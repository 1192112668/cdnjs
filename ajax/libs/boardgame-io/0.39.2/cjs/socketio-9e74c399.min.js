"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var reducer=require("./reducer-34b0fa53.js"),base=require("./base-bdd9c13b.js"),master=require("./master-76993862.js"),io=_interopDefault(require("socket.io-client"));class InMemory extends base.Sync{constructor(){super(),this.state=new Map,this.initial=new Map,this.metadata=new Map,this.log=new Map}createGame(e,t){this.initial.set(e,t.initialState),this.setState(e,t.initialState),this.setMetadata(e,t.metadata)}setMetadata(e,t){this.metadata.set(e,t)}setState(e,t){this.state.set(e,t);let a=this.log.get(e)||[];t.deltalog&&(a=a.concat(t.deltalog)),this.log.set(e,a)}fetch(e,t){let a={};return t.state&&(a.state=this.state.get(e)),t.metadata&&(a.metadata=this.metadata.get(e)),t.log&&(a.log=this.log.get(e)||[]),t.initialState&&(a.initialState=this.initial.get(e)),a}wipe(e){this.state.delete(e),this.metadata.delete(e)}listGames(e){if(void 0!==e.gameName){let t=[];return this.metadata.forEach((a,s)=>{a.gameName===e.gameName&&t.push(s)}),t}return[...this.metadata.keys()]}}var Transport=function e(t){var a=t.store,s=t.gameName,r=t.playerID,i=t.gameID,n=t.numPlayers;reducer._classCallCheck(this,e),this.store=a,this.gameName=s||"default",this.playerID=r||null,this.gameID="".concat(this.gameName,":").concat(i||"default"),this.numPlayers=n||2};function GetBotPlayer(e,t){if(void 0!==e.ctx.gameover)return null;if(e.ctx.stage)for(var a=0,s=Object.keys(t);a<s.length;a++){var r=s[a];if(r in e.ctx.stage)return r}else if(e.ctx.currentPlayer in t)return e.ctx.currentPlayer;return null}function LocalMaster(e){var t=e.game,a=e.bots,s={},r={};if(t&&t.ai&&a)for(var i in a){var n=a[i];r[i]=new n({game:t,enumerate:t.ai.enumerate,seed:t.seed})}var c=function(e){var t=e.type,a=e.playerID,r=e.args,i=s[a];void 0!==i&&i.apply(null,[t].concat(reducer._toConsumableArray(r)))},o=new master.Master(t,new InMemory,{send:c,sendAll:function(e){for(var t in s){var a=e(t),r=a.type,i=a.args;c({type:r,playerID:t,args:i})}}},!1);return o.connect=function(e,t,a){s[t]=a},o.subscribe(function(e){var t=e.state,s=e.gameID;if(a){var i=GetBotPlayer(t,r);null!==i&&setTimeout(async function(){var e=await r[i].play(t,i);await o.onUpdate(e.action,t._stateID,s,e.action.payload.playerID)},100)}}),o}var LocalTransport=function(e){function t(e){var a,s=e.master,r=e.game,i=e.store,n=e.gameID,c=e.playerID,o=e.gameName,l=e.numPlayers;return reducer._classCallCheck(this,t),(a=reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).call(this,{store:i,gameName:o,playerID:c,gameID:n,numPlayers:l}))).master=s,a.game=r,a.isConnected=!0,a}return reducer._inherits(t,e),reducer._createClass(t,[{key:"onUpdate",value:async function(e,t,a){var s=this.store.getState();if(e==this.gameID&&t._stateID>=s._stateID){var r=reducer.update(t,a);this.store.dispatch(r)}}},{key:"onSync",value:function(e,t){if(e==this.gameID){var a=reducer.sync(t);this.store.dispatch(a)}}},{key:"onAction",value:function(e,t){this.master.onUpdate(t,e._stateID,this.gameID,this.playerID)}},{key:"connect",value:function(){var e=this;this.master.connect(this.gameID,this.playerID,function(t){for(var a=arguments.length,s=new Array(a>1?a-1:0),r=1;r<a;r++)s[r-1]=arguments[r];"sync"==t&&e.onSync.apply(e,s),"update"==t&&e.onUpdate.apply(e,s)}),this.master.onSync(this.gameID,this.playerID,this.numPlayers)}},{key:"disconnect",value:function(){}},{key:"subscribe",value:function(){}},{key:"subscribeGameMetadata",value:function(e){}},{key:"updateGameID",value:function(e){this.gameID=this.gameName+":"+e;var t=reducer.reset(null);this.store.dispatch(t),this.connect()}},{key:"updatePlayerID",value:function(e){this.playerID=e;var t=reducer.reset(null);this.store.dispatch(t),this.connect()}}]),t}(Transport),localMasters=new Map;function Local(e){return function(t){var a;return localMasters.has(t.gameKey)&!e?a=localMasters.get(t.gameKey):(a=new LocalMaster({game:t.game,bots:e&&e.bots}),localMasters.set(t.gameKey,a)),new LocalTransport(reducer._objectSpread2({master:a},t))}}var SocketIOTransport=function(e){function t(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.socket,r=a.socketOpts,i=a.store,n=a.gameID,c=a.playerID,o=a.gameName,l=a.numPlayers,u=a.server;return reducer._classCallCheck(this,t),(e=reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).call(this,{store:i,gameName:o,playerID:c,gameID:n,numPlayers:l}))).server=u,e.socket=s,e.socketOpts=r,e.isConnected=!1,e.callback=function(){},e.gameMetadataCallback=function(){},e}return reducer._inherits(t,e),reducer._createClass(t,[{key:"onAction",value:function(e,t){this.socket.emit("update",t,e._stateID,this.gameID,this.playerID)}},{key:"connect",value:function(){var e=this;if(!this.socket)if(this.server){var t=this.server;-1==t.search(/^https?:\/\//)&&(t="http://"+this.server),"/"!=t.substr(-1)&&(t+="/"),this.socket=io(t+this.gameName,this.socketOpts)}else this.socket=io("/"+this.gameName,this.socketOpts);this.socket.on("update",function(t,a,s){var r=e.store.getState();if(t==e.gameID&&a._stateID>=r._stateID){var i=reducer.update(a,s);e.store.dispatch(i)}}),this.socket.on("sync",function(t,a){if(t==e.gameID){var s=reducer.sync(a);e.gameMetadataCallback(a.filteredMetadata),e.store.dispatch(s)}}),this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers),this.socket.on("connect",function(){e.isConnected=!0,e.callback()}),this.socket.on("disconnect",function(){e.isConnected=!1,e.callback()})}},{key:"disconnect",value:function(){this.socket.close(),this.socket=null,this.isConnected=!1,this.callback()}},{key:"subscribe",value:function(e){this.callback=e}},{key:"subscribeGameMetadata",value:function(e){this.gameMetadataCallback=e}},{key:"updateGameID",value:function(e){this.gameID=this.gameName+":"+e;var t=reducer.reset(null);this.store.dispatch(t),this.socket&&this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers)}},{key:"updatePlayerID",value:function(e){this.playerID=e;var t=reducer.reset(null);this.store.dispatch(t),this.socket&&this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers)}}]),t}(Transport);function SocketIO(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.server,a=e.socketOpts;return function(e){return new SocketIOTransport(reducer._objectSpread2({server:t,socketOpts:a},e))}}exports.Local=Local,exports.SocketIO=SocketIO;