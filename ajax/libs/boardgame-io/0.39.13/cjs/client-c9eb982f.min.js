"use strict";var turnOrder=require("./turn-order-e73db595.js"),redux=require("redux"),reducer=require("./reducer-3eb1f0a0.js"),Debug=require("./Debug-ce71f7ad.js"),initialize=require("./initialize-25cb4fc8.js");function createDispatchers(s,e,a,u,l,c){return e.reduce(function(e,n){return e[n]=function(){var e=u;c||null!=u||(e=a.getState().ctx.currentPlayer);for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];a.dispatch(turnOrder.ActionCreators[s](n,r,e,l))},e},{})}var createMoveDispatchers=createDispatchers.bind(null,"makeMove"),createEventDispatchers=createDispatchers.bind(null,"gameEvent"),createPluginDispatchers=createDispatchers.bind(null,"plugin"),_ClientImpl=function(){function g(e){var l=this,t=e.game,r=e.debug,i=e.numPlayers,n=e.multiplayer,s=e.gameID,a=e.playerID,u=e.credentials,c=e.enhancer;turnOrder._classCallCheck(this,g),this.game=reducer.ProcessGameConfig(t),this.playerID=a,this.gameID=s,this.credentials=u,this.multiplayer=n,this.debug=r,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=reducer.CreateGameReducer({game:this.game,isClient:void 0!==n,numPlayers:i}),this.initialState=null,n||(this.initialState=initialize.InitializeGame({game:this.game,numPlayers:i})),this.reset=function(){l.store.dispatch(turnOrder.reset(l.initialState))},this.undo=function(){l.store.dispatch(turnOrder.undo(a,u))},this.redo=function(){l.store.dispatch(turnOrder.redo(a,u))},this.store=null,this.log=[];function o(u){return function(a){return function(e){var t=a(e),r=u.getState();switch(e.type){case turnOrder.MAKE_MOVE:case turnOrder.GAME_EVENT:var i=r.deltalog;l.log=[].concat(turnOrder._toConsumableArray(l.log),turnOrder._toConsumableArray(i));break;case turnOrder.RESET:l.log=[];break;case turnOrder.UPDATE:var n=-1;0<l.log.length&&(n=l.log[l.log.length-1]._stateID);var s=(s=e.deltalog||[]).filter(function(e){return e._stateID>n});l.log=[].concat(turnOrder._toConsumableArray(l.log),turnOrder._toConsumableArray(s));break;case turnOrder.SYNC:l.initialState=e.initialState,l.log=e.log||[]}return t}}}function h(n){return function(i){return function(e){var t=n.getState(),r=i(e);return 1!=e.clientOnly&&l.transport.onAction(t,e),r}}}function d(){return function(r){return function(e){var t=r(e);return l.notifySubscribers(),t}}}c=void 0!==c?redux.compose(redux.applyMiddleware(d,h,o),c):redux.applyMiddleware(d,h,o);this.store=redux.createStore(this.reducer,this.initialState,c),this.transport={isConnected:!0,onAction:function(){},subscribe:function(){},subscribeGameMetadata:function(){},connect:function(){},disconnect:function(){},updateGameID:function(){},updatePlayerID:function(){}},n&&(this.transport=n({gameKey:t,game:this.game,store:this.store,gameID:s,playerID:a,gameName:this.game.name,numPlayers:i})),this.createDispatchers(),this.transport.subscribeGameMetadata(function(e){l.gameMetadata=e}),this._debugPanel=null}return turnOrder._createClass(g,[{key:"notifySubscribers",value:function(){var t=this;Object.values(this.subscribers).forEach(function(e){return e(t.getState())})}},{key:"overrideGameState",value:function(e){this.gameStateOverride=e,this.notifySubscribers()}},{key:"start",value:function(){this.transport.connect(),this._running=!0;var e,t=null;"production"!==process.env.NODE_ENV&&(t=Debug.Debug),this.debug&&this.debug.impl&&(t=this.debug.impl),null!==t&&!1!==this.debug&&null==this._debugPanel&&"undefined"!=typeof document&&(e=document.body,this.debug&&void 0!==this.debug.target&&(e=this.debug.target),e&&(this._debugPanel=new t({target:e,props:{client:this}})))}},{key:"stop",value:function(){this.transport.disconnect(),this._running=!1,null!=this._debugPanel&&(this._debugPanel.$destroy(),this._debugPanel=null)}},{key:"subscribe",value:function(e){var t=this,r=Object.keys(this.subscribers).length;return this.subscribers[r]=e,this.transport.subscribe(function(){return t.notifySubscribers()}),!this._running&&this.multiplayer||e(this.getState()),function(){delete t.subscribers[r]}}},{key:"getInitialState",value:function(){return this.initialState}},{key:"getState",value:function(){var e=this.store.getState();if(null!==this.gameStateOverride&&(e=this.gameStateOverride),null===e)return e;var t=!0,r=this.game.flow.isPlayerActive(e.G,e.ctx,this.playerID);this.multiplayer&&!r&&(t=!1),this.multiplayer||null===this.playerID||void 0===this.playerID||r||(t=!1),void 0!==e.ctx.gameover&&(t=!1);var i=this.game.playerView(e.G,e.ctx,this.playerID),n=turnOrder._objectSpread2({},e,{isActive:t,G:i,log:this.log}),s=this.transport.isConnected;return n=turnOrder._objectSpread2({},n,{isConnected:s})}},{key:"createDispatchers",value:function(){this.moves=createMoveDispatchers(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=createEventDispatchers(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=createPluginDispatchers(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}},{key:"updatePlayerID",value:function(e){this.playerID=e,this.createDispatchers(),this.transport.updatePlayerID(e),this.notifySubscribers()}},{key:"updateGameID",value:function(e){this.gameID=e,this.createDispatchers(),this.transport.updateGameID(e),this.notifySubscribers()}},{key:"updateCredentials",value:function(e){this.credentials=e,this.createDispatchers(),this.notifySubscribers()}}]),g}();function Client(e){return new _ClientImpl(e)}exports.Client=Client;