import{A as ActionCreators,_ as _createClass,k as _objectSpread2,a as _classCallCheck,G as Game,C as CreateGameReducer,r as reset,u as undo,l as redo,M as MAKE_MOVE,n as GAME_EVENT,o as _toConsumableArray,R as RESET,U as UPDATE,p as SYNC}from"./reducer-b8b81041.js";import{compose,applyMiddleware,createStore}from"redux";import{D as Debug}from"./Debug-d8f94c6a.js";import{I as InitializeGame}from"./initialize-2ee3d05a.js";function createDispatchers(e,t,i,a,s,r){return t.reduce(function(t,n){return t[n]=function(){var t=a;r||null!=a||(t=i.getState().ctx.currentPlayer);for(var u=arguments.length,l=new Array(u),o=0;o<u;o++)l[o]=arguments[o];i.dispatch(ActionCreators[e](n,l,t,s))},t},{})}var createMoveDispatchers=createDispatchers.bind(null,"makeMove"),createEventDispatchers=createDispatchers.bind(null,"gameEvent"),createPluginDispatchers=createDispatchers.bind(null,"plugin"),_ClientImpl=function(){function e(t){var i=this,a=t.game,s=t.debug,r=t.numPlayers,n=t.multiplayer,u=t.gameID,l=t.playerID,o=t.credentials,c=t.enhancer;_classCallCheck(this,e),this.game=Game(a),this.playerID=l,this.gameID=u,this.credentials=o,this.multiplayer=n,this.debug=s,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=CreateGameReducer({game:this.game,isClient:void 0!==n,numPlayers:r}),this.initialState=null,n||(this.initialState=InitializeGame({game:this.game,numPlayers:r})),this.reset=function(){i.store.dispatch(reset(i.initialState))},this.undo=function(){i.store.dispatch(undo())},this.redo=function(){i.store.dispatch(redo())},this.store=null,this.log=[];var h=function(e){return function(t){return function(a){var s=t(a),r=e.getState();switch(a.type){case MAKE_MOVE:case GAME_EVENT:var n=r.deltalog;i.log=[].concat(_toConsumableArray(i.log),_toConsumableArray(n));break;case RESET:i.log=[];break;case UPDATE:var u=-1;i.log.length>0&&(u=i.log[i.log.length-1]._stateID);var l=a.deltalog||[];l=l.filter(function(e){return e._stateID>u}),i.log=[].concat(_toConsumableArray(i.log),_toConsumableArray(l));break;case SYNC:i.initialState=a.initialState,i.log=a.log||[]}return s}}},d=function(e){return function(t){return function(a){var s=e.getState(),r=t(a);return 1!=a.clientOnly&&i.transport.onAction(s,a),r}}},p=function(){return function(e){return function(t){var a=e(t);return i.notifySubscribers(),a}}};c=void 0!==c?compose(applyMiddleware(p,d,h),c):applyMiddleware(p,d,h),this.store=createStore(this.reducer,this.initialState,c),this.transport={isConnected:!0,onAction:function(){},subscribe:function(){},subscribeGameMetadata:function(e){},connect:function(){},disconnect:function(){},updateGameID:function(){},updatePlayerID:function(){}},n&&(this.transport=n({gameKey:a,game:this.game,store:this.store,gameID:u,playerID:l,gameName:this.game.name,numPlayers:r})),this.createDispatchers(),this.transport.subscribeGameMetadata(function(e){i.gameMetadata=e}),this._debugPanel=null}return _createClass(e,[{key:"notifySubscribers",value:function(){var e=this;Object.values(this.subscribers).forEach(function(t){return t(e.getState())})}},{key:"overrideGameState",value:function(e){this.gameStateOverride=e,this.notifySubscribers()}},{key:"start",value:function(){this.transport.connect(),this._running=!0;var e=null;if("production"!==process.env.NODE_ENV&&(e=Debug),this.debug&&this.debug.impl&&(e=this.debug.impl),null!==e&&!1!==this.debug&&null==this._debugPanel&&"undefined"!=typeof document){var t=document.body;this.debug&&void 0!==this.debug.target&&(t=this.debug.target),t&&(this._debugPanel=new e({target:t,props:{client:this}}))}}},{key:"stop",value:function(){this.transport.disconnect(),this._running=!1,null!=this._debugPanel&&(this._debugPanel.$destroy(),this._debugPanel=null)}},{key:"subscribe",value:function(e){var t=this,i=Object.keys(this.subscribers).length;return this.subscribers[i]=e,this.transport.subscribe(function(){return t.notifySubscribers()}),!this._running&&this.multiplayer||e(this.getState()),function(){delete t.subscribers[i]}}},{key:"getInitialState",value:function(){return this.initialState}},{key:"getState",value:function(){var e=this.store.getState();if(null!==this.gameStateOverride&&(e=this.gameStateOverride),null===e)return e;var t=!0,i=this.game.flow.isPlayerActive(e.G,e.ctx,this.playerID);this.multiplayer&&!i&&(t=!1),this.multiplayer||null===this.playerID||void 0===this.playerID||i||(t=!1),void 0!==e.ctx.gameover&&(t=!1);var a=this.game.playerView(e.G,e.ctx,this.playerID),s=_objectSpread2({},e,{isActive:t,G:a,log:this.log}),r=this.transport.isConnected;return s=_objectSpread2({},s,{isConnected:r})}},{key:"createDispatchers",value:function(){this.moves=createMoveDispatchers(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=createEventDispatchers(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=createPluginDispatchers(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}},{key:"updatePlayerID",value:function(e){this.playerID=e,this.createDispatchers(),this.transport.updatePlayerID(e),this.notifySubscribers()}},{key:"updateGameID",value:function(e){this.gameID=e,this.createDispatchers(),this.transport.updateGameID(e),this.notifySubscribers()}},{key:"updateCredentials",value:function(e){this.credentials=e,this.createDispatchers(),this.notifySubscribers()}}]),e}();function Client(e){return new _ClientImpl(e)}export{Client as C};