"use strict";var reducer=require("./reducer-d2994695.js"),redux=require("redux"),Debug=require("./Debug-a6563590.js"),initialize=require("./initialize-8bfbe4ed.js");function createDispatchers(a,e,n,u,c,l){return e.reduce(function(e,s){return e[s]=function(){var e=u;l||null!=u||(e=n.getState().ctx.currentPlayer);for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];n.dispatch(reducer.ActionCreators[a](s,r,e,c))},e},{})}var createMoveDispatchers=createDispatchers.bind(null,"makeMove"),createEventDispatchers=createDispatchers.bind(null,"gameEvent"),createPluginDispatchers=createDispatchers.bind(null,"plugin"),_ClientImpl=function(){function g(e){var c=this,t=e.game,r=e.debug,i=e.numPlayers,s=e.multiplayer,a=e.gameID,n=e.playerID,u=e.credentials,l=e.enhancer;reducer._classCallCheck(this,g),this.game=reducer.Game(t),this.playerID=n,this.gameID=a,this.credentials=u,this.multiplayer=s,this.debug=r,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=reducer.CreateGameReducer({game:this.game,isClient:void 0!==s,numPlayers:i}),this.initialState=null,s||(this.initialState=initialize.InitializeGame({game:this.game,numPlayers:i})),this.reset=function(){c.store.dispatch(reducer.reset(c.initialState))},this.undo=function(){c.store.dispatch(reducer.undo())},this.redo=function(){c.store.dispatch(reducer.redo())},this.store=null,this.log=[];function o(u){return function(n){return function(e){var t=n(e),r=u.getState();switch(e.type){case reducer.MAKE_MOVE:case reducer.GAME_EVENT:var i=r.deltalog;c.log=[].concat(reducer._toConsumableArray(c.log),reducer._toConsumableArray(i));break;case reducer.RESET:c.log=[];break;case reducer.UPDATE:var s=-1;0<c.log.length&&(s=c.log[c.log.length-1]._stateID);var a=(a=e.deltalog||[]).filter(function(e){return e._stateID>s});c.log=[].concat(reducer._toConsumableArray(c.log),reducer._toConsumableArray(a));break;case reducer.SYNC:c.initialState=e.initialState,c.log=e.log||[]}return t}}}function h(s){return function(i){return function(e){var t=s.getState(),r=i(e);return 1!=e.clientOnly&&c.transport.onAction(t,e),r}}}function d(){return function(r){return function(e){var t=r(e);return c.notifySubscribers(),t}}}l=void 0!==l?redux.compose(redux.applyMiddleware(d,h,o),l):redux.applyMiddleware(d,h,o);this.store=redux.createStore(this.reducer,this.initialState,l),this.transport={isConnected:!0,onAction:function(){},subscribe:function(){},subscribeGameMetadata:function(){},connect:function(){},disconnect:function(){},updateGameID:function(){},updatePlayerID:function(){}},s&&(this.transport=s({gameKey:t,game:this.game,store:this.store,gameID:a,playerID:n,gameName:this.game.name,numPlayers:i})),this.createDispatchers(),this.transport.subscribeGameMetadata(function(e){c.gameMetadata=e}),this._debugPanel=null}return reducer._createClass(g,[{key:"notifySubscribers",value:function(){var t=this;Object.values(this.subscribers).forEach(function(e){return e(t.getState())})}},{key:"overrideGameState",value:function(e){this.gameStateOverride=e,this.notifySubscribers()}},{key:"start",value:function(){this.transport.connect(),this._running=!0;var e,t=null;"production"!==process.env.NODE_ENV&&(t=Debug.Debug),this.debug&&this.debug.impl&&(t=this.debug.impl),null!==t&&!1!==this.debug&&null==this._debugPanel&&"undefined"!=typeof document&&(e=document.body,this.debug&&void 0!==this.debug.target&&(e=this.debug.target),e&&(this._debugPanel=new t({target:e,props:{client:this}})))}},{key:"stop",value:function(){this.transport.disconnect(),this._running=!1,null!=this._debugPanel&&(this._debugPanel.$destroy(),this._debugPanel=null)}},{key:"subscribe",value:function(e){var t=this,r=Object.keys(this.subscribers).length;return this.subscribers[r]=e,this.transport.subscribe(function(){return t.notifySubscribers()}),!this._running&&this.multiplayer||e(this.getState()),function(){delete t.subscribers[r]}}},{key:"getInitialState",value:function(){return this.initialState}},{key:"getState",value:function(){var e=this.store.getState();if(null!==this.gameStateOverride&&(e=this.gameStateOverride),null===e)return e;var t=!0,r=this.game.flow.isPlayerActive(e.G,e.ctx,this.playerID);this.multiplayer&&!r&&(t=!1),this.multiplayer||null===this.playerID||void 0===this.playerID||r||(t=!1),void 0!==e.ctx.gameover&&(t=!1);var i=this.game.playerView(e.G,e.ctx,this.playerID),s=reducer._objectSpread2({},e,{isActive:t,G:i,log:this.log}),a=this.transport.isConnected;return s=reducer._objectSpread2({},s,{isConnected:a})}},{key:"createDispatchers",value:function(){this.moves=createMoveDispatchers(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=createEventDispatchers(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=createPluginDispatchers(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}},{key:"updatePlayerID",value:function(e){this.playerID=e,this.createDispatchers(),this.transport.updatePlayerID(e),this.notifySubscribers()}},{key:"updateGameID",value:function(e){this.gameID=e,this.createDispatchers(),this.transport.updateGameID(e),this.notifySubscribers()}},{key:"updateCredentials",value:function(e){this.credentials=e,this.createDispatchers(),this.notifySubscribers()}}]),g}();function Client(e){return new _ClientImpl(e)}exports.Client=Client;