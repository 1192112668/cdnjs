"use strict";var reducer=require("./reducer-d2994695.js"),Bot=function(){function e(t){var r=this,a=t.enumerate,n=t.seed;reducer._classCallCheck(this,e),reducer._defineProperty(this,"enumerate",function(e,t,a){return r.enumerateFn(e,t,a).map(function(e){return void 0!==e.payload?e:void 0!==e.move?reducer.makeMove(e.move,e.args,a):void 0!==e.event?reducer.gameEvent(e.event,e.args,a):void 0})}),this.enumerateFn=a,this.seed=n,this.iterationCounter=0,this._opts={}}return reducer._createClass(e,[{key:"addOpt",value:function(e){var t=e.key,r=e.range,a=e.initial;this._opts[t]={range:r,value:a}}},{key:"getOpt",value:function(e){return this._opts[e].value}},{key:"setOpt",value:function(e,t){e in this._opts&&(this._opts[e].value=t)}},{key:"opts",value:function(){return this._opts}},{key:"random",value:function(e){var t;if(void 0!==this.seed){var r=null;t=(r=this.prngstate?new reducer.alea("",{state:this.prngstate}):new reducer.alea(this.seed,{state:!0}))(),this.prngstate=r.state()}else t=Math.random();return e?e.length?e[Math.floor(t*e.length)]:Math.floor(t*e):t}}]),e}(),CHUNK_SIZE=25,MCTSBot=function(e){function t(e){var r,a=e.enumerate,n=e.seed,i=e.objectives,o=e.game,s=e.iterations,c=e.playoutDepth,u=e.iterationCallback;return reducer._classCallCheck(this,t),void 0===i&&(i=function(){return{}}),(r=reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).call(this,{enumerate:a,seed:n}))).objectives=i,r.iterationCallback=u||function(){},r.reducer=reducer.CreateGameReducer({game:o}),r.iterations=s,r.playoutDepth=c,r.addOpt({key:"async",initial:!1}),r.addOpt({key:"iterations",initial:"number"==typeof s?s:1e3,range:{min:1,max:2e3}}),r.addOpt({key:"playoutDepth",initial:"number"==typeof c?c:50,range:{min:1,max:100}}),r}return reducer._inherits(t,e),reducer._createClass(t,[{key:"createNode",value:function(e){var t=e.state,r=e.parentAction,a=e.parent,n=e.playerID,i=t.G,o=t.ctx,s=[],c=[];if(void 0!==n)s=this.enumerate(i,o,n),c=this.objectives(i,o,n);else if(o.activePlayers)for(var u in o.activePlayers)s=s.concat(this.enumerate(i,o,u)),c=c.concat(this.objectives(i,o,u));else s=s.concat(this.enumerate(i,o,o.currentPlayer)),c=c.concat(this.objectives(i,o,o.currentPlayer));return{state:t,parent:a,parentAction:r,actions:s,objectives:c,children:[],visits:0,value:0}}},{key:"select",value:function(e){if(e.actions.length>0)return e;if(0==e.children.length)return e;var t=null,r=0,a=!0,n=!1,i=void 0;try{for(var o,s=e.children[Symbol.iterator]();!(a=(o=s.next()).done);a=!0){var c=o.value,u=c.visits+Number.EPSILON,l=c.value/u+Math.sqrt(2*Math.log(e.visits)/u);(null==t||l>r)&&(r=l,t=c)}}catch(e){n=!0,i=e}finally{try{a||null==s.return||s.return()}finally{if(n)throw i}}return this.select(t)}},{key:"expand",value:function(e){var t=e.actions;if(0==t.length||void 0!==e.state.ctx.gameover)return e;var r=this.random(t.length),a=t[r];e.actions.splice(r,1);var n=this.reducer(e.state,a),i=this.createNode({state:n,parentAction:a,parent:e});return e.children.push(i),i}},{key:"playout",value:function(e){var t=this,r=e.state,a=this.getOpt("playoutDepth");"function"==typeof this.playoutDepth&&(a=this.playoutDepth(r.G,r.ctx));for(var n=function(e){var a=r,n=a.G,i=a.ctx,o=i.currentPlayer;i.activePlayers&&(o=Object.keys(i.activePlayers)[0]);var s=t.enumerate(n,i,o),c=t.objectives(n,i),u=Object.keys(c).reduce(function(e,t){var r=c[t];return r.checker(n,i)?e+r.weight:e},0);if(u>0)return{v:{score:u}};if(!s||0==s.length)return{v:void 0};var l=t.random(s.length),v=t.reducer(r,s[l]);r=v},i=0;i<a&&void 0===r.ctx.gameover;i++){var o=n();if("object"===reducer._typeof(o))return o.v}return r.ctx.gameover}},{key:"backpropagate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.visits++,void 0!==t.score&&(e.value+=t.score),!0===t.draw&&(e.value+=.5),e.parentAction&&t.winner===e.parentAction.payload.playerID&&e.value++,e.parent&&this.backpropagate(e.parent,t)}},{key:"play",value:function(e,t){var r=this,a=this.createNode({state:e,playerID:t}),n=this.getOpt("iterations");"function"==typeof this.iterations&&(n=this.iterations(e.G,e.ctx));var i=function(){var e=null,t=!0,r=!1,n=void 0;try{for(var i,o=a.children[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;(null==e||s.visits>e.visits)&&(e=s)}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return{action:e&&e.parentAction,metadata:a}};return new Promise(function(e){var t=function(){for(var e=0;e<CHUNK_SIZE&&r.iterationCounter<n;e++){var t=r.select(a),i=r.expand(t),o=r.playout(i);r.backpropagate(i,o),r.iterationCounter++}r.iterationCallback({iterationCounter:r.iterationCounter,numIterations:n,metadata:a})};if(r.iterationCounter=0,r.getOpt("async")){!function a(){r.iterationCounter<n?(t(),setTimeout(a,0)):e(i())}()}else{for(;r.iterationCounter<n;)t();e(i())}})}}]),t}(Bot),RandomBot=function(e){function t(){return reducer._classCallCheck(this,t),reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).apply(this,arguments))}return reducer._inherits(t,e),reducer._createClass(t,[{key:"play",value:function(e,t){var r=e.G,a=e.ctx,n=this.enumerate(r,a,t);return Promise.resolve({action:this.random(n)})}}]),t}(Bot);async function Step(e,t){var r=e.store.getState(),a=r.ctx.currentPlayer;r.ctx.activePlayers&&(a=Object.keys(r.ctx.activePlayers)[0]);var n=await t.play(r,a),i=n.action,o=n.metadata;return i&&(i.payload.metadata=o,e.store.dispatch(i)),i}async function Simulate(e){var t=e.game,r=e.bots,a=e.state,n=e.depth;void 0===n&&(n=1e4);for(var i=reducer.CreateGameReducer({game:t,numPlayers:a.ctx.numPlayers}),o=null,s=0;void 0===a.ctx.gameover&&s<n;){var c=a.ctx.currentPlayer;a.ctx.activePlayers&&(c=Object.keys(a.ctx.activePlayers)[0]);var u=r instanceof Bot?r:r[c],l=await u.play(a,c);if(!l.action)break;o=l.metadata,a=i(a,l.action),s++}return{state:a,metadata:o}}exports.Bot=Bot,exports.MCTSBot=MCTSBot,exports.RandomBot=RandomBot,exports.Simulate=Simulate,exports.Step=Step;