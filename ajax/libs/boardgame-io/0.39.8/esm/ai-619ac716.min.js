import{_ as _createClass,a as _classCallCheck,b as _defineProperty,m as makeMove,g as gameEvent,c as alea,d as _inherits,f as _possibleConstructorReturn,h as _getPrototypeOf,C as CreateGameReducer,i as _typeof}from"./reducer-4c0b6feb.js";var Bot=function(){function t(e){var a=this,r=e.enumerate,n=e.seed;_classCallCheck(this,t),_defineProperty(this,"enumerate",function(t,e,r){return a.enumerateFn(t,e,r).map(function(t){return void 0!==t.payload?t:void 0!==t.move?makeMove(t.move,t.args,r):void 0!==t.event?gameEvent(t.event,t.args,r):void 0})}),this.enumerateFn=r,this.seed=n,this.iterationCounter=0,this._opts={}}return _createClass(t,[{key:"addOpt",value:function(t){var e=t.key,a=t.range,r=t.initial;this._opts[e]={range:a,value:r}}},{key:"getOpt",value:function(t){return this._opts[t].value}},{key:"setOpt",value:function(t,e){t in this._opts&&(this._opts[t].value=e)}},{key:"opts",value:function(){return this._opts}},{key:"random",value:function(t){var e;if(void 0!==this.seed){var a=null;e=(a=this.prngstate?new alea("",{state:this.prngstate}):new alea(this.seed,{state:!0}))(),this.prngstate=a.state()}else e=Math.random();return t?t.length?t[Math.floor(e*t.length)]:Math.floor(e*t):e}}]),t}(),CHUNK_SIZE=25,MCTSBot=function(t){function e(t){var a,r=t.enumerate,n=t.seed,i=t.objectives,o=t.game,s=t.iterations,c=t.playoutDepth,u=t.iterationCallback;return _classCallCheck(this,e),void 0===i&&(i=function(){return{}}),(a=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,{enumerate:r,seed:n}))).objectives=i,a.iterationCallback=u||function(){},a.reducer=CreateGameReducer({game:o}),a.iterations=s,a.playoutDepth=c,a.addOpt({key:"async",initial:!1}),a.addOpt({key:"iterations",initial:"number"==typeof s?s:1e3,range:{min:1,max:2e3}}),a.addOpt({key:"playoutDepth",initial:"number"==typeof c?c:50,range:{min:1,max:100}}),a}return _inherits(e,Bot),_createClass(e,[{key:"createNode",value:function(t){var e=t.state,a=t.parentAction,r=t.parent,n=t.playerID,i=e.G,o=e.ctx,s=[],c=[];if(void 0!==n)s=this.enumerate(i,o,n),c=this.objectives(i,o,n);else if(o.activePlayers)for(var u in o.activePlayers)s=s.concat(this.enumerate(i,o,u)),c=c.concat(this.objectives(i,o,u));else s=s.concat(this.enumerate(i,o,o.currentPlayer)),c=c.concat(this.objectives(i,o,o.currentPlayer));return{state:e,parent:r,parentAction:a,actions:s,objectives:c,children:[],visits:0,value:0}}},{key:"select",value:function(t){if(t.actions.length>0)return t;if(0==t.children.length)return t;var e=null,a=0,r=!0,n=!1,i=void 0;try{for(var o,s=t.children[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value,u=c.visits+Number.EPSILON,l=c.value/u+Math.sqrt(2*Math.log(t.visits)/u);(null==e||l>a)&&(a=l,e=c)}}catch(t){n=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}return this.select(e)}},{key:"expand",value:function(t){var e=t.actions;if(0==e.length||void 0!==t.state.ctx.gameover)return t;var a=this.random(e.length),r=e[a];t.actions.splice(a,1);var n=this.reducer(t.state,r),i=this.createNode({state:n,parentAction:r,parent:t});return t.children.push(i),i}},{key:"playout",value:function(t){var e=this,a=t.state,r=this.getOpt("playoutDepth");"function"==typeof this.playoutDepth&&(r=this.playoutDepth(a.G,a.ctx));for(var n=function(t){var r=a,n=r.G,i=r.ctx,o=i.currentPlayer;i.activePlayers&&(o=Object.keys(i.activePlayers)[0]);var s=e.enumerate(n,i,o),c=e.objectives(n,i),u=Object.keys(c).reduce(function(t,e){var a=c[e];return a.checker(n,i)?t+a.weight:t},0);if(u>0)return{v:{score:u}};if(!s||0==s.length)return{v:void 0};var l=e.random(s.length),v=e.reducer(a,s[l]);a=v},i=0;i<r&&void 0===a.ctx.gameover;i++){var o=n();if("object"===_typeof(o))return o.v}return a.ctx.gameover}},{key:"backpropagate",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.visits++,void 0!==e.score&&(t.value+=e.score),!0===e.draw&&(t.value+=.5),t.parentAction&&e.winner===t.parentAction.payload.playerID&&t.value++,t.parent&&this.backpropagate(t.parent,e)}},{key:"play",value:function(t,e){var a=this,r=this.createNode({state:t,playerID:e}),n=this.getOpt("iterations");"function"==typeof this.iterations&&(n=this.iterations(t.G,t.ctx));var i=function(){var t=null,e=!0,a=!1,n=void 0;try{for(var i,o=r.children[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;(null==t||s.visits>t.visits)&&(t=s)}}catch(t){a=!0,n=t}finally{try{e||null==o.return||o.return()}finally{if(a)throw n}}return{action:t&&t.parentAction,metadata:r}};return new Promise(function(t){var e=function(){for(var t=0;t<CHUNK_SIZE&&a.iterationCounter<n;t++){var e=a.select(r),i=a.expand(e),o=a.playout(i);a.backpropagate(i,o),a.iterationCounter++}a.iterationCallback({iterationCounter:a.iterationCounter,numIterations:n,metadata:r})};if(a.iterationCounter=0,a.getOpt("async")){!function r(){a.iterationCounter<n?(e(),setTimeout(r,0)):t(i())}()}else{for(;a.iterationCounter<n;)e();t(i())}})}}]),e}(),RandomBot=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Bot),_createClass(e,[{key:"play",value:function(t,e){var a=t.G,r=t.ctx,n=this.enumerate(a,r,e);return Promise.resolve({action:this.random(n)})}}]),e}();async function Step(t,e){var a=t.store.getState(),r=a.ctx.currentPlayer;a.ctx.activePlayers&&(r=Object.keys(a.ctx.activePlayers)[0]);var n=await e.play(a,r),i=n.action,o=n.metadata;return i&&(i.payload.metadata=o,t.store.dispatch(i)),i}async function Simulate(t){var e=t.game,a=t.bots,r=t.state,n=t.depth;void 0===n&&(n=1e4);for(var i=CreateGameReducer({game:e,numPlayers:r.ctx.numPlayers}),o=null,s=0;void 0===r.ctx.gameover&&s<n;){var c=r.ctx.currentPlayer;r.ctx.activePlayers&&(c=Object.keys(r.ctx.activePlayers)[0]);var u=a instanceof Bot?a:a[c],l=await u.play(r,c);if(!l.action)break;o=l.metadata,r=i(r,l.action),s++}return{state:r,metadata:o}}export{Bot as B,MCTSBot as M,RandomBot as R,Step as S,Simulate as a};