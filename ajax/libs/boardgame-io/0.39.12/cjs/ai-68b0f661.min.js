"use strict";var turnOrder=require("./turn-order-9375b0ef.js"),reducer=require("./reducer-3779d6a8.js"),Bot=function(){function t(e){var r=this,a=e.enumerate,n=e.seed;turnOrder._classCallCheck(this,t),turnOrder._defineProperty(this,"enumerate",function(t,e,a){return r.enumerateFn(t,e,a).map(function(t){return void 0!==t.payload?t:void 0!==t.move?turnOrder.makeMove(t.move,t.args,a):void 0!==t.event?turnOrder.gameEvent(t.event,t.args,a):void 0})}),this.enumerateFn=a,this.seed=n,this.iterationCounter=0,this._opts={}}return turnOrder._createClass(t,[{key:"addOpt",value:function(t){var e=t.key,r=t.range,a=t.initial;this._opts[e]={range:r,value:a}}},{key:"getOpt",value:function(t){return this._opts[t].value}},{key:"setOpt",value:function(t,e){t in this._opts&&(this._opts[t].value=e)}},{key:"opts",value:function(){return this._opts}},{key:"random",value:function(t){var e;if(void 0!==this.seed){var r=null;e=(r=this.prngstate?new turnOrder.alea("",{state:this.prngstate}):new turnOrder.alea(this.seed,{state:!0}))(),this.prngstate=r.state()}else e=Math.random();return t?t.length?t[Math.floor(e*t.length)]:Math.floor(e*t):e}}]),t}(),CHUNK_SIZE=25,MCTSBot=function(t){function e(t){var r,a=t.enumerate,n=t.seed,i=t.objectives,o=t.game,s=t.iterations,u=t.playoutDepth,c=t.iterationCallback;return turnOrder._classCallCheck(this,e),void 0===i&&(i=function(){return{}}),(r=turnOrder._possibleConstructorReturn(this,turnOrder._getPrototypeOf(e).call(this,{enumerate:a,seed:n}))).objectives=i,r.iterationCallback=c||function(){},r.reducer=reducer.CreateGameReducer({game:o}),r.iterations=s,r.playoutDepth=u,r.addOpt({key:"async",initial:!1}),r.addOpt({key:"iterations",initial:"number"==typeof s?s:1e3,range:{min:1,max:2e3}}),r.addOpt({key:"playoutDepth",initial:"number"==typeof u?u:50,range:{min:1,max:100}}),r}return turnOrder._inherits(e,t),turnOrder._createClass(e,[{key:"createNode",value:function(t){var e=t.state,r=t.parentAction,a=t.parent,n=t.playerID,i=e.G,o=e.ctx,s=[],u=[];if(void 0!==n)s=this.enumerate(i,o,n),u=this.objectives(i,o,n);else if(o.activePlayers)for(var c in o.activePlayers)s=s.concat(this.enumerate(i,o,c)),u=u.concat(this.objectives(i,o,c));else s=s.concat(this.enumerate(i,o,o.currentPlayer)),u=u.concat(this.objectives(i,o,o.currentPlayer));return{state:e,parent:a,parentAction:r,actions:s,objectives:u,children:[],visits:0,value:0}}},{key:"select",value:function(t){if(t.actions.length>0)return t;if(0==t.children.length)return t;var e=null,r=0,a=!0,n=!1,i=void 0;try{for(var o,s=t.children[Symbol.iterator]();!(a=(o=s.next()).done);a=!0){var u=o.value,c=u.visits+Number.EPSILON,l=u.value/c+Math.sqrt(2*Math.log(t.visits)/c);(null==e||l>r)&&(r=l,e=u)}}catch(t){n=!0,i=t}finally{try{a||null==s.return||s.return()}finally{if(n)throw i}}return this.select(e)}},{key:"expand",value:function(t){var e=t.actions;if(0==e.length||void 0!==t.state.ctx.gameover)return t;var r=this.random(e.length),a=e[r];t.actions.splice(r,1);var n=this.reducer(t.state,a),i=this.createNode({state:n,parentAction:a,parent:t});return t.children.push(i),i}},{key:"playout",value:function(t){var e=this,r=t.state,a=this.getOpt("playoutDepth");"function"==typeof this.playoutDepth&&(a=this.playoutDepth(r.G,r.ctx));for(var n=function(t){var a=r,n=a.G,i=a.ctx,o=i.currentPlayer;i.activePlayers&&(o=Object.keys(i.activePlayers)[0]);var s=e.enumerate(n,i,o),u=e.objectives(n,i),c=Object.keys(u).reduce(function(t,e){var r=u[e];return r.checker(n,i)?t+r.weight:t},0);if(c>0)return{v:{score:c}};if(!s||0==s.length)return{v:void 0};var l=e.random(s.length),v=e.reducer(r,s[l]);r=v},i=0;i<a&&void 0===r.ctx.gameover;i++){var o=n();if("object"===turnOrder._typeof(o))return o.v}return r.ctx.gameover}},{key:"backpropagate",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.visits++,void 0!==e.score&&(t.value+=e.score),!0===e.draw&&(t.value+=.5),t.parentAction&&e.winner===t.parentAction.payload.playerID&&t.value++,t.parent&&this.backpropagate(t.parent,e)}},{key:"play",value:function(t,e){var r=this,a=this.createNode({state:t,playerID:e}),n=this.getOpt("iterations");"function"==typeof this.iterations&&(n=this.iterations(t.G,t.ctx));var i=function(){var t=null,e=!0,r=!1,n=void 0;try{for(var i,o=a.children[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;(null==t||s.visits>t.visits)&&(t=s)}}catch(t){r=!0,n=t}finally{try{e||null==o.return||o.return()}finally{if(r)throw n}}return{action:t&&t.parentAction,metadata:a}};return new Promise(function(t){var e=function(){for(var t=0;t<CHUNK_SIZE&&r.iterationCounter<n;t++){var e=r.select(a),i=r.expand(e),o=r.playout(i);r.backpropagate(i,o),r.iterationCounter++}r.iterationCallback({iterationCounter:r.iterationCounter,numIterations:n,metadata:a})};if(r.iterationCounter=0,r.getOpt("async")){!function a(){r.iterationCounter<n?(e(),setTimeout(a,0)):t(i())}()}else{for(;r.iterationCounter<n;)e();t(i())}})}}]),e}(Bot),RandomBot=function(t){function e(){return turnOrder._classCallCheck(this,e),turnOrder._possibleConstructorReturn(this,turnOrder._getPrototypeOf(e).apply(this,arguments))}return turnOrder._inherits(e,t),turnOrder._createClass(e,[{key:"play",value:function(t,e){var r=t.G,a=t.ctx,n=this.enumerate(r,a,e);return Promise.resolve({action:this.random(n)})}}]),e}(Bot);async function Step(t,e){var r=t.store.getState(),a=r.ctx.currentPlayer;r.ctx.activePlayers&&(a=Object.keys(r.ctx.activePlayers)[0]);var n=await e.play(r,a),i=n.action,o=n.metadata;return i&&(i.payload.metadata=o,t.store.dispatch(i)),i}async function Simulate(t){var e=t.game,r=t.bots,a=t.state,n=t.depth;void 0===n&&(n=1e4);for(var i=reducer.CreateGameReducer({game:e,numPlayers:a.ctx.numPlayers}),o=null,s=0;void 0===a.ctx.gameover&&s<n;){var u=a.ctx.currentPlayer;a.ctx.activePlayers&&(u=Object.keys(a.ctx.activePlayers)[0]);var c=r instanceof Bot?r:r[u],l=await c.play(a,u);if(!l.action)break;o=l.metadata,a=i(a,l.action),s++}return{state:a,metadata:o}}exports.Bot=Bot,exports.MCTSBot=MCTSBot,exports.RandomBot=RandomBot,exports.Simulate=Simulate,exports.Step=Step;