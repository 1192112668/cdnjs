"use strict";var game=require("./game-4b284c1b.js"),redux=require("redux"),Debug=require("./Debug-a4c62056.js"),initialize=require("./initialize-58dc4481.js");function createDispatchers(s,e,n,u,l,c){return e.reduce(function(e,r){return e[r]=function(){var e=u;c||null!=u||(e=n.getState().ctx.currentPlayer);for(var t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];n.dispatch(game.ActionCreators[s](r,i,e,l))},e},{})}var createMoveDispatchers=createDispatchers.bind(null,"makeMove"),createEventDispatchers=createDispatchers.bind(null,"gameEvent"),createPluginDispatchers=createDispatchers.bind(null,"plugin"),_ClientImpl=function(){function m(e){var l=this,t=e.game,i=e.debug,a=e.numPlayers,r=e.multiplayer,s=e.gameID,n=e.playerID,u=e.credentials,c=e.enhancer;game._classCallCheck(this,m),this.game=game.ProcessGameConfig(t),this.playerID=n,this.gameID=s,this.credentials=u,this.multiplayer=r,this.debug=i,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=game.CreateGameReducer({game:this.game,isClient:void 0!==r,numPlayers:a}),this.initialState=null,r||(this.initialState=initialize.InitializeGame({game:this.game,numPlayers:a})),this.reset=function(){l.store.dispatch(game.reset(l.initialState))},this.undo=function(){l.store.dispatch(game.undo(n,u))},this.redo=function(){l.store.dispatch(game.redo(n,u))},this.store=null,this.log=[];function o(u){return function(n){return function(e){var t=n(e),i=u.getState();switch(e.type){case game.MAKE_MOVE:case game.GAME_EVENT:var a=i.deltalog;l.log=[].concat(game._toConsumableArray(l.log),game._toConsumableArray(a));break;case game.RESET:l.log=[];break;case game.UPDATE:var r=-1;0<l.log.length&&(r=l.log[l.log.length-1]._stateID);var s=(s=e.deltalog||[]).filter(function(e){return e._stateID>r});l.log=[].concat(game._toConsumableArray(l.log),game._toConsumableArray(s));break;case game.SYNC:l.initialState=e.initialState,l.log=e.log||[]}return t}}}function h(r){return function(a){return function(e){var t=r.getState(),i=a(e);return 1!=e.clientOnly&&l.transport.onAction(t,e),i}}}function g(){return function(i){return function(e){var t=i(e);return l.notifySubscribers(),t}}}c=void 0!==c?redux.compose(redux.applyMiddleware(g,h,o),c):redux.applyMiddleware(g,h,o);this.store=redux.createStore(this.reducer,this.initialState,c),this.transport={isConnected:!0,onAction:function(){},subscribe:function(){},subscribeGameMetadata:function(){},connect:function(){},disconnect:function(){},updateGameID:function(){},updatePlayerID:function(){}},r&&(this.transport=r({gameKey:t,game:this.game,store:this.store,gameID:s,playerID:n,gameName:this.game.name,numPlayers:a})),this.createDispatchers(),this.transport.subscribeGameMetadata(function(e){l.gameMetadata=e}),this._debugPanel=null}return game._createClass(m,[{key:"notifySubscribers",value:function(){var t=this;Object.values(this.subscribers).forEach(function(e){return e(t.getState())})}},{key:"overrideGameState",value:function(e){this.gameStateOverride=e,this.notifySubscribers()}},{key:"start",value:function(){this.transport.connect(),this._running=!0;var e,t=null;"production"!==process.env.NODE_ENV&&(t=Debug.Debug),this.debug&&this.debug.impl&&(t=this.debug.impl),null!==t&&!1!==this.debug&&null==this._debugPanel&&"undefined"!=typeof document&&(e=document.body,this.debug&&void 0!==this.debug.target&&(e=this.debug.target),e&&(this._debugPanel=new t({target:e,props:{client:this}})))}},{key:"stop",value:function(){this.transport.disconnect(),this._running=!1,null!=this._debugPanel&&(this._debugPanel.$destroy(),this._debugPanel=null)}},{key:"subscribe",value:function(e){var t=this,i=Object.keys(this.subscribers).length;return this.subscribers[i]=e,this.transport.subscribe(function(){return t.notifySubscribers()}),!this._running&&this.multiplayer||e(this.getState()),function(){delete t.subscribers[i]}}},{key:"getInitialState",value:function(){return this.initialState}},{key:"getState",value:function(){var e=this.store.getState();if(null!==this.gameStateOverride&&(e=this.gameStateOverride),null===e)return e;var t=!0,i=this.game.flow.isPlayerActive(e.G,e.ctx,this.playerID);this.multiplayer&&!i&&(t=!1),this.multiplayer||null===this.playerID||void 0===this.playerID||i||(t=!1),void 0!==e.ctx.gameover&&(t=!1);var a=this.game.playerView(e.G,e.ctx,this.playerID),r=game._objectSpread2({},e,{isActive:t,G:a,log:this.log}),s=this.transport.isConnected;return r=game._objectSpread2({},r,{isConnected:s})}},{key:"createDispatchers",value:function(){this.moves=createMoveDispatchers(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=createEventDispatchers(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=createPluginDispatchers(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}},{key:"updatePlayerID",value:function(e){this.playerID=e,this.createDispatchers(),this.transport.updatePlayerID(e),this.notifySubscribers()}},{key:"updateGameID",value:function(e){this.gameID=e,this.createDispatchers(),this.transport.updateGameID(e),this.notifySubscribers()}},{key:"updateCredentials",value:function(e){this.credentials=e,this.createDispatchers(),this.notifySubscribers()}}]),m}();function Client(e){return new _ClientImpl(e)}exports.Client=Client;