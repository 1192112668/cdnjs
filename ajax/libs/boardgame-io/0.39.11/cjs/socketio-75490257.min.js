"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var game=require("./game-4b284c1b.js"),base=require("./base-bdd9c13b.js"),master=require("./master-1f9698a1.js"),io=_interopDefault(require("socket.io-client"));class InMemory extends base.Sync{constructor(){super(),this.state=new Map,this.initial=new Map,this.metadata=new Map,this.log=new Map}createGame(e,t){this.initial.set(e,t.initialState),this.setState(e,t.initialState),this.setMetadata(e,t.metadata)}setMetadata(e,t){this.metadata.set(e,t)}setState(e,t,a){if(a&&a.length>0){const t=this.log.get(e)||[];this.log.set(e,t.concat(a))}this.state.set(e,t)}fetch(e,t){let a={};return t.state&&(a.state=this.state.get(e)),t.metadata&&(a.metadata=this.metadata.get(e)),t.log&&(a.log=this.log.get(e)||[]),t.initialState&&(a.initialState=this.initial.get(e)),a}wipe(e){this.state.delete(e),this.metadata.delete(e)}listGames(e){if(e&&void 0!==e.gameName){let t=[];return this.metadata.forEach((a,s)=>{a.gameName===e.gameName&&t.push(s)}),t}return[...this.metadata.keys()]}}var Transport=function e(t){var a=t.store,s=t.gameName,n=t.playerID,i=t.gameID,r=t.numPlayers;game._classCallCheck(this,e),this.store=a,this.gameName=s||"default",this.playerID=n||null,this.gameID=i||"default",this.numPlayers=r||2};function GetBotPlayer(e,t){if(void 0!==e.ctx.gameover)return null;if(e.ctx.stage)for(var a=0,s=Object.keys(t);a<s.length;a++){var n=s[a];if(n in e.ctx.stage)return n}else if(e.ctx.currentPlayer in t)return e.ctx.currentPlayer;return null}function LocalMaster(e){var t=e.game,a=e.bots,s={},n={};if(t&&t.ai&&a)for(var i in a){var r=a[i];n[i]=new r({game:t,enumerate:t.ai.enumerate,seed:t.seed})}var o=function(e){var t=e.type,a=e.playerID,n=e.args,i=s[a];void 0!==i&&i.apply(null,[t].concat(game._toConsumableArray(n)))},c=new master.Master(t,new InMemory,{send:o,sendAll:function(e){for(var t in s){var a=e(t),n=a.type,i=a.args;o({type:n,playerID:t,args:i})}}},!1);return c.connect=function(e,t,a){s[t]=a},c.subscribe(function(e){var t=e.state,s=e.gameID;if(a){var i=GetBotPlayer(t,n);null!==i&&setTimeout(async function(){var e=await n[i].play(t,i);await c.onUpdate(e.action,t._stateID,s,e.action.payload.playerID)},100)}}),c}var LocalTransport=function(e){function t(e){var a,s=e.master,n=e.game,i=e.store,r=e.gameID,o=e.playerID,c=e.gameName,l=e.numPlayers;return game._classCallCheck(this,t),(a=game._possibleConstructorReturn(this,game._getPrototypeOf(t).call(this,{store:i,gameName:c,playerID:o,gameID:r,numPlayers:l}))).master=s,a.game=n,a.isConnected=!0,a}return game._inherits(t,e),game._createClass(t,[{key:"onUpdate",value:async function(e,t,a){var s=this.store.getState();if(e==this.gameID&&t._stateID>=s._stateID){var n=game.update(t,a);this.store.dispatch(n)}}},{key:"onSync",value:function(e,t){if(e==this.gameID){var a=game.sync(t);this.store.dispatch(a)}}},{key:"onAction",value:function(e,t){this.master.onUpdate(t,e._stateID,this.gameID,this.playerID)}},{key:"connect",value:function(){var e=this;this.master.connect(this.gameID,this.playerID,function(t){for(var a=arguments.length,s=new Array(a>1?a-1:0),n=1;n<a;n++)s[n-1]=arguments[n];"sync"==t&&e.onSync.apply(e,s),"update"==t&&e.onUpdate.apply(e,s)}),this.master.onSync(this.gameID,this.playerID,this.numPlayers)}},{key:"disconnect",value:function(){}},{key:"subscribe",value:function(){}},{key:"subscribeGameMetadata",value:function(e){}},{key:"updateGameID",value:function(e){this.gameID=e;var t=game.reset(null);this.store.dispatch(t),this.connect()}},{key:"updatePlayerID",value:function(e){this.playerID=e;var t=game.reset(null);this.store.dispatch(t),this.connect()}}]),t}(Transport),localMasters=new Map;function Local(e){return function(t){var a;return localMasters.has(t.gameKey)&!e?a=localMasters.get(t.gameKey):(a=new LocalMaster({game:t.game,bots:e&&e.bots}),localMasters.set(t.gameKey,a)),new LocalTransport(game._objectSpread2({master:a},t))}}var SocketIOTransport=function(e){function t(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.socket,n=a.socketOpts,i=a.store,r=a.gameID,o=a.playerID,c=a.gameName,l=a.numPlayers,u=a.server;return game._classCallCheck(this,t),(e=game._possibleConstructorReturn(this,game._getPrototypeOf(t).call(this,{store:i,gameName:c,playerID:o,gameID:r,numPlayers:l}))).server=u,e.socket=s,e.socketOpts=n,e.isConnected=!1,e.callback=function(){},e.gameMetadataCallback=function(){},e}return game._inherits(t,e),game._createClass(t,[{key:"onAction",value:function(e,t){this.socket.emit("update",t,e._stateID,this.gameID,this.playerID)}},{key:"connect",value:function(){var e=this;if(!this.socket)if(this.server){var t=this.server;-1==t.search(/^https?:\/\//)&&(t="http://"+this.server),"/"!=t.substr(-1)&&(t+="/"),this.socket=io(t+this.gameName,this.socketOpts)}else this.socket=io("/"+this.gameName,this.socketOpts);this.socket.on("update",function(t,a,s){var n=e.store.getState();if(t==e.gameID&&a._stateID>=n._stateID){var i=game.update(a,s);e.store.dispatch(i)}}),this.socket.on("sync",function(t,a){if(t==e.gameID){var s=game.sync(a);e.gameMetadataCallback(a.filteredMetadata),e.store.dispatch(s)}}),this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers),this.socket.on("connect",function(){e.isConnected=!0,e.callback()}),this.socket.on("disconnect",function(){e.isConnected=!1,e.callback()})}},{key:"disconnect",value:function(){this.socket.close(),this.socket=null,this.isConnected=!1,this.callback()}},{key:"subscribe",value:function(e){this.callback=e}},{key:"subscribeGameMetadata",value:function(e){this.gameMetadataCallback=e}},{key:"updateGameID",value:function(e){this.gameID=e;var t=game.reset(null);this.store.dispatch(t),this.socket&&this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers)}},{key:"updatePlayerID",value:function(e){this.playerID=e;var t=game.reset(null);this.store.dispatch(t),this.socket&&this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers)}}]),t}(Transport);function SocketIO(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.server,a=e.socketOpts;return function(e){return new SocketIOTransport(game._objectSpread2({server:t,socketOpts:a},e))}}exports.Local=Local,exports.SocketIO=SocketIO;