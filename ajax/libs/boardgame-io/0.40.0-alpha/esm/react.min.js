import{z as _inherits,_ as _createClass,B as _defineProperty,t as _classCallCheck,C as _possibleConstructorReturn,D as _getPrototypeOf,r as _objectSpread2,H as _assertThisInitialized,x as _toConsumableArray}from"./turn-order-b89c94e7.js";import"redux";import"immer";import"./reducer-f8e7aa66.js";import"./Debug-2d6f2f47.js";import"flatted";import{M as MCTSBot}from"./ai-3a30115d.js";import"./initialize-d650b559.js";import{C as Client$1}from"./client-46dff2fb.js";import React from"react";import PropTypes from"prop-types";import Cookies from"react-cookies";import"./base-c99f5be2.js";import{S as SocketIO,L as Local}from"./socketio-c7d320ac.js";import"./master-c9d30818.js";import"socket.io-client";function Client(e){var t,a,r=e.game,n=e.numPlayers,i=e.loading,s=e.board,o=e.multiplayer,c=e.enhancer,l=e.debug;if(void 0===i){i=function(){return React.createElement("div",{className:"bgio-loading"},"connecting...")}}return a=t=function(e){function t(e){var a;return _classCallCheck(this,t),a=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e)),void 0===l&&(l=e.debug),a.client=Client$1({game:r,debug:l,numPlayers:n,multiplayer:o,gameID:e.gameID,playerID:e.playerID,credentials:e.credentials,enhancer:c}),a}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=this;this.unsubscribe=this.client.subscribe(function(){return e.forceUpdate()}),this.client.start()}},{key:"componentWillUnmount",value:function(){this.client.stop(),this.unsubscribe()}},{key:"componentDidUpdate",value:function(e){this.props.gameID!=e.gameID&&this.client.updateGameID(this.props.gameID),this.props.playerID!=e.playerID&&this.client.updatePlayerID(this.props.playerID),this.props.credentials!=e.credentials&&this.client.updateCredentials(this.props.credentials)}},{key:"render",value:function(){var e=this.client.getState();if(null===e)return React.createElement(i);var t=null;return s&&(t=React.createElement(s,_objectSpread2({},e,{},this.props,{isMultiplayer:!!o,moves:this.client.moves,events:this.client.events,gameID:this.client.gameID,playerID:this.client.playerID,reset:this.client.reset,undo:this.client.undo,redo:this.client.redo,log:this.client.log,gameMetadata:this.client.gameMetadata}))),React.createElement("div",{className:"bgio-client"},t)}}]),t}(React.Component),_defineProperty(t,"propTypes",{gameID:PropTypes.string,playerID:PropTypes.string,credentials:PropTypes.string,debug:PropTypes.any}),_defineProperty(t,"defaultProps",{gameID:"default",playerID:null,credentials:null,debug:!0}),a}var _LobbyConnectionImpl=function(){function e(t){var a=t.server,r=t.gameComponents,n=t.playerName,i=t.playerCredentials;_classCallCheck(this,e),this.gameComponents=r,this.playerName=n||"Visitor",this.playerCredentials=i,this.server=a,this.matches=[]}return _createClass(e,[{key:"_baseUrl",value:function(){return"".concat(this.server||"","/games")}},{key:"refresh",value:async function(){try{this.matches.length=0;var e=await fetch(this._baseUrl());if(200!==e.status)throw new Error("HTTP status "+e.status);var t=await e.json(),a=!0,r=!1,n=void 0;try{for(var i,s=t[Symbol.iterator]();!(a=(i=s.next()).done);a=!0){var o=i.value;if(this._getGameComponents(o)){var c=await fetch(this._baseUrl()+"/"+o),l=await c.json(),p=!0,m=!1,h=void 0;try{for(var y,u=l.matches[Symbol.iterator]();!(p=(y=u.next()).done);p=!0){y.value.gameName=o}}catch(e){m=!0,h=e}finally{try{p||null==u.return||u.return()}finally{if(m)throw h}}this.matches=this.matches.concat(l.matches)}}}catch(e){r=!0,n=e}finally{try{a||null==s.return||s.return()}finally{if(r)throw n}}}catch(e){throw new Error("failed to retrieve list of matches ("+e+")")}}},{key:"_getMatchInstance",value:function(e){var t=!0,a=!1,r=void 0;try{for(var n,i=this.matches[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var s=n.value;if(s.matchID===e)return s}}catch(e){a=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(a)throw r}}}},{key:"_getGameComponents",value:function(e){var t=!0,a=!1,r=void 0;try{for(var n,i=this.gameComponents[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var s=n.value;if(s.game.name===e)return s}}catch(e){a=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(a)throw r}}}},{key:"_findPlayer",value:function(e){var t=!0,a=!1,r=void 0;try{for(var n,i=this.matches[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var s=n.value;if(s.players.some(function(t){return t.name===e}))return s}}catch(e){a=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(a)throw r}}}},{key:"join",value:async function(e,t,a){try{var r=this._findPlayer(this.playerName);if(r)throw new Error("player has already joined "+r.matchID);if(!(r=this._getMatchInstance(t)))throw new Error("game instance "+t+" not found");var n=await fetch(this._baseUrl()+"/"+e+"/"+t+"/join",{method:"POST",body:JSON.stringify({playerID:a,playerName:this.playerName}),headers:{"Content-Type":"application/json"}});if(200!==n.status)throw new Error("HTTP status "+n.status);var i=await n.json();r.players[Number.parseInt(a)].name=this.playerName,this.playerCredentials=i.playerCredentials}catch(e){throw new Error("failed to join match "+t+" ("+e+")")}}},{key:"leave",value:async function(e,t){try{var a=this._getMatchInstance(t);if(!a)throw new Error("match instance not found");var r=!0,n=!1,i=void 0;try{for(var s,o=a.players[Symbol.iterator]();!(r=(s=o.next()).done);r=!0){var c=s.value;if(c.name===this.playerName){var l=await fetch(this._baseUrl()+"/"+e+"/"+t+"/leave",{method:"POST",body:JSON.stringify({playerID:c.id,credentials:this.playerCredentials}),headers:{"Content-Type":"application/json"}});if(200!==l.status)throw new Error("HTTP status "+l.status);return delete c.name,void delete this.playerCredentials}}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}throw new Error("player not found in match")}catch(e){throw new Error("failed to leave match "+t+" ("+e+")")}}},{key:"disconnect",value:async function(){var e=this._findPlayer(this.playerName);e&&await this.leave(e.gameName,e.matchID),this.matches=[],this.playerName="Visitor"}},{key:"create",value:async function(e,t){try{var a=this._getGameComponents(e);if(!a)throw new Error("game not found");if(t<a.game.minPlayers||t>a.game.maxPlayers)throw new Error("invalid number of players "+t);var r=await fetch(this._baseUrl()+"/"+e+"/create",{method:"POST",body:JSON.stringify({numPlayers:t}),headers:{"Content-Type":"application/json"}});if(200!==r.status)throw new Error("HTTP status "+r.status)}catch(t){throw new Error("failed to create match for "+e+" ("+t+")")}}}]),e}();function LobbyConnection(e){return new _LobbyConnectionImpl(e)}var LobbyLoginForm=function(e){function t(){var e,a;_classCallCheck(this,t);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return a=_possibleConstructorReturn(this,(e=_getPrototypeOf(t)).call.apply(e,[this].concat(n))),_defineProperty(_assertThisInitialized(a),"state",{playerName:a.props.playerName,nameErrorMsg:""}),_defineProperty(_assertThisInitialized(a),"onClickEnter",function(){""!==a.state.playerName&&a.props.onEnter(a.state.playerName)}),_defineProperty(_assertThisInitialized(a),"onKeyPress",function(e){"Enter"===e.key&&a.onClickEnter()}),_defineProperty(_assertThisInitialized(a),"onChangePlayerName",function(e){var t=e.target.value.trim();a.setState({playerName:t,nameErrorMsg:t.length>0?"":"empty player name"})}),a}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return React.createElement("div",null,React.createElement("p",{className:"phase-title"},"Choose a player name:"),React.createElement("input",{type:"text",value:this.state.playerName,onChange:this.onChangePlayerName,onKeyPress:this.onKeyPress}),React.createElement("span",{className:"buttons"},React.createElement("button",{className:"buttons",onClick:this.onClickEnter},"Enter")),React.createElement("br",null),React.createElement("span",{className:"error-msg"},this.state.nameErrorMsg,React.createElement("br",null)))}}]),t}(React.Component);_defineProperty(LobbyLoginForm,"propTypes",{playerName:PropTypes.string,onEnter:PropTypes.func.isRequired}),_defineProperty(LobbyLoginForm,"defaultProps",{playerName:""});var LobbyMatchInstance=function(e){function t(){var e,a;_classCallCheck(this,t);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return a=_possibleConstructorReturn(this,(e=_getPrototypeOf(t)).call.apply(e,[this].concat(n))),_defineProperty(_assertThisInitialized(a),"_createSeat",function(e){return e.name||"[free]"}),_defineProperty(_assertThisInitialized(a),"_createButtonJoin",function(e,t){return React.createElement("button",{key:"button-join-"+e.matchID,onClick:function(){return a.props.onClickJoin(e.gameName,e.matchID,""+t)}},"Join")}),_defineProperty(_assertThisInitialized(a),"_createButtonLeave",function(e){return React.createElement("button",{key:"button-leave-"+e.matchID,onClick:function(){return a.props.onClickLeave(e.gameName,e.matchID)}},"Leave")}),_defineProperty(_assertThisInitialized(a),"_createButtonPlay",function(e,t){return React.createElement("button",{key:"button-play-"+e.matchID,onClick:function(){return a.props.onClickPlay(e.gameName,{matchID:e.matchID,playerID:""+t,numPlayers:e.players.length})}},"Play")}),_defineProperty(_assertThisInitialized(a),"_createButtonSpectate",function(e){return React.createElement("button",{key:"button-spectate-"+e.matchID,onClick:function(){return a.props.onClickPlay(e.gameName,{matchID:e.matchID,numPlayers:e.players.length})}},"Spectate")}),_defineProperty(_assertThisInitialized(a),"_createInstanceButtons",function(e){var t=e.players.find(function(e){return e.name===a.props.playerName}),r=e.players.find(function(e){return!e.name});return t&&r?a._createButtonLeave(e):r?a._createButtonJoin(e,r.id):t?React.createElement("div",null,[a._createButtonPlay(e,t.id),a._createButtonLeave(e)]):a._createButtonSpectate(e)}),a}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props.match,t="OPEN";return e.players.find(function(e){return!e.name})||(t="RUNNING"),React.createElement("tr",{key:"line-"+e.matchID},React.createElement("td",{key:"cell-name-"+e.matchID},e.gameName),React.createElement("td",{key:"cell-status-"+e.matchID},t),React.createElement("td",{key:"cell-seats-"+e.matchID},e.players.map(this._createSeat).join(", ")),React.createElement("td",{key:"cell-buttons-"+e.matchID},this._createInstanceButtons(e)))}}]),t}(React.Component);_defineProperty(LobbyMatchInstance,"propTypes",{match:PropTypes.shape({gameName:PropTypes.string.isRequired,matchID:PropTypes.string.isRequired,players:PropTypes.array.isRequired}),playerName:PropTypes.string.isRequired,onClickJoin:PropTypes.func.isRequired,onClickLeave:PropTypes.func.isRequired,onClickPlay:PropTypes.func.isRequired});var LobbyCreateMatchForm=function(e){function t(e){var a;_classCallCheck(this,t),a=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e)),_defineProperty(_assertThisInitialized(a),"state",{selectedGame:0,numPlayers:2}),_defineProperty(_assertThisInitialized(a),"_createGameNameOption",function(e,t){return React.createElement("option",{key:"name-option-"+t,value:t},e.game.name)}),_defineProperty(_assertThisInitialized(a),"_createNumPlayersOption",function(e){return React.createElement("option",{key:"num-option-"+e,value:e},e)}),_defineProperty(_assertThisInitialized(a),"_createNumPlayersRange",function(e){return _toConsumableArray(new Array(e.maxPlayers+1).keys()).slice(e.minPlayers)}),_defineProperty(_assertThisInitialized(a),"onChangeNumPlayers",function(e){a.setState({numPlayers:Number.parseInt(e.target.value)})}),_defineProperty(_assertThisInitialized(a),"onChangeSelectedGame",function(e){var t=Number.parseInt(e.target.value);a.setState({selectedGame:t,numPlayers:a.props.games[t].game.minPlayers})}),_defineProperty(_assertThisInitialized(a),"onClickCreate",function(){a.props.createMatch(a.props.games[a.state.selectedGame].game.name,a.state.numPlayers)});var r=!0,n=!1,i=void 0;try{for(var s,o=e.games[Symbol.iterator]();!(r=(s=o.next()).done);r=!0){var c=s.value.game;c.minPlayers||(c.minPlayers=1),c.maxPlayers||(c.maxPlayers=4),console.assert(c.maxPlayers>=c.minPlayers)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return a.state={selectedGame:0,numPlayers:e.games[0].game.minPlayers},a}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this;return React.createElement("div",null,React.createElement("select",{value:this.state.selectedGame,onChange:function(t){return e.onChangeSelectedGame(t)}},this.props.games.map(this._createGameNameOption)),React.createElement("span",null,"Players:"),React.createElement("select",{value:this.state.numPlayers,onChange:this.onChangeNumPlayers},this._createNumPlayersRange(this.props.games[this.state.selectedGame].game).map(this._createNumPlayersOption)),React.createElement("span",{className:"buttons"},React.createElement("button",{onClick:this.onClickCreate},"Create")))}}]),t}(React.Component);_defineProperty(LobbyCreateMatchForm,"propTypes",{games:PropTypes.array.isRequired,createMatch:PropTypes.func.isRequired});var LobbyPhases={ENTER:"enter",PLAY:"play",LIST:"list"},Lobby=function(e){function t(e){var a;return _classCallCheck(this,t),a=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e)),_defineProperty(_assertThisInitialized(a),"state",{phase:LobbyPhases.ENTER,playerName:"Visitor",runningMatch:null,errorMsg:"",credentialStore:{}}),_defineProperty(_assertThisInitialized(a),"_createConnection",function(e){var t=a.state.playerName;a.connection=LobbyConnection({server:e.lobbyServer,gameComponents:e.gameComponents,playerName:t,playerCredentials:a.state.credentialStore[t]})}),_defineProperty(_assertThisInitialized(a),"_updateCredentials",function(e,t){a.setState(function(a){var r=Object.assign({},a.credentialStore);return r[[e]]=t,{credentialStore:r}})}),_defineProperty(_assertThisInitialized(a),"_updateConnection",async function(){await a.connection.refresh(),a.forceUpdate()}),_defineProperty(_assertThisInitialized(a),"_enterLobby",function(e){a.setState({playerName:e,phase:LobbyPhases.LIST})}),_defineProperty(_assertThisInitialized(a),"_exitLobby",async function(){await a.connection.disconnect(),a.setState({phase:LobbyPhases.ENTER,errorMsg:""})}),_defineProperty(_assertThisInitialized(a),"_createMatch",async function(e,t){try{await a.connection.create(e,t),await a.connection.refresh(),a.setState({})}catch(e){a.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(a),"_joinMatch",async function(e,t,r){try{await a.connection.join(e,t,r),await a.connection.refresh(),a._updateCredentials(a.connection.playerName,a.connection.playerCredentials)}catch(e){a.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(a),"_leaveMatch",async function(e,t){try{await a.connection.leave(e,t),await a.connection.refresh(),a._updateCredentials(a.connection.playerName,a.connection.playerCredentials)}catch(e){a.setState({errorMsg:e.message})}}),_defineProperty(_assertThisInitialized(a),"_startMatch",function(e,t){var r=a.connection._getGameComponents(e);if(r){var n=void 0;if(t.numPlayers>1&&(n=a.props.gameServer?SocketIO({server:a.props.gameServer}):SocketIO()),1==t.numPlayers){for(var i=r.game.maxPlayers,s={},o=1;o<i;o++)s[o+""]=MCTSBot;n=Local({bots:s})}var c={app:a.props.clientFactory({game:r.game,board:r.board,debug:a.props.debug,multiplayer:n}),matchID:t.matchID,playerID:t.numPlayers>1?t.playerID:"0",credentials:a.connection.playerCredentials};a.setState({phase:LobbyPhases.PLAY,runningMatch:c})}else a.setState({errorMsg:"game "+e+" not supported"})}),_defineProperty(_assertThisInitialized(a),"_exitMatch",function(){a.setState({phase:LobbyPhases.LIST,runningMatch:null})}),_defineProperty(_assertThisInitialized(a),"_getPhaseVisibility",function(e){return a.state.phase!==e?"hidden":"phase"}),_defineProperty(_assertThisInitialized(a),"renderMatches",function(e,t){return e.map(function(e){var r=e.matchID,n=e.gameName,i=e.players;return React.createElement(LobbyMatchInstance,{key:"instance-"+r,match:{matchID:r,gameName:n,players:Object.values(i)},playerName:t,onClickJoin:a._joinMatch,onClickLeave:a._leaveMatch,onClickPlay:a._startMatch})})}),a._createConnection(a.props),setInterval(a._updateConnection,a.props.refreshInterval),a}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=Cookies.load("lobbyState")||{};e.phase&&e.phase===LobbyPhases.PLAY&&(e.phase=LobbyPhases.LIST),this.setState({phase:e.phase||LobbyPhases.ENTER,playerName:e.playerName||"Visitor",credentialStore:e.credentialStore||{}})}},{key:"componentDidUpdate",value:function(e,t){var a=this.state.playerName,r=this.state.credentialStore[a];if(t.phase!==this.state.phase||t.credentialStore[a]!==r||t.playerName!==a){this._createConnection(this.props),this._updateConnection();var n={phase:this.state.phase,playerName:a,credentialStore:this.state.credentialStore};Cookies.save("lobbyState",n,{path:"/"})}}},{key:"render",value:function(){var e=this.props,t=e.gameComponents,a=e.renderer,r=this.state,n=r.errorMsg,i=r.playerName,s=r.phase,o=r.runningMatch;return a?a({errorMsg:n,gameComponents:t,matches:this.connection.matches,phase:s,playerName:i,runningMatch:o,handleEnterLobby:this._enterLobby,handleExitLobby:this._exitLobby,handleCreateMatch:this._createMatch,handleJoinMatch:this._joinMatch,handleLeaveMatch:this._leaveMatch,handleExitMatch:this._exitMatch,handleRefreshMatches:this._updateConnection,handleStartMatch:this._startMatch}):React.createElement("div",{id:"lobby-view",style:{padding:50}},React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.ENTER)},React.createElement(LobbyLoginForm,{key:i,playerName:i,onEnter:this._enterLobby})),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.LIST)},React.createElement("p",null,"Welcome, ",i),React.createElement("div",{className:"phase-title",id:"match-creation"},React.createElement("span",null,"Create a match:"),React.createElement(LobbyCreateMatchForm,{games:t,createMatch:this._createMatch})),React.createElement("p",{className:"phase-title"},"Join a match:"),React.createElement("div",{id:"instances"},React.createElement("table",null,React.createElement("tbody",null,this.renderMatches(this.connection.matches,i))),React.createElement("span",{className:"error-msg"},n,React.createElement("br",null))),React.createElement("p",{className:"phase-title"},"Matches that become empty are automatically deleted.")),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.PLAY)},o&&React.createElement(o.app,{matchID:o.matchID,playerID:o.playerID,credentials:o.credentials}),React.createElement("div",{className:"buttons",id:"match-exit"},React.createElement("button",{onClick:this._exitMatch},"Exit match"))),React.createElement("div",{className:"buttons",id:"lobby-exit"},React.createElement("button",{onClick:this._exitLobby},"Exit lobby")))}}]),t}(React.Component);_defineProperty(Lobby,"propTypes",{gameComponents:PropTypes.array.isRequired,lobbyServer:PropTypes.string,gameServer:PropTypes.string,debug:PropTypes.bool,clientFactory:PropTypes.func,refreshInterval:PropTypes.number}),_defineProperty(Lobby,"defaultProps",{debug:!1,clientFactory:Client,refreshInterval:2e3});export{Client,Lobby};