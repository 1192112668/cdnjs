import{a as _classCallCheck,k as _objectSpread2,d as _inherits,f as _possibleConstructorReturn,h as _getPrototypeOf,_ as _createClass,s as sync,o as _toConsumableArray,w as update,r as reset}from"./reducer-3b554105.js";import{S as Sync}from"./base-c99f5be2.js";import{M as Master}from"./master-2f9971d8.js";import io from"socket.io-client";class InMemory extends Sync{constructor(){super(),this.state=new Map,this.initial=new Map,this.metadata=new Map,this.log=new Map}createGame(t,e){this.initial.set(t,e.initialState),this.setState(t,e.initialState),this.setMetadata(t,e.metadata)}setMetadata(t,e){this.metadata.set(t,e)}setState(t,e){this.state.set(t,e);let a=this.log.get(t)||[];e.deltalog&&(a=a.concat(e.deltalog)),this.log.set(t,a)}fetch(t,e){let a={};return e.state&&(a.state=this.state.get(t)),e.metadata&&(a.metadata=this.metadata.get(t)),e.log&&(a.log=this.log.get(t)||[]),e.initialState&&(a.initialState=this.initial.get(t)),a}wipe(t){this.state.delete(t),this.metadata.delete(t)}listGames(t){if(void 0!==t.gameName){let e=[];return this.metadata.forEach((a,s)=>{a.gameName===t.gameName&&e.push(s)}),e}return[...this.metadata.keys()]}}var Transport=function t(e){var a=e.store,s=e.gameName,n=e.playerID,i=e.gameID,r=e.numPlayers;_classCallCheck(this,t),this.store=a,this.gameName=s||"default",this.playerID=n||null,this.gameID="".concat(this.gameName,":").concat(i||"default"),this.numPlayers=r||2};function GetBotPlayer(t,e){if(void 0!==t.ctx.gameover)return null;if(t.ctx.stage)for(var a=0,s=Object.keys(e);a<s.length;a++){var n=s[a];if(n in t.ctx.stage)return n}else if(t.ctx.currentPlayer in e)return t.ctx.currentPlayer;return null}function LocalMaster(t){var e=t.game,a=t.bots,s={},n={};if(e&&e.ai&&a)for(var i in a){var r=a[i];n[i]=new r({game:e,enumerate:e.ai.enumerate,seed:e.seed})}var o=function(t){var e=t.type,a=t.playerID,n=t.args,i=s[a];void 0!==i&&i.apply(null,[e].concat(_toConsumableArray(n)))},c=new Master(e,new InMemory,{send:o,sendAll:function(t){for(var e in s){var a=t(e),n=a.type,i=a.args;o({type:n,playerID:e,args:i})}}},!1);return c.connect=function(t,e,a){s[e]=a},c.subscribe(function(t){var e=t.state,s=t.gameID;if(a){var i=GetBotPlayer(e,n);null!==i&&setTimeout(async function(){var t=await n[i].play(e,i);await c.onUpdate(t.action,e._stateID,s,t.action.payload.playerID)},100)}}),c}var LocalTransport=function(t){function e(t){var a,s=t.master,n=t.game,i=t.store,r=t.gameID,o=t.playerID,c=t.gameName,l=t.numPlayers;return _classCallCheck(this,e),(a=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,{store:i,gameName:c,playerID:o,gameID:r,numPlayers:l}))).master=s,a.game=n,a.isConnected=!0,a}return _inherits(e,Transport),_createClass(e,[{key:"onUpdate",value:async function(t,e,a){var s=this.store.getState();if(t==this.gameID&&e._stateID>=s._stateID){var n=update(e,a);this.store.dispatch(n)}}},{key:"onSync",value:function(t,e){if(t==this.gameID){var a=sync(e);this.store.dispatch(a)}}},{key:"onAction",value:function(t,e){this.master.onUpdate(e,t._stateID,this.gameID,this.playerID)}},{key:"connect",value:function(){var t=this;this.master.connect(this.gameID,this.playerID,function(e){for(var a=arguments.length,s=new Array(a>1?a-1:0),n=1;n<a;n++)s[n-1]=arguments[n];"sync"==e&&t.onSync.apply(t,s),"update"==e&&t.onUpdate.apply(t,s)}),this.master.onSync(this.gameID,this.playerID,this.numPlayers)}},{key:"disconnect",value:function(){}},{key:"subscribe",value:function(){}},{key:"subscribeGameMetadata",value:function(t){}},{key:"updateGameID",value:function(t){this.gameID=this.gameName+":"+t;var e=reset(null);this.store.dispatch(e),this.connect()}},{key:"updatePlayerID",value:function(t){this.playerID=t;var e=reset(null);this.store.dispatch(e),this.connect()}}]),e}(),localMasters=new Map;function Local(t){return function(e){var a;return localMasters.has(e.gameKey)&!t?a=localMasters.get(e.gameKey):(a=new LocalMaster({game:e.game,bots:t&&t.bots}),localMasters.set(e.gameKey,a)),new LocalTransport(_objectSpread2({master:a},e))}}var SocketIOTransport=function(t){function e(){var t,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.socket,n=a.socketOpts,i=a.store,r=a.gameID,o=a.playerID,c=a.gameName,l=a.numPlayers,u=a.server;return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,{store:i,gameName:c,playerID:o,gameID:r,numPlayers:l}))).server=u,t.socket=s,t.socketOpts=n,t.isConnected=!1,t.callback=function(){},t.gameMetadataCallback=function(){},t}return _inherits(e,Transport),_createClass(e,[{key:"onAction",value:function(t,e){this.socket.emit("update",e,t._stateID,this.gameID,this.playerID)}},{key:"connect",value:function(){var t=this;if(!this.socket)if(this.server){var e=this.server;-1==e.search(/^https?:\/\//)&&(e="http://"+this.server),"/"!=e.substr(-1)&&(e+="/"),this.socket=io(e+this.gameName,this.socketOpts)}else this.socket=io("/"+this.gameName,this.socketOpts);this.socket.on("update",function(e,a,s){var n=t.store.getState();if(e==t.gameID&&a._stateID>=n._stateID){var i=update(a,s);t.store.dispatch(i)}}),this.socket.on("sync",function(e,a){if(e==t.gameID){var s=sync(a);t.gameMetadataCallback(a.filteredMetadata),t.store.dispatch(s)}}),this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers),this.socket.on("connect",function(){t.isConnected=!0,t.callback()}),this.socket.on("disconnect",function(){t.isConnected=!1,t.callback()})}},{key:"disconnect",value:function(){this.socket.close(),this.socket=null,this.isConnected=!1,this.callback()}},{key:"subscribe",value:function(t){this.callback=t}},{key:"subscribeGameMetadata",value:function(t){this.gameMetadataCallback=t}},{key:"updateGameID",value:function(t){this.gameID=this.gameName+":"+t;var e=reset(null);this.store.dispatch(e),this.socket&&this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers)}},{key:"updatePlayerID",value:function(t){this.playerID=t;var e=reset(null);this.store.dispatch(e),this.socket&&this.socket.emit("sync",this.gameID,this.playerID,this.numPlayers)}}]),e}();function SocketIO(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.server,a=t.socketOpts;return function(t){return new SocketIOTransport(_objectSpread2({server:e,socketOpts:a},t))}}export{Local as L,SocketIO as S};