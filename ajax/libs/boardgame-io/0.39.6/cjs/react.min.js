"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var reducer=require("./reducer-4406e39f.js");require("redux"),require("immer"),require("./Debug-610def80.js"),require("flatted");var ai=require("./ai-d3e1501b.js");require("./initialize-2f6120b9.js");var client=require("./client-7a343c88.js"),React=_interopDefault(require("react")),PropTypes=_interopDefault(require("prop-types")),Cookies=_interopDefault(require("react-cookies"));require("./base-bdd9c13b.js");var socketio=require("./socketio-d6811f2e.js");function Client(e){var t,r,a=e.game,n=e.numPlayers,i=e.loading,s=e.board,o=e.multiplayer,c=e.enhancer,l=e.debug;if(void 0===i){i=function(){return React.createElement("div",{className:"bgio-loading"},"connecting...")}}return r=t=function(e){function t(e){var r;return reducer._classCallCheck(this,t),r=reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).call(this,e)),void 0===l&&(l=e.debug),r.client=client.Client({game:a,debug:l,numPlayers:n,multiplayer:o,gameID:e.gameID,playerID:e.playerID,credentials:e.credentials,enhancer:c}),r}return reducer._inherits(t,e),reducer._createClass(t,[{key:"componentDidMount",value:function(){var e=this;this.unsubscribe=this.client.subscribe(function(){return e.forceUpdate()}),this.client.start()}},{key:"componentWillUnmount",value:function(){this.client.stop(),this.unsubscribe()}},{key:"componentDidUpdate",value:function(e){this.props.gameID!=e.gameID&&this.client.updateGameID(this.props.gameID),this.props.playerID!=e.playerID&&this.client.updatePlayerID(this.props.playerID),this.props.credentials!=e.credentials&&this.client.updateCredentials(this.props.credentials)}},{key:"render",value:function(){var e=this.client.getState();if(null===e)return React.createElement(i);var t=null;return s&&(t=React.createElement(s,reducer._objectSpread2({},e,{},this.props,{isMultiplayer:!!o,moves:this.client.moves,events:this.client.events,gameID:this.client.gameID,playerID:this.client.playerID,reset:this.client.reset,undo:this.client.undo,redo:this.client.redo,gameMetadata:this.client.gameMetadata}))),React.createElement("div",{className:"bgio-client"},t)}}]),t}(React.Component),reducer._defineProperty(t,"propTypes",{gameID:PropTypes.string,playerID:PropTypes.string,credentials:PropTypes.string,debug:PropTypes.any}),reducer._defineProperty(t,"defaultProps",{gameID:"default",playerID:null,credentials:null,debug:!0}),r}require("./master-d97948bf.js"),require("socket.io-client");var _LobbyConnectionImpl=function(){function e(t){var r=t.server,a=t.gameComponents,n=t.playerName,i=t.playerCredentials;reducer._classCallCheck(this,e),this.gameComponents=a,this.playerName=n||"Visitor",this.playerCredentials=i,this.server=r,this.rooms=[]}return reducer._createClass(e,[{key:"_baseUrl",value:function(){return"".concat(this.server||"","/games")}},{key:"refresh",value:async function(){try{this.rooms.length=0;var e=await fetch(this._baseUrl());if(200!==e.status)throw new Error("HTTP status "+e.status);var t=await e.json(),r=!0,a=!1,n=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;if(this._getGameComponents(o)){var c=await fetch(this._baseUrl()+"/"+o),l=await c.json(),u=!0,m=!1,p=void 0;try{for(var d,y=l.rooms[Symbol.iterator]();!(u=(d=y.next()).done);u=!0){d.value.gameName=o}}catch(e){m=!0,p=e}finally{try{u||null==y.return||y.return()}finally{if(m)throw p}}this.rooms=this.rooms.concat(l.rooms)}}}catch(e){a=!0,n=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw n}}}catch(e){throw new Error("failed to retrieve list of games ("+e+")")}}},{key:"_getGameInstance",value:function(e){var t=!0,r=!1,a=void 0;try{for(var n,i=this.rooms[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var s=n.value;if(s.gameID===e)return s}}catch(e){r=!0,a=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw a}}}},{key:"_getGameComponents",value:function(e){var t=!0,r=!1,a=void 0;try{for(var n,i=this.gameComponents[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var s=n.value;if(s.game.name===e)return s}}catch(e){r=!0,a=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw a}}}},{key:"_findPlayer",value:function(e){var t=!0,r=!1,a=void 0;try{for(var n,i=this.rooms[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var s=n.value;if(s.players.some(function(t){return t.name===e}))return s}}catch(e){r=!0,a=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw a}}}},{key:"join",value:async function(e,t,r){try{var a=this._findPlayer(this.playerName);if(a)throw new Error("player has already joined "+a.gameID);if(!(a=this._getGameInstance(t)))throw new Error("game instance "+t+" not found");var n=await fetch(this._baseUrl()+"/"+e+"/"+t+"/join",{method:"POST",body:JSON.stringify({playerID:r,playerName:this.playerName}),headers:{"Content-Type":"application/json"}});if(200!==n.status)throw new Error("HTTP status "+n.status);var i=await n.json();a.players[Number.parseInt(r)].name=this.playerName,this.playerCredentials=i.playerCredentials}catch(e){throw new Error("failed to join room "+t+" ("+e+")")}}},{key:"leave",value:async function(e,t){try{var r=this._getGameInstance(t);if(!r)throw new Error("game instance not found");var a=!0,n=!1,i=void 0;try{for(var s,o=r.players[Symbol.iterator]();!(a=(s=o.next()).done);a=!0){var c=s.value;if(c.name===this.playerName){var l=await fetch(this._baseUrl()+"/"+e+"/"+t+"/leave",{method:"POST",body:JSON.stringify({playerID:c.id,credentials:this.playerCredentials}),headers:{"Content-Type":"application/json"}});if(200!==l.status)throw new Error("HTTP status "+l.status);return delete c.name,void delete this.playerCredentials}}}catch(e){n=!0,i=e}finally{try{a||null==o.return||o.return()}finally{if(n)throw i}}throw new Error("player not found in room")}catch(e){throw new Error("failed to leave room "+t+" ("+e+")")}}},{key:"disconnect",value:async function(){var e=this._findPlayer(this.playerName);e&&await this.leave(e.gameName,e.gameID),this.rooms=[],this.playerName="Visitor"}},{key:"create",value:async function(e,t){try{var r=this._getGameComponents(e);if(!r)throw new Error("game not found");if(t<r.game.minPlayers||t>r.game.maxPlayers)throw new Error("invalid number of players "+t);var a=await fetch(this._baseUrl()+"/"+e+"/create",{method:"POST",body:JSON.stringify({numPlayers:t}),headers:{"Content-Type":"application/json"}});if(200!==a.status)throw new Error("HTTP status "+a.status)}catch(t){throw new Error("failed to create room for "+e+" ("+t+")")}}}]),e}();function LobbyConnection(e){return new _LobbyConnectionImpl(e)}var LobbyLoginForm=function(e){function t(){var e,r;reducer._classCallCheck(this,t);for(var a=arguments.length,n=new Array(a),i=0;i<a;i++)n[i]=arguments[i];return r=reducer._possibleConstructorReturn(this,(e=reducer._getPrototypeOf(t)).call.apply(e,[this].concat(n))),reducer._defineProperty(reducer._assertThisInitialized(r),"state",{playerName:r.props.playerName,nameErrorMsg:""}),reducer._defineProperty(reducer._assertThisInitialized(r),"onClickEnter",function(){""!==r.state.playerName&&r.props.onEnter(r.state.playerName)}),reducer._defineProperty(reducer._assertThisInitialized(r),"onKeyPress",function(e){"Enter"===e.key&&r.onClickEnter()}),reducer._defineProperty(reducer._assertThisInitialized(r),"onChangePlayerName",function(e){var t=e.target.value.trim();r.setState({playerName:t,nameErrorMsg:t.length>0?"":"empty player name"})}),r}return reducer._inherits(t,e),reducer._createClass(t,[{key:"render",value:function(){return React.createElement("div",null,React.createElement("p",{className:"phase-title"},"Choose a player name:"),React.createElement("input",{type:"text",value:this.state.playerName,onChange:this.onChangePlayerName,onKeyPress:this.onKeyPress}),React.createElement("span",{className:"buttons"},React.createElement("button",{className:"buttons",onClick:this.onClickEnter},"Enter")),React.createElement("br",null),React.createElement("span",{className:"error-msg"},this.state.nameErrorMsg,React.createElement("br",null)))}}]),t}(React.Component);reducer._defineProperty(LobbyLoginForm,"propTypes",{playerName:PropTypes.string,onEnter:PropTypes.func.isRequired}),reducer._defineProperty(LobbyLoginForm,"defaultProps",{playerName:""});var LobbyRoomInstance=function(e){function t(){var e,r;reducer._classCallCheck(this,t);for(var a=arguments.length,n=new Array(a),i=0;i<a;i++)n[i]=arguments[i];return r=reducer._possibleConstructorReturn(this,(e=reducer._getPrototypeOf(t)).call.apply(e,[this].concat(n))),reducer._defineProperty(reducer._assertThisInitialized(r),"_createSeat",function(e){return e.name||"[free]"}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createButtonJoin",function(e,t){return React.createElement("button",{key:"button-join-"+e.gameID,onClick:function(){return r.props.onClickJoin(e.gameName,e.gameID,""+t)}},"Join")}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createButtonLeave",function(e){return React.createElement("button",{key:"button-leave-"+e.gameID,onClick:function(){return r.props.onClickLeave(e.gameName,e.gameID)}},"Leave")}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createButtonPlay",function(e,t){return React.createElement("button",{key:"button-play-"+e.gameID,onClick:function(){return r.props.onClickPlay(e.gameName,{gameID:e.gameID,playerID:""+t,numPlayers:e.players.length})}},"Play")}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createButtonSpectate",function(e){return React.createElement("button",{key:"button-spectate-"+e.gameID,onClick:function(){return r.props.onClickPlay(e.gameName,{gameID:e.gameID,numPlayers:e.players.length})}},"Spectate")}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createInstanceButtons",function(e){var t=e.players.find(function(e){return e.name===r.props.playerName}),a=e.players.find(function(e){return!e.name});return t&&a?r._createButtonLeave(e):a?r._createButtonJoin(e,a.id):t?React.createElement("div",null,[r._createButtonPlay(e,t.id),r._createButtonLeave(e)]):r._createButtonSpectate(e)}),r}return reducer._inherits(t,e),reducer._createClass(t,[{key:"render",value:function(){var e=this.props.room,t="OPEN";return e.players.find(function(e){return!e.name})||(t="RUNNING"),React.createElement("tr",{key:"line-"+e.gameID},React.createElement("td",{key:"cell-name-"+e.gameID},e.gameName),React.createElement("td",{key:"cell-status-"+e.gameID},t),React.createElement("td",{key:"cell-seats-"+e.gameID},e.players.map(this._createSeat).join(", ")),React.createElement("td",{key:"cell-buttons-"+e.gameID},this._createInstanceButtons(e)))}}]),t}(React.Component);reducer._defineProperty(LobbyRoomInstance,"propTypes",{room:PropTypes.shape({gameName:PropTypes.string.isRequired,gameID:PropTypes.string.isRequired,players:PropTypes.array.isRequired}),playerName:PropTypes.string.isRequired,onClickJoin:PropTypes.func.isRequired,onClickLeave:PropTypes.func.isRequired,onClickPlay:PropTypes.func.isRequired});var LobbyCreateRoomForm=function(e){function t(e){var r;reducer._classCallCheck(this,t),r=reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).call(this,e)),reducer._defineProperty(reducer._assertThisInitialized(r),"state",{selectedGame:0,numPlayers:2}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createGameNameOption",function(e,t){return React.createElement("option",{key:"name-option-"+t,value:t},e.game.name)}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createNumPlayersOption",function(e){return React.createElement("option",{key:"num-option-"+e,value:e},e)}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createNumPlayersRange",function(e){return reducer._toConsumableArray(new Array(e.maxPlayers+1).keys()).slice(e.minPlayers)}),reducer._defineProperty(reducer._assertThisInitialized(r),"onChangeNumPlayers",function(e){r.setState({numPlayers:Number.parseInt(e.target.value)})}),reducer._defineProperty(reducer._assertThisInitialized(r),"onChangeSelectedGame",function(e){var t=Number.parseInt(e.target.value);r.setState({selectedGame:t,numPlayers:r.props.games[t].game.minPlayers})}),reducer._defineProperty(reducer._assertThisInitialized(r),"onClickCreate",function(){r.props.createGame(r.props.games[r.state.selectedGame].game.name,r.state.numPlayers)});var a=!0,n=!1,i=void 0;try{for(var s,o=e.games[Symbol.iterator]();!(a=(s=o.next()).done);a=!0){var c=s.value.game;c.minPlayers||(c.minPlayers=1),c.maxPlayers||(c.maxPlayers=4),console.assert(c.maxPlayers>=c.minPlayers)}}catch(e){n=!0,i=e}finally{try{a||null==o.return||o.return()}finally{if(n)throw i}}return r.state={selectedGame:0,numPlayers:e.games[0].game.minPlayers},r}return reducer._inherits(t,e),reducer._createClass(t,[{key:"render",value:function(){var e=this;return React.createElement("div",null,React.createElement("select",{value:this.state.selectedGame,onChange:function(t){return e.onChangeSelectedGame(t)}},this.props.games.map(this._createGameNameOption)),React.createElement("span",null,"Players:"),React.createElement("select",{value:this.state.numPlayers,onChange:this.onChangeNumPlayers},this._createNumPlayersRange(this.props.games[this.state.selectedGame].game).map(this._createNumPlayersOption)),React.createElement("span",{className:"buttons"},React.createElement("button",{onClick:this.onClickCreate},"Create")))}}]),t}(React.Component);reducer._defineProperty(LobbyCreateRoomForm,"propTypes",{games:PropTypes.array.isRequired,createGame:PropTypes.func.isRequired});var LobbyPhases={ENTER:"enter",PLAY:"play",LIST:"list"},Lobby=function(e){function t(e){var r;return reducer._classCallCheck(this,t),r=reducer._possibleConstructorReturn(this,reducer._getPrototypeOf(t).call(this,e)),reducer._defineProperty(reducer._assertThisInitialized(r),"state",{phase:LobbyPhases.ENTER,playerName:"Visitor",runningGame:null,errorMsg:"",credentialStore:{}}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createConnection",function(e){var t=r.state.playerName;r.connection=LobbyConnection({server:e.lobbyServer,gameComponents:e.gameComponents,playerName:t,playerCredentials:r.state.credentialStore[t]})}),reducer._defineProperty(reducer._assertThisInitialized(r),"_updateCredentials",function(e,t){r.setState(function(r){var a=Object.assign({},r.credentialStore);return a[[e]]=t,{credentialStore:a}})}),reducer._defineProperty(reducer._assertThisInitialized(r),"_updateConnection",async function(){await r.connection.refresh(),r.forceUpdate()}),reducer._defineProperty(reducer._assertThisInitialized(r),"_enterLobby",function(e){r.setState({playerName:e,phase:LobbyPhases.LIST})}),reducer._defineProperty(reducer._assertThisInitialized(r),"_exitLobby",async function(){await r.connection.disconnect(),r.setState({phase:LobbyPhases.ENTER,errorMsg:""})}),reducer._defineProperty(reducer._assertThisInitialized(r),"_createRoom",async function(e,t){try{await r.connection.create(e,t),await r.connection.refresh(),r.setState({})}catch(e){r.setState({errorMsg:e.message})}}),reducer._defineProperty(reducer._assertThisInitialized(r),"_joinRoom",async function(e,t,a){try{await r.connection.join(e,t,a),await r.connection.refresh(),r._updateCredentials(r.connection.playerName,r.connection.playerCredentials)}catch(e){r.setState({errorMsg:e.message})}}),reducer._defineProperty(reducer._assertThisInitialized(r),"_leaveRoom",async function(e,t){try{await r.connection.leave(e,t),await r.connection.refresh(),r._updateCredentials(r.connection.playerName,r.connection.playerCredentials)}catch(e){r.setState({errorMsg:e.message})}}),reducer._defineProperty(reducer._assertThisInitialized(r),"_startGame",function(e,t){var a=r.connection._getGameComponents(e);if(a){var n=void 0;if(t.numPlayers>1&&(n=r.props.gameServer?socketio.SocketIO({server:r.props.gameServer}):socketio.SocketIO()),1==t.numPlayers){for(var i=a.game.maxPlayers,s={},o=1;o<i;o++)s[o+""]=ai.MCTSBot;n=socketio.Local({bots:s})}var c={app:r.props.clientFactory({game:a.game,board:a.board,debug:r.props.debug,multiplayer:n}),gameID:t.gameID,playerID:t.numPlayers>1?t.playerID:"0",credentials:r.connection.playerCredentials};r.setState({phase:LobbyPhases.PLAY,runningGame:c})}else r.setState({errorMsg:"game "+e+" not supported"})}),reducer._defineProperty(reducer._assertThisInitialized(r),"_exitRoom",function(){r.setState({phase:LobbyPhases.LIST,runningGame:null})}),reducer._defineProperty(reducer._assertThisInitialized(r),"_getPhaseVisibility",function(e){return r.state.phase!==e?"hidden":"phase"}),reducer._defineProperty(reducer._assertThisInitialized(r),"renderRooms",function(e,t){return e.map(function(e){var a=e.gameID,n=e.gameName,i=e.players;return React.createElement(LobbyRoomInstance,{key:"instance-"+a,room:{gameID:a,gameName:n,players:Object.values(i)},playerName:t,onClickJoin:r._joinRoom,onClickLeave:r._leaveRoom,onClickPlay:r._startGame})})}),r._createConnection(r.props),setInterval(r._updateConnection,r.props.refreshInterval),r}return reducer._inherits(t,e),reducer._createClass(t,[{key:"componentDidMount",value:function(){var e=Cookies.load("lobbyState")||{};e.phase&&e.phase===LobbyPhases.PLAY&&(e.phase=LobbyPhases.LIST),this.setState({phase:e.phase||LobbyPhases.ENTER,playerName:e.playerName||"Visitor",credentialStore:e.credentialStore||{}})}},{key:"componentDidUpdate",value:function(e,t){var r=this.state.playerName,a=this.state.credentialStore[r];if(t.phase!==this.state.phase||t.credentialStore[r]!==a||t.playerName!==r){this._createConnection(this.props),this._updateConnection();var n={phase:this.state.phase,playerName:r,credentialStore:this.state.credentialStore};Cookies.save("lobbyState",n,{path:"/"})}}},{key:"render",value:function(){var e=this.props,t=e.gameComponents,r=e.renderer,a=this.state,n=a.errorMsg,i=a.playerName,s=a.phase,o=a.runningGame;return r?r({errorMsg:n,gameComponents:t,rooms:this.connection.rooms,phase:s,playerName:i,runningGame:o,handleEnterLobby:this._enterLobby,handleExitLobby:this._exitLobby,handleCreateRoom:this._createRoom,handleJoinRoom:this._joinRoom,handleLeaveRoom:this._leaveRoom,handleExitRoom:this._exitRoom,handleRefreshRooms:this._updateConnection,handleStartGame:this._startGame}):React.createElement("div",{id:"lobby-view",style:{padding:50}},React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.ENTER)},React.createElement(LobbyLoginForm,{key:i,playerName:i,onEnter:this._enterLobby})),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.LIST)},React.createElement("p",null,"Welcome, ",i),React.createElement("div",{className:"phase-title",id:"game-creation"},React.createElement("span",null,"Create a room:"),React.createElement(LobbyCreateRoomForm,{games:t,createGame:this._createRoom})),React.createElement("p",{className:"phase-title"},"Join a room:"),React.createElement("div",{id:"instances"},React.createElement("table",null,React.createElement("tbody",null,this.renderRooms(this.connection.rooms,i))),React.createElement("span",{className:"error-msg"},n,React.createElement("br",null))),React.createElement("p",{className:"phase-title"},"Rooms that become empty are automatically deleted.")),React.createElement("div",{className:this._getPhaseVisibility(LobbyPhases.PLAY)},o&&React.createElement(o.app,{gameID:o.gameID,playerID:o.playerID,credentials:o.credentials}),React.createElement("div",{className:"buttons",id:"game-exit"},React.createElement("button",{onClick:this._exitRoom},"Exit game"))),React.createElement("div",{className:"buttons",id:"lobby-exit"},React.createElement("button",{onClick:this._exitLobby},"Exit lobby")))}}]),t}(React.Component);reducer._defineProperty(Lobby,"propTypes",{gameComponents:PropTypes.array.isRequired,lobbyServer:PropTypes.string,gameServer:PropTypes.string,debug:PropTypes.bool,clientFactory:PropTypes.func,refreshInterval:PropTypes.number}),reducer._defineProperty(Lobby,"defaultProps",{debug:!1,clientFactory:Client,refreshInterval:2e3}),exports.Client=Client,exports.Lobby=Lobby;