var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};import{EX_VERSION}from"./";import{polyfill}from"./Polyfill";polyfill();import{Promise}from"./Promises";import{Vector}from"./Algebra";import{ScreenElement}from"./ScreenElement";import{Actor}from"./Actor";import{Timer}from"./Timer";import{TileMap}from"./TileMap";import{Loader}from"./Loader";import{Detector}from"./Util/Detector";import{VisibleEvent,HiddenEvent,GameStartEvent,GameStopEvent,PreUpdateEvent,PostUpdateEvent,PreFrameEvent,PostFrameEvent,DeactivateEvent,ActivateEvent,PreDrawEvent,PostDrawEvent,InitializeEvent}from"./Events";import{Logger,LogLevel}from"./Util/Log";import{Color}from"./Drawing/Color";import{Scene}from"./Scene";import{Debug}from"./Debug";import{Class}from"./Class";import*as Input from"./Input/Index";import{BoundingBox}from"./Collision/BoundingBox";import{BrowserEvents}from"./Util/Browser";export var DisplayMode;!function(e){e[e.FullScreen=0]="FullScreen",e[e.Container=1]="Container",e[e.Fixed=2]="Fixed",e[e.Position=3]="Position"}(DisplayMode||(DisplayMode={}));export var ScrollPreventionMode;!function(e){e[e.None=0]="None",e[e.Canvas=1]="Canvas",e[e.All=2]="All"}(ScrollPreventionMode||(ScrollPreventionMode={}));var Engine=function(e){function t(i){var n=e.call(this)||this;n._hasStarted=!1,n.postProcessors=[],n.scenes={},n._animations=[],n.isFullscreen=!1,n.displayMode=DisplayMode.FullScreen,n._suppressHiDPIScaling=!1,n._suppressPlayButton=!1,n.pauseAudioWhenHidden=!0,n.isDebug=!1,n.debugColor=new Color(255,255,255),n.enableCanvasTransparency=!0,n.onFatalException=function(e){Logger.getInstance().fatal(e)},n._isSmoothingEnabled=!0,n._timescale=1,n._isLoading=!1,n._isInitialized=!1,i=__assign(__assign({},t._DefaultEngineOptions),i),n.browser=new BrowserEvents(window,document);var o=new Detector;if(!i.suppressMinimumBrowserFeatureDetection&&!(n._compatible=o.test())){var s=document.createElement("div");if(s.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(s),o.failedTests.forEach(function(e){var t=document.createElement("div");t.innerText="Browser feature missing "+e,document.body.appendChild(t)}),i.canvasElementId){var r=document.getElementById(i.canvasElementId);r&&r.parentElement.removeChild(r)}return n}return n._compatible=!0,console.log&&!i.suppressConsoleBootMessage&&(console.log("%cPowered by Excalibur.js (v"+EX_VERSION+")","background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log("\n      /| ________________\nO|===|* >________________>\n      \\|"),console.log("Visit","http://excaliburjs.com","for more information")),i.suppressPlayButton&&(n._suppressPlayButton=!0),n._logger=Logger.getInstance(),n._logger.defaultLevel===LogLevel.Debug&&o.logBrowserFeatures(),n._logger.debug("Building engine..."),n.canvasElementId=i.canvasElementId,i.canvasElementId?(n._logger.debug("Using Canvas element specified: "+i.canvasElementId),n.canvas=document.getElementById(i.canvasElementId)):i.canvasElement?(n._logger.debug("Using Canvas element specified:",i.canvasElement),n.canvas=i.canvasElement):(n._logger.debug("Using generated canvas element"),n.canvas=document.createElement("canvas")),i.width&&i.height?(void 0===i.displayMode&&(n.displayMode=DisplayMode.Fixed),n._logger.debug("Engine viewport is size "+i.width+" x "+i.height),n.canvas.width=i.width,n.canvas.height=i.height):i.displayMode||(n._logger.debug("Engine viewport is fullscreen"),n.displayMode=DisplayMode.FullScreen),i.backgroundColor&&(n.backgroundColor=i.backgroundColor.clone()),n.enableCanvasTransparency=i.enableCanvasTransparency,n._loader=new Loader,n.debug=new Debug(n),n._initialize(i),n.rootScene=n.currentScene=new Scene(n),n.addScene("root",n.rootScene),n.goToScene("root"),n}return __extends(t,e),Object.defineProperty(t.prototype,"canvasWidth",{get:function(){return this.canvas.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"halfCanvasWidth",{get:function(){return this.canvas.width/2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canvasHeight",{get:function(){return this.canvas.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"halfCanvasHeight",{get:function(){return this.canvas.height/2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"drawWidth",{get:function(){return this.currentScene&&this.currentScene.camera?this.canvasWidth/this.currentScene.camera.getZoom()/this.pixelRatio:this.canvasWidth/this.pixelRatio},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"halfDrawWidth",{get:function(){return this.drawWidth/2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"drawHeight",{get:function(){return this.currentScene&&this.currentScene.camera?this.canvasHeight/this.currentScene.camera.getZoom()/this.pixelRatio:this.canvasHeight/this.pixelRatio},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"halfDrawHeight",{get:function(){return this.drawHeight/2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isHiDpi",{get:function(){return 1!==this.pixelRatio},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stats",{get:function(){return this.debug.stats},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pixelRatio",{get:function(){return this._suppressHiDPIScaling?1:window.devicePixelRatio<1?1:window.devicePixelRatio||1},enumerable:!0,configurable:!0}),t.prototype.on=function(t,i){e.prototype.on.call(this,t,i)},t.prototype.once=function(t,i){e.prototype.once.call(this,t,i)},t.prototype.off=function(t,i){e.prototype.off.call(this,t,i)},t.prototype.getWorldBounds=function(){var e=this.screenToWorldCoordinates(Vector.Zero).x,t=this.screenToWorldCoordinates(Vector.Zero).y,i=e+this.drawWidth,n=t+this.drawHeight;return new BoundingBox(e,t,i,n)},Object.defineProperty(t.prototype,"timescale",{get:function(){return this._timescale},set:function(e){e<=0?Logger.getInstance().error("Cannot set engine.timescale to a value of 0 or less than 0."):this._timescale=e},enumerable:!0,configurable:!0}),t.prototype.playAnimation=function(e,t,i){this._animations.push(new AnimationNode(e,t,i))},t.prototype.addTileMap=function(e){this.currentScene.addTileMap(e)},t.prototype.removeTileMap=function(e){this.currentScene.removeTileMap(e)},t.prototype.addTimer=function(e){return this.currentScene.addTimer(e)},t.prototype.removeTimer=function(e){return this.currentScene.removeTimer(e)},t.prototype.addScene=function(e,t){this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=t},t.prototype.removeScene=function(e){if(e instanceof Scene)for(var t in this.scenes)this.scenes.hasOwnProperty(t)&&this.scenes[t]===e&&delete this.scenes[t];"string"==typeof e&&delete this.scenes[e]},t.prototype.add=function(e){e instanceof ScreenElement?this.currentScene.addScreenElement(e):(e instanceof Actor&&this._addChild(e),e instanceof Timer&&this.addTimer(e),e instanceof TileMap&&this.addTileMap(e),2===arguments.length&&this.addScene(arguments[0],arguments[1]))},t.prototype.remove=function(e){e instanceof ScreenElement?this.currentScene.removeScreenElement(e):(e instanceof Actor&&this._removeChild(e),e instanceof Timer&&this.removeTimer(e),e instanceof TileMap&&this.removeTileMap(e),e instanceof Scene&&this.removeScene(e),"string"==typeof e&&this.removeScene(e))},t.prototype._addChild=function(e){this.currentScene.add(e)},t.prototype._removeChild=function(e){this.currentScene.remove(e)},t.prototype.goToScene=function(e){if(this.scenes[e]){var t=this.currentScene,i=this.scenes[e];this._logger.debug("Going to scene:",e),this.currentScene.isInitialized&&(this.currentScene._deactivate.call(this.currentScene,[t,i]),this.currentScene.eventDispatcher.emit("deactivate",new DeactivateEvent(i,this.currentScene))),this.currentScene=i,this.currentScene._initialize(this),this.currentScene._activate.call(this.currentScene,[t,i]),this.currentScene.eventDispatcher.emit("activate",new ActivateEvent(t,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")},t.prototype.screenToWorldCoordinates=function(e){var t=e.x,i=e.y;if(t=t/this.canvas.clientWidth*this.drawWidth,i=i/this.canvas.clientHeight*this.drawHeight,t-=this.halfDrawWidth,i-=this.halfDrawHeight,this.currentScene&&this.currentScene.camera){var n=this.currentScene.camera.getFocus();t+=n.x,i+=n.y}return new Vector(Math.floor(t),Math.floor(i))},t.prototype.worldToScreenCoordinates=function(e){var t=e.x,i=e.y;if(this.currentScene&&this.currentScene.camera){var n=this.currentScene.camera.getFocus();t-=n.x,i-=n.y}return t+=this.halfDrawWidth,i+=this.halfDrawHeight,t=t*this.canvas.clientWidth/this.drawWidth,i=i*this.canvas.clientHeight/this.drawHeight,new Vector(Math.floor(t),Math.floor(i))},t.prototype._setHeightByDisplayMode=function(e){this.displayMode===DisplayMode.Container&&(this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight),this.displayMode===DisplayMode.FullScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.width=e.innerWidth,this.canvas.height=e.innerHeight)},t.prototype._initialize=function(e){var t,i,n=this;if(e.displayMode&&(this.displayMode=e.displayMode),this.displayMode===DisplayMode.FullScreen||this.displayMode===DisplayMode.Container){var o=this.displayMode===DisplayMode.Container?this.canvas.parentElement||document.body:window;this._setHeightByDisplayMode(o),this.browser.window.on("resize",function(){n._logger.debug("View port resized"),n._setHeightByDisplayMode(o),n._logger.info("parent.clientHeight "+o.clientHeight),n.setAntialiasing(n._isSmoothingEnabled)})}else this.displayMode===DisplayMode.Position&&this._initializeDisplayModePosition(e);this.pageScrollPreventionMode=e.scrollPreventionMode,this.input={keyboard:new Input.Keyboard,pointers:new Input.Pointers(this),gamepads:new Input.Gamepads},this.input.keyboard.init(),this.input.pointers.init(e&&e.pointerScope===Input.PointerScope.Document?document:this.canvas),this.input.gamepads.init(),void 0!==document.hidden?(t="hidden",i="visibilitychange"):"msHidden"in document?(t="msHidden",i="msvisibilitychange"):"webkitHidden"in document&&(t="webkitHidden",i="webkitvisibilitychange"),this.browser.document.on(i,function(){document[t]?(n.eventDispatcher.emit("hidden",new HiddenEvent(n)),n._logger.debug("Window hidden")):(n.eventDispatcher.emit("visible",new VisibleEvent(n)),n._logger.debug("Window visible"))}),this.ctx=this.canvas.getContext("2d",{alpha:this.enableCanvasTransparency}),this._suppressHiDPIScaling=!!e.suppressHiDPIScaling,e.suppressHiDPIScaling||this._initializeHiDpi(),this.canvasElementId||e.canvasElement||document.body.appendChild(this.canvas)},t.prototype.onInitialize=function(e){},t.prototype._initializeDisplayModePosition=function(e){if(!e.position)throw new Error("DisplayMode of Position was selected but no position option was given");if(this.canvas.style.display="block",this.canvas.style.position="absolute","string"==typeof e.position){var t=e.position.split(" ");switch(t[0]){case"top":this.canvas.style.top="0px";break;case"bottom":this.canvas.style.bottom="0px";break;case"middle":this.canvas.style.top="50%";var i=-this.halfDrawHeight;this.canvas.style.marginTop=i.toString();break;default:throw new Error("Invalid Position Given")}if(t[1])switch(t[1]){case"left":this.canvas.style.left="0px";break;case"right":this.canvas.style.right="0px";break;case"center":this.canvas.style.left="50%";var n=-this.halfDrawWidth;this.canvas.style.marginLeft=n.toString();break;default:throw new Error("Invalid Position Given")}}else e.position.top&&("number"==typeof e.position.top?this.canvas.style.top=e.position.top.toString()+"px":this.canvas.style.top=e.position.top),e.position.right&&("number"==typeof e.position.right?this.canvas.style.right=e.position.right.toString()+"px":this.canvas.style.right=e.position.right),e.position.bottom&&("number"==typeof e.position.bottom?this.canvas.style.bottom=e.position.bottom.toString()+"px":this.canvas.style.bottom=e.position.bottom),e.position.left&&("number"==typeof e.position.left?this.canvas.style.left=e.position.left.toString()+"px":this.canvas.style.left=e.position.left)},t.prototype._initializeHiDpi=function(){if(this.isHiDpi){var e=this.canvas.width,t=this.canvas.height;this.canvas.width=e*this.pixelRatio,this.canvas.height=t*this.pixelRatio,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this._logger.warn("Hi DPI screen detected, resetting canvas resolution from \n                           "+e+"x"+t+" to "+this.canvas.width+"x"+this.canvas.height+" \n                           css size will remain "+e+"x"+t),this.ctx.scale(this.pixelRatio,this.pixelRatio),this._logger.warn("Canvas drawing context was scaled by "+this.pixelRatio)}},t.prototype.setAntialiasing=function(e){this._isSmoothingEnabled=e;var t=this.ctx;t.imageSmoothingEnabled=e;for(var i=0,n=["webkitImageSmoothingEnabled","mozImageSmoothingEnabled","msImageSmoothingEnabled"];i<n.length;i++){var o=n[i];o in t&&(t[o]=e)}},t.prototype.getAntialiasing=function(){return this.ctx.imageSmoothingEnabled||this.ctx.webkitImageSmoothingEnabled||this.ctx.mozImageSmoothingEnabled||this.ctx.msImageSmoothingEnabled},Object.defineProperty(t.prototype,"isInitialized",{get:function(){return this._isInitialized},enumerable:!0,configurable:!0}),t.prototype._overrideInitialize=function(t){this.isInitialized||(this.onInitialize(t),e.prototype.emit.call(this,"initialize",new InitializeEvent(t,this)),this._isInitialized=!0)},t.prototype._update=function(e){if(this._isLoading)return this._loader.update(this,e),this.input.keyboard.update(),this.input.pointers.update(),void this.input.gamepads.update();this._overrideInitialize(this),this._preupdate(e),this.currentScene.update(this,e),this._animations=this._animations.filter(function(e){return!e.animation.isDone()}),this.input.keyboard.update(),this.input.pointers.update(),this.input.gamepads.update(),this._postupdate(e)},t.prototype._preupdate=function(e){this.emit("preupdate",new PreUpdateEvent(this,e,this)),this.onPreUpdate(this,e)},t.prototype.onPreUpdate=function(e,t){},t.prototype._postupdate=function(e){this.emit("postupdate",new PostUpdateEvent(this,e,this)),this.onPostUpdate(this,e)},t.prototype.onPostUpdate=function(e,t){},t.prototype._draw=function(e){var t=this.ctx;if(this._predraw(t,e),this._isLoading)this._loader.draw(t,e);else{t.clearRect(0,0,this.canvasWidth,this.canvasHeight),t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.currentScene.draw(this.ctx,e);for(var i=0,n=this._animations.length;i<n;i++)this._animations[i].animation.draw(t,this._animations[i].x,this._animations[i].y);if(this.isDebug){this.ctx.font="Consolas",this.ctx.fillStyle=this.debugColor.toString();for(var o=this.input.keyboard.getKeys(),s=0;s<o.length;s++)this.ctx.fillText(o[s].toString()+" : "+(Input.Keys[o[s]]?Input.Keys[o[s]]:"Not Mapped"),100,10*s+10);this.ctx.fillText("FPS:"+this.stats.currFrame.fps.toFixed(2).toString(),10,10)}for(var r=0;r<this.postProcessors.length;r++)this.postProcessors[r].process(this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight),this.ctx);this._postdraw(t,e)}},t.prototype._predraw=function(e,t){this.emit("predraw",new PreDrawEvent(e,t,this)),this.onPreDraw(e,t)},t.prototype.onPreDraw=function(e,t){},t.prototype._postdraw=function(e,t){this.emit("postdraw",new PostDrawEvent(e,t,this)),this.onPostDraw(e,t)},t.prototype.onPostDraw=function(e,t){},t.prototype.start=function(e){var i,n=this;return this._compatible?(e?(this._loader=e,this._loader.suppressPlayButton=this._suppressPlayButton||this._loader.suppressPlayButton,this._loader.wireEngine(this),i=this.load(this._loader)):i=Promise.resolve(),i.then(function(){n.emit("start",new GameStartEvent(n))}),this._hasStarted||(this._hasStarted=!0,this._logger.debug("Starting game..."),this.browser.resume(),t.createMainLoop(this,window.requestAnimationFrame,Date.now)(),this._logger.debug("Game started")),i):(new Promise).reject("Excalibur is incompatible with your browser")},t.createMainLoop=function(e,t,i){var n=i();return function o(){if(e._hasStarted)try{e._requestId=t(o),e.emit("preframe",new PreFrameEvent(e,e.stats.prevFrame));var s=i(),r=Math.floor(s-n)||1;r>200&&(r=1);var a=r*e.timescale,c=e.stats.prevFrame.id+1;e.stats.prevFrame.reset(e.stats.currFrame),e.stats.currFrame.reset(),e.stats.currFrame.id=c,e.stats.currFrame.delta=a,e.stats.currFrame.fps=1/(a/1e3);var l=i();e._update(a);var p=i();e._draw(a);var h=i();e.stats.currFrame.duration.update=p-l,e.stats.currFrame.duration.draw=h-p,n=s,e.emit("postframe",new PostFrameEvent(e,e.stats.currFrame))}catch(t){window.cancelAnimationFrame(e._requestId),e.stop(),e.onFatalException(t)}}},t.prototype.stop=function(){this._hasStarted&&(this.emit("stop",new GameStopEvent(this)),this.browser.pause(),this._hasStarted=!1,this._logger.debug("Game stopped"))},t.prototype.isPaused=function(){return!this._hasStarted},t.prototype.screenshot=function(){var e=new Image,t=this.canvas.toDataURL("image/png");return e.src=t,e},t.prototype.load=function(e){var t=this,i=new Promise;return this._isLoading=!0,e.load().then(function(){t._suppressPlayButton?setTimeout(function(){t._isLoading=!1,i.resolve()},500):(t._isLoading=!1,i.resolve())}),i},t._DefaultEngineOptions={width:0,height:0,enableCanvasTransparency:!0,canvasElementId:"",canvasElement:void 0,pointerScope:Input.PointerScope.Document,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,scrollPreventionMode:ScrollPreventionMode.Canvas,backgroundColor:Color.fromHex("#2185d0")},t}(Class);export{Engine};var AnimationNode=function(){return function(e,t,i){this.animation=e,this.x=t,this.y=i}}();