var __extends=this&&this.__extends||function(){var t=function(e,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(e,o)};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}();import{Color}from"./Drawing/Color";import{WebAudio}from"./Util/WebAudio";import{Logger}from"./Util/Log";import{Promise,PromiseState}from"./Promises";import{Class}from"./Class";import*as DrawUtil from"./Util/DrawUtil";import logoImg from"./Loader.logo.png";import loaderCss from"./Loader.css";var Loader=function(t){function e(e){var o=t.call(this)||this;return o._resourceList=[],o._index=0,o._playButtonShown=!1,o._resourceCount=0,o._numLoaded=0,o._progressCounts={},o._totalCounts={},o.logo=logoImg,o.logoWidth=468,o.logoHeight=118,o.backgroundColor="#176BAA",o.suppressPlayButton=!1,o._playButtonStyles=loaderCss.toString(),o.playButtonText="Play game",o.startButtonFactory=function(){var t=document.createElement("button");return t.id="excalibur-play",t.textContent=o.playButtonText,t.style.display="none",t},o.getData=function(){},o.setData=function(){},o.processData=function(){},o.onprogress=function(t){Logger.getInstance().debug("[ex.Loader] Loading "+(100*t.loaded/t.total).toFixed(0))},o.oncomplete=function(){},o.onerror=function(){},e&&o.addResources(e),o}return __extends(e,t),Object.defineProperty(e.prototype,"_image",{get:function(){return this._imageElement||(this._imageElement=new Image,this._imageElement.src=this.logo),this._imageElement},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_playButton",{get:function(){return this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement},enumerable:!0,configurable:!0}),e.prototype.wireEngine=function(t){this._engine=t},e.prototype.addResource=function(t){var e=this._index++;this._resourceList.push(t),this._progressCounts[e]=0,this._totalCounts[e]=1,this._resourceCount++},e.prototype.addResources=function(t){for(var e=0,o=t.length;e<o;e++)this.addResource(t[e])},e.prototype.isLoaded=function(){return this._numLoaded===this._resourceCount},e.prototype.showPlayButton=function(){if(this.suppressPlayButton)return Promise.resolve();this._playButtonShown=!0,this._playButton.style.display="block";var t=new Promise;return this._playButton.addEventListener("click",function(){return t.state()===PromiseState.Pending?t.resolve():t}),this._playButton.addEventListener("touchend",function(){return t.state()===PromiseState.Pending?t.resolve():t}),this._playButton.addEventListener("pointerup",function(){return t.state()===PromiseState.Pending?t.resolve():t}),t},e.prototype.hidePlayButton=function(){this._playButtonShown=!1,this._playButton.style.display="none"},e.prototype.load=function(){var t=this,e=new Promise,o=this;if(0===this._resourceList.length)return o.showPlayButton().then(function(){WebAudio.unlock().then(function(){o.hidePlayButton(),o.oncomplete.call(o),e.resolve()})}),e;var n=new Array(this._resourceList.length),i=this._resourceList.length;return this._resourceList.forEach(function(r,s){t._engine&&r.wireEngine(t._engine),r.onprogress=function(t){var e=t.total,r=t.loaded;n[s]={loaded:r/e*(100/i),total:100};var a=n.reduce(function(t,e){return{loaded:t.loaded+e.loaded,total:100}},{loaded:0,total:100});o.onprogress.call(o,a)},r.oncomplete=r.onerror=function(){o._numLoaded++,o._numLoaded===o._resourceCount&&setTimeout(function(){o.showPlayButton().then(function(){WebAudio.unlock().then(function(){o.hidePlayButton(),o.oncomplete.call(o),e.resolve()})})},200)}}),function t(e,o){e[o]&&e[o].load().then(function(){t(e,o+1)})}(this._resourceList,0),e},e.prototype.draw=function(t){var e=this._engine.canvasHeight/this._engine.pixelRatio,o=this._engine.canvasWidth/this._engine.pixelRatio;if(this._playButtonRootElement){var n=t.canvas.offsetLeft,i=t.canvas.offsetTop,r=this._playButton.clientWidth,s=this._playButton.clientHeight;this._playButtonRootElement.style.left=n+o/2-r/2+"px",this._playButtonRootElement.style.top=i+e/2-s/2+100+"px"}t.fillStyle=this.backgroundColor,t.fillRect(0,0,o,e);var a=e/2,l=Math.min(this.logoWidth,.75*o),u=o/2-l/2,h=Math.floor(l*(this.logoHeight/this.logoWidth)),c=this._engine.getAntialiasing();if(this._engine.setAntialiasing(!0),t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,u,a-h-20,l,h),this.suppressPlayButton||!this._playButtonShown){t.lineWidth=2,DrawUtil.roundRect(t,u,a,l,20,10);var p=l*(this._numLoaded/this._resourceCount)-10;DrawUtil.roundRect(t,u+5,a+5,p>0?p:0,10,5,null,Color.White),this._engine.setAntialiasing(c)}else this._engine.setAntialiasing(c)},e.prototype.update=function(t,e){},e}(Class);export{Loader};