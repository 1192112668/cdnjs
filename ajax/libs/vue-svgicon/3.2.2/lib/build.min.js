"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),path=require("path"),fs=require("fs-plus"),colors=require("colors"),glob=require("glob"),Svgo=require("svgo");function build(d){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(e){return[2,new Promise(function(p,g){fs.removeSync(d.targetPath);var e=d.tpl?path.join(process.cwd(),d.tpl):path.join(__dirname,"../../default/icon.tpl"+(d.es6?".es6":"")+".txt"),h=fs.readFileSync(e,"utf8"),f=new Svgo(getSvgoConfig(d.svgo));glob(path.join(d.sourcePath,"**/*.svg"),function(e,u){var t=this;e?g(e):(u=u.map(function(e){return path.normalize(e)})).forEach(function(s,c){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,r,i,n,o,a,l;return tslib_1.__generator(this,function(e){switch(e.label){case 0:return t=path.basename(s).split(".")[0],r=fs.readFileSync(s,"utf-8"),i=getFilePath(d.sourcePath,s),[4,f.optimize(r)];case 1:n=e.sent(),o=n.data.replace(/<svg[^>]+>/gi,"").replace(/<\/svg>/gi,""),a=getViewBox(n),o=(o=changeId(o=renameStyle(o=addPid(o)),i,t,d.idSP)).replace(/\'/g,"\\'"),l=compile(h,{name:""+i+t,width:parseFloat(n.info.width)||16,height:parseFloat(n.info.height)||16,viewBox:"'"+a+"'",data:o});try{fs.writeFileSync(path.join(d.targetPath,i,t+("."+d.ext)),l,"utf-8"),console.log(colors.yellow("Generated icon: "+i+t)),c===u.length-1&&(generateIndex(d,u),p())}catch(e){g(e)}return[2]}})})})})})]})})}function compile(e,r){return e.replace(/\${(\w+)}/gi,function(e,t){return r[t]?r[t]:""})}function getFilePath(e,t,r){void 0===r&&(r="");var i=t.replace(path.resolve(e),"").replace(path.basename(t),"");return r&&(i=i.replace(r+path.sep,"")),/^[\/\\]/.test(i)&&(i=i.substr(1)),i.replace(/\\/g,"/")}function generateIndex(n,e,o){void 0===o&&(o="");var a=n.es6,l="",s={};switch(n.ext){case"js":l+="/* eslint-disable */\n";break;case"ts":l+="/* tslint:disable */\n"}for(var t in e.forEach(function(e){var t=path.basename(e).split(".")[0],r=getFilePath(n.sourcePath,e,o),i=r.split("/")[0];i?(s[i]||(s[i]=[],l+=a?"import './"+i+"'\n":"require('./"+i+"')\n"),s[i].push(e)):l+=a?"import './"+r+t+"'\n":"require('./"+r+t+"')\n"}),fs.writeFileSync(path.join(n.targetPath,o,"index."+n.ext),l,"utf-8"),console.log(colors.green("Generated "+(o?o+path.sep:"")+"index."+n.ext)),s)generateIndex(n,s[t],path.join(o,t))}function getSvgoConfig(e){return e?"string"==typeof e?require(path.join(process.cwd(),e)):e:require("../../default/svgo")}function getViewBox(e){var t=e.data.match(/viewBox="([-\d\.]+\s[-\d\.]+\s[-\d\.]+\s[-\d\.]+)"/),r="0 0 200 200";return t&&1<t.length?r=t[1]:e.info.height&&e.info.width&&(r="0 0 "+e.info.width+" "+e.info.height),r}function addPid(e){var t=0;return e=e.replace(/<(path|rect|circle|polygon|line|polyline|ellipse)\s/gi,function(e){return e+('pid="'+t++)+'" '})}function renameStyle(e){var t=/fill=\"|stroke="/gi;return e=e.replace(/<(path|rect|circle|polygon|line|polyline|g|ellipse).+>/gi,function(e){return e.replace(t,function(e){return"_"+e})})}function changeId(e,r,i,n){void 0===n&&(n="_");return e=e.replace(/svgicon(\w+)/g,function(e,t){return"svgicon"+n+r.replace(/[\\\/]/g,n)+i+n+t})}exports.default=build;