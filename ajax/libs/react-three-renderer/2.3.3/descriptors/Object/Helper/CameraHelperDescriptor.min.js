"use strict";var _createClass=function(){function r(e,a){for(var t=0;t<a.length;t++){var r=a[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,a,t){return a&&r(e.prototype,a),t&&r(e,t),e}}(),_get=function e(a,t,r){null===a&&(a=Function.prototype);var n=Object.getOwnPropertyDescriptor(a,t);if(void 0===n){var o=Object.getPrototypeOf(a);return null===o?void 0:e(o,t,r)}if("value"in n)return n.value;var i=n.get;return void 0!==i?i.call(r):void 0},_three=require("three"),_three2=_interopRequireDefault(_three),_ReactPropTypes=require("react/lib/ReactPropTypes"),_ReactPropTypes2=_interopRequireDefault(_ReactPropTypes),_Object3DDescriptor2=require("../Object3DDescriptor"),_Object3DDescriptor3=_interopRequireDefault(_Object3DDescriptor2),_CameraUtils=require("../../../utils/CameraUtils.js"),_CameraUtils2=_interopRequireDefault(_CameraUtils);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,a){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!a||"object"!=typeof a&&"function"!=typeof a?e:a}function _inherits(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Super expression must either be null or a function, not "+typeof a);e.prototype=Object.create(a&&a.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),a&&(Object.setPrototypeOf?Object.setPrototypeOf(e,a):e.__proto__=a)}var CameraHelperDescriptor=function(){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return t.hasProp("visible",{type:_ReactPropTypes2.default.bool,override:!0,update:function(e,a){e.userData._visible=a,e.visible=e.userData._hasCamera&&a},updateInitial:!0,default:!0}),t.hasProp("cameraName",{type:_ReactPropTypes2.default.string.isRequired,update:function(e,a){t._clearCameraEvents(e),e.userData._cameraName=a,t._startCameraFinder(e)},default:void 0}),t}return _inherits(r,_Object3DDescriptor3.default),_createClass(r,[{key:"construct",value:function(){return new _three2.default.CameraHelper(new _three2.default.PerspectiveCamera)}},{key:"applyInitialProps",value:function(a,e){var t=this;_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"applyInitialProps",this).call(this,a,e),a.userData._onCameraProjectionUpdate=function(){a.update()},a.userData._onCameraDispose=function(){t._startCameraFinder(a)},a.userData._onCameraRename=function(e){e.oldName===a.userData._cameraName&&t._startCameraFinder(a)},a.userData._onBeforeRender=function(){a.visible=a.userData._hasCamera&&a.userData._visible&&_CameraUtils2.default.current!==a.userData._camera},a.userData._cameraName=e.cameraName,a.userData._visible=!e.hasOwnProperty("visible")||e.visible,a.userData.events.once("addedIntoRoot",function(){a.userData.markup._rootInstance.addBeforeRenderListener(a.userData._onBeforeRender),t._startCameraFinder(a)})}},{key:"unmount",value:function(e){return this._clearCameraEvents(e),delete e.userData._onCameraProjectionUpdate,_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"unmount",this).call(this,e)}},{key:"_getCamera",value:function(e,a){var t,r=null;return!a||0<(t=e.getObjectsByName(a).filter(function(e){return e instanceof _three2.default.Camera})).length&&(r=t[0]),r}},{key:"_clearCameraEvents",value:function(e){e.userData._hasCamera&&(e.userData._camera.userData.events.removeListener("updateProjectionMatrix",e.userData._onCameraProjectionUpdate),e.userData._camera.userData.events.removeListener("dispose",e.userData._onCameraDispose),e.userData._camera.userData.events.removeListener("rename",e.userData._onCameraRename))}},{key:"_setCamera",value:function(e,a){var t,r=e.userData;r._camera!==a&&(this._clearCameraEvents(e),r._hasCamera=!0,r._camera=a,e.camera=a,e.matrix=a.matrixWorld,e.update(),e.visible=r._visible,(t=e.userData._camera.userData.events).on("rename",r._onCameraRename),t.on("updateProjectionMatrix",r._onCameraProjectionUpdate),t.once("dispose",r._onCameraDispose))}},{key:"_startCameraFinder",value:function(t){var r=this;this._clearCameraEvents(t);var e,n=t.userData.markup&&t.userData.markup._rootInstance;n&&(t.userData._hasCamera=!1,t.userData._camera=null,t.camera=new _three2.default.PerspectiveCamera,t.visible=!1,(e=this._getCamera(n,t.userData._cameraName))?this._setCamera(t,e):n.addAnimateListener(function e(){var a=r._getCamera(n,t.userData._cameraName);a&&(n.removeAnimateListener(e),r._setCamera(t,a))}))}}]),r}();module.exports=CameraHelperDescriptor;