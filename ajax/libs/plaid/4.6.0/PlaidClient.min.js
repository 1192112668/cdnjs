"use strict";var P=require("bluebird"),R=require("ramda"),plaidEnvironments=require("./plaidEnvironments"),plaidRequest=require("./plaidRequest"),wrapPromise=require("./wrapPromise");const DEFAULT_VERSION="2019-05-29";function Client(t,e,i,n,o){if(R.isNil(t))throw new Error('Missing Plaid "client_id"');if(R.isNil(e))throw new Error('Missing Plaid "secret"');if(R.isNil(i))throw new Error('Missing Plaid "public_key"');if(!R.any(R.equals(n),R.values(plaidEnvironments)))throw new Error("Invalid Plaid environment");this.client_id=t,this.secret=e,this.env=n,this.public_key=i,null==o&&(o={}),null==o.version&&(o.version=DEFAULT_VERSION),this.client_request_opts=o}var requestWithAccessToken=function(t){return function(e,i,n){return this._authenticatedRequest({path:t,body:{access_token:e}},i,n)}};Client.prototype._authenticatedRequest=function(t,e,i,n){"function"==typeof e?(i=e,e={}):t.body.options=e;var o=R.merge({env:this.env},n?{public_key:this.public_key}:{client_id:this.client_id,secret:this.secret});return plaidRequest(o,t,this.client_request_opts,i)},Client.prototype.createPublicToken=requestWithAccessToken("/item/public_token/create",!1),Client.prototype.exchangePublicToken=function(t,e){return this._authenticatedRequest({path:"/item/public_token/exchange",body:{public_token:t}},e)},Client.prototype.updateAccessTokenVersion=function(t,e){return this._authenticatedRequest({path:"/item/access_token/update_version",body:{access_token_v1:t}},e)},Client.prototype.updateItemWebhook=function(t,e,i){return this._authenticatedRequest({path:"/item/webhook/update",body:{access_token:t,webhook:e}},i)},Client.prototype.createProcessorToken=function(t,e,i,n){var o="/processor/token/create";const s={access_token:t,account_id:e,processor:i};return"stripe"===i?(o="/processor/stripe/bank_account_token/create",delete s.processor):"apex"===i&&(o="/processor/apex/processor_token/create",delete s.processor),this._authenticatedRequest({path:o,body:s},n)},Client.prototype.createStripeToken=function(t,e,i){return this.createProcessorToken(t,e,"stripe",i)},Client.prototype.invalidateAccessToken=requestWithAccessToken("/item/access_token/invalidate"),Client.prototype.removeItem=requestWithAccessToken("/item/remove"),Client.prototype.getItem=requestWithAccessToken("/item/get"),Client.prototype.importItem=function(t,e,i,n){return this._authenticatedRequest({path:"/item/import",body:{products:t,user_auth:e}},i,n)},Client.prototype.getAccounts=requestWithAccessToken("/accounts/get"),Client.prototype.getBalance=requestWithAccessToken("/accounts/balance/get"),Client.prototype.getAuth=requestWithAccessToken("/auth/get"),Client.prototype.getIdentity=requestWithAccessToken("/identity/get"),Client.prototype.getIncome=requestWithAccessToken("/income/get"),Client.prototype.getTransactions=function(t,e,i,n,o){return this._authenticatedRequest({path:"/transactions/get",body:{access_token:t,start_date:e,end_date:i}},n,o)},Client.prototype.getAllTransactions=function(t,e,i,n,o){"function"==typeof n?(o=n,n={}):n=R.defaultTo({},n);var s=this;return wrapPromise(P.coroutine(function*(){for(var o=[],r=0,a={};;){const c=yield s.getTransactions(t,e,i,R.merge(n,{count:500,offset:o.length}));if(a.accounts=c.accounts,a.item=c.item,null!=c.transactions&&(o=R.concat(o,c.transactions),r+=c.transactions.length),r>=c.total_transactions)break}return a.total_transactions=r,a.transactions=o,a})(),o,{no_spread:!0})},Client.prototype.getCreditDetails=requestWithAccessToken("/credit_details/get"),Client.prototype.getHoldings=requestWithAccessToken("/investments/holdings/get"),Client.prototype.getInvestmentTransactions=function(t,e,i,n,o){return this._authenticatedRequest({path:"/investments/transactions/get",body:{access_token:t,start_date:e,end_date:i}},n,o)},Client.prototype.getLiabilities=requestWithAccessToken("/liabilities/get"),Client.prototype.createAssetReport=function(t,e,i,n){return this._authenticatedRequest({path:"/asset_report/create",body:{access_tokens:t,days_requested:e}},i,n)},Client.prototype.filterAssetReport=function(t,e,i){return this._authenticatedRequest({path:"/asset_report/filter",body:{asset_report_token:t,account_ids_to_exclude:e}},i)},Client.prototype.refreshAssetReport=function(t,e,i,n){return this._authenticatedRequest({path:"/asset_report/refresh",body:{asset_report_token:t,days_requested:e}},i,n)},Client.prototype.getAssetReport=function(t,e,i){return this._authenticatedRequest({path:"/asset_report/get",body:{asset_report_token:t,include_insights:e}},i)},Client.prototype.getAssetReportPdf=function(t,e){return this._authenticatedRequest({path:"/asset_report/pdf/get",body:{asset_report_token:t},binary:!0},e)},Client.prototype.createAuditCopy=function(t,e,i){return this._authenticatedRequest({path:"/asset_report/audit_copy/create",body:{asset_report_token:t,auditor_id:e}},i)},Client.prototype.getAuditCopy=function(t,e){return this._authenticatedRequest({path:"/asset_report/audit_copy/get",body:{audit_copy_token:t}},e)},Client.prototype.removeAuditCopy=function(t,e){return this._authenticatedRequest({path:"/asset_report/audit_copy/remove",body:{audit_copy_token:t}},e)},Client.prototype.removeAssetReport=function(t,e){return this._authenticatedRequest({path:"/asset_report/remove",body:{asset_report_token:t}},e)},Client.prototype.createPaymentRecipient=function(t,e,i,n){return this._authenticatedRequest({path:"/payment_initiation/recipient/create",body:{name:t,iban:e,address:i}},n)},Client.prototype.getPaymentRecipient=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/recipient/get",body:{recipient_id:t}},e)},Client.prototype.listPaymentRecipients=function(t){return this._authenticatedRequest({path:"/payment_initiation/recipient/list"},t)},Client.prototype.createPayment=function(t,e,i,n){return this._authenticatedRequest({path:"/payment_initiation/payment/create",body:{recipient_id:t,reference:e,amount:i}},n)},Client.prototype.createPaymentToken=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/token/create",body:{payment_id:t}},e)},Client.prototype.getPayment=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/get",body:{payment_id:t}},e)},Client.prototype.listPayments=function(t,e){return this._authenticatedRequest({path:"/payment_initiation/payment/list",body:t},e)},Client.prototype.getDepositSwitch=function(t,e,i){return this._authenticatedRequest({path:"/deposit_switch/get",body:{deposit_switch_id:t}},e,i)},Client.prototype.createDepositSwitch=function(t,e,i,n){return this._authenticatedRequest({path:"/deposit_switch/create",body:{target_account_id:t,target_access_token:e}},i,n)},Client.prototype.createDepositSwitchToken=function(t,e,i){return this._authenticatedRequest({path:"/deposit_switch/token/create",body:{deposit_switch_id:t}},e,i)},Client.prototype.getInstitutions=function(t,e,i,n){return this._authenticatedRequest({path:"/institutions/get",body:{count:t,offset:e}},i,n)},Client.prototype.getInstitutionById=function(t,e,i){return this._authenticatedRequest({path:"/institutions/get_by_id",body:{institution_id:t}},e,i,!0)},Client.prototype.searchInstitutionsByName=function(t,e,i,n){return this._authenticatedRequest({path:"/institutions/search",body:{query:t,products:e}},i,n,!0)},Client.prototype.getCategories=function(t){return plaidRequest({env:this.env},{path:"/categories/get"},this.client_request_opts,t)},Client.prototype.resetLogin=requestWithAccessToken("/sandbox/item/reset_login"),Client.prototype.getWebhookVerificationKey=function(t,e){return this._authenticatedRequest({path:"/webhook_verification_key/get",body:{key_id:t}},e,!0)},Client.prototype.sandboxPublicTokenCreate=function(t,e,i,n){return this._authenticatedRequest({path:"/sandbox/public_token/create",body:{institution_id:t,initial_products:e}},i,n,!0)},Client.prototype.sandboxItemFireWebhook=function(t,e,i){return this._authenticatedRequest({path:"/sandbox/item/fire_webhook",body:{access_token:t,webhook_code:e}},i,!0)},module.exports=Client;