"use strict";class Connector{constructor(e){this._defaultOptions={auth:{headers:{}},authEndpoint:"/broadcasting/auth",broadcaster:"pusher",csrfToken:null,host:null,key:null,namespace:"App.Events"},this.setOptions(e),this.connect()}setOptions(e){return this.options=Object.assign(this._defaultOptions,e),this.csrfToken()&&(this.options.auth.headers["X-CSRF-TOKEN"]=this.csrfToken()),e}csrfToken(){let e;return"undefined"!=typeof window&&window.Laravel&&window.Laravel.csrfToken?window.Laravel.csrfToken:this.options.csrfToken?this.options.csrfToken:"undefined"!=typeof document&&"function"==typeof document.querySelector&&(e=document.querySelector('meta[name="csrf-token"]'))?e.getAttribute("content"):null}}class Channel{listenForWhisper(e,t){return this.listen(".client-"+e,t)}notification(e){return this.listen(".Illuminate\\Notifications\\Events\\BroadcastNotificationCreated",e)}stopListeningForWhisper(e){return this.stopListening(".client-"+e)}}class EventFormatter{constructor(e){this.setNamespace(e)}format(e){return"."===e.charAt(0)||"\\"===e.charAt(0)?e.substr(1):(this.namespace&&(e=this.namespace+"."+e),e.replace(/\./g,"\\"))}setNamespace(e){this.namespace=e}}class PusherChannel extends Channel{constructor(e,t,n){super(),this.name=t,this.pusher=e,this.options=n,this.eventFormatter=new EventFormatter(this.options.namespace),this.subscribe()}subscribe(){this.subscription=this.pusher.subscribe(this.name)}unsubscribe(){this.pusher.unsubscribe(this.name)}listen(e,t){return this.on(this.eventFormatter.format(e),t),this}stopListening(e){return this.subscription.unbind(this.eventFormatter.format(e)),this}on(e,t){return this.subscription.bind(e,t),this}}class PusherPrivateChannel extends PusherChannel{whisper(e,t){return this.pusher.channels.channels[this.name].trigger(`client-${e}`,t),this}}class PusherEncryptedPrivateChannel extends PusherChannel{whisper(e,t){return this.pusher.channels.channels[this.name].trigger(`client-${e}`,t),this}}class PusherPresenceChannel extends PusherChannel{here(e){return this.on("pusher:subscription_succeeded",t=>{e(Object.keys(t.members).map(e=>t.members[e]))}),this}joining(e){return this.on("pusher:member_added",t=>{e(t.info)}),this}leaving(e){return this.on("pusher:member_removed",t=>{e(t.info)}),this}whisper(e,t){return this.pusher.channels.channels[this.name].trigger(`client-${e}`,t),this}}class SocketIoChannel extends Channel{constructor(e,t,n){super(),this.events={},this.name=t,this.socket=e,this.options=n,this.eventFormatter=new EventFormatter(this.options.namespace),this.subscribe(),this.configureReconnector()}subscribe(){this.socket.emit("subscribe",{channel:this.name,auth:this.options.auth||{}})}unsubscribe(){this.unbind(),this.socket.emit("unsubscribe",{channel:this.name,auth:this.options.auth||{}})}listen(e,t){return this.on(this.eventFormatter.format(e),t),this}stopListening(e){const t=this.eventFormatter.format(e);return this.socket.removeListener(t),delete this.events[t],this}on(e,t){let n=(e,n)=>{this.name==e&&t(n)};this.socket.on(e,n),this.bind(e,n)}configureReconnector(){const e=()=>{this.subscribe()};this.socket.on("reconnect",e),this.bind("reconnect",e)}bind(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)}unbind(){Object.keys(this.events).forEach(e=>{this.events[e].forEach(t=>{this.socket.removeListener(e,t)}),delete this.events[e]})}}class SocketIoPrivateChannel extends SocketIoChannel{whisper(e,t){return this.socket.emit("client event",{channel:this.name,event:`client-${e}`,data:t}),this}}class SocketIoPresenceChannel extends SocketIoPrivateChannel{here(e){return this.on("presence:subscribed",t=>{e(t.map(e=>e.user_info))}),this}joining(e){return this.on("presence:joining",t=>e(t.user_info)),this}leaving(e){return this.on("presence:leaving",t=>e(t.user_info)),this}}class NullChannel extends Channel{subscribe(){}unsubscribe(){}listen(e,t){return this}stopListening(e){return this}on(e,t){return this}}class NullPrivateChannel extends NullChannel{whisper(e,t){return this}}class NullPresenceChannel extends NullChannel{here(e){return this}joining(e){return this}leaving(e){return this}whisper(e,t){return this}}class PusherConnector extends Connector{constructor(){super(...arguments),this.channels={}}connect(){void 0!==this.options.client?this.pusher=this.options.client:this.pusher=new Pusher(this.options.key,this.options)}listen(e,t,n){return this.channel(e).listen(t,n)}channel(e){return this.channels[e]||(this.channels[e]=new PusherChannel(this.pusher,e,this.options)),this.channels[e]}privateChannel(e){return this.channels["private-"+e]||(this.channels["private-"+e]=new PusherPrivateChannel(this.pusher,"private-"+e,this.options)),this.channels["private-"+e]}encryptedPrivateChannel(e){return this.channels["private-encrypted-"+e]||(this.channels["private-encrypted-"+e]=new PusherEncryptedPrivateChannel(this.pusher,"private-encrypted-"+e,this.options)),this.channels["private-encrypted-"+e]}presenceChannel(e){return this.channels["presence-"+e]||(this.channels["presence-"+e]=new PusherPresenceChannel(this.pusher,"presence-"+e,this.options)),this.channels["presence-"+e]}leave(e){[e,"private-"+e,"presence-"+e].forEach((e,t)=>{this.leaveChannel(e)})}leaveChannel(e){this.channels[e]&&(this.channels[e].unsubscribe(),delete this.channels[e])}socketId(){return this.pusher.connection.socket_id}disconnect(){this.pusher.disconnect()}}class SocketIoConnector extends Connector{constructor(){super(...arguments),this.channels={}}connect(){let e=this.getSocketIO();return this.socket=e(this.options.host,this.options),this.socket}getSocketIO(){if(void 0!==this.options.client)return this.options.client;if("undefined"!=typeof io)return io;throw new Error("Socket.io client not found. Should be globally available or passed via options.client")}listen(e,t,n){return this.channel(e).listen(t,n)}channel(e){return this.channels[e]||(this.channels[e]=new SocketIoChannel(this.socket,e,this.options)),this.channels[e]}privateChannel(e){return this.channels["private-"+e]||(this.channels["private-"+e]=new SocketIoPrivateChannel(this.socket,"private-"+e,this.options)),this.channels["private-"+e]}presenceChannel(e){return this.channels["presence-"+e]||(this.channels["presence-"+e]=new SocketIoPresenceChannel(this.socket,"presence-"+e,this.options)),this.channels["presence-"+e]}leave(e){[e,"private-"+e,"presence-"+e].forEach(e=>{this.leaveChannel(e)})}leaveChannel(e){this.channels[e]&&(this.channels[e].unsubscribe(),delete this.channels[e])}socketId(){return this.socket.id}disconnect(){this.socket.disconnect()}}class NullConnector extends Connector{constructor(){super(...arguments),this.channels={}}connect(){}listen(e,t,n){return new NullChannel}channel(e){return new NullChannel}privateChannel(e){return new NullPrivateChannel}presenceChannel(e){return new NullPresenceChannel}leave(e){}leaveChannel(e){}socketId(){return"fake-socket-id"}disconnect(){}}class Echo{constructor(e){this.options=e,this.connect(),this.options.withoutInterceptors||this.registerInterceptors()}channel(e){return this.connector.channel(e)}connect(){"pusher"==this.options.broadcaster?this.connector=new PusherConnector(this.options):"socket.io"==this.options.broadcaster?this.connector=new SocketIoConnector(this.options):"null"==this.options.broadcaster?this.connector=new NullConnector(this.options):"function"==typeof this.options.broadcaster&&(this.connector=new this.options.broadcaster(this.options))}disconnect(){this.connector.disconnect()}join(e){return this.connector.presenceChannel(e)}leave(e){this.connector.leave(e)}leaveChannel(e){this.connector.leaveChannel(e)}listen(e,t,n){return this.connector.listen(e,t,n)}private(e){return this.connector.privateChannel(e)}encryptedPrivate(e){return this.connector.encryptedPrivateChannel(e)}socketId(){return this.connector.socketId()}registerInterceptors(){"function"==typeof Vue&&Vue.http&&this.registerVueRequestInterceptor(),"function"==typeof axios&&this.registerAxiosRequestInterceptor(),"function"==typeof jQuery&&this.registerjQueryAjaxSetup()}registerVueRequestInterceptor(){Vue.http.interceptors.push((e,t)=>{this.socketId()&&e.headers.set("X-Socket-ID",this.socketId()),t()})}registerAxiosRequestInterceptor(){axios.interceptors.request.use(e=>(this.socketId()&&(e.headers["X-Socket-Id"]=this.socketId()),e))}registerjQueryAjaxSetup(){void 0!==jQuery.ajax&&jQuery.ajaxPrefilter((e,t,n)=>{this.socketId()&&n.setRequestHeader("X-Socket-Id",this.socketId())})}}module.exports=Echo;