"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TableBody=void 0;var _react=_interopRequireWildcard(require("react")),_BodyRow=require("./BodyRow"),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_ObjectUtils=_interopRequireDefault(require("../utils/ObjectUtils")),_RowTogglerButton=require("./RowTogglerButton");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var o=_getRequireWildcardCache();if(o&&o.has(e))return o.get(e);var t={};if(null!=e){var r,n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e){Object.prototype.hasOwnProperty.call(e,i)&&((r=n?Object.getOwnPropertyDescriptor(e,i):null)&&(r.get||r.set)?Object.defineProperty(t,i,r):t[i]=e[i])}}return t.default=e,o&&o.set(e,t),t}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(o,e){var t,r=Object.keys(o);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(o),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})),r.push.apply(r,t)),r}function _objectSpread(o){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(o,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(t,e))})}return o}function _defineProperty(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var o=0,t=new Array(e.length);o<e.length;o++)t[o]=e[o];return t}}function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,o){for(var t=0;t<o.length;t++){var r=o[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,o,t){return o&&_defineProperties(e.prototype,o),t&&_defineProperties(e,t),e}function _possibleConstructorReturn(e,o){return!o||"object"!==_typeof(o)&&"function"!=typeof o?_assertThisInitialized(e):o}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _inherits(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),o&&_setPrototypeOf(e,o)}function _setPrototypeOf(e,o){return(_setPrototypeOf=Object.setPrototypeOf||function(e,o){return e.__proto__=o,e})(e,o)}var TableBody=function(){function t(e){var o;return _classCallCheck(this,t),(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e))).onRowClick=o.onRowClick.bind(_assertThisInitialized(o)),o.onRowRightClick=o.onRowRightClick.bind(_assertThisInitialized(o)),o.onRowTouchEnd=o.onRowTouchEnd.bind(_assertThisInitialized(o)),o.onRowToggle=o.onRowToggle.bind(_assertThisInitialized(o)),o.onRadioClick=o.onRadioClick.bind(_assertThisInitialized(o)),o.onCheckboxClick=o.onCheckboxClick.bind(_assertThisInitialized(o)),o.onRowDragEnd=o.onRowDragEnd.bind(_assertThisInitialized(o)),o.onRowDragLeave=o.onRowDragLeave.bind(_assertThisInitialized(o)),o.onRowDrop=o.onRowDrop.bind(_assertThisInitialized(o)),o}return _inherits(t,_react.Component),_createClass(t,[{key:"onRowClick",value:function(e){var o,t,r,n,i,a,s,l,p=e.originalEvent.target.nodeName;"INPUT"===p||"BUTTON"===p||"A"===p||_DomHandler.default.hasClass(e.originalEvent.target,"p-clickable")||(this.props.onRowClick&&this.props.onRowClick(e),this.props.selectionMode&&(o=e.data,t=e.index,this.isMultipleSelectionMode()&&e.originalEvent.shiftKey&&null!==this.anchorRowIndex?(_DomHandler.default.clearSelection(),this.rangeRowIndex=t,s=this.selectRange(e)):(r=this.isSelected(o),n=!this.rowTouched&&this.props.metaKeySelection,this.anchorRowIndex=t,this.rangeRowIndex=t,n?(i=e.originalEvent.metaKey||e.originalEvent.ctrlKey,r&&i?(s=this.isSingleSelectionMode()?null:(a=this.findIndexInSelection(o),this.props.selection.filter(function(e,o){return o!==a})),this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:o,type:"row"})):(this.isSingleSelectionMode()?s=o:this.isMultipleSelectionMode()&&(s=i&&this.props.selection?_toConsumableArray(this.props.selection):[],s=[].concat(_toConsumableArray(s),[o])),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:o,type:"row"}))):this.isSingleSelectionMode()?r?(s=null,this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:o,type:"row"})):(s=o,this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:o,type:"row"})):(s=r?(l=this.findIndexInSelection(o),this.props.selection.filter(function(e,o){return o!==l})):[].concat(_toConsumableArray(this.props.selection||[]),[o]),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:o,type:"row"}))),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:s})),this.rowTouched=!1)}},{key:"selectRange",value:function(e){var o,t=this.rangeRowIndex>this.anchorRowIndex?(o=this.anchorRowIndex,this.rangeRowIndex):this.rangeRowIndex<this.anchorRowIndex?(o=this.rangeRowIndex,this.anchorRowIndex):(o=this.rangeRowIndex,this.rangeRowIndex);this.props.lazy&&this.props.paginator&&(o-=this.first,t-=this.first);for(var r=this.props.value,n=[],i=o;i<=t;i++){var a=r[i];n.push(a),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:a,type:"row"})}return n}},{key:"onRowTouchEnd",value:function(){this.rowTouched=!0}},{key:"onRowRightClick",value:function(e){this.props.onContextMenu&&(_DomHandler.default.clearSelection(),this.props.onContextMenuSelectionChange&&this.props.onContextMenuSelectionChange({originalEvent:e.originalEvent,value:e.data}),this.props.onContextMenu&&this.props.onContextMenu({originalEvent:e.originalEvent,value:this.props.node}),e.originalEvent.preventDefault())}},{key:"onRadioClick",value:function(e){var o,t=e.data;this.isSelected(t)?(o=null,this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:t,type:"radio"})):(o=t,this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"radio"})),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:o})}},{key:"onCheckboxClick",value:function(e){var t,o,r=e.data;this.isSelected(r)?(t=this.findIndexInSelection(r),o=this.props.selection.filter(function(e,o){return o!==t}),this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:r,type:"checkbox"})):(o=[].concat(_toConsumableArray(this.props.selection||[]),[r]),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:r,type:"checkbox"})),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:o})}},{key:"isSingleSelectionMode",value:function(){return"single"===this.props.selectionMode}},{key:"isMultipleSelectionMode",value:function(){return"multiple"===this.props.selectionMode}},{key:"isSelected",value:function(e){return!(!e||!this.props.selection)&&(this.props.selection instanceof Array?-1<this.findIndexInSelection(e):this.equals(e,this.props.selection))}},{key:"isContextMenuSelected",value:function(e){return!(!e||!this.props.contextMenuSelection)&&this.equals(e,this.props.contextMenuSelection)}},{key:"equals",value:function(e,o){var t=this.getDataKeyOnRowToggle();return"equals"===this.props.compareSelectionBy?e===o:_ObjectUtils.default.equals(e,o,t)}},{key:"findIndexInSelection",value:function(e){var o=-1;if(this.props.selection)for(var t=0;t<this.props.selection.length;t++)if(this.equals(e,this.props.selection[t])){o=t;break}return o}},{key:"getDataKeyOnRowToggle",value:function(){return"subheader"===this.props.rowGroupMode&&this.props.expandableRowGroups?this.props.groupField:this.props.dataKey}},{key:"onRowToggle",value:function(e){var o,t,r,n=this.getDataKeyOnRowToggle();n?(o=String(_ObjectUtils.default.resolveFieldData(e.data,n)),null!=(t=this.props.expandedRows?_objectSpread({},this.props.expandedRows):{})[o]?(delete t[o],this.props.onRowCollapse&&this.props.onRowCollapse({originalEvent:e,data:e.data})):(t[o]=!0,this.props.onRowExpand&&this.props.onRowExpand({originalEvent:e,data:e.data}))):(r=this.findExpandedRowIndex(e.data),t=this.props.expandedRows?_toConsumableArray(this.props.expandedRows):[],-1!==r?(t=t.filter(function(e,o){return o!==r}),this.props.onRowCollapse&&this.props.onRowCollapse({originalEvent:e,data:e.data})):(t.push(e.data),this.props.onRowExpand&&this.props.onRowExpand({originalEvent:e,data:e.data}))),this.props.onRowToggle&&this.props.onRowToggle({data:t})}},{key:"findExpandedRowIndex",value:function(e){var o=-1;if(this.props.expandedRows)for(var t=0;t<this.props.expandedRows.length;t++)if(_ObjectUtils.default.equals(this.props.expandedRows[t],e)){o=t;break}return o}},{key:"isRowExpanded",value:function(e){var o=this.getDataKeyOnRowToggle();if(o){var t=String(_ObjectUtils.default.resolveFieldData(e,o));return this.props.expandedRows&&null!=this.props.expandedRows[t]}return-1!==this.findExpandedRowIndex(e)}},{key:"isSelectionEnabled",value:function(){if(this.props.selectionMode||null!=this.props.frozenSelectionMode)return!0;if(!Array.isArray(this.props.children))return this.props.children&&null!=this.props.children.selectionMode;for(var e=0;e<this.props.children.length;e++)if(this.props.children[e].props.selectionMode)return!0;return!1}},{key:"onRowDragStart",value:function(e,o){this.rowDragging=!0,this.draggedRowIndex=o,e.dataTransfer.setData("text","b")}},{key:"onRowDragEnd",value:function(){this.rowDragging=!1,this.draggedRowIndex=null,this.droppedRowIndex=null}},{key:"onRowDragOver",value:function(e,o){var t,r,n,i,a;this.rowDragging&&this.draggedRowIndex!==o&&(t=e.rowElement,r=_DomHandler.default.getOffset(t).top+_DomHandler.default.getWindowScrollTop(),n=e.originalEvent.pageY,i=r+_DomHandler.default.getOuterHeight(t)/2,a=t.previousElementSibling,n<i?(_DomHandler.default.removeClass(t,"p-datatable-dragpoint-bottom"),this.droppedRowIndex=o,a?_DomHandler.default.addClass(a,"p-datatable-dragpoint-bottom"):_DomHandler.default.addClass(t,"p-datatable-dragpoint-top")):(a?_DomHandler.default.removeClass(a,"p-datatable-dragpoint-bottom"):_DomHandler.default.addClass(t,"p-datatable-dragpoint-top"),this.droppedRowIndex=o+1,_DomHandler.default.addClass(t,"p-datatable-dragpoint-bottom")))}},{key:"onRowDragLeave",value:function(e){var o=e.rowElement,t=o.previousElementSibling;t&&_DomHandler.default.removeClass(t,"p-datatable-dragpoint-bottom"),_DomHandler.default.removeClass(o,"p-datatable-dragpoint-bottom"),_DomHandler.default.removeClass(o,"p-datatable-dragpoint-top")}},{key:"onRowDrop",value:function(e){var o,t;null!=this.droppedRowIndex&&(o=this.draggedRowIndex>this.droppedRowIndex?this.droppedRowIndex:0===this.droppedRowIndex?0:this.droppedRowIndex-1,t=_toConsumableArray(this.props.value),_ObjectUtils.default.reorderArray(t,this.draggedRowIndex,o),this.props.onRowReorder&&this.props.onRowReorder({originalEvent:e,value:t,dragIndex:this.draggedRowIndex,dropIndex:this.droppedRowIndex})),this.onRowDragLeave(e),this.onRowDragEnd(e)}},{key:"renderRowGroupHeader",value:function(e,o){var t=null;return"subheader"===this.props.rowGroupMode&&this.props.expandableRowGroups&&(t=_react.default.createElement(_RowTogglerButton.RowTogglerButton,{onClick:this.onRowToggle,rowData:e,expanded:this.isRowExpanded(e)})),_react.default.createElement("tr",{key:o+"_rowgroupheader",className:"p-rowgroup-header"},_react.default.createElement("td",{colSpan:_react.default.Children.count(this.props.children)},t,_react.default.createElement("span",{className:"p-rowgroup-header-name"},this.props.rowGroupHeaderTemplate(e,o))))}},{key:"renderRowGroupFooter",value:function(e,o){return _react.default.createElement("tr",{key:o+"_rowgroupfooter",className:"p-rowgroup-footer"},this.props.rowGroupFooterTemplate(e,o))}},{key:"render",value:function(){var v,y=this,e=this.props.rows||0,o=this.props.first||0,b=this.isSelectionEnabled(),t=this.props.rowGroupMode,_=t&&"subheader"===t,E=t&&"rowspan"===t,x=!1;if(this.props.value&&this.props.value.length){v=[];for(var m=this.props.lazy?0:o,r=this.props.virtualScroll?m+2*e:m+e||this.props.value.length,n=function(o){if(o>=y.props.value.length)return"break";var e,t,r=y.props.value[o],n=y.isRowExpanded(r),i=!!b&&y.isSelected(y.props.value[o]),a=y.isContextMenuSelected(r),s=void 0;if(_&&(e=_ObjectUtils.default.resolveFieldData(r,y.props.groupField),t=_ObjectUtils.default.resolveFieldData(y.props.value[o-1],y.props.groupField),0!==o&&e===t||(v.push(y.renderRowGroupHeader(r,o)),x=n)),E){var l=o,p=_ObjectUtils.default.resolveFieldData(r,y.props.sortField);if(o===m||_ObjectUtils.default.resolveFieldData(y.props.value[o-1],y.props.sortField)!==p)for(var d=p,s=0;p===d;){s++;var u=y.props.value[++l];if(!u)break;d=_ObjectUtils.default.resolveFieldData(u,y.props.sortField)}}var c,h,g,f,w,R=y.props.expandableRowGroups&&_&&x;y.props.expandableRowGroups&&!R||(c=_react.default.createElement(_BodyRow.BodyRow,{key:o,value:y.props.value,rowData:r,rowIndex:o,onClick:y.onRowClick,onDoubleClick:y.props.onRowDoubleClick,onRightClick:y.onRowRightClick,onTouchEnd:y.onRowTouchEnd,onRowToggle:y.onRowToggle,expanded:n,responsive:y.props.responsive,selectionMode:y.props.selectionMode,onRadioClick:y.onRadioClick,onCheckboxClick:y.onCheckboxClick,selected:i,contextMenuSelected:a,rowClassName:y.props.rowClassName,sortField:y.props.sortField,rowGroupMode:y.props.rowGroupMode,groupRowSpan:s,onDragStart:function(e){return y.onRowDragStart(e,o)},onDragEnd:y.onRowDragEnd,onDragOver:function(e){return y.onRowDragOver(e,o)},onDragLeave:y.onRowDragLeave,onDrop:y.onRowDrop,virtualRowHeight:y.props.virtualRowHeight,editMode:y.props.editMode,rowEditorValidator:y.props.rowEditorValidator,onRowEditInit:y.props.onRowEditInit,onRowEditSave:y.props.onRowEditSave,onRowEditCancel:y.props.onRowEditCancel},y.props.children),v.push(c)),!n||_&&y.props.expandableRowGroups||(h=y.props.rowExpansionTemplate(r),g=_react.default.createElement("tr",{key:o+"_expanded"},_react.default.createElement("td",{colSpan:y.props.children.length},h)),v.push(g)),!_||y.props.expandableRowGroups&&!R||(f=_ObjectUtils.default.resolveFieldData(r,y.props.groupField),w=_ObjectUtils.default.resolveFieldData(y.props.value[o+1],y.props.groupField),o!==y.props.value.length-1&&f===w||v.push(y.renderRowGroupFooter(r,o)))},i=m;i<r;i++){if("break"===n(i))break}}else v=!this.props.loading&&this.props.emptyMessage?_react.default.createElement("tr",{className:"p-datatable-emptymessage"},_react.default.createElement("td",{colSpan:this.props.children.length},this.props.emptyMessage)):null;return _react.default.createElement("tbody",{className:"p-datatable-tbody"},v)}}]),t}();exports.TableBody=TableBody;