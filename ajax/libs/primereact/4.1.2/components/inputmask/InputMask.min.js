"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.InputMask=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_reactDom=_interopRequireDefault(require("react-dom")),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_InputText=require("../inputtext/InputText"),_Tooltip=_interopRequireDefault(require("../tooltip/Tooltip"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var i={};if(null!=e){var s,n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e){Object.prototype.hasOwnProperty.call(e,r)&&((s=n?Object.getOwnPropertyDescriptor(e,r):null)&&(s.get||s.set)?Object.defineProperty(i,r,s):i[r]=e[r])}}return i.default=e,t&&t.set(e,i),i}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var InputMask=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e))).onFocus=t.onFocus.bind(_assertThisInitialized(t)),t.onBlur=t.onBlur.bind(_assertThisInitialized(t)),t.onKeyDown=t.onKeyDown.bind(_assertThisInitialized(t)),t.onKeyPress=t.onKeyPress.bind(_assertThisInitialized(t)),t.onInput=t.onInput.bind(_assertThisInitialized(t)),t.handleInputChange=t.handleInputChange.bind(_assertThisInitialized(t)),t}return _inherits(i,_react.Component),_createClass(i,[{key:"caret",value:function(e,t){var i,s,n;if(this.input.offsetParent&&this.input===document.activeElement)return"number"!=typeof e?(this.input.setSelectionRange?(s=this.input.selectionStart,n=this.input.selectionEnd):document.selection&&document.selection.createRange&&(n=(s=0-(i=document.selection.createRange()).duplicate().moveStart("character",-1e5))+i.text.length),{begin:s,end:n}):(s=e,n="number"==typeof t?t:s,void(this.input.setSelectionRange?this.input.setSelectionRange(s,n):this.input.createTextRange&&((i=this.input.createTextRange()).collapse(!0),i.moveEnd("character",n),i.moveStart("character",s),i.select())))}},{key:"isCompleted",value:function(){for(var e=this.firstNonMaskPos;e<=this.lastRequiredNonMaskPos;e++)if(this.tests[e]&&this.buffer[e]===this.getPlaceholder(e))return!1;return!0}},{key:"getPlaceholder",value:function(e){return e<this.props.slotChar.length?this.props.slotChar.charAt(e):this.props.slotChar.charAt(0)}},{key:"getValue",value:function(){return this.props.unmask?this.getUnmaskedValue():this.input&&this.input.value}},{key:"seekNext",value:function(e){for(;++e<this.len&&!this.tests[e];);return e}},{key:"seekPrev",value:function(e){for(;0<=--e&&!this.tests[e];);return e}},{key:"shiftL",value:function(e,t){var i,s;if(!(e<0)){for(i=e,s=this.seekNext(t);i<this.len;i++)if(this.tests[i]){if(!(s<this.len&&this.tests[i].test(this.buffer[s])))break;this.buffer[i]=this.buffer[s],this.buffer[s]=this.getPlaceholder(s),s=this.seekNext(s)}this.writeBuffer(),this.caret(Math.max(this.firstNonMaskPos,e))}}},{key:"shiftR",value:function(e){for(var t,i,s=e,n=this.getPlaceholder(e);s<this.len;s++)if(this.tests[s]){if(t=this.seekNext(s),i=this.buffer[s],this.buffer[s]=n,!(t<this.len&&this.tests[t].test(i)))break;n=i}}},{key:"handleAndroidInput",value:function(e){var t=this.input.value,i=this.caret();if(this.oldVal&&this.oldVal.length&&this.oldVal.length>t.length){for(this.checkVal(!0);0<i.begin&&!this.tests[i.begin-1];)i.begin--;if(0===i.begin)for(;i.begin<this.firstNonMaskPos&&!this.tests[i.begin];)i.begin++;this.caret(i.begin,i.begin)}else{for(this.checkVal(!0);i.begin<this.len&&!this.tests[i.begin];)i.begin++;this.caret(i.begin,i.begin)}this.props.onComplete&&this.isCompleted()&&this.props.onComplete({originalEvent:e,value:this.getValue()})}},{key:"onBlur",value:function(e){var t;this.focus=!1,this.checkVal(),this.updateModel(e),this.updateFilledState(),this.input.value!==this.focusText&&((t=document.createEvent("HTMLEvents")).initEvent("change",!0,!1),this.input.dispatchEvent(t))}},{key:"onKeyDown",value:function(e){var t,i,s,n,r;this.props.readonly||(t=e.which||e.keyCode,r=/iphone/i.test(_DomHandler.default.getUserAgent()),this.oldVal=this.input.value,8===t||46===t||r&&127===t?(s=(i=this.caret()).begin,(n=i.end)-s==0&&(s=46!==t?this.seekPrev(s):n=this.seekNext(s-1),n=46===t?this.seekNext(n):n),this.clearBuffer(s,n),this.shiftL(s,n-1),this.updateModel(e),e.preventDefault()):13===t?(this.onBlur(e),this.updateModel(e)):27===t&&(this.input.value=this.focusText,this.caret(0,this.checkVal()),this.updateModel(e),e.preventDefault()))}},{key:"onKeyPress",value:function(e){var t,i,s,n,r,o,a=this;this.props.readonly||(t=e.which||e.keyCode,i=this.caret(),e.ctrlKey||e.altKey||e.metaKey||t<32||(t&&13!==t&&(i.end-i.begin!=0&&(this.clearBuffer(i.begin,i.end),this.shiftL(i.begin,i.end-1)),(s=this.seekNext(i.begin-1))<this.len&&(o=String.fromCharCode(t),this.tests[s].test(o)&&(this.shiftR(s),this.buffer[s]=o,this.writeBuffer(),n=this.seekNext(s),/android/i.test(_DomHandler.default.getUserAgent())?setTimeout(function(){a.caret(n)},0):this.caret(n),i.begin<=this.lastRequiredNonMaskPos&&(r=this.isCompleted()))),e.preventDefault()),this.updateModel(e),this.props.onComplete&&r&&this.props.onComplete({originalEvent:e,value:this.getValue()})))}},{key:"clearBuffer",value:function(e,t){for(var i=e;i<t&&i<this.len;i++)this.tests[i]&&(this.buffer[i]=this.getPlaceholder(i))}},{key:"writeBuffer",value:function(){this.input.value=this.buffer.join("")}},{key:"checkVal",value:function(e){this.isValueChecked=!0;for(var t,i=this.input.value,s=-1,n=0,r=0;n<this.len;n++)if(this.tests[n]){for(this.buffer[n]=this.getPlaceholder(n);r++<i.length;)if(t=i.charAt(r-1),this.tests[n].test(t)){this.buffer[n]=t,s=n;break}if(r>i.length){this.clearBuffer(n+1,this.len);break}}else this.buffer[n]===i.charAt(r)&&r++,n<this.partialPosition&&(s=n);return e?this.writeBuffer():s+1<this.partialPosition?this.props.autoClear||this.buffer.join("")===this.defaultBuffer?(this.input.value&&(this.input.value=""),this.clearBuffer(0,this.len)):this.writeBuffer():(this.writeBuffer(),this.input.value=this.input.value.substring(0,s+1)),this.partialPosition?n:this.firstNonMaskPos}},{key:"onFocus",value:function(){var e,t=this;this.props.readonly||(this.focus=!0,clearTimeout(this.caretTimeoutId),this.focusText=this.input.value,e=this.checkVal(),this.caretTimeoutId=setTimeout(function(){t.input===document.activeElement&&(t.writeBuffer(),e===t.props.mask.replace("?","").length?t.caret(0,e):t.caret(e),t.updateFilledState())},10))}},{key:"onInput",value:function(e){this.androidChrome?this.handleAndroidInput(e):this.handleInputChange(e)}},{key:"handleInputChange",value:function(e){var t;this.props.readonly||(t=this.checkVal(!0),this.caret(t),this.updateModel(e),this.props.onComplete&&this.isCompleted()&&this.props.onComplete({originalEvent:e,value:this.getValue()}))}},{key:"getUnmaskedValue",value:function(){for(var e=[],t=0;t<this.buffer.length;t++){var i=this.buffer[t];this.tests[t]&&i!==this.getPlaceholder(t)&&e.push(i)}return e.join("")}},{key:"updateModel",value:function(e){var t;this.props.onChange&&(t=this.props.unmask?this.getUnmaskedValue():e&&e.target.value,this.props.onChange({originalEvent:e,value:this.defaultBuffer!==t?t:"",stopPropagation:function(){},preventDefault:function(){},target:{name:this.props.name,id:this.props.id,value:this.defaultBuffer!==t?t:""}}))}},{key:"updateFilledState",value:function(){this.input&&this.input.value&&0<this.input.value.length?_DomHandler.default.addClass(this.input,"p-filled"):_DomHandler.default.removeClass(this.input,"p-filled")}},{key:"updateValue",value:function(){var e=this;this.input&&(null==this.props.value?this.input.value="":(this.input.value=this.props.value,this.checkVal()),setTimeout(function(){e.input&&(e.writeBuffer(),e.checkVal())},10),this.focusText=this.input.value),this.updateFilledState()}},{key:"init",value:function(){this.tests=[],this.partialPosition=this.props.mask.length,this.len=this.props.mask.length,this.firstNonMaskPos=null,this.defs={9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"};var e=_DomHandler.default.getUserAgent();this.androidChrome=/chrome/i.test(e)&&/android/i.test(e);for(var t=this.props.mask.split(""),i=0;i<t.length;i++){var s=t[i];"?"===s?(this.len--,this.partialPosition=i):this.defs[s]?(this.tests.push(new RegExp(this.defs[s])),null===this.firstNonMaskPos&&(this.firstNonMaskPos=this.tests.length-1),i<this.partialPosition&&(this.lastRequiredNonMaskPos=this.tests.length-1)):this.tests.push(null)}this.buffer=[];for(var n=0;n<t.length;n++){var r=t[n];"?"!==r&&(this.defs[r]?this.buffer.push(this.getPlaceholder(n)):this.buffer.push(r))}this.defaultBuffer=this.buffer.join("")}},{key:"componentDidMount",value:function(){this.init(),this.updateValue(),this.props.tooltip&&this.renderTooltip()}},{key:"componentDidUpdate",value:function(e){e.tooltip!==this.props.tooltip&&(this.tooltip?this.tooltip.updateContent(this.props.tooltip):this.renderTooltip()),this.props.value&&(this.props.unmask?this.props.value!==this.getUnmaskedValue():this.props.value.length&&this.input.value!==this.props.value)&&this.updateValue(),e.mask!==this.props.mask&&(this.init(),this.updateValue(),this.updateModel())}},{key:"componentWillUnmount",value:function(){this.tooltip&&(this.tooltip.destroy(),this.tooltip=null)}},{key:"renderTooltip",value:function(){this.tooltip=new _Tooltip.default({target:this.input,content:this.props.tooltip,options:this.props.tooltipOptions})}},{key:"render",value:function(){var t=this;return _react.default.createElement(_InputText.InputText,{id:this.props.id,ref:function(e){return t.input=_reactDom.default.findDOMNode(e)},type:this.props.type,name:this.props.name,style:this.props.style,className:this.props.className,placeholder:this.props.placeholder,size:this.props.size,maxLength:this.props.maxlength,tabIndex:this.props.tabindex,disabled:this.props.disabled,readOnly:this.props.readonly,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onKeyPress:this.onKeyPress,onInput:this.onInput,onPaste:this.handleInputChange,required:this.props.required,"aria-labelledby":this.props.ariaLabelledBy})}}]),i}();_defineProperty(exports.InputMask=InputMask,"defaultProps",{id:null,value:null,type:"text",mask:null,slotChar:"_",autoClear:!0,unmask:!1,style:null,className:null,placeholder:null,size:null,maxlength:null,tabindex:null,disabled:!1,readonly:!1,name:null,required:!1,tooltip:null,tooltipOptions:null,ariaLabelledBy:null,onComplete:null,onChange:null}),_defineProperty(InputMask,"propTypes",{id:_propTypes.default.string,value:_propTypes.default.string,type:_propTypes.default.string,mask:_propTypes.default.string,slotChar:_propTypes.default.string,autoClear:_propTypes.default.bool,unmask:_propTypes.default.bool,style:_propTypes.default.object,className:_propTypes.default.string,placeholder:_propTypes.default.string,size:_propTypes.default.number,maxlength:_propTypes.default.number,tabindex:_propTypes.default.number,disabled:_propTypes.default.bool,readonly:_propTypes.default.bool,name:_propTypes.default.string,required:_propTypes.default.bool,tooltip:_propTypes.default.string,tooltipOptions:_propTypes.default.object,ariaLabelledBy:_propTypes.default.string,onComplete:_propTypes.default.func,onChange:_propTypes.default.func});