"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TableBody=void 0;var _react=_interopRequireWildcard(require("react")),_BodyRow=require("./BodyRow"),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_ObjectUtils=_interopRequireDefault(require("../utils/ObjectUtils")),_RowTogglerButton=require("./RowTogglerButton");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var o,r={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e){Object.prototype.hasOwnProperty.call(e,i)&&((o=n?Object.getOwnPropertyDescriptor(e,i):null)&&(o.get||o.set)?Object.defineProperty(r,i,o):r[i]=e[i])}return r.default=e,t&&t.set(e,r),r}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var o,r=Object.keys(t);return Object.getOwnPropertySymbols&&(o=Object.getOwnPropertySymbols(t),e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,o)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(o),!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(o){var r=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(o);return _possibleConstructorReturn(this,r?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var TableBody=function(){_inherits(r,_react.Component);var o=_createSuper(r);function r(e){var t;return _classCallCheck(this,r),(t=o.call(this,e)).onRowClick=t.onRowClick.bind(_assertThisInitialized(t)),t.onRowRightClick=t.onRowRightClick.bind(_assertThisInitialized(t)),t.onRowTouchEnd=t.onRowTouchEnd.bind(_assertThisInitialized(t)),t.onRowToggle=t.onRowToggle.bind(_assertThisInitialized(t)),t.onRadioClick=t.onRadioClick.bind(_assertThisInitialized(t)),t.onCheckboxClick=t.onCheckboxClick.bind(_assertThisInitialized(t)),t.onRowDragEnd=t.onRowDragEnd.bind(_assertThisInitialized(t)),t.onRowDragLeave=t.onRowDragLeave.bind(_assertThisInitialized(t)),t.onRowDrop=t.onRowDrop.bind(_assertThisInitialized(t)),t}return _createClass(r,[{key:"onRowClick",value:function(e){var t,o,r,n,i,a,s,l,p=e.originalEvent.target.nodeName;"INPUT"===p||"BUTTON"===p||"A"===p||_DomHandler.default.hasClass(e.originalEvent.target,"p-clickable")||(this.props.onRowClick&&this.props.onRowClick(e),this.props.selectionMode&&(t=e.data,o=e.index,this.isMultipleSelectionMode()&&e.originalEvent.shiftKey&&null!==this.anchorRowIndex?(_DomHandler.default.clearSelection(),this.rangeRowIndex=o,s=this.selectRange(e)):(r=this.isSelected(t),n=!this.rowTouched&&this.props.metaKeySelection,this.anchorRowIndex=o,this.rangeRowIndex=o,n?(i=e.originalEvent.metaKey||e.originalEvent.ctrlKey,r&&i?(s=this.isSingleSelectionMode()?null:(a=this.findIndexInSelection(t),this.props.selection.filter(function(e,t){return t!==a})),this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:t,type:"row"})):(this.isSingleSelectionMode()?s=t:this.isMultipleSelectionMode()&&(s=i&&this.props.selection?_toConsumableArray(this.props.selection):[],s=[].concat(_toConsumableArray(s),[t])),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"row"}))):this.isSingleSelectionMode()?r?(s=null,this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:t,type:"row"})):(s=t,this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"row"})):(s=r?(l=this.findIndexInSelection(t),this.props.selection.filter(function(e,t){return t!==l})):[].concat(_toConsumableArray(this.props.selection||[]),[t]),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"row"}))),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:s})),this.rowTouched=!1)}},{key:"selectRange",value:function(e){var t,o=this.rangeRowIndex>this.anchorRowIndex?(t=this.anchorRowIndex,this.rangeRowIndex):this.rangeRowIndex<this.anchorRowIndex?(t=this.rangeRowIndex,this.anchorRowIndex):(t=this.rangeRowIndex,this.rangeRowIndex);this.props.lazy&&this.props.paginator&&(t-=this.first,o-=this.first);for(var r=this.props.value,n=[],i=t;i<=o;i++){var a=r[i];n.push(a),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:a,type:"row"})}return n}},{key:"onRowTouchEnd",value:function(){this.rowTouched=!0}},{key:"onRowRightClick",value:function(e){this.props.onContextMenu&&(_DomHandler.default.clearSelection(),this.props.onContextMenuSelectionChange&&this.props.onContextMenuSelectionChange({originalEvent:e.originalEvent,value:e.data}),this.props.onContextMenu&&this.props.onContextMenu({originalEvent:e.originalEvent,value:this.props.node}),e.originalEvent.preventDefault())}},{key:"onRadioClick",value:function(e){var t,o=e.data;this.isSelected(o)?(t=null,this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:o,type:"radio"})):(t=o,this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:o,type:"radio"})),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:t})}},{key:"onCheckboxClick",value:function(e){var o,t,r=e.data;this.isSelected(r)?(o=this.findIndexInSelection(r),t=this.props.selection.filter(function(e,t){return t!==o}),this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:r,type:"checkbox"})):(t=[].concat(_toConsumableArray(this.props.selection||[]),[r]),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:r,type:"checkbox"})),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:t})}},{key:"isSingleSelectionMode",value:function(){return"single"===this.props.selectionMode}},{key:"isMultipleSelectionMode",value:function(){return"multiple"===this.props.selectionMode}},{key:"isSelected",value:function(e){return!(!e||!this.props.selection)&&(this.props.selection instanceof Array?-1<this.findIndexInSelection(e):this.equals(e,this.props.selection))}},{key:"isContextMenuSelected",value:function(e){return!(!e||!this.props.contextMenuSelection)&&this.equals(e,this.props.contextMenuSelection)}},{key:"equals",value:function(e,t){return"equals"===this.compareSelectionBy?e===t:_ObjectUtils.default.equals(e,t,this.props.dataKey)}},{key:"findIndexInSelection",value:function(e){var t=-1;if(this.props.selection)for(var o=0;o<this.props.selection.length;o++)if(this.equals(e,this.props.selection[o])){t=o;break}return t}},{key:"onRowToggle",value:function(e){var t,o,r,n=this.props.dataKey;n?(t=String(_ObjectUtils.default.resolveFieldData(e.data,n)),null!=(o=this.props.expandedRows?_objectSpread({},this.props.expandedRows):{})[t]?(delete o[t],this.props.onRowCollapse&&this.props.onRowCollapse({originalEvent:e,data:e.data})):(o[t]=!0,this.props.onRowExpand&&this.props.onRowExpand({originalEvent:e,data:e.data}))):(r=this.findExpandedRowIndex(e.data),o=this.props.expandedRows?_toConsumableArray(this.props.expandedRows):[],-1!==r?(o=o.filter(function(e,t){return t!==r}),this.props.onRowCollapse&&this.props.onRowCollapse({originalEvent:e,data:e.data})):(o.push(e.data),this.props.onRowExpand&&this.props.onRowExpand({originalEvent:e,data:e.data}))),this.props.onRowToggle&&this.props.onRowToggle({data:o})}},{key:"findExpandedRowIndex",value:function(e){var t=-1;if(this.props.expandedRows)for(var o=0;o<this.props.expandedRows.length;o++)if(_ObjectUtils.default.equals(this.props.expandedRows[o],e)){t=o;break}return t}},{key:"isRowExpanded",value:function(e){var t=this.props.dataKey;if(t){var o=String(_ObjectUtils.default.resolveFieldData(e,t));return this.props.expandedRows&&null!=this.props.expandedRows[o]}return-1!==this.findExpandedRowIndex(e)}},{key:"isSelectionEnabled",value:function(){if(this.props.selectionMode||null!=this.props.frozenSelectionMode)return!0;if(!Array.isArray(this.props.children))return this.props.children&&null!=this.props.children.selectionMode;for(var e=0;e<this.props.children.length;e++)if(this.props.children[e].props.selectionMode)return!0;return!1}},{key:"onRowDragStart",value:function(e,t){this.rowDragging=!0,this.draggedRowIndex=t,e.dataTransfer.setData("text","b")}},{key:"onRowDragEnd",value:function(){this.rowDragging=!1,this.draggedRowIndex=null,this.droppedRowIndex=null}},{key:"onRowDragOver",value:function(e,t){var o,r,n,i,a;this.rowDragging&&this.draggedRowIndex!==t&&(o=e.rowElement,r=_DomHandler.default.getOffset(o).top+_DomHandler.default.getWindowScrollTop(),n=e.originalEvent.pageY,i=r+_DomHandler.default.getOuterHeight(o)/2,a=o.previousElementSibling,n<i?(_DomHandler.default.removeClass(o,"p-datatable-dragpoint-bottom"),this.droppedRowIndex=t,a?_DomHandler.default.addClass(a,"p-datatable-dragpoint-bottom"):_DomHandler.default.addClass(o,"p-datatable-dragpoint-top")):(a?_DomHandler.default.removeClass(a,"p-datatable-dragpoint-bottom"):_DomHandler.default.addClass(o,"p-datatable-dragpoint-top"),this.droppedRowIndex=t+1,_DomHandler.default.addClass(o,"p-datatable-dragpoint-bottom")))}},{key:"onRowDragLeave",value:function(e){var t=e.rowElement,o=t.previousElementSibling;o&&_DomHandler.default.removeClass(o,"p-datatable-dragpoint-bottom"),_DomHandler.default.removeClass(t,"p-datatable-dragpoint-bottom"),_DomHandler.default.removeClass(t,"p-datatable-dragpoint-top")}},{key:"onRowDrop",value:function(e){var t,o;null!=this.droppedRowIndex&&(t=this.draggedRowIndex>this.droppedRowIndex?this.droppedRowIndex:0===this.droppedRowIndex?0:this.droppedRowIndex-1,o=_toConsumableArray(this.props.value),_ObjectUtils.default.reorderArray(o,this.draggedRowIndex,t),this.props.onRowReorder&&this.props.onRowReorder({originalEvent:e,value:o,dragIndex:this.draggedRowIndex,dropIndex:this.droppedRowIndex})),this.onRowDragLeave(e),this.onRowDragEnd(e)}},{key:"renderRowGroupHeader",value:function(e,t){var o=null;return"subheader"===this.props.rowGroupMode&&this.props.expandableRowGroups&&(o=_react.default.createElement(_RowTogglerButton.RowTogglerButton,{onClick:this.onRowToggle,rowData:e,expanded:this.isRowExpanded(e)})),_react.default.createElement("tr",{key:t+"_rowgroupheader",className:"p-rowgroup-header"},_react.default.createElement("td",{colSpan:_react.default.Children.count(this.props.children)},o,_react.default.createElement("span",{className:"p-rowgroup-header-name"},this.props.rowGroupHeaderTemplate(e,t))))}},{key:"renderRowGroupFooter",value:function(e,t){return _react.default.createElement("tr",{key:t+"_rowgroupfooter",className:"p-rowgroup-footer"},this.props.rowGroupFooterTemplate(e,t))}},{key:"render",value:function(){var v=this,e=this.props.rows||0,t=this.props.first||0,y=this.isSelectionEnabled(),o=this.props.rowGroupMode,b=o&&"subheader"===o,_=o&&"rowspan"===o,m=!1;if(this.props.value&&this.props.value.length){x=[];for(var E=this.props.lazy?0:t,r=this.props.virtualScroll?E+2*e:E+e||this.props.value.length,n=function(t){if(t>=v.props.value.length)return"break";var e,o,r=v.props.value[t],n=v.isRowExpanded(r),i=!!y&&v.isSelected(v.props.value[t]),a=v.isContextMenuSelected(r),s=void 0;if(b&&(e=_ObjectUtils.default.resolveFieldData(r,v.props.groupField),o=_ObjectUtils.default.resolveFieldData(v.props.value[t-1],v.props.groupField),0!==t&&e===o||(x.push(v.renderRowGroupHeader(r,t)),m=n)),_){var l=t,p=_ObjectUtils.default.resolveFieldData(r,v.props.sortField);if(t===E||_ObjectUtils.default.resolveFieldData(v.props.value[t-1],v.props.sortField)!==p)for(var d=p,s=0;p===d;){s++;var u=v.props.value[++l];if(!u)break;d=_ObjectUtils.default.resolveFieldData(u,v.props.sortField)}}var c,h,f,g,w,R=v.props.expandableRowGroups&&b&&m;v.props.expandableRowGroups&&!R||(c=_react.default.createElement(_BodyRow.BodyRow,{key:t,value:v.props.value,rowData:r,rowIndex:t,onClick:v.onRowClick,onDoubleClick:v.props.onRowDoubleClick,onRightClick:v.onRowRightClick,onTouchEnd:v.onRowTouchEnd,onRowToggle:v.onRowToggle,expanded:n,selectionMode:v.props.selectionMode,onRadioClick:v.onRadioClick,onCheckboxClick:v.onCheckboxClick,selected:i,contextMenuSelected:a,rowClassName:v.props.rowClassName,sortField:v.props.sortField,rowGroupMode:v.props.rowGroupMode,groupRowSpan:s,onDragStart:function(e){return v.onRowDragStart(e,t)},onDragEnd:v.onRowDragEnd,onDragOver:function(e){return v.onRowDragOver(e,t)},onDragLeave:v.onRowDragLeave,onDrop:v.onRowDrop,virtualScroll:v.props.virtualScroll,virtualRowHeight:v.props.virtualRowHeight,editMode:v.props.editMode,rowEditorValidator:v.props.rowEditorValidator,onRowEditInit:v.props.onRowEditInit,onRowEditSave:v.props.onRowEditSave,onRowEditCancel:v.props.onRowEditCancel,showRowReorderElement:v.props.showRowReorderElement,showSelectionElement:v.props.showSelectionElement},v.props.children),x.push(c)),!n||b&&v.props.expandableRowGroups||(h=v.props.rowExpansionTemplate(r),f=_react.default.createElement("tr",{key:t+"_expanded"},_react.default.createElement("td",{colSpan:v.props.children.length},h)),x.push(f)),!b||v.props.expandableRowGroups&&!R||(g=_ObjectUtils.default.resolveFieldData(r,v.props.groupField),w=_ObjectUtils.default.resolveFieldData(v.props.value[t+1],v.props.groupField),t!==v.props.value.length-1&&g===w||x.push(v.renderRowGroupFooter(r,t)))},i=E;i<r;i++){if("break"===n(i))break}}else var a=this.props.emptyMessage,x=this.props.loading||null===a?null:_react.default.createElement("tr",{className:"p-datatable-emptymessage"},_react.default.createElement("td",{colSpan:this.props.children.length},"function"==typeof a?a(this.props.frozen):a));return _react.default.createElement("tbody",{className:"p-datatable-tbody"},x)}}]),r}();exports.TableBody=TableBody;