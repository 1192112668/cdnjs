"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileUpload=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_Button=require("../button/Button"),_Messages=require("../messages/Messages"),_ProgressBar=require("../progressbar/ProgressBar"),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_classnames=_interopRequireDefault(require("classnames"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var r,a={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e){Object.prototype.hasOwnProperty.call(e,o)&&((r=n?Object.getOwnPropertyDescriptor(e,o):null)&&(r.get||r.set)?Object.defineProperty(a,o,r):a[o]=e[o])}return a.default=e,t&&t.set(e,a),a}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=_unsupportedIterableToArray(e))){var t=0,r=function(){};return{s:r,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,n,o=!0,i=!1;return{s:function(){a=e[Symbol.iterator]()},n:function(){var e=a.next();return o=e.done,e},e:function(e){i=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(i)throw n}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(r):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,_isNativeReflectConstruct()?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var FileUpload=function(){_inherits(a,_react.Component);var r=_createSuper(a);function a(e){var t;return _classCallCheck(this,a),(t=r.call(this,e)).state={files:[],msgs:[]},t.upload=t.upload.bind(_assertThisInitialized(t)),t.clear=t.clear.bind(_assertThisInitialized(t)),t.onFileSelect=t.onFileSelect.bind(_assertThisInitialized(t)),t.onDragEnter=t.onDragEnter.bind(_assertThisInitialized(t)),t.onDragOver=t.onDragOver.bind(_assertThisInitialized(t)),t.onDragLeave=t.onDragLeave.bind(_assertThisInitialized(t)),t.onDrop=t.onDrop.bind(_assertThisInitialized(t)),t.onFocus=t.onFocus.bind(_assertThisInitialized(t)),t.onBlur=t.onBlur.bind(_assertThisInitialized(t)),t.onSimpleUploaderClick=t.onSimpleUploaderClick.bind(_assertThisInitialized(t)),t.duplicateIEEvent=!1,t}return _createClass(a,[{key:"hasFiles",value:function(){return this.state.files&&0<this.state.files.length}},{key:"isImage",value:function(e){return/^image\//.test(e.type)}},{key:"remove",value:function(e,t){this.clearInputElement();var r=_toConsumableArray(this.state.files),a=this.state.files[t];r.splice(t,1),this.setState({files:r}),this.props.onRemove&&this.props.onRemove({originalEvent:e,file:a})}},{key:"clearInputElement",value:function(){this.fileInput.value="","basic"===this.props.mode&&(this.fileInput.style.display="inline")}},{key:"clearIEInput",value:function(){this.fileInput&&(this.duplicateIEEvent=!0,this.fileInput.value="")}},{key:"formatSize",value:function(e){if(0===e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,t)).toFixed(3))+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}},{key:"onFileSelect",value:function(e){var t=this;if("drop"!==e.type&&this.isIE11()&&this.duplicateIEEvent)this.duplicateIEEvent=!1;else{this.setState({msgs:[]}),this.files=this.state.files||[];for(var r=e.dataTransfer?e.dataTransfer.files:e.target.files,a=0;a<r.length;a++){var n=r[a];this.isFileSelected(n)||this.validate(n)&&(this.isImage(n)&&(n.objectURL=window.URL.createObjectURL(n)),this.files.push(n))}this.setState({files:this.files},function(){t.hasFiles()&&t.props.auto&&t.upload()}),this.props.onSelect&&this.props.onSelect({originalEvent:e,files:r}),"drop"!==e.type&&this.isIE11()?this.clearIEInput():this.clearInputElement(),"basic"===this.props.mode&&(this.fileInput.style.display="none")}}},{key:"isFileSelected",value:function(e){var t,r=_createForOfIteratorHelper(this.state.files);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.name+a.type+a.size===e.name+e.type+e.size)return!0}}catch(e){r.e(e)}finally{r.f()}return!1}},{key:"isIE11",value:function(){return!!window.MSInputMethodContext&&!!document.documentMode}},{key:"validate",value:function(e){if(this.props.maxFileSize&&e.size>this.props.maxFileSize){var t={severity:"error",summary:this.props.invalidFileSizeMessageSummary.replace("{0}",e.name),detail:this.props.invalidFileSizeMessageDetail.replace("{0}",this.formatSize(this.props.maxFileSize))};return"advanced"===this.props.mode&&this.messagesUI.show(t),this.props.onValidationFail&&this.props.onValidationFail(e),!1}return!0}},{key:"upload",value:function(){var t=this;if(this.props.customUpload)this.props.uploadHandler&&this.props.uploadHandler({files:this.state.files});else{this.setState({msgs:[]});var e=new XMLHttpRequest,r=new FormData;this.props.onBeforeUpload&&this.props.onBeforeUpload({xhr:e,formData:r});var a,n=_createForOfIteratorHelper(this.state.files);try{for(n.s();!(a=n.n()).done;){var o=a.value;r.append(this.props.name,o,o.name)}}catch(e){n.e(e)}finally{n.f()}e.upload.addEventListener("progress",function(e){e.lengthComputable&&t.setState({progress:Math.round(100*e.loaded/e.total)}),t.props.onProgress&&t.props.onProgress({originalEvent:e,progress:t.progress})}),e.onreadystatechange=function(){4===e.readyState&&(t.setState({progress:0}),200<=e.status&&e.status<300?t.props.onUpload&&t.props.onUpload({xhr:e,files:t.files}):t.props.onError&&t.props.onError({xhr:e,files:t.files}),t.clear())},e.open("POST",this.props.url,!0),this.props.onBeforeSend&&this.props.onBeforeSend({xhr:e,formData:r}),e.withCredentials=this.props.withCredentials,e.send(r)}}},{key:"clear",value:function(){this.setState({files:[]}),this.props.onClear&&this.props.onClear(),this.clearInputElement()}},{key:"onFocus",value:function(e){_DomHandler.default.addClass(e.currentTarget.parentElement,"p-focus")}},{key:"onBlur",value:function(e){_DomHandler.default.removeClass(e.currentTarget.parentElement,"p-focus")}},{key:"onDragEnter",value:function(e){this.props.disabled||(e.stopPropagation(),e.preventDefault())}},{key:"onDragOver",value:function(e){this.props.disabled||(_DomHandler.default.addClass(this.content,"p-fileupload-highlight"),e.stopPropagation(),e.preventDefault())}},{key:"onDragLeave",value:function(){this.props.disabled||_DomHandler.default.removeClass(this.content,"p-fileupload-highlight")}},{key:"onDrop",value:function(e){var t;this.props.disabled||(_DomHandler.default.removeClass(this.content,"p-fileupload-highlight"),e.stopPropagation(),e.preventDefault(),t=e.dataTransfer?e.dataTransfer.files:e.target.files,(this.props.multiple||t&&1===t.length)&&this.onFileSelect(e))}},{key:"onSimpleUploaderClick",value:function(){this.hasFiles()&&this.upload()}},{key:"renderChooseButton",value:function(){var t=this,e=(0,_classnames.default)("p-button p-fileupload-choose p-component p-button-text-icon-left");return _react.default.createElement("span",{icon:"pi pi-plus",className:e},_react.default.createElement("input",{ref:function(e){return t.fileInput=e},type:"file",onChange:this.onFileSelect,onFocus:this.onFocus,onBlur:this.onBlur,multiple:this.props.multiple,accept:this.props.accept,disabled:this.props.disabled}),_react.default.createElement("span",{className:"p-button-icon p-button-icon-left p-clickable pi pi-fw pi-plus"}),_react.default.createElement("span",{className:"p-button-text p-clickable"},this.props.chooseLabel))}},{key:"renderFiles",value:function(){var i=this;return _react.default.createElement("div",{className:"p-fileupload-files"},this.state.files.map(function(e,t){var r=i.isImage(e)?_react.default.createElement("div",null,_react.default.createElement("img",{alt:e.name,role:"presentation",src:e.objectURL,width:i.props.previewWidth})):null,a=_react.default.createElement("div",null,e.name),n=_react.default.createElement("div",null,i.formatSize(e.size)),o=_react.default.createElement("div",null,_react.default.createElement(_Button.Button,{type:"button",icon:"pi pi-times",onClick:function(e){return i.remove(e,t)}}));return _react.default.createElement("div",{className:"p-fileupload-row",key:e.name+e.type+e.size},r,a,n,o)}))}},{key:"renderAdvanced",value:function(){var e,t,r,a,n=this,o=(0,_classnames.default)("p-fileupload p-component",this.props.className),i=this.renderChooseButton();return this.props.auto||(e=_react.default.createElement(_Button.Button,{type:"button",label:this.props.uploadLabel,icon:"pi pi-upload",onClick:this.upload,disabled:this.props.disabled||!this.hasFiles()}),t=_react.default.createElement(_Button.Button,{type:"button",label:this.props.cancelLabel,icon:"pi pi-times",onClick:this.clear,disabled:this.props.disabled||!this.hasFiles()})),this.hasFiles()&&(r=this.renderFiles(),a=_react.default.createElement(_ProgressBar.ProgressBar,{value:this.state.progress,showValue:!1})),_react.default.createElement("div",{id:this.props.id,className:o,style:this.props.style},_react.default.createElement("div",{className:"p-fileupload-buttonbar"},i,e,t),_react.default.createElement("div",{ref:function(e){n.content=e},className:"p-fileupload-content",onDragEnter:this.onDragEnter,onDragOver:this.onDragOver,onDragLeave:this.onDragLeave,onDrop:this.onDrop},a,_react.default.createElement(_Messages.Messages,{ref:function(e){return n.messagesUI=e}}),r))}},{key:"renderBasic",value:function(){var t=this,e=(0,_classnames.default)("p-button p-fileupload-choose p-component p-button-text-icon-left",{"p-fileupload-choose-selected":this.hasFiles()}),r=(0,_classnames.default)("p-button-icon-left pi",{"pi-plus":!this.hasFiles()||this.props.auto,"pi-upload":this.hasFiles()&&!this.props.auto});return _react.default.createElement("span",{className:e,onMouseUp:this.onSimpleUploaderClick},_react.default.createElement("span",{className:r}),_react.default.createElement("span",{className:"p-button-text p-clickable"},!this.props.auto&&this.hasFiles()?this.state.files[0].name:this.props.chooseLabel),_react.default.createElement("input",{ref:function(e){return t.fileInput=e},type:"file",multiple:this.props.multiple,accept:this.props.accept,disabled:this.props.disabled,onChange:this.onFileSelect,onFocus:this.onFocus,onBlur:this.onBlur}))}},{key:"render",value:function(){return"advanced"===this.props.mode?this.renderAdvanced():"basic"===this.props.mode?this.renderBasic():void 0}}]),a}();_defineProperty(exports.FileUpload=FileUpload,"defaultProps",{id:null,name:null,url:null,mode:"advanced",multiple:!1,accept:null,disabled:!1,auto:!1,maxFileSize:null,invalidFileSizeMessageSummary:"{0}: Invalid file size, ",invalidFileSizeMessageDetail:"maximum upload size is {0}.",style:null,className:null,widthCredentials:!1,previewWidth:50,chooseLabel:"Choose",uploadLabel:"Upload",cancelLabel:"Cancel",customUpload:!1,onBeforeUpload:null,onBeforeSend:null,onUpload:null,onError:null,onClear:null,onSelect:null,onProgress:null,onValidationFail:null,uploadHandler:null,onRemove:null}),_defineProperty(FileUpload,"propTypes",{id:_propTypes.default.string,name:_propTypes.default.string,url:_propTypes.default.string,mode:_propTypes.default.string,multiple:_propTypes.default.bool,accept:_propTypes.default.string,disabled:_propTypes.default.bool,auto:_propTypes.default.bool,maxFileSize:_propTypes.default.number,invalidFileSizeMessageSummary:_propTypes.default.string,invalidFileSizeMessageDetail:_propTypes.default.string,style:_propTypes.default.object,className:_propTypes.default.string,widthCredentials:_propTypes.default.bool,previewWidth:_propTypes.default.number,chooseLabel:_propTypes.default.string,uploadLabel:_propTypes.default.string,cancelLabel:_propTypes.default.string,customUpload:_propTypes.default.bool,onBeforeUpload:_propTypes.default.func,onBeforeSend:_propTypes.default.func,onUpload:_propTypes.default.func,onError:_propTypes.default.func,onClear:_propTypes.default.func,onSelect:_propTypes.default.func,onProgress:_propTypes.default.func,onValidationFail:_propTypes.default.func,uploadHandler:_propTypes.default.func,onRemove:_propTypes.default.func});