"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Dropdown=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_ObjectUtils=_interopRequireDefault(require("../utils/ObjectUtils")),_FilterUtils=_interopRequireDefault(require("../utils/FilterUtils")),_classnames=_interopRequireDefault(require("classnames")),_DropdownPanel=require("./DropdownPanel"),_DropdownItem=require("./DropdownItem"),_Tooltip=require("../tooltip/Tooltip"),_reactTransitionGroup=require("react-transition-group"),_UniqueComponentId=_interopRequireDefault(require("../utils/UniqueComponentId")),_ConnectedOverlayScrollHandler=_interopRequireDefault(require("../utils/ConnectedOverlayScrollHandler"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var i,n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e){Object.prototype.hasOwnProperty.call(e,o)&&((i=r?Object.getOwnPropertyDescriptor(e,o):null)&&(i.get||i.set)?Object.defineProperty(n,o,i):n[o]=e[o])}return n.default=e,t&&t.set(e,n),n}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(i){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(i);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Dropdown=function(){_inherits(n,_react.Component);var i=_createSuper(n);function n(e){var t;return _classCallCheck(this,n),(t=i.call(this,e)).state={filter:"",focused:!1,overlayVisible:!1},t.onClick=t.onClick.bind(_assertThisInitialized(t)),t.onInputFocus=t.onInputFocus.bind(_assertThisInitialized(t)),t.onInputBlur=t.onInputBlur.bind(_assertThisInitialized(t)),t.onInputKeyDown=t.onInputKeyDown.bind(_assertThisInitialized(t)),t.onEditableInputClick=t.onEditableInputClick.bind(_assertThisInitialized(t)),t.onEditableInputChange=t.onEditableInputChange.bind(_assertThisInitialized(t)),t.onEditableInputFocus=t.onEditableInputFocus.bind(_assertThisInitialized(t)),t.onOptionClick=t.onOptionClick.bind(_assertThisInitialized(t)),t.onFilterInputChange=t.onFilterInputChange.bind(_assertThisInitialized(t)),t.onFilterInputKeyDown=t.onFilterInputKeyDown.bind(_assertThisInitialized(t)),t.onPanelClick=t.onPanelClick.bind(_assertThisInitialized(t)),t.onOverlayEnter=t.onOverlayEnter.bind(_assertThisInitialized(t)),t.onOverlayEntered=t.onOverlayEntered.bind(_assertThisInitialized(t)),t.onOverlayExit=t.onOverlayExit.bind(_assertThisInitialized(t)),t.onOverlayExited=t.onOverlayExited.bind(_assertThisInitialized(t)),t.clear=t.clear.bind(_assertThisInitialized(t)),t.id=t.props.id||(0,_UniqueComponentId.default)(),t}return _createClass(n,[{key:"onClick",value:function(e){this.props.disabled||this.isClearClicked(e)||(this.focusInput.focus(),this.state.overlayVisible?this.hideOverlay():this.showOverlay())}},{key:"onInputFocus",value:function(e){var t=this;e.persist(),this.setState({focused:!0},function(){t.props.onFocus&&t.props.onFocus(e)})}},{key:"onInputBlur",value:function(e){var t=this;e.persist(),this.setState({focused:!1},function(){t.props.onBlur&&t.props.onBlur(e)})}},{key:"onPanelClick",value:function(e){e.stopPropagation()}},{key:"onInputKeyDown",value:function(e){switch(e.which){case 40:this.onDownKey(e);break;case 38:this.onUpKey(e);break;case 32:this.state.overlayVisible||(this.showOverlay(),e.preventDefault());break;case 13:this.hideOverlay(),e.preventDefault();break;case 27:case 9:this.hideOverlay();break;default:this.search(e)}}},{key:"onFilterInputKeyDown",value:function(e){switch(e.which){case 40:this.onDownKey(e);break;case 38:this.onUpKey(e);break;case 13:case 27:this.hideOverlay(),e.preventDefault()}}},{key:"onUpKey",value:function(e){var t,i,n;this.props.options&&(t=this.getVisibleOptions(),i=this.findOptionIndex(this.props.value,t),(n=this.findPrevVisibleItem(i,t))&&this.selectItem({originalEvent:e,option:n})),e.preventDefault()}},{key:"onDownKey",value:function(e){var t,i,n;this.props.options&&(!this.state.overlayVisible&&e.altKey?this.showOverlay():(t=this.getVisibleOptions(),i=this.findOptionIndex(this.props.value,t),(n=this.findNextVisibleItem(i,t))&&this.selectItem({originalEvent:e,option:n}))),e.preventDefault()}},{key:"search",value:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout);var i=String.fromCharCode(e.keyCode);this.previousSearchChar=this.currentSearchChar,this.currentSearchChar=i,this.previousSearchChar===this.currentSearchChar?this.searchValue=this.currentSearchChar:this.searchValue=this.searchValue?this.searchValue+i:i;var n=this.props.value?this.findOptionIndex(this.props.value,this.props.options):-1,r=this.searchOption(++n);r&&(this.selectItem({originalEvent:e,option:r}),this.selectedOptionUpdated=!0),this.searchTimeout=setTimeout(function(){t.searchValue=null},250)}},{key:"searchOption",value:function(e){var t;return this.searchValue&&(t=(t=this.searchOptionInRange(e,this.props.options.length))||this.searchOptionInRange(0,e)),t}},{key:"searchOptionInRange",value:function(e,t){for(var i=e;i<t;i++){var n=this.props.options[i];if(this.getOptionLabel(n).toString().toLocaleLowerCase(this.props.filterLocale).startsWith(this.searchValue.toLocaleLowerCase(this.props.filterLocale)))return n}return null}},{key:"filter",value:function(e){var t=this.state.filter.trim().toLocaleLowerCase(this.props.filterLocale),i=this.props.filterBy?this.props.filterBy.split(","):[this.props.optionLabel||"label"],n=_FilterUtils.default.filter(e,i,t,this.props.filterMatchMode,this.props.filterLocale);return n&&n.length?n:null}},{key:"findNextVisibleItem",value:function(e,t){var i=e+1;if(i===t.length)return null;var n=t[i];return n.disabled?this.findNextVisibleItem(i):n}},{key:"findPrevVisibleItem",value:function(e,t){var i=e-1;if(i<0)return null;var n=t[i];return n.disabled?this.findPrevVisibleItem(i):n}},{key:"onEditableInputClick",value:function(e){this.bindDocumentClickListener(),e.stopPropagation()}},{key:"onEditableInputChange",value:function(e){this.props.onChange({originalEvent:e.originalEvent,value:e.target.value,stopPropagation:function(){},preventDefault:function(){},target:{name:this.props.name,id:this.id,value:e.target.value}})}},{key:"onEditableInputFocus",value:function(e){var t=this;e.persist(),this.setState({focused:!0},function(){t.hideOverlay(),t.props.onFocus&&t.props.onFocus(e)})}},{key:"onOptionClick",value:function(e){var t=this;e.option.disabled||(this.selectItem(e),this.focusInput.focus()),setTimeout(function(){t.hideOverlay()},100)}},{key:"onFilterInputChange",value:function(e){this.setState({filter:e.target.value})}},{key:"resetFilter",value:function(){this.setState({filter:""})}},{key:"clear",value:function(e){this.props.onChange({originalEvent:e,value:null,stopPropagation:function(){},preventDefault:function(){},target:{name:this.props.name,id:this.id,value:null}}),this.updateEditableLabel()}},{key:"selectItem",value:function(e){var t;this.findOption(this.props.value)!==e.option&&(this.updateEditableLabel(e.option),t=this.getOptionValue(e.option),this.props.onChange({originalEvent:e.originalEvent,value:t,stopPropagation:function(){},preventDefault:function(){},target:{name:this.props.name,id:this.id,value:t}}))}},{key:"findOptionIndex",value:function(e,t){var i=-1;if(t)for(var n=0;n<t.length;n++){var r=this.getOptionValue(t[n]);if(null===e&&null==r||_ObjectUtils.default.equals(e,r,this.props.dataKey)){i=n;break}}return i}},{key:"findOption",value:function(e){var t=this.findOptionIndex(e,this.props.options);return-1!==t?this.props.options[t]:null}},{key:"showOverlay",value:function(){this.setState({overlayVisible:!0})}},{key:"hideOverlay",value:function(){this.setState({overlayVisible:!1})}},{key:"onOverlayEnter",value:function(){this.panel.element.style.zIndex=String(_DomHandler.default.generateZIndex()),this.alignPanel()}},{key:"onOverlayEntered",value:function(){this.scrollInView(),this.bindDocumentClickListener(),this.bindScrollListener(),this.bindResizeListener(),this.props.filter&&this.props.filterInputAutoFocus&&this.filterInput.focus()}},{key:"onOverlayExit",value:function(){this.unbindDocumentClickListener(),this.unbindScrollListener(),this.unbindResizeListener()}},{key:"onOverlayExited",value:function(){this.props.filter&&this.props.resetFilterOnHide&&this.resetFilter()}},{key:"alignPanel",value:function(){var e=this.input.parentElement;this.props.appendTo?(this.panel.element.style.minWidth=_DomHandler.default.getWidth(e)+"px",_DomHandler.default.absolutePosition(this.panel.element,e)):_DomHandler.default.relativePosition(this.panel.element,e)}},{key:"scrollInView",value:function(){var e=_DomHandler.default.findSingle(this.panel.element,"li.p-highlight");e&&_DomHandler.default.scrollInView(this.panel.itemsWrapper,e)}},{key:"bindDocumentClickListener",value:function(){var t=this;this.documentClickListener||(this.documentClickListener=function(e){t.state.overlayVisible&&t.isOutsideClicked(e)&&t.hideOverlay()},document.addEventListener("click",this.documentClickListener))}},{key:"unbindDocumentClickListener",value:function(){this.documentClickListener&&(document.removeEventListener("click",this.documentClickListener),this.documentClickListener=null)}},{key:"bindScrollListener",value:function(){var e=this;this.scrollHandler||(this.scrollHandler=new _ConnectedOverlayScrollHandler.default(this.container,function(){e.state.overlayVisible&&e.hideOverlay()})),this.scrollHandler.bindScrollListener()}},{key:"unbindScrollListener",value:function(){this.scrollHandler&&this.scrollHandler.unbindScrollListener()}},{key:"bindResizeListener",value:function(){var e=this;this.resizeListener||(this.resizeListener=function(){e.state.overlayVisible&&e.hideOverlay()},window.addEventListener("resize",this.resizeListener))}},{key:"unbindResizeListener",value:function(){this.resizeListener&&(window.removeEventListener("resize",this.resizeListener),this.resizeListener=null)}},{key:"isOutsideClicked",value:function(e){return this.container&&!(this.container.isSameNode(e.target)||this.isClearClicked(e)||this.container.contains(e.target)||this.panel&&this.panel.element&&this.panel.element.contains(e.target))}},{key:"isClearClicked",value:function(e){return _DomHandler.default.hasClass(e.target,"p-dropdown-clear-icon")}},{key:"updateEditableLabel",value:function(e){this.input&&(this.input.value=e?this.getOptionLabel(e):this.props.value||"")}},{key:"hasFilter",value:function(){return this.state.filter&&0<this.state.filter.trim().length}},{key:"getOptionLabel",value:function(e){return this.props.optionLabel?_ObjectUtils.default.resolveFieldData(e,this.props.optionLabel):void 0!==e.label?e.label:e}},{key:"getOptionValue",value:function(e){return this.props.optionValue?_ObjectUtils.default.resolveFieldData(e,this.props.optionValue):void 0!==e.value?e.value:e}},{key:"getOptionKey",value:function(e,t){return this.props.dataKey?_ObjectUtils.default.resolveFieldData(e,this.props.dataKey):"pr_id__".concat(this.getOptionLabel(e),"-").concat(t)}},{key:"checkValidity",value:function(){return this.nativeSelect.checkValidity()}},{key:"getVisibleOptions",value:function(){return this.props.options&&this.hasFilter()?this.filter(this.props.options):this.props.options}},{key:"updateInputField",value:function(){var e,t;this.props.editable&&this.input&&(t=((e=this.findOption(this.props.value))?this.getOptionLabel(e):null)||this.props.value||"",this.input.value=t)}},{key:"componentDidMount",value:function(){this.props.autoFocus&&this.focusInput&&this.focusInput.focus(),this.props.tooltip&&this.renderTooltip(),this.updateInputField(),this.nativeSelect.selectedIndex=1}},{key:"componentWillUnmount",value:function(){this.unbindDocumentClickListener(),this.unbindResizeListener(),this.scrollHandler&&(this.scrollHandler.destroy(),this.scrollHandler=null),this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}},{key:"componentDidUpdate",value:function(e){this.state.overlayVisible&&(this.props.filter&&this.alignPanel(),e.value!==this.props.value&&this.scrollInView()),e.tooltip!==this.props.tooltip&&(this.tooltip?this.tooltip.updateContent(this.props.tooltip):this.renderTooltip()),!this.state.filter||this.props.options&&0!==this.props.options.length||this.setState({filter:""}),this.updateInputField(),this.nativeSelect.selectedIndex=1}},{key:"renderHiddenSelect",value:function(e){var t=this,i=_react.default.createElement("option",{value:""},this.props.placeholder),n=e?_react.default.createElement("option",{value:e.value},this.getOptionLabel(e)):null;return _react.default.createElement("div",{className:"p-hidden-accessible p-dropdown-hidden-select"},_react.default.createElement("select",{ref:function(e){return t.nativeSelect=e},required:this.props.required,name:this.props.name,tabIndex:"-1","aria-hidden":"true"},i,n))}},{key:"renderTooltip",value:function(){this.tooltip=(0,_Tooltip.tip)({target:this.container,content:this.props.tooltip,options:this.props.tooltipOptions})}},{key:"renderKeyboardHelper",value:function(){var t=this;return _react.default.createElement("div",{className:"p-hidden-accessible"},_react.default.createElement("input",{ref:function(e){return t.focusInput=e},id:this.props.inputId,type:"text",readOnly:!0,"aria-haspopup":"listbox",onFocus:this.onInputFocus,onBlur:this.onInputBlur,onKeyDown:this.onInputKeyDown,disabled:this.props.disabled,tabIndex:this.props.tabIndex,"aria-label":this.props.ariaLabel,"aria-labelledby":this.props.ariaLabelledBy}))}},{key:"renderLabel",value:function(e){var t=this,i=e?this.getOptionLabel(e):null;if(this.props.editable){var n=i||this.props.value||"";return _react.default.createElement("input",{ref:function(e){return t.input=e},type:"text",defaultValue:n,className:"p-dropdown-label p-inputtext",disabled:this.props.disabled,placeholder:this.props.placeholder,maxLength:this.props.maxLength,onClick:this.onEditableInputClick,onInput:this.onEditableInputChange,onFocus:this.onEditableInputFocus,onBlur:this.onInputBlur,"aria-label":this.props.ariaLabel,"aria-labelledby":this.props.ariaLabelledBy,"aria-haspopup":"listbox"})}var r=(0,_classnames.default)("p-dropdown-label p-inputtext",{"p-placeholder":null===i&&this.props.placeholder,"p-dropdown-label-empty":null===i&&!this.props.placeholder}),o=this.props.valueTemplate?_ObjectUtils.default.getJSXElement(this.props.valueTemplate,e,this.props):i||this.props.placeholder||"empty";return _react.default.createElement("span",{ref:function(e){return t.input=e},className:r},o)}},{key:"renderClearIcon",value:function(){return null!=this.props.value&&this.props.showClear&&!this.props.disabled?_react.default.createElement("i",{className:"p-dropdown-clear-icon pi pi-times",onClick:this.clear}):null}},{key:"renderDropdownIcon",value:function(){var t=this;return _react.default.createElement("div",{ref:function(e){return t.trigger=e},className:"p-dropdown-trigger",role:"button","aria-haspopup":"listbox","aria-expanded":this.state.overlayVisible},_react.default.createElement("span",{className:"p-dropdown-trigger-icon pi pi-chevron-down p-clickable"}))}},{key:"renderItems",value:function(r){var o=this,e=this.getVisibleOptions();if(e&&e.length)return e.map(function(e,t){var i=o.getOptionLabel(e),n=o.getOptionKey(e,t);return _react.default.createElement(_DropdownItem.DropdownItem,{key:n,label:i,option:e,template:o.props.itemTemplate,selected:r===e,disabled:e.disabled,onClick:o.onOptionClick})});if(this.hasFilter()){var t=_ObjectUtils.default.getJSXElement(this.props.emptyFilterMessage,this.props);return _react.default.createElement("li",{className:"p-dropdown-empty-message"},t)}return null}},{key:"renderFilter",value:function(){var t=this;return this.props.filter?_react.default.createElement("div",{className:"p-dropdown-header"},_react.default.createElement("div",{className:"p-dropdown-filter-container"},_react.default.createElement("input",{ref:function(e){return t.filterInput=e},type:"text",autoComplete:"off",className:"p-dropdown-filter p-inputtext p-component",placeholder:this.props.filterPlaceholder,onKeyDown:this.onFilterInputKeyDown,onChange:this.onFilterInputChange,value:this.state.filter}),_react.default.createElement("span",{className:"p-dropdown-filter-icon pi pi-search"}))):null}},{key:"render",value:function(){var t=this,e=(0,_classnames.default)("p-dropdown p-component p-inputwrapper",this.props.className,{"p-disabled":this.props.disabled,"p-focus":this.state.focused,"p-dropdown-clearable":this.props.showClear&&!this.props.disabled,"p-inputwrapper-filled":this.props.value,"p-inputwrapper-focus":this.state.focused}),i=this.findOption(this.props.value),n=this.renderHiddenSelect(i),r=this.renderKeyboardHelper(),o=this.renderLabel(i),l=this.renderDropdownIcon(),s=this.renderItems(i),a=this.renderFilter(),p=this.renderClearIcon();return _react.default.createElement("div",{id:this.id,ref:function(e){return t.container=e},className:e,style:this.props.style,onClick:this.onClick,onMouseDown:this.props.onMouseDown,onContextMenu:this.props.onContextMenu},r,n,o,p,l,_react.default.createElement(_reactTransitionGroup.CSSTransition,{classNames:"p-connected-overlay",in:this.state.overlayVisible,timeout:{enter:120,exit:100},unmountOnExit:!0,onEnter:this.onOverlayEnter,onEntered:this.onOverlayEntered,onExit:this.onOverlayExit,onExited:this.onOverlayExited},_react.default.createElement(_DropdownPanel.DropdownPanel,{ref:function(e){return t.panel=e},appendTo:this.props.appendTo,panelStyle:this.props.panelStyle,panelClassName:this.props.panelClassName,scrollHeight:this.props.scrollHeight,filter:a,onClick:this.onPanelClick},s)))}}]),n}();_defineProperty(exports.Dropdown=Dropdown,"defaultProps",{id:null,name:null,value:null,options:null,optionLabel:null,optionValue:null,valueTemplate:null,itemTemplate:null,style:null,className:null,scrollHeight:"200px",filter:!1,filterBy:null,filterMatchMode:"contains",filterPlaceholder:null,filterLocale:void 0,emptyFilterMessage:"No results found",editable:!1,placeholder:null,required:!1,disabled:!1,appendTo:null,tabIndex:null,autoFocus:!1,filterInputAutoFocus:!0,resetFilterOnHide:!1,panelClassName:null,panelStyle:null,dataKey:null,inputId:null,showClear:!1,maxLength:null,tooltip:null,tooltipOptions:null,ariaLabel:null,ariaLabelledBy:null,onChange:null,onFocus:null,onBlur:null,onMouseDown:null,onContextMenu:null}),_defineProperty(Dropdown,"propTypes",{id:_propTypes.default.string,name:_propTypes.default.string,value:_propTypes.default.any,options:_propTypes.default.array,optionLabel:_propTypes.default.string,optionValue:_propTypes.default.string,valueTemplate:_propTypes.default.any,itemTemplate:_propTypes.default.any,style:_propTypes.default.object,className:_propTypes.default.string,scrollHeight:_propTypes.default.string,filter:_propTypes.default.bool,filterBy:_propTypes.default.string,filterMatchMode:_propTypes.default.string,filterPlaceholder:_propTypes.default.string,filterLocale:_propTypes.default.string,emptyFilterMessage:_propTypes.default.any,editable:_propTypes.default.bool,placeholder:_propTypes.default.string,required:_propTypes.default.bool,disabled:_propTypes.default.bool,appendTo:_propTypes.default.any,tabIndex:_propTypes.default.number,autoFocus:_propTypes.default.bool,filterInputAutoFocus:_propTypes.default.bool,resetFilterOnHide:_propTypes.default.bool,lazy:_propTypes.default.bool,panelClassName:_propTypes.default.string,panelStyle:_propTypes.default.object,dataKey:_propTypes.default.string,inputId:_propTypes.default.string,showClear:_propTypes.default.bool,maxLength:_propTypes.default.number,tooltip:_propTypes.default.string,tooltipOptions:_propTypes.default.object,ariaLabel:_propTypes.default.string,ariaLabelledBy:_propTypes.default.string,onChange:_propTypes.default.func,onFocus:_propTypes.default.func,onBlur:_propTypes.default.func,onMouseDown:_propTypes.default.func,onContextMenu:_propTypes.default.func});