const EventEmitter=require("events"),ZXing=require("./zxing")(),Visibility=require("visibilityjs"),StateMachine=require("fsm-as-promised");class ActiveScan{constructor(t,e,s,i,a){this.active=!1,this.scanPeriod=i,this.frameCount=0,this.emitter=t,this.analyzer=e,this.captureImage=s,this.refractoryPeriod=a}start(){this.active=!0,requestAnimationFrame(()=>this._scan())}stop(){this.active=!1}_scan(){if(!this.active)return;if(requestAnimationFrame(()=>this._scan()),++this.frameCount!==this.scanPeriod)return;this.frameCount=0;let t=this.analyzer.analyze();if(!t)return;let{result:e,canvas:s}=t;if(!e||e===this.lastResult)return;clearTimeout(this.refractoryTimeout),this.refractoryTimeout=setTimeout(()=>{this.lastResult=null},this.refractoryPeriod);let i=this.captureImage?s.toDataURL("image/webp",.8):null;this.lastResult=e,setTimeout(()=>{this.emitter.emit("scan",e,i)},0)}}class Analyzer{constructor(t){this.video=t,this.imageBuffer=null,this.sensorLeft=null,this.sensorTop=null,this.sensorWidth=null,this.sensorHeight=null,this.canvas=document.createElement("canvas"),this.canvas.style.display="none",this.canvasContext=null,this.decodeCallback=ZXing.Runtime.addFunction(function(t,e,s,i){var a=new Uint8Array(ZXing.HEAPU8.buffer,t,e),r=String.fromCharCode.apply(null,a);0===s&&(window.zxDecodeResult=""),window.zxDecodeResult+=r})}analyze(){if(!this.video.videoWidth)return null;if(!this.imageBuffer){let t=this.video.videoWidth,e=this.video.videoHeight;return this.sensorWidth=t,this.sensorHeight=e,this.sensorLeft=Math.floor(t/2-this.sensorWidth/2),this.sensorTop=Math.floor(e/2-this.sensorHeight/2),this.canvas.width=this.sensorWidth,this.canvas.height=this.sensorHeight,this.canvasContext=this.canvas.getContext("2d"),this.imageBuffer=ZXing._resize(this.sensorWidth,this.sensorHeight),null}this.canvasContext.drawImage(this.video,this.sensorLeft,this.sensorTop,this.sensorWidth,this.sensorHeight);let t=this.canvasContext.getImageData(0,0,this.sensorWidth,this.sensorHeight).data;for(var e=0,s=0;e<t.length;e+=4,s++)ZXing.HEAPU8[this.imageBuffer+s]=t[e];if(ZXing._decode_qr(this.decodeCallback))return null;let i=window.zxDecodeResult;return null!=i?{result:i,canvas:this.canvas}:null}}class Scanner extends EventEmitter{constructor(t){super(),this._scan=null,this._camera=null,this.scanPeriod=t.scanPeriod||1,this.refractoryPeriod=t.refractoryPeriod||5e3,this.captureImage=t.captureImage||!1,this.backgroundScan=t.backgroundScan||!1,this.video=this._configureVideo(t),this.analyzer=new Analyzer(this.video),Visibility.change((t,e)=>{"visible"===e?setTimeout(()=>{this._fsm.can("activate")&&this._fsm.activate()},0):!this.backgroundScan&&this._fsm.can("deactivate")&&this._fsm.deactivate()}),this._fsm=StateMachine.create({initial:"stopped",events:[{name:"start",from:"stopped",to:"started"},{name:"stop",from:["started","active","inactive"],to:"stopped"},{name:"activate",from:["started","inactive"],to:"active"},{name:"deactivate",from:["started","active"],to:"inactive"}],callbacks:{onleaveactive:()=>{this._disableScan(),this.emit("inactive")},onenteractive:async t=>!("visible"!==Visibility.state()&&!this.backgroundScan)&&await this._enableScan(t.args[0]),onenteredstarted:async t=>{await this._fsm.activate(t.args[0])}}}),this.emit("inactive")}async start(t=null){this._fsm.can("start")?await this._fsm.start(t):(await this._fsm.stop(),await this._fsm.start(t))}stop(){this._fsm.can("stop")&&this._fsm.stop()}set camera(t){"stopped"===this._fsm.current||"inactive"===this._fsm.current?this._camera=t:(this._fsm.stop(),this._fsm.start(t))}async _enableScan(t){if(this._camera=t||this._camera,!this._camera)throw new Exception("Camera is not defined.");let e=await this._camera.start();this.video.src=e,this._scan=new ActiveScan(this,this.analyzer,this.captureImage,this.scanPeriod,this.refractoryPeriod),this._scan.start(),this.emit("active")}_disableScan(){this.video.src="",this._scan&&(this._scan.stop(),this._scan=null),this._camera&&this._camera.stop()}_configureVideo(t){if(t.video&&"VIDEO"!==t.video.tagName)throw new Exception("Video must be a <video> element.");var e=t.video||document.createElement("video");return e.setAttribute("autoplay","autoplay"),!1!==t.mirror&&t.video&&(e.style.MozTransform="scaleX(-1)",e.style.webkitTransform="scaleX(-1)",e.style.OTransform="scaleX(-1)",e.style.msFilter="FlipH",e.style.filter="FlipH",e.style.transform="scaleX(-1)"),e}}module.exports=Scanner;