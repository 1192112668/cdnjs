const EventEmitter=require("events"),ZXing=require("./zxing")(),Visibility=require("visibilityjs");class ActiveScan{constructor(t,e,i,s,a){this.active=!1,this.scanPeriod=s,this.frameCount=0,this.emitter=t,this.analyzer=e,this.captureImage=i,this.refractoryPeriod=a,this.start()}start(){this.active=!0,requestAnimationFrame(()=>this.scan())}stop(){this.active=!1}scan(){this.active&&(requestAnimationFrame(()=>this.scan()),++this.frameCount===this.scanPeriod&&(this.frameCount=0,this.analyzer.analyze((t,e)=>{if(t===this.lastResult)return;clearTimeout(this.refractoryTimeout),this.refractoryTimeout=setTimeout(()=>{this.lastResult=null},this.refractoryPeriod);let i=this.captureImage?e.toDataURL("image/webp",.8):null;this.lastResult=t,setTimeout(()=>{this.emitter.emit("scan",t,i)},0)})))}}class Analyzer{constructor(t){this.videoElement=t,this.imageBuffer=null,this.sensorLeft=null,this.sensorTop=null,this.sensorWidth=null,this.sensorHeight=null,this.canvas=document.createElement("canvas"),this.canvas.style.display="none",this.canvasContext=null,this.decodeCallback=ZXing.Runtime.addFunction(function(t,e,i,s){var a=new Uint8Array(ZXing.HEAPU8.buffer,t,e),n=String.fromCharCode.apply(null,a);0===i&&(window.zxDecodeResult=""),window.zxDecodeResult+=n})}analyze(t){if(!this.videoElement.videoWidth)return;if(!this.imageBuffer){let t=this.videoElement.videoWidth,e=this.videoElement.videoHeight;return this.sensorWidth=t,this.sensorHeight=e,this.sensorLeft=Math.floor(t/2-this.sensorWidth/2),this.sensorTop=Math.floor(e/2-this.sensorHeight/2),this.canvas.width=this.sensorWidth,this.canvas.height=this.sensorHeight,this.canvasContext=this.canvas.getContext("2d"),void(this.imageBuffer=ZXing._resize(this.sensorWidth,this.sensorHeight))}this.canvasContext.drawImage(this.videoElement,this.sensorLeft,this.sensorTop,this.sensorWidth,this.sensorHeight);let e=this.canvasContext.getImageData(0,0,this.sensorWidth,this.sensorHeight).data;for(var i=0,s=0;i<e.length;i+=4,s++)ZXing.HEAPU8[this.imageBuffer+s]=e[i];if(ZXing._decode_qr(this.decodeCallback))return;let a=window.zxDecodeResult;null!=a&&t(a,this.canvas)}}class Scanner extends EventEmitter{constructor(t){if(super(),this.activeScan=null,this.camera=null,this.scanPeriod=t.scanPeriod||1,this.refractoryPeriod=t.refractoryPeriod||5e3,this.captureImage=t.captureImage||!1,this.backgroundScan=t.backgroundScan||!1,t.monitor&&"VIDEO"!==t.monitor.tagName)throw new Exception("Monitor must be a <video> element.");this.videoElement=t.monitor||document.createElement("video"),this.videoElement.setAttribute("autoplay","autoplay"),!1!==t.mirror&&(this.videoElement.style.MozTransform="scaleX(-1)",this.videoElement.style.webkitTransform="scaleX(-1)",this.videoElement.style.OTransform="scaleX(-1)",this.videoElement.style.msFilter="FlipH",this.videoElement.style.filter="FlipH",this.videoElement.style.transform="scaleX(-1)"),this.analyzer=new Analyzer(this.videoElement),Visibility.change((t,e)=>{this.backgroundScan||("visible"===e?setTimeout(()=>this.start(this.camera),0):this.stop())})}start(t){this.stop(),this.camera=t,this.camera.start((t,e)=>{t?this.emit("error",t):(this.videoElement.src=e,this.activeScan=new ActiveScan(this,this.analyzer,this.captureImage,this.scanPeriod,this.refractoryPeriod),this.emit("active"))})}stop(){this.videoElement.src="",this.activeScan&&(this.activeScan.stop(),this.activeScan=null,this.emit("inactive")),this.camera&&this.camera.stop()}}module.exports=Scanner;