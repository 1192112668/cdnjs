!function(e,a){"function"==typeof define&&define.amd?define(["./core"],a):"object"==typeof exports?module.exports=a(require("./core")):e.Blockly.Lua=a(e.Blockly)}(this,function(l){"use strict";return l.Lua=new l.Generator("Lua"),l.Lua.addReservedWords("_,__inext,assert,bit,colors,colours,coroutine,disk,dofile,error,fs,fetfenv,getmetatable,gps,help,io,ipairs,keys,loadfile,loadstring,math,native,next,os,paintutils,pairs,parallel,pcall,peripheral,print,printError,rawequal,rawget,rawset,read,rednet,redstone,rs,select,setfenv,setmetatable,sleep,string,table,term,textutils,tonumber,tostring,turtle,type,unpack,vector,write,xpcall,_VERSION,__indext,HTTP,and,break,do,else,elseif,end,false,for,function,if,in,local,nil,not,or,repeat,return,then,true,until,while,add,sub,mul,div,mod,pow,unm,concat,len,eq,lt,le,index,newindex,call,assert,collectgarbage,dofile,error,_G,getmetatable,inpairs,load,loadfile,next,pairs,pcall,print,rawequal,rawget,rawlen,rawset,select,setmetatable,tonumber,tostring,type,_VERSION,xpcall,require,package,string,table,math,bit32,io,file,os,debug"),l.Lua.ORDER_ATOMIC=0,l.Lua.ORDER_HIGH=1,l.Lua.ORDER_EXPONENTIATION=2,l.Lua.ORDER_UNARY=3,l.Lua.ORDER_MULTIPLICATIVE=4,l.Lua.ORDER_ADDITIVE=5,l.Lua.ORDER_CONCATENATION=6,l.Lua.ORDER_RELATIONAL=7,l.Lua.ORDER_AND=8,l.Lua.ORDER_OR=9,l.Lua.ORDER_NONE=99,l.Lua.init=function(e){l.Lua.definitions_=Object.create(null),l.Lua.functionNames_=Object.create(null),l.Lua.variableDB_?l.Lua.variableDB_.reset():l.Lua.variableDB_=new l.Names(l.Lua.RESERVED_WORDS_),l.Lua.variableDB_.setVariableMap(e.getVariableMap())},l.Lua.finish=function(e){var a,t=[];for(a in l.Lua.definitions_)t.push(l.Lua.definitions_[a]);return delete l.Lua.definitions_,delete l.Lua.functionNames_,l.Lua.variableDB_.reset(),t.join("\n\n")+"\n\n\n"+e},l.Lua.scrubNakedValue=function(e){return"local _ = "+e+"\n"},l.Lua.quote_=function(e){return"'"+(e=e.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/'/g,"\\'"))+"'"},l.Lua.multiline_quote_=function(e){return"[==="+(e=e.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/'/g,"\\'"))+"===]"},l.Lua.scrub_=function(e,a,t){var u="";if(!e.outputConnection||!e.outputConnection.targetConnection){var n=e.getCommentText();n&&(n=l.utils.string.wrap(n,l.Lua.COMMENT_WRAP-3),u+=l.Lua.prefixLines(n,"-- ")+"\n");for(var r=0;r<e.inputList.length;r++)e.inputList[r].type==l.INPUT_VALUE&&(n=e.inputList[r].connection.targetBlock())&&(n=l.Lua.allNestedComments(n))&&(u+=l.Lua.prefixLines(n,"-- "))}return e=e.nextConnection&&e.nextConnection.targetBlock(),u+a+(t=t?"":l.Lua.blockToCode(e))},l.Lua.colour={},l.Lua.colour_picker=function(e){return[l.Lua.quote_(e.getFieldValue("COLOUR")),l.Lua.ORDER_ATOMIC]},l.Lua.colour_random=function(e){return['string.format("#%06x", math.random(0, 2^24 - 1))',l.Lua.ORDER_HIGH]},l.Lua.colour_rgb=function(e){return[l.Lua.provideFunction_("colour_rgb",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(r, g, b)","  r = math.floor(math.min(100, math.max(0, r)) * 2.55 + .5)","  g = math.floor(math.min(100, math.max(0, g)) * 2.55 + .5)","  b = math.floor(math.min(100, math.max(0, b)) * 2.55 + .5)",'  return string.format("#%02x%02x%02x", r, g, b)',"end"])+"("+(l.Lua.valueToCode(e,"RED",l.Lua.ORDER_NONE)||0)+", "+(l.Lua.valueToCode(e,"GREEN",l.Lua.ORDER_NONE)||0)+", "+(e=l.Lua.valueToCode(e,"BLUE",l.Lua.ORDER_NONE)||0)+")",l.Lua.ORDER_HIGH]},l.Lua.colour_blend=function(e){return[l.Lua.provideFunction_("colour_blend",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(colour1, colour2, ratio)","  local r1 = tonumber(string.sub(colour1, 2, 3), 16)","  local r2 = tonumber(string.sub(colour2, 2, 3), 16)","  local g1 = tonumber(string.sub(colour1, 4, 5), 16)","  local g2 = tonumber(string.sub(colour2, 4, 5), 16)","  local b1 = tonumber(string.sub(colour1, 6, 7), 16)","  local b2 = tonumber(string.sub(colour2, 6, 7), 16)","  local ratio = math.min(1, math.max(0, ratio))","  local r = math.floor(r1 * (1 - ratio) + r2 * ratio + .5)","  local g = math.floor(g1 * (1 - ratio) + g2 * ratio + .5)","  local b = math.floor(b1 * (1 - ratio) + b2 * ratio + .5)",'  return string.format("#%02x%02x%02x", r, g, b)',"end"])+"("+(l.Lua.valueToCode(e,"COLOUR1",l.Lua.ORDER_NONE)||"'#000000'")+", "+(l.Lua.valueToCode(e,"COLOUR2",l.Lua.ORDER_NONE)||"'#000000'")+", "+(e=l.Lua.valueToCode(e,"RATIO",l.Lua.ORDER_NONE)||0)+")",l.Lua.ORDER_HIGH]},l.Lua.lists={},l.Lua.lists_create_empty=function(e){return["{}",l.Lua.ORDER_ATOMIC]},l.Lua.lists_create_with=function(e){for(var a=Array(e.itemCount_),t=0;t<e.itemCount_;t++)a[t]=l.Lua.valueToCode(e,"ADD"+t,l.Lua.ORDER_NONE)||"None";return["{"+a.join(", ")+"}",l.Lua.ORDER_ATOMIC]},l.Lua.lists_repeat=function(e){return[l.Lua.provideFunction_("create_list_repeated",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(item, count)","  local t = {}","  for i = 1, count do","    table.insert(t, item)","  end","  return t","end"])+"("+(l.Lua.valueToCode(e,"ITEM",l.Lua.ORDER_NONE)||"None")+", "+(e=l.Lua.valueToCode(e,"NUM",l.Lua.ORDER_NONE)||"0")+")",l.Lua.ORDER_HIGH]},l.Lua.lists_length=function(e){return["#"+(l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_UNARY)||"{}"),l.Lua.ORDER_UNARY]},l.Lua.lists_isEmpty=function(e){return["#"+(l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_UNARY)||"{}")+" == 0",l.Lua.ORDER_RELATIONAL]},l.Lua.lists_indexOf=function(e){var a=l.Lua.valueToCode(e,"FIND",l.Lua.ORDER_NONE)||"''",t=l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_NONE)||"{}";return[("FIRST"==e.getFieldValue("END")?l.Lua.provideFunction_("first_index",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t, elem)","  for k, v in ipairs(t) do","    if v == elem then","      return k","    end","  end","  return 0","end"]):l.Lua.provideFunction_("last_index",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t, elem)","  for i = #t, 1, -1 do","    if t[i] == elem then","      return i","    end","  end","  return 0","end"]))+"("+t+", "+a+")",l.Lua.ORDER_HIGH]},l.Lua.lists.getIndex_=function(e,a,t){return"FIRST"==a?"1":"FROM_END"==a?"#"+e+" + 1 - "+t:"LAST"==a?"#"+e:"RANDOM"==a?"math.random(#"+e+")":t},l.Lua.lists_getIndex=function(e){var a=e.getFieldValue("MODE")||"GET",t=e.getFieldValue("WHERE")||"FROM_START",u=l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_HIGH)||"{}",n=l.Lua.lists.getIndex_;if("LAST"!=t&&"FROM_END"!=t&&"RANDOM"!=t||u.match(/^\w+$/))return r="GET"==a&&"FROM_END"==t?l.Lua.ORDER_ADDITIVE:l.Lua.ORDER_NONE,e=n(u,t,e=l.Lua.valueToCode(e,"AT",r)||"1"),"GET"==a?[u+"["+e+"]",l.Lua.ORDER_HIGH]:(t="table.remove("+u+", "+e+")","GET_REMOVE"==a?[t,l.Lua.ORDER_HIGH]:t+"\n");if("REMOVE"!=a)return e=l.Lua.valueToCode(e,"AT",l.Lua.ORDER_NONE)||"1",[("GET"==a?l.Lua.provideFunction_("list_get_"+t.toLowerCase(),["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t"+("FROM_END"==t||"FROM_START"==t?", at)":")"),"  return t["+n("t",t,"at")+"]","end"]):l.Lua.provideFunction_("list_remove_"+t.toLowerCase(),["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t"+("FROM_END"==t||"FROM_START"==t?", at)":")"),"  return table.remove(t, "+n("t",t,"at")+")","end"]))+"("+u+("FROM_END"==t||"FROM_START"==t?", "+e:"")+")",l.Lua.ORDER_HIGH];var r="FROM_END"==t?l.Lua.ORDER_ADDITIVE:l.Lua.ORDER_NONE;return e=l.Lua.valueToCode(e,"AT",r)||"1",(a=l.Lua.variableDB_.getDistinctName("tmp_list",l.Variables.NAME_TYPE))+" = "+u+"\ntable.remove("+a+", "+(e=n(a,t,e))+")\n"},l.Lua.lists_setIndex=function(e){var a=l.Lua.valueToCode(e,"LIST",l.Lua.ORDER_HIGH)||"{}",t=e.getFieldValue("MODE")||"SET",u=e.getFieldValue("WHERE")||"FROM_START",n=l.Lua.valueToCode(e,"AT",l.Lua.ORDER_ADDITIVE)||"1";e=l.Lua.valueToCode(e,"TO",l.Lua.ORDER_NONE)||"None";var r,o=l.Lua.lists.getIndex_,i="";return"LAST"!=u&&"FROM_END"!=u&&"RANDOM"!=u||a.match(/^\w+$/)||(i=(r=l.Lua.variableDB_.getDistinctName("tmp_list",l.Variables.NAME_TYPE))+" = "+a+"\n",a=r),(i="SET"==t?i+(a+"["+o(a,u,n))+"] = "+e:i+("table.insert("+a+", "+o(a,u,n))+("LAST"==u?" + 1":"")+", "+e+")")+"\n"},l.Lua.lists_getSublist=function(e){var a=l.Lua.valueToCode(e,"LIST",l.Lua.ORDER_NONE)||"{}",t=e.getFieldValue("WHERE1"),u=e.getFieldValue("WHERE2"),n=l.Lua.valueToCode(e,"AT1",l.Lua.ORDER_NONE)||"1";e=l.Lua.valueToCode(e,"AT2",l.Lua.ORDER_NONE)||"1";var r=l.Lua.lists.getIndex_;return[l.Lua.provideFunction_("list_sublist_"+t.toLowerCase()+"_"+u.toLowerCase(),["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(source"+("FROM_END"==t||"FROM_START"==t?", at1":"")+("FROM_END"==u||"FROM_START"==u?", at2":"")+")","  local t = {}","  local start = "+r("source",t,"at1"),"  local finish = "+r("source",u,"at2"),"  for i = start, finish do","    table.insert(t, source[i])","  end","  return t","end"])+"("+a+("FROM_END"==t||"FROM_START"==t?", "+n:"")+("FROM_END"==u||"FROM_START"==u?", "+e:"")+")",l.Lua.ORDER_HIGH]},l.Lua.lists_sort=function(e){var a=l.Lua.valueToCode(e,"LIST",l.Lua.ORDER_NONE)||"{}",t="1"===e.getFieldValue("DIRECTION")?1:-1;return e=e.getFieldValue("TYPE"),[l.Lua.provideFunction_("list_sort",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(list, typev, direction)","  local t = {}","  for n,v in pairs(list) do table.insert(t, v) end","  local compareFuncs = {","    NUMERIC = function(a, b)","      return (tonumber(tostring(a)) or 0)","          < (tonumber(tostring(b)) or 0) end,","    TEXT = function(a, b)","      return tostring(a) < tostring(b) end,","    IGNORE_CASE = function(a, b)","      return string.lower(tostring(a)) < string.lower(tostring(b)) end","  }","  local compareTemp = compareFuncs[typev]","  local compare = compareTemp","  if direction == -1","  then compare = function(a, b) return compareTemp(b, a) end","  end","  table.sort(t, compare)","  return t","end"])+"("+a+',"'+e+'", '+t+")",l.Lua.ORDER_HIGH]},l.Lua.lists_split=function(e){var a=l.Lua.valueToCode(e,"INPUT",l.Lua.ORDER_NONE),t=l.Lua.valueToCode(e,"DELIM",l.Lua.ORDER_NONE)||"''";if("SPLIT"==(e=e.getFieldValue("MODE")))a=a||"''",e=l.Lua.provideFunction_("list_string_split",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(input, delim)","  local t = {}","  local pos = 1","  while true do","    next_delim = string.find(input, delim, pos)","    if next_delim == nil then","      table.insert(t, string.sub(input, pos))","      break","    else","      table.insert(t, string.sub(input, pos, next_delim-1))","      pos = next_delim + #delim","    end","  end","  return t","end"]);else{if("JOIN"!=e)throw Error("Unknown mode: "+e);a=a||"{}",e="table.concat"}return[e+"("+a+", "+t+")",l.Lua.ORDER_HIGH]},l.Lua.lists_reverse=function(e){return e=l.Lua.valueToCode(e,"LIST",l.Lua.ORDER_NONE)||"{}",l.Lua.provideFunction_("list_reverse",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(input)","  local reversed = {}","  for i = #input, 1, -1 do","    table.insert(reversed, input[i])","  end","  return reversed","end"]),["list_reverse("+e+")",l.Lua.ORDER_HIGH]},l.Lua.logic={},l.Lua.controls_if=function(e){var a=0,t="";l.Lua.STATEMENT_PREFIX&&(t+=l.Lua.injectId(l.Lua.STATEMENT_PREFIX,e));do{var u=l.Lua.valueToCode(e,"IF"+a,l.Lua.ORDER_NONE)||"false",n=l.Lua.statementToCode(e,"DO"+a);l.Lua.STATEMENT_SUFFIX&&(n=l.Lua.prefixLines(l.Lua.injectId(l.Lua.STATEMENT_SUFFIX,e),l.Lua.INDENT)+n),t+=(0<a?"else":"")+"if "+u+" then\n"+n,++a}while(e.getInput("IF"+a));return(e.getInput("ELSE")||l.Lua.STATEMENT_SUFFIX)&&(n=l.Lua.statementToCode(e,"ELSE"),l.Lua.STATEMENT_SUFFIX&&(n=l.Lua.prefixLines(l.Lua.injectId(l.Lua.STATEMENT_SUFFIX,e),l.Lua.INDENT)+n),t+="else\n"+n),t+"end\n"},l.Lua.controls_ifelse=l.Lua.controls_if,l.Lua.logic_compare=function(e){var a={EQ:"==",NEQ:"~=",LT:"<",LTE:"<=",GT:">",GTE:">="}[e.getFieldValue("OP")];return[(l.Lua.valueToCode(e,"A",l.Lua.ORDER_RELATIONAL)||"0")+" "+a+" "+(e=l.Lua.valueToCode(e,"B",l.Lua.ORDER_RELATIONAL)||"0"),l.Lua.ORDER_RELATIONAL]},l.Lua.logic_operation=function(e){var a,t="AND"==e.getFieldValue("OP")?"and":"or",u="and"==t?l.Lua.ORDER_AND:l.Lua.ORDER_OR,n=l.Lua.valueToCode(e,"A",u);return e=l.Lua.valueToCode(e,"B",u),e=n||e?(a="and"==t?"true":"false",n=n||a,e||a):n="false",[n+" "+t+" "+e,u]},l.Lua.logic_negate=function(e){return["not "+(l.Lua.valueToCode(e,"BOOL",l.Lua.ORDER_UNARY)||"true"),l.Lua.ORDER_UNARY]},l.Lua.logic_boolean=function(e){return["TRUE"==e.getFieldValue("BOOL")?"true":"false",l.Lua.ORDER_ATOMIC]},l.Lua.logic_null=function(e){return["nil",l.Lua.ORDER_ATOMIC]},l.Lua.logic_ternary=function(e){return[(l.Lua.valueToCode(e,"IF",l.Lua.ORDER_AND)||"false")+" and "+(l.Lua.valueToCode(e,"THEN",l.Lua.ORDER_AND)||"nil")+" or "+(e=l.Lua.valueToCode(e,"ELSE",l.Lua.ORDER_OR)||"nil"),l.Lua.ORDER_OR]},l.Lua.loops={},l.Lua.CONTINUE_STATEMENT="goto continue\n",l.Lua.addContinueLabel_=function(e){return-1!=e.indexOf(l.Lua.CONTINUE_STATEMENT)?e+l.Lua.INDENT+"::continue::\n":e},l.Lua.controls_repeat_ext=function(e){var a=e.getField("TIMES")?String(Number(e.getFieldValue("TIMES"))):l.Lua.valueToCode(e,"TIMES",l.Lua.ORDER_NONE)||"0",a=l.isNumber(a)?parseInt(a,10):"math.floor("+a+")",t=l.Lua.statementToCode(e,"DO"),t=l.Lua.addLoopTrap(t,e);return t=l.Lua.addContinueLabel_(t),"for "+l.Lua.variableDB_.getDistinctName("count",l.Variables.NAME_TYPE)+" = 1, "+a+" do\n"+t+"end\n"},l.Lua.controls_repeat=l.Lua.controls_repeat_ext,l.Lua.controls_whileUntil=function(e){var a="UNTIL"==e.getFieldValue("MODE"),t=l.Lua.valueToCode(e,"BOOL",a?l.Lua.ORDER_UNARY:l.Lua.ORDER_NONE)||"false",u=l.Lua.statementToCode(e,"DO"),u=l.Lua.addLoopTrap(u,e);return a&&(t="not "+t),"while "+t+" do\n"+(u=l.Lua.addContinueLabel_(u))+"end\n"},l.Lua.controls_for=function(e){var a,t=l.Lua.variableDB_.getName(e.getFieldValue("VAR"),l.Variables.NAME_TYPE),u=l.Lua.valueToCode(e,"FROM",l.Lua.ORDER_NONE)||"0",n=l.Lua.valueToCode(e,"TO",l.Lua.ORDER_NONE)||"0",r=l.Lua.valueToCode(e,"BY",l.Lua.ORDER_NONE)||"1",o=l.Lua.statementToCode(e,"DO"),o=l.Lua.addLoopTrap(o,e);return o=l.Lua.addContinueLabel_(o),e="",l.isNumber(u)&&l.isNumber(n)&&l.isNumber(r)?a=(Number(u)<=Number(n)?"":"-")+Math.abs(Number(r)):(e="",e+=(a=l.Lua.variableDB_.getDistinctName(t+"_inc",l.Variables.NAME_TYPE))+" = ",e=(e=l.isNumber(r)?e+(Math.abs(r)+"\n"):e+"math.abs("+r+")\n")+"if ("+u+") > ("+n+") then\n"+(l.Lua.INDENT+a)+" = -"+a+"\n",e+="end\n"),e+"for "+t+" = "+u+", "+n+", "+a+" do\n"+o+"end\n"},l.Lua.controls_forEach=function(e){var a=l.Lua.variableDB_.getName(e.getFieldValue("VAR"),l.Variables.NAME_TYPE),t=l.Lua.valueToCode(e,"LIST",l.Lua.ORDER_NONE)||"{}",u=l.Lua.statementToCode(e,"DO"),u=l.Lua.addLoopTrap(u,e);return"for _, "+a+" in ipairs("+t+") do \n"+(u=l.Lua.addContinueLabel_(u))+"end\n"},l.Lua.controls_flow_statements=function(e){var a,t="";switch(l.Lua.STATEMENT_PREFIX&&(t+=l.Lua.injectId(l.Lua.STATEMENT_PREFIX,e)),l.Lua.STATEMENT_SUFFIX&&(t+=l.Lua.injectId(l.Lua.STATEMENT_SUFFIX,e)),!l.Lua.STATEMENT_PREFIX||(a=l.Constants.Loops.CONTROL_FLOW_IN_LOOP_CHECK_MIXIN.getSurroundLoop(e))&&!a.suppressPrefixSuffix&&(t+=l.Lua.injectId(l.Lua.STATEMENT_PREFIX,a)),e.getFieldValue("FLOW")){case"BREAK":return t+"break\n";case"CONTINUE":return t+l.Lua.CONTINUE_STATEMENT}throw Error("Unknown flow statement.")},l.Lua.math={},l.Lua.math_number=function(e){return[e=Number(e.getFieldValue("NUM")),e<0?l.Lua.ORDER_UNARY:l.Lua.ORDER_ATOMIC]},l.Lua.math_arithmetic=function(e){var a=(t={ADD:[" + ",l.Lua.ORDER_ADDITIVE],MINUS:[" - ",l.Lua.ORDER_ADDITIVE],MULTIPLY:[" * ",l.Lua.ORDER_MULTIPLICATIVE],DIVIDE:[" / ",l.Lua.ORDER_MULTIPLICATIVE],POWER:[" ^ ",l.Lua.ORDER_EXPONENTIATION]}[e.getFieldValue("OP")])[0],t=t[1];return[(l.Lua.valueToCode(e,"A",t)||"0")+a+(e=l.Lua.valueToCode(e,"B",t)||"0"),t]},l.Lua.math_single=function(e){var a=e.getFieldValue("OP");if("NEG"==a)return["-"+(e=l.Lua.valueToCode(e,"NUM",l.Lua.ORDER_UNARY)||"0"),l.Lua.ORDER_UNARY];if("POW10"==a)return["10 ^ "+(e=l.Lua.valueToCode(e,"NUM",l.Lua.ORDER_EXPONENTIATION)||"0"),l.Lua.ORDER_EXPONENTIATION];switch(e="ROUND"==a?l.Lua.valueToCode(e,"NUM",l.Lua.ORDER_ADDITIVE)||"0":l.Lua.valueToCode(e,"NUM",l.Lua.ORDER_NONE)||"0",a){case"ABS":a="math.abs("+e+")";break;case"ROOT":a="math.sqrt("+e+")";break;case"LN":a="math.log("+e+")";break;case"LOG10":a="math.log("+e+", 10)";break;case"EXP":a="math.exp("+e+")";break;case"ROUND":a="math.floor("+e+" + .5)";break;case"ROUNDUP":a="math.ceil("+e+")";break;case"ROUNDDOWN":a="math.floor("+e+")";break;case"SIN":a="math.sin(math.rad("+e+"))";break;case"COS":a="math.cos(math.rad("+e+"))";break;case"TAN":a="math.tan(math.rad("+e+"))";break;case"ASIN":a="math.deg(math.asin("+e+"))";break;case"ACOS":a="math.deg(math.acos("+e+"))";break;case"ATAN":a="math.deg(math.atan("+e+"))";break;default:throw Error("Unknown math operator: "+a)}return[a,l.Lua.ORDER_HIGH]},l.Lua.math_constant=function(e){return{PI:["math.pi",l.Lua.ORDER_HIGH],E:["math.exp(1)",l.Lua.ORDER_HIGH],GOLDEN_RATIO:["(1 + math.sqrt(5)) / 2",l.Lua.ORDER_MULTIPLICATIVE],SQRT2:["math.sqrt(2)",l.Lua.ORDER_HIGH],SQRT1_2:["math.sqrt(1 / 2)",l.Lua.ORDER_HIGH],INFINITY:["math.huge",l.Lua.ORDER_HIGH]}[e.getFieldValue("CONSTANT")]},l.Lua.math_number_property=function(e){var a=l.Lua.valueToCode(e,"NUMBER_TO_CHECK",l.Lua.ORDER_MULTIPLICATIVE)||"0",t=e.getFieldValue("PROPERTY");if("PRIME"==t)return[l.Lua.provideFunction_("math_isPrime",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(n)","  -- https://en.wikipedia.org/wiki/Primality_test#Naive_methods","  if n == 2 or n == 3 then","    return true","  end","  -- False if n is NaN, negative, is 1, or not whole.","  -- And false if n is divisible by 2 or 3.","  if not(n > 1) or n % 1 ~= 0 or n % 2 == 0 or n % 3 == 0 then","    return false","  end","  -- Check all the numbers of form 6k +/- 1, up to sqrt(n).","  for x = 6, math.sqrt(n) + 1.5, 6 do","    if n % (x - 1) == 0 or n % (x + 1) == 0 then","      return false","    end","  end","  return true","end"])+"("+a+")",l.Lua.ORDER_HIGH];switch(t){case"EVEN":var u=a+" % 2 == 0";break;case"ODD":u=a+" % 2 == 1";break;case"WHOLE":u=a+" % 1 == 0";break;case"POSITIVE":u=a+" > 0";break;case"NEGATIVE":u=a+" < 0";break;case"DIVISIBLE_BY":if(!(e=l.Lua.valueToCode(e,"DIVISOR",l.Lua.ORDER_MULTIPLICATIVE))||"0"==e)return["nil",l.Lua.ORDER_ATOMIC];u=a+" % "+e+" == 0"}return[u,l.Lua.ORDER_RELATIONAL]},l.Lua.math_change=function(e){var a=l.Lua.valueToCode(e,"DELTA",l.Lua.ORDER_ADDITIVE)||"0";return(e=l.Lua.variableDB_.getName(e.getFieldValue("VAR"),l.Variables.NAME_TYPE))+" = "+e+" + "+a+"\n"},l.Lua.math_round=l.Lua.math_single,l.Lua.math_trig=l.Lua.math_single,l.Lua.math_on_list=function(e){function a(){return l.Lua.provideFunction_("math_sum",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  local result = 0","  for _, v in ipairs(t) do","    result = result + v","  end","  return result","end"])}var t=e.getFieldValue("OP");switch(e=l.Lua.valueToCode(e,"LIST",l.Lua.ORDER_NONE)||"{}",t){case"SUM":t=a();break;case"MIN":t=l.Lua.provideFunction_("math_min",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  local result = math.huge","  for _, v in ipairs(t) do","    if v < result then","      result = v","    end","  end","  return result","end"]);break;case"AVERAGE":t=l.Lua.provideFunction_("math_average",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  return "+a()+"(t) / #t","end"]);break;case"MAX":t=l.Lua.provideFunction_("math_max",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  local result = -math.huge","  for _, v in ipairs(t) do","    if v > result then","      result = v","    end","  end","  return result","end"]);break;case"MEDIAN":t=l.Lua.provideFunction_("math_median",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  -- Source: http://lua-users.org/wiki/SimpleStats","  if #t == 0 then","    return 0","  end","  local temp={}","  for _, v in ipairs(t) do",'    if type(v) == "number" then',"      table.insert(temp, v)","    end","  end","  table.sort(temp)","  if #temp % 2 == 0 then","    return (temp[#temp/2] + temp[(#temp/2)+1]) / 2","  else","    return temp[math.ceil(#temp/2)]","  end","end"]);break;case"MODE":t=l.Lua.provideFunction_("math_modes",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  -- Source: http://lua-users.org/wiki/SimpleStats","  local counts={}","  for _, v in ipairs(t) do","    if counts[v] == nil then","      counts[v] = 1","    else","      counts[v] = counts[v] + 1","    end","  end","  local biggestCount = 0","  for _, v  in pairs(counts) do","    if v > biggestCount then","      biggestCount = v","    end","  end","  local temp={}","  for k, v in pairs(counts) do","    if v == biggestCount then","      table.insert(temp, k)","    end","  end","  return temp","end"]);break;case"STD_DEV":t=l.Lua.provideFunction_("math_standard_deviation",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  local m","  local vm","  local total = 0","  local count = 0","  local result","  m = #t == 0 and 0 or "+a()+"(t) / #t","  for _, v in ipairs(t) do","    if type(v) == 'number' then","      vm = v - m","      total = total + (vm * vm)","      count = count + 1","    end","  end","  result = math.sqrt(total / (count-1))","  return result","end"]);break;case"RANDOM":t=l.Lua.provideFunction_("math_random_list",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return nil","  end","  return t[math.random(#t)]","end"]);break;default:throw Error("Unknown operator: "+t)}return[t+"("+e+")",l.Lua.ORDER_HIGH]},l.Lua.math_modulo=function(e){return[(l.Lua.valueToCode(e,"DIVIDEND",l.Lua.ORDER_MULTIPLICATIVE)||"0")+" % "+(e=l.Lua.valueToCode(e,"DIVISOR",l.Lua.ORDER_MULTIPLICATIVE)||"0"),l.Lua.ORDER_MULTIPLICATIVE]},l.Lua.math_constrain=function(e){return["math.min(math.max("+(l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_NONE)||"0")+", "+(l.Lua.valueToCode(e,"LOW",l.Lua.ORDER_NONE)||"-math.huge")+"), "+(e=l.Lua.valueToCode(e,"HIGH",l.Lua.ORDER_NONE)||"math.huge")+")",l.Lua.ORDER_HIGH]},l.Lua.math_random_int=function(e){return["math.random("+(l.Lua.valueToCode(e,"FROM",l.Lua.ORDER_NONE)||"0")+", "+(e=l.Lua.valueToCode(e,"TO",l.Lua.ORDER_NONE)||"0")+")",l.Lua.ORDER_HIGH]},l.Lua.math_random_float=function(e){return["math.random()",l.Lua.ORDER_HIGH]},l.Lua.math_atan2=function(e){var a=l.Lua.valueToCode(e,"X",l.Lua.ORDER_NONE)||"0";return["math.deg(math.atan2("+(l.Lua.valueToCode(e,"Y",l.Lua.ORDER_NONE)||"0")+", "+a+"))",l.Lua.ORDER_HIGH]},l.Lua.procedures={},l.Lua.procedures_defreturn=function(e){var a=l.Lua.variableDB_.getName(e.getFieldValue("NAME"),l.Procedures.NAME_TYPE),t="";l.Lua.STATEMENT_PREFIX&&(t+=l.Lua.injectId(l.Lua.STATEMENT_PREFIX,e)),l.Lua.STATEMENT_SUFFIX&&(t+=l.Lua.injectId(l.Lua.STATEMENT_SUFFIX,e)),t=t&&l.Lua.prefixLines(t,l.Lua.INDENT);var u="";l.Lua.INFINITE_LOOP_TRAP&&(u=l.Lua.prefixLines(l.Lua.injectId(l.Lua.INFINITE_LOOP_TRAP,e),l.Lua.INDENT));var n=l.Lua.statementToCode(e,"STACK"),r=l.Lua.valueToCode(e,"RETURN",l.Lua.ORDER_NONE)||"",o=n&&r?t:"";r?r=l.Lua.INDENT+"return "+r+"\n":n=n||"";for(var i=[],L=0;L<e.arguments_.length;L++)i[L]=l.Lua.variableDB_.getName(e.arguments_[L],l.Variables.NAME_TYPE);return t="function "+a+"("+i.join(", ")+")\n"+t+u+n+o+r+"end\n",t=l.Lua.scrub_(e,t),l.Lua.definitions_["%"+a]=t,null},l.Lua.procedures_defnoreturn=l.Lua.procedures_defreturn,l.Lua.procedures_callreturn=function(e){for(var a=l.Lua.variableDB_.getName(e.getFieldValue("NAME"),l.Procedures.NAME_TYPE),t=[],u=0;u<e.arguments_.length;u++)t[u]=l.Lua.valueToCode(e,"ARG"+u,l.Lua.ORDER_NONE)||"nil";return[a+"("+t.join(", ")+")",l.Lua.ORDER_HIGH]},l.Lua.procedures_callnoreturn=function(e){return l.Lua.procedures_callreturn(e)[0]+"\n"},l.Lua.procedures_ifreturn=function(e){var a="if "+(l.Lua.valueToCode(e,"CONDITION",l.Lua.ORDER_NONE)||"false")+" then\n";return l.Lua.STATEMENT_SUFFIX&&(a+=l.Lua.prefixLines(l.Lua.injectId(l.Lua.STATEMENT_SUFFIX,e),l.Lua.INDENT)),e.hasReturnValue_?(e=l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_NONE)||"nil",a+=l.Lua.INDENT+"return "+e+"\n"):a+=l.Lua.INDENT+"return\n",a+"end\n"},l.Lua.texts={},l.Lua.text=function(e){return[l.Lua.quote_(e.getFieldValue("TEXT")),l.Lua.ORDER_ATOMIC]},l.Lua.text_multiline=function(e){return[l.Lua.multiline_quote_(e.getFieldValue("TEXT")),l.Lua.ORDER_ATOMIC]},l.Lua.text_join=function(e){if(0==e.itemCount_)return["''",l.Lua.ORDER_ATOMIC];if(1==e.itemCount_)return["tostring("+(l.Lua.valueToCode(e,"ADD0",l.Lua.ORDER_NONE)||"''")+")",l.Lua.ORDER_HIGH];if(2==e.itemCount_){var a=l.Lua.valueToCode(e,"ADD0",l.Lua.ORDER_CONCATENATION)||"''";return[a+" .. "+(e=l.Lua.valueToCode(e,"ADD1",l.Lua.ORDER_CONCATENATION)||"''"),l.Lua.ORDER_CONCATENATION]}a=[];for(var t=0;t<e.itemCount_;t++)a[t]=l.Lua.valueToCode(e,"ADD"+t,l.Lua.ORDER_NONE)||"''";return[e="table.concat({"+a.join(", ")+"})",l.Lua.ORDER_HIGH]},l.Lua.text_append=function(e){var a=l.Lua.variableDB_.getName(e.getFieldValue("VAR"),l.Variables.NAME_TYPE);return a+" = "+a+" .. "+(e=l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_CONCATENATION)||"''")+"\n"},l.Lua.text_length=function(e){return["#"+(l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_UNARY)||"''"),l.Lua.ORDER_UNARY]},l.Lua.text_isEmpty=function(e){return["#"+(l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_UNARY)||"''")+" == 0",l.Lua.ORDER_RELATIONAL]},l.Lua.text_indexOf=function(e){var a=l.Lua.valueToCode(e,"FIND",l.Lua.ORDER_NONE)||"''",t=l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_NONE)||"''";return[("FIRST"==e.getFieldValue("END")?l.Lua.provideFunction_("firstIndexOf",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr) ","  local i = string.find(str, substr, 1, true)","  if i == nil then","    return 0","  else","    return i","  end","end"]):l.Lua.provideFunction_("lastIndexOf",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr)","  local i = string.find(string.reverse(str), string.reverse(substr), 1, true)","  if i then","    return #str + 2 - i - #substr","  end","  return 0","end"]))+"("+t+", "+a+")",l.Lua.ORDER_HIGH]},l.Lua.text_charAt=function(e){var a=e.getFieldValue("WHERE")||"FROM_START",t=l.Lua.valueToCode(e,"AT","FROM_END"==a?l.Lua.ORDER_UNARY:l.Lua.ORDER_NONE)||"1";if(e=l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_NONE)||"''","RANDOM"==a)e=(a=l.Lua.provideFunction_("text_random_letter",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local index = math.random(string.len(str))","  return string.sub(str, index, index)","end"]))+"("+e+")";else{if("FIRST"==a)t="1";else if("LAST"==a)t="-1";else if("FROM_START"!=a){if("FROM_END"!=a)throw Error("Unhandled option (text_charAt).");t="-"+t}e=t.match(/^-?\w*$/)?"string.sub("+e+", "+t+", "+t+")":(a=l.Lua.provideFunction_("text_char_at",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, index)","  return string.sub(str, index, index)","end"]))+"("+e+", "+t+")"}return[e,l.Lua.ORDER_HIGH]},l.Lua.text_getSubstring=function(e){var a=l.Lua.valueToCode(e,"STRING",l.Lua.ORDER_NONE)||"''",t=e.getFieldValue("WHERE1"),u=l.Lua.valueToCode(e,"AT1","FROM_END"==t?l.Lua.ORDER_UNARY:l.Lua.ORDER_NONE)||"1";if("FIRST"==t)t=1;else if("FROM_START"==t)t=u;else{if("FROM_END"!=t)throw Error("Unhandled option (text_getSubstring)");t="-"+u}if(u=e.getFieldValue("WHERE2"),e=l.Lua.valueToCode(e,"AT2","FROM_END"==u?l.Lua.ORDER_UNARY:l.Lua.ORDER_NONE)||"1","LAST"==u)e=-1;else if("FROM_START"!=u){if("FROM_END"!=u)throw Error("Unhandled option (text_getSubstring)");e="-"+e}return["string.sub("+a+", "+t+", "+e+")",l.Lua.ORDER_HIGH]},l.Lua.text_changeCase=function(e){var a,t=e.getFieldValue("CASE");return e=l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_NONE)||"''","UPPERCASE"==t?a="string.upper":"LOWERCASE"==t?a="string.lower":"TITLECASE"==t&&(a=l.Lua.provideFunction_("text_titlecase",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local buf = {}","  local inWord = false","  for i = 1, #str do","    local c = string.sub(str, i, i)","    if inWord then","      table.insert(buf, string.lower(c))",'      if string.find(c, "%s") then',"        inWord = false","      end","    else","      table.insert(buf, string.upper(c))","      inWord = true","    end","  end","  return table.concat(buf)","end"])),[a+"("+e+")",l.Lua.ORDER_HIGH]},l.Lua.text_trim=function(e){var a={LEFT:"^%s*(,-)",RIGHT:"(.-)%s*$",BOTH:"^%s*(.-)%s*$"}[e.getFieldValue("MODE")];return["string.gsub("+(l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_NONE)||"''")+', "'+a+'", "%1")',l.Lua.ORDER_HIGH]},l.Lua.text_print=function(e){return"print("+(l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_NONE)||"''")+")\n"},l.Lua.text_prompt_ext=function(e){var a=e.getField("TEXT")?l.Lua.quote_(e.getFieldValue("TEXT")):l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_NONE)||"''",a=l.Lua.provideFunction_("text_prompt",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(msg)","  io.write(msg)","  io.flush()","  return io.read()","end"])+"("+a+")";return"NUMBER"==e.getFieldValue("TYPE")&&(a="tonumber("+a+", 10)"),[a,l.Lua.ORDER_HIGH]},l.Lua.text_prompt=l.Lua.text_prompt_ext,l.Lua.text_count=function(e){var a=l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_NONE)||"''";return e=l.Lua.valueToCode(e,"SUB",l.Lua.ORDER_NONE)||"''",[l.Lua.provideFunction_("text_count",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(haystack, needle)","  if #needle == 0 then","    return #haystack + 1","  end","  local i = 1","  local count = 0","  while true do","    i = string.find(haystack, needle, i, true)","    if i == nil then","      break","    end","    count = count + 1","    i = i + #needle","  end","  return count","end"])+"("+a+", "+e+")",l.Lua.ORDER_HIGH]},l.Lua.text_replace=function(e){var a=l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_NONE)||"''",t=l.Lua.valueToCode(e,"FROM",l.Lua.ORDER_NONE)||"''";return e=l.Lua.valueToCode(e,"TO",l.Lua.ORDER_NONE)||"''",[l.Lua.provideFunction_("text_replace",["function "+l.Lua.FUNCTION_NAME_PLACEHOLDER_+"(haystack, needle, replacement)","  local buf = {}","  local i = 1","  while i <= #haystack do","    if string.sub(haystack, i, i + #needle - 1) == needle then","      for j = 1, #replacement do","        table.insert(buf, string.sub(replacement, j, j))","      end","      i = i + #needle","    else","      table.insert(buf, string.sub(haystack, i, i))","      i = i + 1","    end","  end","  return table.concat(buf)","end"])+"("+a+", "+t+", "+e+")",l.Lua.ORDER_HIGH]},l.Lua.text_reverse=function(e){return["string.reverse("+(l.Lua.valueToCode(e,"TEXT",l.Lua.ORDER_HIGH)||"''")+")",l.Lua.ORDER_HIGH]},l.Lua.variables={},l.Lua.variables_get=function(e){return[l.Lua.variableDB_.getName(e.getFieldValue("VAR"),l.Variables.NAME_TYPE),l.Lua.ORDER_ATOMIC]},l.Lua.variables_set=function(e){var a=l.Lua.valueToCode(e,"VALUE",l.Lua.ORDER_NONE)||"0";return l.Lua.variableDB_.getName(e.getFieldValue("VAR"),l.Variables.NAME_TYPE)+" = "+a+"\n"},l.Lua.variablesDynamic={},l.Lua.variables_get_dynamic=l.Lua.variables_get,l.Lua.variables_set_dynamic=l.Lua.variables_set,l.Lua});