"use strict";Blockly.Lua=new Blockly.Generator("Lua"),Blockly.Lua.addReservedWords("_,__inext,assert,bit,colors,colours,coroutine,disk,dofile,error,fs,fetfenv,getmetatable,gps,help,io,ipairs,keys,loadfile,loadstring,math,native,next,os,paintutils,pairs,parallel,pcall,peripheral,print,printError,rawequal,rawget,rawset,read,rednet,redstone,rs,select,setfenv,setmetatable,sleep,string,table,term,textutils,tonumber,tostring,turtle,type,unpack,vector,write,xpcall,_VERSION,__indext,HTTP,and,break,do,else,elseif,end,false,for,function,if,in,local,nil,not,or,repeat,return,then,true,until,while,add,sub,mul,div,mod,pow,unm,concat,len,eq,lt,le,index,newindex,call,assert,collectgarbage,dofile,error,_G,getmetatable,inpairs,load,loadfile,next,pairs,pcall,print,rawequal,rawget,rawlen,rawset,select,setmetatable,tonumber,tostring,type,_VERSION,xpcall,require,package,string,table,math,bit32,io,file,os,debug"),Blockly.Lua.ORDER_ATOMIC=0,Blockly.Lua.ORDER_HIGH=1,Blockly.Lua.ORDER_EXPONENTIATION=2,Blockly.Lua.ORDER_UNARY=3,Blockly.Lua.ORDER_MULTIPLICATIVE=4,Blockly.Lua.ORDER_ADDITIVE=5,Blockly.Lua.ORDER_CONCATENATION=6,Blockly.Lua.ORDER_RELATIONAL=7,Blockly.Lua.ORDER_AND=8,Blockly.Lua.ORDER_OR=9,Blockly.Lua.ORDER_NONE=99,Blockly.Lua.init=function(l){Blockly.Lua.definitions_=Object.create(null),Blockly.Lua.functionNames_=Object.create(null),Blockly.Lua.variableDB_?Blockly.Lua.variableDB_.reset():Blockly.Lua.variableDB_=new Blockly.Names(Blockly.Lua.RESERVED_WORDS_)},Blockly.Lua.finish=function(l){var e,o=[];for(e in Blockly.Lua.definitions_)o.push(Blockly.Lua.definitions_[e]);return delete Blockly.Lua.definitions_,delete Blockly.Lua.functionNames_,Blockly.Lua.variableDB_.reset(),o.join("\n\n")+"\n\n\n"+l},Blockly.Lua.scrubNakedValue=function(l){return"local _ = "+l+"\n"},Blockly.Lua.quote_=function(l){return"'"+(l=l.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/'/g,"\\'"))+"'"},Blockly.Lua.scrub_=function(l,e){var o="";if(!l.outputConnection||!l.outputConnection.targetConnection){var a=l.getCommentText();(a=Blockly.utils.wrap(a,Blockly.Lua.COMMENT_WRAP-3))&&(o+=Blockly.Lua.prefixLines(a,"-- ")+"\n");for(var t=0;t<l.inputList.length;t++)l.inputList[t].type==Blockly.INPUT_VALUE&&(a=l.inputList[t].connection.targetBlock())&&(a=Blockly.Lua.allNestedComments(a))&&(o+=Blockly.Lua.prefixLines(a,"-- "))}return t=l.nextConnection&&l.nextConnection.targetBlock(),o+e+(t=Blockly.Lua.blockToCode(t))},Blockly.Lua.colour={},Blockly.Lua.colour_picker=function(l){return["'"+l.getFieldValue("COLOUR")+"'",Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.colour_random=function(l){return['string.format("#%06x", math.random(0, 2^24 - 1))',Blockly.Lua.ORDER_HIGH]},Blockly.Lua.colour_rgb=function(l){return[Blockly.Lua.provideFunction_("colour_rgb",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(r, g, b)","  r = math.floor(math.min(100, math.max(0, r)) * 2.55 + .5)","  g = math.floor(math.min(100, math.max(0, g)) * 2.55 + .5)","  b = math.floor(math.min(100, math.max(0, b)) * 2.55 + .5)",'  return string.format("#%02x%02x%02x", r, g, b)',"end"])+"("+(Blockly.Lua.valueToCode(l,"RED",Blockly.Lua.ORDER_NONE)||0)+", "+(Blockly.Lua.valueToCode(l,"GREEN",Blockly.Lua.ORDER_NONE)||0)+", "+(l=Blockly.Lua.valueToCode(l,"BLUE",Blockly.Lua.ORDER_NONE)||0)+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.colour_blend=function(l){return[Blockly.Lua.provideFunction_("colour_blend",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(colour1, colour2, ratio)","  local r1 = tonumber(string.sub(colour1, 2, 3), 16)","  local r2 = tonumber(string.sub(colour2, 2, 3), 16)","  local g1 = tonumber(string.sub(colour1, 4, 5), 16)","  local g2 = tonumber(string.sub(colour2, 4, 5), 16)","  local b1 = tonumber(string.sub(colour1, 6, 7), 16)","  local b2 = tonumber(string.sub(colour2, 6, 7), 16)","  local ratio = math.min(1, math.max(0, ratio))","  local r = math.floor(r1 * (1 - ratio) + r2 * ratio + .5)","  local g = math.floor(g1 * (1 - ratio) + g2 * ratio + .5)","  local b = math.floor(b1 * (1 - ratio) + b2 * ratio + .5)",'  return string.format("#%02x%02x%02x", r, g, b)',"end"])+"("+(Blockly.Lua.valueToCode(l,"COLOUR1",Blockly.Lua.ORDER_NONE)||"'#000000'")+", "+(Blockly.Lua.valueToCode(l,"COLOUR2",Blockly.Lua.ORDER_NONE)||"'#000000'")+", "+(l=Blockly.Lua.valueToCode(l,"RATIO",Blockly.Lua.ORDER_NONE)||0)+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.lists={},Blockly.Lua.lists_create_empty=function(l){return["{}",Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.lists_create_with=function(l){for(var e=Array(l.itemCount_),o=0;o<l.itemCount_;o++)e[o]=Blockly.Lua.valueToCode(l,"ADD"+o,Blockly.Lua.ORDER_NONE)||"None";return["{"+e.join(", ")+"}",Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.lists_repeat=function(l){return[Blockly.Lua.provideFunction_("create_list_repeated",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(item, count)","  local t = {}","  for i = 1, count do","    table.insert(t, item)","  end","  return t","end"])+"("+(Blockly.Lua.valueToCode(l,"ITEM",Blockly.Lua.ORDER_NONE)||"None")+", "+(l=Blockly.Lua.valueToCode(l,"NUM",Blockly.Lua.ORDER_NONE)||"0")+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.lists_length=function(l){return["#"+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_UNARY)||"{}"),Blockly.Lua.ORDER_UNARY]},Blockly.Lua.lists_isEmpty=function(l){return["#"+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_UNARY)||"{}")+" == 0",Blockly.Lua.ORDER_RELATIONAL]},Blockly.Lua.lists_indexOf=function(l){var e=Blockly.Lua.valueToCode(l,"FIND",Blockly.Lua.ORDER_NONE)||"''",o=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"{}";return[("FIRST"==l.getFieldValue("END")?Blockly.Lua.provideFunction_("first_index",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t, elem)","  for k, v in ipairs(t) do","    if v == elem then","      return k","    end","  end","  return 0","end"]):Blockly.Lua.provideFunction_("last_index",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t, elem)","  for i = #t, 1, -1 do","    if t[i] == elem then","      return i","    end","  end","  return 0","end"]))+"("+o+", "+e+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.lists.getIndex_=function(l,e,o){return"FIRST"==e?"1":"FROM_END"==e?"#"+l+" + 1 - "+o:"LAST"==e?"#"+l:"RANDOM"==e?"math.random(#"+l+")":o},Blockly.Lua.lists_getIndex=function(l){var e=l.getFieldValue("MODE")||"GET",o=l.getFieldValue("WHERE")||"FROM_START",a=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_HIGH)||"{}",t=Blockly.Lua.lists.getIndex_;if("LAST"!=o&&"FROM_END"!=o&&"RANDOM"!=o||a.match(/^\w+$/))return u="GET"==e&&"FROM_END"==o?Blockly.Lua.ORDER_ADDITIVE:Blockly.Lua.ORDER_NONE,l=t(a,o,l=Blockly.Lua.valueToCode(l,"AT",u)||"1"),"GET"==e?[a+"["+l+"]",Blockly.Lua.ORDER_HIGH]:(o="table.remove("+a+", "+l+")","GET_REMOVE"==e?[o,Blockly.Lua.ORDER_HIGH]:o+"\n");if("REMOVE"!=e)return l=Blockly.Lua.valueToCode(l,"AT",Blockly.Lua.ORDER_NONE)||"1",[("GET"==e?Blockly.Lua.provideFunction_("list_get_"+o.toLowerCase(),["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t"+("FROM_END"==o||"FROM_START"==o?", at)":")"),"  return t["+t("t",o,"at")+"]","end"]):Blockly.Lua.provideFunction_("list_remove_"+o.toLowerCase(),["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t"+("FROM_END"==o||"FROM_START"==o?", at)":")"),"  return table.remove(t, "+t("t",o,"at")+")","end"]))+"("+a+("FROM_END"==o||"FROM_START"==o?", "+l:"")+")",Blockly.Lua.ORDER_HIGH];var u="FROM_END"==o?Blockly.Lua.ORDER_ADDITIVE:Blockly.Lua.ORDER_NONE;return l=Blockly.Lua.valueToCode(l,"AT",u)||"1",(e=Blockly.Lua.variableDB_.getDistinctName("tmp_list",Blockly.Variables.NAME_TYPE))+" = "+a+"\ntable.remove("+e+", "+(l=t(e,o,l))+")\n"},Blockly.Lua.lists_setIndex=function(l){var e=Blockly.Lua.valueToCode(l,"LIST",Blockly.Lua.ORDER_HIGH)||"{}",o=l.getFieldValue("MODE")||"SET",a=l.getFieldValue("WHERE")||"FROM_START",t=Blockly.Lua.valueToCode(l,"AT",Blockly.Lua.ORDER_ADDITIVE)||"1";l=Blockly.Lua.valueToCode(l,"TO",Blockly.Lua.ORDER_NONE)||"None";var u,n=Blockly.Lua.lists.getIndex_,r="";return"LAST"!=a&&"FROM_END"!=a&&"RANDOM"!=a||e.match(/^\w+$/)||(r=(u=Blockly.Lua.variableDB_.getDistinctName("tmp_list",Blockly.Variables.NAME_TYPE))+" = "+e+"\n",e=u),(r="SET"==o?r+(e+"["+n(e,a,t))+"] = "+l:r+("table.insert("+e+", "+n(e,a,t))+("LAST"==a?" + 1":"")+", "+l+")")+"\n"},Blockly.Lua.lists_getSublist=function(l){var e=Blockly.Lua.valueToCode(l,"LIST",Blockly.Lua.ORDER_NONE)||"{}",o=l.getFieldValue("WHERE1"),a=l.getFieldValue("WHERE2"),t=Blockly.Lua.valueToCode(l,"AT1",Blockly.Lua.ORDER_NONE)||"1";l=Blockly.Lua.valueToCode(l,"AT2",Blockly.Lua.ORDER_NONE)||"1";var u=Blockly.Lua.lists.getIndex_;return[Blockly.Lua.provideFunction_("list_sublist_"+o.toLowerCase()+"_"+a.toLowerCase(),["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(source"+("FROM_END"==o||"FROM_START"==o?", at1":"")+("FROM_END"==a||"FROM_START"==a?", at2":"")+")","  local t = {}","  local start = "+u("source",o,"at1"),"  local finish = "+u("source",a,"at2"),"  for i = start, finish do","    table.insert(t, source[i])","  end","  return t","end"])+"("+e+("FROM_END"==o||"FROM_START"==o?", "+t:"")+("FROM_END"==a||"FROM_START"==a?", "+l:"")+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.lists_sort=function(l){var e=Blockly.Lua.valueToCode(l,"LIST",Blockly.Lua.ORDER_NONE)||"{}",o="1"===l.getFieldValue("DIRECTION")?1:-1;return l=l.getFieldValue("TYPE"),[Blockly.Lua.provideFunction_("list_sort",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(list, typev, direction)","  local t = {}","  for n,v in pairs(list) do table.insert(t, v) end","  local compareFuncs = {","    NUMERIC = function(a, b)","      return (tonumber(tostring(a)) or 0)","          < (tonumber(tostring(b)) or 0) end,","    TEXT = function(a, b)","      return tostring(a) < tostring(b) end,","    IGNORE_CASE = function(a, b)","      return string.lower(tostring(a)) < string.lower(tostring(b)) end","  }","  local compareTemp = compareFuncs[typev]","  local compare = compareTemp","  if direction == -1","  then compare = function(a, b) return compareTemp(b, a) end","  end","  table.sort(t, compare)","  return t","end"])+"("+e+',"'+l+'", '+o+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.lists_split=function(l){var e=Blockly.Lua.valueToCode(l,"INPUT",Blockly.Lua.ORDER_NONE),o=Blockly.Lua.valueToCode(l,"DELIM",Blockly.Lua.ORDER_NONE)||"''";if("SPLIT"==(l=l.getFieldValue("MODE")))e=e||"''",l=Blockly.Lua.provideFunction_("list_string_split",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(input, delim)","  local t = {}","  local pos = 1","  while true do","    next_delim = string.find(input, delim, pos)","    if next_delim == nil then","      table.insert(t, string.sub(input, pos))","      break","    else","      table.insert(t, string.sub(input, pos, next_delim-1))","      pos = next_delim + #delim","    end","  end","  return t","end"]);else{if("JOIN"!=l)throw"Unknown mode: "+l;e=e||"{}",l="table.concat"}return[l+"("+e+", "+o+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.logic={},Blockly.Lua.controls_if=function(l){for(var e=0,o=Blockly.Lua.valueToCode(l,"IF"+e,Blockly.Lua.ORDER_NONE)||"false",a=Blockly.Lua.statementToCode(l,"DO"+e),t="if "+o+" then\n"+a,e=1;e<=l.elseifCount_;e++)t+=" elseif "+(o=Blockly.Lua.valueToCode(l,"IF"+e,Blockly.Lua.ORDER_NONE)||"false")+" then\n"+(a=Blockly.Lua.statementToCode(l,"DO"+e));return l.elseCount_&&(t+=" else\n"+(a=Blockly.Lua.statementToCode(l,"ELSE"))),t+"end\n"},Blockly.Lua.logic_compare=function(l){var e={EQ:"==",NEQ:"~=",LT:"<",LTE:"<=",GT:">",GTE:">="}[l.getFieldValue("OP")];return[(Blockly.Lua.valueToCode(l,"A",Blockly.Lua.ORDER_RELATIONAL)||"0")+" "+e+" "+(l=Blockly.Lua.valueToCode(l,"B",Blockly.Lua.ORDER_RELATIONAL)||"0"),Blockly.Lua.ORDER_RELATIONAL]},Blockly.Lua.logic_operation=function(l){var e,o="AND"==l.getFieldValue("OP")?"and":"or",a="and"==o?Blockly.Lua.ORDER_AND:Blockly.Lua.ORDER_OR,t=Blockly.Lua.valueToCode(l,"A",a);return l=Blockly.Lua.valueToCode(l,"B",a),l=t||l?(e="and"==o?"true":"false",t=t||e,l||e):t="false",[t+" "+o+" "+l,a]},Blockly.Lua.logic_negate=function(l){return["not "+(Blockly.Lua.valueToCode(l,"BOOL",Blockly.Lua.ORDER_UNARY)||"true"),Blockly.Lua.ORDER_UNARY]},Blockly.Lua.logic_boolean=function(l){return["TRUE"==l.getFieldValue("BOOL")?"true":"false",Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.logic_null=function(l){return["nil",Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.logic_ternary=function(l){return[(Blockly.Lua.valueToCode(l,"IF",Blockly.Lua.ORDER_AND)||"false")+" and "+(Blockly.Lua.valueToCode(l,"THEN",Blockly.Lua.ORDER_AND)||"nil")+" or "+(l=Blockly.Lua.valueToCode(l,"ELSE",Blockly.Lua.ORDER_OR)||"nil"),Blockly.Lua.ORDER_OR]},Blockly.Lua.loops={},Blockly.Lua.CONTINUE_STATEMENT="goto continue\n",Blockly.Lua.addContinueLabel=function(l){return-1<l.indexOf(Blockly.Lua.CONTINUE_STATEMENT)?l+Blockly.Lua.INDENT+"::continue::\n":l},Blockly.Lua.controls_repeat=function(l){var e=parseInt(l.getFieldValue("TIMES"),10);return l=Blockly.Lua.statementToCode(l,"DO")||"",l=Blockly.Lua.addContinueLabel(l),"for "+Blockly.Lua.variableDB_.getDistinctName("count",Blockly.Variables.NAME_TYPE)+" = 1, "+e+" do\n"+l+"end\n"},Blockly.Lua.controls_repeat_ext=function(l){var e=Blockly.Lua.valueToCode(l,"TIMES",Blockly.Lua.ORDER_NONE)||"0",e=Blockly.isNumber(e)?parseInt(e,10):"math.floor("+e+")";return l=Blockly.Lua.statementToCode(l,"DO")||"\n",l=Blockly.Lua.addContinueLabel(l),"for "+Blockly.Lua.variableDB_.getDistinctName("count",Blockly.Variables.NAME_TYPE)+" = 1, "+e+" do\n"+l+"end\n"},Blockly.Lua.controls_whileUntil=function(l){var e="UNTIL"==l.getFieldValue("MODE"),o=Blockly.Lua.valueToCode(l,"BOOL",e?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE)||"false",a=Blockly.Lua.statementToCode(l,"DO")||"\n",a=Blockly.Lua.addLoopTrap(a,l.id);return e&&(o="not "+o),"while "+o+" do\n"+(a=Blockly.Lua.addContinueLabel(a))+"end\n"},Blockly.Lua.controls_for=function(l){var e,o=Blockly.Lua.variableDB_.getName(l.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE),a=Blockly.Lua.valueToCode(l,"FROM",Blockly.Lua.ORDER_NONE)||"0",t=Blockly.Lua.valueToCode(l,"TO",Blockly.Lua.ORDER_NONE)||"0",u=Blockly.Lua.valueToCode(l,"BY",Blockly.Lua.ORDER_NONE)||"1",n=Blockly.Lua.statementToCode(l,"DO")||"\n",n=Blockly.Lua.addLoopTrap(n,l.id),n=Blockly.Lua.addContinueLabel(n);return l="",Blockly.isNumber(a)&&Blockly.isNumber(t)&&Blockly.isNumber(u)?e=((e=parseFloat(a)<=parseFloat(t))?"":"-")+(u=Math.abs(parseFloat(u))):(l="",l+=(e=Blockly.Lua.variableDB_.getDistinctName(o+"_inc",Blockly.Variables.NAME_TYPE))+" = ",l=(l=Blockly.isNumber(u)?l+(Math.abs(u)+"\n"):l+"math.abs("+u+")\n")+"if ("+a+") > ("+t+") then\n"+(Blockly.Lua.INDENT+e)+" = -"+e+"\n",l+="end\n"),l+"for "+o+" = "+a+", "+t+", "+e+" do\n"+n+"end\n"},Blockly.Lua.controls_forEach=function(l){var e=Blockly.Lua.variableDB_.getName(l.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE),o=Blockly.Lua.valueToCode(l,"LIST",Blockly.Lua.ORDER_NONE)||"{}";return l=Blockly.Lua.statementToCode(l,"DO")||"\n","for _, "+e+" in ipairs("+o+") do \n"+(l=Blockly.Lua.addContinueLabel(l))+"end\n"},Blockly.Lua.controls_flow_statements=function(l){switch(l.getFieldValue("FLOW")){case"BREAK":return"break\n";case"CONTINUE":return Blockly.Lua.CONTINUE_STATEMENT}throw"Unknown flow statement."},Blockly.Lua.math={},Blockly.Lua.math_number=function(l){return[l=parseFloat(l.getFieldValue("NUM")),l<0?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.math_arithmetic=function(l){var e=(o={ADD:[" + ",Blockly.Lua.ORDER_ADDITIVE],MINUS:[" - ",Blockly.Lua.ORDER_ADDITIVE],MULTIPLY:[" * ",Blockly.Lua.ORDER_MULTIPLICATIVE],DIVIDE:[" / ",Blockly.Lua.ORDER_MULTIPLICATIVE],POWER:[" ^ ",Blockly.Lua.ORDER_EXPONENTIATION]}[l.getFieldValue("OP")])[0],o=o[1];return[(Blockly.Lua.valueToCode(l,"A",o)||"0")+e+(l=Blockly.Lua.valueToCode(l,"B",o)||"0"),o]},Blockly.Lua.math_single=function(l){var e=l.getFieldValue("OP");if("NEG"==e)return["-"+(l=Blockly.Lua.valueToCode(l,"NUM",Blockly.Lua.ORDER_UNARY)||"0"),Blockly.Lua.ORDER_UNARY];switch(l="SIN"==e||"COS"==e||"TAN"==e?Blockly.Lua.valueToCode(l,"NUM",Blockly.Lua.ORDER_MULTIPLICATIVE)||"0":Blockly.Lua.valueToCode(l,"NUM",Blockly.Lua.ORDER_NONE)||"0",e){case"ABS":e="math.abs("+l+")";break;case"ROOT":e="math.sqrt("+l+")";break;case"LN":e="math.log("+l+")";break;case"LOG10":e="math.log10("+l+")";break;case"EXP":e="math.exp("+l+")";break;case"POW10":e="math.pow(10,"+l+")";break;case"ROUND":e="math.floor("+l+" + .5)";break;case"ROUNDUP":e="math.ceil("+l+")";break;case"ROUNDDOWN":e="math.floor("+l+")";break;case"SIN":e="math.sin(math.rad("+l+"))";break;case"COS":e="math.cos(math.rad("+l+"))";break;case"TAN":e="math.tan(math.rad("+l+"))";break;case"ASIN":e="math.deg(math.asin("+l+"))";break;case"ACOS":e="math.deg(math.acos("+l+"))";break;case"ATAN":e="math.deg(math.atan("+l+"))";break;default:throw"Unknown math operator: "+e}return[e,Blockly.Lua.ORDER_HIGH]},Blockly.Lua.math_constant=function(l){return{PI:["math.pi",Blockly.Lua.ORDER_HIGH],E:["math.exp(1)",Blockly.Lua.ORDER_HIGH],GOLDEN_RATIO:["(1 + math.sqrt(5)) / 2",Blockly.Lua.ORDER_MULTIPLICATIVE],SQRT2:["math.sqrt(2)",Blockly.Lua.ORDER_HIGH],SQRT1_2:["math.sqrt(1 / 2)",Blockly.Lua.ORDER_HIGH],INFINITY:["math.huge",Blockly.Lua.ORDER_HIGH]}[l.getFieldValue("CONSTANT")]},Blockly.Lua.math_number_property=function(l){var e,o=Blockly.Lua.valueToCode(l,"NUMBER_TO_CHECK",Blockly.Lua.ORDER_MULTIPLICATIVE)||"0",a=l.getFieldValue("PROPERTY");if("PRIME"==a)return[Blockly.Lua.provideFunction_("math_isPrime",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(n)","  -- https://en.wikipedia.org/wiki/Primality_test#Naive_methods","  if n == 2 or n == 3 then","    return true","  end","  -- False if n is NaN, negative, is 1, or not whole.","  -- And false if n is divisible by 2 or 3.","  if not(n > 1) or n % 1 ~= 0 or n % 2 == 0 or n % 3 == 0 then","    return false","  end","  -- Check all the numbers of form 6k +/- 1, up to sqrt(n).","  for x = 6, math.sqrt(n) + 1.5, 6 do","    if n % (x - 1) == 0 or n % (x + 1) == 0 then","      return false","    end","  end","  return true","end"])+"("+o+")",Blockly.Lua.ORDER_HIGH];switch(a){case"EVEN":e=o+" % 2 == 0";break;case"ODD":e=o+" % 2 == 1";break;case"WHOLE":e=o+" % 1 == 0";break;case"POSITIVE":e=o+" > 0";break;case"NEGATIVE":e=o+" < 0";break;case"DIVISIBLE_BY":if(!(l=Blockly.Lua.valueToCode(l,"DIVISOR",Blockly.Lua.ORDER_MULTIPLICATIVE))||"0"==l)return["nil",Blockly.Lua.ORDER_ATOMIC];e=o+" % "+l+" == 0"}return[e,Blockly.Lua.ORDER_RELATIONAL]},Blockly.Lua.math_change=function(l){var e=Blockly.Lua.valueToCode(l,"DELTA",Blockly.Lua.ORDER_ADDITIVE)||"0";return(l=Blockly.Lua.variableDB_.getName(l.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE))+" = "+l+" + "+e+"\n"},Blockly.Lua.math_round=Blockly.Lua.math_single,Blockly.Lua.math_trig=Blockly.Lua.math_single,Blockly.Lua.math_on_list=function(l){function e(){return Blockly.Lua.provideFunction_("math_sum",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  local result = 0","  for _, v in ipairs(t) do","    result = result + v","  end","  return result","end"])}var o=l.getFieldValue("OP");switch(l=Blockly.Lua.valueToCode(l,"LIST",Blockly.Lua.ORDER_NONE)||"{}",o){case"SUM":o=e();break;case"MIN":o=Blockly.Lua.provideFunction_("math_min",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  local result = math.huge","  for _, v in ipairs(t) do","    if v < result then","      result = v","    end","  end","  return result","end"]);break;case"AVERAGE":o=Blockly.Lua.provideFunction_("math_average",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  return "+e()+"(t) / #t","end"]);break;case"MAX":o=Blockly.Lua.provideFunction_("math_max",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  local result = -math.huge","  for _, v in ipairs(t) do","    if v > result then","      result = v","    end","  end","  return result","end"]);break;case"MEDIAN":o=Blockly.Lua.provideFunction_("math_median",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  -- Source: http://lua-users.org/wiki/SimpleStats","  if #t == 0 then","    return 0","  end","  local temp={}","  for _, v in ipairs(t) do",'    if type(v) == "number" then',"      table.insert(temp, v)","    end","  end","  table.sort(temp)","  if #temp % 2 == 0 then","    return (temp[#temp/2] + temp[(#temp/2)+1]) / 2","  else","    return temp[math.ceil(#temp/2)]","  end","end"]);break;case"MODE":o=Blockly.Lua.provideFunction_("math_modes",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  -- Source: http://lua-users.org/wiki/SimpleStats","  local counts={}","  for _, v in ipairs(t) do","    if counts[v] == nil then","      counts[v] = 1","    else","      counts[v] = counts[v] + 1","    end","  end","  local biggestCount = 0","  for _, v  in pairs(counts) do","    if v > biggestCount then","      biggestCount = v","    end","  end","  local temp={}","  for k, v in pairs(counts) do","    if v == biggestCount then","      table.insert(temp, k)","    end","  end","  return temp","end"]);break;case"STD_DEV":o=Blockly.Lua.provideFunction_("math_standard_deviation",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  local m","  local vm","  local total = 0","  local count = 0","  local result","  m = #t == 0 and 0 or "+e()+"(t) / #t","  for _, v in ipairs(t) do","    if type(v) == 'number' then","      vm = v - m","      total = total + (vm * vm)","      count = count + 1","    end","  end","  result = math.sqrt(total / (count-1))","  return result","end"]);break;case"RANDOM":o=Blockly.Lua.provideFunction_("math_random_list",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return nil","  end","  return t[math.random(#t)]","end"]);break;default:throw"Unknown operator: "+o}return[o+"("+l+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.math_modulo=function(l){return[(Blockly.Lua.valueToCode(l,"DIVIDEND",Blockly.Lua.ORDER_MULTIPLICATIVE)||"0")+" % "+(l=Blockly.Lua.valueToCode(l,"DIVISOR",Blockly.Lua.ORDER_MULTIPLICATIVE)||"0"),Blockly.Lua.ORDER_MULTIPLICATIVE]},Blockly.Lua.math_constrain=function(l){return["math.min(math.max("+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"0")+", "+(Blockly.Lua.valueToCode(l,"LOW",Blockly.Lua.ORDER_NONE)||"-math.huge")+"), "+(l=Blockly.Lua.valueToCode(l,"HIGH",Blockly.Lua.ORDER_NONE)||"math.huge")+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.math_random_int=function(l){return["math.random("+(Blockly.Lua.valueToCode(l,"FROM",Blockly.Lua.ORDER_NONE)||"0")+", "+(l=Blockly.Lua.valueToCode(l,"TO",Blockly.Lua.ORDER_NONE)||"0")+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.math_random_float=function(l){return["math.random()",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.procedures={},Blockly.Lua.procedures_defreturn=function(l){var e=Blockly.Lua.variableDB_.getName(l.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=Blockly.Lua.statementToCode(l,"STACK");Blockly.Lua.STATEMENT_PREFIX&&(o=Blockly.Lua.prefixLines(Blockly.Lua.STATEMENT_PREFIX.replace(/%1/g,"'"+l.id+"'"),Blockly.Lua.INDENT)+o),Blockly.Lua.INFINITE_LOOP_TRAP&&(o=Blockly.Lua.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+l.id+"'")+o);var a=Blockly.Lua.valueToCode(l,"RETURN",Blockly.Lua.ORDER_NONE)||"";a?a="  return "+a+"\n":o=o||"";for(var t=[],u=0;u<l.arguments_.length;u++)t[u]=Blockly.Lua.variableDB_.getName(l.arguments_[u],Blockly.Variables.NAME_TYPE);return o="function "+e+"("+t.join(", ")+")\n"+o+a+"end\n",o=Blockly.Lua.scrub_(l,o),Blockly.Lua.definitions_["%"+e]=o,null},Blockly.Lua.procedures_defnoreturn=Blockly.Lua.procedures_defreturn,Blockly.Lua.procedures_callreturn=function(l){for(var e=Blockly.Lua.variableDB_.getName(l.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=[],a=0;a<l.arguments_.length;a++)o[a]=Blockly.Lua.valueToCode(l,"ARG"+a,Blockly.Lua.ORDER_NONE)||"nil";return[e+"("+o.join(", ")+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.procedures_callnoreturn=function(l){for(var e=Blockly.Lua.variableDB_.getName(l.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=[],a=0;a<l.arguments_.length;a++)o[a]=Blockly.Lua.valueToCode(l,"ARG"+a,Blockly.Lua.ORDER_NONE)||"nil";return e+"("+o.join(", ")+")\n"},Blockly.Lua.procedures_ifreturn=function(l){var e="if "+(Blockly.Lua.valueToCode(l,"CONDITION",Blockly.Lua.ORDER_NONE)||"false")+" then\n";return l.hasReturnValue_?e+="  return "+(l=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"nil")+"\n":e+="  return\n",e+"end\n"},Blockly.Lua.texts={},Blockly.Lua.text=function(l){return[Blockly.Lua.quote_(l.getFieldValue("TEXT")),Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.text_join=function(l){if(0==l.itemCount_)return["''",Blockly.Lua.ORDER_ATOMIC];if(1==l.itemCount_)return["tostring("+(Blockly.Lua.valueToCode(l,"ADD0",Blockly.Lua.ORDER_NONE)||"''")+")",Blockly.Lua.ORDER_HIGH];if(2==l.itemCount_)return[(e=Blockly.Lua.valueToCode(l,"ADD0",Blockly.Lua.ORDER_CONCATENATION)||"''")+" .. "+(l=Blockly.Lua.valueToCode(l,"ADD1",Blockly.Lua.ORDER_CONCATENATION)||"''"),Blockly.Lua.ORDER_CONCATENATION];for(var e=[],o=0;o<l.itemCount_;o++)e[o]=Blockly.Lua.valueToCode(l,"ADD"+o,Blockly.Lua.ORDER_NONE)||"''";return[l="table.concat({"+e.join(", ")+"})",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_append=function(l){var e=Blockly.Lua.variableDB_.getName(l.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE);return e+" = "+e+" .. "+(l=Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_CONCATENATION)||"''")+"\n"},Blockly.Lua.text_length=function(l){return["#"+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_UNARY)||"''"),Blockly.Lua.ORDER_UNARY]},Blockly.Lua.text_isEmpty=function(l){return["#"+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_UNARY)||"''")+" == 0",Blockly.Lua.ORDER_RELATIONAL]},Blockly.Lua.text_indexOf=function(l){var e=Blockly.Lua.valueToCode(l,"FIND",Blockly.Lua.ORDER_NONE)||"''",o=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"''";return[("FIRST"==l.getFieldValue("END")?Blockly.Lua.provideFunction_("firstIndexOf",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr) ","  local i = string.find(str, substr, 1, true)","  if i == nil then","    return 0","  else","    return i","  end","end"]):Blockly.Lua.provideFunction_("lastIndexOf",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr)","  local i = string.find(string.reverse(str), string.reverse(substr), 1, true)","  if i then","    return #str + 2 - i - #substr","  end","  return 0","end"]))+"("+o+", "+e+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_charAt=function(l){var e=l.getFieldValue("WHERE")||"FROM_START",o=Blockly.Lua.valueToCode(l,"AT","FROM_END"==e?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE)||"1";if(l=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"''","RANDOM"==e)l=(e=Blockly.Lua.provideFunction_("text_random_letter",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local index = math.random(string.len(str))","  return string.sub(str, index, index)","end"]))+"("+l+")";else{if("FIRST"==e)o="1";else if("LAST"==e)o="-1";else if("FROM_START"!=e){if("FROM_END"!=e)throw"Unhandled option (text_charAt).";o="-"+o}l=o.match(/^-?\w*$/)?"string.sub("+l+", "+o+", "+o+")":(e=Blockly.Lua.provideFunction_("text_char_at",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, index)","  return string.sub(str, index, index)","end"]))+"("+l+", "+o+")"}return[l,Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_getSubstring=function(l){var e=Blockly.Lua.valueToCode(l,"STRING",Blockly.Lua.ORDER_NONE)||"''",o=l.getFieldValue("WHERE1"),a=Blockly.Lua.valueToCode(l,"AT1","FROM_END"==o?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE)||"1";if("FIRST"==o)o=1;else if("FROM_START"==o)o=a;else{if("FROM_END"!=o)throw"Unhandled option (text_getSubstring)";o="-"+a}if(a=l.getFieldValue("WHERE2"),l=Blockly.Lua.valueToCode(l,"AT2","FROM_END"==a?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE)||"1","LAST"==a)l=-1;else if("FROM_START"!=a){if("FROM_END"!=a)throw"Unhandled option (text_getSubstring)";l="-"+l}return["string.sub("+e+", "+o+", "+l+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_changeCase=function(l){var e,o=l.getFieldValue("CASE");return l=Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''","UPPERCASE"==o?e="string.upper":"LOWERCASE"==o?e="string.lower":"TITLECASE"==o&&(e=Blockly.Lua.provideFunction_("text_titlecase",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local buf = {}","  local inWord = false","  for i = 1, #str do","    local c = string.sub(str, i, i)","    if inWord then","      table.insert(buf, string.lower(c))",'      if string.find(c, "%s") then',"        inWord = false","      end","    else","      table.insert(buf, string.upper(c))","      inWord = true","    end","  end","  return table.concat(buf)","end"])),[e+"("+l+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_trim=function(l){var e={LEFT:"^%s*(,-)",RIGHT:"(.-)%s*$",BOTH:"^%s*(.-)%s*$"}[l.getFieldValue("MODE")];return["string.gsub("+(Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''")+', "'+e+'", "%1")',Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_print=function(l){return"print("+(Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''")+")\n"},Blockly.Lua.text_prompt_ext=function(l){var e=l.getField("TEXT")?Blockly.Lua.quote_(l.getFieldValue("TEXT")):Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''",e=Blockly.Lua.provideFunction_("text_prompt",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(msg)","  io.write(msg)","  io.flush()","  return io.read()","end"])+"("+e+")";return"NUMBER"==l.getFieldValue("TYPE")&&(e="tonumber("+e+", 10)"),[e,Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_prompt=Blockly.Lua.text_prompt_ext,Blockly.Lua.variables={},Blockly.Lua.variables_get=function(l){return[Blockly.Lua.variableDB_.getName(l.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE),Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.variables_set=function(l){var e=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"0";return Blockly.Lua.variableDB_.getName(l.getFieldValue("VAR"),Blockly.Variables.NAME_TYPE)+" = "+e+"\n"};