layui.define("layer",function(e){"use strict";function v(e){var i=this;i.config=g.extend({},i.config,n.config,e),i.render()}var g=layui.$,i=layui.layer,t=layui.hint(),y=layui.device(),n={config:{},set:function(e){var i=this;return i.config=g.extend({},i.config,e),i},on:function(e,i){return layui.onevent.call(this,o,e,i)}},o="upload",a="layui-upload-file",l="layui-upload-form",F="layui-upload-iframe",b="layui-upload-choose";v.prototype.config={accept:"images",exts:"",auto:!0,bindAction:"",url:"",field:"file",method:"post",data:{},drag:!0,size:0,number:0,multiple:!1},v.prototype.render=function(e){var i=this;(e=i.config).elem=g(e.elem),e.bindAction=g(e.bindAction),i.file(),i.events()},v.prototype.file=function(){var e=this,i=e.config,t=e.elemFile=g(['<input class="'+a+'" type="file" accept="'+i.acceptMime+'" name="'+i.field+'"',i.multiple?" multiple":"",">"].join("")),n=i.elem.next();(n.hasClass(a)||n.hasClass(l))&&n.remove(),y.ie&&y.ie<10&&i.elem.wrap('<div class="layui-upload-wrap"></div>'),e.isFile()?(e.elemFile=i.elem,i.field=i.elem[0].name):i.elem.after(t),y.ie&&y.ie<10&&e.initIE()},v.prototype.initIE=function(){var t,e=this.config,i=g('<iframe id="'+F+'" class="'+F+'" name="'+F+'" frameborder="0"></iframe>'),n=g(['<form target="'+F+'" class="'+l+'" method="post" key="set-mine" enctype="multipart/form-data" action="'+e.url+'">',"</form>"].join(""));g("#"+F)[0]||g("body").append(i),e.elem.next().hasClass(l)||(this.elemFile.wrap(n),e.elem.next("."+l).append((t=[],layui.each(e.data,function(e,i){i="function"==typeof i?i():i,t.push('<input type="hidden" name="'+e+'" value="'+i+'">')}),t.join(""))))},v.prototype.msg=function(e){return i.msg(e,{icon:2,shift:6})},v.prototype.isFile=function(){var e=this.config.elem[0];if(e)return"input"===e.tagName.toLocaleLowerCase()&&"file"===e.type},v.prototype.preview=function(n){window.FileReader&&layui.each(this.chooseFiles,function(e,i){var t=new FileReader;t.readAsDataURL(i),t.onload=function(){n&&n(e,i,this.result)}})},v.prototype.upload=function(i,e){function n(){function n(){c.multiple&&o+a===u.fileLength&&"function"==typeof c.allDone&&c.allDone({total:u.fileLength,successful:o,aborted:a})}var o=0,a=0,e=i||u.files||u.chooseFiles||s.files;layui.each(e,function(i,e){var t=new FormData;t.append(c.field,e),layui.each(c.data,function(e,i){i="function"==typeof i?i():i,t.append(e,i)}),g.ajax({url:c.url,type:"post",data:t,contentType:!1,processData:!1,dataType:"json",headers:c.headers||{},success:function(e){o++,f(i,e),n()},error:function(){a++,u.msg("请求上传接口出现异常"),p(i),n()}})})}var t,o,a,l,r,u=this,c=u.config,s=u.elemFile[0],f=function(e,i){if(u.elemFile.next("."+b).remove(),s.value="","object"!=typeof i)try{i=JSON.parse(i)}catch(e){return i={},u.msg("请对上传接口返回有效JSON")}"function"==typeof c.done&&c.done(i,e||0,function(e){u.upload(e)})},p=function(e){c.auto&&(s.value=""),"function"==typeof c.error&&c.error(e||0,function(e){u.upload(e)})},d=c.exts,m=(o=[],layui.each(i||u.chooseFiles,function(e,i){o.push(i.name)}),o),h={preview:function(e){u.preview(e)},upload:function(e,i){var t={};t[e]=i,u.upload(t)},pushFile:function(){return u.files=u.files||{},layui.each(u.chooseFiles,function(e,i){u.files[e]=i}),u.files},resetFile:function(e,i,t){var n=new File([i],t);u.files=u.files||{},u.files[e]=n}};if(0!==(m=0===m.length?s.value.match(/[^\/\\]+\..+/g)||[]||"":m).length){switch(c.accept){case"file":if(d&&!RegExp("\\w\\.("+d+")$","i").test(escape(m)))return u.msg("选择的文件中包含不支持的格式"),s.value="";break;case"video":if(!RegExp("\\w\\.("+(d||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(m)))return u.msg("选择的视频中包含不支持的格式"),s.value="";break;case"audio":if(!RegExp("\\w\\.("+(d||"mp3|wav|mid")+")$","i").test(escape(m)))return u.msg("选择的音频中包含不支持的格式"),s.value="";break;default:if(layui.each(m,function(e,i){RegExp("\\w\\.("+(d||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(i))||(t=!0)}),t)return u.msg("选择的图片中包含不支持的格式"),s.value=""}if(u.fileLength=(l=0,r=i||u.files||u.chooseFiles||s.files,layui.each(r,function(){l++}),l),c.number&&u.fileLength>c.number)return u.msg("同时最多只能上传的数量为："+c.number);if(0<c.size&&!(y.ie&&y.ie<10))if(layui.each(u.chooseFiles,function(e,i){var t;i.size>1024*c.size&&(t=1<=(t=c.size/1024)?t.toFixed(2)+"MB":c.size+"KB",s.value="",a=t)}),a)return u.msg("文件不能超过"+a);!function(){if("choose"!==e&&!c.auto||(c.choose&&c.choose(h),"choose"!==e))return c.before&&c.before(h),y.ie?9<y.ie?n():(t=g("#"+F),u.elemFile.parent().submit(),clearInterval(v.timer),v.timer=setInterval(function(){var e,i=t.contents().find("body");try{e=i.text()}catch(e){u.msg("获取上传后的响应信息出现异常"),clearInterval(v.timer),p()}e&&(clearInterval(v.timer),i.html(""),f(0,e))},30)):n();var t}()}},v.prototype.events=function(){function o(e){l.chooseFiles={},layui.each(e,function(e,i){var t=(new Date).getTime();l.chooseFiles[t+"-"+e]=i})}function a(e,i){var t=l.elemFile,n=1<e.length?e.length+"个文件":(e[0]||{}).name||t[0].value.match(/[^\/\\]+\..+/g)||[]||"";t.next().hasClass(b)&&t.next().remove(),l.upload(null,"choose"),l.isFile()||r.choose||t.after('<span class="layui-inline '+b+'">'+n+"</span>")}var l=this,r=l.config;r.elem.off("upload.start").on("upload.start",function(){var e=g(this),i=e.attr("lay-data");if(i)try{i=new Function("return "+i)(),l.config=g.extend({},r,i)}catch(e){t.error("Upload element property lay-data configuration item has a syntax error: "+i)}l.config.item=e,l.elemFile[0].click()}),y.ie&&y.ie<10||r.elem.off("upload.over").on("upload.over",function(){g(this).attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){g(this).removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(e,i){var t=g(this),n=i.originalEvent.dataTransfer.files||[];t.removeAttr("lay-over"),o(n),r.auto?l.upload(n):a(n)}),l.elemFile.off("upload.change").on("upload.change",function(){var e=this.files||[];o(e),r.auto?l.upload():a(e)}),r.bindAction.off("upload.action").on("upload.action",function(){l.upload()}),r.elem.data("haveEvents")||(l.elemFile.on("change",function(){g(this).trigger("upload.change")}),r.elem.on("click",function(){l.isFile()||g(this).trigger("upload.start")}),r.drag&&r.elem.on("dragover",function(e){e.preventDefault(),g(this).trigger("upload.over")}).on("dragleave",function(e){g(this).trigger("upload.leave")}).on("drop",function(e){e.preventDefault(),g(this).trigger("upload.drop",e)}),r.bindAction.on("click",function(){g(this).trigger("upload.action")}),r.elem.data("haveEvents",!0))},n.render=function(e){var i=new v(e);return function(){var i=this;return{upload:function(e){i.upload.call(i,e)},config:i.config}}.call(i)},e(o,n)});