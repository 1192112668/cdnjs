"use strict";var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(e,t){function a(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),globals_1=require("../globals"),ops_1=require("../ops/ops"),optimizer_1=require("./optimizer"),AdamaxOptimizer=function(r){function e(e,t,a,i,s){void 0===i&&(i=1e-8),void 0===s&&(s=0);var o=r.call(this)||this;return o.learningRate=e,o.accumulatedFirstMoment={},o.accumulatedWeightedInfNorm={},o.c=globals_1.keep(ops_1.scalar(-e)),o.eps=globals_1.keep(ops_1.scalar(i)),o.beta1=globals_1.keep(ops_1.scalar(t)),o.beta2=globals_1.keep(ops_1.scalar(a)),o.decay=globals_1.keep(ops_1.scalar(s)),globals_1.tidy(function(){o.iteration=ops_1.scalar(0).variable(),o.accBeta1=ops_1.scalar(t).variable()}),o.oneMinusBeta1=globals_1.keep(ops_1.scalar(1-t)),o.one=globals_1.keep(ops_1.scalar(1)),o}return __extends(e,r),e.prototype.applyGradients=function(m){var _=this;globals_1.tidy(function(){var e=_.one.sub(_.accBeta1),t=_.c.div(_.one.add(_.decay.mul(_.iteration)));for(var a in m){var i,s=environment_1.ENV.engine.registeredVariables[a];null==_.accumulatedFirstMoment[a]&&(i=!1,_.accumulatedFirstMoment[a]=ops_1.zerosLike(s).variable(i)),null==_.accumulatedWeightedInfNorm[a]&&(i=!1,_.accumulatedWeightedInfNorm[a]=ops_1.zerosLike(s).variable(i));var o=m[a],r=_.accumulatedFirstMoment[a],n=_.accumulatedWeightedInfNorm[a],c=_.beta1.mul(r).add(_.oneMinusBeta1.mul(o)),l=_.beta2.mul(n),u=o.abs(),d=l.maximum(u);_.accumulatedFirstMoment[a].assign(c),_.accumulatedWeightedInfNorm[a].assign(d);var p=t.div(e).mul(c.div(_.eps.add(d))).add(s);s.assign(p)}_.iteration.assign(_.iteration.add(_.one)),_.accBeta1.assign(_.accBeta1.mul(_.beta1))})},e.prototype.dispose=function(){var t=this;this.c.dispose(),this.eps.dispose(),this.accBeta1.dispose(),this.beta1.dispose(),this.beta2.dispose(),this.oneMinusBeta1.dispose(),this.decay.dispose(),this.iteration.dispose(),this.one.dispose(),null!=this.accumulatedFirstMoment&&Object.keys(this.accumulatedFirstMoment).forEach(function(e){return t.accumulatedFirstMoment[e].dispose()}),null!=this.accumulatedWeightedInfNorm&&Object.keys(this.accumulatedWeightedInfNorm).forEach(function(e){return t.accumulatedWeightedInfNorm[e].dispose()})},e}(optimizer_1.Optimizer);exports.AdamaxOptimizer=AdamaxOptimizer;