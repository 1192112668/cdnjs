"use strict";var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(n,i,s,u){return new(s=s||Promise)(function(t,e){function r(t){try{o(u.next(t))}catch(t){e(t)}}function a(t){try{o(u.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(r,a)}o((u=u.apply(n,i||[])).next())})},__generator=this&&this.__generator||function(r,a){var o,n,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,n&&(i=n[2&e[0]?"return":e[0]?"throw":"next"])&&!(i=i.call(n,e[1])).done)return i;switch(n=0,i&&(e=[0,i.value]),e[0]){case 0:case 1:i=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,n=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!i||e[1]>i[0]&&e[1]<i[3])){s.label=e[1];break}if(6===e[0]&&s.label<i[1]){s.label=i[1],i=e;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(e);break}i[2]&&s.ops.pop(),s.trys.pop();continue}e=a.call(r,s)}catch(t){e=[6,t],n=0}finally{o=i=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),environment_1=require("../environment"),math_1=require("../math"),axis_util=require("../ops/axis_util"),broadcast_util=require("../ops/broadcast_util"),concat_util=require("../ops/concat_util"),ops=require("../ops/ops"),ops_1=require("../ops/ops"),selu_util=require("../ops/selu_util"),tensor_1=require("../tensor"),types=require("../types"),util=require("../util"),MathBackendCPU=function(){function t(){this.data=new WeakMap,"undefined"!=typeof document&&(this.canvas=document.createElement("canvas"))}return t.prototype.register=function(t,e,r){if(this.data.has(t))throw new Error("Data buffer is already registered");this.data.set(t,null)},t.prototype.write=function(t,e){if(null==e)throw new Error("MathBackendCPU.write(): values can not be null");this.throwIfNoData(t),this.data.set(t,e)},t.prototype.fromPixels=function(t,e){if(null==t)throw new Error("MathBackendCPU.writePixels(): pixels can not be null");var r;if(t instanceof ImageData)r=t.data;else if(t instanceof HTMLCanvasElement)r=t.getContext("2d").getImageData(0,0,t.width,t.height).data;else{if(!(t instanceof HTMLImageElement||t instanceof HTMLVideoElement))throw new Error("pixels is of unknown type: "+t.constructor.name);if(null==this.canvas)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.getContext("2d").drawImage(t,0,0,t.width,t.height),r=this.canvas.getContext("2d").getImageData(0,0,t.width,t.height).data}if(4===e)o=new Int32Array(r);else for(var a=t.width*t.height,o=new Int32Array(a*e),n=0;n<a;n++)for(var i=0;i<e;++i)o[n*e+i]=r[4*n+i];var s=[t.height,t.width,e];return ops_1.tensor3d(o,s,"int32")},t.prototype.read=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.readSync(e)]})})},t.prototype.readSync=function(t){return this.throwIfNoData(t),this.data.get(t)},t.prototype.disposeData=function(t){this.data.has(t)&&this.data.delete(t)},t.prototype.time=function(r){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){return e=performance.now(),r(),[2,{kernelMs:performance.now()-e}]})})},t.prototype.memory=function(){return{unreliable:!0}},t.prototype.throwIfNoData=function(t){if(!this.data.has(t))throw new Error("CPU backend: No data found for this tensor. Did you change your backend in the middle of the program? New backends can't use Tensors created with previous backends")},t.prototype.slice1D=function(t,e,r){var a=t.dataSync().slice(e,e+r);return ops.tensor1d(a,t.dtype)},t.prototype.slice2D=function(t,e,r){for(var a=ops.buffer(r,t.dtype),o=e[0],n=e[1],i=0;i<r[0];++i)for(var s=0;s<r[1];++s){var u=t.get(i+o,s+n);a.set(u,i,s)}return a.toTensor()},t.prototype.slice3D=function(t,e,r){for(var a=ops.buffer(r,t.dtype),o=e[0],n=e[1],i=e[2],s=0;s<r[0];++s)for(var u=0;u<r[1];++u)for(var p=0;p<r[2];++p){var h=t.get(s+o,u+n,p+i);a.set(h,s,u,p)}return a.toTensor()},t.prototype.slice4D=function(t,e,r){for(var a=ops.buffer(r,t.dtype),o=e[0],n=e[1],i=e[2],s=e[3],u=0;u<r[0];++u)for(var p=0;p<r[1];++p)for(var h=0;h<r[2];++h)for(var l=0;l<r[3];++l){var f=t.get(u+o,p+n,h+i,l+s);a.set(f,u,p,h,l)}return a.toTensor()},t.prototype.reverse4D=function(e,r){for(var t=ops.buffer(e.shape,e.dtype),a=function(t){return-1!==r.indexOf(t)&&1!==e.shape[t]},o=0;o<e.shape[0];++o)for(var n=0;n<e.shape[1];++n)for(var i=0;i<e.shape[2];++i)for(var s=0;s<e.shape[3];++s){var u=a(0)?e.shape[0]-o-1:o,p=a(1)?e.shape[1]-n-1:n,h=a(2)?e.shape[2]-i-1:i,l=a(3)?e.shape[3]-s-1:s,f=e.get(u,p,h,l);t.set(f,o,n,i,s)}return t.toTensor()},t.prototype.concat=function(t,e){var r=concat_util.computeOutShape(t.shape,e.shape,1),a=ops.buffer(r,t.dtype);if(1===t.shape[0]&&1===e.shape[0]){var o=t.dataSync(),n=e.dataSync(),i=a.values;return i.set(o,0),i.set(n,t.size),a.toTensor()}for(var s=0;s<r[0];++s){for(var u=0;u<t.shape[1];++u)a.set(t.get(s,u),s,u);for(u=0;u<e.shape[1];++u)a.set(e.get(s,u),s,u+t.shape[1])}return a.toTensor()},t.prototype.neg=function(t){return this.multiply(ops.scalar(-1),t)},t.prototype.add=function(t,e){return this.broadcastedBinaryOp(t,e,types.upcastType(t.dtype,e.dtype),function(t,e){return t+e})},t.prototype.subtract=function(t,e){return this.broadcastedBinaryOp(t,e,types.upcastType(t.dtype,e.dtype),function(t,e){return t-e})},t.prototype.pow=function(t,e){return this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.pow(t,e)})},t.prototype.matMul=function(t,e,r,a){for(var o=r?t.shape[0]:t.shape[1],n=r?t.shape[1]:t.shape[0],i=a?e.shape[0]:e.shape[1],s=function(t,e,r){return t.get(e,r)},u=function(t,e,r){return t.get(r,e)},p=r?u:s,h=a?u:s,l=new Float32Array(n*i),f=0,c=0;c<n;++c)for(var d=0;d<i;++d){for(var y=0,v=0;v<o;++v)y+=p(t,c,v)*h(e,v,d);l[f++]=y}return ops.tensor2d(l,[n,i])},t.prototype.multiply=function(t,e){return this.broadcastedBinaryOp(t,e,types.upcastType(t.dtype,e.dtype),function(t,e){return t*e})},t.prototype.divide=function(t,e){return this.broadcastedBinaryOp(t,e,"float32",function(t,e){return t/e})},t.prototype.sum=function(t,e){axis_util.assertAxesAreInnerMostDims("sum",e,t.rank);for(var r=axis_util.computeOutAndReduceShapes(t.shape,e),a=r[0],o=r[1],n=types.upcastType(t.dtype,"int32"),i=ops.zeros(a,n),s=util.sizeFromShape(o),u=i.dataSync(),p=t.dataSync(),h=0;h<u.length;++h){for(var l=h*s,f=0,c=0;c<s;++c)f+=p[l+c];u[h]=f}return i},t.prototype.argMin=function(t,e){axis_util.assertAxesAreInnerMostDims("argMin",e,t.rank);for(var r=axis_util.computeOutAndReduceShapes(t.shape,e),a=r[0],o=r[1],n=ops.zeros(a,"int32"),i=util.sizeFromShape(o),s=n.dataSync(),u=t.dataSync(),p=0;p<s.length;++p){for(var h=p*i,l=u[h],f=0,c=0;c<i;++c){var d=u[h+c];if(isNaN(d)){f=util.NAN_INT32;break}d<l&&(l=d,f=c)}s[p]=f}return n},t.prototype.argMax=function(t,e){axis_util.assertAxesAreInnerMostDims("argMax",e,t.rank);for(var r=axis_util.computeOutAndReduceShapes(t.shape,e),a=r[0],o=r[1],n=ops.zeros(a,"int32"),i=util.sizeFromShape(o),s=n.dataSync(),u=t.dataSync(),p=0;p<s.length;++p){for(var h=p*i,l=u[h],f=0,c=0;c<i;++c){var d=u[h+c];if(isNaN(d)){f=util.NAN_INT32;break}l<d&&(l=d,f=c)}s[p]=f}return n},t.prototype.equal=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t===e?1:0})},t.prototype.notEqual=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t!==e?1:0})},t.prototype.less=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t<e?1:0})},t.prototype.lessEqual=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t<=e?1:0})},t.prototype.greater=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):e<t?1:0})},t.prototype.greaterEqual=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):e<=t?1:0})},t.prototype.logicalNot=function(t){for(var e=t.dataSync(),r=new Int32Array(e.length),a=0;a<e.length;++a)util.isValNaN(e[a],t.dtype)?r[a]=util.getNaN("bool"):r[a]=e[a]?0:1;return tensor_1.Tensor.make(t.shape,{values:r},"bool")},t.prototype.logicalAnd=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t&&e})},t.prototype.logicalOr=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t||e})},t.prototype.logicalXor=function(r,a){return this.broadcastedBinaryOp(r,a,"bool",function(t,e){return util.isValNaN(t,r.dtype)||util.isValNaN(e,a.dtype)?util.getNaN("bool"):t^e})},t.prototype.where=function(t,e,r,a){for(var o=t.dataSync(),n=e.dataSync(),i=r.dataSync(),s=ops.zeros(e.shape,a),u=s.dataSync(),p=0,h=0===t.rank||1<t.rank||1===e.rank?1:e.shape[1],l=0;l<o.length;l++)for(var f=0;f<h;f++)1===o[l]?u[p++]=n[l]:u[p++]=i[l];return s},t.prototype.topKValues=function(t,e){return this.topK(t,e).values},t.prototype.topKIndices=function(t,e){return this.topK(t,e).indices},t.prototype.topK=function(t,e){for(var r=t.dataSync(),a=[],o=0;o<r.length;o++)a.push({value:r[o],index:o});a.sort(function(t,e){return e.value-t.value});for(var n=util.getTypedArrayFromDType(t.dtype,e),i=new Int32Array(e),o=0;o<e;o++)n[o]=a[o].value,i[o]=a[o].index;return{values:ops.tensor1d(n,t.dtype),indices:tensor_1.Tensor1D.new(i)}},t.prototype.min=function(t,e){axis_util.assertAxesAreInnerMostDims("min",e,t.rank);for(var r=axis_util.computeOutAndReduceShapes(t.shape,e),a=r[0],o=r[1],n=ops.zeros(a,t.dtype),i=util.sizeFromShape(o),s=n.dataSync(),u=t.dataSync(),p=0;p<s.length;++p){for(var h=p*i,l=u[0],f=0;f<i;++f){var c=u[h+f];if(isNaN(c)){l=Number.NaN;break}c<l&&(l=c)}s[p]=l}return n},t.prototype.minimum=function(t,e){return this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.min(t,e)})},t.prototype.max=function(t,e){axis_util.assertAxesAreInnerMostDims("max",e,t.rank);for(var r=axis_util.computeOutAndReduceShapes(t.shape,e),a=r[0],o=r[1],n=ops.zeros(a,t.dtype),i=util.sizeFromShape(o),s=n.dataSync(),u=t.dataSync(),p=0;p<s.length;++p){for(var h=p*i,l=u[h],f=0;f<i;++f){var c=u[h+f];if(isNaN(c)){l=Number.NaN;break}l<c&&(l=c)}s[p]=l}return n},t.prototype.maximum=function(t,e){return this.broadcastedBinaryOp(t,e,t.dtype,function(t,e){return Math.max(t,e)})},t.prototype.ceil=function(t){for(var e=t.dataSync(),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.ceil(e[a]);return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.floor=function(t){for(var e=t.dataSync(),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.floor(e[a]);return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.exp=function(t){for(var e=t.dataSync(),r=new Float32Array(e.length),a=0;a<e.length;++a)r[a]=Math.exp(e[a]);return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.log=function(t){for(var e=t.dataSync(),r=new Float32Array(e.length),a=0;a<e.length;++a){var o=e[a];r[a]=Math.log(o)}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.sqrt=function(t){for(var e=t.dataSync(),r=new Float32Array(e.length),a=0;a<e.length;++a){var o=e[a];r[a]=Math.sqrt(o)}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.square=function(t){for(var e=t.dataSync(),r=new Float32Array(e.length),a=0;a<e.length;++a){var o=e[a];r[a]=o*o}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.relu=function(t){for(var e=ops.zeros(t.shape,t.dtype),r=e.dataSync(),a=t.dataSync(),o=0;o<a.length;++o){var n=a[o];util.isValNaN(n,t.dtype)?r[o]=util.getNaN(e.dtype):r[o]=Math.max(0,a[o])}return e},t.prototype.elu=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a){var o=r[a];e[a]=0<=o?o:Math.exp(o)-1}return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.eluDer=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a){var o=r[a];e[a]=0<=o?1:Math.exp(o)}return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.selu=function(t){for(var e=selu_util.SELU_SCALEALPHA,r=selu_util.SELU_SCALE,a=new Float32Array(t.size),o=t.dataSync(),n=0;n<o.length;++n){var i=o[n];a[n]=0<=i?r*i:e*(Math.exp(i)-1)}return tensor_1.Tensor.make(t.shape,{values:a})},t.prototype.leakyRelu=function(t,e){for(var r=new Float32Array(t.size),a=t.dataSync(),o=0;o<a.length;o++){var n=a[o];r[o]=0<=n?n:e*n}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.prelu=function(t,e){for(var r=new Float32Array(t.size),a=t.dataSync(),o=e.dataSync(),n=0;n<a.length;n++){var i=a[n];r[n]=0<=i?i:o[n]*i}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.preluDer=function(t,e){for(var r=new Float32Array(t.size),a=t.dataSync(),o=e.dataSync(),n=0;n<a.length;n++){var i=a[n];r[n]=0<i?1:i<0?o[n]:i}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.clip=function(t,e,r){for(var a=new Float32Array(t.size),o=t.dataSync(),n=0;n<o.length;++n)a[n]=Math.min(r,Math.max(e,o[n]));return tensor_1.Tensor.make(t.shape,{values:a})},t.prototype.abs=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.abs(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.int=function(t){for(var e=new Int32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=r[a];return tensor_1.Tensor.make(t.shape,{values:e},"int32")},t.prototype.sigmoid=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=1/(1+Math.exp(-r[a]));return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.sin=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.sin(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.cos=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.cos(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.tan=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.tan(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.asin=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.asin(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.acos=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.acos(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.atan=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.atan(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.sinh=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.sinh(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.cosh=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=Math.cosh(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.tanh=function(t){for(var e=new Float32Array(t.size),r=t.dataSync(),a=0;a<r.length;++a)e[a]=util.tanh(r[a]);return tensor_1.Tensor.make(t.shape,{values:e})},t.prototype.step=function(t,e){void 0===e&&(e=0);for(var r=new Float32Array(t.size),a=t.dataSync(),o=0;o<a.length;++o){var n=a[o];util.isValNaN(n,t.dtype)?r[o]=util.getNaN(t.dtype):r[o]=0<n?1:e}return tensor_1.Tensor.make(t.shape,{values:r})},t.prototype.conv2d=function(t,e,r){for(var a=r.filterHeight,o=r.filterWidth,n=r.padInfo.left,i=r.padInfo.top,s=ops.buffer(r.outShape,t.dtype),u=0;u<r.batchSize;++u)for(var p=0;p<r.outChannels;++p)for(var h=0;h<r.outHeight;++h)for(var l=h*r.strideHeight-n,f=Math.max(0,l),c=Math.min(r.inHeight,a+l),d=0;d<r.outWidth;++d){for(var y=d*r.strideWidth-i,v=Math.max(0,y),g=Math.min(r.inWidth,o+y),m=0,N=f;N<c;++N)for(var b=N-l,S=v;S<g;++S)for(var w=S-y,_=0;_<r.inChannels;++_){m+=t.get(u,N,S,_)*e.get(b,w,_,p)}s.set(m,u,h,d,p)}return s.toTensor()},t.prototype.conv2dDerInput=function(t,e,r){for(var a=r.filterHeight,o=r.filterWidth,n=a-1-r.padInfo.top,i=o-1-r.padInfo.left,s=r.strideHeight,u=r.strideWidth,p=ops.buffer(r.inShape,"float32"),h=0;h<r.batchSize;++h)for(var l=0;l<r.inChannels;++l)for(var f=0;f<r.inHeight;++f)for(var c=f-i,d=Math.max(0,Math.ceil(c/s)),y=Math.min(r.outHeight,(a+c)/s),v=0;v<r.inWidth;++v){for(var g=v-n,m=Math.max(0,Math.ceil(g/u)),N=Math.min(r.outWidth,(o+g)/u),b=0,S=d;S<y;++S)for(var w=S*s-c,_=m;_<N;++_)for(var M=_*u-g,x=0;x<r.outChannels;++x){b+=t.get(h,S,_,x)*e.get(a-1-w,o-1-M,l,x)}p.set(b,h,f,v,l)}return p.toTensor()},t.prototype.conv2dDerFilter=function(t,e,r){for(var a=r.strideHeight,o=r.strideWidth,n=r.filterHeight,i=r.filterWidth,s=ops.buffer(r.filterShape,"float32"),u=r.padInfo.left,p=r.padInfo.top,h=0;h<n;++h)for(var l=Math.max(0,Math.ceil((p-h)/a)),f=Math.min(r.outHeight,(r.inHeight+p-h)/a),c=0;c<i;++c)for(var d=Math.max(0,Math.ceil((u-c)/o)),y=Math.min(r.outWidth,(r.inWidth+u-c)/o),v=0;v<r.inChannels;++v)for(var g=0;g<r.outChannels;++g){for(var m=0,N=0;N<r.batchSize;++N)for(var b=l;b<f;++b)for(var S=h+b*a-p,w=d;w<y;++w){var _=c+w*o-u;m+=t.get(N,S,_,v)*e.get(N,b,w,g)}s.set(m,h,c,v,g)}return s.toTensor()},t.prototype.depthwiseConv2D=function(t,e,r){for(var a=r.filterHeight,o=r.filterWidth,n=r.padInfo.left,i=r.padInfo.top,s=r.outChannels/r.inChannels,u=ops.buffer(r.outShape,t.dtype),p=0;p<r.batchSize;++p)for(var h=0;h<r.inChannels;++h)for(var l=0;l<r.outHeight;++l)for(var f=l*r.strideHeight-n,c=Math.max(0,f),d=Math.min(r.inHeight,a+f),y=0;y<r.outWidth;++y)for(var v=y*r.strideWidth-i,g=Math.max(0,v),m=Math.min(r.inWidth,o+v),N=0;N<s;++N){for(var b=0,S=c;S<d;++S)for(var w=S-f,_=g;_<m;++_){var M=_-v;b+=t.get(p,S,_,h)*e.get(w,M,h,N)}u.set(b,p,l,y,h*s+N)}return u.toTensor()},t.prototype.tile=function(t,e){for(var r=new Array(t.rank),a=0;a<r.length;a++)r[a]=t.shape[a]*e[a];for(var o=ops.buffer(r,t.dtype),n=t.dataSync(),a=0;a<o.values.length;++a){for(var i=o.indexToLoc(a),s=new Array(t.rank),u=0;u<s.length;u++)s[u]=i[u]%t.shape[u];var p=t.locToIndex(s);o.values[a]=n[p]}return o.toTensor()},t.prototype.pad1D=function(t,e,r){for(var a=e[0],o=e[1],n=t.dataSync(),i=ops.zeros([a+n.length+o],t.dtype),s=i.dataSync(),u=0,p=0;p<s.length;p++)a<=p&&p<a+n.length?s[p]=n[u++]:s[p]=r;return i},t.prototype.pad2D=function(t,e,r){for(var a=e[0][0],o=e[0][1],n=e[1][0],i=e[1][1],s=[a+t.shape[0]+o,n+t.shape[1]+i],u=ops.zeros(s,t.dtype),p=u.dataSync(),h=t.dataSync(),l=0,f=0;f<s[0];f++){var c=-1,d=-1;a<=f&&f<s[0]-o&&(d=(c=f*s[1]+n)+t.shape[1]-1);for(var y=0;y<s[1];y++){var v=f*s[1]+y;p[v]=c<=v&&v<=d?h[l++]:r}}return u},t.prototype.transpose=function(t,e){for(var r=new Array(t.rank),a=0;a<r.length;a++)r[a]=t.shape[e[a]];for(var o=new Float32Array(t.size),n=t.dataSync(),i=tensor_1.Tensor.make(r,{values:o}),a=0;a<t.size;++a){for(var s=t.indexToLoc(a),u=new Array(s.length),p=0;p<u.length;p++)u[p]=s[e[p]];o[i.locToIndex(u)]=n[a]}return i},t.prototype.gather=function(t,e,r){var a=t.shape.slice(),o=e.dataSync();a[r]=o.length;for(var n=ops.zeros(a,t.dtype),i=t.dataSync(),s=n.dataSync(),u=0;u<n.size;++u){var p=n.indexToLoc(u),h=p.slice();h[r]=o[p[r]];var l=t.locToIndex(h);s[u]=i[l]}return n},t.prototype.pool=function(t,e,r){for(var a=e.strideHeight,o=e.strideWidth,n=e.filterHeight,i=e.filterWidth,s=ops.buffer(e.outShape,"float32"),u=e.padInfo.top,p=e.padInfo.left,h=0;h<e.batchSize;++h)for(var l=0;l<e.inChannels;++l)for(var f=0;f<e.outHeight;++f)for(var c=f*a-u,d=Math.max(0,c),y=Math.min(e.inHeight,n+c),v=0;v<e.outWidth;++v){for(var g=v*o-p,m=Math.max(0,g),N=Math.min(e.inWidth,i+g),b="max"===r?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,S=0,w=d;w<y;++w){for(var _=m;_<N;++_){var M=t.get(h,w,_,l);if(isNaN(M)){S=b=NaN;break}"max"===r&&b<M||"min"===r&&M<b?b=M:"avg"===r&&(S+=M/(n*i))}if(isNaN(b))break}s.set("avg"===r?S:b,h,f,v,l)}return s.toTensor()},t.prototype.maxPool=function(t,e){return this.pool(t,e,"max")},t.prototype.maxPoolPositions=function(t,e){for(var r=ops.buffer(e.outShape,"int32"),a=e.strideHeight,o=e.strideWidth,n=e.filterHeight,i=e.filterWidth,s=e.padInfo.top,u=e.padInfo.left,p=0;p<e.batchSize;++p)for(var h=0;h<e.inChannels;++h)for(var l=0;l<e.outHeight;++l)for(var f=l*a-s,c=Math.max(0,f),d=Math.min(e.inHeight,n+f),y=0;y<e.outWidth;++y){for(var v=y*o-u,g=Math.max(0,v),m=Math.min(e.inWidth,i+v),N=Number.NEGATIVE_INFINITY,b=-1,S=c;S<d;++S)for(var w=S-f,_=g;_<m;++_){var M=_-v,x=t.get(p,S,_,h);N<x&&(N=x,b=w*i+M)}r.set(b,p,l,y,h)}return r.toTensor()},t.prototype.maxPoolBackprop=function(t,e,r){for(var a=this.maxPoolPositions(e,r),o=r.strideHeight,n=r.strideWidth,i=r.filterHeight,s=r.filterWidth,u=s-1-r.padInfo.left,p=i-1-r.padInfo.top,h=ops.buffer(e.shape,"float32"),l=0;l<r.batchSize;++l)for(var f=0;f<r.inChannels;++f)for(var c=0;c<r.inHeight;++c)for(var d=0;d<r.inWidth;++d){for(var y=c-p,v=d-u,g=0,m=0;m<i;++m){var N=(y+m)/o;if(!(N<0||N>=r.outHeight||Math.floor(N)!==N))for(var b=0;b<s;++b){var S,w=(v+b)/n;w<0||w>=r.outWidth||Math.floor(w)!==w||0!=(S=i*s-1-a.get(l,N,w,f)===m*s+b?1:0)&&(g+=t.get(l,N,w,f)*S)}}h.set(g,l,c,d,f)}return h.toTensor()},t.prototype.avgPoolBackprop=function(t,e,r){for(var a=r.strideHeight,o=r.strideWidth,n=r.filterHeight,i=r.filterWidth,s=i-1-r.padInfo.left,u=n-1-r.padInfo.top,p=ops.buffer(e.shape,"float32"),h=1/(n*i),l=0;l<r.batchSize;++l)for(var f=0;f<r.inChannels;++f)for(var c=0;c<r.inHeight;++c)for(var d=0;d<r.inWidth;++d){for(var y=c-u,v=d-s,g=0,m=0;m<n;++m){var N=(y+m)/a;if(!(N<0||N>=r.outHeight||Math.floor(N)!==N))for(var b=0;b<i;++b){var S=(v+b)/o;S<0||S>=r.outWidth||Math.floor(S)!==S||(g+=t.get(l,N,S,f))}}p.set(g*h,l,c,d,f)}return p.toTensor()},t.prototype.minPool=function(t,e){return this.pool(t,e,"min")},t.prototype.avgPool=function(t,e){return this.pool(t,e,"avg").toFloat()},t.prototype.resizeBilinear=function(t,e,r,a){for(var o=t.shape,n=o[0],i=o[1],s=o[2],u=o[3],p=ops.buffer([n,e,r,u],t.dtype),h=a?[i-1,s-1]:[i,s],l=a?[e-1,r-1]:[e,r],f=0;f<n;f++)for(var c=0;c<e;c++)for(var d=0;d<r;d++)for(var y=0;y<u;y++){var v=h[0]*c/l[0],g=h[1]*d/l[1],m=Math.floor(v),N=Math.min(i-1,Math.ceil(v)),b=Math.floor(g),S=Math.min(s-1,Math.ceil(g)),w=t.get(f,m,b,y),_=t.get(f,N,b,y),M=g-b,x=w+(t.get(f,m,S,y)-w)*M,T=x+(_+(t.get(f,N,S,y)-_)*M-x)*(v-m);p.set(T,f,c,d,y)}return p.toTensor()},t.prototype.batchNormalization4D=function(t,e,r,a,o,n){for(var i=t.dataSync(),s=e.dataSync(),u=r.dataSync(),p=o?o.dataSync():new Float32Array([1]),h=n?n.dataSync():new Float32Array([0]),l=new Float32Array(i.length),f=0;f<i.length;f++)l[f]=h[f%h.length]+(i[f]-s[f%s.length])*p[f%p.length]/Math.sqrt(u[f%u.length]+a);return ops_1.tensor4d(l,t.shape)},t.prototype.localResponseNormalization4D=function(s,t,e,r,a,o){for(var n=ops.buffer(s.shape,"float32"),u=t,p=n.shape[1]-1,h=n.shape[2]-1,l=n.shape[3]-1,i=function(t,e,r,a){for(var o=0,n=Math.max(0,a-u);n<=Math.min(a+u,l);n++){var i=s.get(t,e,r,n);o+=i*i}return o},f=function(t,e,r,a){for(var o=0,n=Math.max(0,e-u);n<=Math.min(e+u,p);n++)for(var i=Math.max(0,r-u);i<=Math.min(r+u,h);i++)o+=Math.pow(s.get(t,n,i,a),2);return o},c=0;c<n.shape[0];c++)for(var d=0;d<=n.shape[1];d++)for(var y=0;y<n.shape[2];y++)for(var v=0;v<n.shape[3];v++){var g=("withinChannel"===o?f:i)(c,d,y,v),m=s.get(c,d,y,v)*Math.pow(e+r*g,-a);n.set(m,c,d,y,v)}return n.toTensor()},t.prototype.multinomial=function(t,e,r){for(var a=t.shape[0],o=t.shape[1],n=ops.zeros([a,e],"int32"),i=n.dataSync(),s=t.dataSync(),u=0;u<a;++u){var p=u*o,h=new Float32Array(o-1);h[0]=s[p];for(var l=1;l<h.length;++l)h[l]=h[l-1]+s[p+l];for(var f=seedrandom.alea(r.toString()),c=u*e,d=0;d<e;++d){var y=f();i[c+d]=h.length;for(var v=0;v<h.length;v++)if(y<h[v]){i[c+d]=v;break}}}return n},t.prototype.oneHot=function(t,e,r,a){var o=new Float32Array(t.size*e);o.fill(a);for(var n=0;n<t.size;++n)o[n*e+t.get(n)]=r;return ops.tensor2d(o,[t.size,e])},t.prototype.broadcastedBinaryOp=function(i,s,t,u){for(var e=broadcast_util.assertAndGetBroadcastShape(i.shape,s.shape),p=ops.buffer(e,t),h=i.dataSync(),l=s.dataSync(),f=broadcast_util.getBroadcastDims(i.shape,e),c=broadcast_util.getBroadcastDims(s.shape,e),r=function(t){var e=p.indexToLoc(t),r=e.slice(-i.rank);f.forEach(function(t){return r[t]=0});var a=i.locToIndex(r),o=e.slice(-s.rank);c.forEach(function(t){return o[t]=0});var n=s.locToIndex(o);p.values[t]=u(h[a],l[n])},a=0;a<p.values.length;++a)r(a);return p.toTensor()},t.prototype.dispose=function(){},t}();exports.MathBackendCPU=MathBackendCPU,environment_1.ENV.registerBackend("cpu",function(){return new MathBackendCPU});var NDArrayMathCPU=function(e){function t(t){void 0===t&&(t=!1);return console.warn("new NDArrayMathCPU() is deprecated. Please use dl.setBackend('cpu')."),e.call(this,"cpu",t)||this}return __extends(t,e),t}(math_1.NDArrayMath);exports.NDArrayMathCPU=NDArrayMathCPU;