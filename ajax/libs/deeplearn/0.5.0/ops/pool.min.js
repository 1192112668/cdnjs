"use strict";var __decorate=this&&this.__decorate||function(n,e,o,a){var r,t=arguments.length,i=t<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,o):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(n,e,o,a);else for(var s=n.length-1;0<=s;s--)(r=n[s])&&(i=(t<3?r(i):3<t?r(e,o,i):r(e,o))||i);return 3<t&&i&&Object.defineProperty(e,o,i),i};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),environment_1=require("../environment"),util=require("../util"),conv_util=require("./conv_util"),operation_1=require("./operation"),Ops=function(){function p(){}return p.maxPool=function(n,o,a,r,e){var t=n,i=!1;3===n.rank&&(i=!0,t=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===t.rank,"Error in maxPool: input must be rank 4 but got rank "+t.rank+"."),null!=e&&util.assert(util.isInt(r),"Error in maxPool: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+r+".");var s=conv_util.computePool2DInfo(t.shape,o,a,r,e),u=environment_1.ENV.engine.executeKernel("MaxPool",{inputs:{x:t},args:{convInfo:s}},function(n,e){return{x:function(){return p.maxPoolBackprop(n,t,o,a,r)}}});return i?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u},p.maxPoolBackprop=function(n,e,o,a,r,t){util.assert(e.rank===n.rank,"Rank of input ("+e.rank+") does not match rank of dy ("+n.rank+")");var i=e,s=n,u=!1;3===e.rank&&(u=!0,i=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),s=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===s.rank,"Error in maxPoolBackprop: dy must be rank 4 but got rank "+s.rank+"."),util.assert(4===i.rank,"Error in maxPoolBackprop: input must be rank 4 but got rank "+i.rank+"."),null!=t&&util.assert(util.isInt(r),"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+t+" but got pad "+r+".");var p=conv_util.computePool2DInfo(i.shape,o,a,r,t),l=environment_1.ENV.engine.executeKernel("MaxPoolBackprop",{inputs:{dy:s,x:i},args:{convInfo:p}});return u?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l},p.minPool=function(n,e,o,a,r){var t=n,i=!1;3===n.rank&&(i=!0,t=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===t.rank,"Error in minPool: x must be rank 4 but got rank "+t.rank+"."),null!=r&&util.assert(util.isInt(a),"Error in minPool: pad must be an integer when using, dimRoundingMode "+r+" but got pad "+a+".");var s=conv_util.computePool2DInfo(t.shape,e,o,a,r),u=environment_1.ENV.engine.executeKernel("MinPool",{inputs:{x:t},args:{convInfo:s}});return i?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u},p.avgPool=function(n,o,a,r,e){var t=n,i=!1;3===n.rank&&(i=!0,t=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===t.rank,"Error in avgPool: x must be rank 4 but got rank "+t.rank+"."),null!=e&&util.assert(util.isInt(r),"Error in avgPool: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+r+".");var s=conv_util.computePool2DInfo(t.shape,o,a,r),u=environment_1.ENV.engine.executeKernel("AvgPool",{inputs:{x:t},args:{convInfo:s}},function(n,e){return{x:function(){return p.avgPoolBackprop(n,t,o,a,r)}}});return i?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u},p.avgPoolBackprop=function(n,e,o,a,r){util.assert(e.rank===n.rank,"Rank of input ("+e.rank+") does not match rank of dy ("+n.rank+")");var t=e,i=n,s=!1;3===e.rank&&(s=!0,t=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),i=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),util.assert(4===i.rank,"Error in avgPoolBackprop: dy must be rank 4 but got rank "+i.rank+"."),util.assert(4===t.rank,"Error in avgPoolBackprop: input must be rank 4 but got rank "+t.rank+".");var u=conv_util.computePool2DInfo(t.shape,o,a,r),p=environment_1.ENV.engine.executeKernel("AvgPoolBackprop",{inputs:{dy:i,x:t},args:{convInfo:u}});return s?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p},__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],p,"maxPool",null),__decorate([operation_1.operation],p,"maxPoolBackprop",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],p,"minPool",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Convolution"}),operation_1.operation],p,"avgPool",null),__decorate([operation_1.operation],p,"avgPoolBackprop",null),p}();exports.Ops=Ops;