"use strict";var __decorate=this&&this.__decorate||function(e,a,n,r){var i,t=arguments.length,o=t<3?a:null===r?r=Object.getOwnPropertyDescriptor(a,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,a,n,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(o=(t<3?i(o):3<t?i(a,n,o):i(a,n))||o);return 3<t&&o&&Object.defineProperty(a,n,o),o};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),environment_1=require("../environment"),globals_1=require("../globals"),tensor_1=require("../tensor"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),ops=require("./ops"),Ops=function(){function e(){}return e.logSumExp=function(e,a,n){void 0===a&&(a=null),void 0===n&&(n=!1);var r=axis_util.parseAxisParam(a,e.shape),i=e.max(r,!0),t=e.sub(i).exp().sum(r).log(),o=i.reshape(t.shape).add(t);if(n){var s=axis_util.expandShapeToKeepDim(o.shape,r);return o.reshape(s)}return o},e.sum=function(e,a,o){void 0===a&&(a=null),void 0===o&&(o=!1);var s=axis_util.parseAxisParam(a,e.shape);return globals_1.customGrad(function(n){var e=axis_util.getAxesPermutation(s,n.rank),a=s,r=n;null!=e&&(r=n.transpose(e),a=axis_util.getInnerMostAxes(a.length,n.rank));var i,t=environment_1.ENV.engine.executeKernel("Sum",{inputs:{x:r},args:{axes:a}});o&&(i=axis_util.expandShapeToKeepDim(t.shape,s),t=t.reshape(i));return{value:t,gradFunc:function(e){var a=n.shape.slice();return s.forEach(function(e){a[e]=1}),e.reshape(a).mul(tensor_1.Tensor.ones(n.shape,"float32"))}}})(e)},e.mean=function(e,a,i){void 0===a&&(a=null),void 0===i&&(i=!1);var t=axis_util.parseAxisParam(a,e.shape),n=axis_util.computeOutAndReduceShapes(e.shape,t)[1],o=util.sizeFromShape(n);return globals_1.customGrad(function(n){var r=ops.scalar(o);return{value:n.div(r).sum(a,i),gradFunc:function(e){var a=n.shape.slice();return t.forEach(function(e){a[e]=1}),e.reshape(a).mul(tensor_1.Tensor.ones(n.shape,"float32")).div(r)}}})(e)},e.min=function(e,a,n){void 0===a&&(a=null),void 0===n&&(n=!1);var r=axis_util.parseAxisParam(a,e.shape),i=r,t=axis_util.getAxesPermutation(i,e.rank);null!=t&&(e=e.transpose(t),i=axis_util.getInnerMostAxes(i.length,e.rank));var o=environment_1.ENV.engine.executeKernel("Min",{inputs:{x:e},args:{axes:i}});if(n){var s=axis_util.expandShapeToKeepDim(o.shape,r);return o.reshape(s)}return o},e.max=function(e,a,n){void 0===a&&(a=null),void 0===n&&(n=!1);var r=axis_util.parseAxisParam(a,e.shape),i=r,t=axis_util.getAxesPermutation(i,e.rank);null!=t&&(e=e.transpose(t),i=axis_util.getInnerMostAxes(i.length,e.rank));var o=environment_1.ENV.engine.executeKernel("Max",{inputs:{x:e},args:{axes:i}});if(n){var s=axis_util.expandShapeToKeepDim(o.shape,r);return o.reshape(s)}return o},e.argMin=function(e,a){void 0===a&&(a=null);var n=axis_util.parseAxisParam(a,e.shape),r=axis_util.getAxesPermutation(n,e.rank);return null!=r&&(e=e.transpose(r),n=axis_util.getInnerMostAxes(n.length,e.rank)),environment_1.ENV.engine.executeKernel("ArgMin",{inputs:{x:e},args:{axes:n}})},e.argMax=function(e,a){void 0===a&&(a=null);var n=axis_util.parseAxisParam(a,e.shape),r=axis_util.getAxesPermutation(n,e.rank);return null!=r&&(e=e.transpose(r),n=axis_util.getInnerMostAxes(n.length,e.rank)),environment_1.ENV.engine.executeKernel("ArgMax",{inputs:{x:e},args:{axes:n}})},e.moments=function(e,a,n){void 0===a&&(a=null),void 0===n&&(n=!1);var r=axis_util.parseAxisParam(a,e.shape),i=e.mean(r,n),t=i.shape;n||(t=axis_util.expandShapeToKeepDim(i.shape,r));var o=e.toFloat().sub(i.reshape(t)).square();return{mean:i,variance:o.mean(r,n)}},__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"logSumExp",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"sum",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"mean",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"min",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"max",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"argMin",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Reduction"}),operation_1.operation],e,"argMax",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Normalization"}),operation_1.operation],e,"moments",null),e}();exports.Ops=Ops;