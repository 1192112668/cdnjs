"use strict";var __decorate=this&&this.__decorate||function(e,t,r,a){var n,i=arguments.length,o=i<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,a);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(o=(i<3?n(o):3<i?n(t,r,o):n(t,r))||o);return 3<i&&o&&Object.defineProperty(t,r,o),o};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),environment_1=require("../environment"),util=require("../util"),broadcast_util=require("./broadcast_util"),operation_1=require("./operation"),ops_1=require("./ops"),Ops=function(){function e(){}return e.add=function(a,n){util.assertTypesMatch(a,n);var i=broadcast_util.assertAndGetBroadcastShape(a.shape,n.shape);return environment_1.ENV.engine.executeKernel("Add",{inputs:{a:a,b:n}},function(r,e){return{a:function(){var e=r,t=broadcast_util.getReductionAxes(a.shape,i);return 0<t.length&&(e=e.sum(t)),e.reshape(a.shape)},b:function(){var e=r,t=broadcast_util.getReductionAxes(n.shape,i);return 0<t.length&&(e=e.sum(t)),e.reshape(n.shape)}}})},e.addStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in addStrict: "),e.add(t)},e.sub=function(a,n){util.assertTypesMatch(a,n);var i=broadcast_util.assertAndGetBroadcastShape(a.shape,n.shape);return environment_1.ENV.engine.executeKernel("Sub",{inputs:{a:a,b:n}},function(r,e){return{a:function(){var e=r,t=broadcast_util.getReductionAxes(a.shape,i);return 0<t.length&&(e=e.sum(t)),e.reshape(a.shape)},b:function(){var e=r,t=broadcast_util.getReductionAxes(n.shape,i);return 0<t.length&&(e=e.sum(t)),e.neg().reshape(n.shape)}}})},e.subStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in subStrict: "),e.sub(t)},e.pow=function(r,a){util.assert("int32"===a.dtype,"only supports int32 data type for the exponent parameter."),broadcast_util.assertAndGetBroadcastShape(r.shape,a.shape);return environment_1.ENV.engine.executeKernel("Pow",{inputs:{base:r,exp:a}},function(t,e){if(!util.arraysEqual(r.shape,a.shape)&&!util.isScalarShape(a.shape))throw new Error("Gradient of pow not yet supported for broadcasted shapes.");return{base:function(){var e=a.toFloat().mul(r.pow(a.sub(ops_1.scalar(1,"int32"))).toFloat());return t.mul(e)},exp:function(){throw new Error("Backprop through exponent not implemented yet.")}}})},e.powStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in powStrict: "),e.pow(t)},e.mul=function(a,n){util.assertTypesMatch(a,n);var i=broadcast_util.assertAndGetBroadcastShape(a.shape,n.shape);return environment_1.ENV.engine.executeKernel("Mul",{inputs:{a:a,b:n}},function(r,e){return{a:function(){var e=r.mul(n.toFloat()),t=broadcast_util.getReductionAxes(a.shape,i);return 0<t.length?e.sum(t).reshape(a.shape):e},b:function(){var e=r.mul(a.toFloat()),t=broadcast_util.getReductionAxes(n.shape,i);return 0<t.length?e.sum(t).reshape(n.shape):e}}})},e.mulStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in multiplyStrict: "),e.mul(t)},e.div=function(n,i){var o=broadcast_util.assertAndGetBroadcastShape(n.shape,i.shape);return environment_1.ENV.engine.executeKernel("Div",{inputs:{a:n,b:i}},function(a,e){return{a:function(){var e=a.div(i.toFloat()),t=broadcast_util.getReductionAxes(n.shape,o);return 0<t.length?e.sum(t).reshape(n.shape):e},b:function(){var e=a.mul(n.toFloat()),t=broadcast_util.getReductionAxes(i.shape,o);0<t.length&&(e=e.sum(t).reshape(i.shape));var r=i.square();return e.div(r.toFloat()).neg()}}})},e.divStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in divideStrict: "),e.div(t)},e.minimum=function(r,a){util.assertTypesMatch(r,a),broadcast_util.assertAndGetBroadcastShape(r.shape,a.shape);return environment_1.ENV.engine.executeKernel("Minimum",{inputs:{a:r,b:a}},function(e,t){return{a:function(){return e.mul(r.lessEqual(a).toFloat())},b:function(){return e.mul(r.greater(a).toFloat())}}})},e.minimumStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in minimumStrict: "),e.minimum(t)},e.maximum=function(r,a){util.assertTypesMatch(r,a),broadcast_util.assertAndGetBroadcastShape(r.shape,a.shape);return environment_1.ENV.engine.executeKernel("Maximum",{inputs:{a:r,b:a}},function(e,t){return{a:function(){return e.mul(r.greaterEqual(a).toFloat())},b:function(){return e.mul(r.less(a).toFloat())}}})},e.maximumStrict=function(e,t){return util.assertShapesMatch(e.shape,t.shape,"Error in minimumStrict: "),e.maximum(t)},__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"add",null),__decorate([operation_1.operation],e,"addStrict",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"sub",null),__decorate([operation_1.operation],e,"subStrict",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"pow",null),__decorate([operation_1.operation],e,"powStrict",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"mul",null),__decorate([operation_1.operation],e,"mulStrict",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"div",null),__decorate([operation_1.operation],e,"divStrict",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"minimum",null),__decorate([operation_1.operation],e,"minimumStrict",null),__decorate([doc_1.doc({heading:"Operations",subheading:"Arithmetic"}),operation_1.operation],e,"maximum",null),__decorate([operation_1.operation],e,"maximumStrict",null),e}();exports.Ops=Ops;