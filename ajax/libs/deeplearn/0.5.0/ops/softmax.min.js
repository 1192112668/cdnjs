"use strict";var __decorate=this&&this.__decorate||function(e,o,r,t){var a,n=arguments.length,s=n<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,o,r,t);else for(var i=e.length-1;0<=i;i--)(a=e[i])&&(s=(n<3?a(s):3<n?a(o,r,s):a(o,r))||s);return 3<n&&s&&Object.defineProperty(o,r,s),s};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("../doc"),globals_1=require("../globals"),util=require("../util"),axis_util=require("./axis_util"),operation_1=require("./operation"),ops=require("./ops"),Ops=function(){function e(){}return e.softmax=function(e,t){if(void 0===t&&(t=-1),-1===t&&(t=e.rank-1),t!==e.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and dim was "+t);return globals_1.customGrad(function(e){var o=e.logSumExp([t],!0),r=e.toFloat().sub(o).exp();return{value:r,gradFunc:function(e){var o=e.mul(r);return o.sub(o.sum([t],!0).mul(r))}}})(e)},e.softmaxCrossEntropy=function(e,o,a){if(void 0===a&&(a=-1),util.assertShapesMatch(e.shape,o.shape,"Error in softmaxCrossEntropy: "),-1===a&&(a=o.rank-1),a!==o.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+o.rank+" and dim was "+a);return globals_1.customGrad(function(r,e){var t=e.softmax(a);return{value:ops.scalar(1e-5).add(t).log().mul(r).neg().sum([a]),gradFunc:function(e){var o=axis_util.expandShapeToKeepDim(e.shape,[a]);return[e.reshape(o).mul(r.toFloat().sub(t)),e.reshape(o).mul(t.sub(r.toFloat()))]}}})(e,o)},__decorate([doc_1.doc({heading:"Operations",subheading:"Normalization"}),operation_1.operation],e,"softmax",null),__decorate([doc_1.doc({heading:"Training",subheading:"Losses",namespace:"losses"}),operation_1.operation],e,"softmaxCrossEntropy",null),e}();exports.Ops=Ops;