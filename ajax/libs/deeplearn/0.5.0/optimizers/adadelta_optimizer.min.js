"use strict";var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,a){e.__proto__=a}||function(e,a){for(var t in a)a.hasOwnProperty(t)&&(e[t]=a[t])};return function(e,a){function t(){this.constructor=e}r(e,a),e.prototype=null===a?Object.create(a):(t.prototype=a.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),globals_1=require("../globals"),tensor_array_map_1=require("../graph/tensor_array_map"),ops_1=require("../ops/ops"),tensor_1=require("../tensor"),tensor_2=require("../tensor"),optimizer_1=require("./optimizer"),AdadeltaOptimizer=function(u){function e(e,a,t,r){void 0===r&&(r=1e-8);var s=u.call(this,e,t)||this;return s.accumulatedGrads={},s.accumulatedUpdates={},s.accumulatedSquaredGradientsGraph=new tensor_array_map_1.TensorArrayMap,s.accumulatedUpdatesGraph=new tensor_array_map_1.TensorArrayMap,s.c=globals_1.keep(ops_1.scalar(-e)),s.epsilon=globals_1.keep(ops_1.scalar(r)),s.rho=globals_1.keep(ops_1.scalar(a)),s.oneMinusRho=globals_1.keep(ops_1.scalar(1-a)),s}return __extends(e,u),e.prototype.applyGradients=function(e){function a(s){var o=environment_1.ENV.engine.registeredVariables[s];null==t.accumulatedGrads[s]&&globals_1.tidy(function(){d.accumulatedGrads[s]=tensor_2.variable(ops_1.zerosLike(o),!1)}),null==t.accumulatedUpdates[s]&&globals_1.tidy(function(){d.accumulatedUpdates[s]=tensor_2.variable(ops_1.zerosLike(o),!1)});var u=e[s],i=t.accumulatedGrads[s],n=t.accumulatedUpdates[s];globals_1.tidy(function(){var e=d.rho.mul(i).add(d.oneMinusRho.mul(u.square())),a=n.add(d.epsilon).sqrt().div(i.add(d.epsilon).sqrt()).mul(u),t=d.rho.mul(n).add(d.oneMinusRho.mul(a.square()));d.accumulatedGrads[s].assign(e),d.accumulatedUpdates[s].assign(t);var r=d.c.mul(a).add(o);o.assign(r)})}var d=this,t=this;for(var r in e)a(r)},e.prototype.beforeBatch=function(e,a,t,r,s){var o=this;u.prototype.beforeBatch.call(this,e,a,t,r,s),0===this.accumulatedSquaredGradientsGraph.size()&&this.variableNodes.forEach(function(e){o.accumulatedSquaredGradientsGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape)),o.accumulatedUpdatesGraph.set(e.output,tensor_1.Tensor.zeros(e.output.shape))})},e.prototype.afterBatch=function(l,e,a,c,t){var h=this;null==this.one&&(this.one=globals_1.keep(ops_1.scalar(1))),globals_1.tidy(function(){h.variableNodes.forEach(function(e){var a=c.get(e.output),t=h.variableGradients.get(e.output),r=h.accumulatedSquaredGradientsGraph.get(e.output),s=h.accumulatedUpdatesGraph.get(e.output),o=l.multiply(t,t),u=l.scaledArrayAdd(h.rho,r,l.subtract(h.one,h.rho),o),i=l.multiply(l.divide(l.sqrt(l.add(s,h.epsilon)),l.sqrt(l.add(r,h.epsilon))),t),n=l.scaledArrayAdd(h.cGraph,i,h.one,a),d=l.multiply(i,i),p=l.scaledArrayAdd(h.rho,s,l.subtract(h.one,h.rho),d);h.accumulatedSquaredGradientsGraph.set(e.output,globals_1.keep(u)),h.accumulatedUpdatesGraph.set(e.output,globals_1.keep(p)),c.set(e.output,globals_1.keep(n)),e.data=n,a.dispose(),r.dispose(),s.dispose()})}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},e.prototype.dispose=function(){var a=this;u.prototype.dispose.call(this),this.c.dispose(),this.epsilon.dispose(),this.rho.dispose(),this.oneMinusRho.dispose(),null!=this.one&&this.one.dispose(),null!=this.accumulatedSquaredGradientsGraph&&this.accumulatedSquaredGradientsGraph.dispose(),null!=this.accumulatedUpdatesGraph&&this.accumulatedUpdatesGraph.dispose(),null!=this.accumulatedUpdates&&(Object.keys(this.accumulatedUpdates).forEach(function(e){return a.accumulatedUpdates[e].dispose()}),Object.keys(this.accumulatedGrads).forEach(function(e){return a.accumulatedGrads[e].dispose()}))},e}(optimizer_1.Optimizer);exports.AdadeltaOptimizer=AdadeltaOptimizer;