"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(u,a,o,s){return new(o=o||Promise)(function(t,e){function r(t){try{i(s.next(t))}catch(t){e(t)}}function n(t){try{i(s.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new o(function(t){t(e.value)}).then(r,n)}i((s=s.apply(u,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,u,a,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,u&&(a=u[2&e[0]?"return":e[0]?"throw":"next"])&&!(a=a.call(u,e[1])).done)return a;switch(u=0,a&&(e=[0,a.value]),e[0]){case 0:case 1:a=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,u=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(a=0<(a=o.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){o.label=e[1];break}if(6===e[0]&&o.label<a[1]){o.label=a[1],a=e;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(e);break}a[2]&&o.ops.pop(),o.trys.pop();continue}e=n.call(r,o)}catch(t){e=[6,t],u=0}finally{i=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),growing_ring_buffer_1=require("../util/growing_ring_buffer"),ring_buffer_1=require("../util/ring_buffer");function streamFromItems(t){return new ArrayStream(t)}function streamFromIncrementing(t){var e=t;return streamFromFunction(function(){return e++})}function streamFromFunction(t){return new FunctionCallStream(t)}function streamFromConcatenated(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,ChainedStream.create(e)]})})}function streamFromConcatenatedFunction(e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,streamFromConcatenated(streamFromFunction(e).take(r))]})})}exports.streamFromItems=streamFromItems,exports.streamFromIncrementing=streamFromIncrementing,exports.streamFromFunction=streamFromFunction,exports.streamFromConcatenated=streamFromConcatenated,exports.streamFromConcatenatedFunction=streamFromConcatenatedFunction;var DataStream=function(){function t(){}return t.prototype.collectRemaining=function(){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return e=[],[4,this.next()];case 1:r=t.sent(),t.label=2;case 2:return null==r?[3,4]:(e.push(r),[4,this.next()]);case 3:return r=t.sent(),[3,2];case 4:return[2,e]}})})},t.prototype.resolveFully=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.next()];case 1:e=t.sent(),t.label=2;case 2:return null==e?[3,4]:[4,this.next()];case 3:return e=t.sent(),[3,2];case 4:return[2]}})})},t.prototype.filter=function(t){return new FilterStream(this,t)},t.prototype.map=function(t){return new MapStream(this,t)},t.prototype.forEach=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.map(e).resolveFully()]})})},t.prototype.batch=function(t,e){return void 0===e&&(e=!0),new BatchStream(this,t,e)},t.prototype.concatenate=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,ChainedStream.create(new ArrayStream([this,e]))]})})},t.prototype.take=function(t){return t<0||null==t?this:new TakeStream(this,t)},t.prototype.skip=function(t){return t<0||null==t?this:new SkipStream(this,t)},t.prototype.prefetch=function(t){return new PrefetchStream(this,t)},t.prototype.shuffle=function(t,e){return new ShuffleStream(this,t,e)},t}(),ArrayStream=function(r){function t(t){var e=r.call(this)||this;return e.items=t,e.trav=0,e}return __extends(t,r),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){return this.trav>=this.items.length?[2,void 0]:(e=this.items[this.trav],this.trav++,[2,e])})})},t}(exports.DataStream=DataStream),FunctionCallStream=function(r){function t(t){var e=r.call(this)||this;return e.nextFn=t,e}return __extends(t,r),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.nextFn()]})})},t}(DataStream),SkipStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.maxCount=e,r.count=0,r}return __extends(t,n),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.count++<this.maxCount?[4,this.upstream.next()]:[3,2];case 1:return null==t.sent()?[2,void 0]:[3,0];case 2:return[2,this.upstream.next()]}})})},t}(DataStream),TakeStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.maxCount=e,r.count=0,r}return __extends(t,n),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.count++>=this.maxCount?[2,void 0]:[2,this.upstream.next()]})})},t}(DataStream),QueueStream=function(e){function t(){var t=e.call(this)||this;return t.outputQueue=new growing_ring_buffer_1.GrowingRingBuffer,t}return __extends(t,e),t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return 0!==this.outputQueue.length()?[3,2]:[4,this.pump()];case 1:return t.sent()?[3,0]:[2,void 0];case 2:return[2,this.outputQueue.shift()]}})})},t}(DataStream),BatchStream=function(i){function t(t,e,r){void 0===r&&(r=!0);var n=i.call(this)||this;return n.upstream=t,n.batchSize=e,n.enableSmallLastBatch=r,n.currentBatch=[],n}return __extends(t,i),t.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.upstream.next()];case 1:return null==(e=t.sent())?this.enableSmallLastBatch&&0<this.currentBatch.length?(this.outputQueue.push(this.currentBatch),this.currentBatch=[],[2,!0]):[2,!1]:(this.currentBatch.push(e),this.currentBatch.length===this.batchSize&&(this.outputQueue.push(this.currentBatch),this.currentBatch=[]),[2,!0])}})})},t}(exports.QueueStream=QueueStream),FilterStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.predicate=e,r}return __extends(t,n),t.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return[4,this.upstream.next()];case 1:return null==(e=t.sent())?[2,!1]:(r=this.predicate(e))instanceof Promise?[4,r]:[3,3];case 2:r=t.sent(),t.label=3;case 3:return r&&this.outputQueue.push(e),[2,!0]}})})},t}(QueueStream),MapStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.transform=e,r}return __extends(t,n),t.prototype.pump=function(){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return[4,this.upstream.next()];case 1:return null==(e=t.sent())?[2,!1]:(r=this.transform(e))instanceof Promise?[4,r]:[3,3];case 2:r=t.sent(),t.label=3;case 3:return this.outputQueue.push(r),[2,!0]}})})},t}(QueueStream),ChainState=function(t,e,r){this.item=t,this.currentStream=e,this.moreStreams=r};function nextChainState(i){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return[4,i];case 1:return e=t.sent(),null==(r=e.currentStream)?[2,new ChainState(void 0,void 0,e.moreStreams)]:[4,r.next()];case 2:return null!=(n=t.sent())?[3,4]:[4,e.moreStreams.next()];case 3:return r=t.sent(),[2,nextChainState(Promise.resolve(new ChainState(void 0,r,e.moreStreams)))];case 4:return[2,new ChainState(n,r,e.moreStreams)]}})})}var ChainedStream=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return __extends(i,t),i.create=function(n){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return e=new i,[4,n.next()];case 1:return r=t.sent(),e.currentPromise=Promise.resolve(new ChainState(void 0,r,n)),[2,e]}})})},i.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.currentPromise=nextChainState(this.currentPromise),[4,this.currentPromise];case 1:return[2,t.sent().item]}})})},i}(DataStream);exports.ChainedStream=ChainedStream;var PrefetchStream=function(n){function t(t,e){var r=n.call(this)||this;return r.upstream=t,r.bufferSize=e,r.total=0,r.buffer=new ring_buffer_1.RingBuffer(e),r}return __extends(t,n),t.prototype.refill=function(){for(;!this.buffer.isFull();){var t=this.upstream.next();if(null==t)return;this.buffer.push(t)}},t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.refill(),this.buffer.isEmpty()?[2,void 0]:[4,this.buffer.shift()];case 1:return e=t.sent(),this.refill(),[2,e]}})})},t}(DataStream),ShuffleStream=function(i){function t(t,e,r){var n=i.call(this,t,e)||this;return n.upstream=t,n.windowSize=e,n.upstreamExhausted=!1,n.random=seedrandom(r),n}return __extends(t,i),t.prototype.randomInt=function(t){return Math.floor(this.random()*t)},t.prototype.chooseIndex=function(){return this.randomInt(this.buffer.length())},t.prototype.next=function(){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:this.upstreamExhausted||this.refill(),t.label=1;case 1:return this.buffer.isEmpty()?[3,3]:(e=this.chooseIndex(),[4,this.buffer.shuffleExcise(e)]);case 2:return null!=(r=t.sent())?(this.refill(),[2,r]):(this.upstreamExhausted=!0,[3,1]);case 3:return[2,void 0]}})})},t}(exports.PrefetchStream=PrefetchStream);exports.ShuffleStream=ShuffleStream;