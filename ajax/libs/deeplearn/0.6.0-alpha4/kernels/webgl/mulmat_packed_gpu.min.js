"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MatrixOrientation,gpgpu_context_1=require("./gpgpu_context"),webgl_util=require("./webgl_util");function getFragmentShaderSource(t,e,r){var a=Math.ceil(t/2),i=e===MatrixOrientation.REGULAR?"center, resultUV.t":"resultUV.t, center",n=r===MatrixOrientation.REGULAR?"resultUV.s, center":"center, resultUV.s",o=e===MatrixOrientation.REGULAR?["a.xxzz","a.yyww"]:["a.xxyy","a.zzww"],x=r===MatrixOrientation.REGULAR?["b.xyxy","b.zwzw"]:["b.xzxz","b.ywyw"];return"\n    precision highp float;\n    uniform sampler2D matrixA;\n    uniform sampler2D matrixB;\n    varying vec2 resultUV;\n\n    const float sharedDimension = "+a+".0;\n\n    vec4 dot2x2ARowBCol() {\n      vec4 result = vec4(0, 0, 0, 0);\n      for (int ii = 0; ii < "+a+"; ii++) {\n        float i = float(ii);\n        float center = (i + 0.5) / sharedDimension;\n        vec4 a = texture2D(matrixA, vec2("+i+"));\n        vec4 b = texture2D(matrixB, vec2("+n+"));\n        result +=\n          ("+o[0]+" * "+x[0]+") + ("+o[1]+" * "+x[1]+");\n      }\n      return result;\n    }\n\n    void main() {\n      gl_FragColor = dot2x2ARowBCol();\n    }"}function multiplyMatrixPacked(t,e,r,a,i,n){t.setOutputPackedMatrixTexture(i,n[0],n[1]),t.setProgram(e);var o=webgl_util.getProgramUniformLocationOrThrow(t.gl,e,"matrixA"),x=webgl_util.getProgramUniformLocationOrThrow(t.gl,e,"matrixB");t.setInputMatrixTexture(r,o,0),t.setInputMatrixTexture(a,x,1),t.executeProgram()}function uploadMultiplyMatrixPackedDownload(t,e,r,a,i,n){void 0===i&&(i=MatrixOrientation.REGULAR),void 0===n&&(n=MatrixOrientation.REGULAR);var o=i===MatrixOrientation.REGULAR?e[0]:e[1],x=n===MatrixOrientation.REGULAR?a[1]:a[0],u=i===MatrixOrientation.REGULAR?e[1]:e[0],l=new gpgpu_context_1.GPGPUContext,c=l.createProgram(getFragmentShaderSource(u,i,n)),d=l.createPackedMatrixTexture(e[0],e[1]),M=l.createPackedMatrixTexture(a[0],a[1]),p=l.createPackedMatrixTexture(o,x);l.uploadMatrixToPackedTexture(d,e[0],e[1],t),l.uploadMatrixToPackedTexture(M,a[0],a[1],r),multiplyMatrixPacked(l,c,d,M,p,[o,x]);var s=l.downloadMatrixFromPackedTexture(p,o,x);return l.deleteMatrixTexture(d),l.deleteMatrixTexture(M),l.deleteMatrixTexture(p),l.deleteProgram(c),l.dispose(),s}!function(t){t[t.REGULAR=0]="REGULAR",t[t.TRANSPOSED=1]="TRANSPOSED"}(MatrixOrientation=exports.MatrixOrientation||(exports.MatrixOrientation={})),exports.getFragmentShaderSource=getFragmentShaderSource,exports.multiplyMatrixPacked=multiplyMatrixPacked,exports.uploadMultiplyMatrixPackedDownload=uploadMultiplyMatrixPackedDownload;