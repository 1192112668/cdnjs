"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computePool2DInfo(t,e,o,n,r,a){void 0===a&&(a="channelsLast");var i,u=parseTupleParam(e),l=u[0],f=u[1];if("channelsLast"===a)i=[l,f,t[3],t[3]];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);i=[l,f,t[1],t[1]]}return computeConv2DInfo(t,i,o,1,n,r,!1,a)}function computeConv2DInfo(t,e,o,n,r,a,i,u){void 0===i&&(i=!1),void 0===u&&(u="channelsLast");var l=[-1,-1,-1,-1],f=l[0],s=l[1],h=l[2],c=l[3];if("channelsLast"===u)f=t[0],s=t[1],h=t[2],c=t[3];else{if("channelsFirst"!==u)throw new Error("Unknown dataFormat "+u);f=t[0],c=t[1],s=t[2],h=t[3]}var p,d=e[0],m=e[1],g=e[3],v=parseTupleParam(o),I=v[0],P=v[1],w=parseTupleParam(n),D=w[0],M=w[1],b=getPadAndOutInfo(r,s,h,I,P,getEffectiveFilterSize(d,D),getEffectiveFilterSize(m,M),a),F=b.padInfo,S=b.outHeight,C=b.outWidth,E=i?g*c:g;return"channelsFirst"===u?p=[f,E,S,C]:"channelsLast"===u&&(p=[f,S,C,E]),{batchSize:f,dataFormat:u,inHeight:s,inWidth:h,inChannels:c,outHeight:S,outWidth:C,outChannels:E,padInfo:F,strideHeight:I,strideWidth:P,filterHeight:d,filterWidth:m,inShape:t,outShape:p,filterShape:e}}function computeOutputShape3D(t,e,o,n,r,a){null==r&&(r=computeDefaultPad(t,e,n));var i=t[0],u=t[1],l=conditionalRound((i-e+2*r)/n+1,a);util.assert(util.isInt(l),"The output # of rows ("+l+") must be an integer. Change the stride and/or zero pad parameters");var f=conditionalRound((u-e+2*r)/n+1,a);return util.assert(util.isInt(f),"The output # of columns ("+f+") must be an integer. Change the stride and/or zero pad parameters"),[l,f,o]}function computeDefaultPad(t,e,o){return Math.floor((t[0]*(o-1)-o+e)/2)}function parseTupleParam(t){return"number"==typeof t?[t,t]:t}function getEffectiveFilterSize(t,e){return e<=1?t:t+(t-1)*(e-1)}function getPadAndOutInfo(t,e,o,n,r,a,i,u){if("number"==typeof t){g={top:t,bottom:t,left:t,right:t};var l=computeOutputShape3D([e,o,1],a,1,n,t,u),f=l[0],s=l[1]}else if("same"===t)var h=((f=Math.ceil(e/n))-1)*n+a-e,c=((s=Math.ceil(o/r))-1)*r+i-o,p=Math.floor(h/2),d=h-p,m=Math.floor(c/2),g={top:p,bottom:d,left:m,right:c-m};else{if("valid"!==t)throw Error("Unknown padding parameter: "+t);g={top:0,bottom:0,left:0,right:0},f=Math.ceil((e-a+1)/n),s=Math.ceil((o-i+1)/r)}return{padInfo:g,outHeight:f,outWidth:s}}function conditionalRound(t,e){if(!e)return t;switch(e){case"round":return Math.round(t);case"ceil":return Math.ceil(t);case"floor":return Math.floor(t);default:throw new Error("Unknown roundingMode "+e)}}exports.computePool2DInfo=computePool2DInfo,exports.computeConv2DInfo=computeConv2DInfo,exports.computeDefaultPad=computeDefaultPad;