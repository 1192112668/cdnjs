"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("./environment"),backend_cpu_1=require("./math/backends/backend_cpu"),backend_webgl_1=require("./math/backends/backend_webgl"),math_1=require("./math/math"),ndarray_1=require("./math/ndarray"),util=require("./util");function mean(e){for(var r=0,t=0;t<e.length;t++)r+=e[t];return r/e.length}function standardDeviation(e,r){for(var t=0,n=0;n<e.length;n++){var a=e[n]-r;t+=a*a}return Math.sqrt(t/e.length)}function kurtosis(e){for(var r=mean(e),t=e.length,n=0,a=0,o=0;o<t;o++){var s=e[o]-r;n+=Math.pow(s,2),a+=Math.pow(s,4)}return 1/t*a/Math.pow(1/t*n,2)}function skewness(e){for(var r=mean(e),t=e.length,n=0,a=0,o=0;o<t;o++){var s=e[o]-r;n+=Math.pow(s,2),a+=Math.pow(s,3)}return 1/t*a/Math.pow(1/(t-1)*n,1.5)}function jarqueBeraNormalityTest(e){var r=e instanceof ndarray_1.NDArray?e.dataSync():e,t=r.length,n=skewness(r),a=kurtosis(r),o=t/6*(Math.pow(n,2)+.25*Math.pow(a-3,2));if(5.991<o)throw new Error("Invalid p-value for JB: "+o)}function expectArrayInMeanStdRange(e,r,t,n){var a;void 0===n&&(n=exports.TEST_EPSILON);var o=mean(a=e instanceof ndarray_1.NDArray?e.dataSync():e);expectNumbersClose(o,r,n),expectNumbersClose(standardDeviation(a,o),t,n)}function expectArraysClose(e,r,t){if(void 0===t&&(t=exports.TEST_EPSILON),e instanceof ndarray_1.NDArray||r instanceof ndarray_1.NDArray){if(e instanceof ndarray_1.NDArray&&r instanceof ndarray_1.NDArray){if(e.dtype!==r.dtype)throw new Error("Arrays are of different type actual: "+e.dtype+" vs expected: "+r.dtype+".");if(!util.arraysEqual(e.shape,r.shape))throw new Error("Arrays are of different shape actual: "+e.shape+" vs expected: "+r.shape+".")}}else{var n=e.constructor.name,a=r.constructor.name;if(n!==a)throw new Error("Arrays are of different type actual: "+n+" vs expected: "+a)}var o=e instanceof ndarray_1.NDArray?e.dataSync():e,s=r instanceof ndarray_1.NDArray?r.dataSync():r;if(o.length!==s.length)throw new Error("Arrays have different lengths actual: "+o.length+" vs expected: "+s.length+".\nActual:   "+o+".\nExpected: "+s+".");for(var c=0;c<s.length;++c){var u=o[c],i=s[c];if(!areClose(u,Number(i),t))throw new Error("Arrays differ: actual["+c+"] = "+u+", expected["+c+"] = "+i+".\nActual:   "+o+".\nExpected: "+s+".")}}function expectArraysEqual(e,r){return expectArraysClose(e,r,0)}function expectNumbersClose(e,r,t){if(void 0===t&&(t=exports.TEST_EPSILON),!areClose(e,r,t))throw new Error("Numbers differ: actual === "+e+", expected === "+r)}function areClose(e,r,t){return!(!isNaN(e)||!isNaN(r))||!(isNaN(e)||isNaN(r)||Math.abs(e-r)>t)}function expectValuesInRange(e,r,t){for(var n=e instanceof ndarray_1.NDArray?e.dataSync():e,a=0;a<n.length;a++)if(n[a]<r||n[a]>t)throw new Error("Value out of range:"+n[a]+" low: "+r+", high: "+t)}function randomArrayInRange(e,r,t){for(var n=new Float32Array(e),a=t-r,o=0;o<e;++o)n[o]=Math.random()*a+r;return n}function makeIdentity(e){for(var r=new Float32Array(e*e),t=0;t<e;++t)r[t*e+t]=1;return r}function cpuMultiplyMatrix(e,r,t,n,a,o){for(var s=new Float32Array(r*o),c=0;c<r;++c)for(var u=c*t,i=c*o,f=0;f<o;++f){for(var d=0,l=0;l<t;++l)d+=e[u+l]*n[l*o+f];s[i+f]=d}return s}function cpuDotProduct(e,r){if(e.length!==r.length)throw new Error("cpuDotProduct: incompatible vectors.");for(var t=0,n=0;n<e.length;++n)t+=e[n]*r[n];return t}function describeMathCPU(e,r,t){describeWithFeaturesAndExecutor("CPU: math."+e,r,function(e,r,t){return executeMathTests(e,r,function(){return new math_1.NDArrayMath(new backend_cpu_1.MathBackendCPU,!0)},t)},t)}function describeMathGPU(e,r,t){describeWithFeaturesAndExecutor("WebGL: math."+e,r,function(e,r,t){return executeMathTests(e,r,function(){return new math_1.NDArrayMath(new backend_webgl_1.MathBackendWebGL,!0)},t)},t)}function describeCustom(e,r,t,n,a){describeWithFeaturesAndExecutor(e,[r],function(e,r,t){return executeTests(e,r,t,n,a)},t)}function describeWithFeaturesAndExecutor(t,n,a,e){null!=e?e.forEach(function(e){var r=t+" "+JSON.stringify(e);a(r,n,e)}):a(t,n)}function resolveTestFuncPromise(t){return function(r){var e=t();e instanceof Promise?e.then(r,function(e){fail(e),r()}):r()}}exports.TEST_EPSILON=.01,exports.mean=mean,exports.standardDeviation=standardDeviation,exports.kurtosis=kurtosis,exports.skewness=skewness,exports.jarqueBeraNormalityTest=jarqueBeraNormalityTest,exports.expectArrayInMeanStdRange=expectArrayInMeanStdRange,exports.expectArraysClose=expectArraysClose,exports.expectArraysEqual=expectArraysEqual,exports.expectNumbersClose=expectNumbersClose,exports.expectValuesInRange=expectValuesInRange,exports.randomArrayInRange=randomArrayInRange,exports.makeIdentity=makeIdentity,exports.cpuMultiplyMatrix=cpuMultiplyMatrix,exports.cpuDotProduct=cpuDotProduct,exports.describeMathCPU=describeMathCPU,exports.describeMathGPU=describeMathGPU,exports.describeCustom=describeCustom;var PROMISE_IT=function(e,r){it(e,resolveTestFuncPromise(r))},PROMISE_FIT=function(e,r){fit(e,resolveTestFuncPromise(r))},PROMISE_XIT=function(e,r){xit(e,resolveTestFuncPromise(r))};function executeMathTests(e,r,t,n){var a;executeTests(e,r,n,function(){a=t(),environment_1.ENV.setMath(a),a.startScope()},function(){a.endScope(null),a.dispose()},function(e,r){PROMISE_IT(e,function(){return r(a)})},function(e,r){PROMISE_FIT(e,function(){return r(a)})},function(e,r){PROMISE_XIT(e,function(){return r(a)})})}function executeTests(e,r,t,n,a,o,s,c){void 0===o&&(o=PROMISE_IT),void 0===s&&(s=PROMISE_FIT),void 0===c&&(c=PROMISE_XIT),describe(e,function(){beforeEach(function(){null!=t&&(environment_1.ENV.setFeatures(t),environment_1.ENV.registerBackend("webgl",function(){return new backend_webgl_1.MathBackendWebGL}),environment_1.ENV.registerBackend("cpu",function(){return new backend_cpu_1.MathBackendCPU})),null!=n&&n()}),afterEach(function(){null!=a&&a(),null!=t&&environment_1.ENV.reset()}),r.forEach(function(e){return e(o,s,c)})})}function assertIsNan(e,r){if(!util.isValNaN(e,r))throw new Error("Value "+e+" does not represent NaN for dtype "+r)}exports.executeMathTests=executeMathTests,exports.assertIsNan=assertIsNan;