"use strict";var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var ndarray_1=require("../../math/ndarray"),optimizer_1=require("../../math/optimizers/optimizer"),tensor_array_map_1=require("../tensor_array_map"),AdamOptimizer=function(i){function t(t,e,r,a){var o=i.call(this,t,a)||this;return o.learningRate=t,o.beta1=e,o.beta2=r,o.firstMoment=new tensor_array_map_1.TensorArrayMap,o.secondMoment=new tensor_array_map_1.TensorArrayMap,o.eps=ndarray_1.Scalar.new(1e-8),o.b1=ndarray_1.Scalar.new(o.beta1),o.b2=ndarray_1.Scalar.new(o.beta2),o.accB1=ndarray_1.Scalar.new(o.beta1),o.accB2=ndarray_1.Scalar.new(o.beta2),o}return __extends(t,i),t.prototype.applyGradients=function(t){throw new Error("Adam optimizer not yet implemented for eager mode.")},t.prototype.beforeBatch=function(t,e,r,a,o){var s=this;i.prototype.beforeBatch.call(this,t,e,r,a,o),0===this.firstMoment.size()&&this.variableNodes.forEach(function(t){s.firstMoment.set(t.output,ndarray_1.NDArray.zeros(t.output.shape))}),0===this.secondMoment.size()&&this.variableNodes.forEach(function(t){s.secondMoment.set(t.output,ndarray_1.NDArray.zeros(t.output.shape))})},t.prototype.afterBatch=function(y,t,e,_,r){var m=this;y.scope(function(u){m.variableNodes.forEach(function(t){var e=_.get(t.output),r=m.variableGradients.get(t.output),a=m.firstMoment.get(t.output),o=m.secondMoment.get(t.output),s=y.scaledArrayAdd(m.b1,a,y.subtract(m.one,m.b1),r),i=y.multiply(r,r),n=y.scaledArrayAdd(m.b2,o,y.subtract(m.one,m.b2),i),p=y.divide(s,y.subtract(m.one,m.accB1)),c=y.divide(n,y.subtract(m.one,m.accB2)),d=y.scaledArrayAdd(m.cGraph,y.divide(p,y.add(y.sqrt(c),m.eps)),m.one,e);_.set(t.output,u(d)),t.data=d,m.firstMoment.set(t.output,u(s)),m.secondMoment.set(t.output,u(n)),e.dispose(),r.dispose(),a.dispose(),o.dispose()});var t=m.accB1,e=m.accB2;m.accB1=u(y.multiply(m.accB1,m.b1)),m.accB2=u(y.multiply(m.accB2,m.b2)),t.dispose(),e.dispose()}),this.variableGradients.dispose(),this.variableGradients=new tensor_array_map_1.TensorArrayMap},t.prototype.dispose=function(){i.prototype.dispose.call(this),this.firstMoment.dispose(),this.secondMoment.dispose(),this.eps.dispose(),this.b1.dispose(),this.b2.dispose(),this.accB1.dispose(),this.accB2.dispose()},t}(optimizer_1.Optimizer);exports.AdamOptimizer=AdamOptimizer;