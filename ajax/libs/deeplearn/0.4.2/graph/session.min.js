"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CostReduction,ndarray_1=require("../math/ndarray"),util=require("../util"),operation_emitter=require("./operation_emitter"),session_util=require("./session_util"),tensor_array_map_1=require("./tensor_array_map"),FeedDictionary=function(t){var e=this;this.dict={},t&&t.forEach(function(t){return e.dict[t.tensor.id]=t})};exports.FeedDictionary=FeedDictionary,function(t){t[t.NONE=0]="NONE",t[t.SUM=1]="SUM",t[t.MEAN=2]="MEAN"}(CostReduction=exports.CostReduction||(exports.CostReduction={}));var Session=function(){function t(t,e){this.math=e,this.activationArrayMap=new tensor_array_map_1.TensorArrayMap,this.runtimeCache={},this.oneScalar=ndarray_1.Scalar.new(1),this.gradientArrayMap=new tensor_array_map_1.SummedTensorArrayMap(this.math)}return t.prototype.dispose=function(){var r=this;this.activationArrayMap.dispose(),Object.keys(this.runtimeCache).forEach(function(t){var e=r.runtimeCache[t];e.operations&&e.operations.forEach(function(t){return t.dispose()})}),this.runtimeCache={},null!=this.batchSizeScalar&&this.batchSizeScalar.dispose(),this.oneScalar.dispose()},t.prototype.evalAll=function(i,o){var n=this;return this.math.scope(function(){var t=new FeedDictionary(o),e=n.getOrCreateRuntime(i,t),r=n.activationArrayMap;session_util.disposeAndInitializeOperationOutputs(e.nodes,r),session_util.disposeTransientOperationArrays(e.operations,n.activationArrayMap,n.gradientArrayMap),session_util.addPersistentArraysToTensorArrayMap(e.nodes,r),session_util.loadInputsFromFeedDictionaryToTensorArrayMap(t,r,n.math),e.operations.forEach(function(t){return t.feedForward(n.math,r)});var a=i.map(function(t){return r.get(t)});return i.forEach(function(t){return r.delete(t)}),session_util.releaseFeedDictionaryInputsFromTensorArrayMap(t,r,n.math),a})},t.prototype.eval=function(t,e){return this.evalAll([t],e)[0]},t.prototype.train=function(r,t,a,i,o){var n=this;void 0===o&&(o=CostReduction.NONE),util.assert(util.isScalarShape(r.shape),"Cost tensor for training must be a scalar value."),this.prevBatchSize!==a&&(this.prevBatchSize=a,null!=this.batchSizeScalar&&this.batchSizeScalar.dispose(),this.batchSizeScalar=this.math.keep(ndarray_1.Scalar.new(a)));var s=new FeedDictionary(t);session_util.throwIfFeedDictionaryContainsNDArrays(s);var u=this.getOrCreateRuntime([r],s),c=u.operations,p=u.operations.slice().reverse(),h=this.activationArrayMap,d=this.gradientArrayMap;return d.nullify(r),d.add(r,this.oneScalar),session_util.addPersistentArraysToTensorArrayMap(u.nodes,h),i.beforeBatch(this.math,a,u,h,d),this.math.scope(function(){for(var t=ndarray_1.Scalar.new(0),e=0;e<a;++e)session_util.disposeAndInitializeOperationOutputs(u.nodes,h),session_util.disposeAndInitializeOperationInputGradients(u.nodes,d),session_util.disposeTransientOperationArrays(u.operations,h,d),session_util.loadInputsFromFeedDictionaryToTensorArrayMap(s,h,n.math),c.forEach(function(t){return t.feedForward(n.math,h)}),p.forEach(function(t){return t.backProp(n.math,h,d)}),i.afterExample(n.math,u,h,d),session_util.releaseFeedDictionaryInputsFromTensorArrayMap(s,h,n.math),t=n.updateCostForExample(t,h.get(r),o);return i.afterBatch(n.math,a,u,h,d),n.updateCostForBatch(t,o)})},t.prototype.updateCostForExample=function(t,e,r){return r===CostReduction.MEAN||r===CostReduction.SUM?this.math.add(t,e):t},t.prototype.updateCostForBatch=function(t,e){return e===CostReduction.MEAN?this.math.divide(t,this.batchSizeScalar):t},t.prototype.getOrCreateRuntime=function(t,e){var r,a=this.makeRuntimeCacheKey(t,e),i=this.runtimeCache[a];return void 0===i&&(r=session_util.getOrderedEvaluationSetFromEvalTensor(t,e),session_util.removeFeedDictionaryNodesFromEvaluationSet(e,r),session_util.throwErrorIfEvaluationSetContainsPlaceholderNodes(r),i={nodes:r,operations:operation_emitter.emitFromGraphNodes(r)},this.runtimeCache[a]=i),i},t.prototype.makeRuntimeCacheKey=function(t,e){return t.map(function(t){return t.id}).sort().join("_")+"__"+Object.keys(e.dict).sort().join("_")},t}();exports.Session=Session;