"use strict";var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])};return function(t,o){function e(){this.constructor=t}r(t,o),t.prototype=null===o?Object.create(o):(e.prototype=o.prototype,new e)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),ndarray_1=require("../../math/ndarray"),util=require("../../util"),graph_1=require("../graph"),graph_util=require("../graph_util"),op_1=require("./op"),Softmax=function(r){function t(t,o){var e=r.call(this)||this;return e.logitsTensor=t,e.output=o,e}return __extends(t,r),t.prototype.feedForward=function(o,e){var r=this,s=e.get(this.logitsTensor);return o.scope(function(t){e.set(r.output,t(o.softmax(s)))})},t.prototype.backProp=function(o,t,e){var r=this,s=t.get(this.output),n=e.get(this.output);o.scope(function(){var t;graph_util.shouldBackProp(r.logitsTensor)&&(t=o.elementWiseMul(o.subtract(n,o.sum(o.elementWiseMul(n,s))),s),e.add(r.logitsTensor,t))})},t}(op_1.Operation);exports.Softmax=Softmax;var SoftmaxCrossEntropyCost=function(s){function t(t,o,e){var r=s.call(this)||this;return r.logitsTensor=t,r.labelTensor=o,r.yTensor=e,r.softmaxTensor=new graph_1.Tensor(t.shape),r.epsilon=environment_1.ENV.math.keep(ndarray_1.Scalar.new(1e-5)),r}return __extends(t,s),t.prototype.feedForward=function(e,r){var s=this,n=r.get(this.logitsTensor),i=r.get(this.labelTensor);e.scope(function(t){var o=e.softmax(n);r.set(s.softmaxTensor,t(o)),r.set(s.yTensor,t(crossEntropyCost(e,o,i,s.epsilon)))})},t.prototype.backProp=function(t,o,e){var r=this,s=o.get(this.softmaxTensor),n=o.get(this.labelTensor);t.scope(function(){e.add(r.logitsTensor,t.subtract(s,n))})},t.prototype.disposeTransientArrays=function(t,o){t.disposeArray(this.softmaxTensor)},t.prototype.dispose=function(){this.epsilon.dispose()},t}(op_1.Operation);function crossEntropyCost(s,n,i,a){return util.assert(n.size===i.size,"The output and target must be the same size"),s.scope(function(){var t=s.scalarPlusArray(a,n),o=s.log(t),e=s.elementWiseMul(i,o),r=s.neg(e);return s.sum(r)})}exports.SoftmaxCrossEntropyCost=SoftmaxCrossEntropyCost,exports.crossEntropyCost=crossEntropyCost;