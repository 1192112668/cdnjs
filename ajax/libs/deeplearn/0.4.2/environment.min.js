"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Type,device_util=require("./device_util"),math_1=require("./math/math"),util=require("./util");function getWebGLRenderingContext(e){if(0===e)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var t=document.createElement("canvas");return 1===e?t.getContext("webgl")||t.getContext("experimental-webgl"):t.getContext("webgl2")}function loseContext(e){if(null!=e){var t=e.getExtension("WEBGL_lose_context");if(null==t)throw new Error("Extension WEBGL_lose_context not supported on this browser.");t.loseContext()}}function isWebGLVersionEnabled(e){var t=getWebGLRenderingContext(e);return null!=t&&(loseContext(t),!0)}function isWebGLDisjointQueryTimerEnabled(e){var t=getWebGLRenderingContext(e),n=1===e?"EXT_disjoint_timer_query":"EXT_disjoint_timer_query_webgl2",r=null!=t.getExtension(n);return null!=t&&loseContext(t),r}function isFloatTextureReadPixelsEnabled(e){if(0===e)return!1;var t=getWebGLRenderingContext(e);if(1===e){if(null==t.getExtension("OES_texture_float"))return!1}else if(null==t.getExtension("EXT_color_buffer_float"))return!1;var n=t.createFramebuffer(),r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);var i=2===e?t.RGBA32F:t.RGBA;t.texImage2D(t.TEXTURE_2D,0,i,1,1,0,t.RGBA,t.FLOAT,null),t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);var o=t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE;t.readPixels(0,0,1,1,t.RGBA,t.FLOAT,new Float32Array(4));var a=t.getError()===t.NO_ERROR;return loseContext(t),o&&a}function isWebGLGetBufferSubDataAsyncExtensionEnabled(e){if(2!==e)return!1;var t=getWebGLRenderingContext(e),n=null!=t.getExtension("WEBGL_get_buffer_sub_data_async");return loseContext(t),n}!function(e){e[e.NUMBER=0]="NUMBER",e[e.BOOLEAN=1]="BOOLEAN"}(Type=exports.Type||(exports.Type={})),exports.URL_PROPERTIES=[{name:"WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED",type:Type.BOOLEAN},{name:"WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",type:Type.BOOLEAN},{name:"WEBGL_VERSION",type:Type.NUMBER},{name:"WEBGL_FLOAT_TEXTURE_ENABLED",type:Type.BOOLEAN},{name:"WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED",type:Type.BOOLEAN}];var Environment=function(){function e(e){this.features={},this.globalMath=null,this.backendRegistry={},(this.prevBackendRegistry=null)!=e&&(this.features=e)}return e.prototype.get=function(e){return e in this.features||(this.features[e]=this.evaluateFeature(e)),this.features[e]},e.prototype.getBestBackend=function(){for(var e=["webgl","cpu"],t=0;t<e.length;++t){var n=e[t];if(n in this.backendRegistry)return this.backendRegistry[n]}throw new Error("No backend found in registry.")},e.prototype.evaluateFeature=function(e){if("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED"===e){var t=this.get("WEBGL_VERSION");return 0===t?!1:isWebGLDisjointQueryTimerEnabled(t)}if("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE"===e)return this.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED")&&!device_util.isMobile();if("WEBGL_VERSION"===e)return isWebGLVersionEnabled(2)?2:isWebGLVersionEnabled(1)?1:0;if("WEBGL_FLOAT_TEXTURE_ENABLED"===e)return isFloatTextureReadPixelsEnabled(this.get("WEBGL_VERSION"));if("WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED"===e)return isWebGLGetBufferSubDataAsyncExtensionEnabled(this.get("WEBGL_VERSION"));throw new Error("Unknown feature "+e+".")},e.prototype.setFeatures=function(e){this.empty(),this.features=e},e.prototype.reset=function(){if(this.features=getFeaturesFromURL(),null!=this.globalMath&&(this.globalMath.dispose(),this.globalMath=null),null!=this.prevBackendRegistry){for(var e in this.backendRegistry)this.backendRegistry[e].dispose();this.backendRegistry=this.prevBackendRegistry,this.prevBackendRegistry=null}},e.prototype.setMath=function(e){this.globalMath=e},e.prototype.getBackend=function(e){return this.backendRegistry[e]},e.prototype.registerBackend=function(e,t){if(e in this.backendRegistry)throw new Error(e+" backend was already registered");try{var n=t();return this.backendRegistry[e]=n,!0}catch(e){return!1}},Object.defineProperty(e.prototype,"math",{get:function(){var e;return null==this.globalMath&&(e=this.getBestBackend(),this.globalMath=new math_1.NDArrayMath(e,!1)),this.globalMath},enumerable:!0,configurable:!0}),e.prototype.empty=function(){this.globalMath=null,this.prevBackendRegistry=this.backendRegistry,this.backendRegistry={},this.features=null},e}();exports.Environment=Environment;var DEEPLEARNJS_FLAGS_PREFIX="dljsflags";function getFeaturesFromURL(){var t={};if("undefined"==typeof window)return t;var i,e=util.getQueryParams(window.location.search);return DEEPLEARNJS_FLAGS_PREFIX in e&&(i={},e[DEEPLEARNJS_FLAGS_PREFIX].split(",").forEach(function(e){var t=e.split(":"),n=t[0],r=t[1];i[n]=r}),exports.URL_PROPERTIES.forEach(function(e){e.name in i&&(console.log("Setting feature override from URL "+e.name+": "+i[e.name]),e.type===Type.NUMBER?t[e.name]=+i[e.name]:e.type===Type.BOOLEAN?t[e.name]="true"===i[e.name]:console.warn("Unknown URL param: "+e.name+"."))})),t}function getGlobalNamespace(){var e;if("undefined"!=typeof window)e=window;else{if("undefined"==typeof global)throw new Error("Could not find a global object");e=global}return e}function getOrMakeEnvironment(){var e=getGlobalNamespace();return e.ENV=e.ENV||new Environment(getFeaturesFromURL()),e.ENV}exports.ENV=getOrMakeEnvironment();