"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),session_util=require("../../graph/session_util"),tensor_array_map_1=require("../../graph/tensor_array_map"),ndarray_1=require("../../math/ndarray"),Optimizer=function(){function e(e,i){this.learningRate=e,this.variableGradients=new tensor_array_map_1.TensorArrayMap,null!=i&&(this.specifiedVariableNodes=i),this.one=environment_1.ENV.math.keep(ndarray_1.Scalar.new(1))}return e.prototype.minimize=function(e,i){void 0===i&&(i=!1);var t=this.computeGradients(e),r=t.value,a=t.gradients;return this.applyGradients(a),Object.keys(a).forEach(function(e){return a[e].dispose()}),i?r:(r.dispose(),null)},e.prototype.computeGradients=function(e){return environment_1.ENV.math.variableGradients(e)},e.prototype.beforeBatch=function(i,e,t,r,a){var s=this;this.variableNodes=null==this.specifiedVariableNodes?session_util.getVariableNodesFromEvaluationSet(t.nodes):this.specifiedVariableNodes,e!==this.prevBatchSize&&(null!=this.cGraph&&this.cGraph.dispose(),this.prevBatchSize=e,this.cGraph=i.keep(ndarray_1.Scalar.new(-this.learningRate/e))),this.variableNodes.forEach(function(e){return s.variableGradients.set(e.output,i.keep(ndarray_1.NDArray.zeros(e.output.shape)))})},e.prototype.afterExample=function(a,e,i,s){var n=this;a.scope(function(r){n.variableNodes.forEach(function(e){var i=s.get(e.output),t=n.variableGradients.get(e.output);n.variableGradients.set(e.output,r(a.add(i,t))),t.dispose()})})},e.prototype.dispose=function(){null!=this.cGraph&&this.cGraph.dispose(),this.one.dispose(),null!=this.variableNodes&&this.variableNodes.forEach(function(e){e.data.dispose()}),null!=this.specifiedVariableNodes&&this.specifiedVariableNodes.forEach(function(e){e.data.dispose()})},e}();exports.Optimizer=Optimizer;