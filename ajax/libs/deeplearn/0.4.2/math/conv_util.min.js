"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computePool2DInfo(t,e,o,n,r,a){void 0===a&&(a="channelsLast");var u,i=parseTupleParam(e),p=i[0],h=i[1];if("channelsLast"===a)u=[p,h,t[3],t[3]];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);u=[p,h,t[1],t[1]]}return computeConv2DInfo(t,u,o,n,r,!1,a)}function computeConv2DInfo(t,e,o,n,r,a,u){void 0===a&&(a=!1),void 0===u&&(u="channelsLast");var i=[-1,-1,-1,-1],p=i[0],h=i[1],l=i[2],s=i[3];if("channelsLast"===u)p=t[0],h=t[1],l=t[2],s=t[3];else{if("channelsFirst"!==u)throw new Error("Unknown dataFormat "+u);p=t[0],s=t[1],h=t[2],l=t[3]}var c,d=e[0],f=e[1],m=e[3],D=parseTupleParam(o),g=D[0],v=D[1],I=getPadAndOutInfo(n,h,l,g,v,d,f,r),w=I.padInfo,P=I.outHeight,M=I.outWidth,C=a?m*s:m;return"channelsFirst"===u?c=[p,C,P,M]:"channelsLast"===u&&(c=[p,P,M,C]),{batchSize:p,dataFormat:u,inHeight:h,inWidth:l,inChannels:s,outHeight:P,outWidth:M,outChannels:C,padInfo:w,strideHeight:g,strideWidth:v,filterHeight:d,filterWidth:f,inShape:t,outShape:c,filterShape:e}}function computeOutputShape3D(t,e,o,n,r,a){null==r&&(r=computeDefaultPad(t,e,n));var u=t[0],i=t[1],p=conditionalRound((u-e+2*r)/n+1,a);util.assert(util.isInt(p),"The output # of rows ("+p+") must be an integer. Change the stride and/or zero pad parameters");var h=conditionalRound((i-e+2*r)/n+1,a);return util.assert(util.isInt(h),"The output # of columns ("+h+") must be an integer. Change the stride and/or zero pad parameters"),[p,h,o]}function computeDefaultPad(t,e,o){return Math.floor((t[0]*(o-1)-o+e)/2)}function computeWeightsShape4D(t,e,o,n){return[o,n,t,e]}function computeDilatedRC(t,e){return[(t[0]-1)*e+1,(t[1]-1)*e+1]}function parseTupleParam(t){return"number"==typeof t?[t,t]:t}function getPadAndOutInfo(t,e,o,n,r,a,u,i){if("number"==typeof t){D={top:t,bottom:t,left:t,right:t};var p=computeOutputShape3D([e,o,1],a,1,n,t,i),h=p[0],l=p[1]}else if("same"===t)var s=((h=Math.ceil(e/n))-1)*n+a-e,c=((l=Math.ceil(o/r))-1)*r+u-o,d=Math.floor(s/2),f=s-d,m=Math.floor(c/2),D={top:d,bottom:f,left:m,right:c-m};else{if("valid"!==t)throw Error("Unknown padding parameter: "+t);D={top:0,bottom:0,left:0,right:0},h=Math.ceil((e-a+1)/n),l=Math.ceil((o-u+1)/r)}return{padInfo:D,outHeight:h,outWidth:l}}function conditionalRound(t,e){if(!e)return t;switch(e){case"round":return Math.round(t);case"ceil":return Math.ceil(t);case"floor":return Math.floor(t);default:throw new Error("Unknown roundingMode "+e)}}exports.computePool2DInfo=computePool2DInfo,exports.computeConv2DInfo=computeConv2DInfo,exports.computeOutputShape3D=computeOutputShape3D,exports.computeDefaultPad=computeDefaultPad,exports.computeWeightsShape4D=computeWeightsShape4D,exports.computeDilatedRC=computeDilatedRC;