"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t}||function(r,t){for(var a in t)t.hasOwnProperty(a)&&(r[a]=t[a])};return function(r,t){function a(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}(),__awaiter=this&&this.__awaiter||function(o,i,s,u){return new(s=s||Promise)(function(r,t){function a(r){try{n(u.next(r))}catch(r){t(r)}}function e(r){try{n(u.throw(r))}catch(r){t(r)}}function n(t){t.done?r(t.value):new s(function(r){r(t.value)}).then(a,e)}n((u=u.apply(o,i||[])).next())})},__generator=this&&this.__generator||function(a,e){var n,o,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},r={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function t(t){return function(r){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(i=o[2&t[0]?"return":t[0]?"throw":"next"])&&!(i=i.call(o,t[1])).done)return i;switch(o=0,i&&(t=[0,i.value]),t[0]){case 0:case 1:i=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){s.label=t[1];break}if(6===t[0]&&s.label<i[1]){s.label=i[1],i=t;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(t);break}i[2]&&s.ops.pop(),s.trys.pop();continue}t=e.call(a,s)}catch(r){t=[6,r],o=0}finally{n=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,r])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seedrandom=require("seedrandom"),environment_1=require("../../environment"),util=require("../../util"),broadcast_util=require("../broadcast_util"),concat_util=require("../concat_util"),math_1=require("../math"),ndarray_1=require("../ndarray"),types=require("../types"),types_1=require("../types"),axis_util=require("./../axis_util"),matmul_1=require("./types/matmul"),MathBackendCPU=function(){function r(){this.data={},"undefined"!=typeof document&&(this.canvas=document.createElement("canvas"))}return r.prototype.register=function(r,t,a){this.data[r]=null},r.prototype.write=function(r,t){if(null==t)throw new Error("MathBackendCPU.write(): values can not be null");this.throwIfNoData(r),this.data[r]=t},r.prototype.writePixels=function(r,t,a){if(null==t)throw new Error("MathBackendCPU.writePixels(): pixels can not be null");var e;if(this.throwIfNoData(r),t instanceof ImageData)e=t.data;else if(t instanceof HTMLCanvasElement)e=t.getContext("2d").getImageData(0,0,t.width,t.height).data;else{if(!(t instanceof HTMLImageElement||t instanceof HTMLVideoElement))throw new Error("pixels is of unknown type: "+t.constructor.name);if(null==this.canvas)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.getContext("2d").drawImage(t,0,0,t.width,t.height),e=this.canvas.getContext("2d").getImageData(0,0,t.width,t.height).data}if(4===a)o=new Int32Array(e);else for(var n=t.width*t.height,o=new Int32Array(n*a),i=0;i<n;i++)for(var s=0;s<a;++s)o[i*a+s]=e[4*i+s];this.data[r]=o},r.prototype.read=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(r){return this.throwIfNoData(t),[2,this.data[t]]})})},r.prototype.readSync=function(r){return this.throwIfNoData(r),this.data[r]},r.prototype.disposeData=function(r){delete this.data[r]},r.prototype.time=function(a){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(r){return t=performance.now(),a(),[2,performance.now()-t]})})},r.prototype.throwIfNoData=function(r){if(!(r in this.data))throw new Error("No data found for NDArray with data id "+r+". Use dl.ENV.math instead of constructing your own NDArrayMath. If you need to construct your own math, make sure this array is allocated after the math construction")},r.prototype.clone=function(r){return ndarray_1.NDArray.make(r.shape,{values:new Float32Array(r.dataSync())})},r.prototype.slice1D=function(r,t,a){var e=r.dataSync().slice(t,t+a);return ndarray_1.Array1D.new(e)},r.prototype.slice2D=function(r,t,a){for(var e=ndarray_1.Array2D.zeros(a),n=t[0],o=t[1],i=0;i<a[0];++i)for(var s=0;s<a[1];++s){var u=r.get(i+n,s+o);e.set(u,i,s)}return e},r.prototype.slice3D=function(r,t,a){for(var e=ndarray_1.Array3D.zeros(a),n=t[0],o=t[1],i=t[2],s=0;s<a[0];++s)for(var u=0;u<a[1];++u)for(var p=0;p<a[2];++p){var h=r.get(s+n,u+o,p+i);e.set(h,s,u,p)}return e},r.prototype.slice4D=function(r,t,a){for(var e=ndarray_1.Array4D.zeros(a),n=t[0],o=t[1],i=t[2],s=t[3],u=0;u<a[0];++u)for(var p=0;p<a[1];++p)for(var h=0;h<a[2];++h)for(var y=0;y<a[3];++y){var l=r.get(u+n,p+o,h+i,y+s);e.set(l,u,p,h,y)}return e},r.prototype.reverse4D=function(t,a){for(var r=ndarray_1.NDArray.like(t),e=function(r){return-1!==a.indexOf(r)&&1!==t.shape[r]},n=0;n<t.shape[0];++n)for(var o=0;o<t.shape[1];++o)for(var i=0;i<t.shape[2];++i)for(var s=0;s<t.shape[3];++s){var u=e(0)?t.shape[0]-n-1:n,p=e(1)?t.shape[1]-o-1:o,h=e(2)?t.shape[2]-i-1:i,y=e(3)?t.shape[3]-s-1:s,l=t.get(u,p,h,y);r.set(l,n,o,i,s)}return r},r.prototype.concat1D=function(r,t){var a=concat_util.computeOutShape(r.shape,t.shape,0),e=ndarray_1.Array1D.zeros(a),n=r.dataSync(),o=t.dataSync(),i=e.dataSync();return i.set(n,0),i.set(o,r.size),e},r.prototype.concat2D=function(r,t,a){var e=concat_util.computeOutShape(r.shape,t.shape,a),n=ndarray_1.Array2D.zeros(e);if(0===a){var o=r.dataSync(),i=t.dataSync(),s=n.dataSync();return s.set(o,0),s.set(i,r.size),n}for(var u=0;u<e[0];++u)for(var p=0;p<e[1];++p){var h,y,l=[u,p],f=void 0;f=l[a]<r.shape[a]?r.get(u,p):(l[a]-=r.shape[a],h=l[0],y=l[1],t.get(h,y)),n.set(f,u,p)}return n},r.prototype.concat3D=function(r,t,a){var e=concat_util.computeOutShape(r.shape,t.shape,a),n=ndarray_1.Array3D.zeros(e);if(0===a){var o=r.dataSync(),i=t.dataSync(),s=n.dataSync();return s.set(o,0),s.set(i,r.size),n}for(var u=0;u<e[0];++u)for(var p=0;p<e[1];++p)for(var h=0;h<e[2];++h){var y,l,f,d=[u,p,h],c=void 0;c=d[a]<r.shape[a]?r.get(u,p,h):(d[a]-=r.shape[a],y=d[0],l=d[1],f=d[2],t.get(y,l,f)),n.set(c,u,p,h)}return n},r.prototype.concat4D=function(r,t,a){var e=concat_util.computeOutShape(r.shape,t.shape,a),n=ndarray_1.Array4D.zeros(e);if(0===a){var o=r.dataSync(),i=t.dataSync(),s=n.dataSync();return s.set(o,0),s.set(i,r.size),n}for(var u=0;u<e[0];++u)for(var p=0;p<e[1];++p)for(var h=0;h<e[2];++h)for(var y=0;y<e[3];++y){var l,f,d,c,v=[u,p,h,y],g=void 0;g=v[a]<r.shape[a]?r.get(u,p,h,y):(v[a]-=r.shape[a],l=v[0],f=v[1],d=v[2],c=v[3],t.get(l,f,d,c)),n.set(g,u,p,h,y)}return n},r.prototype.neg=function(r){return this.multiply(ndarray_1.Scalar.new(-1),r)},r.prototype.add=function(r,t){return this.broadcastedBinaryOp(r,t,types.upcastType(r.dtype,t.dtype),function(r,t){return r+t})},r.prototype.subtract=function(r,t){return this.broadcastedBinaryOp(r,t,types.upcastType(r.dtype,t.dtype),function(r,t){return r-t})},r.prototype.pow=function(r,t){return this.broadcastedBinaryOp(r,t,r.dtype,function(r,t){return Math.pow(r,t)})},r.prototype.matMul=function(r,t,a,e){void 0===a&&(a=matmul_1.MatrixOrientation.REGULAR),void 0===e&&(e=matmul_1.MatrixOrientation.REGULAR);for(var n=a===matmul_1.MatrixOrientation.REGULAR?r.shape[1]:r.shape[0],o=a===matmul_1.MatrixOrientation.REGULAR?r.shape[0]:r.shape[1],i=e===matmul_1.MatrixOrientation.REGULAR?t.shape[1]:t.shape[0],s=function(r,t,a){return r.get(t,a)},u=function(r,t,a){return r.get(a,t)},p=a===matmul_1.MatrixOrientation.REGULAR?s:u,h=e===matmul_1.MatrixOrientation.REGULAR?s:u,y=new Float32Array(o*i),l=0,f=0;f<o;++f)for(var d=0;d<i;++d){for(var c=0,v=0;v<n;++v)c+=p(r,f,v)*h(t,v,d);y[l++]=c}return ndarray_1.Array2D.new([o,i],y)},r.prototype.multiply=function(r,t){return this.broadcastedBinaryOp(r,t,types.upcastType(r.dtype,t.dtype),function(r,t){return r*t})},r.prototype.divide=function(r,t){return this.broadcastedBinaryOp(r,t,"float32",function(r,t){return r/t})},r.prototype.sum=function(r,t){axis_util.assertAxesAreInnerMostDims("sum",t,r.rank);for(var a=axis_util.computeOutAndReduceShapes(r.shape,t),e=a[0],n=a[1],o=types_1.SumTypesMap[r.dtype],i=ndarray_1.NDArray.zeros(e,o),s=util.sizeFromShape(n),u=i.dataSync(),p=r.dataSync(),h=0;h<u.length;++h){for(var y=h*s,l=0,f=0;f<s;++f)l+=p[y+f];u[h]=l}return i},r.prototype.argMin=function(r,t){axis_util.assertAxesAreInnerMostDims("argMin",t,r.rank);for(var a=axis_util.computeOutAndReduceShapes(r.shape,t),e=a[0],n=a[1],o=ndarray_1.NDArray.zeros(e,"int32"),i=util.sizeFromShape(n),s=o.dataSync(),u=r.dataSync(),p=0;p<s.length;++p){for(var h=p*i,y=u[h],l=0,f=0;f<i;++f){var d=u[h+f];if(isNaN(d)){l=util.NAN_INT32;break}d<y&&(y=d,l=f)}s[p]=l}return o},r.prototype.argMax=function(r,t){axis_util.assertAxesAreInnerMostDims("argMax",t,r.rank);for(var a=axis_util.computeOutAndReduceShapes(r.shape,t),e=a[0],n=a[1],o=ndarray_1.NDArray.zeros(e,"int32"),i=util.sizeFromShape(n),s=o.dataSync(),u=r.dataSync(),p=0;p<s.length;++p){for(var h=p*i,y=u[h],l=0,f=0;f<i;++f){var d=u[h+f];if(isNaN(d)){l=util.NAN_INT32;break}y<d&&(y=d,l=f)}s[p]=l}return o},r.prototype.equal=function(a,e){return this.broadcastedBinaryOp(a,e,"bool",function(r,t){return util.isValNaN(r,a.dtype)||util.isValNaN(t,e.dtype)?util.getNaN("bool"):r===t?1:0})},r.prototype.notEqual=function(a,e){return this.broadcastedBinaryOp(a,e,"bool",function(r,t){return util.isValNaN(r,a.dtype)||util.isValNaN(t,e.dtype)?util.getNaN("bool"):r!==t?1:0})},r.prototype.lessEqual=function(a,e){return this.broadcastedBinaryOp(a,e,"bool",function(r,t){return util.isValNaN(r,a.dtype)||util.isValNaN(t,e.dtype)?util.getNaN("bool"):r<=t?1:0})},r.prototype.greater=function(a,e){return this.broadcastedBinaryOp(a,e,"bool",function(r,t){return util.isValNaN(r,a.dtype)||util.isValNaN(t,e.dtype)?util.getNaN("bool"):t<r?1:0})},r.prototype.greaterEqual=function(a,e){return this.broadcastedBinaryOp(a,e,"bool",function(r,t){return util.isValNaN(r,a.dtype)||util.isValNaN(t,e.dtype)?util.getNaN("bool"):t<=r?1:0})},r.prototype.logicalOr=function(a,e){return this.broadcastedBinaryOp(a,e,"bool",function(r,t){return util.isValNaN(r,a.dtype)||util.isValNaN(t,e.dtype)?util.getNaN("bool"):r||t})},r.prototype.topKValues=function(r,t){return this.topK(r,t).values},r.prototype.topKIndices=function(r,t){return this.topK(r,t).indices},r.prototype.topK=function(r,t){for(var a=r.dataSync(),e=[],n=0;n<a.length;n++)e.push({value:a[n],index:n});e.sort(function(r,t){return t.value-r.value});for(var o=util.getTypedArrayFromDType(r.dtype,t),i=new Int32Array(t),n=0;n<t;n++)o[n]=e[n].value,i[n]=e[n].index;return{values:ndarray_1.Array1D.new(o),indices:ndarray_1.Array1D.new(i)}},r.prototype.min=function(r,t){axis_util.assertAxesAreInnerMostDims("min",t,r.rank);for(var a=axis_util.computeOutAndReduceShapes(r.shape,t),e=a[0],n=a[1],o=ndarray_1.NDArray.zeros(e,r.dtype),i=util.sizeFromShape(n),s=o.dataSync(),u=r.dataSync(),p=0;p<s.length;++p){for(var h=p*i,y=u[0],l=0;l<i;++l){var f=u[h+l];if(isNaN(f)){y=Number.NaN;break}f<y&&(y=f)}s[p]=y}return o},r.prototype.minimum=function(r,t){return this.broadcastedBinaryOp(r,t,r.dtype,function(r,t){return Math.min(r,t)})},r.prototype.max=function(r,t){axis_util.assertAxesAreInnerMostDims("max",t,r.rank);for(var a=axis_util.computeOutAndReduceShapes(r.shape,t),e=a[0],n=a[1],o=ndarray_1.NDArray.zeros(e,r.dtype),i=util.sizeFromShape(n),s=o.dataSync(),u=r.dataSync(),p=0;p<s.length;++p){for(var h=p*i,y=u[h],l=0;l<i;++l){var f=u[h+l];if(isNaN(f)){y=Number.NaN;break}y<f&&(y=f)}s[p]=y}return o},r.prototype.maximum=function(r,t){return this.broadcastedBinaryOp(r,t,r.dtype,function(r,t){return Math.max(r,t)})},r.prototype.ceil=function(r){for(var t=r.dataSync(),a=new Float32Array(t.length),e=0;e<t.length;++e)a[e]=Math.ceil(t[e]);return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.floor=function(r){for(var t=r.dataSync(),a=new Float32Array(t.length),e=0;e<t.length;++e)a[e]=Math.floor(t[e]);return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.exp=function(r){for(var t=r.dataSync(),a=new Float32Array(t.length),e=0;e<t.length;++e)a[e]=Math.exp(t[e]);return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.log=function(r){for(var t=r.dataSync(),a=new Float32Array(t.length),e=0;e<t.length;++e){var n=t[e];a[e]=Math.log(n)}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.sqrt=function(r){for(var t=r.dataSync(),a=new Float32Array(t.length),e=0;e<t.length;++e){var n=t[e];a[e]=Math.sqrt(n)}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.square=function(r){for(var t=r.dataSync(),a=new Float32Array(t.length),e=0;e<t.length;++e){var n=t[e];a[e]=n*n}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.relu=function(r){for(var t=ndarray_1.NDArray.zeros(r.shape,r.dtype),a=t.dataSync(),e=r.dataSync(),n=0;n<e.length;++n){var o=e[n];util.isValNaN(o,r.dtype)?a[n]=util.getNaN(t.dtype):a[n]=Math.max(0,e[n])}return t},r.prototype.elu=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e){var n=a[e];t[e]=0<=n?n:Math.exp(n)-1}return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.eluDer=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e){var n=a[e];t[e]=0<=n?1:Math.exp(n)}return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.selu=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e){var n=a[e];t[e]=0<=n?1.0507009873554805*n:1.7580993408473768*(Math.exp(n)-1)}return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.leakyRelu=function(r,t){for(var a=new Float32Array(r.size),e=r.dataSync(),n=0;n<e.length;n++){var o=e[n];a[n]=0<=o?o:t*o}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.prelu=function(r,t){for(var a=new Float32Array(r.size),e=r.dataSync(),n=t.dataSync(),o=0;o<e.length;o++){var i=e[o];a[o]=0<=i?i:n[o]*i}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.preluDer=function(r,t){for(var a=new Float32Array(r.size),e=r.dataSync(),n=t.dataSync(),o=0;o<e.length;o++){var i=e[o];a[o]=0<i?1:i<0?n[o]:i}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.clip=function(r,t,a){for(var e=new Float32Array(r.size),n=r.dataSync(),o=0;o<n.length;++o)e[o]=Math.min(a,Math.max(t,n[o]));return ndarray_1.NDArray.make(r.shape,{values:e})},r.prototype.abs=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.abs(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.int=function(r){for(var t=new Int32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=a[e];return ndarray_1.NDArray.make(r.shape,{values:t},"int32")},r.prototype.sigmoid=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=1/(1+Math.exp(-a[e]));return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.sin=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.sin(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.cos=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.cos(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.tan=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.tan(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.asin=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.asin(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.acos=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.acos(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.atan=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.atan(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.sinh=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.sinh(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.cosh=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=Math.cosh(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.tanh=function(r){for(var t=new Float32Array(r.size),a=r.dataSync(),e=0;e<a.length;++e)t[e]=util.tanh(a[e]);return ndarray_1.NDArray.make(r.shape,{values:t})},r.prototype.step=function(r,t){void 0===t&&(t=0);for(var a=new Float32Array(r.size),e=r.dataSync(),n=0;n<e.length;++n){var o=e[n];util.isValNaN(o,r.dtype)?a[n]=util.getNaN(r.dtype):a[n]=0<o?1:t}return ndarray_1.NDArray.make(r.shape,{values:a})},r.prototype.conv2d=function(r,t,a,e){for(var n=e.filterHeight,o=e.filterWidth,i=e.padInfo.left,s=e.padInfo.top,u=ndarray_1.Array4D.zeros(e.outShape),p=0;p<e.batchSize;++p)for(var h=0;h<e.outChannels;++h)for(var y=0;y<e.outHeight;++y)for(var l=y*e.strideHeight-i,f=Math.max(0,l),d=Math.min(e.inHeight,n+l),c=0;c<e.outWidth;++c){for(var v=c*e.strideWidth-s,g=Math.max(0,v),m=Math.min(e.inWidth,o+v),A=0,_=f;_<d;++_)for(var N=_-l,w=g;w<m;++w)for(var D=w-v,S=0;S<e.inChannels;++S){A+=r.get(p,_,w,S)*t.get(N,D,S,h)}var M=null!=a?a.get(h):0;u.set(A+M,p,y,c,h)}return u},r.prototype.conv2dDerInput=function(r,t,a){for(var e=a.filterHeight,n=a.filterWidth,o=e-1-a.padInfo.top,i=n-1-a.padInfo.left,s=a.strideHeight,u=a.strideWidth,p=ndarray_1.Array4D.zeros(a.inShape),h=0;h<a.batchSize;++h)for(var y=0;y<a.inChannels;++y)for(var l=0;l<a.inHeight;++l)for(var f=l-i,d=Math.max(0,Math.ceil(f/s)),c=Math.min(a.outHeight,(e+f)/s),v=0;v<a.inWidth;++v){for(var g=v-o,m=Math.max(0,Math.ceil(g/u)),A=Math.min(a.outWidth,(n+g)/u),_=0,N=d;N<c;++N)for(var w=N*s-f,D=m;D<A;++D)for(var S=D*u-g,M=0;M<a.outChannels;++M){_+=r.get(h,N,D,M)*t.get(e-1-w,n-1-S,y,M)}p.set(_,h,l,v,y)}return p},r.prototype.conv2dDerFilter=function(r,t,a){for(var e=a.strideHeight,n=a.strideWidth,o=a.filterHeight,i=a.filterWidth,s=ndarray_1.Array4D.zeros(a.filterShape),u=a.padInfo.left,p=a.padInfo.top,h=0;h<o;++h)for(var y=Math.max(0,Math.ceil((p-h)/e)),l=Math.min(a.outHeight,(a.inHeight+p-h)/e),f=0;f<i;++f)for(var d=Math.max(0,Math.ceil((u-f)/n)),c=Math.min(a.outWidth,(a.inWidth+u-f)/n),v=0;v<a.inChannels;++v)for(var g=0;g<a.outChannels;++g){for(var m=0,A=0;A<a.batchSize;++A)for(var _=y;_<l;++_)for(var N=h+_*e-p,w=d;w<c;++w){var D=f+w*n-u;m+=r.get(A,N,D,v)*t.get(A,_,w,g)}s.set(m,h,f,v,g)}return s},r.prototype.conv2dDerBias=function(r){for(var t=r.shape,a=t[0],e=t[1],n=t[2],o=t[3],i=new Float32Array(o),s=0;s<o;++s){for(var u=0,p=0;p<a;++p)for(var h=0;h<e;++h)for(var y=0;y<n;++y)u+=r.get(p,h,y,s);i[s]=u}return ndarray_1.Array1D.new(i)},r.prototype.depthwiseConv2D=function(r,t,a){for(var e=a.filterHeight,n=a.filterWidth,o=a.padInfo.left,i=a.padInfo.top,s=a.outChannels/a.inChannels,u=ndarray_1.Array4D.zeros(a.outShape),p=0;p<a.batchSize;++p)for(var h=0;h<a.inChannels;++h)for(var y=0;y<a.outHeight;++y)for(var l=y*a.strideHeight-o,f=Math.max(0,l),d=Math.min(a.inHeight,e+l),c=0;c<a.outWidth;++c)for(var v=c*a.strideWidth-i,g=Math.max(0,v),m=Math.min(a.inWidth,n+v),A=0;A<s;++A){for(var _=0,N=f;N<d;++N)for(var w=N-l,D=g;D<m;++D){var S=D-v;_+=r.get(p,N,D,h)*t.get(w,S,h,A)}u.set(_,p,y,c,h*s+A)}return u},r.prototype.tile=function(r,t){for(var a,e=new Array(r.rank),n=0;n<e.length;n++)e[n]=r.shape[n]*t[n];if("float32"===r.dtype)a=Float32Array;else if("int32"===r.dtype)a=Int32Array;else{if("bool"!==r.dtype)throw new Error("Dtype "+r.dtype+" not supported for tile");a=Uint8Array}for(var o=new a(util.sizeFromShape(e)),i=ndarray_1.NDArray.make(e,{values:o},r.dtype),s=r.dataSync(),n=0;n<i.size;++n){for(var u=i.indexToLoc(n),p=new Array(r.rank),h=0;h<p.length;h++)p[h]=u[h]%r.shape[h];var y=r.locToIndex(p);o[n]=s[y]}return i},r.prototype.pad1D=function(r,t,a){var e,n=t[0],o=t[1];if("float32"===r.dtype)e=Float32Array;else if("int32"===r.dtype)e=Int32Array;else{if("bool"!==r.dtype)throw new Error("Dtype "+r.dtype+" not supported for tile");e=Uint8Array}for(var i=r.dataSync(),s=new e(n+i.length+o),u=0,p=0;p<s.length;p++)n<=p&&p<n+i.length?s[p]=i[u++]:s[p]=a;return ndarray_1.Array1D.new(s)},r.prototype.pad2D=function(r,t,a){var e,n=t[0][0],o=t[0][1],i=t[1][0],s=t[1][1],u=[n+r.shape[0]+o,i+r.shape[1]+s];if("float32"===r.dtype)e=Float32Array;else if("int32"===r.dtype)e=Int32Array;else{if("bool"!==r.dtype)throw new Error("Dtype "+r.dtype+" not supported for tile");e=Uint8Array}for(var p=r.dataSync(),h=new e(util.sizeFromShape(u)),y=0,l=0;l<u[0];l++){var f=-1,d=-1;n<=l&&l<u[0]-o&&(d=(f=l*u[1]+i)+r.shape[1]-1);for(var c=0;c<u[1];c++){var v=l*u[1]+c;h[v]=f<=v&&v<=d?p[y++]:a}}return ndarray_1.Array2D.new(u,h)},r.prototype.transpose=function(r,t){for(var a=new Array(r.rank),e=0;e<a.length;e++)a[e]=r.shape[t[e]];for(var n=new Float32Array(r.size),o=r.dataSync(),i=ndarray_1.NDArray.make(a,{values:n}),e=0;e<r.size;++e){for(var s=r.indexToLoc(e),u=new Array(s.length),p=0;p<u.length;p++)u[p]=s[t[p]];n[i.locToIndex(u)]=o[e]}return i},r.prototype.pool=function(r,t,a){for(var e=t.strideHeight,n=t.strideWidth,o=t.filterHeight,i=t.filterWidth,s=ndarray_1.Array4D.zeros(t.outShape),u=t.padInfo.top,p=t.padInfo.left,h=0;h<t.batchSize;++h)for(var y=0;y<t.inChannels;++y)for(var l=0;l<t.outHeight;++l)for(var f=l*e-u,d=Math.max(0,f),c=Math.min(t.inHeight,o+f),v=0;v<t.outWidth;++v){for(var g=v*n-p,m=Math.max(0,g),A=Math.min(t.inWidth,i+g),_="max"===a?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,N=0,w=d;w<c;++w){for(var D=m;D<A;++D){var S=r.get(h,w,D,y);if(isNaN(S)){N=_=NaN;break}"max"===a&&_<S||"min"===a&&S<_?_=S:"avg"===a&&(N+=S/(o*i))}if(isNaN(_))break}s.set("avg"===a?N:_,h,l,v,y)}return s},r.prototype.maxPool=function(r,t){return this.pool(r,t,"max")},r.prototype.maxPoolPositions=function(r,t){for(var a=ndarray_1.Array4D.zeros(t.outShape),e=t.strideHeight,n=t.strideWidth,o=t.filterHeight,i=t.filterWidth,s=t.padInfo.top,u=t.padInfo.left,p=0;p<t.batchSize;++p)for(var h=0;h<t.inChannels;++h)for(var y=0;y<t.outHeight;++y)for(var l=y*e-s,f=Math.max(0,l),d=Math.min(t.inHeight,o+l),c=0;c<t.outWidth;++c){for(var v=c*n-u,g=Math.max(0,v),m=Math.min(t.inWidth,i+v),A=Number.NEGATIVE_INFINITY,_=-1,N=f;N<d;++N)for(var w=N-l,D=g;D<m;++D){var S=D-v,M=r.get(p,N,D,h);A<M&&(A=M,_=w*i+S)}a.set(_,p,y,c,h)}return a},r.prototype.maxPoolBackprop=function(r,t,a){for(var e=this.maxPoolPositions(t,a),n=a.strideHeight,o=a.strideWidth,i=a.filterHeight,s=a.filterWidth,u=s-1-a.padInfo.left,p=i-1-a.padInfo.top,h=ndarray_1.Array4D.zeros(t.shape),y=0;y<a.batchSize;++y)for(var l=0;l<a.inChannels;++l)for(var f=0;f<a.inHeight;++f)for(var d=0;d<a.inWidth;++d){for(var c=f-p,v=d-u,g=0,m=0;m<i;++m){var A=(c+m)/n;if(!(A<0||A>=a.outHeight||Math.floor(A)!==A))for(var _=0;_<s;++_){var N,w=(v+_)/o;w<0||w>=a.outWidth||Math.floor(w)!==w||0!=(N=i*s-1-e.get(y,A,w,l)===m*s+_?1:0)&&(g+=r.get(y,A,w,l)*N)}}h.set(g,y,f,d,l)}return h.asType(t.dtype)},r.prototype.avgPoolBackprop=function(r,t,a){for(var e=a.strideHeight,n=a.strideWidth,o=a.filterHeight,i=a.filterWidth,s=i-1-a.padInfo.left,u=o-1-a.padInfo.top,p=ndarray_1.Array4D.zeros(t.shape),h=1/(o*i),y=0;y<a.batchSize;++y)for(var l=0;l<a.inChannels;++l)for(var f=0;f<a.inHeight;++f)for(var d=0;d<a.inWidth;++d){for(var c=f-u,v=d-s,g=0,m=0;m<o;++m){var A=(c+m)/e;if(!(A<0||A>=a.outHeight||Math.floor(A)!==A))for(var _=0;_<i;++_){var N=(v+_)/n;N<0||N>=a.outWidth||Math.floor(N)!==N||(g+=r.get(y,A,N,l))}}p.set(g*h,y,f,d,l)}return p.asType(t.dtype)},r.prototype.minPool=function(r,t){return this.pool(r,t,"min")},r.prototype.avgPool=function(r,t){return this.pool(r,t,"avg").asType("float32")},r.prototype.resizeBilinear3D=function(r,t,a){for(var e=ndarray_1.Array3D.zeros([t[0],t[1],r.shape[2]]),n=a?[r.shape[0]-1,r.shape[1]-1,r.shape[2]]:r.shape,o=a?[e.shape[0]-1,e.shape[1]-1,e.shape[2]]:e.shape,i=0;i<e.shape[0];i++)for(var s=0;s<e.shape[1];s++)for(var u=0;u<e.shape[2];u++){var p=n[0]*i/o[0],h=n[1]*s/o[1],y=Math.floor(p),l=Math.min(r.shape[0]-1,Math.ceil(p)),f=Math.floor(h),d=Math.min(r.shape[1]-1,Math.ceil(h)),c=r.get(y,f,u),v=r.get(l,f,u),g=h-f,m=c+(r.get(y,d,u)-c)*g,A=m+(v+(r.get(l,d,u)-v)*g-m)*(p-y);e.set(A,i,s,u)}return e},r.prototype.batchNormalization2D=function(r,t,a,e,n,o){for(var i=r.dataSync(),s=t.dataSync(),u=a.dataSync(),p=n?n.dataSync():[1],h=o?o.dataSync():[0],y=new Float32Array(i.length),l=0;l<i.length;l++)y[l]=h[l%h.length]+(i[l]-s[l%s.length])*p[l%p.length]/Math.sqrt(u[l%u.length]+e);return ndarray_1.Array2D.new(r.shape,y)},r.prototype.batchNormalization3D=function(r,t,a,e,n,o){for(var i=r.dataSync(),s=t.dataSync(),u=a.dataSync(),p=n?n.dataSync():[1],h=o?o.dataSync():[0],y=new Float32Array(i.length),l=0;l<i.length;l++)y[l]=h[l%h.length]+(i[l]-s[l%s.length])*p[l%p.length]/Math.sqrt(u[l%u.length]+e);return ndarray_1.Array3D.new(r.shape,y)},r.prototype.batchNormalization4D=function(r,t,a,e,n,o){for(var i=r.dataSync(),s=t.dataSync(),u=a.dataSync(),p=n?n.dataSync():new Float32Array([1]),h=o?o.dataSync():new Float32Array([0]),y=new Float32Array(i.length),l=0;l<i.length;l++)y[l]=h[l%h.length]+(i[l]-s[l%s.length])*p[l%p.length]/Math.sqrt(u[l%u.length]+e);return ndarray_1.Array4D.new(r.shape,y)},r.prototype.localResponseNormalization4D=function(s,r,t,a,e,n){for(var o=ndarray_1.Array4D.zeros(s.shape),u=r,p=o.shape[1]-1,h=o.shape[2]-1,y=o.shape[3]-1,i=function(r,t,a,e){for(var n=0,o=Math.max(0,e-u);o<=Math.min(e+u,y);o++){var i=s.get(r,t,a,o);n+=i*i}return n},l=function(r,t,a,e){for(var n=0,o=Math.max(0,t-u);o<=Math.min(t+u,p);o++)for(var i=Math.max(0,a-u);i<=Math.min(a+u,h);i++)n+=Math.pow(s.get(r,o,i,e),2);return n},f=0;f<o.shape[0];f++)for(var d=0;d<=o.shape[1];d++)for(var c=0;c<o.shape[2];c++)for(var v=0;v<o.shape[3];v++){var g=("withinChannel"===n?l:i)(f,d,c,v),m=s.get(f,d,c,v)*Math.pow(t+a*g,-e);o.set(m,f,d,c,v)}return o},r.prototype.multinomial=function(r,t,a){for(var e=r.shape[0],n=r.shape[1],o=ndarray_1.Array2D.zeros([e,t],"int32"),i=o.dataSync(),s=r.dataSync(),u=0;u<e;++u){var p=u*n,h=new Float32Array(n-1);h[0]=s[p];for(var y=1;y<h.length;++y)h[y]=h[y-1]+s[p+y];for(var l=seedrandom.alea(a.toString()),f=u*t,d=0;d<t;++d){var c=l();i[f+d]=h.length;for(var v=0;v<h.length;v++)if(c<h[v]){i[f+d]=v;break}}}return o},r.prototype.oneHot=function(r,t,a,e){var n=new Float32Array(r.size*t);n.fill(e);for(var o=0;o<r.size;++o)n[o*t+r.get(o)]=a;return ndarray_1.Array2D.new([r.size,t],n)},r.prototype.broadcastedBinaryOp=function(i,s,r,u){for(var t=broadcast_util.assertAndGetBroadcastShape(i.shape,s.shape),p=ndarray_1.NDArray.zeros(t,r),h=p.dataSync(),y=i.dataSync(),l=s.dataSync(),f=broadcast_util.getBroadcastDims(i.shape,t),d=broadcast_util.getBroadcastDims(s.shape,t),a=function(r){var t=p.indexToLoc(r),a=t.slice(-i.rank);f.forEach(function(r){return a[r]=0});var e=i.locToIndex(a),n=t.slice(-s.rank);d.forEach(function(r){return n[r]=0});var o=s.locToIndex(n);h[r]=u(y[e],l[o])},e=0;e<h.length;++e)a(e);return p},r.prototype.dispose=function(){},r}();exports.MathBackendCPU=MathBackendCPU,environment_1.ENV.registerBackend("cpu",function(){return new MathBackendCPU});var NDArrayMathCPU=function(a){function r(r){void 0===r&&(r=!1);var t;return console.warn("new NDArrayMathCPU() is deprecated. Please use the global dl.ENV.math. In rare cases, to construct your own NDArrayMath that runs on CPU, use math = new NDArrayMath('cpu', safeMode); and make sure to set it as global: dl.ENV.setMath(math);"),t=a.call(this,"cpu",r)||this,environment_1.ENV.setMath(t),t}return __extends(r,a),r}(math_1.NDArrayMath);exports.NDArrayMathCPU=NDArrayMathCPU;