"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(p,o,u,i){return new(u=u||Promise)(function(e,t){function r(e){try{a(i.next(e))}catch(e){t(e)}}function n(e){try{a(i.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(r,n)}a((i=i.apply(p,o||[])).next())})},__generator=this&&this.__generator||function(r,n){var a,p,o,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,p&&(o=p[2&t[0]?"return":t[0]?"throw":"next"])&&!(o=o.call(p,t[1])).done)return o;switch(p=0,o&&(t=[0,o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,p=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(r,u)}catch(e){t=[6,e],p=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),axis_util=require("../axis_util"),math_1=require("../math"),ndarray_1=require("../ndarray"),reduce_util=require("../reduce_util"),types=require("../types"),types_1=require("../types"),argminmax_gpu_1=require("./webgl/argminmax_gpu"),avg_pool_backprop_gpu_1=require("./webgl/avg_pool_backprop_gpu"),batchnorm_gpu_1=require("./webgl/batchnorm_gpu"),binaryop_gpu=require("./webgl/binaryop_gpu"),binaryop_gpu_1=require("./webgl/binaryop_gpu"),clip_gpu_1=require("./webgl/clip_gpu"),concat_gpu_1=require("./webgl/concat_gpu"),conv_backprop_gpu_1=require("./webgl/conv_backprop_gpu"),conv_gpu_1=require("./webgl/conv_gpu"),conv_gpu_depthwise_1=require("./webgl/conv_gpu_depthwise"),copy_gpu_1=require("./webgl/copy_gpu"),gpgpu_context_1=require("./webgl/gpgpu_context"),gpgpu_math=require("./webgl/gpgpu_math"),lrn_gpu_1=require("./webgl/lrn_gpu"),max_pool_backprop_gpu_1=require("./webgl/max_pool_backprop_gpu"),mulmat_gpu_1=require("./webgl/mulmat_gpu"),multinomial_gpu_1=require("./webgl/multinomial_gpu"),onehot_gpu_1=require("./webgl/onehot_gpu"),pad_gpu_1=require("./webgl/pad_gpu"),pool_gpu_1=require("./webgl/pool_gpu"),reduce_gpu_1=require("./webgl/reduce_gpu"),resize_bilinear_gpu_1=require("./webgl/resize_bilinear_gpu"),reverse_gpu_1=require("./webgl/reverse_gpu"),slice_gpu_1=require("./webgl/slice_gpu"),tex_util_1=require("./webgl/tex_util"),texture_manager_1=require("./webgl/texture_manager"),tile_gpu_1=require("./webgl/tile_gpu"),transpose_gpu_1=require("./webgl/transpose_gpu"),unary_op=require("./webgl/unaryop_gpu"),unaryop_gpu_1=require("./webgl/unaryop_gpu"),webgl_util=require("./webgl/webgl_util"),MathBackendWebGL=function(){function e(e,t){if(void 0===t&&(t=!0),this.gpgpu=e,this.delayedStorage=t,this.texData={},this.binaryCache={},this.disposed=!1,environment_1.ENV.get("WEBGL_VERSION")<1)throw new Error("WebGL is not supported on this device");null==e?(this.gpgpu=new gpgpu_context_1.GPGPUContext,this.gpgpuCreatedLocally=!0):this.gpgpuCreatedLocally=!1,"undefined"!=typeof document&&(this.canvas=document.createElement("canvas")),this.textureManager=new texture_manager_1.TextureManager(this.gpgpu)}return e.prototype.register=function(e,t,r){if(e in this.texData)throw new Error("data id "+e+" already registered");this.texData[e]={shape:t,dtype:r,values:null,texture:null,texShape:null,textureType:null}},e.prototype.writePixels=function(e,t,r){if(null==t)throw new Error("MathBackendWebGL.writePixels(): pixels can not be null");this.throwIfNoData(e);var n=[t.height,t.width],a=this.texData[e].texture||this.textureManager.acquireTexture(n),p=this.texData[e].shape;if(this.texData[e]={shape:p,values:null,texture:a,textureType:tex_util_1.TextureType.RGBA_COLOR,texShape:n,numChannels:r,dtype:"int32"},t instanceof HTMLVideoElement){if(null==this.canvas)throw new Error("Can't read pixels from HTMLImageElement outside the browser.");this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.getContext("2d").drawImage(t,0,0,t.width,t.height),t=this.canvas}this.gpgpu.uploadPixelDataToTexture(a,t)},e.prototype.write=function(e,t){if(null==t)throw new Error("MathBackendWebGL.write(): values can not be null");this.throwIfNoData(e);var r=this.texData[e],n=r.texture,a=r.texShape;null!=n&&(this.textureManager.releaseTexture(n,a),this.texData[e].texture=null,this.texData[e].texShape=null,this.texData[e].textureType=null),this.texData[e].values=t,this.delayedStorage||this.uploadToGPU(e)},e.prototype.readSync=function(e){this.throwIfNoData(e);var t,r=this.texData[e],n=r.texture,a=r.values,p=r.textureType,o=r.texShape,u=r.numChannels;return null!=a?(this.cacheOnCPU(e),a):(t=p===tex_util_1.TextureType.DEFAULT?this.gpgpu.downloadMatrixFromTexture(n,o[0],o[1]):this.gpgpu.downloadMatrixFromRGBAColorTexture(n,o[0],o[1],u),this.cacheOnCPU(e,t),this.texData[e].values)},e.prototype.read=function(u){return __awaiter(this,void 0,void 0,function(){var t,r,n,a,p,o;return __generator(this,function(e){switch(e.label){case 0:return this.throwIfNoData(u),t=this.texData[u],r=t.texture,n=t.values,a=t.textureType,p=t.texShape,null!=n?(this.cacheOnCPU(u),[2,n]):environment_1.ENV.get("WEBGL_GET_BUFFER_SUB_DATA_ASYNC_EXTENSION_ENABLED")&&a===tex_util_1.TextureType.DEFAULT?[4,this.gpgpu.downloadMatrixFromTextureAsync(r,p[0],p[1])]:[3,2];case 1:return o=e.sent(),this.cacheOnCPU(u,o),[2,this.texData[u].values];case 2:return environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED")?[4,this.gpgpu.runQuery(function(){})]:[2,this.readSync(u)];case 3:return e.sent(),[2,this.readSync(u)]}})})},e.prototype.time=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return environment_1.ENV.get("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_ENABLED")?[3,2]:(t=performance.now(),[4,r().data()]);case 1:return e.sent(),[2,performance.now()-t];case 2:return[2,this.gpgpu.runQuery(r)]}})})},e.prototype.disposeData=function(e){var t,r,n;e in this.texData&&(r=(t=this.texData[e]).texture,n=t.texShape,null!=r&&this.textureManager.releaseTexture(r,n),delete this.texData[e])},e.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData[e].texture},e.prototype.getTextureData=function(e){return this.uploadToGPU(e),this.texData[e]},e.prototype.getGPGPUContext=function(){return this.gpgpu},e.prototype.clone=function(e){this.throwIfNoData(e.dataId),this.uploadToGPU(e.dataId);var t=this.texData[e.dataId].texShape,r=e.as2D(t[0],t[1]),n=this.makeOutputArray(t,e.dtype);return this.copy2D(r,[0,0],t,n,[0,0],t),n.reshape(e.shape)},e.prototype.slice1D=function(e,t,r){var n=new slice_gpu_1.SliceProgram([r]),a=n.getCustomSetupFunc([t]);return this.compileAndRun(n,[e],null,a)},e.prototype.slice2D=function(e,t,r){var n=new slice_gpu_1.SliceProgram(r),a=n.getCustomSetupFunc(t);return this.compileAndRun(n,[e],null,a)},e.prototype.slice3D=function(e,t,r){var n=new slice_gpu_1.SliceProgram(r),a=n.getCustomSetupFunc(t);return this.compileAndRun(n,[e],null,a)},e.prototype.slice4D=function(e,t,r){var n=new slice_gpu_1.SliceProgram(r),a=n.getCustomSetupFunc(t);return this.compileAndRun(n,[e],null,a)},e.prototype.reverse4D=function(e,t){var r=new reverse_gpu_1.ReverseProgram(e.shape,t);return this.compileAndRun(r,[e])},e.prototype.copy2D=function(e,t,r,n,a,p){var o=new copy_gpu_1.Copy2DProgram(r[1],p[1]),u=o.getCustomSetupFunc(t,a,p);this.compileAndRun(o,[e],n,u)},e.prototype.concat1D=function(e,t){var r=new concat_gpu_1.ConcatProgram(e.shape,t.shape,0);return this.compileAndRun(r,[e,t])},e.prototype.concat2D=function(e,t,r){var n=new concat_gpu_1.ConcatProgram(e.shape,t.shape,r);return this.compileAndRun(n,[e,t])},e.prototype.concat3D=function(e,t,r){var n=new concat_gpu_1.ConcatProgram(e.shape,t.shape,r);return this.compileAndRun(n,[e,t])},e.prototype.concat4D=function(e,t,r){var n=new concat_gpu_1.ConcatProgram(e.shape,t.shape,r);return this.compileAndRun(n,[e,t])},e.prototype.neg=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.NEG);return this.compileAndRun(t,[e])},e.prototype.matMul=function(e,t,r,n){var a=new mulmat_gpu_1.MatMulProgram(e.shape,t.shape,r,n);return this.compileAndRun(a,[e,t])},e.prototype.multiply=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MUL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.batchNormalization2D=function(e,t,r,n,a,p){var o=[e,t,r],u=null;null!=p&&(u=p.shape,o.push(p));var i=null;null!=a&&(i=a.shape,o.push(a));var s=new batchnorm_gpu_1.BatchNormProgram(e.shape,t.shape,r.shape,u,i,n);return this.compileAndRun(s,o)},e.prototype.batchNormalization3D=function(e,t,r,n,a,p){var o=[e,t,r],u=null;null!=p&&(u=p.shape,o.push(p));var i=null;null!=a&&(i=a.shape,o.push(a));var s=new batchnorm_gpu_1.BatchNormProgram(e.shape,t.shape,r.shape,u,i,n);return this.compileAndRun(s,o)},e.prototype.batchNormalization4D=function(e,t,r,n,a,p){var o=[e,t,r],u=null;null!=p&&(u=p.shape,o.push(p));var i=null;null!=a&&(i=a.shape,o.push(a));var s=new batchnorm_gpu_1.BatchNormProgram(e.shape,t.shape,r.shape,u,i,n);return this.compileAndRun(s,o)},e.prototype.localResponseNormalization4D=function(e,t,r,n,a,p){var o=new lrn_gpu_1.LRNProgram(e.shape,t,r,n,a,p);return this.compileAndRun(o,[e])},e.prototype.tile=function(e,t){var r=new tile_gpu_1.TileProgram(e.shape,t);return this.compileAndRun(r,[e])},e.prototype.pad1D=function(e,t,r){var n=new pad_gpu_1.Pad1DProgram(e.shape,t,r);return this.compileAndRun(n,[e])},e.prototype.pad2D=function(e,t,r){var n=new pad_gpu_1.Pad2DProgram(e.shape,t,r);return this.compileAndRun(n,[e])},e.prototype.transpose=function(e,t){var r=new transpose_gpu_1.TransposeProgram(e.shape,t);return this.compileAndRun(r,[e])},e.prototype.reduce=function(e,t,r){var n=e.shape[0],a=e.shape[1],p={windowSize:reduce_util.computeOptimalWindowSize(a),inSize:a,batchSize:n},o=new reduce_gpu_1.ReduceProgram(p,t),u=o.outputShape,i=u[0],s=u[1],h=this.makeOutputArray(o.outputShape,r).as2D(i,s);return this.compileAndRun(o,[e],h),1===h.shape[1]?h:this.reduce(h,t,r)},e.prototype.argReduce=function(e,t,r){void 0===r&&(r=null);var n=e.shape[0],a=e.shape[1];null!=r&&(n=r.shape[0],a=r.shape[1]);var p={windowSize:reduce_util.computeOptimalWindowSize(a),inSize:a,batchSize:n},o=new argminmax_gpu_1.ArgMinMaxProgram(p,t,null==r),u=o.outputShape,i=u[0],s=u[1],h=this.makeOutputArray(o.outputShape,"int32").as2D(i,s),l=[e];return null!=r&&l.push(r),this.compileAndRun(o,l,h),1===h.shape[1]?h:this.argReduce(e,t,h)},e.prototype.sum=function(e,t){axis_util.assertAxesAreInnerMostDims("sum",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],p=util.sizeFromShape(a),o=e.as2D(-1,p),u=types_1.SumTypesMap[e.dtype];return this.reduce(o,"sum",u).reshape(n)},e.prototype.argMin=function(e,t){axis_util.assertAxesAreInnerMostDims("argMin",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],p=util.sizeFromShape(a),o=e.as2D(-1,p);return this.argReduce(o,"min").reshape(n)},e.prototype.argMax=function(e,t){axis_util.assertAxesAreInnerMostDims("argMax",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],p=util.sizeFromShape(a),o=e.as2D(-1,p);return this.argReduce(o,"max").reshape(n)},e.prototype.equal=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.notEqual=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.NOT_EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.lessEqual=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LESS_EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.greater=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.greaterEqual=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.GREATER_EQUAL,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.logicalOr=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.LOGICAL_OR,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"bool");return this.compileAndRun(r,[e,t],n)},e.prototype.topKValues=function(e,t){throw new Error("topKValues GPU not yet implemented!")},e.prototype.topKIndices=function(e,t){throw new Error("topKIndices GPU not yet implemented!")},e.prototype.min=function(e,t){axis_util.assertAxesAreInnerMostDims("min",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],p=util.sizeFromShape(a),o=e.as2D(-1,p);return this.reduce(o,"min",o.dtype).reshape(n)},e.prototype.minimum=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MIN,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.max=function(e,t){axis_util.assertAxesAreInnerMostDims("max",t,e.rank);var r=axis_util.computeOutAndReduceShapes(e.shape,t),n=r[0],a=r[1],p=util.sizeFromShape(a),o=e.as2D(-1,p);return this.reduce(o,"max",o.dtype).reshape(n)},e.prototype.maximum=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.MAX,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.divide=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.DIV,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,"float32");return this.compileAndRun(r,[e,t],n)},e.prototype.add=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.ADD,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.subtract=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.SUB,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.pow=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.POW,e.shape,t.shape),n=this.makeOutputArray(r.outputShape,types.upcastType(e.dtype,t.dtype));return this.compileAndRun(r,[e,t],n)},e.prototype.ceil=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.CEIL);return this.compileAndRun(t,[e])},e.prototype.floor=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.FLOOR);return this.compileAndRun(t,[e])},e.prototype.exp=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.EXP);return this.compileAndRun(t,[e])},e.prototype.log=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.LOG);return this.compileAndRun(t,[e])},e.prototype.sqrt=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SQRT);return this.compileAndRun(t,[e])},e.prototype.square=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SQUARE);return this.compileAndRun(t,[e])},e.prototype.relu=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.RELU);return this.compileAndRun(t,[e])},e.prototype.elu=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ELU);return this.compileAndRun(t,[e])},e.prototype.eluDer=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ELU_DER);return this.compileAndRun(t,[e])},e.prototype.selu=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SELU);return this.compileAndRun(t,[e])},e.prototype.leakyRelu=function(e,t){var r=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.LEAKY_RELU(t));return this.compileAndRun(r,[e])},e.prototype.prelu=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.preluDer=function(e,t){var r=new binaryop_gpu_1.BinaryOpProgram(binaryop_gpu.PRELU_DER,e.shape,t.shape);return this.compileAndRun(r,[e,t])},e.prototype.int=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.TO_INT),r=this.makeOutputArray(t.outputShape,"int32");return this.compileAndRun(t,[e],r)},e.prototype.clip=function(e,t,r){var n=new clip_gpu_1.ClipProgram(e.shape,t,r);return this.compileAndRun(n,[e])},e.prototype.abs=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ABS);return this.compileAndRun(t,[e])},e.prototype.sigmoid=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SIGMOID);return this.compileAndRun(t,[e])},e.prototype.sin=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SIN);return this.compileAndRun(t,[e])},e.prototype.cos=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.COS);return this.compileAndRun(t,[e])},e.prototype.tan=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.TAN);return this.compileAndRun(t,[e])},e.prototype.asin=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ASIN);return this.compileAndRun(t,[e])},e.prototype.acos=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ACOS);return this.compileAndRun(t,[e])},e.prototype.atan=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.ATAN);return this.compileAndRun(t,[e])},e.prototype.sinh=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.SINH);return this.compileAndRun(t,[e])},e.prototype.cosh=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.COSH);return this.compileAndRun(t,[e])},e.prototype.tanh=function(e){var t=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.TANH);return this.compileAndRun(t,[e])},e.prototype.step=function(e,t){var r=new unaryop_gpu_1.UnaryOpProgram(e.shape,unary_op.STEP(t));return this.compileAndRun(r,[e])},e.prototype.conv2d=function(e,t,r,n){var a=new conv_gpu_1.Conv2DProgram(n,null!=r),p=null!=r?[e,t,r]:[e,t];return this.compileAndRun(a,p)},e.prototype.conv2dDerInput=function(e,t,r){var n=new conv_backprop_gpu_1.Conv2DDerInputProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.conv2dDerFilter=function(e,t,r){var n=new conv_backprop_gpu_1.Conv2DDerFilterProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.conv2dDerBias=function(e){var t=new conv_backprop_gpu_1.Conv2DDerBiasProgram(e.shape);return this.compileAndRun(t,[e])},e.prototype.depthwiseConv2D=function(e,t,r){var n=new conv_gpu_depthwise_1.DepthwiseConv2DProgram(r);return this.compileAndRun(n,[e,t])},e.prototype.maxPool=function(e,t){var r=new pool_gpu_1.Pool2DProgram(t,"max",!1),n=this.makeOutputArray(r.outputShape,e.dtype);return this.compileAndRun(r,[e],n)},e.prototype.minPool=function(e,t){var r=new pool_gpu_1.Pool2DProgram(t,"min",!1),n=this.makeOutputArray(r.outputShape,e.dtype);return this.compileAndRun(r,[e],n)},e.prototype.avgPool=function(e,t){var r=new pool_gpu_1.Pool2DProgram(t,"avg",!1),n=this.makeOutputArray(r.outputShape,"float32");return this.compileAndRun(r,[e],n)},e.prototype.maxPoolBackprop=function(e,t,r){var n=new pool_gpu_1.Pool2DProgram(r,"max",!0),a=this.compileAndRun(n,[t]),p=new max_pool_backprop_gpu_1.MaxPool2DBackpropProgram(r),o=this.makeOutputArray(p.outputShape,t.dtype),u=this.compileAndRun(p,[e,a],o);return a.dispose(),u},e.prototype.avgPoolBackprop=function(e,t,r){var n=new avg_pool_backprop_gpu_1.AvgPool2DBackpropProgram(r),a=this.makeOutputArray(n.outputShape,t.dtype);return this.compileAndRun(n,[e],a)},e.prototype.resizeBilinear3D=function(e,t,r){var n=new resize_bilinear_gpu_1.ResizeBilinear3DProgram(e.shape,t,r);return this.compileAndRun(n,[e])},e.prototype.multinomial=function(e,t,r){var n=e.shape[0],a=e.shape[1],p=new multinomial_gpu_1.MultinomialProgram(n,a,t),o=this.makeOutputArray(p.outputShape,"int32"),u=p.getCustomSetupFunc(r);return this.compileAndRun(p,[e],o,u)},e.prototype.oneHot=function(e,t,r,n){var a=new onehot_gpu_1.OneHotProgram(e.size,t,r,n);return this.compileAndRun(a,[e])},e.prototype.makeOutputArray=function(e,t){return ndarray_1.NDArray.make(e,{},t)},e.prototype.compileAndRun=function(e,t,r,n){var a=this;null==r&&(r=this.makeOutputArray(e.outputShape,t[0].dtype));var p=t.map(function(e){return a.uploadToGPU(e.dataId),{array:e,texData:a.texData[e.dataId]}});this.uploadToGPU(r.dataId);var o={array:r,texData:this.texData[r.dataId]},u=gpgpu_math.makeShaderKey(e,p,o),i=this.getAndSaveBinary(u,function(){return gpgpu_math.compileProgram(a.gpgpu,e,p,o)});return gpgpu_math.runProgram(i,p,o,n),r},e.prototype.getAndSaveBinary=function(e,t){return e in this.binaryCache||(this.binaryCache[e]=t()),this.binaryCache[e]},e.prototype.getTextureManager=function(){return this.textureManager},e.prototype.dispose=function(){if(!this.disposed){for(var e in this.binaryCache)this.gpgpu.deleteProgram(this.binaryCache[e].webGLProgram);this.textureManager.dispose(),this.gpgpuCreatedLocally&&this.gpgpu.dispose(),this.disposed=!0}},e.prototype.throwIfNoData=function(e){if(!(e in this.texData))throw new Error("No data found for NDArray with data id "+e+". Use dl.ENV.math instead of constructing your own NDArrayMath. If you need to construct your own math, make sure this array is allocated after the math construction")},e.prototype.uploadToGPU=function(e){this.throwIfNoData(e);var t,r,n=this.texData[e],a=n.shape,p=n.values,o=n.texture,u=n.dtype;null==o&&(t=webgl_util.getTextureShapeFromLogicalShape(this.gpgpu.gl,a),this.texData[e].textureType=tex_util_1.TextureType.DEFAULT,this.texData[e].texShape=t,r=this.textureManager.acquireTexture(t),this.texData[e].texture=r,null!=p&&this.gpgpu.uploadMatrixToTexture(r,t[0],t[1],typedArrayToFloat32(p,u)))},e.prototype.cacheOnCPU=function(e,t){var r=this.delayedStorage,n=this.texData[e],a=n.texture,p=n.texShape,o=n.dtype;r&&null!=a&&(this.textureManager.releaseTexture(a,p),this.texData[e].texture=null,this.texData[e].texShape=null,this.texData[e].textureType=null),null!=t&&(this.texData[e].values=float32ToTypedArray(t,o))},e}();exports.MathBackendWebGL=MathBackendWebGL,environment_1.ENV.registerBackend("webgl",function(){return new MathBackendWebGL});var NDArrayMathGPU=function(n){function e(e,t){void 0===t&&(t=!1);var r;return console.warn("new NDArrayMathGPU() is deprecated. Please use the global dl.ENV.math. In rare cases, to construct your own NDArrayMath that runs on GPU, use math = new NDArrayMath('webgl', safeMode); and make sure to set it as global: dl.ENV.setMath(math);"),r=n.call(this,new MathBackendWebGL(e),t)||this,environment_1.ENV.setMath(r),r}return __extends(e,n),e.prototype.getGPGPUContext=function(){return this.backendEngine.getBackend().getGPGPUContext()},e.prototype.getTextureManager=function(){return this.backendEngine.getBackend().getTextureManager()},e}(math_1.NDArrayMath);function float32ToTypedArray(e,t){if("float32"===t)return e;if("int32"!==t&&"bool"!==t)throw new Error("Unknown dtype "+t);for(var r=new("int32"===t?Int32Array:Uint8Array)(e.length),n=0;n<r.length;++n){var a=e[n],a=isNaN(a)?util.getNaN(t):Math.round(a);r[n]=a}return r}function typedArrayToFloat32(e,t){if(e instanceof Float32Array)return e;for(var r=new Float32Array(e.length),n=0;n<r.length;n++){var a=e[n];r[n]=util.isValNaN(a,t)?NaN:a}return r}exports.NDArrayMathGPU=NDArrayMathGPU;