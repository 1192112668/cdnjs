"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../../environment"),util=require("../../util"),ndarray_1=require("../ndarray");function getFilteredNodesXToY(t,r,n){for(var e={},i={},o=0;o<r.length;o++)e[r[o].id]=!0;for(o=0;o<t.length;o++){var u=(b=t[o]).inputAndArgs.inputs;for(var a in u){for(var p=u[a],s=!1,d=0;d<r.length;d++)if(e[p.id]){if(b.output instanceof ndarray_1.NDArray)e[b.output.id]=!0;else for(var f=0,l=Object.keys(b.output);f<l.length;f++){var c=l[f];e[b.output[c].id]=!0}s=!0,i[b.id]=!0;break}if(s)break}}var g={};g[n.id]=!0;for(var v={},o=t.length-1;0<=o;o--){var u=(b=t[o]).inputAndArgs.inputs,h=[];if(b.output instanceof ndarray_1.NDArray)h.push(b.output);else for(var y=0,A=Object.keys(b.output);y<A.length;y++){c=A[y];h.push(b.output[c])}for(d=0;d<h.length;d++)if(g[h[d].id]){for(var a in u)g[u[a].id]=!0,v[b.id]=!0;break}}for(var b,m=[],o=0;o<t.length;o++){if(i[(b=t[o]).id]&&v[b.id]){var k={};for(var a in b.inputAndArgs.inputs){var N=b.inputAndArgs.inputs[a];e[N.id]&&(k[a]=N)}var _=void 0;if(b.output instanceof ndarray_1.NDArray)_=b.output;else for(var D in _={},b.output){g[b.output[D].id]&&(_[D]=b.output[D])}var j=Object.assign({},b);j.inputAndArgs={inputs:k},j.output=_,m.push(j)}}return m}function backpropagateGradients(t,r){for(var n=r.length-1;0<=n;n--){var e=r[n],i=void 0;if(e.output instanceof ndarray_1.NDArray)i=t[e.output.id];else{i={};for(var o=0,u=Object.keys(e.output);o<u.length;o++){var a=u[o];i[a]=t[e.output[a].id]}}if(null==e.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+e.name+".");var p=e.gradient(i,e.output);for(var s in e.inputAndArgs.inputs){if(!(s in p))throw new Error("Cannot backprop through input "+s+". Available gradients found: "+Object.keys(p)+".");var d,f=p[s](),l=e.inputAndArgs.inputs[s];if(!util.arraysEqual(f.shape,l.shape))throw new Error("Error in gradient for op "+e.name+". The gradient of input '"+s+"' has shape '"+f.shape+"', which does not match the shape of the input '"+l.shape+"'");null==t[l.id]?t[l.id]=f:(d=t[l.id],t[l.id]=environment_1.ENV.math.add(d,f),d.dispose())}}}function computeInputs(t){for(var r={},n=0;n<t.length;n++){if((s=t[n]).output instanceof ndarray_1.NDArray)r[s.output.id]=!0;else for(var e=0,i=Object.keys(s.output);e<i.length;e++){var o=i[e];r[s.output[o].id]=!0}}for(var u={},a={},p=0,n=0;n<t.length;n++)for(var s,d=(s=t[n]).inputAndArgs.inputs,f=0,l=Object.keys(d);f<l.length;f++){r[d[o=l[f]].id]||a[d[o].id]||(u[(p++).toString()]=d[o],a[d[o].id]=!0)}return u}function extractNDArraysFromScopeResult(t){if(null==t)return[];if(t instanceof ndarray_1.NDArray)return[t];var r=[],n=t;for(var e in n){var i=n[e];i instanceof ndarray_1.NDArray&&r.push(i)}return r}function stripUndefinedInputsFromInputConfig(r){return Object.keys(r.inputs).forEach(function(t){null==r.inputs[t]&&delete r.inputs[t]}),r}exports.getFilteredNodesXToY=getFilteredNodesXToY,exports.backpropagateGradients=backpropagateGradients,exports.computeInputs=computeInputs,exports.extractNDArraysFromScopeResult=extractNDArraysFromScopeResult,exports.stripUndefinedInputsFromInputConfig=stripUndefinedInputsFromInputConfig;