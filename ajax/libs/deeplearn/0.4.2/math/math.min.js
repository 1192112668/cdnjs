"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),util=require("../util"),axis_util=require("./axis_util"),backend_engine_1=require("./backends/backend_engine"),matmul_1=require("./backends/types/matmul"),broadcast_util=require("./broadcast_util"),concat_util=require("./concat_util"),conv_util=require("./conv_util"),ndarray_1=require("./ndarray"),slice_util=require("./slice_util"),NDArrayMath=function(){function t(t,e){this.registeredArrays=new Map,this.customBackend=!1,this.registeredVariables={},"string"==typeof t?this.backend=environment_1.ENV.getBackend(t):(this.customBackend=!0,this.backend=t),this.backendEngine=new backend_engine_1.BackendEngine(this.backend,e)}return t.prototype.time=function(t){return this.backend.time(t)},t.prototype.getNumArrays=function(){return this.registeredArrays.size},t.prototype.register=function(t){var e=this.registeredArrays.has(t.dataId)?this.registeredArrays.get(t.dataId):0;0===e&&this.backend.register(t.dataId,t.shape,t.dtype),this.registeredArrays.set(t.dataId,e+1),t instanceof ndarray_1.Variable||this.backendEngine.track(t)},t.prototype.registerVariable=function(t){if(null!=this.registeredVariables[t.name])throw new Error("Variable with name "+t.name+" was already registered");this.registeredVariables[t.name]=t},t.prototype.writePixels=function(t,e,r){this.backend.writePixels(t,e,r)},t.prototype.write=function(t,e){this.backend.write(t,e)},t.prototype.readSync=function(t){return this.backend.readSync(t)},t.prototype.read=function(t){return this.backend.read(t)},t.prototype.enableDebugMode=function(){this.backendEngine.enableDebugMode(),console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")},t.prototype.scope=function(t){return this.backendEngine.scope("scope",t,!1)},t.prototype.gradientsScope=function(t){return this.backendEngine.scope("gradientsScope",t,!0)},t.prototype.startScope=function(){this.backendEngine.startScope(!1)},t.prototype.endScope=function(t){this.backendEngine.endScope(t,!1)},t.prototype.keep=function(t){return this.backendEngine.keep(t)},t.prototype.track=function(t){return t},t.prototype.dispose=function(){this.customBackend&&this.backend.dispose()},t.prototype.matMul=function(r,n,a,i){var s=this;void 0===a&&(a=matmul_1.MatrixOrientation.REGULAR),void 0===i&&(i=matmul_1.MatrixOrientation.REGULAR);var t=a===matmul_1.MatrixOrientation.REGULAR?r.shape[1]:r.shape[0],e=i===matmul_1.MatrixOrientation.REGULAR?n.shape[0]:n.shape[1];return util.assert(2===r.rank&&2===n.rank,"Error in matMul: inputs must be rank 2, got ranks "+r.rank+" and "+n.rank+"."),util.assert(t===e,"Error in matMul: inner shapes ("+t+") and ("+e+") of NDArrays with shapes "+r.shape+" and "+n.shape+" and orientations "+matmul_1.MatrixOrientation[a]+" and "+matmul_1.MatrixOrientation[i]+" must match."),this.backendEngine.executeKernel("MatMul",{inputs:{a:r,b:n},args:{aOrientation:a,bOrientation:i}},function(t,e){if(a===matmul_1.MatrixOrientation.TRANSPOSED||i===matmul_1.MatrixOrientation.TRANSPOSED)throw new Error("Backprop for transposed MatMul not yet implemented.");return{a:function(){return s.matMul(t,n,matmul_1.MatrixOrientation.REGULAR,matmul_1.MatrixOrientation.TRANSPOSED)},b:function(){return s.matMul(r,t,matmul_1.MatrixOrientation.TRANSPOSED,matmul_1.MatrixOrientation.REGULAR)}}})},t.prototype.executeOp=function(t,e){return e()},t.prototype.vectorTimesMatrix=function(t,e){return util.assert(1===t.rank,"Error in vectorTimesMatrix: first input must be rank 1, but got rank "+t.rank+"."),util.assert(2===e.rank,"Error in vectorTimesMatrix: second input must be rank 2, but got rank "+e.rank+"."),util.assert(t.size===e.shape[0],"Error in vectorTimesMatrix: size of vector ("+t.size+") must match first dimension of matrix ("+e.shape[0]+")"),this.matMul(t.as2D(1,-1),e).as1D()},t.prototype.matrixTimesVector=function(t,e){return util.assert(1===e.rank,"Error in matrixTimesVector: second input must rank 1, but got rank "+e.rank+"."),util.assert(2===t.rank,"Error in matrixTimesVector: first input must be a rank 2, but got rank "+t.rank+"."),util.assert(e.size===t.shape[1],"Error in matrixTimesVector: size of first rank 1 input "+e.size+" must match inner dimension of second rank 2 input, but got shape "+t.shape+"."),this.matMul(t,e.as2D(-1,1)).as1D()},t.prototype.dotProduct=function(t,e){return util.assert(1===t.rank&&1===e.rank,"Error in dotProduct: inputs must be rank 1, but got ranks "+t.rank+" and "+e.rank+"."),util.assert(t.size===e.size,"Error in dotProduct: size of inputs ("+t.size+") and ("+e.size+") must match."),this.matMul(t.as2D(1,-1),e.as2D(-1,1)).asScalar()},t.prototype.outerProduct=function(t,e){return util.assert(1===t.rank&&1===e.rank,"Error in outerProduct: inputs must be rank 1, but got ranks "+t.rank+" and "+e.rank+"."),this.matMul(t.as2D(-1,1),e.as2D(1,-1))},t.prototype.clone=function(t){return this.backendEngine.executeKernel("Clone",{inputs:{x:t}})},t.prototype.reshape=function(r,t){t=util.inferFromImplicitShape(t,r.size),util.assert(r.size===util.sizeFromShape(t),"new shape and old shape must have the same number of elements.");return this.backendEngine.executeKernel("Reshape",{inputs:{x:r},args:{newShape:t}},function(t,e){return{x:function(){return t.reshape(r.shape)}}})},t.prototype.cast=function(t,e){return this.backendEngine.executeKernel("Cast",{inputs:{x:t},args:{newDType:e}},function(t,e){return{x:function(){return t.reshape(t.shape)}}})},t.prototype.slice1D=function(t,e,r){return slice_util.assertParamsValid(t,[e],[r]),this.backendEngine.executeKernel("Slice1D",{inputs:{x:t},args:{begin:e,size:r}})},t.prototype.slice2D=function(t,e,r){return slice_util.assertParamsValid(t,e,r),this.backendEngine.executeKernel("Slice2D",{inputs:{x:t},args:{begin:e,size:r}})},t.prototype.slice3D=function(t,e,r){return slice_util.assertParamsValid(t,e,r),this.backendEngine.executeKernel("Slice3D",{inputs:{x:t},args:{begin:e,size:r}})},t.prototype.slice4D=function(t,e,r){return slice_util.assertParamsValid(t,e,r),this.backendEngine.executeKernel("Slice4D",{inputs:{x:t},args:{begin:e,size:r}})},t.prototype.reverse1D=function(t){util.assert(1===t.rank,"Error in reverse1D: x must be rank 1 but got\n             rank "+t.rank+".");var e=t.as4D(1,1,1,t.shape[0]);return this.reverse4D(e,[3]).as1D()},t.prototype.reverse2D=function(t,e){util.assert(2===t.rank,"Error in reverse2D: x must be rank 2 but got\n             rank "+t.rank+".");var r=axis_util.parseAxisParam(e,t.shape).map(function(t){return t+2}),n=t.as4D(1,1,t.shape[0],t.shape[1]),a=this.reverse4D(n,r);return a.as2D(a.shape[2],a.shape[3])},t.prototype.reverse3D=function(t,e){util.assert(3===t.rank,"Error in reverse3D: x must be rank 3 but got\n             rank "+t.rank+".");var r=axis_util.parseAxisParam(e,t.shape).map(function(t){return t+1}),n=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]),a=this.reverse4D(n,r);return a.as3D(a.shape[1],a.shape[2],a.shape[3])},t.prototype.reverse4D=function(t,e){util.assert(4===t.rank,"Error in reverse4D: x must be rank 4 but got\n             rank "+t.rank+".");var r=axis_util.parseAxisParam(e,t.shape);return this.backendEngine.executeKernel("Reverse4D",{inputs:{x:t},args:{axis:r}})},t.prototype.concat1D=function(t,e){return concat_util.assertParams(t.shape,e.shape,0),this.backendEngine.executeKernel("Concat1D",{inputs:{a:t,b:e}})},t.prototype.concat2D=function(t,e,r){return concat_util.assertParams(t.shape,e.shape,r),this.backendEngine.executeKernel("Concat2D",{inputs:{a:t,b:e},args:{axis:r}})},t.prototype.concat3D=function(o,t,u){var p=this;concat_util.assertParams(o.shape,t.shape,u);return this.backendEngine.executeKernel("Concat3D",{inputs:{a:o,b:t},args:{axis:u}},function(t,e){var r=concat_util.computeGradientSliceShapes3D(o.shape,e.shape,u),n=r.x1Begin,a=r.x1Size,i=r.x2Begin,s=r.x2Size;return{a:function(){return p.slice3D(t,n,a)},b:function(){return p.slice3D(t,i,s)}}})},t.prototype.concat4D=function(t,e,r){return concat_util.assertParams(t.shape,e.shape,r),this.backendEngine.executeKernel("Concat4D",{inputs:{a:t,b:e},args:{axis:r}})},t.prototype.logSumExp=function(o,t,u){var p=this;void 0===t&&(t=null),void 0===u&&(u=!1);var c=axis_util.parseAxisParam(t,o.shape);return this.executeOp("logSumExp",function(){var t=p.max(o,c,!0),e=p.subtract(o,t),r=p.exp(e),n=p.sum(r,c),a=p.log(n),i=p.add(t.reshape(a.shape),a);if(u){var s=axis_util.expandShapeToKeepDim(i.shape,c);return i.reshape(s)}return i})},t.prototype.sum=function(i,t,s){var o=this;void 0===t&&(t=null),void 0===s&&(s=!1);var u=axis_util.parseAxisParam(t,i.shape);return this.executeOp("sum",function(){return o.customGradient(function(){var t=axis_util.getAxesPermutation(u,i.rank),e=u,r=i;null!=t&&(r=o.transpose(i,t),e=axis_util.getInnerMostAxes(e.length,i.rank));var n,a=o.backendEngine.executeKernel("Sum",{inputs:{x:r},args:{axes:e}});s&&(n=axis_util.expandShapeToKeepDim(a.shape,u),a=a.reshape(n));return{value:a,gradients:function(t){var e=i.shape.slice();u.forEach(function(t){e[t]=1});var r=t.reshape(e);return{x:function(){return o.multiply(r,ndarray_1.NDArray.ones(i.shape,"float32"))}}}}},{x:i},"sum")})},t.prototype.mean=function(a,e,r){var i=this;void 0===e&&(e=null),void 0===r&&(r=!1);var s=axis_util.parseAxisParam(e,a.shape),t=axis_util.computeOutAndReduceShapes(a.shape,s)[1],o=util.sizeFromShape(t);return this.executeOp("mean",function(){return i.customGradient(function(){var n=ndarray_1.Scalar.new(o),t=i.divide(a,n);return{value:i.sum(t,e,r),gradients:function(t){var e=a.shape.slice();s.forEach(function(t){e[t]=1});var r=t.reshape(e);return{x:function(){return i.divide(i.multiply(r,ndarray_1.NDArray.ones(a.shape,"float32")),n)}}}}},{x:a},"mean")})},t.prototype.argMin=function(t,e){var r=this;void 0===e&&(e=null);var n=axis_util.parseAxisParam(e,t.shape),a=axis_util.getAxesPermutation(n,t.rank);return this.executeOp("argMin",function(){return null!=a&&(t=r.transpose(t,a),n=axis_util.getInnerMostAxes(n.length,t.rank)),r.backendEngine.executeKernel("ArgMin",{inputs:{x:t},args:{axes:n}})})},t.prototype.argMax=function(t,e){var r=this;void 0===e&&(e=null);var n=axis_util.parseAxisParam(e,t.shape),a=axis_util.getAxesPermutation(n,t.rank);return this.executeOp("argMax",function(){return null!=a&&(t=r.transpose(t,a),n=axis_util.getInnerMostAxes(n.length,t.rank)),r.backendEngine.executeKernel("ArgMax",{inputs:{x:t},args:{axes:n}})})},t.prototype.argMaxEquals=function(t,e){var r=this;return util.assertShapesMatch(t.shape,e.shape,"Error in argMaxEquals: "),this.executeOp("argMaxEquals",function(){return r.scope(function(){return r.equal(r.argMax(t),r.argMax(e))})})},t.prototype.equal=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("Equal",{inputs:{a:t,b:e}})},t.prototype.equalStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in equalStrict: "),this.equal(t,e)},t.prototype.notEqual=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("NotEqual",{inputs:{a:t,b:e}})},t.prototype.notEqualStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in notEqualStrict: "),this.notEqual(t,e)},t.prototype.lessEqual=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("LessEqual",{inputs:{a:t,b:e}})},t.prototype.greater=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("Greater",{inputs:{a:t,b:e}})},t.prototype.greaterEqual=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("GreaterEqual",{inputs:{a:t,b:e}})},t.prototype.logicalOr=function(t,e){return util.assert("bool"===t.dtype||"bool"===e.dtype,"Error Array must be of type bool."),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("LogicalOr",{inputs:{a:t,b:e}})},t.prototype.topK=function(t,e){var r,n,a=this;return util.assert(e<=t.size,"Error in topK: k value ("+e+") must be less than size of input ndarray, got shape "+t.shape+"."),this.executeOp("topK",function(){return r=a.backendEngine.executeKernel("TopKValues",{inputs:{x:t},args:{k:e}}),n=a.backendEngine.executeKernel("TopKIndices",{inputs:{x:t},args:{k:e}}),r}),{values:r,indices:n}},t.prototype.min=function(r,t,n){var a=this;void 0===t&&(t=null),void 0===n&&(n=!1);var i=axis_util.parseAxisParam(t,r.shape),s=i,o=axis_util.getAxesPermutation(s,r.rank);return this.executeOp("min",function(){null!=o&&(r=a.transpose(r,o),s=axis_util.getInnerMostAxes(s.length,r.rank));var t=a.backendEngine.executeKernel("Min",{inputs:{x:r},args:{axes:s}});if(n){var e=axis_util.expandShapeToKeepDim(t.shape,i);return t.reshape(e)}return t})},t.prototype.minimum=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("Minimum",{inputs:{a:t,b:e}})},t.prototype.max=function(r,t,n){var a=this;void 0===t&&(t=null),void 0===n&&(n=!1);var i=axis_util.parseAxisParam(t,r.shape),s=i,o=axis_util.getAxesPermutation(s,r.rank);return this.executeOp("max",function(){null!=o&&(r=a.transpose(r,o),s=axis_util.getInnerMostAxes(s.length,r.rank));var t=a.backendEngine.executeKernel("Max",{inputs:{x:r},args:{axes:s}});if(n){var e=axis_util.expandShapeToKeepDim(t.shape,i);return t.reshape(e)}return t})},t.prototype.maximum=function(t,e){return util.assertTypesMatch(t,e),broadcast_util.assertAndGetBroadcastShape(t.shape,e.shape),this.backendEngine.executeKernel("Maximum",{inputs:{a:t,b:e}})},t.prototype.softmax=function(r,n){var a=this;if(void 0===n&&(n=-1),-1===n&&(n=r.rank-1),n!==r.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+r.rank+" and dim was "+n);function i(e,r){return{logits:function(){var t=a.multiply(e,r);return a.subtract(t,a.multiply(a.sum(t,[n],!0),r))}}}return this.executeOp("softmax",function(){return a.customGradient(function(){var t=a.logSumExp(r,[n],!0),e=a.subtract(r.asType("float32"),t);return{value:a.exp(e),gradients:i}},{logits:r},"softmax")})},t.prototype.softmaxCrossEntropyWithLogits=function(i,s,o){var u=this;if(void 0===o&&(o=-1),util.assertShapesMatch(i.shape,s.shape,"Error in softmaxCrossEntropyWithLogits: "),-1===o&&(o=s.rank-1),o!==s.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+s.rank+" and dim was "+o);return this.executeOp("softmaxCrossEntropyWithLogits",function(){return u.customGradient(function(){var n=u.softmax(s,o),t=u.add(ndarray_1.Scalar.new(1e-5),n),e=u.log(t),r=u.multiply(i,e),a=u.neg(r);return{value:u.sum(a,[o]),gradients:function(t,e){var r=axis_util.expandShapeToKeepDim(t.shape,[o]);return{logits:function(){return u.multiply(t.reshape(r),u.subtract(n,i.asType("float32")))},labels:function(){return u.multiply(t.reshape(r),u.subtract(i,n))}}}}},{labels:i,logits:s},"softmaxCrossEntropyWithLogits")})},t.prototype.switchDim=function(t,e){return this.transpose(t,e)},t.prototype.tile=function(t,e){return util.assert(t.rank===e.length,"Error in transpose: rank of input "+t.rank+" must match length of reps "+e+"."),this.backendEngine.executeKernel("Tile",{inputs:{x:t},args:{reps:e}})},t.prototype.pad1D=function(t,e,r){return void 0===r&&(r=0),util.assert(2===e.length,"Invalid number of paddings. Must be length of 2."),this.backendEngine.executeKernel("Pad1D",{inputs:{x:t},args:{paddings:e,constantValue:r}})},t.prototype.pad2D=function(t,e,r){return void 0===r&&(r=0),util.assert(2===e.length&&2===e[0].length&&2===e[1].length,"Invalid number of paddings. Must be length of 2 each."),this.backendEngine.executeKernel("Pad2D",{inputs:{x:t},args:{paddings:e,constantValue:r}})},t.prototype.transpose=function(t,r){var n=this;null==r&&(r=t.shape.map(function(t,e){return e}).reverse());return util.assert(t.rank===r.length,"Error in transpose: rank of input "+t.rank+" must match length of perm "+r+"."),this.backendEngine.executeKernel("Transpose",{inputs:{x:t},args:{perm:r}},function(t){var e=axis_util.getUndoAxesPermutation(r);return{x:function(){return n.transpose(t,e)}}})},t.prototype.scalarPlusArray=function(t,e){return util.assert(1===t.size,"Error in scalarPlusArray: first argument must be rank 0, but got rank "+t.rank+"."),this.add(t,e)},t.prototype.scalarMinusArray=function(t,e){return util.assert(1===t.size,"Error in scalarMinusArray: first argument must be rank 0, but got rank "+t.rank+"."),this.subtract(t,e)},t.prototype.arrayMinusScalar=function(t,e){return util.assert(1===e.size,"Error in arrayMinusScalar: second argument must be rank 0, but got rank "+e.rank+"."),this.subtract(t,e)},t.prototype.neg=function(t){return this.backendEngine.executeKernel("Neg",{inputs:{x:t}})},t.prototype.add=function(n,a){var i=this;util.assertTypesMatch(n,a);var s=broadcast_util.assertAndGetBroadcastShape(n.shape,a.shape);return this.backendEngine.executeKernel("Add",{inputs:{a:n,b:a}},function(r,t){return{a:function(){var t=r,e=broadcast_util.getReductionAxes(n.shape,s);return 0<e.length&&(t=i.sum(t,e)),t.reshape(n.shape)},b:function(){var t=r,e=broadcast_util.getReductionAxes(a.shape,s);return 0<e.length&&(t=i.sum(t,e)),t.reshape(a.shape)}}})},t.prototype.addStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in addStrict: "),this.add(t,e)},t.prototype.subtract=function(n,a){var i=this;util.assertTypesMatch(n,a);var s=broadcast_util.assertAndGetBroadcastShape(n.shape,a.shape);return this.backendEngine.executeKernel("Sub",{inputs:{a:n,b:a}},function(r,t){return{a:function(){var t=r,e=broadcast_util.getReductionAxes(n.shape,s);return 0<e.length&&(t=i.sum(t,e)),t.reshape(n.shape)},b:function(){var t=r,e=broadcast_util.getReductionAxes(a.shape,s);return 0<e.length&&(t=i.sum(t,e)),i.neg(t).reshape(a.shape)}}})},t.prototype.pow=function(r,n){var a=this;util.assert("int32"===n.dtype,"only supports int32 data type for the exponent parameter."),broadcast_util.assertAndGetBroadcastShape(r.shape,n.shape);return this.backendEngine.executeKernel("Pow",{inputs:{a:r,b:n}},function(t,e){if(!util.arraysEqual(r.shape,n.shape))throw new Error("Gradient of pow not yet supported for broadcasted shapes.");return{a:function(){return a.scope(function(){return a.multiply(t,a.multiply(n.asType(r.dtype),a.pow(r,a.subtract(n,ndarray_1.Scalar.new(1,"int32")))))})},b:function(){throw new Error("Backprop through exponent of math.pow not implemented yet.")}}})},t.prototype.powStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in powStrict: "),this.pow(t,e)},t.prototype.sub=function(t,e){return this.subtract(t,e)},t.prototype.subStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in subStrict: "),this.subtract(t,e)},t.prototype.multiply=function(n,a){var i=this;util.assertTypesMatch(n,a);var s=broadcast_util.assertAndGetBroadcastShape(n.shape,a.shape);return this.backendEngine.executeKernel("Mul",{inputs:{a:n,b:a}},function(r,t){return{a:function(){var t=i.multiply(r,a.asType("float32")),e=broadcast_util.getReductionAxes(n.shape,s);return 0<e.length?i.sum(t,e).reshape(n.shape):t},b:function(){var t=i.multiply(r,n.asType("float32")),e=broadcast_util.getReductionAxes(a.shape,s);return 0<e.length?i.sum(t,e).reshape(a.shape):t}}})},t.prototype.elementWiseMul=function(t,e){return this.multiplyStrict(t,e)},t.prototype.multiplyStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in multiplyStrict: "),this.multiply(t,e)},t.prototype.divide=function(n,a){var i=this,s=broadcast_util.assertAndGetBroadcastShape(n.shape,a.shape);return this.backendEngine.executeKernel("Div",{inputs:{a:n,b:a}},function(r,t){return{a:function(){var t=i.divide(r,a.asType("float32")),e=broadcast_util.getReductionAxes(n.shape,s);return 0<e.length?i.sum(t,e).reshape(n.shape):t},b:function(){var t=i.multiply(r,n.asType("float32")),e=broadcast_util.getReductionAxes(a.shape,s);return 0<e.length&&(t=i.sum(t,e).reshape(a.shape)),i.neg(i.divide(t,i.square(a)))}}})},t.prototype.divideStrict=function(t,e){return util.assertShapesMatch(t.shape,e.shape,"Error in divideStrict: "),this.divide(t,e)},t.prototype.scalarDividedByArray=function(t,e){return util.assert(1===t.size,"Error in scalarDividedByArray: first argument must be rank 0, but got NDArray of rank "+t.rank+"."),this.divide(t,e)},t.prototype.arrayDividedByScalar=function(t,e){return util.assert(1===e.size,"Error in arrayDividedByScalar: second argument must be rank 0, but got NDArray of rank "+e.rank+"."),this.divide(t,e)},t.prototype.ceil=function(t){return this.backendEngine.executeKernel("Ceil",{inputs:{x:t}})},t.prototype.floor=function(t){return this.backendEngine.executeKernel("Floor",{inputs:{x:t}})},t.prototype.exp=function(t){return this.backendEngine.executeKernel("Exp",{inputs:{x:t}})},t.prototype.log=function(t){return this.backendEngine.executeKernel("Log",{inputs:{x:t}})},t.prototype.sqrt=function(t){return this.backendEngine.executeKernel("Sqrt",{inputs:{x:t}})},t.prototype.square=function(r){var n=this;return this.backendEngine.executeKernel("Square",{inputs:{x:r}},function(t,e){return{x:function(){return n.multiply(t,n.multiply(r.asType("float32"),ndarray_1.Scalar.new(2)))}}})},t.prototype.abs=function(t){return this.backendEngine.executeKernel("Abs",{inputs:{x:t}})},t.prototype.clip=function(t,e,r){return util.assert(e<=r,"Error in clip: min ("+e+") must beless than or equal to max ("+r+")."),this.backendEngine.executeKernel("Clip",{inputs:{x:t},args:{min:e,max:r}})},t.prototype.relu=function(r){var n=this;return this.backendEngine.executeKernel("Relu",{inputs:{x:r}},function(t,e){return{x:function(){return n.multiply(t,n.step(r).asType("float32"))}}})},t.prototype.elu=function(t){return this.backendEngine.executeKernel("Elu",{inputs:{x:t}})},t.prototype.eluDer=function(t){return this.backendEngine.executeKernel("EluDer",{inputs:{x:t}})},t.prototype.selu=function(t){return this.backendEngine.executeKernel("Selu",{inputs:{x:t}})},t.prototype.leakyRelu=function(t,e){return void 0===e&&(e=.2),this.backendEngine.executeKernel("LeakyRelu",{inputs:{x:t},args:{alpha:e}})},t.prototype.prelu=function(t,e){return this.backendEngine.executeKernel("PReLU",{inputs:{x:t,alpha:e}})},t.prototype.preluDer=function(t,e){return this.backendEngine.executeKernel("PReLUDer",{inputs:{x:t,alpha:e}})},t.prototype.sigmoid=function(t){return this.backendEngine.executeKernel("Sigmoid",{inputs:{x:t}})},t.prototype.sin=function(t){return this.backendEngine.executeKernel("Sin",{inputs:{x:t}})},t.prototype.cos=function(t){return this.backendEngine.executeKernel("Cos",{inputs:{x:t}})},t.prototype.tan=function(t){return this.backendEngine.executeKernel("Tan",{inputs:{x:t}})},t.prototype.asin=function(t){return this.backendEngine.executeKernel("Asin",{inputs:{x:t}})},t.prototype.acos=function(t){return this.backendEngine.executeKernel("Acos",{inputs:{x:t}})},t.prototype.atan=function(t){return this.backendEngine.executeKernel("Atan",{inputs:{x:t}})},t.prototype.sinh=function(t){return this.backendEngine.executeKernel("Sinh",{inputs:{x:t}})},t.prototype.cosh=function(t){return this.backendEngine.executeKernel("Cosh",{inputs:{x:t}})},t.prototype.tanh=function(t){return this.backendEngine.executeKernel("Tanh",{inputs:{x:t}})},t.prototype.step=function(t,e){return void 0===e&&(e=0),this.backendEngine.executeKernel("Step",{inputs:{x:t},args:{alpha:e}})},t.prototype.scaledArrayAdd=function(t,e,r,n){var a=this;return util.assert(1===t.size,"Error in scaledArrayAdd: first argument must rank 0, but got  rank "+t.rank+"."),util.assert(1===r.size,"Error in scaledArrayAdd: third argument must be rank 0, but got NDArray of rank "+r.rank+"."),util.assertShapesMatch(e.shape,n.shape,"Error in scaledArrayAdd: "),this.executeOp("scaledArrayAdd",function(){return a.scope(function(){return a.add(a.multiply(t,e),a.multiply(r,n))})})},t.prototype.scalarTimesArray=function(t,e){return util.assert(1===t.size,"Error in arrayDividedByScalar: first argument must be rank 0, but got rank "+t.rank+"."),this.multiply(t,e)},t.prototype.elementWiseMulBroadcast=function(t,e){return util.assert(2===t.rank,"Error in elementWiseMulBroadcast: first argument must be rank 2, but got rank "+t.rank+"."),util.assert(2===e.rank,"Error in elementWiseMulBroadcast: second argument must be rank 2, but got rank "+e.rank+"."),this.multiply(t,e)},t.prototype.conv1d=function(t,e,r,n,a,i){var s=this,o=t,u=!1;2===t.rank&&(u=!0,o=t.as3D(1,t.shape[0],t.shape[1])),util.assert(3===o.rank,"Error in conv1d: input must be rank 3, but got rank "+o.rank+"."),util.assert(3===e.rank,"Error in conv1d: filter must be rank 3, but got rank "+e.rank+"."),null!=r&&util.assert(1===r.rank,"Error in conv1d: bias must be rank 1, but got rank "+r.rank+"."),null!=i&&util.assert(util.isInt(a),"Error in conv1d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+a+"."),util.assert(o.shape[2]===e.shape[1],"Error in conv1d: depth of input ("+o.shape[2]+") must match  input depth for filter "+e.shape[1]+".");var p=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),c=o.as4D(o.shape[0],1,o.shape[1],o.shape[2]),l=[1,n];return this.executeOp("Conv1D",function(){var t=s.conv2d(c,p,r,l,a,i);return u?t.as2D(t.shape[2],t.shape[3]):t.as3D(t.shape[0],t.shape[2],t.shape[3])})},t.prototype.conv2d=function(t,r,e,n,a,i){var s=this,o=t,u=!1;3===t.rank&&(u=!0,o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===o.rank,"Error in conv2d: input must be rank 4, but got rank "+o.rank+"."),util.assert(4===r.rank,"Error in conv2d: filter must be rank 4, but got rank "+r.rank+"."),null!=e&&util.assert(1===e.rank,"Error in conv2d: bias must be rank 1, but got rank "+e.rank+"."),null!=i&&util.assert(util.isInt(a),"Error in conv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+a+"."),util.assert(o.shape[3]===r.shape[2],"Error in conv2d: depth of input ("+o.shape[3]+") must match  input depth for filter "+r.shape[2]+".");var p=conv_util.computeConv2DInfo(o.shape,r.shape,n,a,i);return this.executeOp("Conv2D",function(){var t=s.backendEngine.executeKernel("Conv2D",{inputs:{x:o,filter:r,bias:e},args:{convInfo:p}},function(t,e){return{x:function(){return s.conv2dDerInput(o.shape,t,r,n,a)},filter:function(){return s.conv2dDerFilter(o,t,r.shape,n,a)},bias:function(){return s.conv2dDerBias(t)}}});return u?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.conv2dDerInput=function(t,e,r,n,a,i){var s=this;util.assert(t.length===e.rank,"Length of inShape ("+t.length+") and rank of dy ("+e.rank+") must match");var o=t,u=e,p=!1;3===e.rank&&(p=!0,u=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),o=[1,t[0],t[1],t[2]]);var c=o[3],l=u.shape[3];util.assert(4===o.length,"Error in conv2dDerInput: inShape must be length 4, but got length "+o.length+"."),util.assert(4===u.rank,"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank),util.assert(4===r.rank,"Error in conv2dDerInput: filter must be rank 4, but got rank "+r.rank),util.assert(c===r.shape[2],"Error in conv2dDerInput: depth of input ("+c+") must match input depth for filter "+r.shape[2]+"."),util.assert(l===r.shape[3],"Error in conv2dDerInput: depth of output ("+l+") mustmatch output depth for filter "+r.shape[3]+"."),null!=i&&util.assert(util.isInt(a),"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+a+".");var h=conv_util.computeConv2DInfo(o,r.shape,n,a,i);return this.executeOp("conv2dDerInput",function(){var t=s.backendEngine.executeKernel("Conv2DDerInput",{inputs:{dy:u,filter:r},args:{convInfo:h}});return p?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.conv2dDerBias=function(t){var e=t;return 3===t.rank&&(e=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),this.backendEngine.executeKernel("Conv2DDerBias",{inputs:{dy:e}})},t.prototype.conv2dDerFilter=function(t,e,r,n,a,i){var s=t;3===t.rank&&(s=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var o=e;3===o.rank&&(o=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),util.assert(4===s.rank,"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."),util.assert(4===o.rank,"Error in conv2dDerFilter: dy must be rank 4, but got shape "+o.shape+"."),util.assert(4===r.length,"Error in conv2dDerFilter: filterShape must be length 4, but got "+r+"."),util.assert(s.shape[3]===r[2],"Error in conv2dDerFilter: depth of input "+s.shape[3]+") must match input depth in filter ("+r[2]+"."),util.assert(o.shape[3]===r[3],"Error in conv2dDerFilter: depth of dy ("+o.shape[3]+") must match output depth for filter ("+r[3]+")."),null!=i&&util.assert(util.isInt(a),"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+a+".");var u=conv_util.computeConv2DInfo(s.shape,r,n,a,i);return this.backendEngine.executeKernel("Conv2DDerFilter",{inputs:{x:s,dy:o},args:{convInfo:u}})},t.prototype.conv2dTranspose=function(t,e,r,n,a,i){return this.conv2dDerInput(r,t,e,n,a,i)},t.prototype.depthwiseConv2D=function(t,e,r,n,a,i){var s=this;void 0===a&&(a=[1,1]);var o=t,u=!1;3===t.rank&&(u=!0,o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===o.rank,"Error in depthwiseConv2D: input must be rank 4, but got rank "+o.rank+"."),util.assert(4===e.rank,"Error in depthwiseConv2D: filter must be rank 4, but got rank "+e.rank+"."),util.assert(o.shape[3]===e.shape[2],"Error in depthwiseConv2D: number of input channels ("+o.shape[3]+") must match the inChannels dimension in filter "+e.shape[2]+".");var p=parseTupleParam(a=a||[1,1]),c=p[0],l=p[1];util.assert(1===c&&1===l,"Error in depthwiseConv2D: rates greater than 1 are not yet supported. Got rates '"+a+"'"),null!=i&&util.assert(util.isInt(n),"Error in depthwiseConv2D: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+n+".");var h=conv_util.computeConv2DInfo(o.shape,e.shape,r,n,i,!0);return this.executeOp("depthwiseConv2D",function(){var t=s.backendEngine.executeKernel("DepthwiseConv2D",{inputs:{x:o,filter:e},args:{convInfo:h}});return u?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.maxPool=function(t,r,n,a,e){var i=this,s=t,o=!1;3===t.rank&&(o=!0,s=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===s.rank,"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."),null!=e&&util.assert(util.isInt(a),"Error in maxPool: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+a+".");function u(t,e){return{x:function(){return i.maxPoolBackprop(t,s,r,n,a)}}}var p=conv_util.computePool2DInfo(s.shape,r,n,a,e);return this.executeOp("maxPool",function(){var t=i.backendEngine.executeKernel("MaxPool",{inputs:{x:s},args:{convInfo:p}},u);return o?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.maxPoolBackprop=function(t,e,r,n,a,i){var s=this;util.assert(e.rank===t.rank,"Rank of input ("+e.rank+") does not match rank of dy ("+t.rank+")");var o=e,u=t,p=!1;3===e.rank&&(p=!0,o=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===u.rank,"Error in maxPoolBackprop: dy must be rank 4 but got rank "+u.rank+"."),util.assert(4===o.rank,"Error in maxPoolBackprop: input must be rank 4 but got rank "+o.rank+"."),null!=i&&util.assert(util.isInt(a),"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+a+".");var c=conv_util.computePool2DInfo(o.shape,r,n,a,i);return this.executeOp("maxPoolBackprop",function(){var t=s.backendEngine.executeKernel("MaxPoolBackprop",{inputs:{dy:u,x:o},args:{convInfo:c}});return p?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.minPool=function(t,e,r,n,a){var i=this,s=t,o=!1;3===t.rank&&(o=!0,s=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===s.rank,"Error in minPool: x must be rank 4 but got rank "+s.rank+"."),null!=a&&util.assert(util.isInt(n),"Error in minPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+n+".");var u=conv_util.computePool2DInfo(s.shape,e,r,n,a);return this.executeOp("minPool",function(){var t=i.backendEngine.executeKernel("MinPool",{inputs:{x:s},args:{convInfo:u}});return o?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.avgPool=function(t,r,n,a,e){var i=this,s=t,o=!1;3===t.rank&&(o=!0,s=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===s.rank,"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."),null!=e&&util.assert(util.isInt(a),"Error in avgPool: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+a+".");function u(t,e){return{x:function(){return i.avgPoolBackprop(t,s,r,n,a)}}}var p=conv_util.computePool2DInfo(s.shape,r,n,a);return this.executeOp("avgPool",function(){var t=i.backendEngine.executeKernel("AvgPool",{inputs:{x:s},args:{convInfo:p}},u);return o?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.avgPoolBackprop=function(t,e,r,n,a){var i=this;util.assert(e.rank===t.rank,"Rank of input ("+e.rank+") does not match rank of dy ("+t.rank+")");var s=e,o=t,u=!1;3===e.rank&&(u=!0,s=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]),o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),util.assert(4===o.rank,"Error in avgPoolBackprop: dy must be rank 4 but got rank "+o.rank+"."),util.assert(4===s.rank,"Error in avgPoolBackprop: input must be rank 4 but got rank "+s.rank+".");var p=conv_util.computePool2DInfo(s.shape,r,n,a);return this.executeOp("avgPoolBackprop",function(){var t=i.backendEngine.executeKernel("AvgPoolBackprop",{inputs:{dy:o,x:s},args:{convInfo:p}});return u?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t})},t.prototype.resizeBilinear3D=function(t,e,r){return void 0===r&&(r=!1),util.assert(3===t.rank,"Error in resizeBilinear3D: x must be rank 3 but got rank "+t.rank+"."),util.assert(2===e.length,"Error in resizeBilinear3D: new shape must 2D, but got shape "+e+"."),this.backendEngine.executeKernel("ResizeBilinear3D",{inputs:{x:t},args:{newShape2D:e,alignCorners:r}})},t.prototype.batchNormalization2D=function(t,e,r,n,a,i){return void 0===n&&(n=.001),util.assert(2===t.rank,"Error in batchNormalization3D: x must be rank 3 but got rank "+t.rank+"."),util.assert(2===e.rank||1===e.rank,"Error in batchNormalization2D: mean must be rank 2 or rank 1 but got rank "+e.rank+"."),util.assert(2===r.rank||1===r.rank,"Error in batchNormalization2D: variance must be rank 2 or rank 1 but got rank "+r.rank+"."),null!=a&&util.assert(2===a.rank||1===a.rank,"Error in batchNormalization2D: scale must be rank 2 or rank 1 but got rank "+a.rank+"."),null!=i&&util.assert(2===i.rank||1===i.rank,"Error in batchNormalization2D: offset must be rank 2 or rank 1 but got rank "+i.rank+"."),this.backendEngine.executeKernel("BatchNorm2D",{inputs:{x:t,mean:e,variance:r,scale:a,offset:i},args:{varianceEpsilon:n}})},t.prototype.batchNormalization3D=function(t,e,r,n,a,i){return void 0===n&&(n=.001),util.assert(3===t.rank,"Error in batchNormalization3D: x must be rank 3 but got rank "+t.rank+"."),util.assert(3===e.rank||1===e.rank,"Error in batchNormalization3D: mean must be rank 3 or rank 1 but got rank "+e.rank+"."),util.assert(3===r.rank||1===r.rank,"Error in batchNormalization3D: variance must be rank 3 or rank 1 but got rank "+r.rank+"."),null!=a&&util.assert(3===a.rank||1===a.rank,"Error in batchNormalization3D: scale must be rank 3 or rank 1 but got rank "+a.rank+"."),null!=i&&util.assert(3===i.rank||1===i.rank,"Error in batchNormalization3D: offset must be rank 3 or rank 1 but got rank "+i.rank+"."),this.backendEngine.executeKernel("BatchNorm3D",{inputs:{x:t,mean:e,variance:r,scale:a,offset:i},args:{varianceEpsilon:n}})},t.prototype.batchNormalization4D=function(t,e,r,n,a,i){return void 0===n&&(n=.001),util.assert(4===t.rank,"Error in batchNormalization4D: x must be rank 4 but got rank "+t.rank+"."),util.assert(4===e.rank||1===e.rank,"Error in batchNormalization4D: mean must be rank 4 or rank 1 but got rank "+e.rank+"."),util.assert(4===r.rank||1===r.rank,"Error in batchNormalization4D: variance must be rank 4 or rank 1 but got rank "+r.rank+"."),null!=a&&util.assert(4===a.rank||1===a.rank,"Error in batchNormalization4D: scale must be rank 4 or rank 1 but got rank "+a.rank+"."),null!=i&&util.assert(4===i.rank||1===i.rank,"Error in batchNormalization4D: offset must be rank 4 or rank 1 but got rank "+i.rank+"."),this.backendEngine.executeKernel("BatchNorm4D",{inputs:{x:t,mean:e,variance:r,scale:a,offset:i},args:{varianceEpsilon:n}})},t.prototype.localResponseNormalization3D=function(t,e,r,n,a,i){void 0===e&&(e=5),void 0===r&&(r=1),void 0===n&&(n=1),void 0===a&&(a=.5),void 0===i&&(i="acrossChannels"),util.assert(3===t.rank,"Error in localResponseNormalization3D: x must be rank 3 but got\n         rank "+t.rank+"."),util.assert(util.isInt(e),"Error in localResponseNormalization3D: radius must be an integer\n         but got radius "+e+".");var s=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]),o=this.localResponseNormalization4D(s,e,r,n,a,i);return o.as3D(o.shape[1],o.shape[2],o.shape[3])},t.prototype.localResponseNormalization4D=function(t,e,r,n,a,i){return void 0===e&&(e=5),void 0===r&&(r=1),void 0===n&&(n=1),void 0===a&&(a=.5),void 0===i&&(i="acrossChannels"),util.assert(4===t.rank,"Error in localResponseNormalization4D: x must be rank 4 but got\n         rank "+t.rank+"."),util.assert(util.isInt(e),"Error in localResponseNormalization3D: radius must be an integer\n         but got radius "+e+"."),this.backendEngine.executeKernel("LRN4D",{inputs:{x:t},args:{radius:e,bias:r,alpha:n,beta:a,normRegion:i}})},t.prototype.multiRNNCell=function(a,i,s,o){for(var t=this.scope(function(){for(var t=i,e=[],r=0;r<a.length;r++){var n=a[r](t,s[r],o[r]);e.push(n[0]),e.push(n[1]),t=n[1]}return e}),e=[],r=[],n=0;n<t.length;n+=2)e.push(t[n]),r.push(t[n+1]);return[e,r]},t.prototype.basicLSTMCell=function(l,h,d,m,k,g){var f=this,t=this.scope(function(){var t=f.concat2D(m,g,1),e=f.matMul(t,h),r=f.add(e,d),n=r.shape[0],a=r.shape[1]/4,i=[n,a],s=f.slice2D(r,[0,0],i),o=f.slice2D(r,[0,a],i),u=f.slice2D(r,[0,2*a],i),p=f.slice2D(r,[0,3*a],i),c=f.addStrict(f.multiplyStrict(k,f.sigmoid(f.add(l,u))),f.multiplyStrict(f.sigmoid(s),f.tanh(o)));return[c,f.multiplyStrict(f.tanh(c),f.sigmoid(p))]});return[t[0],t[1]]},t.prototype.multinomial=function(e,r,n){var a=this,t=e.size;if(t<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+t+".");if(2<e.rank)throw new Error("Rank of probabilities must be 1 or 2, but is "+e.rank);n=n||Math.random();var i=e.rank;return 1===e.rank&&(e=e.as2D(1,-1)),this.executeOp("multinomial",function(){var t=a.backendEngine.executeKernel("Multinomial",{inputs:{probs:e},args:{numSamples:r,seed:n}});return 1===i?t.as1D():t})},t.prototype.oneHot=function(t,e,r,n){if(void 0===r&&(r=1),void 0===n&&(n=0),e<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+e);return this.backendEngine.executeKernel("OneHot",{inputs:{indices:t},args:{depth:e,onValue:r,offValue:n}})},t.prototype.moments=function(n,t,a){var i=this;void 0===t&&(t=null),void 0===a&&(a=!1);var s=axis_util.parseAxisParam(t,n.shape);return this.scope(function(){var t=i.mean(n,s,a),e=t.shape;a||(e=axis_util.expandShapeToKeepDim(t.shape,s));var r=i.square(i.subtract(n.asType("float32"),t.reshape(e)));return{mean:t,variance:i.mean(r,s,a)}})},t.prototype.norm=function(n,a,i,s){var o=this;return void 0===a&&(a="euclidean"),void 0===i&&(i=null),void 0===s&&(s=!1),this.scope(function(){var t,e=o.normInternal(n,a,i),r=e.shape;return s&&(t=axis_util.parseAxisParam(i,n.shape),r=axis_util.expandShapeToKeepDim(e.shape,t)),e.reshape(r)})},t.prototype.normInternal=function(t,e,r){if(void 0===r&&(r=null),0===t.rank)return this.abs(t);if(1!==t.rank&&null===r)return this.normInternal(t.reshape([-1]),e,r);if(1===t.rank||"number"==typeof r||r instanceof Array&&1===r.length){if(1===e)return this.sum(this.abs(t),r);if(e===1/0)return this.max(this.abs(t),r);if(e===-1/0)return this.min(this.abs(t),r);if("euclidean"===e||2===e)return this.sqrt(this.sum(this.pow(this.abs(t),ndarray_1.Scalar.new(2,"int32")),r));throw new Error("Error in norm: invalid ord value: "+e)}if(r instanceof Array&&2===r.length){if(1===e)return this.max(this.sum(this.abs(t),r[0]),r[1]-1);if(e===1/0)return this.max(this.sum(this.abs(t),r[1]),r[0]);if(e===-1/0)return this.min(this.sum(this.abs(t),r[1]),r[0]);if("fro"===e||"euclidean"===e)return this.sqrt(this.sum(this.pow(t,ndarray_1.Scalar.new(2,"int32")),r));throw new Error("Error in norm: invalid ord value: "+e)}throw new Error("Error in norm: invalid axis: "+r)},t.prototype.vjp=function(t,e,r){var n=e instanceof ndarray_1.NDArray?null:Object.keys(e),a=util.flattenNameArrayMap(e,n),i=this.backendEngine.vjp(t,a,r);return e instanceof ndarray_1.NDArray?i[0]:util.unflattenToNameArrayMap(n,i)},t.prototype.gradients=function(t,e){var r=e instanceof ndarray_1.NDArray?null:Object.keys(e),n=util.flattenNameArrayMap(e,r),a=this.backendEngine.gradients(t,n,!1);return e instanceof ndarray_1.NDArray?a[0]:util.unflattenToNameArrayMap(r,a)},t.prototype.variableGradients=function(t){return this.valueAndGradients(t,this.registeredVariables)},t.prototype.valueAndGradients=function(t,e){var r=e instanceof ndarray_1.NDArray?null:Object.keys(e),n=util.flattenNameArrayMap(e,r),a=this.backendEngine.gradients(t,n,!0),i=e instanceof ndarray_1.NDArray?a.gradients[0]:util.unflattenToNameArrayMap(r,a.gradients);return{value:a.value,gradients:i}},t.prototype.customGradient=function(t,e,r){return this.backendEngine.customGradient(t,e,null==r?"":r)},t.prototype.disposeData=function(t){var e;this.registeredArrays.has(t)&&((e=this.registeredArrays.get(t))<=1?(this.registeredArrays.delete(t),this.backend.disposeData(t)):this.registeredArrays.set(t,e-1))},t}();function parseTupleParam(t){return"number"==typeof t?[t,t]:t}exports.NDArrayMath=NDArrayMath;