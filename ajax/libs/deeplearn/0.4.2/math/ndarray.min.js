"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)r.hasOwnProperty(e)&&(t[e]=r[e])};return function(t,r){function e(){this.constructor=t}n(t,r),t.prototype=null===r?Object.create(r):(e.prototype=r.prototype,new e)}}(),__awaiter=this&&this.__awaiter||function(o,i,s,u){return new(s=s||Promise)(function(t,r){function e(t){try{a(u.next(t))}catch(t){r(t)}}function n(t){try{a(u.throw(t))}catch(t){r(t)}}function a(r){r.done?t(r.value):new s(function(t){t(r.value)}).then(e,n)}a((u=u.apply(o,i||[])).next())})},__generator=this&&this.__generator||function(e,n){var a,o,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},t={next:r(0),throw:r(1),return:r(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function r(r){return function(t){return function(r){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,o&&(i=o[2&r[0]?"return":r[0]?"throw":"next"])&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[0,i.value]),r[0]){case 0:case 1:i=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,o=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){s.label=r[1];break}if(6===r[0]&&s.label<i[1]){s.label=i[1],i=r;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(r);break}i[2]&&s.ops.pop(),s.trys.pop();continue}r=n.call(e,s)}catch(t){r=[6,t],o=0}finally{a=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var DType,environment_1=require("../environment"),util=require("../util"),rand_1=require("./rand");!function(t){t.float32="float32",t.int32="int32",t.bool="bool"}(DType=exports.DType||(exports.DType={}));var NDArray=function(){function s(t,r,e,n,a){this.isDisposed=!1,this.math=a||environment_1.ENV.math,this.size=util.sizeFromShape(t),null!=e&&util.assert(this.size===e.length,"Constructing ndarray of shape ("+this.size+") should match the length of values ("+e.length+")"),this.shape=t,this.dtype=r||"float32";var o=this.shape.length;if(o<2)this.strides=[];else{this.strides=new Array(o-1),this.strides[o-2]=this.shape[o-1];for(var i=o-3;0<=i;--i)this.strides[i]=this.strides[i+1]*this.shape[i+1]}this.dataId=null!=n?n:s.nextDataId++,this.id=s.nextId++,this.rankType=this.rank<5?this.rank.toString():"higher",this.math.register(this),null!=e&&this.math.write(this.dataId,e)}return s.ones=function(t,r){var e=makeOnesTypedArray(util.sizeFromShape(t),r);return s.make(t,{values:e},r)},s.zeros=function(t,r){var e=makeZerosTypedArray(util.sizeFromShape(t),r);return s.make(t,{values:e},r)},s.onesLike=function(t){return s.ones(t.shape,t.dtype)},s.zerosLike=function(t){return s.zeros(t.shape,t.dtype)},s.like=function(t){var r=copyTypedArray(t.dataSync(),t.dtype);return s.make(t.shape,{values:r},t.dtype,t.math)},s.make=function(t,r,e,n){switch(t.length){case 0:return new Scalar(t,e,r.values,r.dataId,n);case 1:return new Array1D(t,e,r.values,r.dataId,n);case 2:return new Array2D(t,e,r.values,r.dataId,n);case 3:return new Array3D(t,e,r.values,r.dataId,n);case 4:return new Array4D(t,e,r.values,r.dataId,n);default:return new s(t,e,r.values,r.dataId,n)}},s.fromPixels=function(t,r,e){if(void 0===r&&(r=3),4<r)throw new Error("Cannot construct NDArray with more than 4 channels from pixels.");var n=[t.height,t.width,r];e=e||environment_1.ENV.math;var a=s.make(n,{},"int32",e);return e.writePixels(a.dataId,t,r),a},s.prototype.reshape=function(t){return this.throwIfDisposed(),this.math.reshape(this,t)},s.prototype.squeeze=function(t){return this.reshape(util.squeezeShape(this.shape,t).newShape)},s.prototype.flatten=function(){return this.throwIfDisposed(),this instanceof Array1D?this:this.as1D()},s.prototype.asScalar=function(){return this.throwIfDisposed(),util.assert(1===this.size,"The array must have only 1 element."),this.reshape([])},s.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},s.prototype.as2D=function(t,r){return this.throwIfDisposed(),this.reshape([t,r])},s.prototype.as3D=function(t,r,e){return this.throwIfDisposed(),this.reshape([t,r,e])},s.prototype.as4D=function(t,r,e,n){return this.throwIfDisposed(),this.reshape([t,r,e,n])},s.prototype.asType=function(t){return this.throwIfDisposed(),this.math.cast(this,t)},Object.defineProperty(s.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),s.prototype.get=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];for(var e=t[t.length-1],n=0;n<t.length-1;++n)e+=this.strides[n]*t[n];return this.dataSync()[e]},s.prototype.add=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];this.set.apply(this,[this.get.apply(this,r)+t].concat(r))},s.prototype.set=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];this.throwIfDisposed(),util.assert(r.length===this.rank,"The number of provided coordinates ("+r.length+") must match the rank ("+this.rank+")");for(var n=0<r.length?r[r.length-1]:0,a=0;a<r.length-1;++a)n+=this.strides[a]*r[a];var o=this.dataSync();o[n]=t,this.math.write(this.dataId,o)},s.prototype.val=function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.throwIfDisposed(),[4,this.data()];case 1:return t.sent(),[2,this.get.apply(this,r)]}})})},s.prototype.locToIndex=function(t){if(this.throwIfDisposed(),0===t.length)return 0;for(var r=t[t.length-1],e=0;e<t.length-1;++e)r+=this.strides[e]*t[e];return r},s.prototype.indexToLoc=function(t){this.throwIfDisposed();for(var r=new Array(this.shape.length),e=0;e<r.length-1;++e)r[e]=Math.floor(t/this.strides[e]),t-=r[e]*this.strides[e];return r[r.length-1]=t,r},s.prototype.fill=function(t){this.throwIfDisposed();var r=this.dataSync();r.fill(t),this.math.write(this.dataId,r)},s.prototype.getValues=function(){return this.dataSync()},s.prototype.getValuesAsync=function(){return this.data()},s.prototype.data=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.throwIfDisposed(),[2,this.math.read(this.dataId)]})})},s.prototype.dataSync=function(){return this.throwIfDisposed(),this.math.readSync(this.dataId)},s.prototype.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.math.disposeData(this.dataId))},s.prototype.equals=function(t){return this.throwIfDisposed(),this.dtype===t.dtype&&util.arraysEqual(this.shape,t.shape)&&util.arraysEqual(this.dataSync(),t.dataSync())},s.rand=function(t,r,e){var n=util.sizeFromShape(t),a=null;if(null==e||"float32"===e)a=new Float32Array(n);else if("int32"===e)a=new Int32Array(n);else{if("bool"!==e)throw new Error("Unknown data type "+e);a=new Uint8Array(n)}for(var o=0;o<n;o++)a[o]=r();return s.make(t,{values:a},e)},s.randNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!1,a);return s.rand(t,function(){return o.nextValue()},n)},s.randTruncatedNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!0,a);return s.rand(t,function(){return o.nextValue()},n)},s.randUniform=function(t,r,e,n){return s.rand(t,function(){return util.randUniform(r,e)},n)},s.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("NDArray is disposed.")},s.nextId=0,s.nextDataId=0,s}(),Scalar=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return __extends(e,r),e.new=function(t,r){return new e([],r,toTypedArray([t],r))},e.prototype.get=function(){return this.dataSync()[0]},e.prototype.val=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.data()];case 1:return t.sent(),[2,this.get()]}})})},e.prototype.add=function(t){this.dataSync()[0]+=t},e.prototype.asType=function(t){return r.prototype.asType.call(this,t)},e.prototype.locToIndex=function(t){return 0},e.prototype.indexToLoc=function(t){return[]},e}(exports.NDArray=NDArray);exports.Scalar=Scalar;var Array1D=function(r){function n(){return null!==r&&r.apply(this,arguments)||this}return __extends(n,r),n.new=function(t,r){var e;return instanceofTypedArray(t)||(e=util.inferShape(t),util.assert(1===e.length,"Error constructing Array1D. Shape of values "+e+" is not 1 dimensional.")),new n([t.length],r,toTypedArray(t,r))},n.prototype.get=function(t){return this.dataSync()[t]},n.prototype.val=function(r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.data()];case 1:return t.sent(),[2,this.get(r)]}})})},n.prototype.add=function(t,r){this.dataSync()[r]+=t},n.prototype.locToIndex=function(t){return t[0]},n.prototype.indexToLoc=function(t){return[t]},n.prototype.asType=function(t){return r.prototype.asType.call(this,t)},n.ones=function(t,r){return NDArray.ones(t,r)},n.zeros=function(t,r){return NDArray.zeros(t,r)},n.randNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!1,a);return NDArray.rand(t,function(){return o.nextValue()},n)},n.randTruncatedNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!0,a);return NDArray.rand(t,function(){return o.nextValue()},n)},n.randUniform=function(t,r,e,n){return NDArray.rand(t,function(){return util.randUniform(r,e)},n)},n}(NDArray);exports.Array1D=Array1D;var Array2D=function(o){function a(t,r,e,n,a){return util.assert(2===t.length,"Shape should be of length 2"),o.call(this,t,r,e,n,a)||this}return __extends(a,o),a.new=function(t,r,e){var n;return instanceofTypedArray(r)||1<(n=util.inferShape(r)).length&&util.assertShapesMatch(t,n,"Error when constructing Array2D. Shape of values "+n+" does not match the provided shape "+t+". "),new a(t,e,toTypedArray(r,e))},a.prototype.get=function(t,r){return this.dataSync()[this.strides[0]*t+r]},a.prototype.add=function(t,r,e){this.dataSync()[this.strides[0]*r+e]+=t},a.prototype.val=function(r,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.data()];case 1:return t.sent(),[2,this.get(r,e)]}})})},a.prototype.locToIndex=function(t){return this.strides[0]*t[0]+t[1]},a.prototype.indexToLoc=function(t){return[Math.floor(t/this.strides[0]),t%this.strides[0]]},a.prototype.asType=function(t){return o.prototype.asType.call(this,t)},a.ones=function(t,r){return NDArray.ones(t,r)},a.zeros=function(t,r){return NDArray.zeros(t,r)},a.randNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!1,a);return NDArray.rand(t,function(){return o.nextValue()},n)},a.randTruncatedNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!0,a);return NDArray.rand(t,function(){return o.nextValue()},n)},a.randUniform=function(t,r,e,n){return NDArray.rand(t,function(){return util.randUniform(r,e)},n)},a}(NDArray);exports.Array2D=Array2D;var Array3D=function(o){function a(t,r,e,n,a){return util.assert(3===t.length,"Shape should be of length 3"),o.call(this,t,r,e,n,a)||this}return __extends(a,o),a.new=function(t,r,e){var n;return instanceofTypedArray(r)||1<(n=util.inferShape(r)).length&&util.assertShapesMatch(t,n,"Error when constructing Array3D. Shape of values "+n+" does not match the provided shape "+t+". "),new a(t,e,toTypedArray(r,e))},a.prototype.get=function(t,r,e){return this.dataSync()[this.strides[0]*t+this.strides[1]*r+e]},a.prototype.val=function(r,e,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.data()];case 1:return t.sent(),[2,this.get(r,e,n)]}})})},a.prototype.add=function(t,r,e,n){this.dataSync()[this.strides[0]*r+this.strides[1]*e+n]+=t},a.prototype.locToIndex=function(t){return this.strides[0]*t[0]+this.strides[1]*t[1]+t[2]},a.prototype.indexToLoc=function(t){var r=Math.floor(t/this.strides[0]);return t-=r*this.strides[0],[r,Math.floor(t/this.strides[1]),t%this.strides[1]]},a.ones=function(t,r){return NDArray.ones(t,r)},a.prototype.asType=function(t){return o.prototype.asType.call(this,t)},a.zeros=function(t,r){return NDArray.zeros(t,r)},a.randNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!1,a);return NDArray.rand(t,function(){return o.nextValue()},n)},a.randTruncatedNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!0,a);return NDArray.rand(t,function(){return o.nextValue()},n)},a.randUniform=function(t,r,e,n){return NDArray.rand(t,function(){return util.randUniform(r,e)},n)},a}(NDArray);exports.Array3D=Array3D;var Array4D=function(o){function a(t,r,e,n,a){return util.assert(4===t.length,"Shape should be of length 4"),o.call(this,t,r,e,n,a)||this}return __extends(a,o),a.new=function(t,r,e){var n;return instanceofTypedArray(r)||1<(n=util.inferShape(r)).length&&util.assertShapesMatch(t,n,"Error when constructing Array4D. Shape of values "+n+" does not match the provided shape "+t+". "),new a(t,e,toTypedArray(r,e))},a.prototype.get=function(t,r,e,n){return this.dataSync()[this.strides[0]*t+this.strides[1]*r+this.strides[2]*e+n]},a.prototype.val=function(r,e,n,a){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.data()];case 1:return t.sent(),[2,this.get(r,e,n,a)]}})})},a.prototype.add=function(t,r,e,n,a){this.dataSync()[this.strides[0]*r+this.strides[1]*e+this.strides[2]*n+a]+=t},a.prototype.locToIndex=function(t){return this.strides[0]*t[0]+this.strides[1]*t[1]+this.strides[2]*t[2]+t[3]},a.prototype.indexToLoc=function(t){var r=Math.floor(t/this.strides[0]);t-=r*this.strides[0];var e=Math.floor(t/this.strides[1]);return t-=e*this.strides[1],[r,e,Math.floor(t/this.strides[2]),t%this.strides[2]]},a.prototype.asType=function(t){return o.prototype.asType.call(this,t)},a.ones=function(t,r){return NDArray.ones(t,r)},a.zeros=function(t,r){return NDArray.zeros(t,r)},a.randNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!1,a);return NDArray.rand(t,function(){return o.nextValue()},n)},a.randTruncatedNormal=function(t,r,e,n,a){if(void 0===r&&(r=0),void 0===e&&(e=1),null!=n&&"bool"===n)throw new Error("Unsupported data type "+n);var o=new rand_1.MPRandGauss(r,e,n,!0,a);return NDArray.rand(t,function(){return o.nextValue()},n)},a.randUniform=function(t,r,e,n){return NDArray.rand(t,function(){return util.randUniform(r,e)},n)},a}(NDArray);exports.Array4D=Array4D;var Variable=function(a){function o(t,r,e){void 0===r&&(r=!0);var n=a.call(this,t.shape,t.dtype,null,t.dataId)||this;return n.trainable=r,t.dispose(),n.name=e,null==n.name&&(n.name=o.nextVarId.toString(),o.nextVarId++),n.math.registerVariable(n),n}return __extends(o,a),o.variable=function(t,r,e,n){return void 0===r&&(r=!0),null!=n&&n!==t.dtype&&(t=t.asType(n)),new o(t,r,e)},o.prototype.assign=function(t){if(t.dtype!==this.dtype)throw new Error("dtype of the new value ("+t.dtype+") and previous value ("+this.dtype+") must match");if(!util.arraysEqual(t.shape,this.shape))throw new Error("shape of the new value ("+t.shape+") and previous value ("+this.shape+") must match");this.math.disposeData(this.dataId),this.dataId=t.dataId,this.math.register(this),t.dispose()},o.nextVarId=0,o}(NDArray),variable=(exports.Variable=Variable).variable;function copyTypedArray(t,r){if(null==r||"float32"===r)return new Float32Array(t);if("int32"===r){for(var e=new Int32Array(t.length),n=0;n<e.length;++n){var a=t[n];util.isValNaN(a,"int32")?e[n]=util.getNaN("int32"):e[n]=a}return e}if("bool"!==r)throw new Error("Unknown data type "+r);for(var o=new Uint8Array(t.length),n=0;n<o.length;++n){a=t[n];util.isValNaN(a,"bool")?o[n]=util.getNaN("bool"):0!==Math.round(a)&&(o[n]=1)}return o}function instanceofTypedArray(t){return t instanceof Float32Array||t instanceof Int32Array||t instanceof Uint8Array}function noConversionNeeded(t,r){return t instanceof Float32Array&&"float32"===r||t instanceof Int32Array&&"int32"===r||t instanceof Uint8Array&&"bool"===r}function toTypedArray(t,r){return noConversionNeeded(t,r)?t:(Array.isArray(t)&&(t=util.flatten(t)),copyTypedArray(t,r))}function makeZerosTypedArray(t,r){if(null==r||"float32"===r)return new Float32Array(t);if("int32"===r)return new Int32Array(t);if("bool"===r)return new Uint8Array(t);throw new Error("Unknown data type "+r)}function makeOnesTypedArray(t,r){for(var e=makeZerosTypedArray(t,r),n=0;n<e.length;n++)e[n]=1;return e}exports.variable=variable;