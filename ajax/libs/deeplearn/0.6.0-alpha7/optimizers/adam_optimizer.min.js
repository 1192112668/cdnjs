"use strict";var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(e,t){function a(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var environment_1=require("../environment"),globals_1=require("../globals"),ops_1=require("../ops/ops"),optimizer_1=require("./optimizer"),AdamOptimizer=function(i){function e(e,t,a,s){void 0===s&&(s=1e-8);var o=i.call(this)||this;return o.learningRate=e,o.accumulatedFirstMoment={},o.accumulatedSecondMoment={},o.c=globals_1.keep(ops_1.scalar(-e)),o.eps=globals_1.keep(ops_1.scalar(s)),o.beta1=globals_1.keep(ops_1.scalar(t)),o.beta2=globals_1.keep(ops_1.scalar(a)),globals_1.tidy(function(){o.accBeta1=ops_1.scalar(t).variable(),o.accBeta2=ops_1.scalar(a).variable()}),o.oneMinusBeta1=globals_1.keep(ops_1.scalar(1-t)),o.oneMinusBeta2=globals_1.keep(ops_1.scalar(1-a)),o.one=globals_1.keep(ops_1.scalar(1)),o}return __extends(e,i),e.prototype.applyGradients=function(m){var _=this;globals_1.tidy(function(){var e=_.one.sub(_.accBeta1),t=_.one.sub(_.accBeta2);for(var a in m){var s,o=environment_1.ENV.engine.registeredVariables[a];null==_.accumulatedFirstMoment[a]&&(s=!1,_.accumulatedFirstMoment[a]=ops_1.zerosLike(o).variable(s)),null==_.accumulatedSecondMoment[a]&&(s=!1,_.accumulatedSecondMoment[a]=ops_1.zerosLike(o).variable(s));var i=m[a],n=_.accumulatedFirstMoment[a],c=_.accumulatedSecondMoment[a],r=_.beta1.mul(n).add(_.oneMinusBeta1.mul(i)),u=_.beta2.mul(c).add(_.oneMinusBeta2.mul(i.square())),l=r.div(e),p=u.div(t);_.accumulatedFirstMoment[a].assign(r),_.accumulatedSecondMoment[a].assign(u);var d=_.c.mul(l.div(_.eps.add(p.sqrt()))).add(o);o.assign(d)}_.accBeta1.assign(_.accBeta1.mul(_.beta1)),_.accBeta2.assign(_.accBeta2.mul(_.beta2))})},e.prototype.dispose=function(){var t=this;this.c.dispose(),this.eps.dispose(),this.beta1.dispose(),this.beta2.dispose(),this.accBeta1.dispose(),this.accBeta2.dispose(),this.oneMinusBeta1.dispose(),this.oneMinusBeta2.dispose(),this.one.dispose(),null!=this.accumulatedFirstMoment&&Object.keys(this.accumulatedFirstMoment).forEach(function(e){return t.accumulatedFirstMoment[e].dispose()}),null!=this.accumulatedSecondMoment&&Object.keys(this.accumulatedSecondMoment).forEach(function(e){return t.accumulatedSecondMoment[e].dispose()})},e}(optimizer_1.Optimizer);exports.AdamOptimizer=AdamOptimizer;