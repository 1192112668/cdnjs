"use strict";var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])};return function(t,o){function e(){this.constructor=t}s(t,o),t.prototype=null===o?Object.create(o):(e.prototype=o.prototype,new e)}}(),__decorate=this&&this.__decorate||function(t,o,e,s){var r,i=arguments.length,n=i<3?o:null===s?s=Object.getOwnPropertyDescriptor(o,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,o,e,s);else for(var p=t.length-1;0<=p;p--)(r=t[p])&&(n=(i<3?r(n):3<i?r(o,e,n):r(o,e))||n);return 3<i&&n&&Object.defineProperty(o,e,n),n},__awaiter=this&&this.__awaiter||function(i,n,p,h){return new(p=p||Promise)(function(t,o){function e(t){try{r(h.next(t))}catch(t){o(t)}}function s(t){try{r(h.throw(t))}catch(t){o(t)}}function r(o){o.done?t(o.value):new p(function(t){t(o.value)}).then(e,s)}r((h=h.apply(i,n||[])).next())})},__generator=this&&this.__generator||function(e,s){var r,i,n,p={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},t={next:o(0),throw:o(1),return:o(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function o(o){return function(t){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;p;)try{if(r=1,i&&(n=i[2&o[0]?"return":o[0]?"throw":"next"])&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[0,n.value]),o[0]){case 0:case 1:n=o;break;case 4:return p.label++,{value:o[1],done:!1};case 5:p.label++,i=o[1],o=[0];continue;case 7:o=p.ops.pop(),p.trys.pop();continue;default:if(!(n=0<(n=p.trys).length&&n[n.length-1])&&(6===o[0]||2===o[0])){p=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){p.label=o[1];break}if(6===o[0]&&p.label<n[1]){p.label=n[1],n=o;break}if(n&&p.label<n[2]){p.label=n[2],p.ops.push(o);break}n[2]&&p.ops.pop(),p.trys.pop();continue}o=s.call(e,p)}catch(t){o=[6,t],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var doc_1=require("./doc"),environment_1=require("./environment"),ops=require("./ops/ops"),tensor_util=require("./tensor_util"),util=require("./util"),TensorBuffer=function(){function t(t,o,e){var s,r;this.shape=t,this.dtype=o,null!=(this.values=e)&&(s=e.length,r=util.sizeFromShape(t),util.assert(s===r,"Length of values '"+s+"' does not match the size inferred by the shape '"+r+"'")),this.values=e||util.getTypedArrayFromDType(o,util.sizeFromShape(t)),this.strides=computeStrides(t),this.size=util.sizeFromShape(t)}return t.prototype.set=function(t){for(var o=[],e=1;e<arguments.length;e++)o[e-1]=arguments[e];0===o.length&&(o=[0]),util.assert(o.length===this.rank,"The number of provided coordinates ("+o.length+") must match the rank ("+this.rank+")");var s=this.locToIndex(o);this.values[s]=t},t.prototype.get=function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];0===t.length&&(t=[0]);for(var e=t[t.length-1],s=0;s<t.length-1;++s)e+=this.strides[s]*t[s];return this.values[e]},t.prototype.locToIndex=function(t){if(0===this.rank)return 0;if(1===this.rank)return t[0];for(var o=t[t.length-1],e=0;e<t.length-1;++e)o+=this.strides[e]*t[e];return o},t.prototype.indexToLoc=function(t){if(0===this.rank)return[];if(1===this.rank)return[t];for(var o=new Array(this.shape.length),e=0;e<o.length-1;++e)o[e]=Math.floor(t/this.strides[e]),t-=o[e]*this.strides[e];return o[o.length-1]=t,o},Object.defineProperty(t.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),t.prototype.toTensor=function(){return Tensor.make(this.shape,{values:this.values},this.dtype)},__decorate([doc_1.doc({heading:"Tensors",subheading:"Creation"})],t.prototype,"set",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Creation"})],t.prototype,"get",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Creation"})],t.prototype,"toTensor",null),t=__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t)}();exports.TensorBuffer=TensorBuffer;var Tensor=function(){function t(t,o,e,s){this.isDisposed=!1,this.size=util.sizeFromShape(t),null!=e&&util.assert(this.size===e.length,"Constructing tensor of shape ("+this.size+") should match the length of values ("+e.length+")"),this.shape=t,this.dtype=o||"float32",this.strides=computeStrides(t),this.dataId=null!=s?s:{},this.id=r.nextId++,this.rankType=this.rank<5?this.rank.toString():"higher",environment_1.ENV.engine.registerTensor(this),null!=e&&environment_1.ENV.engine.write(this.dataId,e)}return(r=t).make=function(t,o,e){return new r(t,e,o.values,o.dataId)},t.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},t.prototype.asScalar=function(){return this.throwIfDisposed(),util.assert(1===this.size,"The array must have only 1 element."),this.reshape([])},t.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},t.prototype.as2D=function(t,o){return this.throwIfDisposed(),this.reshape([t,o])},t.prototype.as3D=function(t,o,e){return this.throwIfDisposed(),this.reshape([t,o,e])},t.prototype.as4D=function(t,o,e,s){return this.throwIfDisposed(),this.reshape([t,o,e,s])},t.prototype.asType=function(t){return this.throwIfDisposed(),ops.cast(this,t)},Object.defineProperty(t.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),t.prototype.get=function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];this.throwIfDisposed(),0===t.length&&(t=[0]);for(var e=t[t.length-1],s=0;s<t.length-1;++s)e+=this.strides[s]*t[s];return this.dataSync()[e]},t.prototype.buffer=function(){return ops.buffer(this.shape,this.dtype,this.dataSync())},t.prototype.data=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.throwIfDisposed(),[2,environment_1.ENV.engine.read(this.dataId)]})})},t.prototype.dataSync=function(){return this.throwIfDisposed(),environment_1.ENV.engine.readSync(this.dataId)},t.prototype.dispose=function(){this.isDisposed||(this.isDisposed=!0,environment_1.ENV.engine.disposeTensor(this))},t.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},t.prototype.toFloat=function(){return this.asType("float32")},t.prototype.toInt=function(){return this.asType("int32")},t.prototype.toBool=function(){return this.asType("bool")},t.prototype.print=function(t){return void 0===t&&(t=!1),ops.print(this,t)},t.prototype.reshape=function(t){return this.throwIfDisposed(),ops.reshape(this,t)},t.prototype.reshapeAs=function(t){return this.throwIfDisposed(),this.reshape(t.shape)},t.prototype.expandDims=function(t){return void 0===t&&(t=0),ops.expandDims(this,t)},t.prototype.squeeze=function(t){return this.throwIfDisposed(),ops.squeeze(this,t)},t.prototype.clone=function(){return this.throwIfDisposed(),ops.clone(this)},t.prototype.toString=function(){return tensor_util.tensorToString(this,!0)},t.prototype.tile=function(t){return this.throwIfDisposed(),ops.tile(this,t)},t.prototype.gather=function(t,o){return void 0===o&&(o=0),this.throwIfDisposed(),ops.gather(this,t,o)},t.prototype.matMul=function(t,o,e){return void 0===o&&(o=!1),void 0===e&&(e=!1),this.throwIfDisposed(),ops.matMul(this,t,o,e)},t.prototype.norm=function(t,o,e){return void 0===t&&(t="euclidean"),void 0===o&&(o=null),void 0===e&&(e=!1),this.throwIfDisposed(),ops.norm(this,t,o,e)},t.prototype.slice=function(t,o){return this.throwIfDisposed(),ops.slice(this,t,o)},t.prototype.reverse=function(t){return this.throwIfDisposed(),ops.reverse(this,t)},t.prototype.concat=function(t,o){return void 0===o&&(o=0),this.throwIfDisposed(),ops.concat([this,t],o)},t.prototype.stack=function(t,o){return void 0===o&&(o=0),ops.stack([this,t],o)},t.prototype.pad=function(t,o){return void 0===o&&(o=0),ops.pad(this,t,o)},t.prototype.batchNormalization=function(t,o,e,s,r){return void 0===e&&(e=.001),this.throwIfDisposed(),ops.batchNormalization(this,t,o,e,s,r)},t.prototype.logSumExp=function(t,o){return void 0===t&&(t=null),void 0===o&&(o=!1),this.throwIfDisposed(),ops.logSumExp(this,t,o)},t.prototype.sum=function(t,o){return void 0===t&&(t=null),void 0===o&&(o=!1),this.throwIfDisposed(),ops.sum(this,t,o)},t.prototype.mean=function(t,o){return void 0===t&&(t=null),void 0===o&&(o=!1),this.throwIfDisposed(),ops.mean(this,t,o)},t.prototype.min=function(t,o){return void 0===t&&(t=null),void 0===o&&(o=!1),this.throwIfDisposed(),ops.min(this,t,o)},t.prototype.max=function(t,o){return void 0===t&&(t=null),void 0===o&&(o=!1),this.throwIfDisposed(),ops.max(this,t,o)},t.prototype.argMin=function(t){return void 0===t&&(t=null),this.throwIfDisposed(),ops.argMin(this,t)},t.prototype.argMax=function(t){return void 0===t&&(t=null),this.throwIfDisposed(),ops.argMax(this,t)},t.prototype.add=function(t){return this.throwIfDisposed(),ops.add(this,t)},t.prototype.addStrict=function(t){return this.throwIfDisposed(),ops.addStrict(this,t)},t.prototype.sub=function(t){return this.throwIfDisposed(),ops.sub(this,t)},t.prototype.subStrict=function(t){return this.throwIfDisposed(),ops.subStrict(this,t)},t.prototype.pow=function(t){return this.throwIfDisposed(),ops.pow(this,t)},t.prototype.powStrict=function(t){return this.throwIfDisposed(),ops.powStrict(this,t)},t.prototype.mul=function(t){return this.throwIfDisposed(),ops.mul(this,t)},t.prototype.mulStrict=function(t){return this.throwIfDisposed(),ops.mulStrict(this,t)},t.prototype.div=function(t){return this.throwIfDisposed(),ops.div(this,t)},t.prototype.divStrict=function(t){return this.throwIfDisposed(),ops.divStrict(this,t)},t.prototype.minimum=function(t){return this.throwIfDisposed(),ops.minimum(this,t)},t.prototype.minimumStrict=function(t){return this.throwIfDisposed(),ops.minimumStrict(this,t)},t.prototype.maximum=function(t){return this.throwIfDisposed(),ops.maximum(this,t)},t.prototype.maximumStrict=function(t){return this.throwIfDisposed(),ops.maximumStrict(this,t)},t.prototype.transpose=function(t){return this.throwIfDisposed(),ops.transpose(this,t)},t.prototype.notEqual=function(t){return this.throwIfDisposed(),ops.notEqual(this,t)},t.prototype.notEqualStrict=function(t){return this.throwIfDisposed(),ops.notEqualStrict(this,t)},t.prototype.less=function(t){return this.throwIfDisposed(),ops.less(this,t)},t.prototype.lessStrict=function(t){return this.throwIfDisposed(),ops.lessStrict(this,t)},t.prototype.equal=function(t){return this.throwIfDisposed(),ops.equal(this,t)},t.prototype.equalStrict=function(t){return this.throwIfDisposed(),ops.equalStrict(this,t)},t.prototype.lessEqual=function(t){return this.throwIfDisposed(),ops.lessEqual(this,t)},t.prototype.lessEqualStrict=function(t){return this.throwIfDisposed(),ops.lessEqualStrict(this,t)},t.prototype.greater=function(t){return this.throwIfDisposed(),ops.greater(this,t)},t.prototype.greaterStrict=function(t){return this.throwIfDisposed(),ops.greaterStrict(this,t)},t.prototype.greaterEqual=function(t){return this.throwIfDisposed(),ops.greaterEqual(this,t)},t.prototype.greaterEqualStrict=function(t){return this.throwIfDisposed(),ops.greaterEqualStrict(this,t)},t.prototype.logicalAnd=function(t){return this.throwIfDisposed(),ops.logicalAnd(this,t)},t.prototype.logicalOr=function(t){return this.throwIfDisposed(),ops.logicalOr(this,t)},t.prototype.logicalXor=function(t){return this.throwIfDisposed(),ops.logicalXor(this,t)},t.prototype.where=function(t,o){return this.throwIfDisposed(),ops.where(t,this,o)},t.prototype.neg=function(){return this.throwIfDisposed(),ops.neg(this)},t.prototype.ceil=function(){return this.throwIfDisposed(),ops.ceil(this)},t.prototype.floor=function(){return this.throwIfDisposed(),ops.floor(this)},t.prototype.exp=function(){return this.throwIfDisposed(),ops.exp(this)},t.prototype.log=function(){return this.throwIfDisposed(),ops.log(this)},t.prototype.log1p=function(){return this.throwIfDisposed(),ops.log1p(this)},t.prototype.sqrt=function(){return this.throwIfDisposed(),ops.sqrt(this)},t.prototype.square=function(){return this.throwIfDisposed(),ops.square(this)},t.prototype.abs=function(){return this.throwIfDisposed(),ops.abs(this)},t.prototype.clipByValue=function(t,o){return this.throwIfDisposed(),ops.clipByValue(this,t,o)},t.prototype.relu=function(){return this.throwIfDisposed(),ops.relu(this)},t.prototype.elu=function(){return this.throwIfDisposed(),ops.elu(this)},t.prototype.selu=function(){return this.throwIfDisposed(),ops.selu(this)},t.prototype.leakyRelu=function(t){return void 0===t&&(t=.2),this.throwIfDisposed(),ops.leakyRelu(this,t)},t.prototype.prelu=function(t){return this.throwIfDisposed(),ops.prelu(this,t)},t.prototype.sigmoid=function(){return this.throwIfDisposed(),ops.sigmoid(this)},t.prototype.sin=function(){return this.throwIfDisposed(),ops.sin(this)},t.prototype.cos=function(){return this.throwIfDisposed(),ops.cos(this)},t.prototype.tan=function(){return this.throwIfDisposed(),ops.tan(this)},t.prototype.asin=function(){return this.throwIfDisposed(),ops.asin(this)},t.prototype.acos=function(){return this.throwIfDisposed(),ops.acos(this)},t.prototype.atan=function(){return this.throwIfDisposed(),ops.atan(this)},t.prototype.sinh=function(){return this.throwIfDisposed(),ops.sinh(this)},t.prototype.cosh=function(){return this.throwIfDisposed(),ops.cosh(this)},t.prototype.tanh=function(){return this.throwIfDisposed(),ops.tanh(this)},t.prototype.step=function(t){return void 0===t&&(t=0),this.throwIfDisposed(),ops.step(this,t)},t.prototype.softmax=function(t){return void 0===t&&(t=-1),this.throwIfDisposed(),ops.softmax(this,t)},t.prototype.resizeBilinear=function(t,o){return void 0===o&&(o=!1),this.throwIfDisposed(),ops.image.resizeBilinear(this,t,o)},t.prototype.conv1d=function(t,o,e,s,r,i){return void 0===s&&(s="NWC"),void 0===r&&(r=1),this.throwIfDisposed(),ops.conv1d(this,t,o,e,s,r,i)},t.prototype.conv2d=function(t,o,e,s,r,i){return void 0===s&&(s="NHWC"),void 0===r&&(r=[1,1]),this.throwIfDisposed(),ops.conv2d(this,t,o,e,s,r,i)},t.prototype.conv2dTranspose=function(t,o,e,s,r){return this.throwIfDisposed(),ops.conv2dTranspose(this,t,o,e,s,r)},t.prototype.depthwiseConv2D=function(t,o,e,s,r,i){return void 0===s&&(s="NHWC"),void 0===r&&(r=[1,1]),this.throwIfDisposed(),ops.depthwiseConv2d(this,t,o,e,s,r,i)},t.prototype.avgPool=function(t,o,e,s){return this.throwIfDisposed(),ops.avgPool(this,t,o,e,s)},t.prototype.maxPool=function(t,o,e,s){return this.throwIfDisposed(),ops.maxPool(this,t,o,e,s)},t.prototype.minPool=function(t,o,e,s){return this.throwIfDisposed(),ops.minPool(this,t,o,e,s)},t.prototype.localResponseNormalization=function(t,o,e,s,r){return void 0===t&&(t=5),void 0===o&&(o=1),void 0===e&&(e=1),void 0===s&&(s=.5),void 0===r&&(r="acrossChannels"),ops.localResponseNormalization(this,t,o,e,s,r)},t.prototype.variable=function(t,o,e){return void 0===t&&(t=!0),this.throwIfDisposed(),Variable.variable(this,t,o,e)},t.nextId=0,__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"flatten",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"asScalar",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"as1D",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"as2D",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"as3D",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"as4D",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"asType",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"buffer",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"data",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"dataSync",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"dispose",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"toFloat",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"toInt",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"toBool",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"print",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"reshape",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"reshapeAs",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"expandDims",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"squeeze",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"clone",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"toString",null),t=r=__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t);var r}(),Variable=function(r){function t(t,o,e){void 0===o&&(o=!0);var s=r.call(this,t.shape,t.dtype,null,t.dataId)||this;return s.trainable=o,s.name=e,null==s.name&&(s.name=i.nextVarId.toString(),i.nextVarId++),environment_1.ENV.engine.registerVariable(s),s}return __extends(t,r),(i=t).variable=function(t,o,e,s){return void 0===o&&(o=!0),null!=s&&s!==t.dtype&&(t=t.asType(s)),new i(t,o,e)},t.prototype.assign=function(t){if(t.dtype!==this.dtype)throw new Error("dtype of the new value ("+t.dtype+") and previous value ("+this.dtype+") must match");if(!util.arraysEqual(t.shape,this.shape))throw new Error("shape of the new value ("+t.shape+") and previous value ("+this.shape+") must match");environment_1.ENV.engine.disposeTensor(this),this.dataId=t.dataId,environment_1.ENV.engine.registerTensor(this)},t.nextVarId=0,__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t.prototype,"assign",null),__decorate([doc_1.doc({heading:"Tensors",subheading:"Creation"})],t,"variable",null),t=i=__decorate([doc_1.doc({heading:"Tensors",subheading:"Classes"})],t);var i}(exports.Tensor=Tensor),variable=(exports.Variable=Variable).variable;function computeStrides(t){var o=t.length;if(o<2)return[];var e=new Array(o-1);e[o-2]=t[o-1];for(var s=o-3;0<=s;--s)e[s]=e[s+1]*t[s+1];return e}exports.variable=variable;