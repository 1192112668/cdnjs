"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util=require("../util");function computePool2DInfo(t,e,o,n,r,a){void 0===a&&(a="channelsLast");var i,u=parseTupleParam(e),l=u[0],f=u[1];if("channelsLast"===a)i=[l,f,t[3],t[3]];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);i=[l,f,t[1],t[1]]}return computeConv2DInfo(t,i,o,1,n,r,!1,a)}function computeConv2DInfo(t,e,o,n,r,a,i,u){void 0===i&&(i=!1),void 0===u&&(u="channelsLast");var l=[-1,-1,-1,-1],f=l[0],h=l[1],s=l[2],d=l[3];if("channelsLast"===u)f=t[0],h=t[1],s=t[2],d=t[3];else{if("channelsFirst"!==u)throw new Error("Unknown dataFormat "+u);f=t[0],d=t[1],h=t[2],s=t[3]}var c,p=e[0],m=e[1],v=e[3],g=parseTupleParam(o),I=g[0],P=g[1],w=parseTupleParam(n),D=w[0],M=w[1],F=getPadAndOutInfo(r,h,s,I,P,getEffectiveFilterSize(p,D),getEffectiveFilterSize(m,M),a),S=F.padInfo,b=F.outHeight,C=F.outWidth,E=i?v*d:v;return"channelsFirst"===u?c=[f,E,b,C]:"channelsLast"===u&&(c=[f,b,C,E]),{batchSize:f,dataFormat:u,inHeight:h,inWidth:s,inChannels:d,outHeight:b,outWidth:C,outChannels:E,padInfo:S,strideHeight:I,strideWidth:P,filterHeight:p,filterWidth:m,dilationHeight:D,dilationWidth:M,inShape:t,outShape:c,filterShape:e}}function computeOutputShape3D(t,e,o,n,r,a){null==r&&(r=computeDefaultPad(t,e,n));var i=t[0],u=t[1],l=conditionalRound((i-e+2*r)/n+1,a);util.assert(util.isInt(l),"The output # of rows ("+l+") must be an integer. Change the stride and/or zero pad parameters");var f=conditionalRound((u-e+2*r)/n+1,a);return util.assert(util.isInt(f),"The output # of columns ("+f+") must be an integer. Change the stride and/or zero pad parameters"),[l,f,o]}function computeDefaultPad(t,e,o,n){void 0===n&&(n=1);var r=getEffectiveFilterSize(e,n);return Math.floor((t[0]*(o-1)-o+r)/2)}function parseTupleParam(t){return"number"==typeof t?[t,t]:t}function getEffectiveFilterSize(t,e){return e<=1?t:t+(t-1)*(e-1)}function getPadAndOutInfo(t,e,o,n,r,a,i,u){if("number"==typeof t){v={top:t,bottom:t,left:t,right:t};var l=computeOutputShape3D([e,o,1],a,1,n,t,u),f=l[0],h=l[1]}else if("same"===t)var s=((f=Math.ceil(e/n))-1)*n+a-e,d=((h=Math.ceil(o/r))-1)*r+i-o,c=Math.floor(s/2),p=s-c,m=Math.floor(d/2),v={top:c,bottom:p,left:m,right:d-m};else{if("valid"!==t)throw Error("Unknown padding parameter: "+t);v={top:0,bottom:0,left:0,right:0},f=Math.ceil((e-a+1)/n),h=Math.ceil((o-i+1)/r)}return{padInfo:v,outHeight:f,outWidth:h}}function conditionalRound(t,e){if(!e)return t;switch(e){case"round":return Math.round(t);case"ceil":return Math.ceil(t);case"floor":return Math.floor(t);default:throw new Error("Unknown roundingMode "+e)}}exports.computePool2DInfo=computePool2DInfo,exports.computeConv2DInfo=computeConv2DInfo,exports.computeDefaultPad=computeDefaultPad;