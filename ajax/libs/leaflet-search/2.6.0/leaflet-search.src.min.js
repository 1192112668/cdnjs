!function(t){if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("undefined"!=typeof module)module.exports=t(require("leaflet"));else{if(void 0===window.L)throw"Leaflet must be loaded first";t(window.L)}}(function(n){function r(t,e){var i=e.split("."),o=i.pop(),s=i.length,n=i[0],r=1;if(0<s)for(;(t=t[n])&&r<s;)n=i[r++];if(t)return t[o]}function o(t){return"[object Object]"===Object.prototype.toString.call(t)}return n.Control.Search=n.Control.extend({includes:n.Mixin.Events,options:{url:"",layer:null,sourceData:null,jsonpParam:null,propertyLoc:"loc",propertyName:"title",formatData:null,filterData:null,moveToLocation:null,buildTip:null,container:"",zoom:null,minLength:1,initial:!0,casesensitive:!1,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,firstTipSubmit:!1,autoResize:!0,collapsed:!0,autoCollapse:!1,autoCollapseTime:1200,textErr:"Location not found",textCancel:"Cancel",textPlaceholder:"Search...",position:"topleft",hideMarkerOnCollapse:!1,marker:{icon:!1,animate:!0,circle:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1}}},initialize:function(t){n.Util.setOptions(this,t||{}),this._inputMinSize=this.options.textPlaceholder?this.options.textPlaceholder.length:10,this._layer=this.options.layer||new n.LayerGroup,this._filterData=this.options.filterData||this._defaultFilterData,this._formatData=this.options.formatData||this._defaultFormatData,this._moveToLocation=this.options.moveToLocation||this._defaultMoveToLocation,this._autoTypeTmp=this.options.autoType,this._countertips=0,this._recordsCache={},this._curReq=null},onAdd:function(t){return this._map=t,this._container=n.DomUtil.create("div","leaflet-control-search"),this._input=this._createInput(this.options.textPlaceholder,"search-input"),this._tooltip=this._createTooltip("search-tooltip"),this._cancel=this._createCancel(this.options.textCancel,"search-cancel"),this._button=this._createButton(this.options.textPlaceholder,"search-button"),this._alert=this._createAlert("search-alert"),!1===this.options.collapsed&&this.expand(this.options.collapsed),this.options.marker&&(this.options.marker instanceof n.Marker?this._markerSearch=this.options.marker:o(this.options.marker)&&(this._markerSearch=new n.Control.Search.Marker([0,0],this.options.marker)),this._markerSearch._isMarkerSearch=!0),this.setLayer(this._layer),t.on({resize:this._handleAutoresize},this),this._container},addTo:function(t){return this.options.container?(this._container=this.onAdd(t),this._wrapper=n.DomUtil.get(this.options.container),this._wrapper.style.position="relative",this._wrapper.appendChild(this._container)):n.Control.prototype.addTo.call(this,t),this},onRemove:function(t){this._recordsCache={}},setLayer:function(t){return this._layer=t,this._layer.addTo(this._map),this},showAlert:function(t){t=t||this.options.textErr,this._alert.style.display="block",this._alert.innerHTML=t,clearTimeout(this.timerAlert);var e=this;return this.timerAlert=setTimeout(function(){e.hideAlert()},this.options.autoCollapseTime),this},hideAlert:function(){return this._alert.style.display="none",this},cancel:function(){return this._input.value="",this._handleKeypress({keyCode:8}),this._input.size=this._inputMinSize,this._input.focus(),this._cancel.style.display="none",this._hideTooltip(),this},expand:function(t){return t="boolean"!=typeof t||t,this._input.style.display="block",n.DomUtil.addClass(this._container,"search-exp"),!1!==t&&(this._input.focus(),this._map.on("dragstart click",this.collapse,this)),this.fire("search_expanded"),this},collapse:function(){return this._hideTooltip(),this.cancel(),this._alert.style.display="none",this._input.blur(),this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",n.DomUtil.removeClass(this._container,"search-exp"),this.options.hideMarkerOnCollapse&&this._map.removeLayer(this._markerSearch),this._map.off("dragstart click",this.collapse,this)),this.fire("search_collapsed"),this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var t=this;return clearTimeout(this.timerCollapse),this.timerCollapse=setTimeout(function(){t.collapse()},this.options.autoCollapseTime),this},collapseDelayedStop:function(){return clearTimeout(this.timerCollapse),this},_createAlert:function(t){var e=n.DomUtil.create("div",t,this._container);return e.style.display="none",n.DomEvent.on(e,"click",n.DomEvent.stop,this).on(e,"click",this.hideAlert,this),e},_createInput:function(t,e){var i=n.DomUtil.create("label",e,this._container),o=n.DomUtil.create("input",e,this._container);return o.type="text",o.size=this._inputMinSize,o.value="",o.autocomplete="off",o.autocorrect="off",o.autocapitalize="off",o.placeholder=t,o.style.display="none",o.role="search",o.id=o.role+o.type+o.size,i.htmlFor=o.id,i.style.display="none",i.value=t,n.DomEvent.disableClickPropagation(o).on(o,"keydown",this._handleKeypress,this).on(o,"blur",this.collapseDelayed,this).on(o,"focus",this.collapseDelayedStop,this),o},_createCancel:function(t,e){var i=n.DomUtil.create("a",e,this._container);return i.href="#",i.title=t,i.style.display="none",i.innerHTML="<span>&otimes;</span>",n.DomEvent.on(i,"click",n.DomEvent.stop,this).on(i,"click",this.cancel,this),i},_createButton:function(t,e){var i=n.DomUtil.create("a",e,this._container);return i.href="#",i.title=t,n.DomEvent.on(i,"click",n.DomEvent.stop,this).on(i,"click",this._handleSubmit,this).on(i,"focus",this.collapseDelayedStop,this).on(i,"blur",this.collapseDelayed,this),i},_createTooltip:function(t){var e=n.DomUtil.create("ul",t,this._container);e.style.display="none";var i=this;return n.DomEvent.disableClickPropagation(e).on(e,"blur",this.collapseDelayed,this).on(e,"mousewheel",function(t){i.collapseDelayedStop(),n.DomEvent.stopPropagation(t)},this).on(e,"mouseover",function(t){i.collapseDelayedStop()},this),e},_createTip:function(e,t){var i,o;return this.options.buildTip?"string"==typeof(o=this.options.buildTip.call(this,e,t))&&((i=n.DomUtil.create("div")).innerHTML=o,o=i.firstChild):(o=n.DomUtil.create("li","")).innerHTML=e,n.DomUtil.addClass(o,"search-tip"),o._text=e,this.options.tipAutoSubmit&&n.DomEvent.disableClickPropagation(o).on(o,"click",n.DomEvent.stop,this).on(o,"click",function(t){this._input.value=e,this._handleAutoresize(),this._input.focus(),this._hideTooltip(),this._handleSubmit()},this),o},_getUrl:function(t){return"function"==typeof this.options.url?this.options.url(t):this.options.url},_defaultFilterData:function(t,e){var i,o,s,n={};if(""===(t=t.replace(/[.*+?^${}()|[\]\\]/g,"")))return[];for(var r in i=this.options.initial?"^":"",o=this.options.casesensitive?void 0:"i",s=new RegExp(i+t,o),e)s.test(r)&&(n[r]=e[r]);return n},showTooltip:function(t){var e;for(var i in this._countertips=0,this._tooltip.innerHTML="",this._tooltip.currentSelection=-1,t){if(++this._countertips==this.options.tooltipLimit)break;e=this._createTip(i,t[i]),this._tooltip.appendChild(e)}return 0<this._countertips?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip(),this._tooltip.scrollTop=0,this._countertips},_hideTooltip:function(){return this._tooltip.style.display="none",this._tooltip.innerHTML="",0},_defaultFormatData:function(t){var e,i=this.options.propertyName,o=this.options.propertyLoc,s={};if(n.Util.isArray(o))for(e in t)s[r(t[e],i)]=n.latLng(t[e][o[0]],t[e][o[1]]);else for(e in t)s[r(t[e],i)]=n.latLng(r(t[e],o));return s},_recordsFromJsonp:function(t,e){n.Control.Search.callJsonp=e;var i=n.DomUtil.create("script","leaflet-search-jsonp",document.getElementsByTagName("body")[0]),o=n.Util.template(this._getUrl(t)+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:t});return i.type="text/javascript",i.src=o,{abort:function(){i.parentNode.removeChild(i)}}},_recordsFromAjax:function(t,e){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(t){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(t){throw new Error("XMLHttpRequest is not supported")}}});var i=new(n.Browser.ie&&!window.atob&&document.querySelector?XDomainRequest:XMLHttpRequest),o=n.Util.template(this._getUrl(t),{s:t});i.open("GET",o);return i.onload=function(){e(JSON.parse(i.responseText))},i.onreadystatechange=function(){4===i.readyState&&200===i.status&&this.onload()},i.send(),i},_recordsFromLayer:function(){var e,i={},o=this.options.propertyName;return this._layer.eachLayer(function(t){if(!t.hasOwnProperty("_isMarkerSearch"))if(t instanceof n.Marker||t instanceof n.CircleMarker)try{if(r(t.options,o))(e=t.getLatLng()).layer=t,i[r(t.options,o)]=e;else{if(!r(t.feature.properties,o))throw new Error("propertyName '"+o+"' not found in marker");(e=t.getLatLng()).layer=t,i[r(t.feature.properties,o)]=e}}catch(t){console}else if(t.hasOwnProperty("feature"))try{if(!t.feature.properties.hasOwnProperty(o))throw new Error("propertyName '"+o+"' not found in feature");(e=t.getBounds().getCenter()).layer=t,i[t.feature.properties[o]]=e}catch(t){console}else t instanceof n.LayerGroup&&t.eachLayer(function(t){(e=t.getLatLng()).layer=t,i[t.feature.properties[o]]=e})},this),i},_autoType:function(){var t,e=this._input.value.length,i=this._tooltip.firstChild._text,o=i.length;0===i.indexOf(this._input.value)&&(this._input.value=i,this._handleAutoresize(),this._input.createTextRange?((t=this._input.createTextRange()).collapse(!0),t.moveStart("character",e),t.moveEnd("character",o),t.select()):this._input.setSelectionRange?this._input.setSelectionRange(e,o):this._input.selectionStart&&(this._input.selectionStart=e,this._input.selectionEnd=o))},_hideAutoType:function(){var t,e;(t=this._input.selection)&&t.empty?t.empty():this._input.createTextRange?((t=this._input.createTextRange()).collapse(!0),e=this._input.value.length,t.moveStart("character",e),t.moveEnd("character",e),t.select()):(this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd)},_handleKeypress:function(t){switch(t.keyCode){case 27:this.collapse();break;case 13:(1==this._countertips||this.options.firstTipSubmit&&0<this._countertips)&&this._handleArrowSelect(1),this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 8:case 45:case 46:this._autoTypeTmp=!1;break;case 37:case 39:case 16:case 17:case 35:case 36:break;default:var e;this._input.value.length?this._cancel.style.display="block":this._cancel.style.display="none",this._input.value.length>=this.options.minLength?(clearTimeout((e=this).timerKeypress),this.timerKeypress=setTimeout(function(){e._fillRecordsCache()},this.options.delayType)):this._hideTooltip()}this._handleAutoresize()},searchText:function(t){var e=t.charCodeAt(t.length);this._input.value=t,this._input.style.display="block",n.DomUtil.addClass(this._container,"search-exp"),this._autoTypeTmp=!1,this._handleKeypress({keyCode:e})},_fillRecordsCache:function(){var e,t=this._input.value,i=this;this._curReq&&this._curReq.abort&&this._curReq.abort(),n.DomUtil.addClass(this._container,"search-load"),this.options.layer?(this._recordsCache=this._recordsFromLayer(),e=this._filterData(this._input.value,this._recordsCache),this.showTooltip(e),n.DomUtil.removeClass(this._container,"search-load")):(this.options.sourceData?this._retrieveData=this.options.sourceData:this.options.url&&(this._retrieveData=this.options.jsonpParam?this._recordsFromJsonp:this._recordsFromAjax),this._curReq=this._retrieveData.call(this,t,function(t){i._recordsCache=i._formatData(t),e=i.options.sourceData?i._filterData(i._input.value,i._recordsCache):i._recordsCache,i.showTooltip(e),n.DomUtil.removeClass(i._container,"search-load")}))},_handleAutoresize:function(){this._input.style.maxWidth!=this._map._container.offsetWidth&&(this._input.style.maxWidth=n.DomUtil.getStyle(this._map._container,"width")),this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(t){var e,o=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<o.length;i++)n.DomUtil.removeClass(o[i],"search-tip-select");1==t&&this._tooltip.currentSelection>=o.length-1?n.DomUtil.addClass(o[this._tooltip.currentSelection],"search-tip-select"):-1==t&&this._tooltip.currentSelection<=0?this._tooltip.currentSelection=-1:"none"!=this._tooltip.style.display&&(this._tooltip.currentSelection+=t,n.DomUtil.addClass(o[this._tooltip.currentSelection],"search-tip-select"),this._input.value=o[this._tooltip.currentSelection]._text,(e=o[this._tooltip.currentSelection].offsetTop)+o[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=e-this._tooltip.clientHeight+o[this._tooltip.currentSelection].clientHeight:e<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=e))},_handleSubmit:function(){var t;this._hideAutoType(),this.hideAlert(),this._hideTooltip(),"none"==this._input.style.display?this.expand():""===this._input.value?this.collapse():!1===(t=this._getLocation(this._input.value))?this.showAlert():(this.showLocation(t,this._input.value),this.fire("search_locationfound",{latlng:t,text:this._input.value,layer:t.layer?t.layer:null}))},_getLocation:function(t){return!!this._recordsCache.hasOwnProperty(t)&&this._recordsCache[t]},_defaultMoveToLocation:function(t,e,i){this.options.zoom?this._map.setView(t,this.options.zoom):this._map.panTo(t)},showLocation:function(e,t){var i=this;return i._map.once("moveend zoomend",function(t){i._markerSearch&&i._markerSearch.addTo(i._map).setLatLng(e)}),i._moveToLocation(e,t,i._map),i.options.autoCollapse&&i.collapse(),i}}),n.Control.Search.Marker=n.Marker.extend({includes:n.Mixin.Events,options:{icon:new n.Icon.Default,animate:!0,circle:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1}},initialize:function(t,e){n.setOptions(this,e),!0===e.icon&&(e.icon=new n.Icon.Default),n.Marker.prototype.initialize.call(this,t,e),o(this.options.circle)&&(this._circleLoc=new n.CircleMarker(t,this.options.circle))},onAdd:function(t){n.Marker.prototype.onAdd.call(this,t),this._circleLoc&&(t.addLayer(this._circleLoc),this.options.animate&&this.animate())},onRemove:function(t){n.Marker.prototype.onRemove.call(this,t),this._circleLoc&&t.removeLayer(this._circleLoc)},setLatLng:function(t){return n.Marker.prototype.setLatLng.call(this,t),this._circleLoc&&this._circleLoc.setLatLng(t),this},_initIcon:function(){this.options.icon&&n.Marker.prototype._initIcon.call(this)},_removeIcon:function(){this.options.icon&&n.Marker.prototype._removeIcon.call(this)},animate:function(){var t,e,i,o,s;return this._circleLoc&&(t=this._circleLoc,e=parseInt(t._radius/5),i=this.options.circle.radius,o=2*t._radius,s=0,t._timerAnimLoc=setInterval(function(){o-=e+=s+=.5,t.setRadius(o),o<i&&(clearInterval(t._timerAnimLoc),t.setRadius(i))},200)),this}}),n.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=n.control.search(this.options.searchControl),this.addControl(this.searchControl))}),n.control.search=function(t){return new n.Control.Search(t)},n.Control.Search});