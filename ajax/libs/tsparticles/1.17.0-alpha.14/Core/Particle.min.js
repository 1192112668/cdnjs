"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Particle=void 0;const Updater_1=require("./Particle/Updater"),Particles_1=require("../Options/Classes/Particles/Particles"),Shape_1=require("../Options/Classes/Particles/Shape/Shape"),Enums_1=require("../Enums"),Utils_1=require("../Utils"),Infecter_1=require("./Particle/Infecter");class Particle{constructor(t,i,e){var s,o,a,l,r,n,h,c,p,d;this.container=t,this.fill=!0,this.close=!0,this.links=[],this.lastNoiseTime=0,this.destroyed=!1;const u=t.options,m=new Particles_1.Particles;if(m.load(u.particles),null===(s=null==e?void 0:e.shape)||void 0===s?void 0:s.type){const t=e.shape.type;this.shape=t instanceof Array?Utils_1.Utils.itemFromArray(t):t;const i=new Shape_1.Shape;if(i.load(e.shape),this.shape){const t=i.options[this.shape];t&&(this.shapeData=Utils_1.Utils.deepExtend({},t instanceof Array?Utils_1.Utils.itemFromArray(t):t))}}else{const t=m.shape.type;this.shape=t instanceof Array?Utils_1.Utils.itemFromArray(t):t;const i=m.shape.options[this.shape];i&&(this.shapeData=Utils_1.Utils.deepExtend({},i instanceof Array?Utils_1.Utils.itemFromArray(i):i))}void 0!==e&&m.load(e),void 0!==(null===(o=this.shapeData)||void 0===o?void 0:o.particles)&&m.load(null===(a=this.shapeData)||void 0===a?void 0:a.particles),this.fill=null!==(r=null===(l=this.shapeData)||void 0===l?void 0:l.fill)&&void 0!==r?r:this.fill,this.close=null!==(h=null===(n=this.shapeData)||void 0===n?void 0:n.close)&&void 0!==h?h:this.close,this.particlesOptions=m;const v=this.particlesOptions.move.noise.delay;this.noiseDelay=1e3*(v.random.enable?Utils_1.Utils.randomInRange(v.random.minimumValue,v.value):v.value),t.retina.initParticle(this);const y=this.particlesOptions.color,U=null!==(c=this.sizeValue)&&void 0!==c?c:t.retina.sizeValue,g="boolean"==typeof this.particlesOptions.size.random?this.particlesOptions.size.random:this.particlesOptions.size.random.enable;this.size={value:g&&void 0!==this.randomMinimumSize?Utils_1.Utils.randomInRange(this.randomMinimumSize,U):U},this.direction=this.particlesOptions.move.direction,this.bubble={inRange:!1},this.initialVelocity=this.calculateVelocity(),this.velocity={horizontal:this.initialVelocity.horizontal,vertical:this.initialVelocity.vertical};const _=this.particlesOptions.rotate,f=_.path?Math.atan2(this.initialVelocity.vertical,this.initialVelocity.horizontal):0,z=_.random?360*Math.random():_.value;if(this.angle=f+z*Math.PI/180,this.rotateDirection=_.direction,this.rotateDirection===Enums_1.RotateDirection.random){const t=Math.floor(2*Math.random());this.rotateDirection=t>0?Enums_1.RotateDirection.counterClockwise:Enums_1.RotateDirection.clockwise}const O=this.particlesOptions.size.animation;if(O.enable){switch(O.startValue){case Enums_1.StartValueType.min:if(!g){const i=t.retina.pixelRatio;this.size.value=O.minimumValue*i}}this.size.status=Enums_1.SizeAnimationStatus.increasing,this.size.velocity=(null!==(p=this.sizeAnimationSpeed)&&void 0!==p?p:t.retina.sizeAnimationSpeed)/100,O.sync||(this.size.velocity*=Math.random())}this.color=Utils_1.ColorUtils.colorToHsl(y);const b=this.particlesOptions.color.animation;if(b.enable?(this.colorVelocity=b.speed/100,b.sync||(this.colorVelocity=this.colorVelocity*Math.random())):this.colorVelocity=0,b.enable&&!b.sync&&this.color&&(this.color.h=360*Math.random()),this.position=this.calcPosition(this.container,i),this.offset={x:0,y:0},this.particlesOptions.collisions.enable&&!this.checkOverlap(i))throw new Error;const w=this.particlesOptions.opacity,M=w.random,P=w.value;this.opacity={value:M.enable?Utils_1.Utils.randomInRange(M.minimumValue,P):P};const k=w.animation;k.enable&&(this.opacity.status=Enums_1.OpacityAnimationStatus.increasing,this.opacity.velocity=k.speed/100,k.sync||(this.opacity.velocity*=Math.random()));let C=t.drawers.get(this.shape);if(C||(C=Utils_1.Plugins.getShapeDrawer(this.shape))&&t.drawers.set(this.shape,C),this.loadImageShape(t,C),this.stroke=this.particlesOptions.stroke instanceof Array?Utils_1.Utils.itemFromArray(this.particlesOptions.stroke):this.particlesOptions.stroke,this.strokeColor=Utils_1.ColorUtils.colorToHsl(this.stroke.color),"string"!=typeof this.stroke.color){const t=null===(d=this.stroke.color)||void 0===d?void 0:d.animation;t&&this.strokeColor&&(t.enable?(this.strokeColorVelocity=b.speed/100,t.sync||(this.strokeColorVelocity=this.strokeColorVelocity*Math.random())):this.strokeColorVelocity=0,t.enable&&!t.sync&&this.color&&(this.strokeColor.h=360*Math.random()))}this.shadowColor=Utils_1.ColorUtils.colorToRgb(this.particlesOptions.shadow.color),this.updater=new Updater_1.Updater(this.container,this),this.infecter=new Infecter_1.Infecter(this.container,this)}update(t){this.updater.update(t)}draw(t){this.container.canvas.drawParticle(this,t)}isOverlapping(){const t=this.container;let i=!1;const e=this.getPosition();for(const s of t.particles.array.filter(t=>t!=this)){const t=s.getPosition();if(Utils_1.Utils.getDistance(e,t)<=this.size.value+s.size.value){i=!0;break}}return i}getPosition(){return{x:this.position.x+this.offset.x,y:this.position.y+this.offset.y}}getFillColor(){var t;return null!==(t=this.bubble.color)&&void 0!==t?t:this.color}getStrokeColor(){var t,i;return null!==(i=null!==(t=this.bubble.color)&&void 0!==t?t:this.strokeColor)&&void 0!==i?i:this.color}destroy(){this.destroyed=!0}checkOverlap(t,i=0){const e=this.container;if(!e.particles.count)return!0;if(i>=e.particles.count)return!1;const s=this.isOverlapping();return console.log(s),!s||(this.position.x=t?t.x:Math.random()*e.canvas.size.width,this.position.y=t?t.y:Math.random()*e.canvas.size.height,this.checkOverlap(void 0,i+1))}calcPosition(t,i){var e,s;for(const[,e]of t.plugins){const t=void 0!==e.particlePosition?e.particlePosition(i,this):void 0;if(void 0!==t)return Utils_1.Utils.deepExtend({},t)}const o={x:null!==(e=null==i?void 0:i.x)&&void 0!==e?e:Math.random()*t.canvas.size.width,y:null!==(s=null==i?void 0:i.y)&&void 0!==s?s:Math.random()*t.canvas.size.height},a=this.particlesOptions.move.outMode;return(Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounce)||Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounceHorizontal))&&(o.x>t.canvas.size.width-2*this.size.value?o.x-=this.size.value:o.x<2*this.size.value&&(o.x+=this.size.value)),(Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounce)||Utils_1.Utils.isInArray(a,Enums_1.OutMode.bounceVertical))&&(o.y>t.canvas.size.height-2*this.size.value?o.y-=this.size.value:o.y<2*this.size.value&&(o.y+=this.size.value)),o}calculateVelocity(){const t=Utils_1.Utils.getParticleBaseVelocity(this),i={horizontal:0,vertical:0},e=this.particlesOptions.move,s=Math.PI/180*e.angle,o=Math.PI/4,a={left:Math.sin(o+s/2)-Math.sin(o-s/2),right:Math.cos(o+s/2)-Math.cos(o-s/2)};return e.straight?(i.horizontal=t.x,i.vertical=t.y,e.random&&(i.horizontal+=Utils_1.Utils.randomInRange(a.left,a.right)/2,i.vertical+=Utils_1.Utils.randomInRange(a.left,a.right)/2)):(i.horizontal=t.x+Utils_1.Utils.randomInRange(a.left,a.right)/2,i.vertical=t.y+Utils_1.Utils.randomInRange(a.left,a.right)/2),i}loadImageShape(t,i){var e,s,o,a;if(this.shape!==Enums_1.ShapeType.image&&this.shape!==Enums_1.ShapeType.images)return;const l=i,r=this.particlesOptions.shape.options[this.shape],n=l.getImages(t).images,h=Utils_1.Utils.itemFromArray(n),c=r instanceof Array?r.find(t=>t.src===h.source):r,p=this.getFillColor();let d;if(void 0!==(null==h?void 0:h.svgData)&&c.replaceColor&&p){const t=Utils_1.Utils.replaceColorSvg(h,p,this.opacity.value),i=new Blob([t],{type:"image/svg+xml"}),s=window.URL||window.webkitURL||window,o=s.createObjectURL(i),a=new Image;d={data:h,loaded:!1,ratio:c.width/c.height,replaceColor:null!==(e=c.replaceColor)&&void 0!==e?e:c.replace_color,source:c.src},a.addEventListener("load",()=>{this.image&&(this.image.loaded=!0,h.element=a),s.revokeObjectURL(o)}),a.addEventListener("error",()=>{s.revokeObjectURL(o),Utils_1.Utils.loadImage(c.src).then(t=>{this.image&&(h.element=t.element,this.image.loaded=!0)})}),a.src=o}else d={data:h,loaded:!0,ratio:c.width/c.height,replaceColor:null!==(s=c.replaceColor)&&void 0!==s?s:c.replace_color,source:c.src};return d.ratio||(d.ratio=1),{image:d,fill:null!==(o=c.fill)&&void 0!==o?o:this.fill,close:null!==(a=c.close)&&void 0!==a?a:this.close}}}exports.Particle=Particle;