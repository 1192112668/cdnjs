"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Collider=void 0;const Utils_1=require("../../../../Utils"),Enums_1=require("../../../../Enums");class Collider{static collide(i,e,t){const s=i.getPosition(),o=e.particles.quadTree.query(new Utils_1.Circle(s.x,s.y,2*i.size.value));for(const t of o){if(i===t||!t.particlesOptions.collisions.enable||i.particlesOptions.collisions.mode!==t.particlesOptions.collisions.mode)continue;const o=t.getPosition(),l=Utils_1.Utils.getDistance(s,o),a=e.retina.sizeValue;l<=this.getRadius(i,a)+this.getRadius(t,a)&&this.resolveCollision(i,t,e)}}static getRadius(i,e){return i.bubble.radius||i.size.value||e}static resolveCollision(i,e,t){switch(i.particlesOptions.collisions.mode){case Enums_1.CollisionMode.absorb:this.absorb(i,e,t);break;case Enums_1.CollisionMode.bounce:this.bounce(i,e);break;case Enums_1.CollisionMode.destroy:this.destroy(i,e)}}static rotate(i,e){return{horizontal:i.horizontal*Math.cos(e)-i.vertical*Math.sin(e),vertical:i.horizontal*Math.sin(e)+i.vertical*Math.cos(e)}}static collisionVelocity(i,e,t,s){return{horizontal:i.horizontal*(t-s)/(t+s)+2*e.horizontal*s/(t+s),vertical:i.vertical}}static absorb(i,e,t){const s=t.options.fpsLimit/1e3;if(void 0===i.size.value&&void 0!==e.size.value)i.destroy();else if(void 0!==i.size.value&&void 0===e.size.value)e.destroy();else if(void 0!==i.size.value&&void 0!==e.size.value)if(i.size.value>=e.size.value){const o=Utils_1.Utils.clamp(i.size.value/e.size.value,0,e.size.value)*s;i.size.value+=o,e.size.value-=o,e.size.value<=t.retina.pixelRatio&&(e.size.value=0,e.destroy())}else{const o=Utils_1.Utils.clamp(e.size.value/i.size.value,0,i.size.value)*s;i.size.value-=o,e.size.value+=o,i.size.value<=t.retina.pixelRatio&&(i.size.value=0,i.destroy())}}static bounce(i,e){const t=i.getPosition(),s=e.getPosition(),o=i.velocity.horizontal-e.velocity.horizontal,l=i.velocity.vertical-e.velocity.vertical;if(o*(s.x-t.x)+l*(s.y-t.y)>=0){const o=-Math.atan2(s.y-t.y,s.x-t.x),l=i.size.value,a=e.size.value,r=this.rotate(i.velocity,o),c=this.rotate(e.velocity,o),v=this.collisionVelocity(r,c,l,a),n=this.collisionVelocity(c,r,l,a),u=this.rotate(v,-o),z=this.rotate(n,-o);i.velocity.horizontal=u.horizontal,i.velocity.vertical=u.vertical,e.velocity.horizontal=z.horizontal,e.velocity.vertical=z.vertical}}static destroy(i,e){void 0===i.size.value&&void 0!==e.size.value?i.destroy():void 0!==i.size.value&&void 0===e.size.value?e.destroy():void 0!==i.size.value&&void 0!==e.size.value&&(i.size.value>=e.size.value?e.destroy():i.destroy())}}exports.Collider=Collider;