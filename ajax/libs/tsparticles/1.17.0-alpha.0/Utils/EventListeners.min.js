"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventListeners=void 0;const Enums_1=require("../Enums"),Constants_1=require("./Constants");class EventListeners{constructor(e){this.container=e,this.canPush=!0,this.mouseMoveHandler=(e=>this.mouseTouchMove(e)),this.touchStartHandler=(e=>this.mouseTouchMove(e)),this.touchMoveHandler=(e=>this.mouseTouchMove(e)),this.touchEndHandler=(()=>this.mouseTouchFinish()),this.mouseLeaveHandler=(()=>this.mouseTouchFinish()),this.touchCancelHandler=(()=>this.mouseTouchFinish()),this.touchEndClickHandler=(e=>this.mouseTouchClick(e)),this.mouseUpHandler=(e=>this.mouseTouchClick(e)),this.mouseDownHandler=(()=>this.mouseDown()),this.visibilityChangeHandler=(()=>this.handleVisibilityChange()),this.resizeHandler=(()=>this.handleWindowResize())}static manageListener(e,t,i,n,s){if(n){let n={passive:!0};"boolean"==typeof s?n.capture=s:void 0!==s&&(n=s),e.addEventListener(t,i,n)}else{const n=s;e.removeEventListener(t,i,n)}}addListeners(){this.manageListeners(!0)}removeListeners(){this.manageListeners(!1)}manageListeners(e){const t=this.container,i=t.options,n=i.interactivity.detectsOn;n===Enums_1.InteractivityDetect.window?t.interactivity.element=window:n===Enums_1.InteractivityDetect.parent&&t.canvas.element?t.interactivity.element=t.canvas.element.parentNode:t.interactivity.element=t.canvas.element;const s=t.interactivity.element;s&&(i.interactivity.events.onHover.enable||i.interactivity.events.onClick.enable)&&(EventListeners.manageListener(s,Constants_1.Constants.mouseMoveEvent,this.mouseMoveHandler,e),EventListeners.manageListener(s,Constants_1.Constants.touchStartEvent,this.touchStartHandler,e),EventListeners.manageListener(s,Constants_1.Constants.touchMoveEvent,this.touchMoveHandler,e),i.interactivity.events.onClick.enable||EventListeners.manageListener(s,Constants_1.Constants.touchEndEvent,this.touchEndHandler,e),EventListeners.manageListener(s,Constants_1.Constants.mouseLeaveEvent,this.mouseLeaveHandler,e),EventListeners.manageListener(s,Constants_1.Constants.touchCancelEvent,this.touchCancelHandler,e)),i.interactivity.events.onClick.enable&&s&&(EventListeners.manageListener(s,Constants_1.Constants.touchEndEvent,this.touchEndClickHandler,e),EventListeners.manageListener(s,Constants_1.Constants.mouseUpEvent,this.mouseUpHandler,e),EventListeners.manageListener(s,Constants_1.Constants.mouseDownEvent,this.mouseDownHandler,e)),i.interactivity.events.resize&&EventListeners.manageListener(window,Constants_1.Constants.resizeEvent,this.resizeHandler,e),document&&EventListeners.manageListener(document,Constants_1.Constants.visibilityChangeEvent,this.visibilityChangeHandler,e,!1)}handleWindowResize(){const e=this.container,t=e.options,i=e.canvas.element;if(!i)return;const n=e.retina.pixelRatio;e.canvas.size.width=i.offsetWidth*n,e.canvas.size.height=i.offsetHeight*n,i.width=e.canvas.size.width,i.height=e.canvas.size.height,t.particles.move.enable||e.particles.redraw(),e.densityAutoParticles();for(const[,t]of e.plugins)void 0!==t.resize&&t.resize()}handleVisibilityChange(){const e=this.container;e.options.pauseOnBlur&&((null===document||void 0===document?void 0:document.hidden)?(e.pageHidden=!0,e.pause()):(e.pageHidden=!1,e.getAnimationStatus()?e.play(!0):e.draw()))}mouseDown(){this.container.interactivity&&(this.container.interactivity.mouse.clicking=!0)}mouseTouchMove(e){var t,i,n;const s=this.container,o=s.options;if(void 0===(null===(t=s.interactivity)||void 0===t?void 0:t.element))return;let a;s.interactivity.mouse.inside=!0;const c=s.canvas.element;if(e.type.startsWith("mouse")){this.canPush=!0;const t=e;if(s.interactivity.element===window){if(c){const e=c.getBoundingClientRect();a={x:t.clientX-e.left,y:t.clientY-e.top}}}else if(o.interactivity.detectsOn===Enums_1.InteractivityDetect.parent){const e=t.target,i=t.currentTarget;if(e&&i){const n=e.getBoundingClientRect(),s=i.getBoundingClientRect();a={x:t.offsetX+n.left-s.left,y:t.offsetY+n.top-s.top}}else a={x:t.offsetX||t.clientX,y:t.offsetY||t.clientY}}else t.target===s.canvas.element&&(a={x:t.offsetX||t.clientX,y:t.offsetY||t.clientY})}else{this.canPush="touchmove"!==e.type;const t=e,s=t.touches[t.touches.length-1],o=null==c?void 0:c.getBoundingClientRect();a={x:s.clientX-(null!==(i=null==o?void 0:o.left)&&void 0!==i?i:0),y:s.clientY-(null!==(n=null==o?void 0:o.top)&&void 0!==n?n:0)}}const r=s.retina.pixelRatio;a&&(a.x*=r,a.y*=r),s.interactivity.mouse.position=a,s.interactivity.status=Constants_1.Constants.mouseMoveEvent}mouseTouchFinish(){const e=this.container;delete e.interactivity.mouse.position,e.interactivity.status=Constants_1.Constants.mouseLeaveEvent,e.interactivity.mouse.inside=!1,e.interactivity.mouse.clicking=!1}mouseTouchClick(e){const t=this.container,i=t.options;t.interactivity.mouse.inside=!0;let n=!1;const s=t.interactivity.mouse.position;if(void 0!==s&&i.interactivity.events.onClick.enable){for(const[,e]of t.plugins)if(void 0!==e.clickPositionValid&&(n=e.clickPositionValid(s)))break;n||this.doMouseTouchClick(e),t.interactivity.mouse.clicking=!1}}doMouseTouchClick(e){const t=this.container,i=t.options;if(this.canPush){const e=t.interactivity.mouse.position;if(!e)return;t.interactivity.mouse.clickPosition={x:e.x,y:e.y},t.interactivity.mouse.clickTime=(new Date).getTime();const n=i.interactivity.events.onClick;if(n.mode instanceof Array)for(const e of n.mode)this.handleClickMode(e);else this.handleClickMode(n.mode)}"touchend"===e.type&&setTimeout(()=>this.mouseTouchFinish(),500)}handleClickMode(e){const t=this.container,i=t.options,n=i.interactivity.modes.push.quantity,s=i.interactivity.modes.remove.quantity;switch(e){case Enums_1.ClickMode.push:n>0&&(i.particles.move.enable?t.particles.push(n,t.interactivity.mouse):1===n?t.particles.push(n,t.interactivity.mouse):n>1&&t.particles.push(n));break;case Enums_1.ClickMode.remove:t.particles.removeQuantity(s);break;case Enums_1.ClickMode.bubble:t.bubble.clicking=!0;break;case Enums_1.ClickMode.repulse:t.repulse.clicking=!0,t.repulse.count=0;for(const e of t.repulse.particles)e.velocity.horizontal=e.initialVelocity.horizontal,e.velocity.vertical=e.initialVelocity.vertical;t.repulse.particles=[],t.repulse.finish=!1,setTimeout(()=>{t.destroyed||(t.repulse.clicking=!1)},1e3*i.interactivity.modes.repulse.duration);break;case Enums_1.ClickMode.pause:t.getAnimationStatus()?t.pause():t.play()}for(const[,i]of t.plugins)i.handleClickMode&&i.handleClickMode(e)}}exports.EventListeners=EventListeners;