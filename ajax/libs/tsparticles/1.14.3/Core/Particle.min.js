"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ShapeType_1=require("../Enums/ShapeType"),Updater_1=require("./Particle/Updater"),Utils_1=require("../Utils/Utils"),PolygonMaskType_1=require("../Enums/PolygonMaskType"),RotateDirection_1=require("../Enums/RotateDirection"),ColorUtils_1=require("../Utils/ColorUtils"),Particles_1=require("../Options/Classes/Particles/Particles"),SizeAnimationStatus_1=require("../Enums/SizeAnimationStatus"),OpacityAnimationStatus_1=require("../Enums/OpacityAnimationStatus"),Shape_1=require("../Options/Classes/Particles/Shape/Shape"),StartValueType_1=require("../Enums/StartValueType"),Plugins_1=require("../Utils/Plugins"),Particle=function(){function i(i,t,e){var o,s,a,n,l,r,h,c,p,d,u,v,y,m,f,g,U,S=this;this.container=i,this.fill=!0,this.close=!0,this.links=[],this.lastNoiseTime=0,this.destroyed=!1;var _,O,z,D=i.options,T=new Particles_1.Particles;T.load(D.particles),void 0!==(null==e?void 0:e.shape)?(O=null!==(o=e.shape.type)&&void 0!==o?o:T.shape.type,this.shape=O instanceof Array?Utils_1.Utils.itemFromArray(O):O,(_=new Shape_1.Shape).load(e.shape),void 0!==this.shape&&void 0!==(z=_.options[this.shape])&&(this.shapeData=Utils_1.Utils.deepExtend({},z instanceof Array?Utils_1.Utils.itemFromArray(z):z),this.fill=null!==(a=null===(s=this.shapeData)||void 0===s?void 0:s.fill)&&void 0!==a?a:this.fill,this.close=null!==(l=null===(n=this.shapeData)||void 0===n?void 0:n.close)&&void 0!==l?l:this.close)):(O=T.shape.type,this.shape=O instanceof Array?Utils_1.Utils.itemFromArray(O):O,(z=T.shape.options[this.shape])&&(this.shapeData=Utils_1.Utils.deepExtend({},z instanceof Array?Utils_1.Utils.itemFromArray(z):z),this.fill=null!==(h=null===(r=this.shapeData)||void 0===r?void 0:r.fill)&&void 0!==h?h:this.fill,this.close=null!==(p=null===(c=this.shapeData)||void 0===c?void 0:c.close)&&void 0!==p?p:this.close)),void 0!==e&&T.load(e),void 0!==(null===(d=this.shapeData)||void 0===d?void 0:d.particles)&&T.load(null===(u=this.shapeData)||void 0===u?void 0:u.particles),this.particlesOptions=T;var w=this.particlesOptions.move.noise.delay;this.noiseDelay=1e3*(w.random.enable?Utils_1.Utils.randomInRange(w.random.minimumValue,w.value):w.value),i.retina.initParticle(this);var P,x=this.particlesOptions.color,b=null!==(v=this.sizeValue)&&void 0!==v?v:i.retina.sizeValue,C="boolean"==typeof this.particlesOptions.size.random?this.particlesOptions.size.random:this.particlesOptions.size.random.enable;if(this.size={value:C&&void 0!==this.randomMinimumSize?Utils_1.Utils.randomInRange(this.randomMinimumSize,b):b},this.direction=this.particlesOptions.move.direction,this.bubble={},this.angle=this.particlesOptions.rotate.random?360*Math.random():this.particlesOptions.rotate.value,this.particlesOptions.rotate.direction==RotateDirection_1.RotateDirection.random?(V=Math.floor(2*Math.random()),this.rotateDirection=0<V?RotateDirection_1.RotateDirection.counterClockwise:RotateDirection_1.RotateDirection.clockwise):this.rotateDirection=this.particlesOptions.rotate.direction,this.particlesOptions.size.animation.enable){switch(this.particlesOptions.size.animation.startValue){case StartValueType_1.StartValueType.min:C||(P=i.retina.pixelRatio,this.size.value=this.particlesOptions.size.animation.minimumValue*P)}this.size.status=SizeAnimationStatus_1.SizeAnimationStatus.increasing,this.size.velocity=(null!==(y=this.sizeAnimationSpeed)&&void 0!==y?y:i.retina.sizeAnimationSpeed)/100,this.particlesOptions.size.animation.sync||(this.size.velocity=this.size.velocity*Math.random())}this.particlesOptions.rotate.animation.enable&&(this.particlesOptions.rotate.animation.sync||(this.angle=360*Math.random())),this.position=this.calcPosition(this.container,t),D.polygon.enable&&D.polygon.type===PolygonMaskType_1.PolygonMaskType.inline&&(this.initialPosition={x:this.position.x,y:this.position.y}),this.offset={x:0,y:0},this.particlesOptions.collisions.enable&&this.checkOverlap(t),x instanceof Array?this.color=ColorUtils_1.ColorUtils.colorToRgb(Utils_1.Utils.itemFromArray(x)):this.color=ColorUtils_1.ColorUtils.colorToRgb(x);var R=this.particlesOptions.opacity.random,k=this.particlesOptions.opacity.value;this.opacity={value:R.enable?Utils_1.Utils.randomInRange(R.minimumValue,k):k},this.particlesOptions.opacity.animation.enable&&(this.opacity.status=OpacityAnimationStatus_1.OpacityAnimationStatus.increasing,this.opacity.velocity=this.particlesOptions.opacity.animation.speed/100,this.particlesOptions.opacity.animation.sync||(this.opacity.velocity*=Math.random())),this.initialVelocity=this.calculateVelocity(),this.velocity={horizontal:this.initialVelocity.horizontal,vertical:this.initialVelocity.vertical};var A,M,V,q,I,E,F,L,j,B,N=i.drawers[this.shape];N||(N=Plugins_1.Plugins.getShapeDrawer(this.shape),i.drawers[this.shape]=N),this.shape!==ShapeType_1.ShapeType.image&&this.shape!==ShapeType_1.ShapeType.images||(A=this.particlesOptions.shape.options[this.shape],M=N.getImages(i).images,q=M[V=Utils_1.Utils.arrayRandomIndex(M)],I=A instanceof Array?A.filter(function(i){return i.src===q.source})[0]:A,void 0!==(null==q?void 0:q.svgData)&&I.replaceColor&&this.color?(E=Utils_1.Utils.replaceColorSvg(q,this.color,this.opacity.value),F=new Blob([E],{type:"image/svg+xml"}),L=window.URL||window.webkitURL||window,j=L.createObjectURL(F),B=new Image,this.image={data:q,loaded:!1,ratio:I.width/I.height,replaceColor:null!==(m=I.replaceColor)&&void 0!==m?m:I.replace_color,source:I.src},B.addEventListener("load",function(i){S.image&&(S.image.loaded=!0,q.element=B),L.revokeObjectURL(j)}),B.addEventListener("error",function(i){L.revokeObjectURL(j),Utils_1.Utils.loadImage(I.src).then(function(i){S.image&&(q.element=i.element,S.image.loaded=!0)})}),B.src=j):this.image={data:q,loaded:!0,ratio:I.width/I.height,replaceColor:null!==(f=I.replaceColor)&&void 0!==f?f:I.replace_color,source:I.src},this.image.ratio||(this.image.ratio=1),this.fill=null!==(g=I.fill)&&void 0!==g?g:this.fill,this.close=null!==(U=I.close)&&void 0!==U?U:this.close),this.stroke=this.particlesOptions.stroke instanceof Array?Utils_1.Utils.itemFromArray(this.particlesOptions.stroke):this.particlesOptions.stroke,this.strokeColor="string"==typeof this.stroke.color?ColorUtils_1.ColorUtils.stringToRgb(this.stroke.color):ColorUtils_1.ColorUtils.colorToRgb(this.stroke.color),this.shadowColor="string"==typeof this.particlesOptions.shadow.color?ColorUtils_1.ColorUtils.stringToRgb(this.particlesOptions.shadow.color):ColorUtils_1.ColorUtils.colorToRgb(this.particlesOptions.shadow.color),this.updater=new Updater_1.Updater(this.container,this)}return i.prototype.update=function(i,t){this.links=[],this.updater.update(t)},i.prototype.draw=function(i){var t;!1!==(null===(t=this.image)||void 0===t?void 0:t.loaded)&&this.container.canvas.drawParticle(this,i)},i.prototype.isOverlapping=function(){for(var i=this.container,t=this,e=!1,o=0,s=t.getPosition(),a=0,n=i.particles.array.filter(function(i){return i!=t});a<n.length;a++){var l=n[a];o++;var r=l.getPosition();if(Utils_1.Utils.getDistance(s,r)<=t.size.value+l.size.value){e=!0;break}}return{collisionFound:e,iterations:o}},i.prototype.checkOverlap=function(i){var t=this.container,e=this.isOverlapping();e.iterations>=t.particles.count?t.particles.remove(this):e.collisionFound&&(this.position.x=i?i.x:Math.random()*t.canvas.size.width,this.position.y=i?i.y:Math.random()*t.canvas.size.height,this.checkOverlap())},i.prototype.startInfection=function(i){this.container.options.infection.stages.length<i||i<0||(this.infectionDelay=0,this.infectionDelayStage=i)},i.prototype.updateInfectionStage=function(i){this.container.options.infection.stages.length<i||i<0||void 0!==this.infectionStage&&this.infectionStage>i||(void 0!==this.infectionTimeout&&window.clearTimeout(this.infectionTimeout),this.infectionStage=i,this.infectionTime=0)},i.prototype.updateInfection=function(i){var t,e=this.container.options,o=e.infection,s=e.infection.stages,a=s.length;if(void 0!==this.infectionDelay&&void 0!==this.infectionDelayStage){var n=this.infectionDelayStage;if(a<n||n<0)return;this.infectionDelay>1e3*o.delay?(this.infectionStage=n,this.infectionTime=0,delete this.infectionDelay,delete this.infectionDelayStage):this.infectionDelay+=i}else delete this.infectionDelay,delete this.infectionDelayStage;void 0!==this.infectionStage&&void 0!==this.infectionTime?void 0!==(t=s[this.infectionStage]).duration&&0<=t.duration&&this.infectionTime>1e3*t.duration?this.nextInfectionStage():this.infectionTime+=i:(delete this.infectionStage,delete this.infectionTime)},i.prototype.getPosition=function(){return{x:this.position.x+this.offset.x,y:this.position.y+this.offset.y}},i.prototype.destroy=function(){this.destroyed=!0},i.prototype.nextInfectionStage=function(){var i=this.container.options,t=i.infection.stages.length;if(!(t<=0||void 0===this.infectionStage)&&(this.infectionTime=0,t<=++this.infectionStage)){if(i.infection.cure)return delete this.infectionStage,void delete this.infectionTime;this.infectionStage=0,this.infectionTime=0}},i.prototype.calcPosition=function(i,t){for(var e in i.plugins){var o=i.plugins[e],s=void 0!==o.particlePosition?o.particlePosition(t):void 0;if(void 0!==s)return s}var a={x:0,y:0};return a.x=t?t.x:Math.random()*i.canvas.size.width,a.y=t?t.y:Math.random()*i.canvas.size.height,a.x>i.canvas.size.width-2*this.size.value?a.x-=this.size.value:a.x<2*this.size.value&&(a.x+=this.size.value),a.y>i.canvas.size.height-2*this.size.value?a.y-=this.size.value:a.y<2*this.size.value&&(a.y+=this.size.value),a},i.prototype.calculateVelocity=function(){var i=Utils_1.Utils.getParticleBaseVelocity(this),t={horizontal:0,vertical:0};return this.particlesOptions.move.straight?(t.horizontal=i.x,t.vertical=i.y,this.particlesOptions.move.random&&(t.horizontal*=Math.random(),t.vertical*=Math.random())):(t.horizontal=i.x+Math.random()-.5,t.vertical=i.y+Math.random()-.5),t},i}();exports.Particle=Particle;