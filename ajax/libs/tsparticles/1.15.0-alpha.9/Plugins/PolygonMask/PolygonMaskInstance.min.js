"use strict";var __awaiter=this&&this.__awaiter||function(t,r,s,l){return new(s=s||Promise)(function(e,n){function o(t){try{i(l.next(t))}catch(t){n(t)}}function a(t){try{i(l.throw(t))}catch(t){n(t)}}function i(t){var n;t.done?e(t.value):((n=t.value)instanceof s?n:new s(function(t){t(n)})).then(o,a)}i((l=l.apply(t,r||[])).next())})},__generator=this&&this.__generator||function(e,o){var a,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},t={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function n(n){return function(t){return function(n){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(r=2&n[0]?i.return:n[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,n[1])).done)return r;switch(i=0,r&&(n=[2&n[0],r.value]),n[0]){case 0:case 1:r=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!r||n[1]>r[0]&&n[1]<r[3])){s.label=n[1];break}if(6===n[0]&&s.label<r[1]){s.label=r[1],r=n;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(n);break}r[2]&&s.ops.pop(),s.trys.pop();continue}n=o.call(e,s)}catch(t){n=[6,t],i=0}finally{a=r=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,t])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PolygonMaskInstance=void 0;var PolygonMaskType_1=require("./Enums/PolygonMaskType"),PolygonMaskInlineArrangement_1=require("./Enums/PolygonMaskInlineArrangement"),Utils_1=require("../../Utils"),PolygonMask_1=require("./Options/Classes/PolygonMask"),PolygonMaskInstance=function(){function h(t){this.container=t,this.dimension={height:0,width:0},this.path2DSupported=Object.prototype.hasOwnProperty.call(window,"Path2D"),this.options=new PolygonMask_1.PolygonMask,this.polygonMaskMoveRadius=this.options.move.radius*t.retina.pixelRatio}return h.polygonBounce=function(t){t.velocity.horizontal=-t.velocity.horizontal+t.velocity.vertical/2,t.velocity.vertical=-t.velocity.vertical+t.velocity.horizontal/2},h.drawPolygonMask=function(t,n,e){var o=Utils_1.ColorUtils.colorToRgb(e.color);if(o){t.beginPath(),t.moveTo(n[0].x,n[0].y);for(var a=1;a<n.length;a++)t.lineTo(n[a].x,n[a].y);t.closePath(),t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(o),t.lineWidth=e.width,t.stroke()}},h.drawPolygonMaskPath=function(t,n,e,o){t.translate(o.x,o.y);var a=Utils_1.ColorUtils.colorToRgb(e.color);a&&(t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(a,e.opacity),t.lineWidth=e.width,t.stroke(n))},h.prototype.initAsync=function(o){return __awaiter(this,void 0,void 0,function(){var n,e;return __generator(this,function(t){switch(t.label){case 0:return(this.options.load(null==o?void 0:o.polygon),n=this.options,this.polygonMaskMoveRadius=n.move.radius*this.container.retina.pixelRatio,n.enable)?n.url?[4,(e=this).downloadSvgPathToPolygon(n.url)]:[3,2]:[3,4];case 1:return e.raw=t.sent(),[3,3];case 2:n.data&&(this.raw=this.parseSvgPathToPolygon(n.data)),t.label=3;case 3:this.createPath2D(),t.label=4;case 4:return[2]}})})},h.prototype.checkInsidePolygon=function(t){var n=this.container,e=this.options;if(!e.enable||e.type===PolygonMaskType_1.PolygonMaskType.none||e.type===PolygonMaskType_1.PolygonMaskType.inline)return!0;if(!this.raw)throw new Error(Utils_1.Constants.noPolygonFound);for(var o=t?t.x:Math.random()*n.canvas.size.width,a=t?t.y:Math.random()*n.canvas.size.height,i=!1,r=0,s=this.raw.length-1;r<this.raw.length;s=r++){var l=this.raw[r].x,h=this.raw[r].y,y=this.raw[s].x,g=this.raw[s].y;a<h!=a<g&&o<(y-l)*(a-h)/(g-h)+l&&(i=!i)}return e.type===PolygonMaskType_1.PolygonMaskType.inside?i:e.type===PolygonMaskType_1.PolygonMaskType.outside&&!i},h.prototype.resize=function(){var t=this,e=this.container,o=this.options;o.enable&&o.type!==PolygonMaskType_1.PolygonMaskType.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){return __awaiter(t,void 0,void 0,function(){var n;return __generator(this,function(t){switch(t.label){case 0:return o.url?[4,(n=this).downloadSvgPathToPolygon(o.url)]:[3,2];case 1:return n.raw=t.sent(),[3,3];case 2:o.data&&(this.raw=this.parseSvgPathToPolygon(o.data)),t.label=3;case 3:return this.createPath2D(),e.particles.redraw(),[2]}})})},250))},h.prototype.stop=function(){delete this.raw,delete this.paths},h.prototype.randomPointInPolygon=function(){var t,n=this.container,e=this.options;if(e.type===PolygonMaskType_1.PolygonMaskType.inline)switch(e.inline.arrangement){case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(n.particles.count);break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint:case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(n.particles.count)}else t={x:Math.random()*n.canvas.size.width,y:Math.random()*n.canvas.size.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},h.prototype.particlesInitialization=function(){var t=this.options;return!(!t.enable||t.type!==PolygonMaskType_1.PolygonMaskType.inline||t.inline.arrangement!==PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint&&t.inline.arrangement!==PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint)&&(this.drawPointsOnPolygonPath(),!0)},h.prototype.particlePosition=function(t,n){var e,o,a=this.options;if(a.enable&&0<(null!==(o=null===(e=this.raw)||void 0===e?void 0:e.length)&&void 0!==o?o:0)){var i,r={x:0,y:0};return t?(r.x=t.x,r.y=t.y):(i=this.randomPointInPolygon(),r.x=i.x,r.y=i.y),a.type===PolygonMaskType_1.PolygonMaskType.inline&&n&&(n.initialPosition={x:r.x,y:r.y}),r}},h.prototype.particleBounce=function(t,n){var e=this.options;if(e.enable&&e.type!==PolygonMaskType_1.PolygonMaskType.none&&e.type!==PolygonMaskType_1.PolygonMaskType.inline){if(!this.checkInsidePolygon(t.getPosition()))return h.polygonBounce(t),!0}else if(e.enable&&e.type===PolygonMaskType_1.PolygonMaskType.inline){if(t.initialPosition)if(Utils_1.Utils.getDistance(t.initialPosition,t.getPosition())>this.polygonMaskMoveRadius)return h.polygonBounce(t),!0}return!1},h.prototype.clickPositionValid=function(t){var n=this.options;return!(!n.enable||n.type===PolygonMaskType_1.PolygonMaskType.none||n.type===PolygonMaskType_1.PolygonMaskType.inline||!this.checkInsidePolygon(t))},h.prototype.downloadSvgPathToPolygon=function(r,s){return __awaiter(this,void 0,void 0,function(){var n,e,o,a,i;return __generator(this,function(t){switch(t.label){case 0:return n=this.options,e=r||n.url,o=null!=s&&s,!e||void 0!==this.paths&&!o?[2,this.raw]:[4,fetch(e)];case 1:return(a=t.sent()).ok?(i=this.parseSvgPathToPolygon,[4,a.text()]):[3,3];case 2:return[2,i.apply(this,[t.sent()])];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download")}})})},h.prototype.parseSvgPathToPolygon=function(t,n){var e,o=null!=n&&n;if(void 0!==this.paths&&!o)return this.raw;var a=this.container,i=this.options,r=(new DOMParser).parseFromString(t,"image/svg+xml"),s=r.getElementsByTagName("svg")[0],l=s.getElementsByTagName("path");l.length||(l=r.getElementsByTagName("path")),this.paths=[];for(var h=0;h<l.length;h++){(u=l.item(h))&&(console.dir(u),this.paths.push({element:u,length:u.getTotalLength()}))}var y=a.retina.pixelRatio,g=i.scale/y;this.dimension.width=parseFloat(s.getAttribute("width")||"0")*g,this.dimension.height=parseFloat(s.getAttribute("height")||"0")*g;var c=null!==(e=i.position)&&void 0!==e?e:{x:50,y:50};this.offset={x:a.canvas.size.width*c.x/(100*y)-this.dimension.width/2,y:a.canvas.size.height*c.y/(100*y)-this.dimension.height/2};for(var p=[],P=0,d=this.paths;P<d.length;P++)for(var u,w=(u=d[P]).element.pathSegList.numberOfItems,v={x:0,y:0},h=0;h<w;h++){var _=u.element.pathSegList.getItem(h);switch(_.pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:var f=_;v.x=f.x,v.y=f.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:v.x=_.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:v.y=_.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:var T=_;v.x+=T.x,v.y+=T.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:v.x+=_.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:v.y+=_.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}p.push({x:v.x*g+this.offset.x,y:v.y*g+this.offset.y})}return p},h.prototype.draw=function(t){var n;if(null!==(n=this.paths)&&void 0!==n&&n.length){var e=this.options;if(e.enable&&e.draw.enable)for(var o=e.draw,a=this.raw,i=0,r=this.paths;i<r.length;i++){var s=r[i].path2d,l=this.path2DSupported;t&&(l&&s&&this.offset?h.drawPolygonMaskPath(t,s,o.stroke,this.offset):a&&h.drawPolygonMask(t,a,o.stroke))}}},h.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var n=0,e=this.raw;n<e.length;n++){var o=e[n];t.particles.addParticle({x:o.x,y:o.y})}},h.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},h.prototype.getRandomPointOnPolygonPathByLength=function(){var t,n,e,o=this.options;if(!this.raw||!this.raw.length||null===(t=this.paths)||void 0===t||!t.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var a=Utils_1.Utils.itemFromArray(this.paths),i=Math.floor(Math.random()*a.length)+1,r=a.element.getPointAtLength(i);return{x:r.x*o.scale+((null===(n=this.offset)||void 0===n?void 0:n.x)||0),y:r.y*o.scale+((null===(e=this.offset)||void 0===e?void 0:e.y)||0)}},h.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var n,e,o,a,i,r,s,l=this.container.options,h=this.options;if(!this.raw||!this.raw.length||null===(n=this.paths)||void 0===n||!n.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);for(var y,g=0,c=this.paths.reduce(function(t,n){return t+n.length},0)/l.particles.number.value,p=0,P=this.paths;p<P.length;p++){var d=P[p],u=c*t-g;if(u<=d.length){y=d.element.getPointAtLength(u);break}g+=d.length}return{x:(null!==(e=null==y?void 0:y.x)&&void 0!==e?e:0)*h.scale+(null!==(a=null===(o=this.offset)||void 0===o?void 0:o.x)&&void 0!==a?a:0),y:(null!==(i=null==y?void 0:y.y)&&void 0!==i?i:0)*h.scale+(null!==(s=null===(r=this.offset)||void 0===r?void 0:r.y)&&void 0!==s?s:0)}},h.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var n=this.raw[t%this.raw.length];return{x:n.x,y:n.y}},h.prototype.createPath2D=function(){var t,r,s=this.options;if(this.path2DSupported&&null!==(t=this.paths)&&void 0!==t&&t.length)for(var n=function(o){var t,n,e,a,i=null===(r=o.element)||void 0===r?void 0:r.getAttribute("d");i?(t=new Path2D(i),n=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),e=new Path2D,a=n.scale(s.scale),e.addPath?(e.addPath(t,a),o.path2d=e):delete o.path2d):delete o.path2d,!o.path2d&&l.raw&&(o.path2d=new Path2D,o.path2d.moveTo(l.raw[0].x,l.raw[0].y),l.raw.forEach(function(t,n){var e;0<n&&null!==(e=o.path2d)&&void 0!==e&&e.lineTo(t.x,t.y)}),o.path2d.closePath())},l=this,e=0,o=this.paths;e<o.length;e++){n(o[e])}},h}();exports.PolygonMaskInstance=PolygonMaskInstance;