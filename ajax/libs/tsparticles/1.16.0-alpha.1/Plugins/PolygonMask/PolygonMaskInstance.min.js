"use strict";var __awaiter=this&&this.__awaiter||function(t,r,s,h){return new(s=s||Promise)(function(n,e){function o(t){try{a(h.next(t))}catch(t){e(t)}}function i(t){try{a(h.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(o,i)}a((h=h.apply(t,r||[])).next())})},__generator=this&&this.__generator||function(n,o){var i,a,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,a&&(r=2&e[0]?a.return:e[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,e[1])).done)return r;switch(a=0,r&&(e=[2&e[0],r.value]),e[0]){case 0:case 1:r=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,a=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3])){s.label=e[1];break}if(6===e[0]&&s.label<r[1]){s.label=r[1],r=e;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(e);break}r[2]&&s.ops.pop(),s.trys.pop();continue}e=o.call(n,s)}catch(t){e=[6,t],a=0}finally{i=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PolygonMaskInstance=void 0;var Enums_1=require("./Enums"),Utils_1=require("../../Utils"),PolygonMask_1=require("./Options/Classes/PolygonMask"),PolygonMaskInstance=function(){function l(t){this.container=t,this.dimension={height:0,width:0},this.path2DSupported=Object.prototype.hasOwnProperty.call(window,"Path2D"),this.options=new PolygonMask_1.PolygonMask,this.polygonMaskMoveRadius=this.options.move.radius*t.retina.pixelRatio}return l.polygonBounce=function(t){t.velocity.horizontal=-t.velocity.horizontal+t.velocity.vertical/2,t.velocity.vertical=-t.velocity.vertical+t.velocity.horizontal/2},l.drawPolygonMask=function(t,e,n){var o=Utils_1.ColorUtils.colorToRgb(n.color);if(o){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var i=1;i<e.length;i++)t.lineTo(e[i].x,e[i].y);t.closePath(),t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(o),t.lineWidth=n.width,t.stroke()}},l.drawPolygonMaskPath=function(t,e,n,o){t.translate(o.x,o.y);var i=Utils_1.ColorUtils.colorToRgb(n.color);i&&(t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(i,n.opacity),t.lineWidth=n.width,t.stroke(e))},l.prototype.initAsync=function(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.options.load(null==n?void 0:n.polygon),e=this.options,this.polygonMaskMoveRadius=e.move.radius*this.container.retina.pixelRatio,e.enable?[4,this.initRawData()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},l.prototype.checkInsidePolygon=function(t){var e=this.container,n=this.options;if(!n.enable||n.type===Enums_1.Type.none||n.type===Enums_1.Type.inline)return!0;if(!this.raw)throw new Error(Utils_1.Constants.noPolygonFound);for(var o=t?t.x:Math.random()*e.canvas.size.width,i=t?t.y:Math.random()*e.canvas.size.height,a=!1,r=0,s=this.raw.length-1;r<this.raw.length;s=r++){var h=this.raw[r].x,l=this.raw[r].y,c=this.raw[s].x,u=this.raw[s].y;i<l!=i<u&&o<(c-h)*(i-l)/(u-l)+h&&(a=!a)}return n.type===Enums_1.Type.inside?a:n.type===Enums_1.Type.outside&&!a},l.prototype.resize=function(){var t=this,e=this.container,n=this.options;n.enable&&n.type!==Enums_1.Type.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.initRawData()];case 1:return t.sent(),e.particles.redraw(),[2]}})})},250))},l.prototype.stop=function(){delete this.raw,delete this.paths},l.prototype.randomPointInPolygon=function(){var t,e=this.container,n=this.options;if(n.type===Enums_1.Type.inline)switch(n.inline.arrangement){case Enums_1.InlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case Enums_1.InlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case Enums_1.InlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(e.particles.count);break;case Enums_1.InlineArrangement.onePerPoint:case Enums_1.InlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(e.particles.count)}else t={x:Math.random()*e.canvas.size.width,y:Math.random()*e.canvas.size.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},l.prototype.particlesInitialization=function(){var t=this.options;return!(!t.enable||t.type!==Enums_1.Type.inline||t.inline.arrangement!==Enums_1.InlineArrangement.onePerPoint&&t.inline.arrangement!==Enums_1.InlineArrangement.perPoint)&&(this.drawPointsOnPolygonPath(),!0)},l.prototype.particlePosition=function(t,e){var n,o,i=this.options;if(i.enable&&0<(null!==(o=null===(n=this.raw)||void 0===n?void 0:n.length)&&void 0!==o?o:0)){var a,r={x:0,y:0};return t?(r.x=t.x,r.y=t.y):(a=this.randomPointInPolygon(),r.x=a.x,r.y=a.y),i.type===Enums_1.Type.inline&&e&&(e.initialPosition={x:r.x,y:r.y}),r}},l.prototype.particleBounce=function(t,e){var n=this.options;if(n.enable&&n.type!==Enums_1.Type.none&&n.type!==Enums_1.Type.inline){if(!this.checkInsidePolygon(t.getPosition()))return l.polygonBounce(t),!0}else if(n.enable&&n.type===Enums_1.Type.inline){if(t.initialPosition)if(Utils_1.Utils.getDistance(t.initialPosition,t.getPosition())>this.polygonMaskMoveRadius)return l.polygonBounce(t),!0}return!1},l.prototype.clickPositionValid=function(t){var e=this.options;return!(!e.enable||e.type===Enums_1.Type.none||e.type===Enums_1.Type.inline||!this.checkInsidePolygon(t))},l.prototype.downloadSvgPathToPolygon=function(r,s){return __awaiter(this,void 0,void 0,function(){var e,n,o,i,a;return __generator(this,function(t){switch(t.label){case 0:return e=this.options,n=r||e.url,o=null!=s&&s,!n||void 0!==this.paths&&!o?[2,this.raw]:[4,fetch(n)];case 1:return(i=t.sent()).ok?(a=this.parseSvgPathToPolygon,[4,i.text()]):[3,3];case 2:return[2,a.apply(this,[t.sent()])];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download")}})})},l.prototype.parseSvgPathToPolygon=function(t,e){var n,o=null!=e&&e;if(void 0!==this.paths&&!o)return this.raw;var i=this.container,a=this.options,r=(new DOMParser).parseFromString(t,"image/svg+xml"),s=r.getElementsByTagName("svg")[0],h=s.getElementsByTagName("path");h.length||(h=r.getElementsByTagName("path")),this.paths=[];for(var l=0;l<h.length;l++){(w=h.item(l))&&this.paths.push({element:w,length:w.getTotalLength()})}var c=i.retina.pixelRatio,u=a.scale/c;this.dimension.width=parseFloat(s.getAttribute("width")||"0")*u,this.dimension.height=parseFloat(s.getAttribute("height")||"0")*u;var p=null!==(n=a.position)&&void 0!==n?n:{x:50,y:50};this.offset={x:i.canvas.size.width*p.x/(100*c)-this.dimension.width/2,y:i.canvas.size.height*p.y/(100*c)-this.dimension.height/2};for(var d=[],y=0,g=this.paths;y<g.length;y++)for(var w,P=(w=g[y]).element.pathSegList,v=P.numberOfItems,f={x:0,y:0},l=0;l<v;l++){var _=P.getItem(l);switch(_.pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:var m=_;f.x=m.x,f.y=m.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:f.x=_.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:f.y=_.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:var S=_;f.x+=S.x,f.y+=S.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:f.x+=_.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:f.y+=_.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}d.push({x:f.x*u+this.offset.x,y:f.y*u+this.offset.y})}return d},l.prototype.draw=function(t){var e;if(null!==(e=this.paths)&&void 0!==e&&e.length){var n=this.options;if(n.enable&&n.draw.enable)for(var o=n.draw,i=this.raw,a=0,r=this.paths;a<r.length;a++){var s=r[a].path2d,h=this.path2DSupported;t&&(h&&s&&this.offset?l.drawPolygonMaskPath(t,s,o.stroke,this.offset):i&&l.drawPolygonMask(t,i,o.stroke))}}},l.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var e=0,n=this.raw;e<n.length;e++){var o=n[e];t.particles.addParticle({x:o.x,y:o.y})}},l.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},l.prototype.getRandomPointOnPolygonPathByLength=function(){var t,e,n,o=this.options;if(!this.raw||!this.raw.length||null===(t=this.paths)||void 0===t||!t.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var i=Utils_1.Utils.itemFromArray(this.paths),a=Math.floor(Math.random()*i.length)+1,r=i.element.getPointAtLength(a);return{x:r.x*o.scale+((null===(e=this.offset)||void 0===e?void 0:e.x)||0),y:r.y*o.scale+((null===(n=this.offset)||void 0===n?void 0:n.y)||0)}},l.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var e,n,o,i,a,r,s,h=this.container.options,l=this.options;if(!this.raw||!this.raw.length||null===(e=this.paths)||void 0===e||!e.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);for(var c,u=0,p=this.paths.reduce(function(t,e){return t+e.length},0)/h.particles.number.value,d=0,y=this.paths;d<y.length;d++){var g=y[d],w=p*t-u;if(w<=g.length){c=g.element.getPointAtLength(w);break}u+=g.length}return{x:(null!==(n=null==c?void 0:c.x)&&void 0!==n?n:0)*l.scale+(null!==(i=null===(o=this.offset)||void 0===o?void 0:o.x)&&void 0!==i?i:0),y:(null!==(a=null==c?void 0:c.y)&&void 0!==a?a:0)*l.scale+(null!==(s=null===(r=this.offset)||void 0===r?void 0:r.y)&&void 0!==s?s:0)}},l.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var e=this.raw[t%this.raw.length];return{x:e.x,y:e.y}},l.prototype.createPath2D=function(){var t,r,s=this.options;if(this.path2DSupported&&null!==(t=this.paths)&&void 0!==t&&t.length)for(var e=function(o){var t,e,n,i,a=null===(r=o.element)||void 0===r?void 0:r.getAttribute("d");a?(t=new Path2D(a),e=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),n=new Path2D,i=e.scale(s.scale),n.addPath?(n.addPath(t,i),o.path2d=n):delete o.path2d):delete o.path2d,!o.path2d&&h.raw&&(o.path2d=new Path2D,o.path2d.moveTo(h.raw[0].x,h.raw[0].y),h.raw.forEach(function(t,e){var n;0<e&&null!==(n=o.path2d)&&void 0!==n&&n.lineTo(t.x,t.y)}),o.path2d.closePath())},h=this,n=0,o=this.paths;n<o.length;n++){e(o[n])}},l.prototype.initRawData=function(){return __awaiter(this,void 0,void 0,function(){var e,n,o,i,a;return __generator(this,function(t){switch(t.label){case 0:return(e=this.options).url?[4,(n=this).downloadSvgPathToPolygon(e.url)]:[3,2];case 1:return n.raw=t.sent(),[3,3];case 2:e.data&&(o=e.data,i=void 0,i="string"!=typeof o?(a=o.path instanceof Array?o.path.map(function(t){return'<path d="'+t+'" />'}).join(""):'<path d="'+o.path+'" />','<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+o.size.width+'" height="'+o.size.height+'">'+a+"</svg>"):o,this.raw=this.parseSvgPathToPolygon(i)),t.label=3;case 3:return this.createPath2D(),[2]}})})},l}();exports.PolygonMaskInstance=PolygonMaskInstance;