"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PolygonMaskInstance=void 0;var tslib_1=require("tslib"),PolygonMaskType_1=require("../../Enums/PolygonMaskType"),PolygonMaskInlineArrangement_1=require("../../Enums/PolygonMaskInlineArrangement"),Utils_1=require("../../Utils"),PolygonMask_1=require("./Options/Classes/PolygonMask"),PolygonMaskInstance=function(){function l(t){this.container=t,this.dimension={height:0,width:0},this.paths=[],this.path2DSupported=Object.prototype.hasOwnProperty.call(window,"Path2D"),this.options=new PolygonMask_1.PolygonMask,this.polygonMaskMoveRadius=this.options.move.radius*t.retina.pixelRatio}return l.polygonBounce=function(t){t.velocity.horizontal=-t.velocity.horizontal+t.velocity.vertical/2,t.velocity.vertical=-t.velocity.vertical+t.velocity.horizontal/2},l.drawPolygonMask=function(t,e,n){var o=Utils_1.ColorUtils.colorToRgb(n.color);if(o){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var i=1;i<e.length;i++)t.lineTo(e[i].x,e[i].y);t.closePath(),t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(o),t.lineWidth=n.width,t.stroke()}},l.drawPolygonMaskPath=function(t,e,n,o){t.translate(o.x,o.y);var i=Utils_1.ColorUtils.colorToRgb(n.color);i&&(t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(i,n.opacity),t.lineWidth=n.width,t.stroke(e))},l.prototype.initAsync=function(o){return tslib_1.__awaiter(this,void 0,void 0,function(){var e,n;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return(this.options.load(null==o?void 0:o.polygon),e=this.options,this.polygonMaskMoveRadius=e.move.radius*this.container.retina.pixelRatio,e.enable&&e.url)?[4,(n=this).parseSvgPathToPolygon(e.url)]:[3,2];case 1:n.raw=t.sent(),this.createPath2D(),t.label=2;case 2:return[2]}})})},l.prototype.checkInsidePolygon=function(t){var e=this.container,n=this.options;if(!n.enable||n.type===PolygonMaskType_1.PolygonMaskType.none||n.type===PolygonMaskType_1.PolygonMaskType.inline)return!0;if(!this.raw)throw new Error(Utils_1.Constants.noPolygonFound);for(var o=t?t.x:Math.random()*e.canvas.size.width,i=t?t.y:Math.random()*e.canvas.size.height,a=!1,s=0,r=this.raw.length-1;s<this.raw.length;r=s++){var l=this.raw[s].x,h=this.raw[s].y,y=this.raw[r].x,g=this.raw[r].y;i<h!=i<g&&o<(y-l)*(i-h)/(g-h)+l&&(a=!a)}return n.type===PolygonMaskType_1.PolygonMaskType.inside?a:n.type===PolygonMaskType_1.PolygonMaskType.outside&&!a},l.prototype.resize=function(){var e=this,n=this.container,t=this.options;t.enable&&t.type!==PolygonMaskType_1.PolygonMaskType.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){e.parseSvgPathToPolygon().then(function(t){e.raw=t,e.createPath2D(),n.particles.redraw()})},250))},l.prototype.stop=function(){delete this.raw,this.paths=[],delete this.svg},l.prototype.randomPointInPolygon=function(){var t,e=this.container,n=this.options;if(n.type===PolygonMaskType_1.PolygonMaskType.inline)switch(n.inline.arrangement){case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(e.particles.count);break;case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint:case PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(e.particles.count)}else t={x:Math.random()*e.canvas.size.width,y:Math.random()*e.canvas.size.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},l.prototype.particlesInitialization=function(){var t=this.options;return!(!t.enable||t.type!==PolygonMaskType_1.PolygonMaskType.inline||t.inline.arrangement!==PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.onePerPoint&&t.inline.arrangement!==PolygonMaskInlineArrangement_1.PolygonMaskInlineArrangement.perPoint)&&(this.drawPointsOnPolygonPath(),!0)},l.prototype.particlePosition=function(t,e){var n,o,i=this.options;if(i.enable&&0<(null!==(o=null===(n=this.raw)||void 0===n?void 0:n.length)&&void 0!==o?o:0)){var a,s={x:0,y:0};return t?(s.x=t.x,s.y=t.y):(a=this.randomPointInPolygon(),s.x=a.x,s.y=a.y),i.type===PolygonMaskType_1.PolygonMaskType.inline&&e&&(e.initialPosition={x:s.x,y:s.y}),s}},l.prototype.particleBounce=function(t,e){var n=this.options;if(n.enable&&n.type!==PolygonMaskType_1.PolygonMaskType.none&&n.type!==PolygonMaskType_1.PolygonMaskType.inline){if(!this.checkInsidePolygon(t.getPosition()))return l.polygonBounce(t),!0}else if(n.enable&&n.type===PolygonMaskType_1.PolygonMaskType.inline){if(t.initialPosition)if(Utils_1.Utils.getDistance(t.initialPosition,t.getPosition())>this.polygonMaskMoveRadius)return l.polygonBounce(t),!0}return!1},l.prototype.clickPositionValid=function(t){var e=this.options;return!(!e.enable||e.type===PolygonMaskType_1.PolygonMaskType.none||e.type===PolygonMaskType_1.PolygonMaskType.inline||!this.checkInsidePolygon(t))},l.prototype.parseSvgPathToPolygon=function(f){var k;return tslib_1.__awaiter(this,void 0,void 0,function(){var e,n,o,i,a,s,r,l,h,y,g,P,p,c,d,w,u,_,v,T,S;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return e=this.container,n=this.options,o=f||n.url,this.paths.length&&this.svg?[3,4]:[4,fetch(o)];case 1:return(i=t.sent()).ok?[4,i.text()]:[3,3];case 2:for(a=t.sent(),s=new DOMParser,r=s.parseFromString(a,"image/svg+xml"),this.svg=r.getElementsByTagName("svg")[0],l=r.getElementsByTagName("path"),_=0;_<l.length;_++)(d=l.item(_))&&this.paths.push({element:d,length:d.getTotalLength()});return[3,4];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download");case 4:for(h=e.retina.pixelRatio,y=n.scale/h,this.dimension.width=parseFloat(this.svg.getAttribute("width")||"0")*y,this.dimension.height=parseFloat(this.svg.getAttribute("height")||"0")*y,g=null!==(k=n.position)&&void 0!==k?k:{x:50,y:50},this.offset={x:e.canvas.size.width*g.x/(100*h)-this.dimension.width/2,y:e.canvas.size.height*g.y/(100*h)-this.dimension.height/2},P=[],p=0,c=this.paths;p<c.length;p++)for(d=c[p],w=d.element.pathSegList.numberOfItems,u={x:0,y:0},_=0;_<w;_++){switch((v=d.element.pathSegList.getItem(_)).pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:T=v,u.x=T.x,u.y=T.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:u.x=v.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:u.y=v.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:S=v,u.x+=S.x,u.y+=S.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:u.x+=v.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:u.y+=v.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}P.push({x:u.x*y+this.offset.x,y:u.y*y+this.offset.y})}return[2,P]}})})},l.prototype.draw=function(t){var e=this.options;if(e.enable&&e.draw.enable)for(var n=e.draw,o=this.raw,i=0,a=this.paths;i<a.length;i++){var s=a[i].path2d,r=this.path2DSupported;t&&(r&&s&&this.offset?l.drawPolygonMaskPath(t,s,n.stroke,this.offset):o&&l.drawPolygonMask(t,o,n.stroke))}},l.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var e=0,n=this.raw;e<n.length;e++){var o=n[e];t.particles.addParticle({x:o.x,y:o.y})}},l.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},l.prototype.getRandomPointOnPolygonPathByLength=function(){var t,e,n=this.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var o=Utils_1.Utils.itemFromArray(this.paths),i=Math.floor(Math.random()*o.length)+1,a=o.element.getPointAtLength(i);return{x:a.x*n.scale+((null===(t=this.offset)||void 0===t?void 0:t.x)||0),y:a.y*n.scale+((null===(e=this.offset)||void 0===e?void 0:e.y)||0)}},l.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var e,n,o,i,a,s,r=this.container.options,l=this.options;if(!this.raw||!this.raw.length||!this.paths.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);for(var h,y=0,g=this.paths.reduce(function(t,e){return t+e.length},0)/r.particles.number.value,P=0,p=this.paths;P<p.length;P++){var c=p[P],d=g*t-y;if(d<=c.length){h=c.element.getPointAtLength(d);break}y+=c.length}return{x:(null!==(e=null==h?void 0:h.x)&&void 0!==e?e:0)*l.scale+(null!==(o=null===(n=this.offset)||void 0===n?void 0:n.x)&&void 0!==o?o:0),y:(null!==(i=null==h?void 0:h.y)&&void 0!==i?i:0)*l.scale+(null!==(s=null===(a=this.offset)||void 0===a?void 0:a.y)&&void 0!==s?s:0)}},l.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var e=this.raw[t%this.raw.length];return{x:e.x,y:e.y}},l.prototype.createPath2D=function(){var s,r=this.options;if(this.path2DSupported)for(var t=function(o){var t,e,n,i,a=null===(s=o.element)||void 0===s?void 0:s.getAttribute("d");a?(t=new Path2D(a),e=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),n=new Path2D,i=e.scale(r.scale),n.addPath?(n.addPath(t,i),o.path2d=n):delete o.path2d):delete o.path2d,!o.path2d&&l.raw&&(o.path2d=new Path2D,o.path2d.moveTo(l.raw[0].x,l.raw[0].y),l.raw.forEach(function(t,e){var n;0<e&&null!==(n=o.path2d)&&void 0!==n&&n.lineTo(t.x,t.y)}),o.path2d.closePath())},l=this,e=0,n=this.paths;e<n.length;e++){t(n[e])}},l}();exports.PolygonMaskInstance=PolygonMaskInstance;