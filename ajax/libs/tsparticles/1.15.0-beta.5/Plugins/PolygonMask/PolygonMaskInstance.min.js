"use strict";var __awaiter=this&&this.__awaiter||function(t,r,s,l){return new(s=s||Promise)(function(n,e){function i(t){try{a(l.next(t))}catch(t){e(t)}}function o(t){try{a(l.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(i,o)}a((l=l.apply(t,r||[])).next())})},__generator=this&&this.__generator||function(n,i){var o,a,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,a&&(r=2&e[0]?a.return:e[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,e[1])).done)return r;switch(a=0,r&&(e=[2&e[0],r.value]),e[0]){case 0:case 1:r=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,a=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3])){s.label=e[1];break}if(6===e[0]&&s.label<r[1]){s.label=r[1],r=e;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(e);break}r[2]&&s.ops.pop(),s.trys.pop();continue}e=i.call(n,s)}catch(t){e=[6,t],a=0}finally{o=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PolygonMaskInstance=void 0;var Type_1=require("./Enums/Type"),InlineArrangement_1=require("./Enums/InlineArrangement"),Utils_1=require("../../Utils"),PolygonMask_1=require("./Options/Classes/PolygonMask"),PolygonMaskInstance=function(){function h(t){this.container=t,this.dimension={height:0,width:0},this.path2DSupported=Object.prototype.hasOwnProperty.call(window,"Path2D"),this.options=new PolygonMask_1.PolygonMask,this.polygonMaskMoveRadius=this.options.move.radius*t.retina.pixelRatio}return h.polygonBounce=function(t){t.velocity.horizontal=-t.velocity.horizontal+t.velocity.vertical/2,t.velocity.vertical=-t.velocity.vertical+t.velocity.horizontal/2},h.drawPolygonMask=function(t,e,n){var i=Utils_1.ColorUtils.colorToRgb(n.color);if(i){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var o=1;o<e.length;o++)t.lineTo(e[o].x,e[o].y);t.closePath(),t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(i),t.lineWidth=n.width,t.stroke()}},h.drawPolygonMaskPath=function(t,e,n,i){t.translate(i.x,i.y);var o=Utils_1.ColorUtils.colorToRgb(n.color);o&&(t.strokeStyle=Utils_1.ColorUtils.getStyleFromRgb(o,n.opacity),t.lineWidth=n.width,t.stroke(e))},h.prototype.initAsync=function(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.options.load(null==n?void 0:n.polygon),e=this.options,this.polygonMaskMoveRadius=e.move.radius*this.container.retina.pixelRatio,e.enable?[4,this.initRawData()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},h.prototype.checkInsidePolygon=function(t){var e=this.container,n=this.options;if(!n.enable||n.type===Type_1.Type.none||n.type===Type_1.Type.inline)return!0;if(!this.raw)throw new Error(Utils_1.Constants.noPolygonFound);for(var i=t?t.x:Math.random()*e.canvas.size.width,o=t?t.y:Math.random()*e.canvas.size.height,a=!1,r=0,s=this.raw.length-1;r<this.raw.length;s=r++){var l=this.raw[r].x,h=this.raw[r].y,p=this.raw[s].x,c=this.raw[s].y;o<h!=o<c&&i<(p-l)*(o-h)/(c-h)+l&&(a=!a)}return n.type===Type_1.Type.inside?a:n.type===Type_1.Type.outside&&!a},h.prototype.resize=function(){var t=this,e=this.container,n=this.options;n.enable&&n.type!==Type_1.Type.none&&(this.redrawTimeout&&clearTimeout(this.redrawTimeout),this.redrawTimeout=window.setTimeout(function(){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.initRawData()];case 1:return t.sent(),e.particles.redraw(),[2]}})})},250))},h.prototype.stop=function(){delete this.raw,delete this.paths},h.prototype.randomPointInPolygon=function(){var t,e=this.container,n=this.options;if(n.type===Type_1.Type.inline)switch(n.inline.arrangement){case InlineArrangement_1.InlineArrangement.randomPoint:t=this.getRandomPointOnPolygonPath();break;case InlineArrangement_1.InlineArrangement.randomLength:t=this.getRandomPointOnPolygonPathByLength();break;case InlineArrangement_1.InlineArrangement.equidistant:t=this.getEquidistantPointOnPolygonPathByIndex(e.particles.count);break;case InlineArrangement_1.InlineArrangement.onePerPoint:case InlineArrangement_1.InlineArrangement.perPoint:default:t=this.getPointOnPolygonPathByIndex(e.particles.count)}else t={x:Math.random()*e.canvas.size.width,y:Math.random()*e.canvas.size.height};return this.checkInsidePolygon(t)?t:this.randomPointInPolygon()},h.prototype.particlesInitialization=function(){var t=this.options;return!(!t.enable||t.type!==Type_1.Type.inline||t.inline.arrangement!==InlineArrangement_1.InlineArrangement.onePerPoint&&t.inline.arrangement!==InlineArrangement_1.InlineArrangement.perPoint)&&(this.drawPointsOnPolygonPath(),!0)},h.prototype.particlePosition=function(t,e){var n,i,o=this.options;if(o.enable&&0<(null!==(i=null===(n=this.raw)||void 0===n?void 0:n.length)&&void 0!==i?i:0)){var a,r={x:0,y:0};return t?(r.x=t.x,r.y=t.y):(a=this.randomPointInPolygon(),r.x=a.x,r.y=a.y),o.type===Type_1.Type.inline&&e&&(e.initialPosition={x:r.x,y:r.y}),r}},h.prototype.particleBounce=function(t,e){var n=this.options;if(n.enable&&n.type!==Type_1.Type.none&&n.type!==Type_1.Type.inline){if(!this.checkInsidePolygon(t.getPosition()))return h.polygonBounce(t),!0}else if(n.enable&&n.type===Type_1.Type.inline){if(t.initialPosition)if(Utils_1.Utils.getDistance(t.initialPosition,t.getPosition())>this.polygonMaskMoveRadius)return h.polygonBounce(t),!0}return!1},h.prototype.clickPositionValid=function(t){var e=this.options;return!(!e.enable||e.type===Type_1.Type.none||e.type===Type_1.Type.inline||!this.checkInsidePolygon(t))},h.prototype.downloadSvgPathToPolygon=function(r,s){return __awaiter(this,void 0,void 0,function(){var e,n,i,o,a;return __generator(this,function(t){switch(t.label){case 0:return e=this.options,n=r||e.url,i=null!=s&&s,!n||void 0!==this.paths&&!i?[2,this.raw]:[4,fetch(n)];case 1:return(o=t.sent()).ok?(a=this.parseSvgPathToPolygon,[4,o.text()]):[3,3];case 2:return[2,a.apply(this,[t.sent()])];case 3:throw new Error("tsParticles Error - Error occurred during polygon mask download")}})})},h.prototype.parseSvgPathToPolygon=function(t,e){var n,i=null!=e&&e;if(void 0!==this.paths&&!i)return this.raw;var o=this.container,a=this.options,r=(new DOMParser).parseFromString(t,"image/svg+xml"),s=r.getElementsByTagName("svg")[0],l=s.getElementsByTagName("path");l.length||(l=r.getElementsByTagName("path")),this.paths=[];for(var h=0;h<l.length;h++){(w=l.item(h))&&this.paths.push({element:w,length:w.getTotalLength()})}var p=o.retina.pixelRatio,c=a.scale/p;this.dimension.width=parseFloat(s.getAttribute("width")||"0")*c,this.dimension.height=parseFloat(s.getAttribute("height")||"0")*c;var y=null!==(n=a.position)&&void 0!==n?n:{x:50,y:50};this.offset={x:o.canvas.size.width*y.x/(100*p)-this.dimension.width/2,y:o.canvas.size.height*y.y/(100*p)-this.dimension.height/2};for(var g=[],u=0,d=this.paths;u<d.length;u++)for(var w,P=(w=d[u]).element.pathSegList,v=P.numberOfItems,f={x:0,y:0},h=0;h<v;h++){var _=P.getItem(h);switch(_.pathSegType){case window.SVGPathSeg.PATHSEG_MOVETO_ABS:case window.SVGPathSeg.PATHSEG_LINETO_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:case window.SVGPathSeg.PATHSEG_ARC_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:var T=_;f.x=T.x,f.y=T.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:f.x=_.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:f.y=_.y;break;case window.SVGPathSeg.PATHSEG_LINETO_REL:case window.SVGPathSeg.PATHSEG_MOVETO_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:case window.SVGPathSeg.PATHSEG_ARC_REL:case window.SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:case window.SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:var S=_;f.x+=S.x,f.y+=S.y;break;case window.SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:f.x+=_.x;break;case window.SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:f.y+=_.y;break;case window.SVGPathSeg.PATHSEG_UNKNOWN:case window.SVGPathSeg.PATHSEG_CLOSEPATH:continue}g.push({x:f.x*c+this.offset.x,y:f.y*c+this.offset.y})}return g},h.prototype.draw=function(t){var e;if(null!==(e=this.paths)&&void 0!==e&&e.length){var n=this.options;if(n.enable&&n.draw.enable)for(var i=n.draw,o=this.raw,a=0,r=this.paths;a<r.length;a++){var s=r[a].path2d,l=this.path2DSupported;t&&(l&&s&&this.offset?h.drawPolygonMaskPath(t,s,i.stroke,this.offset):o&&h.drawPolygonMask(t,o,i.stroke))}}},h.prototype.drawPointsOnPolygonPath=function(){var t=this.container;if(this.raw)for(var e=0,n=this.raw;e<n.length;e++){var i=n[e];t.particles.addParticle({x:i.x,y:i.y})}},h.prototype.getRandomPointOnPolygonPath=function(){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var t=Utils_1.Utils.itemFromArray(this.raw);return{x:t.x,y:t.y}},h.prototype.getRandomPointOnPolygonPathByLength=function(){var t,e,n,i=this.options;if(!this.raw||!this.raw.length||null===(t=this.paths)||void 0===t||!t.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var o=Utils_1.Utils.itemFromArray(this.paths),a=Math.floor(Math.random()*o.length)+1,r=o.element.getPointAtLength(a);return{x:r.x*i.scale+((null===(e=this.offset)||void 0===e?void 0:e.x)||0),y:r.y*i.scale+((null===(n=this.offset)||void 0===n?void 0:n.y)||0)}},h.prototype.getEquidistantPointOnPolygonPathByIndex=function(t){var e,n,i,o,a,r,s,l=this.container.options,h=this.options;if(!this.raw||!this.raw.length||null===(e=this.paths)||void 0===e||!e.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);for(var p,c=0,y=this.paths.reduce(function(t,e){return t+e.length},0)/l.particles.number.value,g=0,u=this.paths;g<u.length;g++){var d=u[g],w=y*t-c;if(w<=d.length){p=d.element.getPointAtLength(w);break}c+=d.length}return{x:(null!==(n=null==p?void 0:p.x)&&void 0!==n?n:0)*h.scale+(null!==(o=null===(i=this.offset)||void 0===i?void 0:i.x)&&void 0!==o?o:0),y:(null!==(a=null==p?void 0:p.y)&&void 0!==a?a:0)*h.scale+(null!==(s=null===(r=this.offset)||void 0===r?void 0:r.y)&&void 0!==s?s:0)}},h.prototype.getPointOnPolygonPathByIndex=function(t){if(!this.raw||!this.raw.length)throw new Error(Utils_1.Constants.noPolygonDataLoaded);var e=this.raw[t%this.raw.length];return{x:e.x,y:e.y}},h.prototype.createPath2D=function(){var t,r,s=this.options;if(this.path2DSupported&&null!==(t=this.paths)&&void 0!==t&&t.length)for(var e=function(i){var t,e,n,o,a=null===(r=i.element)||void 0===r?void 0:r.getAttribute("d");a?(t=new Path2D(a),e=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),n=new Path2D,o=e.scale(s.scale),n.addPath?(n.addPath(t,o),i.path2d=n):delete i.path2d):delete i.path2d,!i.path2d&&l.raw&&(i.path2d=new Path2D,i.path2d.moveTo(l.raw[0].x,l.raw[0].y),l.raw.forEach(function(t,e){var n;0<e&&null!==(n=i.path2d)&&void 0!==n&&n.lineTo(t.x,t.y)}),i.path2d.closePath())},l=this,n=0,i=this.paths;n<i.length;n++){e(i[n])}},h.prototype.initRawData=function(){return __awaiter(this,void 0,void 0,function(){var e,n,i,o,a;return __generator(this,function(t){switch(t.label){case 0:return(e=this.options).url?[4,(n=this).downloadSvgPathToPolygon(e.url)]:[3,2];case 1:return n.raw=t.sent(),[3,3];case 2:e.data&&(i=e.data,o=void 0,o="string"!=typeof i?(a=i.path instanceof Array?i.path.map(function(t){return'<path d="'+t+'" />'}).join(""):'<path d="'+i.path+'" />','<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+i.size.width+'" height="'+i.size.height+'">'+a+"</svg>"):i,this.raw=this.parseSvgPathToPolygon(o)),t.label=3;case 3:return this.createPath2D(),[2]}})})},h}();exports.PolygonMaskInstance=PolygonMaskInstance;