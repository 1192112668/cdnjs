"use strict";var __awaiter=this&&this.__awaiter||function(t,i,e,s){return new(e||(e=Promise))(function(n,a){function r(t){try{h(s.next(t))}catch(t){a(t)}}function o(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var i;t.done?n(t.value):(i=t.value,i instanceof e?i:new e(function(t){t(i)})).then(r,o)}h((s=s.apply(t,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Container=void 0;const Canvas_1=require("./Canvas"),Particles_1=require("./Particles"),Retina_1=require("./Retina"),FrameManager_1=require("./FrameManager"),Options_1=require("../Options/Classes/Options"),Utils_1=require("../Utils");class Container{constructor(t,i,...e){this.id=t,this.sourceOptions=i,this.started=!1,this.destroyed=!1,this.paused=!0,this.lastFrameTime=0,this.pageHidden=!1,this.retina=new Retina_1.Retina(this),this.canvas=new Canvas_1.Canvas(this),this.particles=new Particles_1.Particles(this),this.drawer=new FrameManager_1.FrameManager(this),this.noise={generate:()=>({angle:Math.random()*Math.PI*2,length:Math.random()}),init:()=>{},update:()=>{}},this.interactivity={mouse:{}},this.bubble={},this.repulse={particles:[]},this.plugins=new Map,this.drawers=new Map,this.density=1,this.options=new Options_1.Options;for(const t of e)this.options.load(Utils_1.Plugins.getPreset(t));const s=Utils_1.Plugins.getSupportedShapes();for(const t of s){const i=Utils_1.Plugins.getShapeDrawer(t);i&&this.drawers.set(t,i)}this.sourceOptions&&this.options.load(this.sourceOptions),this.eventListeners=new Utils_1.EventListeners(this)}static requestFrame(t){return window.customRequestAnimationFrame(t)}static cancelAnimation(t){window.cancelAnimationFrame(t)}play(t){const i=this.paused||t;if(this.paused&&(this.paused=!1),i){for(const[,t]of this.plugins)t.play&&t.play();this.lastFrameTime=performance.now()}this.draw()}pause(){if(void 0!==this.drawAnimationFrame&&(Container.cancelAnimation(this.drawAnimationFrame),delete this.drawAnimationFrame),!this.paused){for(const[,t]of this.plugins)t.pause&&t.pause();this.pageHidden||(this.paused=!0)}}draw(){this.drawAnimationFrame=Container.requestFrame(t=>{var i;return null===(i=this.drawer)||void 0===i?void 0:i.nextFrame(t)})}getAnimationStatus(){return!this.paused}setNoise(t,i,e){t&&("function"==typeof t?(this.noise.generate=t,i&&(this.noise.init=i),e&&(this.noise.update=e)):(t.generate&&(this.noise.generate=t.generate),t.init&&(this.noise.init=t.init),t.update&&(this.noise.update=t.update)))}densityAutoParticles(){this.initDensityFactor();const t=this.options.particles.number,i=t.value,e=t.limit>0?t.limit:i,s=Math.min(i,e)*this.density,n=this.particles.count;n<s?this.particles.push(Math.abs(s-n)):n>s&&this.particles.removeQuantity(n-s)}initDensityFactor(){const t=this.options.particles.number.density;if(!this.canvas.element||!t.enable)return;const i=this.canvas.element,e=this.retina.pixelRatio;this.density=i.width*i.height/(t.factor*e*t.area)}destroy(){this.stop(),this.retina.reset(),this.canvas.destroy(),delete this.interactivity,delete this.options,delete this.retina,delete this.canvas,delete this.particles,delete this.bubble,delete this.repulse,delete this.drawer,delete this.eventListeners;for(const[,t]of this.drawers)t.destroy&&t.destroy(this);this.drawers=new Map,this.destroyed=!0}exportImg(t){this.exportImage(t)}exportImage(t,i,e){var s;return null===(s=this.canvas.element)||void 0===s?void 0:s.toBlob(t,null!=i?i:"image/png",e)}exportConfiguration(){return JSON.stringify(this.options,void 0,2)}refresh(){return __awaiter(this,void 0,void 0,function*(){this.stop(),yield this.start()})}stop(){if(this.started){this.started=!1,this.eventListeners.removeListeners(),this.pause(),this.particles.clear(),this.retina.reset(),this.canvas.clear();for(const[,t]of this.plugins)t.stop&&t.stop();this.plugins=new Map,this.particles.linksColors={},delete this.particles.linksColor}}start(){return __awaiter(this,void 0,void 0,function*(){if(!this.started){yield this.init(),this.started=!0,this.eventListeners.addListeners();for(const[,t]of this.plugins)void 0!==t.startAsync?yield t.startAsync():void 0!==t.start&&t.start();this.play()}})}init(){return __awaiter(this,void 0,void 0,function*(){this.retina.init(),this.canvas.init();const t=Utils_1.Plugins.getAvailablePlugins(this);for(const[i,e]of t)this.plugins.set(i,e);for(const[,t]of this.drawers)t.init&&(yield t.init(this));for(const[,t]of this.plugins)t.init?t.init(this.options):void 0!==t.initAsync&&(yield t.initAsync(this.options));this.particles.init(),this.densityAutoParticles()})}}exports.Container=Container;