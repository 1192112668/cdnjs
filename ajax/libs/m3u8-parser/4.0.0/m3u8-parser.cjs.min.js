"use strict";var classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},Stream=function(){function t(){classCallCheck(this,t),this.listeners={}}return t.prototype.on=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t.prototype.off=function(t,e){if(!this.listeners[t])return!1;var i=this.listeners[t].indexOf(e);return this.listeners[t].splice(i,1),-1<i},t.prototype.trigger=function(t,e){var i=this.listeners[t],r=void 0,a=void 0,s=void 0;if(i)if(2===arguments.length)for(a=i.length,r=0;r<a;++r)i[r].call(this,e);else for(s=Array.prototype.slice.call(arguments,1),a=i.length,r=0;r<a;++r)i[r].apply(this,s)},t.prototype.dispose=function(){this.listeners={}},t.prototype.pipe=function(e){this.on("data",function(t){e.push(t)})},t}(),LineStream=function(e){function i(){classCallCheck(this,i);var t=possibleConstructorReturn(this,e.call(this));return t.buffer="",t}return inherits(i,e),i.prototype.push=function(t){var e=void 0;for(this.buffer+=t,e=this.buffer.indexOf("\n");-1<e;e=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)},i}(Stream),attributeSeparator=function(){return new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')},parseAttributes=function(t){for(var e=t.split(attributeSeparator()),i={},r=e.length,a=void 0;r--;)""!==e[r]&&((a=/([^=]*)=(.*)/.exec(e[r]).slice(1))[0]=a[0].replace(/^\s+|\s+$/g,""),a[1]=a[1].replace(/^\s+|\s+$/g,""),a[1]=a[1].replace(/^['"](.*)['"]$/g,"$1"),i[a[0]]=a[1]);return i},ParseStream=function(t){function e(){return classCallCheck(this,e),possibleConstructorReturn(this,t.call(this))}return inherits(e,t),e.prototype.push=function(t){var e,i,r=void 0,a=void 0;if(0!==(t=t.replace(/^[\u0000\s]+|[\u0000\s]+$/g,"")).length)if("#"===t[0])if(0===t.indexOf("#EXT"))if(t=t.replace("\r",""),r=/^#EXTM3U/.exec(t))this.trigger("data",{type:"tag",tagType:"m3u"});else{if(r=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(t))return a={type:"tag",tagType:"inf"},r[1]&&(a.duration=parseFloat(r[1])),r[2]&&(a.title=r[2]),void this.trigger("data",a);if(r=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(t))return a={type:"tag",tagType:"targetduration"},r[1]&&(a.duration=parseInt(r[1],10)),void this.trigger("data",a);if(r=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(t))return a={type:"tag",tagType:"totalduration"},r[1]&&(a.duration=parseInt(r[1],10)),void this.trigger("data",a);if(r=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(t))return a={type:"tag",tagType:"version"},r[1]&&(a.version=parseInt(r[1],10)),void this.trigger("data",a);if(r=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return a={type:"tag",tagType:"media-sequence"},r[1]&&(a.number=parseInt(r[1],10)),void this.trigger("data",a);if(r=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return a={type:"tag",tagType:"discontinuity-sequence"},r[1]&&(a.number=parseInt(r[1],10)),void this.trigger("data",a);if(r=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(t))return a={type:"tag",tagType:"playlist-type"},r[1]&&(a.playlistType=r[1]),void this.trigger("data",a);if(r=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(t))return a={type:"tag",tagType:"byterange"},r[1]&&(a.length=parseInt(r[1],10)),r[2]&&(a.offset=parseInt(r[2],10)),void this.trigger("data",a);if(r=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(t))return a={type:"tag",tagType:"allow-cache"},r[1]&&(a.allowed=!/NO/.test(r[1])),void this.trigger("data",a);if(r=/^#EXT-X-MAP:?(.*)$/.exec(t)){var s,n,u,o,a={type:"tag",tagType:"map"};return r[1]&&((s=parseAttributes(r[1])).URI&&(a.uri=s.URI),s.BYTERANGE&&(u=(n=s.BYTERANGE.split("@"))[0],o=n[1],a.byterange={},u&&(a.byterange.length=parseInt(u,10)),o&&(a.byterange.offset=parseInt(o,10)))),void this.trigger("data",a)}if(r=/^#EXT-X-STREAM-INF:?(.*)$/.exec(t))return a={type:"tag",tagType:"stream-inf"},r[1]&&(a.attributes=parseAttributes(r[1]),a.attributes.RESOLUTION&&(i={},(e=a.attributes.RESOLUTION.split("x"))[0]&&(i.width=parseInt(e[0],10)),e[1]&&(i.height=parseInt(e[1],10)),a.attributes.RESOLUTION=i),a.attributes.BANDWIDTH&&(a.attributes.BANDWIDTH=parseInt(a.attributes.BANDWIDTH,10)),a.attributes["PROGRAM-ID"]&&(a.attributes["PROGRAM-ID"]=parseInt(a.attributes["PROGRAM-ID"],10))),void this.trigger("data",a);if(r=/^#EXT-X-MEDIA:?(.*)$/.exec(t))return a={type:"tag",tagType:"media"},r[1]&&(a.attributes=parseAttributes(r[1])),void this.trigger("data",a);if(r=/^#EXT-X-ENDLIST/.exec(t))this.trigger("data",{type:"tag",tagType:"endlist"});else if(r=/^#EXT-X-DISCONTINUITY/.exec(t))this.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(r=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(t))return a={type:"tag",tagType:"program-date-time"},r[1]&&(a.dateTimeString=r[1],a.dateTimeObject=new Date(r[1])),void this.trigger("data",a);if(r=/^#EXT-X-KEY:?(.*)$/.exec(t))return a={type:"tag",tagType:"key"},r[1]&&(a.attributes=parseAttributes(r[1]),a.attributes.IV&&("0x"===a.attributes.IV.substring(0,2).toLowerCase()&&(a.attributes.IV=a.attributes.IV.substring(2)),a.attributes.IV=a.attributes.IV.match(/.{8}/g),a.attributes.IV[0]=parseInt(a.attributes.IV[0],16),a.attributes.IV[1]=parseInt(a.attributes.IV[1],16),a.attributes.IV[2]=parseInt(a.attributes.IV[2],16),a.attributes.IV[3]=parseInt(a.attributes.IV[3],16),a.attributes.IV=new Uint32Array(a.attributes.IV))),void this.trigger("data",a);if(r=/^#EXT-X-START:?(.*)$/.exec(t))return a={type:"tag",tagType:"start"},r[1]&&(a.attributes=parseAttributes(r[1]),a.attributes["TIME-OFFSET"]=parseFloat(a.attributes["TIME-OFFSET"]),a.attributes.PRECISE=/YES/.test(a.attributes.PRECISE)),void this.trigger("data",a);if(r=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(t))return a={type:"tag",tagType:"cue-out-cont"},r[1]?a.data=r[1]:a.data="",void this.trigger("data",a);if(r=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(t))return a={type:"tag",tagType:"cue-out"},r[1]?a.data=r[1]:a.data="",void this.trigger("data",a);if(r=/^#EXT-X-CUE-IN:?(.*)?$/.exec(t))return a={type:"tag",tagType:"cue-in"},r[1]?a.data=r[1]:a.data="",void this.trigger("data",a);this.trigger("data",{type:"tag",data:t.slice(4)})}}else this.trigger("data",{type:"comment",text:t.slice(1)});else this.trigger("data",{type:"uri",uri:t})},e}(Stream),Parser=function(e){function i(){classCallCheck(this,i);var t=possibleConstructorReturn(this,e.call(this));t.lineStream=new LineStream,t.parseStream=new ParseStream,t.lineStream.pipe(t.parseStream);var a=t,s=[],n={},u=void 0,o=void 0,g={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},c=0;return t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]},t.parseStream.on("data",function(e){var i=void 0,r=void 0;({tag:function(){({"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&((n.byterange=t).length=e.length,"offset"in e||(this.trigger("info",{message:"defaulting offset to zero"}),e.offset=0)),"offset"in e&&((n.byterange=t).offset=e.offset)},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),0<e.duration&&(n.duration=e.duration),0===e.duration&&(n.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=s},key:function(){e.attributes?"NONE"!==e.attributes.METHOD?e.attributes.URI?(e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),o={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(o.iv=e.attributes.IV)):this.trigger("warn",{message:"ignoring key declaration without URI"}):o=null:this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,c=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){u={},e.uri&&(u.uri=e.uri),e.byterange&&(u.byterange=e.byterange)},"stream-inf":function(){this.manifest.playlists=s,this.manifest.mediaGroups=this.manifest.mediaGroups||g,e.attributes?(n.attributes||(n.attributes={}),_extends(n.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){var t;this.manifest.mediaGroups=this.manifest.mediaGroups||g,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME?((t=this.manifest.mediaGroups[e.attributes.TYPE])[e.attributes["GROUP-ID"]]=t[e.attributes["GROUP-ID"]]||{},i=t[e.attributes["GROUP-ID"]],(r={default:/yes/i.test(e.attributes.DEFAULT)}).default?r.autoselect=!0:r.autoselect=/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(r.language=e.attributes.LANGUAGE),e.attributes.URI&&(r.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(r.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(r.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(r.forced=/yes/i.test(e.attributes.FORCED)),i[e.attributes.NAME]=r):this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){c+=1,n.discontinuity=!0,this.manifest.discontinuityStarts.push(s.length)},"program-date-time":function(){this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):this.manifest.targetDuration=e.duration},totalduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid total duration: "+e.duration}):this.manifest.totalDuration=e.duration},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){n.cueOut=e.data},"cue-out-cont":function(){n.cueOutCont=e.data},"cue-in":function(){n.cueIn=e.data}}[e.tagType]||function(){}).call(a)},uri:function(){n.uri=e.uri,s.push(n),!this.manifest.targetDuration||"duration"in n||(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),n.duration=this.manifest.targetDuration),o&&(n.key=o),n.timeline=c,u&&(n.map=u),n={}},comment:function(){}})[e.type].call(a)}),t}return inherits(i,e),i.prototype.push=function(t){this.lineStream.push(t)},i.prototype.end=function(){this.lineStream.push("\n")},i}(Stream);exports.LineStream=LineStream,exports.ParseStream=ParseStream,exports.Parser=Parser;