!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).cellx={})}(this,function(t){"use strict";const e=(()=>{const t=Function("return this;")();if(t.process&&"[object process]"==t.process.toString()&&t.process.nextTick)return t.process.nextTick;if(t.setImmediate&&-1!=t.setImmediate.toString().indexOf("[native code]")){const e=t.setImmediate;return t=>{e(t)}}const e=Promise.resolve();return t=>{e.then(t)}})(),i={logError:(...t)=>{console.error(...t)}};function s(...t){i.logError(...t)}const r=Object.prototype.hasOwnProperty;let n=!1,o=0,h=[],l=0;class a{constructor(){this._events=new Map}static get currentlySubscribing(){return n}static transact(t){o++;try{t()}catch(t){s(t)}if(--o)return;let e=h;h=[];for(let t of e)t.target.handleEvent(t)}static silently(t){l++;try{t()}catch(t){s(t)}l--}getEvents(t){if(t){let e=this._events.get(t);return e?Array.isArray(e)?e:[e]:[]}let e=new Map;for(let[t,i]of this._events)e.set(t,Array.isArray(i)?i:[i]);return e}on(t,e,i){if("object"==typeof t){i=void 0!==e?e:this;let s=t;for(t in s)r.call(s,t)&&this._on(t,s[t],i);for(let t of Object.getOwnPropertySymbols(s))this._on(t,s[t],i)}else this._on(t,e,void 0!==i?i:this);return this}off(t,e,i){if(t)if("object"==typeof t){i=void 0!==e?e:this;let s=t;for(t in s)r.call(s,t)&&this._off(t,s[t],i);for(let t of Object.getOwnPropertySymbols(s))this._off(t,s[t],i)}else this._off(t,e,void 0!==i?i:this);else this._events.clear();return this}_on(t,e,i){let s;if("string"==typeof t&&-1!=(s=t.indexOf(":"))){let r=t.slice(s+1);n=!0,((this[O]||(this[O]=new Map)).get(r)||(this[r],this[O]).get(r)).on(t.slice(0,s),e,i),n=!1}else{let s=this._events.get(t),r={listener:e,context:i};s?Array.isArray(s)?s.push(r):this._events.set(t,[s,r]):this._events.set(t,r)}}_off(t,e,i){let s;if("string"==typeof t&&-1!=(s=t.indexOf(":"))){let r=this[O]&&this[O].get(t.slice(s+1));r&&r.off(t.slice(0,s),e,i)}else{let s,r=this._events.get(t);if(!r)return;if(Array.isArray(r)){if(1!=r.length){for(let t=r.length;t;)if((s=r[--t]).listener==e&&s.context===i){r.splice(t,1);break}return}s=r[0]}else s=r;s.listener==e&&s.context===i&&this._events.delete(t)}}once(t,e,i){function s(r){return this._off(t,s,i),e.call(this,r)}return void 0===i&&(i=this),this._on(t,s,i),s}emit(t,e){if("object"==typeof t)if(t.target){if(t.target!=this)throw TypeError("Event cannot be emitted on this target")}else t.target=this;else t={target:this,type:t};if(e&&(t.data=e),!l)if(o)for(let e=h.length;;){if(!e){(t.data||(t.data={})).prevEvent=null,h.push(t);break}let i=h[--e];if(i.target==this&&i.type===t.type){(t.data||(t.data={})).prevEvent=i,h[e]=t;break}}else this.handleEvent(t);return t}handleEvent(t){let e=this._events.get(t.type);if(e)if(Array.isArray(e))if(1==e.length)!1===this._tryEventListener(e[0],t)&&(t.propagationStopped=!0);else{e=e.slice();for(let i=0;i<e.length;i++)!1===this._tryEventListener(e[i],t)&&(t.propagationStopped=!0)}else!1===this._tryEventListener(e,t)&&(t.propagationStopped=!0)}_tryEventListener(t,e){try{return t.listener.call(t.context,e)}catch(t){s(t)}}}class c extends Error{}const u=Symbol("listenerWrappers");function _(t,e){t.push(e)}const f=[];let d,p=0,E=null;const g={error:null};let v=0;function m(){for(;p<f.length;){let t=f[p++];t._active&&t.actualize()}if(f.length=0,p=0,d){let t=d;d=null;for(let e of t)e()}}let b=(()=>{class t extends a{constructor(e,i){super(),this._reactions=[],this._error=null,this._lastErrorEvent=null,this._hasSubscribers=!1,this._active=!1,this._currentlyPulling=!1,this._updationId=-1,this.debugKey=i&&i.debugKey,this.context=i&&void 0!==i.context?i.context:this,this._pull=i&&i.pull||("function"==typeof e?e:null),this._get=i&&i.get||null,this._validate=i&&i.validate||null,this._merge=i&&i.merge||null,this._put=i&&i.put||_,this._reap=i&&i.reap||null,this.meta=i&&i.meta||null,this._pull?(this._dependencies=void 0,this._value=void 0,this._state="dirty",this._inited=!1):(this._dependencies=null,i&&void 0!==i.value&&(e=i.value),this._validate&&this._validate(e,void 0),this._merge&&(e=this._merge(e,void 0)),this._value=e,this._state="actual",this._inited=!0,e instanceof a&&e.on("change",this._onValueChange,this)),i&&(i.onChange&&this.on("change",i.onChange),i.onError&&this.on(t.EVENT_ERROR,i.onError))}static get currentlyPulling(){return!!E}static autorun(e,i){let s;return new t(function(t,i){return s||(s=(()=>{t.dispose()})),e.call(this,i,s)},i&&i.onChange?i:Object.assign(Object.assign({},i),{onChange(){}})),s}static release(){m()}static afterRelease(t){(d||(d=[])).push(t)}on(t,e,i){return null!==this._dependencies&&this.actualize(),"object"==typeof t?super.on(t,void 0!==e?e:this.context):super.on(t,e,void 0!==i?i:this.context),this._hasSubscribers=!0,this._activate(!0),this}off(e,i,s){return null!==this._dependencies&&this.actualize(),e?"object"==typeof e?super.off(e,void 0!==i?i:this.context):super.off(e,i,void 0!==s?s:this.context):super.off(),!this._hasSubscribers||this._reactions.length||this._events.has(t.EVENT_CHANGE)||this._events.has(t.EVENT_ERROR)||(this._hasSubscribers=!1,this._deactivate(),this._reap&&this._reap.call(this.context)),this}onChange(e,i){return this.on(t.EVENT_CHANGE,e,void 0!==i?i:this.context)}offChange(e,i){return this.off(t.EVENT_CHANGE,e,void 0!==i?i:this.context)}onError(e,i){return this.on(t.EVENT_ERROR,e,void 0!==i?i:this.context)}offError(e,i){return this.off(t.EVENT_ERROR,e,void 0!==i?i:this.context)}subscribe(e,i){let s=e[u]||(e[u]=new Map);if(s.has(this))return this;function r(t){return e.call(this,t.data.error||null,t)}return s.set(this,r),void 0===i&&(i=this.context),this.on(t.EVENT_CHANGE,r,i).on(t.EVENT_ERROR,r,i)}unsubscribe(e,i){let s=e[u],r=s&&s.get(this);return r?(s.delete(this),void 0===i&&(i=this.context),this.off(t.EVENT_CHANGE,r,i).off(t.EVENT_ERROR,r,i)):this}_addReaction(t,e){this._reactions.push(t),this._hasSubscribers=!0,this._activate(e)}_deleteReaction(e){this._reactions.splice(this._reactions.indexOf(e),1),!this._hasSubscribers||this._reactions.length||this._events.has(t.EVENT_CHANGE)||this._events.has(t.EVENT_ERROR)||(this._hasSubscribers=!1,this._deactivate(),this._reap&&this._reap.call(this.context))}_activate(t){if(this._active||!this._pull)return;let e=this._dependencies;if(e){let i=e.length;do{e[--i]._addReaction(this,t)}while(i);t&&(this._state="actual"),this._active=!0}}_deactivate(){if(!this._active)return;let t=this._dependencies,e=t.length;do{t[--e]._deleteReaction(this)}while(e);this._state="dirty",this._active=!1}_onValueChange(t){this._inited=!0,this._updationId=++v;let e=this._reactions;for(let t=0;t<e.length;t++)e[t]._addToRelease(!0);this.handleEvent(t)}_addToRelease(t){this._state=t?"dirty":"check";let i=this._reactions,s=i.length;if(s)do{"actual"==i[--s]._state&&i[s]._addToRelease(!1)}while(s);else 1==f.push(this)&&e(m)}actualize(){if("dirty"==this._state)this.pull();else if("check"==this._state){let t=this._dependencies;for(let e=0;;){if(t[e].actualize(),"dirty"==this._state){this.pull();break}if(++e==t.length){this._state="actual";break}}}}get value(){return this.get()}set value(t){this.set(t)}get(){if("actual"!=this._state&&this._updationId!=v&&this.actualize(),E&&(E._dependencies?-1==E._dependencies.indexOf(this)&&E._dependencies.push(this):E._dependencies=[this],this._error&&this._error instanceof c))throw this._error;return this._get?this._get(this._value):this._value}pull(){if(!this._pull)return!1;if(this._currentlyPulling)throw TypeError("Circular pulling detected");this._currentlyPulling=!0;let t=this._dependencies;this._dependencies=null;let e,i=E;E=this;try{e=this._pull.length?this._pull.call(this.context,this,this._value):this._pull.call(this.context)}catch(t){g.error=t,e=g}if(E=i,this._currentlyPulling=!1,this._hasSubscribers){let e=this._dependencies,i=0;if(e){let s=e.length;do{let r=e[--s];t&&-1!=t.indexOf(r)||(r._addReaction(this,!1),i++)}while(s)}if(t&&(!e||e.length-i<t.length))for(let i=t.length;i;)i--,e&&-1!=e.indexOf(t[i])||t[i]._deleteReaction(this);e?this._active=!0:(this._state="actual",this._active=!1)}else this._state=this._dependencies?"dirty":"actual";return e===g?this.fail(g.error):this.push(e)}set(t){return this._inited||this.pull(),this._validate&&this._validate(t,this._value),this._merge&&(t=this._merge(t,this._value)),this._put.length>=3?this._put.call(this.context,this,t,this._value):this._put.call(this.context,this,t),this}push(e){this._inited=!0,this._error&&this._setError(null);let i=this._value,s=!Object.is(e,i);if(s&&(this._value=e,i instanceof a&&i.off("change",this._onValueChange,this),e instanceof a&&e.on("change",this._onValueChange,this)),this._active&&(this._state="actual"),this._updationId=++v,s){let s=this._reactions;for(let t=0;t<s.length;t++)s[t]._addToRelease(!0);this.emit(t.EVENT_CHANGE,{prevValue:i,value:e})}return s}fail(t){this._inited=!0;let e=t instanceof c;return e||(this.debugKey?s("["+this.debugKey+"]",t):s(t),t instanceof Error||(t=new Error(String(t)))),this._setError(t),this._active&&(this._state="actual"),e}_setError(e){this._error=e,this._updationId=++v,e&&this._handleErrorEvent({target:this,type:t.EVENT_ERROR,data:{error:e}})}_handleErrorEvent(t){if(this._lastErrorEvent===t)return;this._lastErrorEvent=t,this.handleEvent(t);let e=this._reactions;for(let i=0;i<e.length;i++)e[i]._handleErrorEvent(t)}wait(){throw new c}reap(){this.off();let t=this._reactions;for(let e=0;e<t.length;e++)t[e].reap();return this}dispose(){return this.reap()}}return t.EVENT_CHANGE="change",t.EVENT_ERROR="error",t})();const y=Object.prototype.hasOwnProperty;let N=(()=>{class t extends a{constructor(e){if(super(),this._entries=new Map,e){let i=this._entries;if(e instanceof Map||e instanceof t)for(let[t,s]of e instanceof Map?e:e._entries)i.set(t,s);else if(Array.isArray(e))for(let t=0,s=e.length;t<s;t++)i.set(e[t][0],e[t][1]);else for(let t in e)y.call(e,t)&&i.set(t,e[t])}}get size(){return this._entries.size}onChange(e,i){return this.on(t.EVENT_CHANGE,e,i)}offChange(e,i){return this.off(t.EVENT_CHANGE,e,i)}has(t){return this._entries.has(t)}get(t){return this._entries.get(t)}set(e,i){let s,r=this._entries,n=r.has(e);return n&&(s=r.get(e),Object.is(i,s))?this:(r.set(e,i),this.emit(t.EVENT_CHANGE,{subtype:n?"update":"add",key:e,prevValue:s,value:i}),this)}delete(e){let i=this._entries;if(i.has(e)){let s=i.get(e);return i.delete(e),this.emit(t.EVENT_CHANGE,{subtype:"delete",key:e,value:s}),!0}return!1}clear(){return this._entries.size&&(this._entries.clear(),this.emit(t.EVENT_CHANGE,{subtype:"clear"})),this}equals(e){if(!(e instanceof t))return!1;if(this.size!=e.size)return!1;for(let t of this)if(t[1]!==e.get(t[0]))return!1;return!0}forEach(t,e){for(let[i,s]of this._entries)t.call(e,s,i,this)}keys(){return this._entries.keys()}values(){return this._entries.values()}entries(){return this._entries.entries()}clone(t=!1){let e;if(t){e=[];for(let[t,i]of this._entries)e.push([t,i&&"object"==typeof i&&i.clone?i.clone.length?i.clone(!0):i.clone():i])}return new this.constructor(e||this)}absorbFrom(e){if(!(e instanceof t))throw TypeError('"that" must be instance of ObservableMap');let i=this._entries,s=!1;for(let[t,r]of i)if(e.has(t)){let n=e.get(t);r!==n&&(r&&n&&"object"==typeof r&&"object"==typeof n&&r.absorbFrom&&r.absorbFrom===n.absorbFrom?r.absorbFrom(n)&&(s=!0):(i.set(t,n),s=!0))}else i.delete(t),s=!0;for(let[t,r]of e)i.has(t)||(i.set(t,r),s=!0);return s&&this.emit(t.EVENT_CHANGE,{subtype:"absorbFrom"}),s}toData(){let t={};for(let[e,i]of this._entries)t[e]=i&&"object"==typeof i&&i.toData?i.toData():i;return t}}return t.EVENT_CHANGE="change",t})();N.prototype[Symbol.iterator]=N.prototype.entries;const x=Array.prototype.push,C=Array.prototype.splice,T=(t,e)=>t<e?-1:t>e?1:0;let V=(()=>{class t extends a{constructor(e,i){if(super(),this._items=[],i&&(i.sorted||i.comparator&&!1!==i.sorted)?(this._comparator=i.comparator||T,this._sorted=!0):(this._comparator=null,this._sorted=!1),e)if(this._sorted){e instanceof t&&(e=e._items);for(let t=0,i=e.length;t<i;t++)this._insertSortedValue(e[t])}else x.apply(this._items,e instanceof t?e._items:e)}get length(){return this._items.length}set length(e){if(this._items.length!=e){if(e>this._items.length)throw RangeError("Length out of valid range");this.emit(t.EVENT_CHANGE),this._items.length=e}}onChange(e,i){return this.on(t.EVENT_CHANGE,e,i)}offChange(e,i){return this.off(t.EVENT_CHANGE,e,i)}_validateIndex(t,e=!1){if(void 0===t)return t;if(t<0){if((t+=this._items.length)<0)throw RangeError("Index out of valid range")}else if(t>this._items.length-(e?0:1))throw RangeError("Index out of valid range");return t}contains(t){return-1!=this._items.indexOf(t)}indexOf(t,e){return this._items.indexOf(t,this._validateIndex(e,!0))}lastIndexOf(t,e){return this._items.lastIndexOf(t,void 0===e?-1:this._validateIndex(e,!0))}get(t){return this._items[this._validateIndex(t,!0)]}getRange(t,e){if(t=this._validateIndex(t,!0),void 0===e)return this._items.slice(t);if(t+e>this._items.length)throw RangeError('Sum of "index" and "count" out of valid range');return this._items.slice(t,t+e)}set(e,i){if(this._sorted)throw TypeError("Cannot set to sorted list");return e=this._validateIndex(e,!0),Object.is(i,this._items[e])||(this._items[e]=i,this.emit(t.EVENT_CHANGE)),this}setRange(e,i){if(this._sorted)throw TypeError("Cannot set to sorted list");e=this._validateIndex(e,!0),i instanceof t&&(i=i._items);let s=i.length;if(!s)return this;let r=this._items;if(e+s>r.length)throw RangeError('Sum of "index" and "values.length" out of valid range');let n=!1;for(let t=e+s;t>e;){let s=i[--t-e];Object.is(s,r[t])||(r[t]=s,n=!0)}return n&&this.emit(t.EVENT_CHANGE),this}add(e,i=!1){return i&&-1!=this._items.indexOf(e)?this:(this._sorted?this._insertSortedValue(e):this._items.push(e),this.emit(t.EVENT_CHANGE),this)}addRange(e,i=!1){if(e instanceof t&&(e=e._items),e.length)if(i){let i=this._items,s=this._sorted,r=!1;for(let t of e)-1==i.indexOf(t)&&(s?this._insertSortedValue(t):i.push(t),r=!0);r&&this.emit(t.EVENT_CHANGE)}else{if(this._sorted)for(let t=0,i=e.length;t<i;t++)this._insertSortedValue(e[t]);else x.apply(this._items,e);this.emit(t.EVENT_CHANGE)}return this}insert(e,i){if(this._sorted)throw TypeError("Cannot insert to sorted list");return this._items.splice(this._validateIndex(e,!0),0,i),this.emit(t.EVENT_CHANGE),this}insertRange(e,i){if(this._sorted)throw TypeError("Cannot insert to sorted list");return e=this._validateIndex(e,!0),i instanceof t&&(i=i._items),i.length&&(C.apply(this._items,[e,0].concat(i)),this.emit(t.EVENT_CHANGE)),this}remove(e,i){let s=this._items.indexOf(e,this._validateIndex(i,!0));return-1!=s&&(this._items.splice(s,1),this.emit(t.EVENT_CHANGE),!0)}removeAll(e,i){let s=this._validateIndex(i,!0),r=this._items,n=!1;for(;-1!=(s=r.indexOf(e,s));)r.splice(s,1),n=!0;return n&&this.emit(t.EVENT_CHANGE),n}removeEach(e,i){i=this._validateIndex(i,!0),e instanceof t&&(e=e._items.slice());let s=this._items,r=!1;for(let t=0,n=e.length;t<n;t++){let n=s.indexOf(e[t],i);-1!=n&&(s.splice(n,1),r=!0)}return r&&this.emit(t.EVENT_CHANGE),r}removeAt(e){let i=this._items.splice(this._validateIndex(e),1)[0];return this.emit(t.EVENT_CHANGE),i}removeRange(e,i){if(e=this._validateIndex(e,!0),void 0===i){if(!(i=this._items.length-e))return[]}else{if(!i)return[];if(e+i>this._items.length)throw RangeError('Sum of "index" and "count" out of valid range')}let s=this._items.splice(e,i);return this.emit(t.EVENT_CHANGE),s}replace(e,i){if(this._sorted)throw TypeError("Cannot replace in sorted list");let s=this._items.indexOf(e);return-1!=s&&(this._items[s]=i,this.emit(t.EVENT_CHANGE),!0)}clear(){return this._items.length&&(this._items.length=0,this.emit(t.EVENT_CHANGE)),this}equals(e){if(!(e instanceof t))return!1;let i=this._items,s=e._items;if(i.length!=s.length)return!1;for(let t=i.length;t;)if(i[--t]!==s[t])return!1;return!0}join(t){return this._items.join(t)}find(t,e){let i=this._items;for(let s=0,r=i.length;s<r;s++){let r=i[s];if(t.call(e,r,s,this))return r}}findIndex(t,e){let i=this._items;for(let s=0,r=i.length;s<r;s++)if(t.call(e,i[s],s,this))return s;return-1}clone(t=!1){return new this.constructor(t?this._items.map(t=>t&&"object"==typeof t&&t.clone?t.clone.length?t.clone(!0):t.clone():t):this,{comparator:this._comparator||void 0,sorted:this._sorted})}absorbFrom(e){if(!(e instanceof t))throw TypeError('"that" must be instance of ObservableList');let i=this._items,s=e._items,r=!1;i.length!=e.length&&(i.length=e.length,r=!0);for(let t=i.length;t;){let e=i[--t],n=s[t];e!==n&&(e&&n&&"object"==typeof e&&"object"==typeof n&&e.absorbFrom&&e.absorbFrom===n.absorbFrom?e.absorbFrom(n)&&(r=!0):(i[t]=n,r=!0))}return r&&this.emit(t.EVENT_CHANGE),r}toArray(){return this._items.slice()}toString(){return this._items.join()}toData(){return this._items.map(t=>t&&"object"==typeof t&&t.toData?t.toData():t)}_insertSortedValue(t){let e=this._items,i=this._comparator,s=0,r=e.length;for(;s!=r;){let n=s+r>>1;i(t,e[n])<0?r=n:s=n+1}e.splice(s,0,t)}}return t.EVENT_CHANGE="change",t})();["forEach","map","filter","every","some"].forEach(t=>{V.prototype[t]=function(e,i){return this._items[t]((t,s)=>e.call(i,t,s,this))}}),["reduce","reduceRight"].forEach(t=>{V.prototype[t]=function(e,i){let s=(t,i,s)=>e(t,i,s,this);return arguments.length>=2?this._items[t](s,i):this._items[t](s)}}),[["keys",t=>t],["values",(t,e)=>e],["entries",(t,e)=>[t,e]]].forEach(t=>{let e=t[1];V.prototype[t[0]]=function(){let t=this._items,i=0,s=!1;return{next(){if(!s){if(i<t.length)return{value:e(i,t[i++]),done:!1};s=!0}return{value:void 0,done:!0}}}}}),V.prototype[Symbol.iterator]=V.prototype.values;const O=Symbol("valueCells"),A={__proto__:Function.prototype,cell:null,on(t,e,i){return this.cell.on(t,e,i)},off(t,e,i){return this.cell.off(t,e,i)},onChange(t,e){return this.cell.onChange(t,e)},offChange(t,e){return this.cell.offChange(t,e)},onError(t,e){return this.cell.onError(t,e)},offError(t,e){return this.cell.offError(t,e)},subscribe(t,e){return this.cell.subscribe(t,e)},unsubscribe(t,e){return this.cell.unsubscribe(t,e)},get value(){return this.cell.value},set value(t){this.cell.value=t},pull(){return this.cell.pull()},reap(){return this.cell.reap()},dispose(){return this.cell.dispose()}};function R(t,e,i){return(t[O]||(t[O]=new Map)).set(e,i instanceof b?i:new b(i,{context:t})),Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get(){return this[O].get(e).get()},set(t){this[O].get(e).set(t)}}),t}function w(t,e){return Object.keys(e).forEach(i=>{R(t,i,e[i])}),t}t.Cell=b,t.EventEmitter=a,t.KEY_VALUE_CELLS=O,t.ObservableList=V,t.ObservableMap=N,t.WaitError=c,t.cellx=function t(e,i){let s=function(t){return arguments.length?(s.cell.set(t),t):s.cell.get()};return Object.setPrototypeOf(s,A),s.constructor=t,s.cell=new b(e,i),s},t.configure=function(t){return Object.assign(i,t),i},t.define=function(t,e,i){return"object"==typeof e?w(t,e):R(t,e,i),t},t.defineObservableProperties=w,t.defineObservableProperty=R,Object.defineProperty(t,"__esModule",{value:!0})});