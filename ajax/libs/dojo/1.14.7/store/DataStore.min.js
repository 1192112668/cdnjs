define(["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(i,t,s,u,a,e){return t("dojo.store.DataStore",null,{target:"",constructor:function(t){if(i.mixin(this,t),!("idProperty"in t)){var e;try{e=this.store.getIdentityAttributes()}catch(t){}this.idProperty=(i.isArray(e)?e[0]:e)||this.idProperty}var r=this.store.getFeatures();r["dojo.data.api.Read"]||(this.get=null),r["dojo.data.api.Identity"]||(this.getIdentity=null),r["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:e,_objectConverter:function(e){var c=this.store,l=this.idProperty;return function(t){return e(t&&function t(e){for(var r={},n=c.getAttributes(e),o=0;o<n.length;o++){var i=n[o],u=c.getValues(e,i);if(1<u.length){for(var s,a=0;a<u.length;a++)"object"==typeof(s=u[a])&&c.isItem(s)&&(u[a]=t(s));s=u}else"object"==typeof(s=c.getValue(e,i))&&c.isItem(s)&&(s=t(s));r[n[o]]=s}return l in r||!c.getIdentity||(r[l]=c.getIdentity(e)),r}(t))}},get:function(t,e){var r,n,o=new s;if(this.store.fetchItemByIdentity({identity:t,onItem:this._objectConverter(function(t){o.resolve(r=t)}),onError:function(t){o.reject(n=t)}}),void 0!==r)return null==r?void 0:r;if(n)throw n;return o.promise},put:function(r,n){var t,e=void 0!==(n=n||{}).id?n.id:this.getIdentity(r),o=this.store,i=this.idProperty,u=new s;return void 0===e?(t=o.newItem(r),o.save({onComplete:function(){u.resolve(t)},onError:function(t){u.reject(t)}})):o.fetchItemByIdentity({identity:e,onItem:function(t){if(t){if(!1===n.overwrite)return u.reject(new Error("Overwriting existing object not allowed"));for(var e in r)e!=i&&r.hasOwnProperty(e)&&o.getValue(t,e)!=r[e]&&o.setValue(t,e,r[e])}else{if(!0===n.overwrite)return u.reject(new Error("Creating new object not allowed"));t=o.newItem(r)}o.save({onComplete:function(){u.resolve(t)},onError:function(t){u.reject(t)}})},onError:function(t){u.reject(t)}}),u.promise},add:function(t,e){return(e=e||{}).overwrite=!1,this.put(t,e)},remove:function(t){var e=this.store,r=new s;return this.store.fetchItemByIdentity({identity:t,onItem:function(t){try{null==t?r.resolve(!1):(e.deleteItem(t),e.save(),r.resolve(!0))}catch(t){r.reject(t)}},onError:function(t){r.reject(t)}}),r.promise},query:function(t,e){var r=new s(function(){o.abort&&o.abort()});r.total=new s;var n=this._objectConverter(function(t){return t}),o=this.store.fetch(i.mixin({query:t,onBegin:function(t){r.total.resolve(t)},onComplete:function(t){r.resolve(u.map(t,n))},onError:function(t){r.reject(t)}},e));return a(r)},getIdentity:function(t){return t[this.idProperty]}})});