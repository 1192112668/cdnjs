define(["dojo/_base/declare","dojo/hash","dojo/topic"],function(e,n,a){var i;function l(e,t,r){var n,a,i=this.callbackQueue,s=!1,o=!1,h=[{stopImmediatePropagation:function(){s=!0},preventDefault:function(){o=!0},oldPath:t,newPath:r,params:e}];if(e instanceof Array)h=h.concat(e);else for(var u in e)h.push(e[u]);for(n=0,a=i.length;n<a;++n)s||i[n].apply(null,h);return!o}return i=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},e(null,{_routes:null,_routeIndex:null,_started:!1,_currentPath:"",idMatch:/:(\w[\w\d]*)/g,idReplacement:"([^\\/]+)",globMatch:/\*(\w[\w\d]*)/,globReplacement:"(.+)",constructor:function(e){for(var t in this._routes=[],this._routeIndex={},e)e.hasOwnProperty(t)&&(this[t]=e[t])},register:function(e,t){return this._registerRoute(e,t)},registerBefore:function(e,t){return this._registerRoute(e,t,!0)},go:function(e,t){var r;return"string"==typeof e&&(e=i(e),(r=this._handlePathChange(e))&&n(e,t),r)},startup:function(e){var t,r;this._started||(t=this,r=n(),this._started=!0,this._hashchangeHandle=a.subscribe("/dojo/hashchange",function(){t._handlePathChange.apply(t,arguments)}),r?this._handlePathChange(r):this.go(e,!0))},destroy:function(){this._hashchangeHandle&&this._hashchangeHandle.remove(),this._routes=null,this._routeIndex=null},_handlePathChange:function(e){var t,r,n,a,i,s,o,h,u,c=this._routes,l=this._currentPath;if(!this._started||e===l)return o;for(o=!0,t=0,n=c.length;t<n;++t)if(s=(i=c[t]).route.exec(e)){if(i.parameterNames)for(u={},r=0,a=(h=i.parameterNames).length;r<a;++r)u[h[r]]=s[r+1];else u=s.slice(1);o=i.fire(u,l,e)}return o&&(this._currentPath=e),o},_convertRouteToRegExp:function(e){return e="^"+(e=(e=e.replace(this.idMatch,this.idReplacement)).replace(this.globMatch,this.globReplacement))+"$",new RegExp(e)},_getParameterNames:function(e){var t,r=this.idMatch,n=this.globMatch,a=[];for(r.lastIndex=0;null!==(t=r.exec(e));)a.push(t[1]);return null!==(t=n.exec(e))&&a.push(t[1]),0<a.length?a:null},_indexRoutes:function(){for(var e=this._routes,t=this._routeIndex={},r=0,n=e.length;r<n;++r)t[e[r].route]=r},_registerRoute:function(r,n,e){var t,a,i,s=this,o=this._routes,h=this._routeIndex,u=this._routeIndex[r],c=void 0!==u;return c&&(t=o[u]),a=(t=t||{route:r,callbackQueue:[],fire:l}).callbackQueue,"string"==typeof r&&(t.parameterNames=this._getParameterNames(r),t.route=this._convertRouteToRegExp(r)),e?a.unshift(n):a.push(n),c||(u=o.length,h[r]=u,o.push(t)),i=!1,{remove:function(){var e,t;if(!i){for(e=0,t=a.length;e<t;++e)a[e]===n&&a.splice(e,1);0===a.length&&(o.splice(u,1),s._indexRoutes()),i=!0}},register:function(e,t){return s.register(r,e,t)}}}})});