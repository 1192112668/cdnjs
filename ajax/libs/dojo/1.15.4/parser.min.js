define(["require","./_base/kernel","./_base/lang","./_base/array","./_base/config","./dom","./_base/window","./_base/url","./aspect","./promise/all","./date/stamp","./Deferred","./has","./query","./on","./ready"],function(require,dojo,dlang,darray,config,dom,dwindow,_Url,aspect,all,dates,Deferred,has,query,don,ready){function myEval(text){return eval("("+text+")")}new Date("X");var extendCnt=0;function getNameMap(e){var t=e._nameCaseMap,r=e.prototype;if(!t||t._extendCnt<extendCnt){for(var n in t=e._nameCaseMap={},r)"_"!==n.charAt(0)&&(t[n.toLowerCase()]=n);t._extendCnt=extendCnt}return t}function getCtor(e,t){var r=(t=t||require)._dojoParserCtorMap||(t._dojoParserCtorMap={}),n=e.join();if(!r[n]){for(var a=[],o=0,i=e.length;o<i;o++){var s=e[o];a[a.length]=r[s]=r[s]||dlang.getObject(s)||~s.indexOf("/")&&t(s)}var c=a.shift();r[n]=a.length?c.createSubclass?c.createSubclass(a):c.extend.apply(c,a):c}return r[n]}aspect.after(dlang,"extend",function(){extendCnt++},!0);var parser={_clearCache:function(){extendCnt++,_ctorMap={}},_functionFromScript:function(e,t){var r="",n="",a=e.getAttribute(t+"args")||e.getAttribute("args"),o=e.getAttribute("with"),i=(a||"").split(/\s*,\s*/);return o&&o.length&&darray.forEach(o.split(/\s*,\s*/),function(e){r+="with("+e+"){",n+="}"}),new Function(i,r+e.innerHTML+n)},instantiate:function(e,a,t){a=a||{};var o=((t=t||{}).scope||dojo._scopeName)+"Type",r="data-"+(t.scope||dojo._scopeName)+"-",i=r+"type",s=r+"mixins",c=[];return darray.forEach(e,function(e){var t,r,n=o in a?a[o]:e.getAttribute(i)||e.getAttribute(o);n&&(r=(t=e.getAttribute(s))?[n].concat(t.split(/\s*,\s*/)):[n],c.push({node:e,types:r}))}),this._instantiate(c,a,t)},_instantiate:function(e,r,n,t){var a=darray.map(e,function(e){var t=e.ctor||getCtor(e.types,n.contextRequire);if(!t)throw new Error("Unable to resolve constructor for: '"+e.types.join()+"'");return this.construct(t,e.node,r,n,e.scripts,e.inherited)},this);function o(e){return r._started||n.noStart||darray.forEach(e,function(e){"function"!=typeof e.startup||e._started||e.startup()}),e}return t?all(a).then(o):o(a)},construct:function(e,r,t,n,a,o){var i,s,c=e&&e.prototype,d={};(n=n||{}).defaults&&dlang.mixin(d,n.defaults),o&&dlang.mixin(d,o),s=has("dom-attributes-explicit")?r.attributes:has("dom-attributes-specified-flag")?darray.filter(r.attributes,function(e){return e.specified}):(i=(/^input$|^img$/i.test(r.nodeName)?r:r.cloneNode(!1)).outerHTML.replace(/=[^\s"']+|="[^"]*"|='[^']*'/g,"").replace(/^\s*<[a-zA-Z0-9]*\s*/,"").replace(/\s*>.*$/,""),darray.map(i.split(/\s+/),function(e){var t=e.toLowerCase();return{name:e,value:"LI"==r.nodeName&&"value"==e||"enctype"==t?r.getAttribute(t):r.getAttributeNode(t).value}}));var u=n.scope||dojo._scopeName,p="data-"+u+"-",l={};"dojo"!==u&&(l[p+"props"]="data-dojo-props",l[p+"type"]="data-dojo-type",l[p+"mixins"]="data-dojo-mixins",l[u+"type"]="dojotype",l[p+"id"]="data-dojo-id");for(var f,h,g,v=0,b=[];f=s[v++];){var y=f.name,m=y.toLowerCase(),j=f.value;switch(l[m]||m){case"data-dojo-type":case"dojotype":case"data-dojo-mixins":break;case"data-dojo-props":g=j;break;case"data-dojo-id":case"jsid":h=j;break;case"data-dojo-attach-point":case"dojoattachpoint":d.dojoAttachPoint=j;break;case"data-dojo-attach-event":case"dojoattachevent":d.dojoAttachEvent=j;break;case"class":d.class=r.className;break;case"style":d.style=r.style&&r.style.cssText;break;default:if(y in c||(y=getNameMap(e)[m]||y),y in c)switch(typeof c[y]){case"string":d[y]=j;break;case"number":d[y]=j.length?Number(j):NaN;break;case"boolean":d[y]="false"!=j.toLowerCase();break;case"function":""===j||-1!=j.search(/[^\w\.]+/i)?d[y]=new Function(j):d[y]=dlang.getObject(j,!1)||new Function(j),b.push(y);break;default:var x=c[y];d[y]=x&&"length"in x?j?j.split(/\s*,\s*/):[]:x instanceof Date?""==j?new Date(""):"now"==j?new Date:dates.fromISOString(j):x instanceof _Url?dojo.baseUrl+j:myEval(j)}else d[y]=j}}for(var w=0;w<b.length;w++){var _=b[w].toLowerCase();r.removeAttribute(_),r[_]=null}if(g)try{g=myEval.call(n.propsThis,"{"+g+"}"),dlang.mixin(d,g)}catch(e){throw new Error(e.toString()+" in data-dojo-props='"+g+"'")}dlang.mixin(d,t),a=a||(e&&(e._noScript||c._noScript)?[]:query("> script[type^='dojo/']",r));var A=[],C=[],N=[],q=[];if(a)for(v=0;v<a.length;v++){var S=a[v];r.removeChild(S);var k=S.getAttribute(p+"event")||S.getAttribute("event"),D=S.getAttribute(p+"prop"),E=S.getAttribute(p+"method"),L=S.getAttribute(p+"advice"),M=S.getAttribute("type"),T=this._functionFromScript(S,p);k?"dojo/connect"==M?A.push({method:k,func:T}):"dojo/on"==M?q.push({event:k,func:T}):d[k]=T:"dojo/aspect"==M?A.push({method:E,advice:L,func:T}):"dojo/watch"==M?N.push({prop:D,func:T}):C.push(T)}var O=e.markupFactory||c.markupFactory,F=O?O(d,r,e):new e(d,r);function R(e){for(h&&dlang.setObject(h,e),v=0;v<A.length;v++)aspect[A[v].advice||"after"](e,A[v].method,dlang.hitch(e,A[v].func),!0);for(v=0;v<C.length;v++)C[v].call(e);for(v=0;v<N.length;v++)e.watch(N[v].prop,N[v].func);for(v=0;v<q.length;v++)don(e,q[v].event,q[v].func);return e}return F.then?F.then(R):R(F)},scan:function(e,n){var t=[],r=[],a={},o=(n.scope||dojo._scopeName)+"Type",i="data-"+(n.scope||dojo._scopeName)+"-",s=i+"type",c=i+"textdir",d=i+"mixins",u=e.firstChild,p=n.inherited;if(!p){function l(e,t){return e.getAttribute&&e.getAttribute(t)||e.parentNode&&l(e.parentNode,t)}for(var f in p={dir:l(e,"dir"),lang:l(e,"lang"),textDir:l(e,c)})p[f]||delete p[f]}var h,g,v={inherited:p};function b(e){if(!e.inherited){e.inherited={};var t=e.node,r=b(e.parent),n={dir:t.getAttribute("dir")||r.dir,lang:t.getAttribute("lang")||r.lang,textDir:t.getAttribute(c)||r.textDir};for(var a in n)n[a]&&(e.inherited[a]=n[a])}return e.inherited}for(;;)if(u)if(1==u.nodeType)if(h&&"script"==u.nodeName.toLowerCase())(y=u.getAttribute("type"))&&/^dojo\/\w/i.test(y)&&h.push(u),u=u.nextSibling;else if(g)u=u.nextSibling;else{var y=u.getAttribute(s)||u.getAttribute(o),m=u.firstChild;if(y||m&&(3!=m.nodeType||m.nextSibling)){var j=null;if(y){var x=u.getAttribute(d),w=x?[y].concat(x.split(/\s*,\s*/)):[y];try{j=getCtor(w,n.contextRequire)}catch(e){}j||darray.forEach(w,function(e){~e.indexOf("/")&&!a[e]&&(a[e]=!0,r[r.length]=e)});var _,A=j&&!j.prototype._noScript?[]:null;(_={types:w,ctor:j,parent:v,node:u,scripts:A}).inherited=b(_),t.push(_)}else _={node:u,scripts:h,parent:v};h=A,g=u.stopParser||j&&j.prototype.stopParser&&!n.template,v=_,u=m}else u=u.nextSibling}else u=u.nextSibling;else{if(!v||!v.node)break;u=v.node.nextSibling,g=!1,h=(v=v.parent).scripts}var C=new Deferred;return r.length?(has("dojo-debug-messages")&&console.warn("WARNING: Modules being Auto-Required: "+r.join(", ")),(n.contextRequire||require)(r,function(){C.resolve(darray.filter(t,function(e){if(!e.ctor)try{e.ctor=getCtor(e.types,n.contextRequire)}catch(e){}for(var t=e.parent;t&&!t.types;)t=t.parent;var r=e.ctor&&e.ctor.prototype;return e.instantiateChildren=!(r&&r.stopParser&&!n.template),e.instantiate=!t||t.instantiate&&t.instantiateChildren,e.instantiate}))})):C.resolve(t),C.promise},_require:function(e,t){var r=myEval("{"+e.innerHTML+"}"),n=[],a=[],o=new Deferred,i=t&&t.contextRequire||require;for(var s in r)n.push(s),a.push(r[s]);return i(a,function(){for(var e=0;e<n.length;e++)dlang.setObject(n[e],arguments[e]);o.resolve(arguments)}),o.promise},_scanAmd:function(e,t){var r=new Deferred,n=r.promise;r.resolve(!0);var a=this;return query("script[type='dojo/require']",e).forEach(function(e){n=n.then(function(){return a._require(e,t)}),e.parentNode.removeChild(e)}),n},parse:function(e,t){!e||"string"==typeof e||"nodeType"in e||(e=(t=e).rootNode);var r=e?dom.byId(e):dwindow.body(),n=(t=t||{}).template?{template:!0}:{},a=[],o=this,i=this._scanAmd(r,t).then(function(){return o.scan(r,t)}).then(function(e){return o._instantiate(e,n,t,!0)}).then(function(e){return a=a.concat(e)}).otherwise(function(e){throw console.error("dojo/parser::parse() error",e),e});return dlang.mixin(a,i),a}};return has("extend-dojo")&&(dojo.parser=parser),config.parseOnLoad&&ready(100,parser,"parse"),parser});