define(["require","./util","./handlers","../errors/RequestTimeoutError","../node!http","../node!https","../node!url","../node!stream"],function(e,p,c,u,d,h,l,t){var m=t.Stream,k={method:"GET",query:null,data:void 0,headers:{}};function o(e,t){var s=p.parseArgs(e,p.deepCreate(k,t),t&&t.data instanceof m);e=s.url,t=s.options;var r=p.deferred(s,function(e,t){t.clientRequest.abort()});e=l.parse(e);var o=s.requestOptions={hostname:e.hostname,port:e.port,socketPath:t.socketPath,method:t.method,headers:t.headers,agent:t.agent,pfx:t.pfx,key:t.key,passphrase:t.passphrase,cert:t.cert,ca:t.ca,ciphers:t.ciphers,rejectUnauthorized:!1!==t.rejectUnauthorized};e.path&&(o.path=e.path),(t.user||t.password)&&(o.auth=(t.user||"")+":"+(t.password||""));var n,a,i=s.clientRequest=("https:"===e.protocol?h:d).request(o);return t.socketOptions&&("timeout"in t.socketOptions&&i.setTimeout(t.socketOptions.timeout),"noDelay"in t.socketOptions&&i.setNoDelay(t.socketOptions.noDelay),"keepAlive"in t.socketOptions&&(n=t.socketOptions.keepAlive,i.setKeepAlive(0<=n,n||0))),i.on("socket",function(){s.hasSocket=!0,r.progress(s)}),i.on("response",function(t){s.clientResponse=t,s.status=t.statusCode,s.getHeader=function(e){return t.headers[e.toLowerCase()]||null};var o=[];t.on("data",function(e){o.push(e)}),t.on("end",function(){a&&clearTimeout(a),s.text=o.join(""),p.checkStatus(s.status)||r.reject({message:"http response code "+s.status,response:s});try{c(s),r.resolve(s)}catch(e){r.reject(e)}})}),i.on("error",r.reject),t.data?"string"==typeof t.data?i.end(t.data):t.data.pipe(i):i.end(),t.timeout&&(a=setTimeout(function(){r.cancel(new u(s))},t.timeout)),r.promise}return p.addCommonMethods(o),o});