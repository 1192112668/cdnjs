define(["../_base/kernel","../_base/lang","../_base/declare","../_base/array","../_base/xhr","../Evented","./util/filter","./util/simpleFetch","../date/stamp"],function(n,F,t,i,o,e,_,r,s){var a=t("dojo.data.ItemFileReadStore",[e],{constructor:function(t){this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._jsonFileUrl=t.url,this._ccUrl=t.url,this.url=t.url,this._jsonData=t.data,this.data=null,this._datatypeMap=t.typeMap||{},this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(t){return s.fromISOString(t)}}),this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._itemsByIdentity=null,this._storeRefPropName="_S",this._itemNumPropName="_0",this._rootItemPropName="_RI",this._reverseRefMap="_RRM",this._loadInProgress=!1,this._queuedFetches=[],void 0!==t.urlPreventCache&&(this.urlPreventCache=!!t.urlPreventCache),void 0!==t.hierarchical&&(this.hierarchical=!!t.hierarchical),t.clearOnClose&&(this.clearOnClose=!0),"failOk"in t&&(this.failOk=!!t.failOk)},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(t){if(!this.isItem(t))throw new Error(this.declaredClass+": Invalid item argument.")},_assertIsAttribute:function(t){if("string"!=typeof t)throw new Error(this.declaredClass+": Invalid attribute argument.")},getValue:function(t,e,r){var s=this.getValues(t,e);return 0<s.length?s[0]:r},getValues:function(t,e){return this._assertIsItem(t),this._assertIsAttribute(e),(t[e]||[]).slice(0)},getAttributes:function(t){this._assertIsItem(t);var e=[];for(var r in t)r!==this._storeRefPropName&&r!==this._itemNumPropName&&r!==this._rootItemPropName&&r!==this._reverseRefMap&&e.push(r);return e},hasAttribute:function(t,e){return this._assertIsItem(t),this._assertIsAttribute(e),e in t},containsValue:function(t,e,r){var s=void 0;return"string"==typeof r&&(s=_.patternToRegExp(r,!1)),this._containsValue(t,e,r,s)},_containsValue:function(t,e,r,s){return i.some(this.getValues(t,e),function(t){if(null!==t&&!F.isObject(t)&&s){if(t.toString().match(s))return!0}else if(r===t)return!0})},isItem:function(t){return!(!t||t[this._storeRefPropName]!==this||this._arrayOfAllItems[t[this._itemNumPropName]]!==t)},isItemLoaded:function(t){return this.isItem(t)},loadItem:function(t){this._assertIsItem(t.item)},getFeatures:function(){return this._features},getLabel:function(t){if(this._labelAttr&&this.isItem(t))return this.getValue(t,this._labelAttr)},getLabelAttributes:function(t){return this._labelAttr?[this._labelAttr]:null},filter:function(t,e,r){var s,i,a=[];if(t.query){var l,n=!!t.queryOptions&&t.queryOptions.ignoreCase,o={};for(i in t.query)"string"==typeof(l=t.query[i])?o[i]=_.patternToRegExp(l,n):l instanceof RegExp&&(o[i]=l);for(s=0;s<e.length;++s){var h=!0,d=e[s];if(null===d)h=!1;else for(i in t.query)l=t.query[i],this._containsValue(d,i,l,o[i])||(h=!1);h&&a.push(d)}r(a,t)}else{for(s=0;s<e.length;++s){var u=e[s];null!==u&&a.push(u)}r(a,t)}},_fetchItems:function(e,r,s){var t,i,a,l=this;if(this._loadFinished)this.filter(e,this._getItemsArray(e.queryOptions),r);else if(this._jsonFileUrl!==this._ccUrl?(n.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)this._loadInProgress?this._queuedFetches.push({args:e,filter:F.hitch(l,"filter"),findCallback:F.hitch(l,r)}):(this._loadInProgress=!0,t={url:l._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},(i=o.get(t)).addCallback(function(t){try{l._getItemsFromLoadedData(t),l._loadFinished=!0,l._loadInProgress=!1,l.filter(e,l._getItemsArray(e.queryOptions),r),l._handleQueuedFetches()}catch(t){l._loadFinished=!0,l._loadInProgress=!1,s(t,e)}}),i.addErrback(function(t){l._loadInProgress=!1,s(t,e)}),a=null,e.abort&&(a=e.abort),e.abort=function(){var t=i;t&&-1===t.fired&&(t.cancel(),t=null),a&&a.call(e)});else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,l.filter(e,this._getItemsArray(e.queryOptions),r)}catch(t){s(t,e)}else s(new Error(this.declaredClass+": No JSON source data was provided as either URL or a nested Javascript object."),e)},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var t=0;t<this._queuedFetches.length;t++){var e=this._queuedFetches[t],r=e.args,s=e.filter,i=e.findCallback;s?s(r,this._getItemsArray(r.queryOptions),i):this.fetchItemByIdentity(r)}this._queuedFetches=[]}},_getItemsArray:function(t){return t&&t.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(t){this.clearOnClose&&this._loadFinished&&!this._loadInProgress&&(""!=this._jsonFileUrl&&null!=this._jsonFileUrl||""!=this.url&&null!=this.url||null!=this.data||console.debug(this.declaredClass+": WARNING!  Data reload  information has not been provided.  Please set 'url' or 'data' to the appropriate value before the next fetch"),this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[])},_getItemsFromLoadedData:function(t){var e,r=!1,l=this;function n(t){return null!==t&&"object"==typeof t&&(!F.isArray(t)||r)&&!F.isFunction(t)&&(t.constructor==Object||F.isArray(t))&&void 0===t._reference&&void 0===t._type&&void 0===t._value&&l.hierarchical}function o(t){for(var e in l._arrayOfAllItems.push(t),t){var r=t[e];if(r)if(F.isArray(r))for(var s=r,i=0;i<s.length;++i){var a=s[i];n(a)&&o(a)}else n(r)&&o(r)}}for(this._labelAttr=t.label,this._arrayOfAllItems=[],this._arrayOfTopLevelItems=t.items,d=0;d<this._arrayOfTopLevelItems.length;++d)e=this._arrayOfTopLevelItems[d],F.isArray(e)&&(r=!0),o(e),e[this._rootItemPropName]=!0;for(var s,i,a,h={},d=0;d<this._arrayOfAllItems.length;++d)for(s in e=this._arrayOfAllItems[d]){s!==this._rootItemPropName&&(null!==(i=e[s])?F.isArray(i)||(e[s]=[i]):e[s]=[null]),h[s]=s}for(;h[this._storeRefPropName];)this._storeRefPropName+="_";for(;h[this._itemNumPropName];)this._itemNumPropName+="_";for(;h[this._reverseRefMap];)this._reverseRefMap+="_";var u=t.identifier;if(u)for(this._itemsByIdentity={},this._features["dojo.data.api.Identity"]=u,d=0;d<this._arrayOfAllItems.length;++d){var _=(a=(e=this._arrayOfAllItems[d])[u])[0];if(Object.hasOwnProperty.call(this._itemsByIdentity,_)){if(this._jsonFileUrl)throw new Error(this.declaredClass+":  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+u+"].  Value collided: ["+_+"]");if(this._jsonData)throw new Error(this.declaredClass+":  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+u+"].  Value collided: ["+_+"]")}else this._itemsByIdentity[_]=e}else this._features["dojo.data.api.Identity"]=Number;for(d=0;d<this._arrayOfAllItems.length;++d)(e=this._arrayOfAllItems[d])[this._storeRefPropName]=this,e[this._itemNumPropName]=d;for(d=0;d<this._arrayOfAllItems.length;++d)for(s in e=this._arrayOfAllItems[d]){a=e[s];for(var c=0;c<a.length;++c)if(null!==(i=a[c])&&"object"==typeof i){if("_type"in i&&"_value"in i){var f=i._type,m=this._datatypeMap[f];if(!m)throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+f+"'");if(F.isFunction(m))a[c]=new m(i._value);else{if(!F.isFunction(m.deserialize))throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");a[c]=m.deserialize(i._value)}}if(i._reference){var p,I=i._reference;if(F.isObject(I))for(var y=0;y<this._arrayOfAllItems.length;++y){var g=this._arrayOfAllItems[y],v=!0;for(var j in I)g[j]!=I[j]&&(v=!1);v&&(a[c]=g)}else a[c]=this._getItemByIdentity(I);this.referenceIntegrity&&(p=a[c],this.isItem(p)&&this._addReferenceToMap(p,e,s))}else this.isItem(i)&&this.referenceIntegrity&&this._addReferenceToMap(i,e,s)}}},_addReferenceToMap:function(t,e,r){},getIdentity:function(t){var e=this._features["dojo.data.api.Identity"];if(e===Number)return t[this._itemNumPropName];var r=t[e];return r?r[0]:null},fetchItemByIdentity:function(r){var s,t,i,e,a;this._loadFinished?(s=this._getItemByIdentity(r.identity),r.onItem&&(t=r.scope?r.scope:n.global,r.onItem.call(t,s))):((i=this)._jsonFileUrl!==this._ccUrl?(n.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&null==this._jsonData&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl?this._loadInProgress?this._queuedFetches.push({args:r}):(this._loadInProgress=!0,e={url:i._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},(a=o.get(e)).addCallback(function(t){var e=r.scope?r.scope:n.global;try{i._getItemsFromLoadedData(t),i._loadFinished=!0,i._loadInProgress=!1,s=i._getItemByIdentity(r.identity),r.onItem&&r.onItem.call(e,s),i._handleQueuedFetches()}catch(t){i._loadInProgress=!1,r.onError&&r.onError.call(e,t)}}),a.addErrback(function(t){var e;i._loadInProgress=!1,r.onError&&(e=r.scope?r.scope:n.global,r.onError.call(e,t))})):this._jsonData&&(i._getItemsFromLoadedData(i._jsonData),i._jsonData=null,i._loadFinished=!0,s=i._getItemByIdentity(r.identity),r.onItem&&(t=r.scope?r.scope:n.global,r.onItem.call(t,s))))},_getItemByIdentity:function(t){var e=null;return this._itemsByIdentity?Object.hasOwnProperty.call(this._itemsByIdentity,t)&&(e=this._itemsByIdentity[t]):Object.hasOwnProperty.call(this._arrayOfAllItems,t)&&(e=this._arrayOfAllItems[t]),void 0===e&&(e=null),e},getIdentityAttributes:function(t){var e=this._features["dojo.data.api.Identity"];return e===Number?null:[e]},_forceLoad:function(){var t,e,r=this;this._jsonFileUrl!==this._ccUrl?(n.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl?(t={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0},(e=o.get(t)).addCallback(function(t){try{if(!0===r._loadInProgress||r._loadFinished){if(r._loadInProgress)throw new Error(this.declaredClass+":  Unable to perform a synchronous load, an async load is in progress.")}else r._getItemsFromLoadedData(t),r._loadFinished=!0}catch(t){throw console.log(t),t}}),e.addErrback(function(t){throw t})):this._jsonData&&(r._getItemsFromLoadedData(r._jsonData),r._jsonData=null,r._loadFinished=!0)}});return F.extend(a,r),a});