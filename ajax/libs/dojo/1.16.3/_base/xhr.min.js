define(["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(f,n,e,p,x,y,m,i,s,b,u,r,o,a,c,t){f._xhrObj=c._create;var T=f.config;f.objectToQuery=p.objectToQuery,f.queryToObject=p.queryToObject,f.fieldToObject=y.fieldToObject,f.formToObject=y.toObject,f.formToQuery=y.toQuery,f.formToJson=y.toJson,f._blockAsync=!1;var l=f._contentHandlers=f.contentHandlers={text:function(e){return e.responseText},json:function(e){return s.fromJson(e.responseText||null)},"json-comment-filtered":function(e){i.useCommentedJson||console.warn("Consider using the standard mimetype:application/json. json-commenting can introduce security issues. To decrease the chances of hijacking, use the standard the 'json' handler and prefix your json with: {}&&\nUse djConfig.useCommentedJson=true to turn off this message.");var r=e.responseText,o=r.indexOf("/*"),t=r.lastIndexOf("*/");if(-1==o||-1==t)throw new Error("JSON was not comment filtered");return s.fromJson(r.substring(o+2,t))},javascript:function(e){return f.eval(e.responseText)},xml:function(o){var e,r,t=o.responseXML;return t&&n("dom-qsa2.1")&&!t.querySelectorAll&&n("dom-parser")&&(t=(new DOMParser).parseFromString(o.responseText,"application/xml")),n("ie")&&(t&&t.documentElement||(r=["Microsoft.XMLDOM",(e=function(e){return"MSXML"+e+".DOMDocument"})(6),e(4),e(3),e(2)],u.some(r,function(e){try{var r=new ActiveXObject(e);r.async=!1,r.loadXML(o.responseText),t=r}catch(e){return!1}return!0}))),t},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?l["json-comment-filtered"](e):l.json(e)}};f._ioSetArgs=function(r,o,e,t){var n,i,s={args:r,url:r.url},u=null;r.form&&(i=(n=x.byId(r.form)).getAttributeNode("action"),s.url=s.url||(i?i.value:f.doc?f.doc.URL:null),u=y.toObject(n));var a={};u&&b.mixin(a,u),r.content&&b.mixin(a,r.content),r.preventCache&&(a["dojo.preventCache"]=(new Date).valueOf()),s.query=p.objectToQuery(a),s.handleAs=r.handleAs||"text";var c=new m(function(e){e.canceled=!0,o&&o(e);var r=e.ioArgs.error;return r||((r=new Error("request cancelled")).dojoType="cancel",e.ioArgs.error=r),r});c.addCallback(e);var l=r.load;l&&b.isFunction(l)&&c.addCallback(function(e){return l.call(r,e,s)});var d=r.error;d&&b.isFunction(d)&&c.addErrback(function(e){return d.call(r,e,s)});var h=r.handle;return h&&b.isFunction(h)&&c.addBoth(function(e){return h.call(r,e,s)}),c.addErrback(function(e){return t(e,c)}),T.ioPublish&&f.publish&&!1!==s.args.ioPublish&&(c.addCallbacks(function(e){return f.publish("/dojo/io/load",[c,e]),e},function(e){return f.publish("/dojo/io/error",[c,e]),e}),c.addBoth(function(e){return f.publish("/dojo/io/done",[c,e]),e})),c.ioArgs=s,c};function d(e){var r=l[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===r?null:r}function h(e,r){return r.ioArgs.args.failOk||console.error(e),e}function j(e){g<=0&&(g=0,T.ioPublish&&f.publish&&(!e||e&&!1!==e.ioArgs.args.ioPublish)&&f.publish("/dojo/io/stop"))}var g=0;o.after(a,"_onAction",function(){--g}),o.after(a,"_onInFlight",j),f._ioCancelAll=a.cancelAll,f._ioNotifyStart=function(e){T.ioPublish&&f.publish&&!1!==e.ioArgs.args.ioPublish&&(g||f.publish("/dojo/io/start"),g+=1,f.publish("/dojo/io/send",[e]))},f._ioWatch=function(r,o,t,n){r.ioArgs.options=r.ioArgs.args;b.mixin(r,{response:r.ioArgs,isValid:function(e){return o(r)},isReady:function(e){return t(r)},handleResponse:function(e){return n(r)}}),a(r),j(r)};return f._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},f.xhr=function(e,r,o){var t,n=f._ioSetArgs(r,function(e){t&&t.cancel()},d,h),i=n.ioArgs;"postData"in r?i.query=r.postData:"putData"in r?i.query=r.putData:"rawBody"in r?i.query=r.rawBody:(2<arguments.length&&!o||-1==="POST|PUT".indexOf(e.toUpperCase()))&&f._ioAddQueryToUrl(i);var s={method:e,handleAs:"text",timeout:r.timeout,withCredentials:r.withCredentials,ioArgs:i};void 0!==r.headers&&(s.headers=r.headers),void 0!==r.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=r.contentType),void 0!==i.query&&(s.data=i.query),void 0!==r.sync&&(s.sync=r.sync),f._ioNotifyStart(n);try{t=c(i.url,s,!0)}catch(e){return n.cancel(),n}return n.ioArgs.xhr=t.response.xhr,t.then(function(){n.resolve(n)}).otherwise(function(e){(i.error=e).response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),n.reject(e)}),n},f.xhrGet=function(e){return f.xhr("GET",e)},f.rawXhrPost=f.xhrPost=function(e){return f.xhr("POST",e,!0)},f.rawXhrPut=f.xhrPut=function(e){return f.xhr("PUT",e,!0)},f.xhrDelete=function(e){return f.xhr("DELETE",e)},f._isDocumentOk=function(e){return t.checkStatus(e.status)},f._getText=function(e){var r;return f.xhrGet({url:e,sync:!0,load:function(e){r=e}}),r},b.mixin(f.xhr,{_xhrObj:f._xhrObj,fieldToObject:y.fieldToObject,formToObject:y.toObject,objectToQuery:p.objectToQuery,formToQuery:y.toQuery,formToJson:y.toJson,queryToObject:p.queryToObject,contentHandlers:l,_ioSetArgs:f._ioSetArgs,_ioCancelAll:f._ioCancelAll,_ioNotifyStart:f._ioNotifyStart,_ioWatch:f._ioWatch,_ioAddQueryToUrl:f._ioAddQueryToUrl,_isDocumentOk:f._isDocumentOk,_getText:f._getText,get:f.xhrGet,post:f.xhrPost,put:f.xhrPut,del:f.xhrDelete}),f.xhr});