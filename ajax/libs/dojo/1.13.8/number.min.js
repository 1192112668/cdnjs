define(["./_base/lang","./i18n","./i18n!./cldr/nls/number","./string","./regexp"],function(i,u,e,b,s){var l,v={};return i.setObject("dojo.number",v),v.format=function(e,r){r=i.mixin({},r||{});var n=u.normalizeLocale(r.locale),a=u.getLocalization("dojo.cldr","number",n);r.customs=a;var t=r.pattern||a[(r.type||"decimal")+"Format"];return isNaN(e)||Math.abs(e)==1/0?null:v._applyPattern(e,t,r)},v._numberPatternRE=/[#0,]*[#0](?:\.0*#*)?/,v._applyPattern=function(e,r,l){var n=(l=l||{}).customs.group,a=l.customs.decimal,t=r.split(";"),i=t[0];if(-1!=(r=t[e<0?1:0]||"-"+i).indexOf("%"))e*=100;else if(-1!=r.indexOf("‰"))e*=1e3;else if(-1!=r.indexOf("¤"))n=l.customs.currencyGroup||n,a=l.customs.currencyDecimal||a,r=r.replace(/([\s\xa0]*)(\u00a4{1,3})([\s\xa0]*)/,function(e,r,n,a){var t=["symbol","currency","displayName"][n.length-1],i=l[t]||l.currency||"";return i?r+i+a:""});else if(-1!=r.indexOf("E"))throw new Error("exponential notation not supported");var o=v._numberPatternRE,c=i.match(o);if(!c)throw new Error("unable to find a number expression in pattern: "+r);return!1===l.fractional&&(l.places=0),r.replace(o,v._formatAbsolute(e,c[0],{decimal:a,group:n,places:l.places,round:l.round}))},v.round=function(e,r,n){var a=10/(n||10);return(a*e).toFixed(r)/a},0==.9.toFixed()&&(l=v.round,v.round=function(e,r,n){var a=Math.pow(10,-r||0),t=Math.abs(e);return(!e||a<=t||(t/=a)<.5||.95<=t)&&(a=0),l(e,r,n)+(0<e?a:-a)}),v._formatAbsolute=function(e,r,n){!0===(n=n||{}).places&&(n.places=0),n.places===1/0&&(n.places=6);var a=r.split("."),t="string"==typeof n.places&&n.places.indexOf(","),i=n.places;t?i=n.places.substring(t+1):0<=i||(i=(a[1]||[]).length),n.round<0||(e=v.round(e,i,n.round));var l=String(Math.abs(e)).split("."),o=l[1]||"";a[1]||n.places?(t&&(n.places=n.places.substring(0,t)),(c=void 0!==n.places?n.places:a[1]&&a[1].lastIndexOf("0")+1)>o.length&&(l[1]=b.pad(o,c,"0",!0)),i<o.length&&(l[1]=o.substr(0,i))):l[1]&&l.pop();var c,p=a[0].replace(",","");-1!=(c=p.indexOf("0"))&&((c=p.length-c)>l[0].length&&(l[0]=b.pad(l[0],c)),-1==p.indexOf("#")&&(l[0]=l[0].substr(l[0].length-c)));var u,s,d,g=a[0].lastIndexOf(",");-1!=g&&(u=a[0].length-g-1,-1!=(g=(d=a[0].substr(0,g)).lastIndexOf(","))&&(s=d.length-g-1));for(var f=[],x=l[0];x;){var m=x.length-u;f.push(0<m?x.substr(m):x),x=0<m?x.slice(0,m):"",s&&(u=s,s=void 0)}return l[0]=f.reverse().join(n.group||","),l.join(n.decimal||".")},v.regexp=function(e){return v._parseInfo(e).regexp},v._parseInfo=function(l){l=l||{};var e,r=u.normalizeLocale(l.locale),n=u.getLocalization("dojo.cldr","number",r),a=l.pattern||n[(l.type||"decimal")+"Format"],i=n.group,o=n.decimal,c=1;-1!=a.indexOf("%")?c/=100:-1!=a.indexOf("‰")?c/=1e3:(e=-1!=a.indexOf("¤"))&&(i=n.currencyGroup||i,o=n.currencyDecimal||o);var t=a.split(";");1==t.length&&t.push("-"+t[0]);var p=s.buildGroupRE(t,function(e){return(e="(?:"+s.escapeString(e,".")+")").replace(v._numberPatternRE,function(e){var r={signed:!1,separator:l.strict?i:[i,""],fractional:l.fractional,decimal:o,exponent:!1},n=e.split("."),a=l.places;1==n.length&&1!=c&&(n[1]="###"),1==n.length||0===a?r.fractional=!1:(void 0===a&&(a=l.pattern?n[1].lastIndexOf("0")+1:1/0),a&&null==l.fractional&&(r.fractional=!0),!l.places&&a<n[1].length&&(a+=","+n[1].length),r.places=a);var t=n[0].split(",");return 1<t.length&&(r.groupSize=t.pop().length,1<t.length&&(r.groupSize2=t.pop().length)),"("+v._realNumberRegexp(r)+")"})},!0);return e&&(p=p.replace(/([\s\xa0]*)(\u00a4{1,3})([\s\xa0]*)/g,function(e,r,n,a){var t=["symbol","currency","displayName"][n.length-1],i=s.escapeString(l[t]||l.currency||"");return i?(r=r?"[\\s\\xa0]":"",a=a?"[\\s\\xa0]":"",l.strict?r+i+a:(r&&(r+="*"),a&&(a+="*"),"(?:"+r+i+a+")?")):""})),{regexp:p.replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:i,decimal:o,factor:c}},v.parse=function(e,r){var n=v._parseInfo(r),a=new RegExp("^"+n.regexp+"$").exec(e);if(!a)return NaN;var t=a[1];if(!a[1]){if(!a[2])return NaN;t=a[2],n.factor*=-1}return(t=t.replace(new RegExp("["+n.group+"\\s\\xa0]","g"),"").replace(n.decimal,"."))*n.factor},v._realNumberRegexp=function(n){"places"in(n=n||{})||(n.places=1/0),"string"!=typeof n.decimal&&(n.decimal="."),"fractional"in n&&!/^0/.test(n.places)||(n.fractional=[!0,!1]),"exponent"in n||(n.exponent=[!0,!1]),"eSigned"in n||(n.eSigned=[!0,!1]);var e=v._integerRegexp(n),r=s.buildGroupRE(n.fractional,function(e){var r="";return e&&0!==n.places&&(r="\\"+n.decimal,n.places==1/0?r="(?:"+r+"\\d+)?":r+="\\d{"+n.places+"}"),r},!0),a=e+r;return r&&(a="(?:(?:"+a+")|(?:"+r+"))"),a+s.buildGroupRE(n.exponent,function(e){return e?"([eE]"+v._integerRegexp({signed:n.eSigned})+")":""})},v._integerRegexp=function(t){return"signed"in(t=t||{})||(t.signed=[!0,!1]),"separator"in t?"groupSize"in t||(t.groupSize=3):t.separator="",s.buildGroupRE(t.signed,function(e){return e?"[-+]":""},!0)+s.buildGroupRE(t.separator,function(e){if(!e)return"(?:\\d+)";" "==(e=s.escapeString(e))?e="\\s":" "==e&&(e="\\s\\xa0");var r=t.groupSize,n=t.groupSize2;if(n){var a="(?:0|[1-9]\\d{0,"+(n-1)+"}(?:["+e+"]\\d{"+n+"})*["+e+"]\\d{"+r+"})";return 0<r-n?"(?:"+a+"|(?:0|[1-9]\\d{0,"+(r-1)+"}))":a}return"(?:0|[1-9]\\d{0,"+(r-1)+"}(?:["+e+"]\\d{"+r+"})*)"},!0)},v});