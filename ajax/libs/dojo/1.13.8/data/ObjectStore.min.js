define(["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../_base/array","../_base/connect","../regexp"],function(s,t,e,h,u,b,l){function f(t){return"*"==t?".*":"?"==t?".":t}return e("dojo.data.ObjectStore",[t],{objectStore:null,constructor:function(t){this._dirtyObjects=[],t.labelAttribute&&(t.labelProperty=t.labelAttribute),s.mixin(this,t)},labelProperty:"label",getValue:function(t,e,n){return"function"==typeof t.get?t.get(e):e in t?t[e]:n},getValues:function(t,e){var n=this.getValue(t,e);return n instanceof Array?n:void 0===n?[]:[n]},getAttributes:function(t){var e=[];for(var n in t)!t.hasOwnProperty(n)||"_"==n.charAt(0)&&"_"==n.charAt(1)||e.push(n);return e},hasAttribute:function(t,e){return e in t},containsValue:function(t,e,n){return-1<u.indexOf(this.getValues(t,e),n)},isItem:function(t){return"object"==typeof t&&t&&!(t instanceof Date)},isItemLoaded:function(t){return t&&"function"!=typeof t.load},loadItem:function(n){var o;return"function"==typeof n.item.load?h.when(n.item.load(),function(t){var e=(o=t)instanceof Error?n.onError:n.onItem;e&&e.call(n.scope,t)}):n.onItem&&n.onItem.call(n.scope,n.item),o},close:function(t){return t&&t.abort&&t.abort()},fetch:function(o){o=s.delegate(o,o&&o.queryOptions);var r=this,i=o.scope||r,t=o.query;if("object"==typeof t)for(var e in t=s.delegate(t)){var n=t[e];"string"==typeof n&&(t[e]=RegExp("^"+l.escapeString(n,"*?\\").replace(/\\.|\*|\?/g,f)+"$",o.ignoreCase?"mi":"m"),t[e].toString=function(t){return function(){return t}}(n))}var c=this.objectStore.query(t,o);function a(t){o.onError&&o.onError.call(i,t,o)}return h.when(c.total,function(n){h.when(c,function(t){if(o.onBegin&&o.onBegin.call(i,n||t.length,o),o.onItem)for(var e=0;e<t.length;e++)o.onItem.call(i,t[e],o);return o.onComplete&&o.onComplete.call(i,o.onItem?null:t,o),t},a)},a),o.abort=function(){c.cancel&&c.cancel()},c.observe&&(this.observing&&this.observing.cancel(),this.observing=c.observe(function(t,e,n){if(-1==u.indexOf(r._dirtyObjects,t))if(-1==e)r.onNew(t);else if(-1==n)r.onDelete(t);else for(var o in t)o!=r.objectStore.idProperty&&r.onSet(t,o,null,t[o])},!0)),this.onFetch(c),o.store=this,o},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(t){if(this.isItem(t))return this.getValue(t,this.labelProperty)},getLabelAttributes:function(t){return[this.labelProperty]},getIdentity:function(t){return this.objectStore.getIdentity?this.objectStore.getIdentity(t):t[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(t){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var n;return h.when(this.objectStore.get(e.identity),function(t){n=t,e.onItem.call(e.scope,t)},function(t){e.onError.call(e.scope,t)}),n},newItem:function(t,e){var n;return e&&(n=(n=this.getValue(e.parent,e.attribute,[])).concat([t]),t.__parent=n,this.setValue(e.parent,e.attribute,n)),this._dirtyObjects.push({object:t,save:!0}),this.onNew(t),t},deleteItem:function(t){this.changing(t,!0),this.onDelete(t)},setValue:function(t,e,n){var o=t[e];this.changing(t),t[e]=n,this.onSet(t,e,o,n)},setValues:function(t,e,n){if(!s.isArray(n))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(t,e,n)},unsetAttribute:function(t,e){this.changing(t);var n=t[e];delete t[e],this.onSet(t,e,n,void 0)},changing:function(t,e){t.__isDirty=!0;for(var n=0;n<this._dirtyObjects.length;n++){var o=this._dirtyObjects[n];if(t==o.object)return void(e&&(o.object=!1,this._saveNotNeeded||(o.save=!0)))}var r=t instanceof Array?[]:{};for(n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);this._dirtyObjects.push({object:!e&&t,old:r,save:!this._saveNotNeeded})},save:function(e){e=e||{};var t,n,o=[],r=[],i=this,c=this._dirtyObjects,a=c.length;try{b.connect(e,"onError",function(){var t;!1!==e.revertOnError?(t=c,c=r,i.revert(),i._dirtyObjects=t):i._dirtyObjects=c.concat(r)}),this.objectStore.transaction&&(n=this.objectStore.transaction());for(var s=0;s<c.length;s++){var u=c[s],l=u.object,f=u.old;delete l.__isDirty,l?t=this.objectStore.put(l,{overwrite:!!f}):void 0!==f&&(t=this.objectStore.remove(this.getIdentity(f))),r.push(u),c.splice(s--,1),h.when(t,function(t){--a||e.onComplete&&e.onComplete.call(e.scope,o)},function(t){a=-1,e.onError.call(e.scope,t)})}n&&n.commit()}catch(t){e.onError.call(e.scope,value)}},revert:function(){for(var t=this._dirtyObjects,e=t.length;0<e;){var n=t[--e],o=n.object,r=n.old;if(o&&r){for(var i in r)r.hasOwnProperty(i)&&o[i]!==r[i]&&(this.onSet(o,i,o[i],r[i]),o[i]=r[i]);for(i in o)r.hasOwnProperty(i)||(this.onSet(o,i,o[i]),delete o[i])}else r?this.onNew(r):this.onDelete(o);delete(o||r).__isDirty,t.splice(e,1)}},isDirty:function(t){return t?t.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(t){}})});