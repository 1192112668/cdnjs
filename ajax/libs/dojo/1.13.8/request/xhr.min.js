define(["../errors/RequestError","./watch","./handlers","./util","../has"],function(v,b,a,y,x){x.add("native-xhr",function(){return"undefined"!=typeof XMLHttpRequest}),x.add("dojo-force-activex-xhr",function(){return x("activex")&&"file:"===window.location.protocol}),x.add("native-xhr2",function(){if(x("native-xhr")&&!x("dojo-force-activex-xhr")){var e=new XMLHttpRequest;return void 0!==e.addEventListener&&("undefined"==typeof opera||void 0!==e.upload)}}),x.add("native-formdata",function(){return"undefined"!=typeof FormData}),x.add("native-blob",function(){return"undefined"!=typeof Blob}),x.add("native-arraybuffer",function(){return"undefined"!=typeof ArrayBuffer}),x.add("native-response-type",function(){return x("native-xhr")&&void 0!==(new XMLHttpRequest).responseType}),x.add("native-xhr2-blob",function(){if(x("native-response-type")){var e=new XMLHttpRequest;e.open("GET","https://dojotoolkit.org/",!0),e.responseType="blob";var t=e.responseType;return e.abort(),"blob"===t}});var w,m,L,T,X={blob:x("native-xhr2-blob")?"blob":"arraybuffer",document:"document",arraybuffer:"arraybuffer"};function H(e,t){var r,n=e.xhr;e.status=e.xhr.status;try{e.text=n.responseText}catch(e){}if("xml"===e.options.handleAs&&(e.data=n.responseXML),t)this.reject(t);else{try{a(e)}catch(e){r=e}y.checkStatus(n.status)?r?this.reject(r):this.resolve(e):(t=new v(r?"Unable to load "+e.url+" status: "+n.status+" and an error in handleAs: transformation of response":"Unable to load "+e.url+" status: "+n.status,e),this.reject(t))}}function M(e){return this.xhr.getResponseHeader(e)}x("native-xhr2")?(w=function(e){return!this.isFulfilled()},T=function(e,t){t.xhr.abort()},L=function(e,n,a){function t(e){n.handleResponse(a)}function r(e){var t=e.target,r=new v("Unable to load "+a.url+" status: "+t.status,a);n.handleResponse(a,r)}function o(e){e.lengthComputable?(a.loaded=e.loaded,a.total=e.total,n.progress(a)):3===a.xhr.readyState&&(a.loaded="loaded"in e?e.loaded:e.position,n.progress(a))}return e.addEventListener("load",t,!1),e.addEventListener("error",r,!1),e.addEventListener("progress",o,!1),function(){e.removeEventListener("load",t,!1),e.removeEventListener("error",r,!1),e.removeEventListener("progress",o,!1),e=null}}):(w=function(e){return e.xhr.readyState},m=function(e){return 4===e.xhr.readyState},T=function(e,t){var r=t.xhr,n=typeof r.abort;"function"!=n&&"object"!=n&&"unknown"!=n||r.abort()});var R,j={data:null,query:null,sync:!1,method:"GET"};function q(e,t,r){var n=x("native-formdata")&&t&&t.data&&t.data instanceof FormData,a=y.parseArgs(e,y.deepCreate(j,t),n);e=a.url;var o=!(t=a.options).data&&"POST"!==t.method&&"PUT"!==t.method;x("ie")<=10&&(e=e.split("#")[0]);var s,i=y.deferred(a,T,w,m,H,function(){s&&s()}),d=a.xhr=q._create();if(!d)return i.cancel(new v("XHR was not created")),r?i:i.promise;a.getHeader=M,L&&(s=L(d,i,a));var u=void 0===t.data?null:t.data,c=!t.sync,f=t.method;try{d.open(f,e,c,t.user||R,t.password||R),t.withCredentials&&(d.withCredentials=t.withCredentials),x("native-response-type")&&t.handleAs in X&&(d.responseType=X[t.handleAs]);var l=t.headers,p=!n&&!o&&"application/x-www-form-urlencoded";if(l)for(var h in l)"content-type"===h.toLowerCase()?p=l[h]:l[h]&&d.setRequestHeader(h,l[h]);p&&!1!==p&&d.setRequestHeader("Content-Type",p),l&&"X-Requested-With"in l||d.setRequestHeader("X-Requested-With","XMLHttpRequest"),y.notify&&y.notify.emit("send",a,i.promise.cancel),d.send(u)}catch(e){i.reject(e)}return b(i),d=null,r?i:i.promise}if(q._create=function(){throw new Error("XMLHTTP not available")},x("native-xhr")&&!x("dojo-force-activex-xhr"))q._create=function(){return new XMLHttpRequest};else if(x("activex"))try{new ActiveXObject("Msxml2.XMLHTTP"),q._create=function(){return new ActiveXObject("Msxml2.XMLHTTP")}}catch(e){try{new ActiveXObject("Microsoft.XMLHTTP"),q._create=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}catch(e){}}return y.addCommonMethods(q),q});