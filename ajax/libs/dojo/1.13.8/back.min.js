define(["./_base/config","./_base/lang","./sniff","./dom","./dom-construct","./_base/window","require"],function(l,o,d,n,s,u,t){var r={};d("extend-dojo")&&o.setObject("dojo.back",r);var h=r.getHash=function(){var o=window.location.hash;return"#"==o.charAt(0)&&(o=o.substring(1)),d("mozilla")?o:decodeURIComponent(o)},f=r.setHash=function(o){o=o||"",window.location.hash=encodeURIComponent(o),history.length},e="undefined"!=typeof window?window.location.href:"",a="undefined"!=typeof window?h():"",c=null,w=null,g=null,m=null,b=[],k=[],i=!1,y=!1;function p(){var o,n=k.pop();n&&((o=k[k.length-1])||0!=k.length||(o=c),o&&(o.kwArgs.back?o.kwArgs.back():o.kwArgs.backButton?o.kwArgs.backButton():o.kwArgs.handle&&o.kwArgs.handle("back")),b.push(n))}function v(){var o=b.pop();o&&(o.kwArgs.forward?o.kwArgs.forward():o.kwArgs.forwardButton?o.kwArgs.forwardButton():o.kwArgs.handle&&o.kwArgs.handle("forward"),k.push(o))}function j(o,n,t){return{url:o,kwArgs:n,urlHash:t}}function A(o){var n=o.split("?");return n.length<2?null:n[1]}function H(){var o=(l.dojoIframeHistoryUrl||t.toUrl("./resources/iframe_history.html"))+"?"+(new Date).getTime();return i=!0,m&&(d("webkit")?m.location=o:window.frames[m.name].location=o),o}function _(){if(!y){var o=k.length,n=h();if((n===a||window.location.href==e)&&1==o)return void p();if(0<b.length&&b[b.length-1].urlHash===n)return void v();2<=o&&k[o-2]&&k[o-2].urlHash===n&&p()}}return r.goBack=p,r.goForward=v,r.init=function(){var o;n.byId("dj_history")||(o=l.dojoIframeHistoryUrl||t.toUrl("./resources/iframe_history.html"),l.afterOnLoad?console.error("dojo/back::init() must be called before the DOM has loaded. Include dojo/back in a build layer."):document.write('<iframe style="border:0;width:1px;height:1px;position:absolute;visibility:hidden;bottom:0;right:0;" name="dj_history" id="dj_history" src="'+o+'"></iframe>'))},r.setInitialState=function(o){c=j(e,o,a)},r.addToHistory=function(o){b=[];var n,t,r,e,a=null,i=null;if(m||(l.useXDomain&&!l.dojoIframeHistoryUrl&&console.warn("dojo/back: When using cross-domain Dojo builds, please save iframe_history.html to your domain and set djConfig.dojoIframeHistoryUrl to the path on your domain to iframe_history.html"),m=window.frames.dj_history),g=g||s.create("a",{style:{display:"none"}},u.body()),o.changeUrl){if(a=""+(!0!==o.changeUrl?o.changeUrl:(new Date).getTime()),0==k.length&&c.urlHash==a)return void(c=j(i,o,a));if(0<k.length&&k[k.length-1].urlHash==a)return void(k[k.length-1]=j(i,o,a));y=!0,setTimeout(function(){f(a),y=!1},1),g.href=a,d("ie")?(i=H(),n=o.back||o.backButton||o.handle,t=function(o){""!=h()&&setTimeout(function(){f(a)},1),n.apply(this,[o])},o.back?o.back=t:o.backButton?o.backButton=t:o.handle&&(o.handle=t),r=o.forward||o.forwardButton||o.handle,e=function(o){""!=h()&&f(a),r&&r.apply(this,[o])},o.forward?o.forward=e:o.forwardButton?o.forwardButton=e:o.handle&&(o.handle=e)):d("ie")||(w=w||setInterval(_,200))}else i=H();k.push(j(i,o,a))},r._iframeLoaded=function(o,n){var t=A(n.href);null!=t?i?i=!1:2<=k.length&&t==A(k[k.length-2].url)?p():0<b.length&&t==A(b[b.length-1].url)&&v():1==k.length&&p()},r});