define(["../_base/kernel","../_base/lang","../when","../_base/array"],function(e,f,u,q){function t(m){var x,o=[],O=0;(m=f.delegate(m)).notify=function(e,t){O++;for(var n=o.slice(),r=0,i=n.length;r<i;r++)n[r](e,t)};var a,i=m.query;function e(r,i){var o=m[r];o&&(m[r]=function(t){var n;if("put"===r&&(n=m.getIdentity(t)),a)return o.apply(this,arguments);a=!0;try{var e=o.apply(this,arguments);return u(e,function(e){i("object"==typeof e&&e||t,n)}),e}finally{a=!1}})}return m.query=function(e,p){p=p||{};var t,h,g,b,n,r=i.apply(this,arguments);return r&&r.forEach&&(delete(t=f.mixin({},p)).start,delete t.count,h=m.queryEngine&&m.queryEngine(e,t),g=O,b=[],r.observe=function(t,d){1==b.push(t)&&o.push(n=function(y,v){u(r,function(e){var t,n,r=e.length!=p.count;if(++g!=O)throw new Error("Query is out of date, you must observe() the query prior to any data modifications");var i,o,a=-1,f=-1;if(v!==x){var u=[].concat(e);for(h&&!y&&(u=h(e)),l=0,t=e.length;l<t;l++){var c=e[l];if(m.getIdentity(c)==v){if(u.indexOf(c)<0)continue;i=c,a=l,!h&&y||e.splice(l,1);break}}}if(h?y&&(h.matches?h.matches(y):h([y]).length)&&(o=-1<a?a:e.length,e.splice(o,0,y),f=q.indexOf(h(e),y),e.splice(o,1),p.start&&0==f||!r&&f==e.length?f=-1:e.splice(f,0,y)):y&&(v!==x?f=a:p.start||(f=m.defaultIndex||0,e.splice(f,0,y))),(-1<a||-1<f)&&(d||!h||a!=f))for(var s=b.slice(),l=0;n=s[l];l++)n(y||i,a,f)})});var e={};return e.remove=e.cancel=function(){var e=q.indexOf(b,t);-1<e&&(b.splice(e,1),b.length||o.splice(q.indexOf(o,n),1))},e}),r},e("put",function(e,t){m.notify(e,t)}),e("add",function(e){m.notify(e)}),e("remove",function(e){m.notify(void 0,e)}),m}return f.setObject("dojo.store.Observable",t),t});