"use strict";var htmlparser=require("htmlparser2"),extend=require("xtend"),quoteRegexp=require("lodash.escaperegexp"),cloneDeep=require("lodash.clonedeep"),mergeWith=require("lodash.mergewith"),isString=require("lodash.isstring"),isPlainObject=require("lodash.isplainobject"),srcset=require("srcset"),postcss=require("postcss"),url=require("url");function each(t,r){t&&Object.keys(t).forEach(function(e){r(t[e],e)})}function has(e,t){return{}.hasOwnProperty.call(e,t)}function filter(e,t){var r=[];return each(e,function(e){t(e)&&r.push(e)}),r}module.exports=sanitizeHtml;var VALID_HTML_ATTRIBUTE_NAME=/^[^\0\t\n\f\r /<=>]+$/;function sanitizeHtml(e,A,t){var P="";function i(e,t){var r=this;this.tag=e,this.attribs=t||{},this.tagPosition=P.length,this.text="",this.updateParentNodeText=function(){u.length&&(u[u.length-1].text+=r.text)}}A?(A=extend(sanitizeHtml.defaults,A)).parser?A.parser=extend(htmlParserDefaults,A.parser):A.parser=htmlParserDefaults:(A=sanitizeHtml.defaults).parser=htmlParserDefaults;var q,S,n=A.nonTextTags||["script","style","textarea"];A.allowedAttributes&&(q={},S={},each(A.allowedAttributes,function(e,t){q[t]=[];var r=[];e.forEach(function(e){isString(e)&&0<=e.indexOf("*")?r.push(quoteRegexp(e).replace(/\\\*/g,".*")):q[t].push(e)}),S[t]=new RegExp("^("+r.join("|")+")$")}));var H={};each(A.allowedClasses,function(e,t){q&&(has(q,t)||(q[t]=[]),q[t].push("class")),H[t]=e});var s,l={};each(A.transformTags,function(e,t){var r;"function"==typeof e?r=e:"string"==typeof e&&(r=sanitizeHtml.simpleTransform(e)),"*"===t?s=r:l[t]=r});var o=0,u=[],c={},f={},d=!1,h=0,r=new htmlparser.Parser({onopentag:function(T,e){var O,t,r,a;d?h++:(O=new i(T,e),u.push(O),t=!1,r=!!O.text,has(l,T)&&(a=l[T](T,e),O.attribs=e=a.attribs,void 0!==a.text&&(O.innerText=a.text),T!==a.tagName&&(O.name=T=a.tagName,f[o]=a.tagName)),s&&(a=s(T,e),O.attribs=e=a.attribs,T!==a.tagName&&(O.name=T=a.tagName,f[o]=a.tagName)),A.allowedTags&&-1===A.allowedTags.indexOf(T)&&(t=!0,-1!==n.indexOf(T)&&(d=!0,h=1),c[o]=!0),o++,t||(P+="<"+T,q&&!has(q,T)&&!q["*"]||each(e,function(e,t){if(VALID_HTML_ATTRIBUTE_NAME.test(t)){var r,a,i,n=!1;if(!q||has(q,T)&&-1!==q[T].indexOf(t)||q["*"]&&-1!==q["*"].indexOf(t)||has(S,T)&&S[T].test(t)||S["*"]&&S["*"].test(t))n=!0;else if(q&&q[T]){var s=!0,l=!1,o=void 0;try{for(var u,c=q[T][Symbol.iterator]();!(s=(u=c.next()).done);s=!0){var f=u.value;if(isPlainObject(f)&&f.name&&f.name===t){var d="";if((n=!0)===f.multiple){var h=e.split(" "),p=!0,m=!1,g=void 0;try{for(var v,x=h[Symbol.iterator]();!(p=(v=x.next()).done);p=!0){var b=v.value;-1!==f.values.indexOf(b)&&(""===d?d=b:d+=" "+b)}}catch(e){m=!0,g=e}finally{try{!p&&x.return&&x.return()}finally{if(m)throw g}}}else 0<=f.values.indexOf(e)&&(d=e);e=d}}}catch(e){l=!0,o=e}finally{try{!s&&c.return&&c.return()}finally{if(l)throw o}}}if(n){if(-1!==A.allowedSchemesAppliedToAttributes.indexOf(t)&&z(T,e))return void delete O.attribs[t];if("iframe"===T&&"src"===t){var w=!0;try{(r=url.parse(e,!1,!0))&&null===r.host&&null===r.protocol?w=has(A,"allowIframeRelativeUrls")?A.allowIframeRelativeUrls:!A.allowedIframeHostnames:A.allowedIframeHostnames&&(w=A.allowedIframeHostnames.find(function(e){return e===r.hostname}))}catch(e){w=!1}if(!w)return void delete O.attribs[t]}if("srcset"===t)try{if(each(r=srcset.parse(e),function(e){z("srcset",e.url)&&(e.evil=!0)}),!(r=filter(r,function(e){return!e.evil})).length)return void delete O.attribs[t];e=srcset.stringify(filter(r,function(e){return!e.evil})),O.attribs[t]=e}catch(e){return void delete O.attribs[t]}if("class"===t&&(a=e,!(e=(i=H[T])?(a=a.split(/\s+/)).filter(function(e){return-1!==i.indexOf(e)}).join(" "):a).length))return void delete O.attribs[t];if("style"===t)try{var y=function(e,t){if(!t)return e;var r,a=cloneDeep(e),i=e.nodes[0];r=t[i.selector]&&t["*"]?mergeWith(cloneDeep(t[i.selector]),t["*"],function(e,t){if(Array.isArray(e))return e.concat(t)}):t[i.selector]||t["*"];r&&(a.nodes[0].nodes=i.nodes.reduce(function(r){return function(e,t){return r.hasOwnProperty(t.prop)&&r[t.prop].some(function(e){return e.test(t.value)})&&e.push(t),e}}(r),[]));return a}(postcss.parse(T+" {"+e+"}"),A.allowedStyles);if(0===(e=y.nodes[0].nodes.reduce(function(e,t){return e.push(t.prop+":"+t.value),e},[]).join(";")).length)return void delete O.attribs[t]}catch(e){return void delete O.attribs[t]}P+=" "+t,e.length&&(P+='="'+N(e,!0)+'"')}else delete O.attribs[t]}else delete O.attribs[t]}),-1!==A.selfClosing.indexOf(T)?P+=" />":(P+=">",!O.innerText||r||A.textFilter||(P+=O.innerText))))},ontext:function(e){var t,r,a;d||((t=u[u.length-1])&&(r=t.tag,e=void 0!==t.innerText?t.innerText:e),"script"===r||"style"===r?P+=e:(a=N(e,!1),A.textFilter?P+=A.textFilter(a):P+=a),u.length&&(u[u.length-1].text+=e))},onclosetag:function(e){if(d){if(--h)return;d=!1}var t=u.pop();if(t){if(d=!1,c[--o])return delete c[o],void t.updateParentNodeText();f[o]&&(e=f[o],delete f[o]),A.exclusiveFilter&&A.exclusiveFilter(t)?P=P.substr(0,t.tagPosition):(t.updateParentNodeText(),-1===A.selfClosing.indexOf(e)&&(P+="</"+e+">"))}}},A.parser);return r.write(e),r.end(),P;function N(e,t){return"string"!=typeof e&&(e+=""),A.parser.decodeEntities&&(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\>/g,"&gt;"),t&&(e=e.replace(/\"/g,"&quot;"))),e=e.replace(/&(?![a-zA-Z0-9#]{1,20};)/g,"&amp;").replace(/</g,"&lt;").replace(/\>/g,"&gt;"),t&&(e=e.replace(/\"/g,"&quot;")),e}function z(e,t){var r=(t=(t=t.replace(/[\x00-\x20]+/g,"")).replace(/<\!\-\-.*?\-\-\>/g,"")).match(/^([a-zA-Z]+)\:/);if(!r)return t.match(/^[\/\\]{2}/)&&!A.allowProtocolRelative;var a=r[1].toLowerCase();return has(A.allowedSchemesByTag,e)?-1===A.allowedSchemesByTag[e].indexOf(a):!A.allowedSchemes||-1===A.allowedSchemes.indexOf(a)}}var htmlParserDefaults={decodeEntities:!0};sanitizeHtml.defaults={allowedTags:["h3","h4","h5","h6","blockquote","p","a","ul","ol","nl","li","b","i","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","iframe"],allowedAttributes:{a:["href","name","target"],img:["src"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:["http","https","ftp","mailto"],allowedSchemesByTag:{},allowedSchemesAppliedToAttributes:["href","src","cite"],allowProtocolRelative:!0},sanitizeHtml.simpleTransform=function(a,i,n){return n=void 0===n||n,i=i||{},function(e,t){var r;if(n)for(r in i)t[r]=i[r];else t=i;return{tagName:a,attribs:t}}};