"use strict";var htmlparser=require("htmlparser2"),extend=require("xtend"),quoteRegexp=require("lodash.escaperegexp"),cloneDeep=require("lodash.clonedeep"),mergeWith=require("lodash.mergewith"),isString=require("lodash.isstring"),isPlainObject=require("lodash.isplainobject"),srcset=require("srcset"),csstree=require("css-tree"),url=require("url");function each(t,r){t&&Object.keys(t).forEach(function(e){r(t[e],e)})}function has(e,t){return{}.hasOwnProperty.call(e,t)}function filter(e,t){var r=[];return each(e,function(e){t(e)&&r.push(e)}),r}module.exports=sanitizeHtml;var VALID_HTML_ATTRIBUTE_NAME=/^[^\0\t\n\f\r /<=>]+$/;function sanitizeHtml(e,q,t){var P="";function i(e,t){var r=this;this.tag=e,this.attribs=t||{},this.tagPosition=P.length,this.text="",this.updateParentNodeText=function(){c.length&&(c[c.length-1].text+=r.text)}}q?(q=extend(sanitizeHtml.defaults,q)).parser?q.parser=extend(htmlParserDefaults,q.parser):q.parser=htmlParserDefaults:(q=sanitizeHtml.defaults).parser=htmlParserDefaults;var S,H,n=q.nonTextTags||["script","style","textarea"];q.allowedAttributes&&(S={},H={},each(q.allowedAttributes,function(e,t){S[t]=[];var r=[];e.forEach(function(e){isString(e)&&0<=e.indexOf("*")?r.push(quoteRegexp(e).replace(/\\\*/g,".*")):S[t].push(e)}),H[t]=new RegExp("^("+r.join("|")+")$")}));var N={};each(q.allowedClasses,function(e,t){S&&(has(S,t)||(S[t]=[]),S[t].push("class")),N[t]=e});var l,s={};each(q.transformTags,function(e,t){var r;"function"==typeof e?r=e:"string"==typeof e&&(r=sanitizeHtml.simpleTransform(e)),"*"===t?l=r:s[t]=r});var o=0,c=[],u={},f={},d=!1,h=0,r=new htmlparser.Parser({onopentag:function(A,e){var O,t,r,a;d?h++:(O=new i(A,e),c.push(O),t=!1,r=!!O.text,has(s,A)&&(a=s[A](A,e),O.attribs=e=a.attribs,void 0!==a.text&&(O.innerText=a.text),A!==a.tagName&&(O.name=A=a.tagName,f[o]=a.tagName)),l&&(a=l(A,e),O.attribs=e=a.attribs,A!==a.tagName&&(O.name=A=a.tagName,f[o]=a.tagName)),q.allowedTags&&-1===q.allowedTags.indexOf(A)&&(t=!0,-1!==n.indexOf(A)&&(d=!0,h=1),u[o]=!0),o++,t||(P+="<"+A,S&&!has(S,A)&&!S["*"]||each(e,function(e,t){if(VALID_HTML_ATTRIBUTE_NAME.test(t)){var r,a,i,n=!1;if(!S||has(S,A)&&-1!==S[A].indexOf(t)||S["*"]&&-1!==S["*"].indexOf(t)||has(H,A)&&H[A].test(t)||H["*"]&&H["*"].test(t))n=!0;else if(S&&S[A]){var l=!0,s=!1,o=void 0;try{for(var c,u=S[A][Symbol.iterator]();!(l=(c=u.next()).done);l=!0){var f=c.value;if(isPlainObject(f)&&f.name&&f.name===t){var d="";if((n=!0)===f.multiple){var h=e.split(" "),p=!0,g=!1,m=void 0;try{for(var v,x=h[Symbol.iterator]();!(p=(v=x.next()).done);p=!0){var b=v.value;-1!==f.values.indexOf(b)&&(""===d?d=b:d+=" "+b)}}catch(e){g=!0,m=e}finally{try{!p&&x.return&&x.return()}finally{if(g)throw m}}}else 0<=f.values.indexOf(e)&&(d=e);e=d}}}catch(e){s=!0,o=e}finally{try{!l&&u.return&&u.return()}finally{if(s)throw o}}}if(n){if(-1!==q.allowedSchemesAppliedToAttributes.indexOf(t)&&D(A,e))return void delete O.attribs[t];if("iframe"===A&&"src"===t){var w=!0;try{(r=url.parse(e,!1,!0))&&null===r.host&&null===r.protocol?w=has(q,"allowIframeRelativeUrls")?q.allowIframeRelativeUrls:!q.allowedIframeHostnames:q.allowedIframeHostnames&&(w=q.allowedIframeHostnames.find(function(e){return e===r.hostname}))}catch(e){w=!1}if(!w)return void delete O.attribs[t]}if("srcset"===t)try{if(each(r=srcset.parse(e),function(e){D("srcset",e.url)&&(e.evil=!0)}),!(r=filter(r,function(e){return!e.evil})).length)return void delete O.attribs[t];e=srcset.stringify(filter(r,function(e){return!e.evil})),O.attribs[t]=e}catch(e){return void delete O.attribs[t]}if("class"===t&&(a=e,!(e=(i=N[A])?(a=a.split(/\s+/)).filter(function(e){return-1!==i.indexOf(e)}).join(" "):a).length))return void delete O.attribs[t];if("style"===t)try{var y=csstree.parse(A+" {"+e+"}"),T=function(e,t){if(t[e]&&t["*"])return mergeWith(cloneDeep(t[e]),t["*"],function(e,t){if(Array.isArray(e))return e.concat(t)});return t[e]||t["*"]||{}}(A,q.allowedStyles||{});if(csstree.walk(y,function(e,t,r){var a,i;"Declaration"===e.type&&r&&(a=csstree.generate(e.value),void 0!==(i=T[e.property])&&i.every(function(e){return!a.match(e)})&&r.remove(t))}),0===(e=(e=csstree.generate(y).slice(A.length+1)).slice(0,e.length-1)).length)return void delete O.attribs[t];e+=";"}catch(e){return void delete O.attribs[t]}P+=" "+t,e.length&&(P+='="'+z(e,!0)+'"')}else delete O.attribs[t]}else delete O.attribs[t]}),-1!==q.selfClosing.indexOf(A)?P+=" />":(P+=">",!O.innerText||r||q.textFilter||(P+=O.innerText))))},ontext:function(e){var t,r,a;d||((t=c[c.length-1])&&(r=t.tag,e=void 0!==t.innerText?t.innerText:e),"script"===r||"style"===r?P+=e:(a=z(e,!1),q.textFilter?P+=q.textFilter(a):P+=a),c.length&&(c[c.length-1].text+=e))},onclosetag:function(e){if(d){if(--h)return;d=!1}var t=c.pop();if(t){if(d=!1,u[--o])return delete u[o],void t.updateParentNodeText();f[o]&&(e=f[o],delete f[o]),q.exclusiveFilter&&q.exclusiveFilter(t)?P=P.substr(0,t.tagPosition):(t.updateParentNodeText(),-1===q.selfClosing.indexOf(e)&&(P+="</"+e+">"))}}},q.parser);return r.write(e),r.end(),P;function z(e,t){return"string"!=typeof e&&(e+=""),q.parser.decodeEntities&&(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\>/g,"&gt;"),t&&(e=e.replace(/\"/g,"&quot;"))),e=e.replace(/&(?![a-zA-Z0-9#]{1,20};)/g,"&amp;").replace(/</g,"&lt;").replace(/\>/g,"&gt;"),t&&(e=e.replace(/\"/g,"&quot;")),e}function D(e,t){var r=(t=(t=t.replace(/[\x00-\x20]+/g,"")).replace(/<\!\-\-.*?\-\-\>/g,"")).match(/^([a-zA-Z]+)\:/);if(!r)return t.match(/^[\/\\]{2}/)&&!q.allowProtocolRelative;var a=r[1].toLowerCase();return has(q.allowedSchemesByTag,e)?-1===q.allowedSchemesByTag[e].indexOf(a):!q.allowedSchemes||-1===q.allowedSchemes.indexOf(a)}}var htmlParserDefaults={decodeEntities:!0};sanitizeHtml.defaults={allowedTags:["h3","h4","h5","h6","blockquote","p","a","ul","ol","nl","li","b","i","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","iframe"],allowedAttributes:{a:["href","name","target"],img:["src"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:["http","https","ftp","mailto"],allowedSchemesByTag:{},allowedSchemesAppliedToAttributes:["href","src","cite"],allowProtocolRelative:!0},sanitizeHtml.simpleTransform=function(a,i,n){return n=void 0===n||n,i=i||{},function(e,t){var r;if(n)for(r in i)t[r]=i[r];else t=i;return{tagName:a,attribs:t}}};