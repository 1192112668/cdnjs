var PruneCluster,__extends=this&&this.__extends||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);function i(){this.constructor=t}t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};!function(t){function e(){}t.Point=e;function s(){}t.ClusterObject=s;var r,n=1,o=Math.pow(2,53)-1,i=(__extends(a,r=s),a.prototype.Move=function(t,e){this.position.lat=+t,this.position.lng=+e},a.prototype.SetData=function(t){for(var e in t)this.data[e]=t[e]},a);function a(t,e,s,i,a,o){void 0===s&&(s={}),void 0===a&&(a=1),void 0===o&&(o=!1),r.call(this),this.data=s,this.position={lat:+t,lng:+e},this.weight=a,this.category=i,this.filtered=o,this.hashCode=n++}t.Marker=i;var l,v=(__extends(h,l=s),h.prototype.AddMarker=function(t){h.ENABLE_MARKERS_LIST&&this._clusterMarkers.push(t);var e=((e=this.hashCode)<<5)-e+t.hashCode;this.hashCode=o<=e?e%o:e;var s=(this.lastMarker=t).weight,i=this.totalWeight,a=s+i;this.averagePosition.lat=(this.averagePosition.lat*i+t.position.lat*s)/a,this.averagePosition.lng=(this.averagePosition.lng*i+t.position.lng*s)/a,++this.population,this.totalWeight=a,void 0!==t.category&&(this.stats[t.category]=this.stats[t.category]+1||1)},h.prototype.Reset=function(){this.hashCode=1,this.lastMarker=void 0,this.population=0,this.totalWeight=0,this.stats=[0,0,0,0,0,0,0,0],h.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])},h.prototype.ComputeBounds=function(t){var e=t.Project(this.position.lat,this.position.lng),s=t.Size,i=Math.floor(e.x/s)*s,a=Math.floor(e.y/s)*s,o=t.UnProject(i,a),r=t.UnProject(i+s,a+s);this.bounds={minLat:r.lat,maxLat:o.lat,minLng:o.lng,maxLng:r.lng}},h.prototype.GetClusterMarkers=function(){return this._clusterMarkers},h.prototype.ApplyCluster=function(t){this.hashCode=41*this.hashCode+43*t.hashCode,this.hashCode>o&&(this.hashCode=this.hashCode=o);var e=t.totalWeight,s=this.totalWeight,i=e+s;for(var a in this.averagePosition.lat=(this.averagePosition.lat*s+t.averagePosition.lat*e)/i,this.averagePosition.lng=(this.averagePosition.lng*s+t.averagePosition.lng*e)/i,this.population+=t.population,this.totalWeight=i,this.bounds.minLat=Math.min(this.bounds.minLat,t.bounds.minLat),this.bounds.minLng=Math.min(this.bounds.minLng,t.bounds.minLng),this.bounds.maxLat=Math.max(this.bounds.maxLat,t.bounds.maxLat),this.bounds.maxLng=Math.max(this.bounds.maxLng,t.bounds.maxLng),t.stats)t.stats.hasOwnProperty(a)&&(this.stats.hasOwnProperty(a)?this.stats[a]+=t.stats[a]:this.stats[a]=t.stats[a]);h.ENABLE_MARKERS_LIST&&(this._clusterMarkers=this._clusterMarkers.concat(t.GetClusterMarkers()))},h.ENABLE_MARKERS_LIST=!1,h);function h(t){if(l.call(this),this.stats=[0,0,0,0,0,0,0,0],this.data={},!t)return this.hashCode=1,void(h.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[]));h.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[t]),this.lastMarker=t,this.hashCode=31+t.hashCode,this.population=1,void 0!==t.category&&(this.stats[t.category]=1),this.totalWeight=t.weight,this.position={lat:t.position.lat,lng:t.position.lng},this.averagePosition={lat:t.position.lat,lng:t.position.lng}}function u(t){for(var e,s,i,a=1,o=t.length;a<o;++a){for(i=(s=t[a]).position.lng,e=a-1;0<=e&&t[e].position.lng>i;--e)t[e+1]=t[e];t[e+1]=s}}t.Cluster=v;var p=(d.prototype.RegisterMarker=function(t){t._removeFlag&&delete t._removeFlag,this._markers.push(t),this._nbChanges+=1},d.prototype.RegisterMarkers=function(t){var e=this;t.forEach(function(t){e.RegisterMarker(t)})},d.prototype._sortMarkers=function(){var t,e,s=this._markers,i=s.length;this._nbChanges&&(t=i,300<(e=this._nbChanges)||!(e/t<.2))?this._markers.sort(function(t,e){return t.position.lng-e.position.lng}):u(s),this._nbChanges=0},d.prototype._sortClusters=function(){u(this._clusters)},d.prototype._indexLowerBoundLng=function(t){for(var e,s,i=this._markers,a=0,o=i.length;0<o;)i[e=a+(s=Math.floor(o/2))].position.lng<t?(a=++e,o-=s+1):o=s;return a},d.prototype._resetClusterViews=function(){for(var t=0,e=this._clusters.length;t<e;++t){var s=this._clusters[t];s.Reset(),s.ComputeBounds(this)}},d.prototype.ProcessView=function(t){var e=Math.abs(t.maxLat-t.minLat)*this.ViewPadding,s=Math.abs(t.maxLng-t.minLng)*this.ViewPadding,i={minLat:t.minLat-e-e,maxLat:t.maxLat+e+e,minLng:t.minLng-s-s,maxLng:t.maxLng+s+s};this._sortMarkers(),this._resetClusterViews();for(var a,o,r=this._indexLowerBoundLng(i.minLng),n=this._markers,l=this._clusters,h=l.slice(0),u=r,p=n.length;u<p;++u){var d=n[u],m=d.position;if(m.lng>i.maxLng)break;if(m.lat>i.minLat&&m.lat<i.maxLat&&!d.filtered){for(var g,_=!1,f=0,c=h.length;f<c;++f)if((g=h[f]).bounds.maxLng<d.position.lng)h.splice(f,1),--f,--c;else if(a=m,o=g.bounds,a.lat>=o.minLat&&a.lat<=o.maxLat&&a.lng>=o.minLng&&a.lng<=o.maxLng){g.AddMarker(d),_=!0;break}_||((g=new v(d)).ComputeBounds(this),l.push(g),h.push(g))}}for(var L=[],u=0,p=l.length;u<p;++u)0<(g=l[u]).population&&L.push(g);return this._clusters=L,this._sortClusters(),this._clusters},d.prototype.RemoveMarkers=function(t){if(t){for(var e=0,s=t.length;e<s;++e)t[e]._removeFlag=!0;for(var i=[],e=0,s=this._markers.length;e<s;++e)this._markers[e]._removeFlag||i.push(this._markers[e]);this._markers=i}else this._markers=[]},d.prototype.FindMarkersInArea=function(t){for(var e=t.minLat,s=t.maxLat,i=t.minLng,a=t.maxLng,o=this._markers,r=[],n=this._indexLowerBoundLng(i),l=o.length;n<l;++n){var h=o[n].position;if(h.lng>a)break;h.lat>=e&&h.lat<=s&&h.lng>=i&&r.push(o[n])}return r},d.prototype.ComputeBounds=function(t,e){if(void 0===e&&(e=!0),!t||!t.length)return null;for(var s,i=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=Number.MAX_VALUE,r=-Number.MAX_VALUE,n=0,l=t.length;n<l;++n)!e&&t[n].filtered||((s=t[n].position).lat<i&&(i=s.lat),s.lat>a&&(a=s.lat),s.lng<o&&(o=s.lng),s.lng>r&&(r=s.lng));return{minLat:i,maxLat:a,minLng:o,maxLng:r}},d.prototype.FindMarkersBoundsInArea=function(t){return this.ComputeBounds(this.FindMarkersInArea(t))},d.prototype.ComputeGlobalBounds=function(t){return void 0===t&&(t=!0),this.ComputeBounds(this._markers,t)},d.prototype.GetMarkers=function(){return this._markers},d.prototype.GetPopulation=function(){return this._markers.length},d.prototype.ResetClusters=function(){this._clusters=[]},d);function d(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.2}t.PruneCluster=p}(PruneCluster=PruneCluster||{}),PruneCluster=PruneCluster||{};var PruneClusterForLeaflet=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,e){var s=this;void 0===t&&(t=120),void 0===e&&(e=20),this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Size=t,this.clusterMargin=Math.min(e,t/4),this.Cluster.Project=function(t,e){return s._map.project(new L.LatLng(t,e),Math.floor(s._map.getZoom()))},this.Cluster.UnProject=function(t,e){return s._map.unproject(new L.Point(t,e),Math.floor(s._map.getZoom()))},this._objectsOnMap=[],this.spiderfier=new PruneClusterLeafletSpiderfier(this),this._hardMove=!1,this._resetIcons=!1,this._removeTimeoutId=0,this._markersRemoveListTimeout=[]},RegisterMarker:function(t){this.Cluster.RegisterMarker(t)},RegisterMarkers:function(t){this.Cluster.RegisterMarkers(t)},RemoveMarkers:function(t){this.Cluster.RemoveMarkers(t)},BuildLeafletCluster:function(t,e){var f=this,c=new L.Marker(e,{icon:this.BuildLeafletClusterIcon(t)});return c._leafletClusterBounds=t.bounds,c.on("click",function(){var t=c._leafletClusterBounds,e=f.Cluster.FindMarkersInArea(t),s=f.Cluster.ComputeBounds(e);if(s){var i=new L.LatLngBounds(new L.LatLng(s.minLat,s.maxLng),new L.LatLng(s.maxLat,s.minLng)),a=f._map.getZoom(),o=f._map.getBoundsZoom(i,!1,new L.Point(20,20));if(o===a){for(var r=[],n=0,l=f._objectsOnMap.length;n<l;++n){var h=f._objectsOnMap[n];h.data._leafletMarker!==c&&h.bounds.minLat>=t.minLat&&h.bounds.maxLat<=t.maxLat&&h.bounds.minLng>=t.minLng&&h.bounds.maxLng<=t.maxLng&&r.push(h.bounds)}if(0<r.length){for(var u=[],p=r.length,n=0,l=e.length;n<l;++n){for(var d=e[n].position,m=!1,g=0;g<p;++g){var _=r[g];if(d.lat>=_.minLat&&d.lat<=_.maxLat&&d.lng>=_.minLng&&d.lng<=_.maxLng){m=!0;break}}m||u.push(e[n])}e=u}e.length<200?f._map.fire("overlappingmarkers",{cluster:f,markers:e,center:c.getLatLng(),marker:c}):o<f._map.getMaxZoom()&&o++,f._map.setView(c.getLatLng(),o)}else f._map.fitBounds(i)}}),c},BuildLeafletClusterIcon:function(t){var e="prunecluster prunecluster-",s=38,i=this.Cluster.GetPopulation();return t.population<Math.max(10,.01*i)?e+="small":s=t.population<Math.max(100,.05*i)?(e+="medium",40):(e+="large",44),new L.DivIcon({html:"<div><span>"+t.population+"</span></div>",className:e,iconSize:L.point(s,s)})},BuildLeafletMarker:function(t,e){var s=new L.Marker(e);return this.PrepareLeafletMarker(s,t.data,t.category),s},PrepareLeafletMarker:function(t,e,s){var i;e.icon&&("function"==typeof e.icon?t.setIcon(e.icon(e,s)):t.setIcon(e.icon)),e.popup&&(i="function"==typeof e.popup?e.popup(e,s):e.popup,t.getPopup()?t.setPopupContent(i,e.popupOptions):t.bindPopup(i,e.popupOptions))},onAdd:function(t){(this._map=t).on("movestart",this._moveStart,this),t.on("moveend",this._moveEnd,this),t.on("zoomend",this._zoomStart,this),t.on("zoomend",this._zoomEnd,this),this.ProcessView(),t.addLayer(this.spiderfier)},onRemove:function(t){t.off("movestart",this._moveStart,this),t.off("moveend",this._moveEnd,this),t.off("zoomend",this._zoomStart,this),t.off("zoomend",this._zoomEnd,this);for(var e=0,s=this._objectsOnMap.length;e<s;++e)t.removeLayer(this._objectsOnMap[e].data._leafletMarker);this._objectsOnMap=[],this.Cluster.ResetClusters(),t.removeLayer(this.spiderfier),this._map=null},_moveStart:function(){this._moveInProgress=!0},_moveEnd:function(t){this._moveInProgress=!1,this._hardMove=t.hard,this.ProcessView()},_zoomStart:function(){this._zoomInProgress=!0},_zoomEnd:function(){this._zoomInProgress=!1,this.ProcessView()},ProcessView:function(){var r=this;if(this._map&&!this._zoomInProgress&&!this._moveInProgress){for(var t=this._map,e=t.getBounds(),n=Math.floor(t.getZoom()),s=this.clusterMargin/this.Cluster.Size,l=this._resetIcons,i=e.getSouthWest(),a=e.getNorthEast(),o=this.Cluster.ProcessView({minLat:i.lat,minLng:i.lng,maxLat:a.lat,maxLng:a.lng}),h=this._objectsOnMap,u=[],p=new Array(h.length),d=0,m=h.length;d<m;++d){var g=h[d].data._leafletMarker;(p[d]=g)._removeFromMap=!0}var _=[],f=[],c=[],v=[];for(d=0,m=o.length;d<m;++d){for(var M=o[d],k=M.data,C=(M.bounds.maxLat-M.bounds.minLat)*s,P=(M.bounds.maxLng-M.bounds.minLng)*s,y=0,w=v.length;y<w;++y){var b=v[y];if(b.bounds.maxLng<M.bounds.minLng)v.splice(y,1),--y,--w;else{var x=b.averagePosition.lng+P,I=b.averagePosition.lat-C,S=b.averagePosition.lat+C,B=M.averagePosition.lng-P,R=M.averagePosition.lat-C,O=M.averagePosition.lat+C;if(B<x&&R<S&&I<O){k._leafletCollision=!0,b.ApplyCluster(M);break}}}k._leafletCollision||v.push(M)}for(o.forEach(function(t){var e=void 0,s=t.data;if(s._leafletCollision)return s._leafletCollision=!1,s._leafletOldPopulation=0,void(s._leafletOldHashCode=0);var i,a=new L.LatLng(t.averagePosition.lat,t.averagePosition.lng),o=s._leafletMarker;o&&(1===t.population&&1===s._leafletOldPopulation&&t.hashCode===o._hashCode?((l||o._zoomLevel!==n||t.lastMarker.data.forceIconRedraw)&&(r.PrepareLeafletMarker(o,t.lastMarker.data,t.lastMarker.category),t.lastMarker.data.forceIconRedraw&&(t.lastMarker.data.forceIconRedraw=!1)),o.setLatLng(a),e=o):1<t.population&&1<s._leafletOldPopulation&&(o._zoomLevel===n||s._leafletPosition.equals(a))&&(o.setLatLng(a),!l&&t.population==s._leafletOldPopulation&&t.hashCode===s._leafletOldHashCode||(i={},L.Util.extend(i,t.bounds),o._leafletClusterBounds=i,o.setIcon(r.BuildLeafletClusterIcon(t))),s._leafletOldPopulation=t.population,s._leafletOldHashCode=t.hashCode,e=o)),e?(e._removeFromMap=!1,u.push(t),e._zoomLevel=n,e._hashCode=t.hashCode,e._population=t.population,s._leafletMarker=e,s._leafletPosition=a):(1===t.population?f.push(t):_.push(t),s._leafletPosition=a,s._leafletOldPopulation=t.population,s._leafletOldHashCode=t.hashCode)}),_=f.concat(_),d=0,m=h.length;d<m;++d){var A=(M=h[d]).data,g=A._leafletMarker;if(A._leafletMarker._removeFromMap){var E=!0;if(g._zoomLevel===n)for(var z=M.averagePosition,C=(M.bounds.maxLat-M.bounds.minLat)*s,P=(M.bounds.maxLng-M.bounds.minLng)*s,y=0,w=_.length;y<w;++y){var T,F,U,j,V=_[y],N=V.data;if(1===g._population&&1===V.population&&g._hashCode===V.hashCode?((l||V.lastMarker.data.forceIconRedraw)&&(this.PrepareLeafletMarker(g,V.lastMarker.data,V.lastMarker.category),V.lastMarker.data.forceIconRedraw&&(V.lastMarker.data.forceIconRedraw=!1)),g.setLatLng(N._leafletPosition),E=!1):(T=V.averagePosition,F=z.lng-P,U=T.lng+P,x=z.lng+P,I=z.lat-C,S=z.lat+C,B=T.lng-P,R=T.lat-C,O=T.lat+C,1<g._population&&1<V.population&&B<x&&F<U&&R<S&&I<O&&(g.setLatLng(N._leafletPosition),g.setIcon(this.BuildLeafletClusterIcon(V)),j={},L.Util.extend(j,V.bounds),g._leafletClusterBounds=j,N._leafletOldPopulation=V.population,N._leafletOldHashCode=V.hashCode,g._population=V.population,E=!1)),!E){(N._leafletMarker=g)._removeFromMap=!1,u.push(V),_.splice(y,1),--y,--w;break}}E&&(g._removeFromMap||console.error("wtf"))}}for(d=0,m=_.length;d<m;++d){var D=(A=(M=_[d]).data)._leafletPosition,G=1===M.population?this.BuildLeafletMarker(M.lastMarker,D):this.BuildLeafletCluster(M,D);G.addTo(t),G.setOpacity(0),c.push(G),(A._leafletMarker=G)._zoomLevel=n,G._hashCode=M.hashCode,G._population=M.population,u.push(M)}if(window.setTimeout(function(){for(d=0,m=c.length;d<m;++d){var t=c[d];t._icon&&L.DomUtil.addClass(t._icon,"prunecluster-anim"),t._shadow&&L.DomUtil.addClass(t._shadow,"prunecluster-anim"),t.setOpacity(1)}},1),this._hardMove)for(d=0,m=p.length;d<m;++d)(g=p[d])._removeFromMap&&t.removeLayer(g);else{if(0!==this._removeTimeoutId)for(window.clearTimeout(this._removeTimeoutId),d=0,m=this._markersRemoveListTimeout.length;d<m;++d)t.removeLayer(this._markersRemoveListTimeout[d]);for(var W=[],d=0,m=p.length;d<m;++d)(g=p[d])._removeFromMap&&(g.setOpacity(0),W.push(g));0<W.length&&(this._removeTimeoutId=window.setTimeout(function(){for(d=0,m=W.length;d<m;++d)t.removeLayer(W[d]);r._removeTimeoutId=0},300)),this._markersRemoveListTimeout=W}this._objectsOnMap=u,this._hardMove=!1,this._resetIcons=!1}},FitBounds:function(t){void 0===t&&(t=!0);var e=this.Cluster.ComputeGlobalBounds(t);e&&this._map.fitBounds(new L.LatLngBounds(new L.LatLng(e.minLat,e.maxLng),new L.LatLng(e.maxLat,e.minLng)))},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(t){void 0===t&&(t=!0),this._resetIcons=!0,t&&this.ProcessView()}}),PruneClusterLeafletSpiderfier=(L.Layer?L.Layer:L.Class).extend({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(t){this._cluster=t,this._currentMarkers=[],this._multiLines=!!L.multiPolyline,this._lines=this._multiLines?L.multiPolyline([],{weight:1.5,color:"#222"}):L.polyline([],{weight:1.5,color:"#222"})},onAdd:function(t){this._map=t,this._map.on("overlappingmarkers",this.Spiderfy,this),this._map.on("click",this.Unspiderfy,this),this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(l){var h=this;if(l.cluster===this._cluster){this.Unspiderfy();var t=l.markers.filter(function(t){return!t.filtered});this._currentCenter=l.center;for(var e=this._map.latLngToLayerPoint(l.center),u=t.length>=this._spiralCountTrigger?this._generatePointsSpiral(t.length,e):(this._multiLines&&(e.y+=10),this._generatePointsCircle(t.length,e)),p=[],s=[],d=[],m=0,g=u.length;m<g;++m){var i=this._map.layerPointToLatLng(u[m]),a=this._cluster.BuildLeafletMarker(t[m],l.center);a.setZIndexOffset(5e3),a.setOpacity(0),this._currentMarkers.push(a),this._map.addLayer(a),s.push(a),d.push(i)}window.setTimeout(function(){for(m=0,g=u.length;m<g;++m)s[m].setLatLng(d[m]).setOpacity(1);var r=+new Date,n=window.setInterval(function(){p=[];var t=+new Date-r,e=290<=t?(window.clearInterval(n),1):t/290,s=l.center;for(m=0,g=u.length;m<g;++m){var i=d[m],a=i.lat-s.lat,o=i.lng-s.lng;p.push([s,new L.LatLng(s.lat+a*e,s.lng+o*e)])}h._lines.setLatLngs(p)},42)},1),this._lines.setLatLngs(p),this._map.addLayer(this._lines),l.marker&&(this._clusterMarker=l.marker.setOpacity(.3))}},_generatePointsCircle:function(t,e){for(var s,i=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+t)/this._2PI,a=this._2PI/t,o=[],r=(o.length=t)-1;0<=r;r--)s=this._circleStartAngle+r*a,o[r]=new L.Point(Math.round(e.x+i*Math.cos(s)),Math.round(e.y+i*Math.sin(s)));return o},_generatePointsSpiral:function(t,e){for(var s=this.spiderfyDistanceMultiplier*this._spiralLengthStart,i=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,a=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,o=0,r=[],n=(r.length=t)-1;0<=n;n--)o+=i/s+5e-4*n,r[n]=new L.Point(Math.round(e.x+s*Math.cos(o)),Math.round(e.y+s*Math.sin(o))),s+=this._2PI*a/o;return r},Unspiderfy:function(){for(var t=this,e=0,s=this._currentMarkers.length;e<s;++e)this._currentMarkers[e].setLatLng(this._currentCenter).setOpacity(0);var i=this._currentMarkers;window.setTimeout(function(){for(e=0,s=i.length;e<s;++e)t._map.removeLayer(i[e])},300),this._currentMarkers=[],this._map.removeLayer(this._lines),this._clusterMarker&&this._clusterMarker.setOpacity(1)},onRemove:function(t){this.Unspiderfy(),t.off("overlappingmarkers",this.Spiderfy,this),t.off("click",this.Unspiderfy,this),t.off("zoomend",this.Unspiderfy,this)}});