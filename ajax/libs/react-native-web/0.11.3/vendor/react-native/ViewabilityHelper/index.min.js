function _objectSpread(e){for(var i=1;i<arguments.length;i++){var t=null!=arguments[i]?arguments[i]:{},r=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.forEach(function(i){_defineProperty(e,i,t[i])})}return e}function _defineProperty(e,i,t){return i in e?Object.defineProperty(e,i,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[i]=t,e}import invariant from"fbjs/lib/invariant";var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var i=e.prototype;return i.dispose=function(){this._timers.forEach(clearTimeout)},i.computeViewableItems=function(e,i,t,r,n){var a=this._config,s=a.itemVisiblePercentThreshold,o=a.viewAreaCoveragePercentThreshold,l=null!=o,c=l?o:s;invariant(null!=c&&null!=s!=(null!=o),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var f=[];if(0===e)return f;var u=-1,h=n||{first:0,last:e-1},v=h.first,b=h.last;invariant(b<e,"Invalid render range "+JSON.stringify({renderRange:n,itemCount:e}));for(var d=v;d<=b;d++){var m=r(d);if(m){var _=m.offset-i,w=_+m.length;if(_<t&&w>0)u=d,_isViewable(l,c,_,w,t,m.length)&&f.push(d);else if(u>=0)break}}return f},i.onUpdate=function(e,i,t,r,n,a,s){var o=this;if((!this._config.waitForInteraction||this._hasInteracted)&&0!==e&&r(0)){var l=[];if(e&&(l=this.computeViewableItems(e,i,t,r,s)),this._viewableIndices.length!==l.length||!this._viewableIndices.every(function(e,i){return e===l[i]}))if(this._viewableIndices=l,this._config.minimumViewTime){var c=setTimeout(function(){o._timers.delete(c),o._onUpdateSync(l,a,n)},this._config.minimumViewTime);this._timers.add(c)}else this._onUpdateSync(l,a,n)}},i.resetViewableIndices=function(){this._viewableIndices=[]},i.recordInteraction=function(){this._hasInteracted=!0},i._onUpdateSync=function(e,i,t){var r=this;e=e.filter(function(e){return r._viewableIndices.includes(e)});var n=this._viewableItems,a=new Map(e.map(function(e){var i=t(e,!0);return[i.key,i]})),s=[],o=a,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var f;if(l){if(c>=o.length)break;f=o[c++]}else{if((c=o.next()).done)break;f=c.value}var u=f,h=u[0],v=u[1];n.has(h)||s.push(v)}var b=n,d=Array.isArray(b),m=0;for(b=d?b:b[Symbol.iterator]();;){var _;if(d){if(m>=b.length)break;_=b[m++]}else{if((m=b.next()).done)break;_=m.value}var w=_;h=w[0],v=w[1];a.has(h)||s.push(_objectSpread({},v,{isViewable:!1}))}s.length>0&&(this._viewableItems=a,i({viewableItems:Array.from(a.values()),changed:s,viewabilityConfig:this._config}))},e}();function _isViewable(e,i,t,r,n,a){if(_isEntirelyVisible(t,r,n))return!0;var s=_getPixelsVisible(t,r,n);return 100*(e?s/n:s/a)>=i}function _getPixelsVisible(e,i,t){var r=Math.min(i,t)-Math.max(e,0);return Math.max(0,r)}function _isEntirelyVisible(e,i,t){return e>=0&&i<=t&&i>e}export default ViewabilityHelper;