"use strict";exports.__esModule=!0,exports.default=void 0;var _AccessibilityUtil=_interopRequireDefault(require("../../modules/AccessibilityUtil")),_BoundingDimensions=_interopRequireDefault(require("./BoundingDimensions")),_findNodeHandle=_interopRequireDefault(require("../findNodeHandle")),_normalizeCssColor=_interopRequireDefault(require("normalize-css-color")),_Position=_interopRequireDefault(require("./Position")),_react=_interopRequireDefault(require("react")),_TouchEventUtils=_interopRequireDefault(require("fbjs/lib/TouchEventUtils")),_UIManager=_interopRequireDefault(require("../UIManager")),_View=_interopRequireDefault(require("../View"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var E=null!=arguments[t]?arguments[t]:{},s=Object.keys(E);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(E).filter(function(t){return Object.getOwnPropertyDescriptor(E,t).enumerable}))),s.forEach(function(t){_defineProperty(e,t,E[t])})}return e}function _defineProperty(t,e,E){return e in t?Object.defineProperty(t,e,{value:E,enumerable:!0,configurable:!0,writable:!0}):t[e]=E,t}var States={NOT_RESPONDER:"NOT_RESPONDER",RESPONDER_INACTIVE_PRESS_IN:"RESPONDER_INACTIVE_PRESS_IN",RESPONDER_INACTIVE_PRESS_OUT:"RESPONDER_INACTIVE_PRESS_OUT",RESPONDER_ACTIVE_PRESS_IN:"RESPONDER_ACTIVE_PRESS_IN",RESPONDER_ACTIVE_PRESS_OUT:"RESPONDER_ACTIVE_PRESS_OUT",RESPONDER_ACTIVE_LONG_PRESS_IN:"RESPONDER_ACTIVE_LONG_PRESS_IN",RESPONDER_ACTIVE_LONG_PRESS_OUT:"RESPONDER_ACTIVE_LONG_PRESS_OUT",ERROR:"ERROR"},IsActive={RESPONDER_ACTIVE_PRESS_OUT:!0,RESPONDER_ACTIVE_PRESS_IN:!0},IsPressingIn={RESPONDER_INACTIVE_PRESS_IN:!0,RESPONDER_ACTIVE_PRESS_IN:!0,RESPONDER_ACTIVE_LONG_PRESS_IN:!0},IsLongPressingIn={RESPONDER_ACTIVE_LONG_PRESS_IN:!0},Signals={DELAY:"DELAY",RESPONDER_GRANT:"RESPONDER_GRANT",RESPONDER_RELEASE:"RESPONDER_RELEASE",RESPONDER_TERMINATED:"RESPONDER_TERMINATED",ENTER_PRESS_RECT:"ENTER_PRESS_RECT",LEAVE_PRESS_RECT:"LEAVE_PRESS_RECT",LONG_PRESS_DETECTED:"LONG_PRESS_DETECTED"},Transitions={NOT_RESPONDER:{DELAY:States.ERROR,RESPONDER_GRANT:States.RESPONDER_INACTIVE_PRESS_IN,RESPONDER_RELEASE:States.ERROR,RESPONDER_TERMINATED:States.ERROR,ENTER_PRESS_RECT:States.ERROR,LEAVE_PRESS_RECT:States.ERROR,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_INACTIVE_PRESS_IN:{DELAY:States.RESPONDER_ACTIVE_PRESS_IN,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_INACTIVE_PRESS_OUT:{DELAY:States.RESPONDER_ACTIVE_PRESS_OUT,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_INACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_ACTIVE_PRESS_IN:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.RESPONDER_ACTIVE_LONG_PRESS_IN},RESPONDER_ACTIVE_PRESS_OUT:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},RESPONDER_ACTIVE_LONG_PRESS_IN:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_OUT,LONG_PRESS_DETECTED:States.RESPONDER_ACTIVE_LONG_PRESS_IN},RESPONDER_ACTIVE_LONG_PRESS_OUT:{DELAY:States.ERROR,RESPONDER_GRANT:States.ERROR,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_IN,LEAVE_PRESS_RECT:States.RESPONDER_ACTIVE_LONG_PRESS_OUT,LONG_PRESS_DETECTED:States.ERROR},error:{DELAY:States.NOT_RESPONDER,RESPONDER_GRANT:States.RESPONDER_INACTIVE_PRESS_IN,RESPONDER_RELEASE:States.NOT_RESPONDER,RESPONDER_TERMINATED:States.NOT_RESPONDER,ENTER_PRESS_RECT:States.NOT_RESPONDER,LEAVE_PRESS_RECT:States.NOT_RESPONDER,LONG_PRESS_DETECTED:States.NOT_RESPONDER}},HIGHLIGHT_DELAY_MS=130,PRESS_EXPAND_PX=20,LONG_PRESS_THRESHOLD=500,LONG_PRESS_DELAY_MS=LONG_PRESS_THRESHOLD-HIGHLIGHT_DELAY_MS,LONG_PRESS_ALLOWED_MOVEMENT=10,TouchableMixin={componentDidMount:function(){var e=this;this._touchableNode=(0,_findNodeHandle.default)(this),this._touchableNode&&this._touchableNode.addEventListener&&(this._touchableBlurListener=function(t){e._isTouchableKeyboardActive&&(e.state.touchable.touchState&&e.state.touchable.touchState!==States.NOT_RESPONDER&&e.touchableHandleResponderTerminate({nativeEvent:t}),e._isTouchableKeyboardActive=!1)},this._touchableNode.addEventListener("blur",this._touchableBlurListener))},componentWillUnmount:function(){this._touchableNode&&this._touchableNode.addEventListener&&this._touchableNode.removeEventListener("blur",this._touchableBlurListener),this.touchableDelayTimeout&&clearTimeout(this.touchableDelayTimeout),this.longPressDelayTimeout&&clearTimeout(this.longPressDelayTimeout),this.pressOutDelayTimeout&&clearTimeout(this.pressOutDelayTimeout)},touchableGetInitialState:function(){return{touchable:{touchState:void 0,responderID:null}}},touchableHandleResponderTerminationRequest:function(){return!this.props.rejectResponderTermination},touchableHandleStartShouldSetResponder:function(){return!this.props.disabled},touchableLongPressCancelsPress:function(){return!0},touchableHandleResponderGrant:function(t){var e=t.currentTarget;t.persist(),this.pressOutDelayTimeout&&clearTimeout(this.pressOutDelayTimeout),this.pressOutDelayTimeout=null,this.state.touchable.touchState=States.NOT_RESPONDER,this.state.touchable.responderID=e,this._receiveSignal(Signals.RESPONDER_GRANT,t);var E=void 0!==this.touchableGetHighlightDelayMS?Math.max(this.touchableGetHighlightDelayMS(),0):HIGHLIGHT_DELAY_MS;0!==(E=isNaN(E)?HIGHLIGHT_DELAY_MS:E)?this.touchableDelayTimeout=setTimeout(this._handleDelay.bind(this,t),E):(this.state.touchable.positionOnActivate=null,this._handleDelay(t));var s=void 0!==this.touchableGetLongPressDelayMS?Math.max(this.touchableGetLongPressDelayMS(),10):LONG_PRESS_DELAY_MS,s=isNaN(s)?LONG_PRESS_DELAY_MS:s;this.longPressDelayTimeout=setTimeout(this._handleLongDelay.bind(this,t),s+E)},touchableHandleResponderRelease:function(t){this._receiveSignal(Signals.RESPONDER_RELEASE,t)},touchableHandleResponderTerminate:function(t){this._receiveSignal(Signals.RESPONDER_TERMINATED,t)},touchableHandleResponderMove:function(t){var e,E,s,i,R,a,S,o,_,n,l,r;this.state.touchable.touchState!==States.RESPONDER_INACTIVE_PRESS_IN&&this.state.touchable.positionOnActivate&&(e=this.state.touchable.positionOnActivate,E=this.state.touchable.dimensionsOnActivate,i=(s=this.touchableGetPressRectOffset?this.touchableGetPressRectOffset():{left:PRESS_EXPAND_PX,right:PRESS_EXPAND_PX,top:PRESS_EXPAND_PX,bottom:PRESS_EXPAND_PX}).left,R=s.top,a=s.right,S=s.bottom,(o=this.touchableGetHitSlop?this.touchableGetHitSlop():null)&&(i+=o.left,R+=o.top,a+=o.right,S+=o.bottom),n=(_=_TouchEventUtils.default.extractSingleTouch(t.nativeEvent))&&_.pageX,l=_&&_.pageY,this.pressInLocation&&(r=this._getDistanceBetweenPoints(n,l,this.pressInLocation.pageX,this.pressInLocation.pageY),LONG_PRESS_ALLOWED_MOVEMENT<r&&this._cancelLongPressDelayTimeout()),n>e.left-i&&l>e.top-R&&n<e.left+E.width+a&&l<e.top+E.height+S?(this._receiveSignal(Signals.ENTER_PRESS_RECT,t),this.state.touchable.touchState===States.RESPONDER_INACTIVE_PRESS_IN&&this._cancelLongPressDelayTimeout()):(this._cancelLongPressDelayTimeout(),this._receiveSignal(Signals.LEAVE_PRESS_RECT,t)))},_remeasureMetricsOnActivation:function(){var t=this.state.touchable.responderID;null!=t&&_UIManager.default.measure(t,this._handleQueryLayout)},_handleQueryLayout:function(t,e,E,s,i,R){(t||e||E||s||i||R)&&(this.state.touchable.positionOnActivate&&_Position.default.release(this.state.touchable.positionOnActivate),this.state.touchable.dimensionsOnActivate&&_BoundingDimensions.default.release(this.state.touchable.dimensionsOnActivate),this.state.touchable.positionOnActivate=_Position.default.getPooled(i,R),this.state.touchable.dimensionsOnActivate=_BoundingDimensions.default.getPooled(E,s))},_handleDelay:function(t){this.touchableDelayTimeout=null,this._receiveSignal(Signals.DELAY,t)},_handleLongDelay:function(t){this.longPressDelayTimeout=null;var e=this.state.touchable.touchState;e!==States.RESPONDER_ACTIVE_PRESS_IN&&e!==States.RESPONDER_ACTIVE_LONG_PRESS_IN?console.error("Attempted to transition from state `"+e+"` to `"+States.RESPONDER_ACTIVE_LONG_PRESS_IN+"`, which is not supported. This is most likely due to `Touchable.longPressDelayTimeout` not being cancelled."):this._receiveSignal(Signals.LONG_PRESS_DETECTED,t)},_receiveSignal:function(t,e){var E=this.state.touchable.responderID,s=this.state.touchable.touchState,i=Transitions[s]&&Transitions[s][t];if(E||t!==Signals.RESPONDER_RELEASE){if(!i)throw new Error("Unrecognized signal `"+t+"` or state `"+s+"` for Touchable responder `"+E+"`");if(i===States.ERROR)throw new Error("Touchable cannot transition from `"+s+"` to `"+t+"` for responder `"+E+"`");s!==i&&(this._performSideEffectsForTransition(s,i,t,e),this.state.touchable.touchState=i)}},_cancelLongPressDelayTimeout:function(){this.longPressDelayTimeout&&clearTimeout(this.longPressDelayTimeout),this.longPressDelayTimeout=null},_isHighlight:function(t){return t===States.RESPONDER_ACTIVE_PRESS_IN||t===States.RESPONDER_ACTIVE_LONG_PRESS_IN},_savePressInLocation:function(t){var e=_TouchEventUtils.default.extractSingleTouch(t.nativeEvent),E=e&&e.pageX,s=e&&e.pageY;this.pressInLocation={pageX:E,pageY:s,get locationX(){return e&&e.locationX},get locationY(){return e&&e.locationY}}},_getDistanceBetweenPoints:function(t,e,E,s){var i=t-E,R=e-s;return Math.sqrt(i*i+R*R)},_performSideEffectsForTransition:function(t,e,E,s){var i,R,a=this._isHighlight(t),S=this._isHighlight(e);E!==Signals.RESPONDER_TERMINATED&&E!==Signals.RESPONDER_RELEASE||this._cancelLongPressDelayTimeout(),!IsActive[t]&&IsActive[e]&&this._remeasureMetricsOnActivation(),IsPressingIn[t]&&E===Signals.LONG_PRESS_DETECTED&&this.touchableHandleLongPress&&this.touchableHandleLongPress(s),S&&!a?this._startHighlight(s):!S&&a&&this._endHighlight(s),IsPressingIn[t]&&E===Signals.RESPONDER_RELEASE&&(i=!!this.props.onLongPress,R=IsLongPressingIn[t]&&(!i||!this.touchableLongPressCancelsPress()),IsLongPressingIn[t]&&!R||!this.touchableHandlePress||(S||a||(this._startHighlight(s),this._endHighlight(s)),this.touchableHandlePress(s))),this.touchableDelayTimeout&&clearTimeout(this.touchableDelayTimeout),this.touchableDelayTimeout=null},_startHighlight:function(t){this._savePressInLocation(t),this.touchableHandleActivePressIn&&this.touchableHandleActivePressIn(t)},_endHighlight:function(t){var e=this;this.touchableHandleActivePressOut&&(this.touchableGetPressOutDelayMS&&this.touchableGetPressOutDelayMS()?this.pressOutDelayTimeout=setTimeout(function(){e.touchableHandleActivePressOut(t)},this.touchableGetPressOutDelayMS()):this.touchableHandleActivePressOut(t))},touchableHandleKeyEvent:function(t){var e=t.type,E=t.which;13!==E&&32!==E||("keydown"===e?this._isTouchableKeyboardActive||this.state.touchable.touchState&&this.state.touchable.touchState!==States.NOT_RESPONDER||(this.touchableHandleResponderGrant(t),this._isTouchableKeyboardActive=!0):"keyup"===e&&this._isTouchableKeyboardActive&&this.state.touchable.touchState&&this.state.touchable.touchState!==States.NOT_RESPONDER&&(this.touchableHandleResponderRelease(t),this._isTouchableKeyboardActive=!1),t.stopPropagation(),13===E&&"link"===_AccessibilityUtil.default.propsToAriaRole(this.props)||t.preventDefault())}},Touchable={Mixin:TouchableMixin,TOUCH_TARGET_DEBUG:!1,renderDebugView:function(t){var e=t.color,E=t.hitSlop;if("production"!==process.env.NODE_ENV){if(!Touchable.TOUCH_TARGET_DEBUG)return null;var s={},E=E||{top:0,bottom:0,left:0,right:0};for(var i in E)s[i]=-E[i];var R="#"+("00000000"+(0,_normalizeCssColor.default)(e).toString(16)).substr(-8);return _react.default.createElement(_View.default,{pointerEvents:"none",style:_objectSpread({position:"absolute",borderColor:R.slice(0,-2)+"55",borderWidth:1,borderStyle:"dashed",backgroundColor:R.slice(0,-2)+"0F"},s)})}}},_default=Touchable;exports.default=Touchable,module.exports=exports.default;