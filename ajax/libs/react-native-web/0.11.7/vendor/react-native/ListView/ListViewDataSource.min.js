"use strict";import invariant from"fbjs/lib/invariant";import isEmpty from"../isEmpty";import warning from"fbjs/lib/warning";function defaultGetRowData(t,e,i){return t[e][i]}function defaultGetSectionHeaderData(t,e){return t[e]}var ListViewDataSource=function(){function t(t){invariant(t&&"function"==typeof t.rowHasChanged,"Must provide a rowHasChanged function."),this._rowHasChanged=t.rowHasChanged,this._getRowData=t.getRowData||defaultGetRowData,this._sectionHeaderHasChanged=t.sectionHeaderHasChanged,this._getSectionHeaderData=t.getSectionHeaderData||defaultGetSectionHeaderData,this._dataBlob=null,this._dirtyRows=[],this._dirtySections=[],this._cachedRowCount=0,this.rowIdentities=[],this.sectionIdentities=[]}var e=t.prototype;return e.cloneWithRows=function(t,e){var i=e?[[].concat(e)]:null;return this._sectionHeaderHasChanged||(this._sectionHeaderHasChanged=function(){return!1}),this.cloneWithRowsAndSections({s1:t},["s1"],i)},e.cloneWithRowsAndSections=function(e,i,n){invariant("function"==typeof this._sectionHeaderHasChanged,"Must provide a sectionHeaderHasChanged function with section data."),invariant(!i||!n||i.length===n.length,"row and section ids lengths must be the same");var a=new t({getRowData:this._getRowData,getSectionHeaderData:this._getSectionHeaderData,rowHasChanged:this._rowHasChanged,sectionHeaderHasChanged:this._sectionHeaderHasChanged});return a._dataBlob=e,a.sectionIdentities=i||Object.keys(e),n?a.rowIdentities=n:(a.rowIdentities=[],a.sectionIdentities.forEach(function(t){a.rowIdentities.push(Object.keys(e[t]))})),a._cachedRowCount=countRows(a.rowIdentities),a._calculateDirtyArrays(this._dataBlob,this.sectionIdentities,this.rowIdentities),a},e.getRowCount=function(){return this._cachedRowCount},e.getRowAndSectionCount=function(){return this._cachedRowCount+this.sectionIdentities.length},e.rowShouldUpdate=function(t,e){var i=this._dirtyRows[t][e];return warning(void 0!==i,"missing dirtyBit for section, row: "+t+", "+e),i},e.getRowData=function(t,e){var i=this.sectionIdentities[t],n=this.rowIdentities[t][e];return warning(void 0!==i&&void 0!==n,"rendering invalid section, row: "+t+", "+e),this._getRowData(this._dataBlob,i,n)},e.getRowIDForFlatIndex=function(t){for(var e=t,i=0;i<this.sectionIdentities.length;i++){if(!(e>=this.rowIdentities[i].length))return this.rowIdentities[i][e];e-=this.rowIdentities[i].length}return null},e.getSectionIDForFlatIndex=function(t){for(var e=t,i=0;i<this.sectionIdentities.length;i++){if(!(e>=this.rowIdentities[i].length))return this.sectionIdentities[i];e-=this.rowIdentities[i].length}return null},e.getSectionLengths=function(){for(var t=[],e=0;e<this.sectionIdentities.length;e++)t.push(this.rowIdentities[e].length);return t},e.sectionHeaderShouldUpdate=function(t){var e=this._dirtySections[t];return warning(void 0!==e,"missing dirtyBit for section: "+t),e},e.getSectionHeaderData=function(t){if(!this._getSectionHeaderData)return null;var e=this.sectionIdentities[t];return warning(void 0!==e,"renderSection called on invalid section: "+t),this._getSectionHeaderData(this._dataBlob,e)},e._calculateDirtyArrays=function(t,e,i){for(var n,a=keyedDictionaryFromArray(e),o={},r=0;r<i.length;r++){var s=e[r];warning(!o[s],"SectionID appears more than once: "+s),o[s]=keyedDictionaryFromArray(i[r])}this._dirtySections=[],this._dirtyRows=[];for(var d=0;d<this.sectionIdentities.length;d++){n=!a[s=this.sectionIdentities[d]];var h=this._sectionHeaderHasChanged;!n&&h&&(n=h(this._getSectionHeaderData(t,s),this._getSectionHeaderData(this._dataBlob,s))),this._dirtySections.push(!!n),this._dirtyRows[d]=[];for(var c=0;c<this.rowIdentities[d].length;c++){var u=this.rowIdentities[d][c];n=!a[s]||!o[s][u]||this._rowHasChanged(this._getRowData(t,s,u),this._getRowData(this._dataBlob,s,u)),this._dirtyRows[d].push(!!n)}}},t}();function countRows(t){for(var e=0,i=0;i<t.length;i++){e+=t[i].length}return e}function keyedDictionaryFromArray(t){if(isEmpty(t))return{};for(var e={},i=0;i<t.length;i++){var n=t[i];warning(!e[n],"Value appears more than once in array: "+n),e[n]=!0}return e}export default ListViewDataSource;