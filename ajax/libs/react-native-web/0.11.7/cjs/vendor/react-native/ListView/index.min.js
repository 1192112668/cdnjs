"use strict";exports.__esModule=!0,exports.default=void 0;var _ListViewDataSource=_interopRequireDefault(require("./ListViewDataSource")),_Platform=_interopRequireDefault(require("../../../exports/Platform")),_react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_findNodeHandle=_interopRequireDefault(require("../../../exports/findNodeHandle")),_NativeModules=_interopRequireDefault(require("../../../exports/NativeModules")),_ScrollView=_interopRequireDefault(require("../../../exports/ScrollView")),_ScrollResponder=_interopRequireDefault(require("../../../modules/ScrollResponder")),_StaticRenderer=_interopRequireDefault(require("../StaticRenderer")),_reactTimerMixin=_interopRequireDefault(require("react-timer-mixin")),_View=_interopRequireDefault(require("../../../exports/View")),_cloneReferencedElement=_interopRequireDefault(require("./cloneReferencedElement")),_createReactClass=_interopRequireDefault(require("create-react-class")),_isEmpty=_interopRequireDefault(require("../isEmpty"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};for(var o,r={},n=Object.keys(e),i=0;i<n.length;i++)o=n[i],0<=t.indexOf(o)||(r[o]=e[o]);return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{},r=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,o[e])})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var merge=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];return Object.assign.apply(Object,[{}].concat(t))},RCTScrollViewManager=_NativeModules.default.ScrollViewManager,DEFAULT_PAGE_SIZE=1,DEFAULT_INITIAL_ROWS=10,DEFAULT_SCROLL_RENDER_AHEAD=1e3,DEFAULT_END_REACHED_THRESHOLD=1e3,DEFAULT_SCROLL_CALLBACK_THROTTLE=50,ListView=(0,_createReactClass.default)({displayName:"ListView",_childFrames:[],_sentEndForContentLength:null,_scrollComponent:null,_prevRenderedRowsCount:0,_visibleRows:{},scrollProperties:{},mixins:[_ScrollResponder.default.Mixin,_reactTimerMixin.default],statics:{DataSource:_ListViewDataSource.default},propTypes:_objectSpread({},_ScrollView.default.propTypes,{dataSource:_propTypes.default.instanceOf(_ListViewDataSource.default).isRequired,renderSeparator:_propTypes.default.func,renderRow:_propTypes.default.func.isRequired,initialListSize:_propTypes.default.number.isRequired,onEndReached:_propTypes.default.func,onEndReachedThreshold:_propTypes.default.number.isRequired,pageSize:_propTypes.default.number.isRequired,renderFooter:_propTypes.default.func,renderHeader:_propTypes.default.func,renderSectionHeader:_propTypes.default.func,renderScrollComponent:_propTypes.default.func.isRequired,scrollRenderAheadDistance:_propTypes.default.number.isRequired,onChangeVisibleRows:_propTypes.default.func,removeClippedSubviews:_propTypes.default.bool,stickySectionHeadersEnabled:_propTypes.default.bool,stickyHeaderIndices:_propTypes.default.arrayOf(_propTypes.default.number).isRequired,enableEmptySections:_propTypes.default.bool}),getMetrics:function(){return{contentLength:this.scrollProperties.contentLength,totalRows:this.props.enableEmptySections?this.props.dataSource.getRowAndSectionCount():this.props.dataSource.getRowCount(),renderedRows:this.state.curRenderedRowsCount,visibleRows:Object.keys(this._visibleRows).length}},getScrollResponder:function(){if(this._scrollComponent&&this._scrollComponent.getScrollResponder)return this._scrollComponent.getScrollResponder()},getScrollableNode:function(){return this._scrollComponent&&this._scrollComponent.getScrollableNode?this._scrollComponent.getScrollableNode():(0,_findNodeHandle.default)(this._scrollComponent)},scrollTo:function(){var e;this._scrollComponent&&this._scrollComponent.scrollTo&&(e=this._scrollComponent).scrollTo.apply(e,arguments)},scrollToEnd:function(e){this._scrollComponent&&(this._scrollComponent.scrollToEnd?this._scrollComponent.scrollToEnd(e):console.warn("The scroll component used by the ListView does not support scrollToEnd. Check the renderScrollComponent prop of your ListView."))},flashScrollIndicators:function(){this._scrollComponent&&this._scrollComponent.flashScrollIndicators&&this._scrollComponent.flashScrollIndicators()},setNativeProps:function(e){this._scrollComponent&&this._scrollComponent.setNativeProps(e)},getDefaultProps:function(){return{initialListSize:DEFAULT_INITIAL_ROWS,pageSize:DEFAULT_PAGE_SIZE,renderScrollComponent:function(e){return _react.default.createElement(_ScrollView.default,e)},scrollRenderAheadDistance:DEFAULT_SCROLL_RENDER_AHEAD,onEndReachedThreshold:DEFAULT_END_REACHED_THRESHOLD,stickySectionHeadersEnabled:"ios"===_Platform.default.OS||"web"===_Platform.default.OS,stickyHeaderIndices:[]}},getInitialState:function(){return{curRenderedRowsCount:this.props.initialListSize,highlightedRow:{}}},getInnerViewNode:function(){return this._scrollComponent.getInnerViewNode()},UNSAFE_componentWillMount:function(){this.scrollProperties={visibleLength:null,contentLength:null,offset:0},this._childFrames=[],this._visibleRows={},this._prevRenderedRowsCount=0,this._sentEndForContentLength=null},componentDidMount:function(){var e=this;this.requestAnimationFrame(function(){e._measureAndUpdateScrollProps()})},UNSAFE_componentWillReceiveProps:function(e){var o=this;this.props.dataSource===e.dataSource&&this.props.initialListSize===e.initialListSize||this.setState(function(e,t){return o._prevRenderedRowsCount=0,{curRenderedRowsCount:Math.min(Math.max(e.curRenderedRowsCount,t.initialListSize),t.enableEmptySections?t.dataSource.getRowAndSectionCount():t.dataSource.getRowCount())}},function(){return o._renderMoreRowsIfNeeded()})},componentDidUpdate:function(){var e=this;this.requestAnimationFrame(function(){e._measureAndUpdateScrollProps()})},_onRowHighlighted:function(e,t){this.setState({highlightedRow:{sectionID:e,rowID:t}})},render:function(){for(var e=[],t=this.props.dataSource,o=t.rowIdentities,r=0,n=[],i=this.props.renderSectionHeader,s=this.props.renderHeader&&this.props.renderHeader(),l=this.props.renderFooter&&this.props.renderFooter(),a=s?1:0,d=0;d<o.length;d++){var p,c=t.sectionIdentities[d],u=o[d];if(0===u.length){if(void 0===this.props.enableEmptySections){require("fbjs/lib/warning")(!1,"In next release empty section headers will be rendered. In this release you can use 'enableEmptySections' flag to render empty section headers.");continue}require("fbjs/lib/invariant")(this.props.enableEmptySections,"In next release 'enableEmptySections' flag will be deprecated, empty section headers will always be rendered. If empty section headers are not desirable their indices should be excluded from sectionIDs object. In this release 'enableEmptySections' may only have value 'true' to allow empty section headers rendering.")}!i||(p=i(t.getSectionHeaderData(d),c))&&(e.push(_react.default.cloneElement(p,{key:"s_"+c})),this.props.stickySectionHeadersEnabled&&n.push(a),a++);for(var h=0;h<u.length;h++){var _,f,R=u[h],S=c+"_"+R,w=r>=this._prevRenderedRowsCount&&t.rowShouldUpdate(d,h),g=_react.default.createElement(_StaticRenderer.default,{key:"r_"+S,shouldUpdate:!!w,render:this.props.renderRow.bind(null,t.getRowData(d,h),c,R,this._onRowHighlighted)});if(e.push(g),a++,!this.props.renderSeparator||h===u.length-1&&d!==o.length-1||(_=this.state.highlightedRow.sectionID===c&&(this.state.highlightedRow.rowID===R||this.state.highlightedRow.rowID===u[h+1]),(f=this.props.renderSeparator(c,R,_))&&(e.push(_react.default.createElement(_View.default,{key:"s_"+S},f)),a++)),++r===this.state.curRenderedRowsCount)break}if(r>=this.state.curRenderedRowsCount)break}var m=this.props,C=m.renderScrollComponent,b=_objectWithoutPropertiesLoose(m,["renderScrollComponent"]);return b.scrollEventThrottle||(b.scrollEventThrottle=DEFAULT_SCROLL_CALLBACK_THROTTLE),void 0===b.removeClippedSubviews&&(b.removeClippedSubviews=!0),Object.assign(b,{onScroll:this._onScroll,stickyHeaderIndices:this.props.stickyHeaderIndices.concat(n),onKeyboardWillShow:void 0,onKeyboardWillHide:void 0,onKeyboardDidShow:void 0,onKeyboardDidHide:void 0}),(0,_cloneReferencedElement.default)(C(b),{ref:this._setScrollComponentRef,onContentSizeChange:this._onContentSizeChange,onLayout:this._onLayout,DEPRECATED_sendUpdatedChildFrames:(b.onChangeVisibleRows,!0)},s,e,l)},_measureAndUpdateScrollProps:function(){var e=this.getScrollResponder();e&&e.getInnerViewNode&&RCTScrollViewManager&&RCTScrollViewManager.calculateChildFrames&&RCTScrollViewManager.calculateChildFrames((0,_findNodeHandle.default)(e),this._updateVisibleRows)},_setScrollComponentRef:function(e){this._scrollComponent=e},_onContentSizeChange:function(e,t){var o=this.props.horizontal?e:t;o!==this.scrollProperties.contentLength&&(this.scrollProperties.contentLength=o,this._updateVisibleRows(),this._renderMoreRowsIfNeeded()),this.props.onContentSizeChange&&this.props.onContentSizeChange(e,t)},_onLayout:function(e){var t=e.nativeEvent.layout,o=t.width,r=t.height,n=this.props.horizontal?o:r;n!==this.scrollProperties.visibleLength&&(this.scrollProperties.visibleLength=n,this._updateVisibleRows(),this._renderMoreRowsIfNeeded()),this.props.onLayout&&this.props.onLayout(e)},_maybeCallOnEndReached:function(e){return!!(this.props.onEndReached&&this.scrollProperties.contentLength!==this._sentEndForContentLength&&this._getDistanceFromEnd(this.scrollProperties)<this.props.onEndReachedThreshold&&this.state.curRenderedRowsCount===(this.props.enableEmptySections?this.props.dataSource.getRowAndSectionCount():this.props.dataSource.getRowCount()))&&(this._sentEndForContentLength=this.scrollProperties.contentLength,this.props.onEndReached(e),!0)},_renderMoreRowsIfNeeded:function(){null!==this.scrollProperties.contentLength&&null!==this.scrollProperties.visibleLength&&this.state.curRenderedRowsCount!==(this.props.enableEmptySections?this.props.dataSource.getRowAndSectionCount():this.props.dataSource.getRowCount())?this._getDistanceFromEnd(this.scrollProperties)<this.props.scrollRenderAheadDistance&&this._pageInNewRows():this._maybeCallOnEndReached()},_pageInNewRows:function(){var r=this;this.setState(function(e,t){var o=Math.min(e.curRenderedRowsCount+t.pageSize,t.enableEmptySections?t.dataSource.getRowAndSectionCount():t.dataSource.getRowCount());return r._prevRenderedRowsCount=e.curRenderedRowsCount,{curRenderedRowsCount:o}},function(){r._measureAndUpdateScrollProps(),r._prevRenderedRowsCount=r.state.curRenderedRowsCount})},_getDistanceFromEnd:function(e){return e.contentLength-e.visibleLength-e.offset},_updateVisibleRows:function(e){var t=this;if(this.props.onChangeVisibleRows){e&&e.forEach(function(e){t._childFrames[e.index]=merge(e)});for(var o=!this.props.horizontal,r=this.props.dataSource,n=this.scrollProperties.offset,i=n+this.scrollProperties.visibleLength,s=r.rowIdentities,l=this.props.renderHeader&&this.props.renderHeader()?1:0,a=!1,d={},p=0;p<s.length;p++){var c=s[p];if(0!==c.length){var u=r.sectionIdentities[p];this.props.renderSectionHeader&&l++;for(var h=(h=this._visibleRows[u])||{},_=0;_<c.length;_++){var f=c[_],R=this._childFrames[l];if(l++,!this.props.renderSeparator||_===c.length-1&&p!==s.length-1||l++,!R)break;var S=h[f],w=o?R.y:R.x,g=w+(o?R.height:R.width);if(!w&&!g||w===g)break;i<w||g<n?S&&(a=!0,delete h[f],d[u]||(d[u]={}),d[u][f]=!1):S||(a=!0,h[f]=!0,d[u]||(d[u]={}),d[u][f]=!0)}(0,_isEmpty.default)(h)?this._visibleRows[u]&&delete this._visibleRows[u]:this._visibleRows[u]=h}}a&&this.props.onChangeVisibleRows(this._visibleRows,d)}},_onScroll:function(e){var t=!this.props.horizontal;this.scrollProperties.visibleLength=e.nativeEvent.layoutMeasurement[t?"height":"width"],this.scrollProperties.contentLength=e.nativeEvent.contentSize[t?"height":"width"],this.scrollProperties.offset=e.nativeEvent.contentOffset[t?"y":"x"],this._updateVisibleRows(e.nativeEvent.updatedChildFrames),this._maybeCallOnEndReached(e)||this._renderMoreRowsIfNeeded(),this.props.onEndReached&&this._getDistanceFromEnd(this.scrollProperties)>this.props.onEndReachedThreshold&&(this._sentEndForContentLength=null),this.props.onScroll&&this.props.onScroll(e)}}),_default=ListView;exports.default=ListView,module.exports=exports.default;