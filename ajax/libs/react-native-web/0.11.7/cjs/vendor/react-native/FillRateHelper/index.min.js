"use strict";exports.__esModule=!0,exports.default=void 0;var _performanceNow=_interopRequireDefault(require("fbjs/lib/performanceNow")),_warning=_interopRequireDefault(require("fbjs/lib/warning"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),a.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var Info=function(){this.any_blank_count=0,this.any_blank_ms=0,this.any_blank_speed_sum=0,this.mostly_blank_count=0,this.mostly_blank_ms=0,this.pixels_blank=0,this.pixels_sampled=0,this.pixels_scrolled=0,this.total_time_spent=0,this.sample_count=0},DEBUG=!1,_listeners=[],_minSampleCount=10,_sampleRate=DEBUG?1:null,FillRateHelper=function(){function t(t){this._anyBlankStartTime=null,this._enabled=!1,this._info=new Info,this._mostlyBlankStartTime=null,this._samplesStartTime=null,this._getFrameMetrics=t,this._enabled=(_sampleRate||0)>Math.random(),this._resetData()}t.addListener=function(e){return(0,_warning.default)(null!==_sampleRate,"Call `FillRateHelper.setSampleRate` before `addListener`."),_listeners.push(e),{remove:function(){_listeners=_listeners.filter(function(t){return e!==t})}}},t.setSampleRate=function(t){_sampleRate=t},t.setMinSampleCount=function(t){_minSampleCount=t};var e=t.prototype;return e.activate=function(){this._enabled&&null==this._samplesStartTime&&(DEBUG&&console.debug("FillRateHelper: activate"),this._samplesStartTime=(0,_performanceNow.default)())},e.deactivateAndFlush=function(){if(this._enabled){var t=this._samplesStartTime;if(null!=t)if(this._info.sample_count<_minSampleCount)this._resetData();else{var e=(0,_performanceNow.default)()-t,n=_objectSpread({},this._info,{total_time_spent:e});if(DEBUG){var a={avg_blankness:this._info.pixels_blank/this._info.pixels_sampled,avg_speed:this._info.pixels_scrolled/(e/1e3),avg_speed_when_any_blank:this._info.any_blank_speed_sum/this._info.any_blank_count,any_blank_per_min:this._info.any_blank_count/(e/1e3/60),any_blank_time_frac:this._info.any_blank_ms/e,mostly_blank_per_min:this._info.mostly_blank_count/(e/1e3/60),mostly_blank_time_frac:this._info.mostly_blank_ms/e};for(var i in a)a[i]=Math.round(1e3*a[i])/1e3;console.debug("FillRateHelper deactivateAndFlush: ",{derived:a,info:n})}_listeners.forEach(function(t){return t(n)}),this._resetData()}else DEBUG&&console.debug("FillRateHelper: bail on deactivate with no start time")}},e.computeBlankness=function(t,e,n){if(!this._enabled||0===t.getItemCount(t.data)||null==this._samplesStartTime)return 0;var a=n.dOffset,i=n.offset,l=n.velocity,s=n.visibleLength;this._info.sample_count++,this._info.pixels_sampled+=Math.round(s),this._info.pixels_scrolled+=Math.round(Math.abs(a));var r=Math.round(1e3*Math.abs(l)),_=(0,_performanceNow.default)();null!=this._anyBlankStartTime&&(this._info.any_blank_ms+=_-this._anyBlankStartTime),(this._anyBlankStartTime=null)!=this._mostlyBlankStartTime&&(this._info.mostly_blank_ms+=_-this._mostlyBlankStartTime),this._mostlyBlankStartTime=null;for(var o=0,u=e.first,m=this._getFrameMetrics(u);u<=e.last&&(!m||!m.inLayout);)m=this._getFrameMetrics(u),u++;m&&0<u&&(o=Math.min(s,Math.max(0,m.offset-i)));for(var f,h=0,p=e.last,c=this._getFrameMetrics(p);p>=e.first&&(!c||!c.inLayout);)c=this._getFrameMetrics(p),p--;c&&p<t.getItemCount(t.data)-1&&(f=c.offset+c.length,h=Math.min(s,Math.max(0,i+s-f)));var d=Math.round(o+h),b=d/s;return 0<b?(this._anyBlankStartTime=_,this._info.any_blank_speed_sum+=r,this._info.any_blank_count++,this._info.pixels_blank+=d,.5<b&&(this._mostlyBlankStartTime=_,this._info.mostly_blank_count++)):(r<.01||Math.abs(a)<1)&&this.deactivateAndFlush(),b},e.enabled=function(){return this._enabled},e._resetData=function(){this._anyBlankStartTime=null,this._info=new Info,this._mostlyBlankStartTime=null,this._samplesStartTime=null},t}(),_default=FillRateHelper;exports.default=FillRateHelper,module.exports=exports.default;