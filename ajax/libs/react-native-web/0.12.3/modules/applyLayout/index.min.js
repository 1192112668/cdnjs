import{canUseDOM}from"fbjs/lib/ExecutionEnvironment";import debounce from"debounce";import findNodeHandle from"../../exports/findNodeHandle";var resizeObserver,emptyObject={},registry={},id=1,guid=function(){return"r-"+id++};if(canUseDOM)if(void 0!==window.ResizeObserver)resizeObserver=new window.ResizeObserver(function(e){e.forEach(function(e){var t=e.target,o=registry[t._layoutId];o&&o._handleLayout()})});else{"production"!==process.env.NODE_ENV&&"test"!==process.env.NODE_ENV&&console.warn("onLayout relies on ResizeObserver which is not supported by your browser. Please include a polyfill, e.g., https://github.com/que-etc/resize-observer-polyfill. Falling back to window.onresize.");var triggerAll=function(){Object.keys(registry).forEach(function(e){registry[e]._handleLayout()})};window.addEventListener("resize",debounce(triggerAll,16),!1)}var observe=function(e){var t=guid();if(registry[t]=e,resizeObserver){var o=findNodeHandle(e);o&&(o._layoutId=t,resizeObserver.observe(o))}else e._layoutId=t,e._handleLayout()},unobserve=function(e){if(resizeObserver){var t=findNodeHandle(e);t&&(delete registry[t._layoutId],delete t._layoutId,resizeObserver.unobserve(t))}else delete registry[e._layoutId],delete e._layoutId},safeOverride=function(e,t){return e?function(){e.call(this,arguments),t.call(this,arguments)}:t},applyLayout=function(e){var t=e.prototype.componentDidMount,o=e.prototype.componentDidUpdate,r=e.prototype.componentWillUnmount;return e.prototype.componentDidMount=safeOverride(t,function(){this._layoutState=emptyObject,this._isMounted=!0,this.props.onLayout&&observe(this)}),e.prototype.componentDidUpdate=safeOverride(o,function(e){this.props.onLayout&&!e.onLayout?observe(this):!this.props.onLayout&&e.onLayout&&unobserve(this)}),e.prototype.componentWillUnmount=safeOverride(r,function(){this._isMounted=!1,this.props.onLayout&&unobserve(this)}),e.prototype._handleLayout=function(){var e=this,t=this._layoutState,o=this.props.onLayout;o&&this.measure(function(r,n,i,s){if(e._isMounted&&(t.x!==r||t.y!==n||t.width!==i||t.height!==s)){e._layoutState={x:r,y:n,width:i,height:s};var a={layout:e._layoutState};Object.defineProperty(a,"target",{enumerable:!0,get:function(){return findNodeHandle(e)}}),o({nativeEvent:a,timeStamp:Date.now()})}})},e};export default applyLayout;