"use strict";exports.__esModule=!0,exports.default=createStyleResolver;var _ExecutionEnvironment=require("fbjs/lib/ExecutionEnvironment"),_createCSSStyleSheet=_interopRequireDefault(require("./createCSSStyleSheet")),_createCompileableStyle=_interopRequireDefault(require("./createCompileableStyle")),_createOrderedCSSStyleSheet=_interopRequireDefault(require("./createOrderedCSSStyleSheet")),_flattenArray=_interopRequireDefault(require("../../modules/flattenArray")),_flattenStyle=_interopRequireDefault(require("./flattenStyle")),_I18nManager=_interopRequireDefault(require("../I18nManager")),_i18nStyle=_interopRequireDefault(require("./i18nStyle")),_compile=require("./compile"),_initialRules=_interopRequireDefault(require("./initialRules")),_modality=_interopRequireDefault(require("./modality")),_constants=require("./constants");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var emptyObject={};function createStyleResolver(){function t(){u={css:{},ltr:{},rtl:{},rtlNoSwap:{}},f=(0,_createOrderedCSSStyleSheet.default)((0,_createCSSStyleSheet.default)(_constants.STYLE_ELEMENT_ID)),S={byClassName:{},byProp:{}},(0,_modality.default)(function(e){return f.insert(e,_constants.STYLE_GROUPS.modality)}),_initialRules.default.forEach(function(e){f.insert(e,_constants.STYLE_GROUPS.reset)})}var u,f,S,y={css:{},ltr:{},rtl:{},rtlNoSwap:{}};function p(e){var t,c,r=_I18nManager.default.doLeftAndRightSwapInRTL,n=_I18nManager.default.isRTL?r?"rtl":"rtlNoSwap":"ltr";u[n][e]||(t=(0,_createCompileableStyle.default)((0,_i18nStyle.default)((0,_flattenStyle.default)(e))),c=(0,_compile.atomic)(t),Object.keys(c).forEach(function(e){var t,r,n,a=c[e],l=a.identifier,s=a.property,i=a.rules,o=a.value;t=l,r=s,n=o,S.byProp[r]||(S.byProp[r]={}),S.byProp[r][n]=t,S.byClassName[t]={prop:r,value:n},i.forEach(function(e){var t=_constants.STYLE_GROUPS.custom[s]||_constants.STYLE_GROUPS.atomic;f.insert(e,t)})}),u[n][e]=!0)}function _(e,t){var r=[],n={};if(!e&&!t)return n;if(Array.isArray(t)&&(0,_flattenArray.default)(t).forEach(function(e){var t;e&&(null==u.css[e]&&null!=y.css[e]&&((t=y.css[e]).rules.forEach(function(e){f.insert(e,t.group)}),u.css[e]=!0),r.push(e))}),"number"==typeof e){p(e);n=d(e,createCacheKey(e))}else if(Array.isArray(e)){for(var a=(0,_flattenArray.default)(e),l=!0,s="",i=0;i<a.length;i++){var o=a[i];"number"!=typeof o?l=!1:(l&&(s+=o+"-"),p(o))}n=d(a,l?createCacheKey(s):null)}else n=d(e);r.push.apply(r,n.classList);var c={className:classListToString(r),classList:r};return n.style&&(c.style=n.style),c}function d(e,t){var r=_I18nManager.default.doLeftAndRightSwapInRTL,n=_I18nManager.default.isRTL?r?"rtl":"rtlNoSwap":"ltr";if(null!=t&&null!=y[n][t])return y[n][t];var a=(0,_flattenStyle.default)(e),u=(0,_createCompileableStyle.default)((0,_i18nStyle.default)(a)),l=Object.keys(u).sort().reduce(function(a,e){var t,r,l,n,s,i,o,c=u[e];return null!=c&&(n=e,s=c,i=(0,_compile.stringifyValueWithProperty)(s,n),(t=(o=S.byProp)[n]&&o[n].hasOwnProperty(i)&&o[n][i])?a.classList.push(t):"animationKeyframes"===e||"placeholderTextColor"===e||"pointerEvents"===e||"scrollbarWidth"===e?(l=(0,_compile.atomic)(((r={})[e]=c,r)),Object.keys(l).forEach(function(e){var t=l[e],r=t.identifier,n=t.rules;a.classList.push(r),n.forEach(function(e){f.insert(e,_constants.STYLE_GROUPS.atomic)})})):(a.style||(a.style={}),a.style[e]=c)),a},{classList:[]});return l.style&&(l.style=(0,_compile.inline)(l.style)),null!=t&&(y[n][t]=l),l}return t(),{getStyleSheet:function(){var e=f.getTextContent();return _ExecutionEnvironment.canUseDOM||t(),{id:_constants.STYLE_ELEMENT_ID,textContent:e}},createCSS:function(t,s){var i={};return Object.keys(t).forEach(function(a){var e=t[a],l=(0,_compile.classic)(e,a);Object.keys(l).forEach(function(e){var t=l[e],r=t.identifier,n=t.rules;y.css[r]={group:s||_constants.STYLE_GROUPS.classic,rules:n},i[a]=r})}),i},resolve:_,sheet:f,resolveWithNode:function(e,t){function l(e){return S.byClassName[e]||emptyObject}var r=getDOMStyleInfo(t),n=r.classList,a=r.style,s=n.reduce(function(e,t){var r=l(t),n=r.prop,a=r.value;return n?e.style[n]=a:e.classList.push(t),e},{classList:[],style:{}}),i=s.classList,o=s.style,c=_([(0,_i18nStyle.default)(o),e]),u=c.classList,f=c.style,y=classListToString(u.concat(i)),p=_objectSpread({},a);return u.forEach(function(e){var t=l(e).prop;p[t]&&(p[t]="")}),Object.assign(p,f),{className:y,style:p}}}}var createCacheKey=function(e){return"rn-"+e},classListToString=function(e){return e.join(" ").trim()},hyphenPattern=/-([a-z])/g,toCamelCase=function(e){return e.replace(hyphenPattern,function(e){return e[1].toUpperCase()})},getDOMStyleInfo=function(e){for(var t=e.style,r=Array.prototype.slice.call(e.classList),n={},a=0;a<t.length;a+=1){var l=t.item(a);l&&(n[toCamelCase(l)]=t.getPropertyValue(l))}return{classList:r,style:n}};module.exports=exports.default;