"use strict";exports.__esModule=!0,exports.default=void 0;var _invariant=_interopRequireDefault(require("fbjs/lib/invariant"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var i,r=Object.keys(t);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(t),e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(i,!0).forEach(function(e){_defineProperty(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ownKeys(i).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var t=e.prototype;return t.dispose=function(){this._timers.forEach(clearTimeout)},t.computeViewableItems=function(e,t,i,r,n){var a=this._config,s=a.itemVisiblePercentThreshold,o=a.viewAreaCoveragePercentThreshold,l=null!=o,u=l?o:s;(0,_invariant.default)(null!=u&&null!=s!=(null!=o),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var c=[];if(0===e)return c;var f=-1,h=n||{first:0,last:e-1},b=h.first,v=h.last;if(e<=v)return console.warn("Invalid render range computing viewability "+JSON.stringify({renderRange:n,itemCount:e})),[];for(var d=b;d<=v;d++){var p=r(d);if(p){var _=p.offset-t,w=_+p.length;if(_<i&&0<w)f=d,_isViewable(l,u,_,w,i,p.length)&&c.push(d);else if(0<=f)break}}return c},t.onUpdate=function(e,t,i,r,n,a,s){var o,l,u=this;this._config.waitForInteraction&&!this._hasInteracted||0===e||!r(0)||(o=[],e&&(o=this.computeViewableItems(e,t,i,r,s)),this._viewableIndices.length===o.length&&this._viewableIndices.every(function(e,t){return e===o[t]})||(this._viewableIndices=o,this._config.minimumViewTime?(l=setTimeout(function(){u._timers.delete(l),u._onUpdateSync(o,a,n)},this._config.minimumViewTime),this._timers.add(l)):this._onUpdateSync(o,a,n)))},t.resetViewableIndices=function(){this._viewableIndices=[]},t.recordInteraction=function(){this._hasInteracted=!0},t._onUpdateSync=function(e,t,i){var r=this;e=e.filter(function(e){return r._viewableIndices.includes(e)});for(var n,a=this._viewableItems,s=new Map(e.map(function(e){var t=i(e,!0);return[t.key,t]})),o=[],l=s,u=Array.isArray(l),c=0,l=u?l:l[Symbol.iterator]();;){if(u){if(c>=l.length)break;n=l[c++]}else{if((c=l.next()).done)break;n=c.value}var f=n[0],h=n[1];a.has(f)||o.push(h)}for(var b,v=a,d=Array.isArray(v),p=0,v=d?v:v[Symbol.iterator]();;){if(d){if(p>=v.length)break;b=v[p++]}else{if((p=v.next()).done)break;b=p.value}var _=b[0],w=b[1];s.has(_)||o.push(_objectSpread({},w,{isViewable:!1}))}0<o.length&&(this._viewableItems=s,t({viewableItems:Array.from(s.values()),changed:o,viewabilityConfig:this._config}))},e}();function _isViewable(e,t,i,r,n,a){if(_isEntirelyVisible(i,r,n))return!0;var s=_getPixelsVisible(i,r,n);return t<=100*(e?s/n:s/a)}function _getPixelsVisible(e,t,i){var r=Math.min(t,i)-Math.max(e,0);return Math.max(0,r)}function _isEntirelyVisible(e,t,i){return 0<=e&&t<=i&&e<t}var _default=ViewabilityHelper;exports.default=ViewabilityHelper,module.exports=exports.default;