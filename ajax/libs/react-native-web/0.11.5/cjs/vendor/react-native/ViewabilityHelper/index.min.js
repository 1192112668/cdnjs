"use strict";exports.__esModule=!0,exports.default=void 0;var _invariant=_interopRequireDefault(require("fbjs/lib/invariant"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,i[e])})}return t}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var t=e.prototype;return t.dispose=function(){this._timers.forEach(clearTimeout)},t.computeViewableItems=function(e,t,i,r,n){var a=this._config,s=a.itemVisiblePercentThreshold,o=a.viewAreaCoveragePercentThreshold,l=null!=o,u=l?o:s;(0,_invariant.default)(null!=u&&null!=s!=(null!=o),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var f=[];if(0===e)return f;var c=-1,h=n||{first:0,last:e-1},v=h.first,b=h.last;(0,_invariant.default)(b<e,"Invalid render range "+JSON.stringify({renderRange:n,itemCount:e}));for(var d=v;d<=b;d++){var _=r(d);if(_){var m=_.offset-t,p=m+_.length;if(m<i&&0<p)c=d,_isViewable(l,u,m,p,i,_.length)&&f.push(d);else if(0<=c)break}}return f},t.onUpdate=function(e,t,i,r,n,a,s){var o,l,u=this;this._config.waitForInteraction&&!this._hasInteracted||0===e||!r(0)||(o=[],e&&(o=this.computeViewableItems(e,t,i,r,s)),this._viewableIndices.length===o.length&&this._viewableIndices.every(function(e,t){return e===o[t]})||(this._viewableIndices=o,this._config.minimumViewTime?(l=setTimeout(function(){u._timers.delete(l),u._onUpdateSync(o,a,n)},this._config.minimumViewTime),this._timers.add(l)):this._onUpdateSync(o,a,n)))},t.resetViewableIndices=function(){this._viewableIndices=[]},t.recordInteraction=function(){this._hasInteracted=!0},t._onUpdateSync=function(e,t,i){var r=this;e=e.filter(function(e){return r._viewableIndices.includes(e)});for(var n,a=this._viewableItems,s=new Map(e.map(function(e){var t=i(e,!0);return[t.key,t]})),o=[],l=s,u=Array.isArray(l),f=0,l=u?l:l[Symbol.iterator]();;){if(u){if(f>=l.length)break;n=l[f++]}else{if((f=l.next()).done)break;n=f.value}var c=n[0],h=n[1];a.has(c)||o.push(h)}for(var v,b=a,d=Array.isArray(b),_=0,b=d?b:b[Symbol.iterator]();;){if(d){if(_>=b.length)break;v=b[_++]}else{if((_=b.next()).done)break;v=_.value}c=v[0],h=v[1];s.has(c)||o.push(_objectSpread({},h,{isViewable:!1}))}0<o.length&&(this._viewableItems=s,t({viewableItems:Array.from(s.values()),changed:o,viewabilityConfig:this._config}))},e}();function _isViewable(e,t,i,r,n,a){if(_isEntirelyVisible(i,r,n))return!0;var s=_getPixelsVisible(i,r,n);return t<=100*(e?s/n:s/a)}function _getPixelsVisible(e,t,i){var r=Math.min(t,i)-Math.max(e,0);return Math.max(0,r)}function _isEntirelyVisible(e,t,i){return 0<=e&&t<=i&&e<t}var _default=ViewabilityHelper;exports.default=ViewabilityHelper,module.exports=exports.default;