"use strict";exports.__esModule=!0,exports.default=void 0;var _invariant=_interopRequireDefault(require("fbjs/lib/invariant")),_isEmpty=_interopRequireDefault(require("../isEmpty")),_warning=_interopRequireDefault(require("fbjs/lib/warning"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function defaultGetRowData(t,e,i){return t[e][i]}function defaultGetSectionHeaderData(t,e){return t[e]}var ListViewDataSource=function(){function a(t){(0,_invariant.default)(t&&"function"==typeof t.rowHasChanged,"Must provide a rowHasChanged function."),this._rowHasChanged=t.rowHasChanged,this._getRowData=t.getRowData||defaultGetRowData,this._sectionHeaderHasChanged=t.sectionHeaderHasChanged,this._getSectionHeaderData=t.getSectionHeaderData||defaultGetSectionHeaderData,this._dataBlob=null,this._dirtyRows=[],this._dirtySections=[],this._cachedRowCount=0,this.rowIdentities=[],this.sectionIdentities=[]}var t=a.prototype;return t.cloneWithRows=function(t,e){var i=e?[[].concat(e)]:null;return this._sectionHeaderHasChanged||(this._sectionHeaderHasChanged=function(){return!1}),this.cloneWithRowsAndSections({s1:t},["s1"],i)},t.cloneWithRowsAndSections=function(e,t,i){(0,_invariant.default)("function"==typeof this._sectionHeaderHasChanged,"Must provide a sectionHeaderHasChanged function with section data."),(0,_invariant.default)(!t||!i||t.length===i.length,"row and section ids lengths must be the same");var n=new a({getRowData:this._getRowData,getSectionHeaderData:this._getSectionHeaderData,rowHasChanged:this._rowHasChanged,sectionHeaderHasChanged:this._sectionHeaderHasChanged});return n._dataBlob=e,n.sectionIdentities=t||Object.keys(e),i?n.rowIdentities=i:(n.rowIdentities=[],n.sectionIdentities.forEach(function(t){n.rowIdentities.push(Object.keys(e[t]))})),n._cachedRowCount=countRows(n.rowIdentities),n._calculateDirtyArrays(this._dataBlob,this.sectionIdentities,this.rowIdentities),n},t.getRowCount=function(){return this._cachedRowCount},t.getRowAndSectionCount=function(){return this._cachedRowCount+this.sectionIdentities.length},t.rowShouldUpdate=function(t,e){var i=this._dirtyRows[t][e];return(0,_warning.default)(void 0!==i,"missing dirtyBit for section, row: "+t+", "+e),i},t.getRowData=function(t,e){var i=this.sectionIdentities[t],n=this.rowIdentities[t][e];return(0,_warning.default)(void 0!==i&&void 0!==n,"rendering invalid section, row: "+t+", "+e),this._getRowData(this._dataBlob,i,n)},t.getRowIDForFlatIndex=function(t){for(var e=t,i=0;i<this.sectionIdentities.length;i++){if(!(e>=this.rowIdentities[i].length))return this.rowIdentities[i][e];e-=this.rowIdentities[i].length}return null},t.getSectionIDForFlatIndex=function(t){for(var e=t,i=0;i<this.sectionIdentities.length;i++){if(!(e>=this.rowIdentities[i].length))return this.sectionIdentities[i];e-=this.rowIdentities[i].length}return null},t.getSectionLengths=function(){for(var t=[],e=0;e<this.sectionIdentities.length;e++)t.push(this.rowIdentities[e].length);return t},t.sectionHeaderShouldUpdate=function(t){var e=this._dirtySections[t];return(0,_warning.default)(void 0!==e,"missing dirtyBit for section: "+t),e},t.getSectionHeaderData=function(t){if(!this._getSectionHeaderData)return null;var e=this.sectionIdentities[t];return(0,_warning.default)(void 0!==e,"renderSection called on invalid section: "+t),this._getSectionHeaderData(this._dataBlob,e)},t._calculateDirtyArrays=function(t,e,i){for(var n=keyedDictionaryFromArray(e),a={},r=0;r<i.length;r++){var o=e[r];(0,_warning.default)(!a[o],"SectionID appears more than once: "+o),a[o]=keyedDictionaryFromArray(i[r])}this._dirtySections=[],this._dirtyRows=[];for(var s=0;s<this.sectionIdentities.length;s++){c=!n[o=this.sectionIdentities[s]];var d=this._sectionHeaderHasChanged;!c&&d&&(c=d(this._getSectionHeaderData(t,o),this._getSectionHeaderData(this._dataBlob,o))),this._dirtySections.push(!!c),this._dirtyRows[s]=[];for(var h=0;h<this.rowIdentities[s].length;h++){var u=this.rowIdentities[s][h],c=!n[o]||!a[o][u]||this._rowHasChanged(this._getRowData(t,o,u),this._getRowData(this._dataBlob,o,u));this._dirtyRows[s].push(!!c)}}},a}();function countRows(t){for(var e=0,i=0;i<t.length;i++){e+=t[i].length}return e}function keyedDictionaryFromArray(t){if((0,_isEmpty.default)(t))return{};for(var e={},i=0;i<t.length;i++){var n=t[i];(0,_warning.default)(!e[n],"Value appears more than once in array: "+n),e[n]=!0}return e}var _default=ListViewDataSource;exports.default=ListViewDataSource,module.exports=exports.default;