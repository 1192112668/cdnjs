"use strict";exports.__esModule=!0,exports.default=void 0;var _applyNativeMethods=_interopRequireDefault(require("../../modules/applyNativeMethods")),_createElement=_interopRequireDefault(require("../createElement")),_css=_interopRequireDefault(require("../StyleSheet/css")),_AssetRegistry=require("../../modules/AssetRegistry"),_resolveShadowValue=_interopRequireDefault(require("../StyleSheet/resolveShadowValue")),_ImageLoader=_interopRequireDefault(require("../../modules/ImageLoader")),_ImageUriCache=_interopRequireDefault(require("./ImageUriCache")),_StyleSheet=_interopRequireDefault(require("../StyleSheet")),_TextAncestorContext=_interopRequireDefault(require("../Text/TextAncestorContext")),_View=_interopRequireDefault(require("../View")),_react=_interopRequireDefault(require("react"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var r,a=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,r)),a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}var STATUS_ERRORED="ERRORED",STATUS_LOADED="LOADED",STATUS_LOADING="LOADING",STATUS_PENDING="PENDING",STATUS_IDLE="IDLE",getImageState=function(e,t){return t?STATUS_LOADED:e?STATUS_PENDING:STATUS_IDLE},resolveAssetDimensions=function(e){if("number"==typeof e){var t=(0,_AssetRegistry.getAssetByID)(e);return{height:t.height,width:t.width}}if("object"==typeof e)return{height:e.height,width:e.width}},svgDataUriPattern=/^(data:image\/svg\+xml;utf8,)(.*)/,resolveAssetUri=function(e){var t,r,a,o="";if("number"==typeof e?(a=1!==(r=(t=(0,_AssetRegistry.getAssetByID)(e)).scales[0])?"@"+r+"x":"",o=t?t.httpServerLocation+"/"+t.name+a+"."+t.type:""):"string"==typeof e?o=e:e&&"string"==typeof e.uri&&(o=e.uri),o){var i=o.match(svgDataUriPattern);if(i){var n=i[1],s=i[2];return""+n+encodeURIComponent(s)}}return o},filterId=0,createTintColorSVG=function(e,t){return e&&null!=t?_react.default.createElement("svg",{style:{position:"absolute",height:0,visibility:"hidden",width:0}},_react.default.createElement("defs",null,_react.default.createElement("filter",{id:"tint-"+t},_react.default.createElement("feFlood",{floodColor:""+e}),_react.default.createElement("feComposite",{in2:"SourceAlpha",operator:"atop"})))):null},Image=function(o){function e(e,t){var u=o.call(this,e,t)||this;u._filterId=0,u._imageRef=null,u._imageRequestId=null,u._imageState=null,u._isMounted=!1,u._createLayoutHandler=function(e){var r=u.props.onLayout;if("center"===e||"repeat"===e||r)return function(e){var t=e.nativeEvent.layout;r&&r(e),u.setState(function(){return{layout:t}})}},u._getBackgroundSize=function(e){if(u._imageRef&&("center"===e||"repeat"===e)){var t=u._imageRef,r=t.naturalHeight,a=t.naturalWidth,o=u.state.layout,i=o.height,n=o.width;if(r&&a&&i&&n){var s=Math.min(1,n/a,i/r);return{backgroundSize:Math.ceil(s*a)+"px "+Math.ceil(s*r)+"px"}}}},u._onError=function(){var e=u.props,t=e.onError,r=e.source;u._updateImageState(STATUS_ERRORED),t&&t({nativeEvent:{error:"Failed to load resource "+resolveAssetUri(r)+" (404)"}}),u._onLoadEnd()},u._onLoad=function(e){var t=u.props,r=t.onLoad,a=t.source,o={nativeEvent:e};_ImageUriCache.default.add(resolveAssetUri(a)),u._updateImageState(STATUS_LOADED),r&&r(o),u._onLoadEnd()},u._setImageRef=function(e){u._imageRef=e};var r=resolveAssetUri(e.source),a=_ImageUriCache.default.has(r);return u.state={layout:{},shouldDisplaySource:a},u._imageState=getImageState(r,a),u._filterId=filterId,filterId++,u}_inheritsLoose(e,o),e.getSize=function(e,t,r){_ImageLoader.default.getSize(e,t,r)},e.prefetch=function(e){return _ImageLoader.default.prefetch(e).then(function(){_ImageUriCache.default.add(e),_ImageUriCache.default.remove(e)})},e.queryCache=function(e){var t={};return e.forEach(function(e){_ImageUriCache.default.has(e)&&(t[e]="disk/memory")}),Promise.resolve(t)};var t=e.prototype;return t.componentDidMount=function(){this._isMounted=!0,this._imageState===STATUS_PENDING?this._createImageLoader():this._imageState===STATUS_LOADED&&this._onLoad({target:this._imageRef})},t.componentDidUpdate=function(e){var t,r=resolveAssetUri(e.source),a=resolveAssetUri(this.props.source),o=null!=this.props.defaultSource;r!==a?(_ImageUriCache.default.remove(r),(t=_ImageUriCache.default.has(a))&&_ImageUriCache.default.add(a),this._updateImageState(getImageState(a,t),o)):o&&e.defaultSource!==this.props.defaultSource&&this._updateImageState(this._imageState,o),this._imageState===STATUS_PENDING&&this._createImageLoader()},t.componentWillUnmount=function(){var e=resolveAssetUri(this.props.source);_ImageUriCache.default.remove(e),this._destroyImageLoader(),this._isMounted=!1},t.renderImage=function(e){var t=this.state.shouldDisplaySource,r=this.props,a=r.accessibilityLabel,o=r.accessibilityRelationship,i=r.accessibilityRole,n=r.accessibilityState,s=r.accessible,u=r.blurRadius,l=r.defaultSource,c=r.draggable,d=r.importantForAccessibility,f=r.nativeID,_=r.pointerEvents,h=r.resizeMode,p=r.source,g=r.testID;if("production"!==process.env.NODE_ENV&&this.props.children)throw new Error("The <Image> component cannot contain children. If you want to render content on top of the image, consider using the <ImageBackground> component or absolute positioning.");var m,S=t?p:l,y=resolveAssetUri(S),I=resolveAssetDimensions(S),v=y?'url("'+y+'")':null,b=_objectSpread({},_StyleSheet.default.flatten(this.props.style)),D=h||b.resizeMode||"cover",A=[],E=b.tintColor;b.filter&&A.push(b.filter),u&&A.push("blur("+u+"px)"),!b.shadowOffset||(m=(0,_resolveShadowValue.default)(b))&&A.push("drop-shadow("+m+")"),b.tintColor&&A.push("url(#tint-"+this._filterId+")"),delete b.shadowColor,delete b.shadowOpacity,delete b.shadowOffset,delete b.shadowRadius,delete b.tintColor,delete b.overlayColor,delete b.resizeMode;var L=y?(0,_createElement.default)("img",{alt:a||"",classList:[classes.accessibilityImage],draggable:c||!1,ref:this._setImageRef,src:y}):null;return _react.default.createElement(_View.default,{accessibilityLabel:a,accessibilityRelationship:o,accessibilityRole:i,accessibilityState:n,accessible:s,importantForAccessibility:d,nativeID:f,onLayout:this._createLayoutHandler(D),pointerEvents:_,style:[styles.root,e&&styles.inline,I,b],testID:g},_react.default.createElement(_View.default,{style:[styles.image,resizeModeStyles[D],this._getBackgroundSize(D),v&&{backgroundImage:v},0<A.length&&{filter:A.join(" ")}]}),L,createTintColorSVG(E,this._filterId))},t.render=function(){var t=this;return _react.default.createElement(_TextAncestorContext.default.Consumer,null,function(e){return t.renderImage(e)})},t._createImageLoader=function(){var e=this.props.source;this._destroyImageLoader();var t=resolveAssetUri(e);this._imageRequestId=_ImageLoader.default.load(t,this._onLoad,this._onError),this._onLoadStart()},t._destroyImageLoader=function(){this._imageRequestId&&(_ImageLoader.default.abort(this._imageRequestId),this._imageRequestId=null)},t._onLoadEnd=function(){var e=this.props.onLoadEnd;e&&e()},t._onLoadStart=function(){var e=this.props,t=e.defaultSource,r=e.onLoadStart;this._updateImageState(STATUS_LOADING,null!=t),r&&r()},t._updateImageState=function(e,t){void 0===t&&(t=!1),this._imageState=e;var r=this._imageState===STATUS_LOADED||this._imageState===STATUS_LOADING&&!t;r!==this.state.shouldDisplaySource&&this._isMounted&&this.setState(function(){return{shouldDisplaySource:r}})},e}(_react.default.Component);Image.displayName="Image";var classes=_css.default.create({accessibilityImage:_objectSpread({},_StyleSheet.default.absoluteFillObject,{height:"100%",opacity:0,width:"100%",zIndex:-1})}),styles=_StyleSheet.default.create({root:{flexBasis:"auto",overflow:"hidden",zIndex:0},inline:{display:"inline-flex"},image:_objectSpread({},_StyleSheet.default.absoluteFillObject,{backgroundColor:"transparent",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"cover",height:"100%",width:"100%",zIndex:-1})}),resizeModeStyles=_StyleSheet.default.create({center:{backgroundSize:"auto"},contain:{backgroundSize:"contain"},cover:{backgroundSize:"cover"},none:{backgroundPosition:"0 0",backgroundSize:"auto"},repeat:{backgroundPosition:"0 0",backgroundRepeat:"repeat",backgroundSize:"auto"},stretch:{backgroundSize:"100% 100%"}}),_default=(0,_applyNativeMethods.default)(Image);exports.default=_default,module.exports=exports.default;