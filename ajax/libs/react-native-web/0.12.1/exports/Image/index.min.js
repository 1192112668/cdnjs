function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}import applyNativeMethods from"../../modules/applyNativeMethods";import createElement from"../createElement";import css from"../StyleSheet/css";import{getAssetByID}from"../../modules/AssetRegistry";import resolveShadowValue from"../StyleSheet/resolveShadowValue";import ImageLoader from"../../modules/ImageLoader";import ImageUriCache from"./ImageUriCache";import StyleSheet from"../StyleSheet";import TextAncestorContext from"../Text/TextAncestorContext";import View from"../View";import React from"react";var STATUS_ERRORED="ERRORED",STATUS_LOADED="LOADED",STATUS_LOADING="LOADING",STATUS_PENDING="PENDING",STATUS_IDLE="IDLE",getImageState=function(e,t){return t?STATUS_LOADED:e?STATUS_PENDING:STATUS_IDLE},resolveAssetDimensions=function(e){if("number"==typeof e){var t=getAssetByID(e);return{height:t.height,width:t.width}}if("object"==typeof e)return{height:e.height,width:e.width}},svgDataUriPattern=/^(data:image\/svg\+xml;utf8,)(.*)/,resolveAssetUri=function(e){var t="";if("number"==typeof e){var r=getAssetByID(e),o=r.scales[0],a=1!==o?"@"+o+"x":"";t=r?r.httpServerLocation+"/"+r.name+a+"."+r.type:""}else"string"==typeof e?t=e:e&&"string"==typeof e.uri&&(t=e.uri);if(t){var i=t.match(svgDataUriPattern);if(i){var n=i[1],s=i[2];return""+n+encodeURIComponent(s)}}return t},filterId=0,createTintColorSVG=function(e,t){return e&&null!=t?React.createElement("svg",{style:{position:"absolute",height:0,visibility:"hidden",width:0}},React.createElement("defs",null,React.createElement("filter",{id:"tint-"+t},React.createElement("feFlood",{floodColor:""+e}),React.createElement("feComposite",{in2:"SourceAlpha",operator:"atop"})))):null},Image=function(e){function t(t,r){var o;(o=e.call(this,t,r)||this)._filterId=0,o._imageRef=null,o._imageRequestId=null,o._imageState=null,o._isMounted=!1,o._createLayoutHandler=function(e){var t=o.props.onLayout;if("center"===e||"repeat"===e||t)return function(e){var r=e.nativeEvent.layout;t&&t(e),o.setState(function(){return{layout:r}})}},o._getBackgroundSize=function(e){if(o._imageRef&&("center"===e||"repeat"===e)){var t=o._imageRef,r=t.naturalHeight,a=t.naturalWidth,i=o.state.layout,n=i.height,s=i.width;if(r&&a&&n&&s){var c=Math.min(1,s/a,n/r);return{backgroundSize:Math.ceil(c*a)+"px "+Math.ceil(c*r)+"px"}}}},o._onError=function(){var e=o.props,t=e.onError,r=e.source;o._updateImageState(STATUS_ERRORED),t&&t({nativeEvent:{error:"Failed to load resource "+resolveAssetUri(r)+" (404)"}}),o._onLoadEnd()},o._onLoad=function(e){var t=o.props,r=t.onLoad,a=t.source,i={nativeEvent:e};ImageUriCache.add(resolveAssetUri(a)),o._updateImageState(STATUS_LOADED),r&&r(i),o._onLoadEnd()},o._setImageRef=function(e){o._imageRef=e};var a=resolveAssetUri(t.source),i=ImageUriCache.has(a);return o.state={layout:{},shouldDisplaySource:i},o._imageState=getImageState(a,i),o._filterId=filterId,filterId++,o}_inheritsLoose(t,e),t.getSize=function(e,t,r){ImageLoader.getSize(e,t,r)},t.prefetch=function(e){return ImageLoader.prefetch(e).then(function(){ImageUriCache.add(e),ImageUriCache.remove(e)})},t.queryCache=function(e){var t={};return e.forEach(function(e){ImageUriCache.has(e)&&(t[e]="disk/memory")}),Promise.resolve(t)};var r=t.prototype;return r.componentDidMount=function(){this._isMounted=!0,this._imageState===STATUS_PENDING?this._createImageLoader():this._imageState===STATUS_LOADED&&this._onLoad({target:this._imageRef})},r.componentDidUpdate=function(e){var t=resolveAssetUri(e.source),r=resolveAssetUri(this.props.source),o=null!=this.props.defaultSource;if(t!==r){ImageUriCache.remove(t);var a=ImageUriCache.has(r);a&&ImageUriCache.add(r),this._updateImageState(getImageState(r,a),o)}else o&&e.defaultSource!==this.props.defaultSource&&this._updateImageState(this._imageState,o);this._imageState===STATUS_PENDING&&this._createImageLoader()},r.componentWillUnmount=function(){var e=resolveAssetUri(this.props.source);ImageUriCache.remove(e),this._destroyImageLoader(),this._isMounted=!1},r.renderImage=function(e){var t=this.state.shouldDisplaySource,r=this.props,o=r.accessibilityLabel,a=r.accessibilityRelationship,i=r.accessibilityRole,n=r.accessibilityState,s=r.accessible,c=r.blurRadius,l=r.defaultSource,u=r.draggable,d=r.importantForAccessibility,h=r.nativeID,p=r.pointerEvents,m=r.resizeMode,g=r.source,f=r.testID;if("production"!==process.env.NODE_ENV&&this.props.children)throw new Error("The <Image> component cannot contain children. If you want to render content on top of the image, consider using the <ImageBackground> component or absolute positioning.");var S=t?g:l,y=resolveAssetUri(S),_=resolveAssetDimensions(S),I=y?'url("'+y+'")':null,v=_objectSpread({},StyleSheet.flatten(this.props.style)),b=m||v.resizeMode||"cover",D=[],E=v.tintColor;if(v.filter&&D.push(v.filter),c&&D.push("blur("+c+"px)"),v.shadowOffset){var A=resolveShadowValue(v);A&&D.push("drop-shadow("+A+")")}v.tintColor&&D.push("url(#tint-"+this._filterId+")"),delete v.shadowColor,delete v.shadowOpacity,delete v.shadowOffset,delete v.shadowRadius,delete v.tintColor,delete v.overlayColor,delete v.resizeMode;var L=y?createElement("img",{alt:o||"",classList:[classes.accessibilityImage],draggable:u||!1,ref:this._setImageRef,src:y}):null;return React.createElement(View,{accessibilityLabel:o,accessibilityRelationship:a,accessibilityRole:i,accessibilityState:n,accessible:s,importantForAccessibility:d,nativeID:h,onLayout:this._createLayoutHandler(b),pointerEvents:p,style:[styles.root,e&&styles.inline,_,v],testID:f},React.createElement(View,{style:[styles.image,resizeModeStyles[b],this._getBackgroundSize(b),I&&{backgroundImage:I},D.length>0&&{filter:D.join(" ")}]}),L,createTintColorSVG(E,this._filterId))},r.render=function(){var e=this;return React.createElement(TextAncestorContext.Consumer,null,function(t){return e.renderImage(t)})},r._createImageLoader=function(){var e=this.props.source;this._destroyImageLoader();var t=resolveAssetUri(e);this._imageRequestId=ImageLoader.load(t,this._onLoad,this._onError),this._onLoadStart()},r._destroyImageLoader=function(){this._imageRequestId&&(ImageLoader.abort(this._imageRequestId),this._imageRequestId=null)},r._onLoadEnd=function(){var e=this.props.onLoadEnd;e&&e()},r._onLoadStart=function(){var e=this.props,t=e.defaultSource,r=e.onLoadStart;this._updateImageState(STATUS_LOADING,null!=t),r&&r()},r._updateImageState=function(e,t){void 0===t&&(t=!1),this._imageState=e;var r=this._imageState===STATUS_LOADED||this._imageState===STATUS_LOADING&&!t;r!==this.state.shouldDisplaySource&&this._isMounted&&this.setState(function(){return{shouldDisplaySource:r}})},t}(React.Component);Image.displayName="Image";var classes=css.create({accessibilityImage:_objectSpread({},StyleSheet.absoluteFillObject,{height:"100%",opacity:0,width:"100%",zIndex:-1})}),styles=StyleSheet.create({root:{flexBasis:"auto",overflow:"hidden",zIndex:0},inline:{display:"inline-flex"},image:_objectSpread({},StyleSheet.absoluteFillObject,{backgroundColor:"transparent",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"cover",height:"100%",width:"100%",zIndex:-1})}),resizeModeStyles=StyleSheet.create({center:{backgroundSize:"auto"},contain:{backgroundSize:"contain"},cover:{backgroundSize:"cover"},none:{backgroundPosition:"0 0",backgroundSize:"auto"},repeat:{backgroundPosition:"0 0",backgroundRepeat:"repeat",backgroundSize:"auto"},stretch:{backgroundSize:"100% 100%"}});export default applyNativeMethods(Image);