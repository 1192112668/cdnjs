"use strict";function _inheritsLoose(t,i){t.prototype=Object.create(i.prototype),t.prototype.constructor=t,t.__proto__=i}import AnimatedValue from"../nodes/AnimatedValue";import AnimatedValueXY from"../nodes/AnimatedValueXY";import Animation from"./Animation";import SpringConfig from"../SpringConfig";import invariant from"fbjs/lib/invariant";import{shouldUseNativeDriver}from"../NativeAnimatedHelper";function withDefault(t,i){return null==t?i:t}var SpringAnimation=function(t){function i(i){var s;if((s=t.call(this)||this)._overshootClamping=withDefault(i.overshootClamping,!1),s._restDisplacementThreshold=withDefault(i.restDisplacementThreshold,.001),s._restSpeedThreshold=withDefault(i.restSpeedThreshold,.001),s._initialVelocity=withDefault(i.velocity,0),s._lastVelocity=withDefault(i.velocity,0),s._toValue=i.toValue,s._delay=withDefault(i.delay,0),s._useNativeDriver=shouldUseNativeDriver(i),s.__isInteraction=void 0===i.isInteraction||i.isInteraction,s.__iterations=void 0!==i.iterations?i.iterations:1,void 0!==i.stiffness||void 0!==i.damping||void 0!==i.mass)invariant(void 0===i.bounciness&&void 0===i.speed&&void 0===i.tension&&void 0===i.friction,"You can define one of bounciness/speed, tension/friction, or stiffness/damping/mass, but not more than one"),s._stiffness=withDefault(i.stiffness,100),s._damping=withDefault(i.damping,10),s._mass=withDefault(i.mass,1);else if(void 0!==i.bounciness||void 0!==i.speed){invariant(void 0===i.tension&&void 0===i.friction&&void 0===i.stiffness&&void 0===i.damping&&void 0===i.mass,"You can define one of bounciness/speed, tension/friction, or stiffness/damping/mass, but not more than one");var e=SpringConfig.fromBouncinessAndSpeed(withDefault(i.bounciness,8),withDefault(i.speed,12));s._stiffness=e.stiffness,s._damping=e.damping,s._mass=1}else{var a=SpringConfig.fromOrigamiTensionAndFriction(withDefault(i.tension,40),withDefault(i.friction,7));s._stiffness=a.stiffness,s._damping=a.damping,s._mass=1}return invariant(s._stiffness>0,"Stiffness value must be greater than 0"),invariant(s._damping>0,"Damping value must be greater than 0"),invariant(s._mass>0,"Mass value must be greater than 0"),s}_inheritsLoose(i,t);var s=i.prototype;return s.__getNativeAnimationConfig=function(){return{type:"spring",overshootClamping:this._overshootClamping,restDisplacementThreshold:this._restDisplacementThreshold,restSpeedThreshold:this._restSpeedThreshold,stiffness:this._stiffness,damping:this._damping,mass:this._mass,initialVelocity:withDefault(this._initialVelocity,this._lastVelocity),toValue:this._toValue,iterations:this.__iterations}},s.start=function(t,s,e,a,n){var o=this;if(this.__active=!0,this._startPosition=t,this._lastPosition=this._startPosition,this._onUpdate=s,this.__onEnd=e,this._lastTime=Date.now(),this._frameTime=0,a instanceof i){var r=a.getInternalState();this._lastPosition=r.lastPosition,this._lastVelocity=r.lastVelocity,this._initialVelocity=this._lastVelocity,this._lastTime=r.lastTime}var h=function(){o._useNativeDriver?o.__startNativeAnimation(n):o.onUpdate()};this._delay?this._timeout=setTimeout(h,this._delay):h()},s.getInternalState=function(){return{lastPosition:this._lastPosition,lastVelocity:this._lastVelocity,lastTime:this._lastTime}},s.onUpdate=function(){var t=Date.now();t>this._lastTime+64&&(t=this._lastTime+64);var i=(t-this._lastTime)/1e3;this._frameTime+=i;var s=this._damping,e=this._mass,a=this._stiffness,n=-this._initialVelocity,o=s/(2*Math.sqrt(a*e)),r=Math.sqrt(a/e),h=r*Math.sqrt(1-o*o),l=this._toValue-this._startPosition,_=0,f=0,m=this._frameTime;if(o<1){var d=Math.exp(-o*r*m);_=this._toValue-d*((n+o*r*l)/h*Math.sin(h*m)+l*Math.cos(h*m)),f=o*r*d*(Math.sin(h*m)*(n+o*r*l)/h+l*Math.cos(h*m))-d*(Math.cos(h*m)*(n+o*r*l)-h*l*Math.sin(h*m))}else{var u=Math.exp(-r*m);_=this._toValue-u*(l+(n+r*l)*m),f=u*(n*(m*r-1)+m*l*(r*r))}if(this._lastTime=t,this._lastPosition=_,this._lastVelocity=f,this._onUpdate(_),this.__active){var p=!1;this._overshootClamping&&0!==this._stiffness&&(p=this._startPosition<this._toValue?_>this._toValue:_<this._toValue);var c=Math.abs(f)<=this._restSpeedThreshold,v=!0;if(0!==this._stiffness&&(v=Math.abs(this._toValue-_)<=this._restDisplacementThreshold),p||c&&v)return 0!==this._stiffness&&(this._lastPosition=this._toValue,this._lastVelocity=0,this._onUpdate(this._toValue)),void this.__debouncedOnEnd({finished:!0});this._animationFrame=requestAnimationFrame(this.onUpdate.bind(this))}},s.stop=function(){t.prototype.stop.call(this),this.__active=!1,clearTimeout(this._timeout),global.cancelAnimationFrame(this._animationFrame),this.__debouncedOnEnd({finished:!1})},i}(Animation);export default SpringAnimation;