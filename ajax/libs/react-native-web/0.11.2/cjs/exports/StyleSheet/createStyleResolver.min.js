"use strict";exports.__esModule=!0,exports.default=createStyleResolver;var _ExecutionEnvironment=require("fbjs/lib/ExecutionEnvironment"),_createCSSStyleSheet=_interopRequireDefault(require("./createCSSStyleSheet")),_createCompileableStyle=_interopRequireDefault(require("./createCompileableStyle")),_createOrderedCSSStyleSheet=_interopRequireDefault(require("./createOrderedCSSStyleSheet")),_flattenArray=_interopRequireDefault(require("../../modules/flattenArray")),_flattenStyle=_interopRequireDefault(require("./flattenStyle")),_I18nManager=_interopRequireDefault(require("../I18nManager")),_i18nStyle=_interopRequireDefault(require("./i18nStyle")),_compile=require("./compile"),_initialRules=_interopRequireDefault(require("./initialRules")),_modality=_interopRequireDefault(require("./modality")),_constants=require("./constants");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(e){_defineProperty(t,e,r[e])})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var emptyObject={};function createStyleResolver(){function t(){c={css:{},ltr:{},rtl:{},rtlNoSwap:{}},f=(0,_createOrderedCSSStyleSheet.default)((0,_createCSSStyleSheet.default)(_constants.STYLE_ELEMENT_ID)),S={byClassName:{},byProp:{}},(0,_modality.default)(function(e){return f.insert(e,_constants.STYLE_GROUPS.modality)}),_initialRules.default.forEach(function(e){f.insert(e,_constants.STYLE_GROUPS.reset)})}var c,f,S,y={css:{},ltr:{},rtl:{},rtlNoSwap:{}};function p(e){var t,r,n=_I18nManager.default.doLeftAndRightSwapInRTL,a=_I18nManager.default.isRTL?n?"rtl":"rtlNoSwap":"ltr";c[a][e]||(t=(0,_createCompileableStyle.default)((0,_i18nStyle.default)((0,_flattenStyle.default)(e))),r=(0,_compile.atomic)(t),Object.values(r).forEach(function(e){var t,r,n,a=e.identifier,l=e.property,i=e.rules,s=e.value;t=a,r=l,n=s,S.byProp[r]||(S.byProp[r]={}),S.byProp[r][n]=t,S.byClassName[t]={prop:r,value:n},i.forEach(function(e){var t=_constants.STYLE_GROUPS.custom[l]||_constants.STYLE_GROUPS.atomic;f.insert(e,t)})}),c[a][e]=!0)}function _(e,t){var r=[],n={};if(!e&&!t)return n;if(Array.isArray(t)&&(0,_flattenArray.default)(t).forEach(function(e){var t;e&&(null==c.css[e]&&null!=y.css[e]&&((t=y.css[e]).rules.forEach(function(e){f.insert(e,t.group)}),c.css[e]=!0),r.push(e))}),"number"==typeof e){p(e);n=d(e,createCacheKey(e))}else if(Array.isArray(e)){for(var a=(0,_flattenArray.default)(e),l=!0,i="",s=0;s<a.length;s++){var o=a[s];"number"!=typeof o?l=!1:(l&&(i+=o+"-"),p(o))}n=d(a,l?createCacheKey(i):null)}else n=d(e);r.push.apply(r,n.classList);var u={className:classListToString(r),classList:r};return n.style&&(u.style=n.style),u}function d(e,t){var r=_I18nManager.default.doLeftAndRightSwapInRTL,n=_I18nManager.default.isRTL?r?"rtl":"rtlNoSwap":"ltr";if(null!=t&&null!=y[n][t])return y[n][t];var a=(0,_flattenStyle.default)(e),c=(0,_createCompileableStyle.default)((0,_i18nStyle.default)(a)),l=Object.keys(c).sort().reduce(function(n,e){var t,r,a,l,i,s,o,u=c[e];return null!=u&&(l=e,i=u,s=(0,_compile.stringifyValueWithProperty)(i,l),(t=(o=S.byProp)[l]&&o[l].hasOwnProperty(s)&&o[l][s])?n.classList.push(t):"pointerEvents"===e||"placeholderTextColor"===e||"animationKeyframes"===e?(a=(0,_compile.atomic)(((r={})[e]=u,r)),Object.values(a).forEach(function(e){var t=e.identifier,r=e.rules;n.classList.push(t),r.forEach(function(e){f.insert(e,_constants.STYLE_GROUPS.atomic)})})):(n.style||(n.style={}),n.style[e]=u)),n},{classList:[]});return l.style&&(l.style=(0,_compile.inline)(l.style)),null!=t&&(y[n][t]=l),l}return t(),{getStyleSheet:function(){var e=f.getTextContent();return _ExecutionEnvironment.canUseDOM||t(),{id:_constants.STYLE_ELEMENT_ID,textContent:e}},createCSS:function(r,a){var l={};return Object.keys(r).forEach(function(n){var e=r[n],t=(0,_compile.classic)(e,n);Object.values(t).forEach(function(e){var t=e.identifier,r=e.rules;y.css[t]={group:a||_constants.STYLE_GROUPS.classic,rules:r},l[n]=t})}),l},resolve:_,sheet:f,resolveWithNode:function(e,t){function l(e){return S.byClassName[e]||emptyObject}var r=getDOMStyleInfo(t),n=r.classList,a=r.style,i=n.reduce(function(e,t){var r=l(t),n=r.prop,a=r.value;return n?e.style[n]=a:e.classList.push(t),e},{classList:[],style:{}}),s=i.classList,o=i.style,u=_([(0,_i18nStyle.default)(o),e]),c=u.classList,f=u.style,y=classListToString(c.concat(s)),p=_objectSpread({},a);return c.forEach(function(e){var t=l(e).prop;p[t]&&(p[t]="")}),Object.assign(p,f),{className:y,style:p}}}}var createCacheKey=function(e){return"rn-"+e},classListToString=function(e){return e.join(" ").trim()},hyphenPattern=/-([a-z])/g,toCamelCase=function(e){return e.replace(hyphenPattern,function(e){return e[1].toUpperCase()})},getDOMStyleInfo=function(e){for(var t=e.style,r=Array.prototype.slice.call(e.classList),n={},a=0;a<t.length;a+=1){var l=t.item(a);l&&(n[toCamelCase(l)]=t.getPropertyValue(l))}return{classList:r,style:n}};module.exports=exports.default;