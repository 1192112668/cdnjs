function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e}).apply(this,arguments)}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},r=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,o[t])})}return e}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var o,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)o=i[r],t.indexOf(o)>=0||(a[o]=e[o]);return a}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}import applyNativeMethods from"../../modules/applyNativeMethods";import createElement from"../createElement";import css from"../StyleSheet/css";import{getAssetByID}from"../../modules/AssetRegistry";import resolveShadowValue from"../StyleSheet/resolveShadowValue";import ImageLoader from"../../modules/ImageLoader";import ImageResizeMode from"./ImageResizeMode";import ImageSourcePropType from"./ImageSourcePropType";import ImageStylePropTypes from"./ImageStylePropTypes";import ImageUriCache from"./ImageUriCache";import StyleSheet from"../StyleSheet";import StyleSheetPropType from"../../modules/StyleSheetPropType";import View from"../View";import ViewPropTypes from"../ViewPropTypes";import{bool,func,number,oneOf,shape}from"prop-types";import React,{Component}from"react";var emptyObject={},STATUS_ERRORED="ERRORED",STATUS_LOADED="LOADED",STATUS_LOADING="LOADING",STATUS_PENDING="PENDING",STATUS_IDLE="IDLE",getImageState=function(e,t){return t?STATUS_LOADED:e?STATUS_PENDING:STATUS_IDLE},resolveAssetDimensions=function(e){if("number"==typeof e){var t=getAssetByID(e);return{height:t.height,width:t.width}}if("object"==typeof e)return{height:e.height,width:e.width}},svgDataUriPattern=/^(data:image\/svg\+xml;utf8,)(.*)/,resolveAssetUri=function(e){var t="";if("number"==typeof e){var o=getAssetByID(e),r=o.scales[0],a=1!==r?"@"+r+"x":"";t=o?o.httpServerLocation+"/"+o.name+a+"."+o.type:""}else"string"==typeof e?t=e:e&&"string"==typeof e.uri&&(t=e.uri);if(t){var i=t.match(svgDataUriPattern);if(i){var n=i[1],s=i[2];return""+n+encodeURIComponent(s)}}return t},filterId=0,createTintColorSVG=function(e,t){return e&&null!=t?React.createElement("svg",{style:{position:"absolute",height:0,visibility:"hidden",width:0}},React.createElement("defs",null,React.createElement("filter",{id:"tint-"+t},React.createElement("feFlood",{floodColor:""+e}),React.createElement("feComposite",{in2:"SourceAlpha",operator:"atop"})))):null},Image=function(e){function t(t,o){var r;(r=e.call(this,t,o)||this)._filterId=0,r._imageRef=null,r._imageRequestId=null,r._imageState=null,r._isMounted=!1,r._createLayoutHandler=function(e){var t=r.props.onLayout;if("center"===e||"repeat"===e||t)return function(e){var o=e.nativeEvent.layout;t&&t(e),r.setState(function(){return{layout:o}})}},r._getBackgroundSize=function(e){if(r._imageRef&&("center"===e||"repeat"===e)){var t=r._imageRef,o=t.naturalHeight,a=t.naturalWidth,i=r.state.layout,n=i.height,s=i.width;if(o&&a&&n&&s){var c=Math.min(1,s/a,n/o);return{backgroundSize:Math.ceil(c*a)+"px "+Math.ceil(c*o)+"px"}}}},r._onError=function(){var e=r.props,t=e.onError,o=e.source;r._updateImageState(STATUS_ERRORED),t&&t({nativeEvent:{error:"Failed to load resource "+resolveAssetUri(o)+" (404)"}}),r._onLoadEnd()},r._onLoad=function(e){var t=r.props,o=t.onLoad,a=t.source,i={nativeEvent:e};ImageUriCache.add(resolveAssetUri(a)),r._updateImageState(STATUS_LOADED),o&&o(i),r._onLoadEnd()},r._setImageRef=function(e){r._imageRef=e};var a=resolveAssetUri(t.source),i=ImageUriCache.has(a);return r.state={layout:{},shouldDisplaySource:i},r._imageState=getImageState(a,i),r._filterId=filterId,filterId++,r}_inheritsLoose(t,e),t.getSize=function(e,t,o){ImageLoader.getSize(e,t,o)},t.prefetch=function(e){return ImageLoader.prefetch(e)};var o=t.prototype;return o.componentDidMount=function(){this._isMounted=!0,this._imageState===STATUS_PENDING?this._createImageLoader():this._imageState===STATUS_LOADED&&this._onLoad({target:this._imageRef})},o.componentDidUpdate=function(e){var t=resolveAssetUri(e.source),o=resolveAssetUri(this.props.source);if(t!==o){ImageUriCache.remove(t);var r=ImageUriCache.has(o);r&&ImageUriCache.add(o),this._updateImageState(getImageState(o,r))}this._imageState===STATUS_PENDING&&this._createImageLoader()},o.componentWillUnmount=function(){var e=resolveAssetUri(this.props.source);ImageUriCache.remove(e),this._destroyImageLoader(),this._isMounted=!1},o.render=function(){var e=this.state.shouldDisplaySource,t=this.props,o=t.accessibilityLabel,r=t.accessible,a=t.blurRadius,i=t.defaultSource,n=t.draggable,s=t.source,c=t.testID,l=(t.capInsets,t.onError,t.onLayout,t.onLoad,t.onLoadEnd,t.onLoadStart,t.resizeMethod,t.resizeMode),u=_objectWithoutPropertiesLoose(t,["accessibilityLabel","accessible","blurRadius","defaultSource","draggable","source","testID","capInsets","onError","onLayout","onLoad","onLoadEnd","onLoadStart","resizeMethod","resizeMode"]);if("production"!==process.env.NODE_ENV&&(this.props.src&&console.warn("The <Image> component requires a `source` property rather than `src`."),this.props.children))throw new Error("The <Image> component cannot contain children. If you want to render content on top of the image, consider using the <ImageBackground> component or absolute positioning.");var d=e?s:i,p=resolveAssetUri(d),m=resolveAssetDimensions(d),h=p?'url("'+p+'")':null,g=_objectSpread({},StyleSheet.flatten(this.props.style)),f=l||g.resizeMode||ImageResizeMode.cover,S=[],y=g.tintColor;if(g.filter&&S.push(g.filter),a&&S.push("blur("+a+"px)"),g.shadowOffset){var I=resolveShadowValue(g);I&&S.push("drop-shadow("+I+")")}g.tintColor&&S.push("url(#tint-"+this._filterId+")"),delete g.shadowColor,delete g.shadowOpacity,delete g.shadowOffset,delete g.shadowRadius,delete g.tintColor,delete g.overlayColor,delete g.resizeMode;var _=p?createElement("img",{alt:o||"",classList:[classes.accessibilityImage],draggable:n||!1,ref:this._setImageRef,src:p}):null;return React.createElement(View,_extends({},u,{accessibilityLabel:o,accessible:r,onLayout:this._createLayoutHandler(f),style:[styles.root,this.context.isInAParentText&&styles.inline,m,g],testID:c}),React.createElement(View,{style:[styles.image,resizeModeStyles[f],this._getBackgroundSize(f),h&&{backgroundImage:h},S.length>0&&{filter:S.join(" ")}]}),_,createTintColorSVG(y,this._filterId))},o._createImageLoader=function(){var e=this.props.source;this._destroyImageLoader();var t=resolveAssetUri(e);this._imageRequestId=ImageLoader.load(t,this._onLoad,this._onError),this._onLoadStart()},o._destroyImageLoader=function(){this._imageRequestId&&(ImageLoader.abort(this._imageRequestId),this._imageRequestId=null)},o._onLoadEnd=function(){var e=this.props.onLoadEnd;e&&e()},o._onLoadStart=function(){var e=this.props.onLoadStart;this._updateImageState(STATUS_LOADING),e&&e()},o._updateImageState=function(e){this._imageState=e;var t=this._imageState===STATUS_LOADED||this._imageState===STATUS_LOADING;t!==this.state.shouldDisplaySource&&this._isMounted&&this.setState(function(){return{shouldDisplaySource:t}})},t}(Component);Image.displayName="Image",Image.contextTypes={isInAParentText:bool},Image.defaultProps={style:emptyObject},Image.propTypes="production"!==process.env.NODE_ENV?_objectSpread({},ViewPropTypes,{blurRadius:number,defaultSource:ImageSourcePropType,draggable:bool,onError:func,onLayout:func,onLoad:func,onLoadEnd:func,onLoadStart:func,resizeMode:oneOf(Object.keys(ImageResizeMode)),source:ImageSourcePropType,style:StyleSheetPropType(ImageStylePropTypes),capInsets:shape({top:number,left:number,bottom:number,right:number}),resizeMethod:oneOf(["auto","resize","scale"])}):{};var classes=css.create({accessibilityImage:_objectSpread({},StyleSheet.absoluteFillObject,{height:"100%",opacity:0,width:"100%",zIndex:-1})}),styles=StyleSheet.create({root:{flexBasis:"auto",overflow:"hidden",zIndex:0},inline:{display:"inline-flex"},image:_objectSpread({},StyleSheet.absoluteFillObject,{backgroundColor:"transparent",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"cover",height:"100%",width:"100%",zIndex:-1})}),resizeModeStyles=StyleSheet.create({center:{backgroundSize:"auto"},contain:{backgroundSize:"contain"},cover:{backgroundSize:"cover"},none:{backgroundPosition:"0 0",backgroundSize:"auto"},repeat:{backgroundPosition:"0 0",backgroundRepeat:"repeat",backgroundSize:"auto"},stretch:{backgroundSize:"100% 100%"}});export default applyNativeMethods(Image);