"use strict";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import Pane from"./Pane.js";import Pointer from"../Core/Pointer.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,animObject=U.animObject,defined=U.defined,find=U.find,isNumber=U.isNumber,pick=U.pick,splat=U.splat,uniqueKey=U.uniqueKey,wrap=U.wrap;import"../Core/Series/Series.js";var colProto,arearangeProto,Series=H.Series,seriesTypes=H.seriesTypes,seriesProto=Series.prototype,pointerProto=Pointer.prototype;seriesProto.searchPointByAngle=function(t){var e=this.chart,i=this.xAxis.pane.center,r=t.chartX-i[0]-e.plotLeft,a=t.chartY-i[1]-e.plotTop;return this.searchKDTree({clientX:180+Math.atan2(r,a)*(-180/Math.PI)})},seriesProto.getConnectors=function(t,e,i,r){var a,s,o,n,l,p,h,c,d,f,g,P,u,y,A,m,v,x,C,X,Y,M=r?1:0;return s=(a=e>=0&&e<=t.length-1?e:e<0?t.length-1+e:0)-1<0?t.length-(1+M):a-1,o=a+1>t.length-1?M:a+1,n=t[s],l=t[o],p=n.plotX,h=n.plotY,c=l.plotX,d=l.plotY,u=(1.5*(f=t[a].plotX)+p)/2.5,y=(1.5*(g=t[a].plotY)+h)/2.5,A=(1.5*f+c)/2.5,m=(1.5*g+d)/2.5,v=Math.sqrt(Math.pow(u-f,2)+Math.pow(y-g,2)),x=Math.sqrt(Math.pow(A-f,2)+Math.pow(m-g,2)),C=Math.atan2(y-g,u-f),X=Math.atan2(m-g,A-f),Y=Math.PI/2+(C+X)/2,Math.abs(C-Y)>Math.PI/2&&(Y-=Math.PI),u=f+Math.cos(Y)*v,y=g+Math.sin(Y)*v,P={rightContX:A=f+Math.cos(Math.PI+Y)*x,rightContY:m=g+Math.sin(Math.PI+Y)*x,leftContX:u,leftContY:y,plotX:f,plotY:g},i&&(P.prevPointCont=this.getConnectors(t,s,!1,r)),P},seriesProto.toXY=function(t){var e,i,r=this.chart,a=this.xAxis,s=this.yAxis,o=t.plotX,n=t.plotY,l=t.series,p=r.inverted,h=t.y,c=p?o:s.len-n;p&&l&&!l.isRadialBar&&(t.plotY=n="number"==typeof h&&s.translate(h)||0),t.rectPlotX=o,t.rectPlotY=n,s.center&&(c+=s.center[3]/2),e=p?s.postTranslate(n,c):a.postTranslate(o,c),t.plotX=t.polarPlotX=e.x-r.plotLeft,t.plotY=t.polarPlotY=e.y-r.plotTop,this.kdByAngle?((i=(o/Math.PI*180+a.pane.options.startAngle)%360)<0&&(i+=360),t.clientX=i):t.clientX=t.plotX},seriesTypes.spline&&(wrap(seriesTypes.spline.prototype,"getPointSpline",function(t,e,i,r){var a;return this.chart.polar?r?["C",(a=this.getConnectors(e,r,!0,this.connectEnds)).prevPointCont.rightContX,a.prevPointCont.rightContY,a.leftContX,a.leftContY,a.plotX,a.plotY]:["M",i.plotX,i.plotY]:t.call(this,e,i,r)}),seriesTypes.areasplinerange&&(seriesTypes.areasplinerange.prototype.getPointSpline=seriesTypes.spline.prototype.getPointSpline)),addEvent(Series,"afterTranslate",function(){var t=this.chart;if(t.polar&&this.xAxis){if(this.kdByAngle=t.tooltip&&t.tooltip.shared,this.kdByAngle?this.searchPoint=this.searchPointByAngle:this.options.findNearestPointBy="xy",!this.preventPostTranslate)for(var e=this.points,i=e.length;i--;)this.toXY(e[i]),!t.hasParallelCoordinates&&!this.yAxis.reversed&&e[i].y<this.yAxis.min&&(e[i].isNull=!0);this.hasClipCircleSetter||(this.hasClipCircleSetter=!!this.eventsToUnbind.push(addEvent(this,"afterRender",function(){var e;t.polar&&(e=this.yAxis.pane.center,this.clipCircle?this.clipCircle.animate({x:e[0],y:e[1],r:e[2]/2,innerR:e[3]/2}):this.clipCircle=t.renderer.clipCircle(e[0],e[1],e[2]/2,e[3]/2),this.group.clip(this.clipCircle),this.setClip=H.noop)})))}},{order:2}),wrap(seriesProto,"getGraphPath",function(t,e){var i,r,a,s=this;if(this.chart.polar){for(e=e||this.points,i=0;i<e.length;i++)if(!e[i].isNull){r=i;break}!1!==this.options.connectEnds&&void 0!==r&&(this.connectEnds=!0,e.splice(e.length,0,e[r]),a=!0),e.forEach(function(t){void 0===t.polarPlotY&&s.toXY(t)})}var o=t.apply(this,[].slice.call(arguments,1));return a&&e.pop(),o});var polarAnimate=function(t,e){var i,r,a,s,o,n,l=this,p=this.chart,h=this.options.animation,c=this.group,d=this.markerGroup,f=this.xAxis.center,g=p.plotLeft,P=p.plotTop;p.polar?l.isRadialBar?e||(l.startAngleRad=pick(l.translatedThreshold,l.xAxis.startAngleRad),H.seriesTypes.pie.prototype.animate.call(l,e)):p.renderer.isSVG&&(h=animObject(h),l.is("column")?e||(r=f[3]/2,l.points.forEach(function(t){a=t.graphic,s=t.shapeArgs,o=s&&s.r,n=s&&s.innerR,a&&s&&(a.attr({r:r,innerR:r}),a.animate({r:o,innerR:n},l.options.animation))})):e?(i={translateX:f[0]+g,translateY:f[1]+P,scaleX:.001,scaleY:.001},c.attr(i),d&&d.attr(i)):(i={translateX:g,translateY:P,scaleX:1,scaleY:1},c.animate(i,h),d&&d.animate(i,h))):t.call(this,e)};wrap(seriesProto,"animate",polarAnimate),seriesTypes.column&&(arearangeProto=seriesTypes.arearange.prototype,(colProto=seriesTypes.column.prototype).polarArc=function(t,e,i,r){var a=this.xAxis.center,s=this.yAxis.len,o=a[3]/2,n=s-e+o,l=s-pick(t,s)+o;return this.yAxis.reversed&&(n<0&&(n=o),l<0&&(l=o)),{x:a[0],y:a[1],r:n,innerR:l,start:i,end:r}},wrap(colProto,"animate",polarAnimate),wrap(colProto,"translate",function(t){var e,i,r,a,s,o,n,l,p,h,c,d,f,g,P,u,y=this.options,A=y.threshold,m=y.stacking,v=this.chart,x=this.xAxis,C=this.yAxis,X=C.reversed,Y=C.center,M=x.startAngleRad,T=x.endAngleRad-M;if(this.preventPostTranslate=!0,t.call(this),x.isRadial)for(a=(i=this.points).length,s=C.translate(C.min),o=C.translate(C.max),A=y.threshold||0,v.inverted&&isNumber(A)&&(e=C.translate(A),defined(e)&&(e<0?e=0:e>T&&(e=T),this.translatedThreshold=e+M));a--;)g=(r=i[a]).barX,h=r.x,c=r.y,r.shapeType="arc",v.inverted?(r.plotY=C.translate(c),m&&C.stacking?(f=C.stacking.stacks[(c<0?"-":"")+this.stackKey],this.visible&&f&&f[h]&&(r.isNull||(d=f[h].points[this.getStackIndicator(void 0,h,this.index).key],n=C.translate(d[0]),l=C.translate(d[1]),defined(n)&&(n=U.clamp(n,0,T))))):(n=e,l=r.plotY),n>l&&(l=[n,n=l][0]),X?l>s?l=s:n<o?n=o:(n>s||l<o)&&(n=l=T):n<s?n=s:l>o?l=o:(l<s||n>o)&&(n=l=0),C.min>C.max&&(n=l=X?T:0),n+=M,l+=M,Y&&(r.barX=g+=Y[3]/2),P=Math.max(g,0),u=Math.max(g+r.pointWidth,0),r.shapeArgs={x:Y&&Y[0],y:Y&&Y[1],r:u,innerR:P,start:n,end:l},r.opacity=n===l?0:void 0,r.plotY=(defined(this.translatedThreshold)&&(n<this.translatedThreshold?n:l))-M):(n=g+M,r.shapeArgs=this.polarArc(r.yBottom,r.plotY,n,n+r.pointWidth)),this.toXY(r),v.inverted?(p=C.postTranslate(r.rectPlotY,g+r.pointWidth/2),r.tooltipPos=[p.x-v.plotLeft,p.y-v.plotTop]):r.tooltipPos=[r.plotX,r.plotY],Y&&(r.ttBelow=r.plotY>Y[1])}),colProto.findAlignments=function(t,e){var i,r;return null===e.align&&(i=t>20&&t<160?"left":t>200&&t<340?"right":"center",e.align=i),null===e.verticalAlign&&(r=t<45||t>315?"bottom":t>135&&t<225?"top":"middle",e.verticalAlign=r),e},arearangeProto&&(arearangeProto.findAlignments=colProto.findAlignments),wrap(colProto,"alignDataLabel",function(t,e,i,r,a,s){var o,n,l,p=this.chart,h=pick(r.inside,!!this.options.stacking);p.polar?(o=e.rectPlotX/Math.PI*180,p.inverted?(this.forceDL=p.isInsidePlot(e.plotX,Math.round(e.plotY),!1),h&&e.shapeArgs?(n=e.shapeArgs,a={x:(l=this.yAxis.postTranslate((n.start+n.end)/2-this.xAxis.startAngleRad,e.barX+e.pointWidth/2)).x-p.plotLeft,y:l.y-p.plotTop}):e.tooltipPos&&(a={x:e.tooltipPos[0],y:e.tooltipPos[1]}),r.align=pick(r.align,"center"),r.verticalAlign=pick(r.verticalAlign,"middle")):this.findAlignments&&(r=this.findAlignments(o,r)),seriesProto.alignDataLabel.call(this,e,i,r,a,s),this.isRadialBar&&e.shapeArgs&&e.shapeArgs.start===e.shapeArgs.end&&i.hide(!0)):t.call(this,e,i,r,a,s)})),wrap(pointerProto,"getCoordinates",function(t,e){var i=this.chart,r={xAxis:[],yAxis:[]};return i.polar?i.axes.forEach(function(t){var a,s,o=t.isXAxis,n=t.center;"colorAxis"!==t.coll&&(a=e.chartX-n[0]-i.plotLeft,s=e.chartY-n[1]-i.plotTop,r[o?"xAxis":"yAxis"].push({axis:t,value:t.translate(o?Math.PI-Math.atan2(a,s):Math.sqrt(Math.pow(a,2)+Math.pow(s,2)),!0)}))}):r=t.call(this,e),r}),SVGRenderer.prototype.clipCircle=function(t,e,i,r){var a,s=uniqueKey(),o=this.createElement("clipPath").attr({id:s}).add(this.defs);return(a=r?this.arc(t,e,i,r,0,2*Math.PI).add(o):this.circle(t,e,i).add(o)).id=s,a.clipPath=o,a},addEvent(Chart,"getAxes",function(){this.pane||(this.pane=[]),splat(this.options.pane).forEach(function(t){new Pane(t,this)},this)}),addEvent(Chart,"afterDrawChartBox",function(){this.pane.forEach(function(t){t.render()})}),addEvent(H.Series,"afterInit",function(){var t=this.chart;t.inverted&&t.polar&&(this.isRadialSeries=!0,this.is("column")&&(this.isRadialBar=!0))}),wrap(Chart.prototype,"get",function(t,e){return find(this.pane,function(t){return t.options.id===e})||t.call(this,e)});