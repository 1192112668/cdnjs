"use strict";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import Color from"../Core/Color.js";var color=Color.parse;import U from"../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,wrap=U.wrap;import"../Core/Series/Series.js";import"../Core/Options.js";var destroyLoadingDiv,win=H.win,doc=win.document,noop=function(){},Series=H.Series,seriesTypes=H.seriesTypes,CHUNK_SIZE=5e4;H.initCanvasBoost=function(){H.seriesTypes.heatmap&&wrap(H.seriesTypes.heatmap.prototype,"drawPoints",function(){var e=this.chart,t=this.getContext(),o=this.chart.inverted,i=this.xAxis,r=this.yAxis;t?(this.points.forEach(function(s){var n,a,c=s.plotY;void 0===c||isNaN(c)||null===s.y||(n=s.shapeArgs,a=e.styledMode?s.series.colorAttribs(s):s.series.pointAttribs(s),t.fillStyle=a.fill,o?t.fillRect(r.len-n.y+i.left,i.len-n.x+r.top,-n.height,-n.width):t.fillRect(n.x+i.left,n.y+r.top,n.width,n.height))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}),extend(Series.prototype,{getContext:function(){var e,t=this.chart,o=t.chartWidth,i=t.chartHeight,r=t.seriesGroup||this.group,s=this,n=function(e,t,o,i,r,s,n){e.call(this,o,t,i,r,s,n)};return t.isChartSeriesBoosting()&&(s=t,r=t.seriesGroup),e=s.ctx,s.canvas?H.Chart:(s.canvas=doc.createElement("canvas"),s.renderTarget=t.renderer.image("",0,0,o,i).addClass("highcharts-boost-canvas").add(r),s.ctx=e=s.canvas.getContext("2d"),t.inverted&&["moveTo","lineTo","rect","arc"].forEach(function(t){wrap(e,t,n)}),s.boostCopy=function(){s.renderTarget.attr({href:s.canvas.toDataURL("image/png")})},s.boostClear=function(){e.clearRect(0,0,s.canvas.width,s.canvas.height),s===this&&s.renderTarget.attr({href:""})},s.boostClipRect=t.renderer.clipRect(),s.renderTarget.clip(s.boostClipRect)),s.canvas.width!==o&&(s.canvas.width=o),s.canvas.height!==i&&(s.canvas.height=i),s.renderTarget.attr({x:0,y:0,width:o,height:i,style:"pointer-events: none",href:""}),s.boostClipRect.attr(t.getBoostClipRect(s)),e},canvasToSVG:function(){this.chart.isChartSeriesBoosting()?this.boostClear&&this.boostClear():(this.boostCopy||this.chart.boostCopy)&&(this.boostCopy||this.chart.boostCopy)()},cvsLineTo:function(e,t,o){e.lineTo(t,o)},renderCanvas:function(){var e,t,o,i,r,s,n,a,c,l,p=this,h=p.options,d=p.chart,v=this.xAxis,u=this.yAxis,g=d.options.boost||{},y=g.timeRendering||!1,f=(g.timeSeriesProcessing,g.timeSetup,0),m=p.processedXData,C=p.processedYData,b=h.data,T=v.getExtremes(),x=T.min,w=T.max,S=u.getExtremes(),k=S.min,D=S.max,E={},M=!!p.sampling,N=h.marker&&h.marker.radius,P=this.cvsDrawPoint,A=h.lineWidth?this.cvsLineTo:void 0,R=N&&N<=1?this.cvsMarkerSquare:this.cvsMarkerCircle,G=this.cvsStrokeBatch||1e3,L=!1!==h.enableMouseTracking,B=h.threshold,X=u.getThreshold(B),j=isNumber(B),Y=X,O=this.fill,I=p.pointArrayMap&&"low,high"===p.pointArrayMap.join(","),K=!!h.stacking,V=p.cropStart||0,W=d.options.loading,q=p.requireSorting,_=h.connectNulls,Z=!m,z=K?p.data:m||b,J=p.fillOpacity?new Color(p.color).setOpacity(pick(h.fillOpacity,.75)).get():p.color,F=function(){O?(e.fillStyle=J,e.fill()):(e.strokeStyle=p.color,e.lineWidth=h.lineWidth,e.stroke())},Q=function(t,o,s,n){0===f&&(e.beginPath(),A&&(e.lineJoin="round")),d.scroller&&"highcharts-navigator-series"===p.options.className?(o+=d.scroller.top,s&&(s+=d.scroller.top)):o+=d.plotTop,t+=d.plotLeft,r?e.moveTo(t,o):P?P(e,t,o,s,i):A?A(e,t,o):R&&R.call(p,e,t,o,N,n),(f+=1)===G&&(F(),f=0),i={clientX:t,plotY:o,yBottom:s}},$="x"===h.findNearestPointBy,ee=this.xData||this.options.xData||this.processedXData||!1,te=function(e,t,i){l=$?e:e+","+t,L&&!E[l]&&(E[l]=!0,d.inverted&&(e=v.len-e,t=u.len-t),o.push({x:!!ee&&ee[V+i],clientX:e,plotX:e,plotY:t,i:V+i}))};this.renderTarget&&this.renderTarget.attr({href:""}),(this.points||this.graph)&&this.destroyGraphics(),p.plotGroup("group","series",p.visible?"visible":"hidden",h.zIndex,d.seriesGroup),p.markerGroup=p.group,addEvent(p,"destroy",function(){p.markerGroup=null}),o=this.points=[],e=this.getContext(),p.buildKDTree=noop,this.boostClear&&this.boostClear(),this.visible&&(b.length>99999&&(d.options.loading=merge(W,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(destroyLoadingDiv),d.showLoading("Drawing..."),d.options.loading=W),y&&console.time("canvas rendering"),H.eachAsync(z,function(e,o){var i,l,h,g,y,f,m=!1,b=!1,T=!1,S=!1,E=void 0===d.index,U=!0;return E||(Z?(i=e[0],l=e[1],z[o+1]&&(T=z[o+1][0]),z[o-1]&&(S=z[o-1][0])):(i=e,l=C[o],z[o+1]&&(T=z[o+1]),z[o-1]&&(S=z[o-1])),T&&T>=x&&T<=w&&(m=!0),S&&S>=x&&S<=w&&(b=!0),I?(Z&&(l=e.slice(1,3)),f=l[0],l=l[1]):K&&(i=e.x,f=(l=e.stackY)-e.y),q||(U=l>=k&&l<=D),!(y=null===l)&&(i>=x&&i<=w&&U||m||b)&&(h=Math.round(v.toPixels(i,!0)),M?(void 0!==a&&h!==t||(I||(f=l),(void 0===c||l>n)&&(n=l,c=o),(void 0===a||f<s)&&(s=f,a=o)),h!==t&&(void 0!==a&&(g=u.toPixels(n,!0),X=u.toPixels(s,!0),Q(h,j?Math.min(g,Y):g,j?Math.max(X,Y):X,o),te(h,g,c),X!==g&&te(h,X,a)),a=c=void 0,t=h)):(g=Math.round(u.toPixels(l,!0)),Q(h,g,X,o),te(h,g,o))),r=y&&!_,o%CHUNK_SIZE==0&&(p.boostCopy||p.chart.boostCopy)&&(p.boostCopy||p.chart.boostCopy)()),!E},function(){var e=d.loadingDiv,t=d.loadingShown;F(),p.canvasToSVG(),y&&console.timeEnd("canvas rendering"),fireEvent(p,"renderedCanvas"),t&&(extend(e.style,{transition:"opacity 250ms",opacity:0}),d.loadingShown=!1,destroyLoadingDiv=setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e),d.loadingDiv=d.loadingSpan=null},250)),delete p.buildKDTree,p.buildKDTree()},d.renderer.forExport?Number.MAX_VALUE:void 0))}}),seriesTypes.scatter.prototype.cvsMarkerCircle=function(e,t,o,i){e.moveTo(t,o),e.arc(t,o,i,0,2*Math.PI,!1)},seriesTypes.scatter.prototype.cvsMarkerSquare=function(e,t,o,i){e.rect(t-i,o-i,2*i,2*i)},seriesTypes.scatter.prototype.fill=!0,seriesTypes.bubble&&(seriesTypes.bubble.prototype.cvsMarkerCircle=function(e,t,o,i,r){e.moveTo(t,o),e.arc(t,o,this.radii&&this.radii[r],0,2*Math.PI,!1)},seriesTypes.bubble.prototype.cvsStrokeBatch=1),extend(seriesTypes.area.prototype,{cvsDrawPoint:function(e,t,o,i,r){r&&t!==r.clientX&&(e.moveTo(r.clientX,r.yBottom),e.lineTo(r.clientX,r.plotY),e.lineTo(t,o),e.lineTo(t,i))},fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{cvsDrawPoint:function(e,t,o,i){e.rect(t-1,o,1,i-o)},fill:!0,sampling:!0}),Chart.prototype.callbacks.push(function(e){addEvent(e,"predraw",function(){e.renderTarget&&e.renderTarget.attr({href:""}),e.canvas&&e.canvas.getContext("2d").clearRect(0,0,e.canvas.width,e.canvas.height)}),addEvent(e,"render",function(){e.boostCopy&&e.boostCopy()})})};