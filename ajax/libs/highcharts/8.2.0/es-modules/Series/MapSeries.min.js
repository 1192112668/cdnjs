"use strict";import H from"../Core/Globals.js";import LegendSymbolMixin from"../Mixins/LegendSymbol.js";import Point from"../Core/Series/Point.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var extend=U.extend,fireEvent=U.fireEvent,getNestedProperty=U.getNestedProperty,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,seriesType=U.seriesType,splat=U.splat;import"../Core/Options.js";import"../Series/ScatterSeries.js";import"../Core/Series/Series.js";import"../Mixins/ColorMapSeries.js";var colorMapPointMixin=H.colorMapPointMixin,colorMapSeriesMixin=H.colorMapSeriesMixin,noop=H.noop,Series=H.Series,seriesTypes=H.seriesTypes;seriesType("map","scatter",{animation:!1,dataLabels:{crop:!1,formatter:function(){return this.point.value},inside:!0,overflow:!1,padding:0,verticalAlign:"middle"},marker:null,nullColor:"#f7f7f7",stickyTracking:!1,tooltip:{followPointer:!0,pointFormat:"{point.name}: {point.value}<br/>"},turboThreshold:0,allAreas:!0,borderColor:"#cccccc",borderWidth:1,joinBy:"hc-key",states:{hover:{halo:null,brightness:.2},normal:{animation:!0},select:{color:"#cccccc"},inactive:{opacity:1}}},merge(colorMapSeriesMixin,{type:"map",getExtremesFromAll:!0,useMapGeometry:!0,forceDL:!0,searchPoint:noop,directTouch:!0,preserveAspectRatio:!0,pointArrayMap:["value"],setOptions:function(t){var e=Series.prototype.setOptions.call(this,t),i=e.joinBy;return null===i&&(i="_i"),(i=this.joinBy=splat(i))[1]||(i[1]=i[0]),e},getBox:function(t){var e,i=Number.MAX_VALUE,a=-i,r=i,s=-i,n=i,o=i,p=this.xAxis,l=this.yAxis;(t||[]).forEach(function(t){if(t.path){"string"==typeof t.path?t.path=H.splitPath(t.path):"M"===t.path[0]&&(t.path=SVGRenderer.prototype.pathToSegments(t.path));var p=t.path||[],l=-i,h=i,c=-i,m=i,d=t.properties;t._foundBox||(p.forEach(function(t){var e=t[t.length-2],i=t[t.length-1];"number"==typeof e&&"number"==typeof i&&(h=Math.min(h,e),l=Math.max(l,e),m=Math.min(m,i),c=Math.max(c,i))}),t._midX=h+(l-h)*pick(t.middleX,d&&d["hc-middle-x"],.5),t._midY=m+(c-m)*pick(t.middleY,d&&d["hc-middle-y"],.5),t._maxX=l,t._minX=h,t._maxY=c,t._minY=m,t.labelrank=pick(t.labelrank,(l-h)*(c-m)),t._foundBox=!0),a=Math.max(a,t._maxX),r=Math.min(r,t._minX),s=Math.max(s,t._maxY),n=Math.min(n,t._minY),o=Math.min(t._maxX-t._minX,t._maxY-t._minY,o),e=!0}}),e&&(this.minY=Math.min(n,pick(this.minY,i)),this.maxY=Math.max(s,pick(this.maxY,-i)),this.minX=Math.min(r,pick(this.minX,i)),this.maxX=Math.max(a,pick(this.maxX,-i)),p&&void 0===p.options.minRange&&(p.minRange=Math.min(5*o,(this.maxX-this.minX)/5,p.minRange||i)),l&&void 0===l.options.minRange&&(l.minRange=Math.min(5*o,(this.maxY-this.minY)/5,l.minRange||i)))},hasData:function(){return!!this.processedXData.length},getExtremes:function(){var t=Series.prototype.getExtremes.call(this,this.valueData),e=t.dataMin,i=t.dataMax;return this.chart.hasRendered&&this.isDirtyData&&this.getBox(this.options.data),isNumber(e)&&(this.valueMin=e),isNumber(i)&&(this.valueMax=i),{dataMin:this.minY,dataMax:this.maxY}},translatePath:function(t){var e=this.xAxis,i=this.yAxis,a=e.min,r=e.transA,s=e.minPixelPadding,n=i.min,o=i.transA,p=i.minPixelPadding,l=[];return t&&t.forEach(function(t){"M"===t[0]?l.push(["M",(t[1]-(a||0))*r+s,(t[2]-(n||0))*o+p]):"L"===t[0]?l.push(["L",(t[1]-(a||0))*r+s,(t[2]-(n||0))*o+p]):"C"===t[0]?l.push(["C",(t[1]-(a||0))*r+s,(t[2]-(n||0))*o+p,(t[3]-(a||0))*r+s,(t[4]-(n||0))*o+p,(t[5]-(a||0))*r+s,(t[6]-(n||0))*o+p]):"Q"===t[0]?l.push(["Q",(t[1]-(a||0))*r+s,(t[2]-(n||0))*o+p,(t[3]-(a||0))*r+s,(t[4]-(n||0))*o+p]):"Z"===t[0]&&l.push(["Z"])}),l},setData:function(t,e,i,a){var r,s,n,o=this.options,p=this.chart.options.chart,l=p&&p.map,h=o.mapData,c=this.joinBy,m=o.keys||this.pointArrayMap,d=[],u={},f=this.chart.mapTransforms;if(!h&&l&&(h="string"==typeof l?H.maps[l]:l),t&&t.forEach(function(e,i){var a=0;if(isNumber(e))t[i]={value:e};else if(isArray(e)){t[i]={},!o.keys&&e.length>m.length&&"string"==typeof e[0]&&(t[i]["hc-key"]=e[0],++a);for(var r=0;r<m.length;++r,++a)m[r]&&void 0!==e[a]&&(m[r].indexOf(".")>0?Point.prototype.setNestedProperty(t[i],e[a],m[r]):t[i][m[r]]=e[a])}c&&"_i"===c[0]&&(t[i]._i=i)}),this.getBox(t),this.chart.mapTransforms=f=p&&p.mapTransforms||h&&h["hc-transform"]||f,f&&objectEach(f,function(t){t.rotation&&(t.cosAngle=Math.cos(t.rotation),t.sinAngle=Math.sin(t.rotation))}),h){for("FeatureCollection"===h.type&&(this.mapTitle=h.title,h=H.geojson(h,this.type,this)),this.mapData=h,this.mapMap={},n=0;n<h.length;n++)s=(r=h[n]).properties,r._i=n,c[0]&&s&&s[c[0]]&&(r[c[0]]=s[c[0]]),u[r[c[0]]]=r;if(this.mapMap=u,t&&c[1]){var x=c[1];t.forEach(function(t){var e=getNestedProperty(x,t);u[e]&&d.push(u[e])})}if(o.allAreas){if(this.getBox(h),t=t||[],c[1]){var y=c[1];t.forEach(function(t){d.push(getNestedProperty(y,t))})}d="|"+d.map(function(t){return t&&t[c[0]]}).join("|")+"|",h.forEach(function(e){c[0]&&-1!==d.indexOf("|"+e[c[0]]+"|")||(t.push(merge(e,{value:null})),a=!1)})}else this.getBox(d)}Series.prototype.setData.call(this,t,e,i,a)},drawGraph:noop,drawDataLabels:noop,doFullTranslate:function(){return this.isDirtyData||this.chart.isResizing||this.chart.renderer.isVML||!this.baseTrans},translate:function(){var t=this,e=t.xAxis,i=t.yAxis,a=t.doFullTranslate();t.generatePoints(),t.data.forEach(function(r){isNumber(r._midX)&&isNumber(r._midY)&&(r.plotX=e.toPixels(r._midX,!0),r.plotY=i.toPixels(r._midY,!0)),a&&(r.shapeType="path",r.shapeArgs={d:t.translatePath(r.path)})}),fireEvent(t,"afterTranslate")},pointAttribs:function(t,e){var i=t.series.chart.styledMode?this.colorAttribs(t):seriesTypes.column.prototype.pointAttribs.call(this,t,e);return i["stroke-width"]=pick(t.options[this.pointAttrToOptions&&this.pointAttrToOptions["stroke-width"]||"borderWidth"],"inherit"),i},drawPoints:function(){var t,e,i,a,r,s,n,o,p,l=this,h=l.xAxis,c=l.yAxis,m=l.group,d=l.chart,u=d.renderer,f=this.baseTrans;l.transformGroup||(l.transformGroup=u.g().attr({scaleX:1,scaleY:1}).add(m),l.transformGroup.survive=!0),l.doFullTranslate()?(d.hasRendered&&!d.styledMode&&l.points.forEach(function(t){t.shapeArgs&&(t.shapeArgs.fill=l.pointAttribs(t,t.state).fill)}),l.group=l.transformGroup,seriesTypes.column.prototype.drawPoints.apply(l),l.group=m,l.points.forEach(function(t){if(t.graphic){var e="";t.name&&(e+="highcharts-name-"+t.name.replace(/ /g,"-").toLowerCase()),t.properties&&t.properties["hc-key"]&&(e+=" highcharts-key-"+t.properties["hc-key"].toLowerCase()),e&&t.graphic.addClass(e),d.styledMode&&t.graphic.css(l.pointAttribs(t,t.selected?"select":void 0))}}),this.baseTrans={originX:h.min-h.minPixelPadding/h.transA,originY:c.min-c.minPixelPadding/c.transA+(c.reversed?0:c.len/c.transA),transAX:h.transA,transAY:c.transA},this.transformGroup.animate({translateX:0,translateY:0,scaleX:1,scaleY:1})):(t=h.transA/f.transAX,e=c.transA/f.transAY,i=h.toPixels(f.originX,!0),a=c.toPixels(f.originY,!0),t>.99&&t<1.01&&e>.99&&e<1.01&&(t=1,e=1,i=Math.round(i),a=Math.round(a)),r=this.transformGroup,d.renderer.globalAnimation?(s=r.attr("translateX"),n=r.attr("translateY"),o=r.attr("scaleX"),p=r.attr("scaleY"),r.attr({animator:0}).animate({animator:1},{step:function(l,h){r.attr({translateX:s+(i-s)*h.pos,translateY:n+(a-n)*h.pos,scaleX:o+(t-o)*h.pos,scaleY:p+(e-p)*h.pos})}})):r.attr({translateX:i,translateY:a,scaleX:t,scaleY:e})),d.styledMode||m.element.setAttribute("stroke-width",pick(l.options[l.pointAttrToOptions&&l.pointAttrToOptions["stroke-width"]||"borderWidth"],1)/(t||1)),this.drawMapDataLabels()},drawMapDataLabels:function(){Series.prototype.drawDataLabels.call(this),this.dataLabelsGroup&&this.dataLabelsGroup.clip(this.chart.clipRect)},render:function(){var t=this,e=Series.prototype.render;t.chart.renderer.isVML&&t.data.length>3e3?setTimeout(function(){e.call(t)}):e.call(t)},animate:function(t){var e=this.chart,i=this.options.animation,a=this.group,r=this.xAxis,s=this.yAxis,n=r.pos,o=s.pos;e.renderer.isSVG&&(!0===i&&(i={duration:1e3}),t?a.attr({translateX:n+r.len/2,translateY:o+s.len/2,scaleX:.001,scaleY:.001}):a.animate({translateX:n,translateY:o,scaleX:1,scaleY:1},i))},animateDrilldown:function(t){var e,i=this.chart.plotBox,a=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],r=a.bBox,s=this.chart.options.drilldown.animation;t||(e=Math.min(r.width/i.width,r.height/i.height),a.shapeArgs={scaleX:e,scaleY:e,translateX:r.x,translateY:r.y},this.points.forEach(function(t){t.graphic&&t.graphic.attr(a.shapeArgs).animate({scaleX:1,scaleY:1,translateX:0,translateY:0},s)}))},drawLegendSymbol:LegendSymbolMixin.drawRectangle,animateDrillupFrom:function(t){seriesTypes.column.prototype.animateDrillupFrom.call(this,t)},animateDrillupTo:function(t){seriesTypes.column.prototype.animateDrillupTo.call(this,t)}}),extend({applyOptions:function(t,e){var i,a=this.series,r=Point.prototype.applyOptions.call(this,t,e),s=a.joinBy;if(a.mapData&&a.mapMap){var n=s[1],o=Point.prototype.getNestedProperty.call(r,n);(i=void 0!==o&&a.mapMap[o])?(a.xyFromShape&&(r.x=i._midX,r.y=i._midY),extend(r,i)):r.value=r.value||null}return r},onMouseOver:function(t){U.clearTimeout(this.colorInterval),null!==this.value||this.series.options.nullInteraction?Point.prototype.onMouseOver.call(this,t):this.series.onMouseOut(t)},zoomTo:function(){var t=this.series;t.xAxis.setExtremes(this._minX,this._maxX,!1),t.yAxis.setExtremes(this._minY,this._maxY,!1),t.chart.redraw()}},colorMapPointMixin));