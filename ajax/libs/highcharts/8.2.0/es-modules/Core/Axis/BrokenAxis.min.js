"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import U from"../Utilities.js";var addEvent=U.addEvent,find=U.find,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,pick=U.pick;import"../Series/Series.js";import StackItem from"../../Extensions/Stacking.js";var Series=H.Series,BrokenAxisAdditions=function(){function i(i){this.hasBreaks=!1,this.axis=i}return i.isInBreak=function(i,t){var n=i.repeat||1/0,r=i.from,s=i.to-i.from,e=t>=r?(t-r)%n:n-(r-t)%n;return i.inclusive?e<=s:e<s&&0!==e},i.lin2Val=function(t){var n=this.brokenAxis,r=n&&n.breakArray;if(!r)return t;var s,e,o=t;for(e=0;e<r.length&&!((s=r[e]).from>=o);e++)s.to<o?o+=s.len:i.isInBreak(s,o)&&(o+=s.len);return o},i.val2Lin=function(t){var n=this.brokenAxis,r=n&&n.breakArray;if(!r)return t;var s,e,o=t;for(e=0;e<r.length;e++)if((s=r[e]).to<=t)o-=s.len;else{if(s.from>=t)break;if(i.isInBreak(s,t)){o-=t-s.from;break}}return o},i.prototype.findBreakAt=function(i,t){return find(t,function(t){return t.from<i&&i<t.to})},i.prototype.isInAnyBreak=function(t,n){var r,s,e,o=this.axis,a=o.options.breaks,f=a&&a.length;if(f){for(;f--;)i.isInBreak(a[f],t)&&(r=!0,s||(s=pick(a[f].showPoints,!o.isXAxis)));e=r&&n?r&&!s:r}return e},i.prototype.setBreaks=function(t,n){var r=this,s=r.axis,e=isArray(t)&&!!t.length;s.isDirty=r.hasBreaks!==e,r.hasBreaks=e,s.options.breaks=s.userOptions.breaks=t,s.forceRedraw=!0,s.series.forEach(function(i){i.isDirty=!0}),e||s.val2lin!==i.val2Lin||(delete s.val2lin,delete s.lin2val),e&&(s.userOptions.ordinal=!1,s.lin2val=i.lin2Val,s.val2lin=i.val2Lin,s.setExtremes=function(i,t,n,s,e){if(r.hasBreaks){for(var o,a=this.options.breaks;o=r.findBreakAt(i,a);)i=o.to;for(;o=r.findBreakAt(t,a);)t=o.from;t<i&&(t=i)}Axis.prototype.setExtremes.call(this,i,t,n,s,e)},s.setAxisTranslation=function(t){if(Axis.prototype.setAxisTranslation.call(this,t),r.unitLength=null,r.hasBreaks){var n,e,o,a,f=s.options.breaks||[],k=[],u=[],h=0,c=s.userMin||s.min,l=s.userMax||s.max,p=pick(s.pointRangePadding,0);f.forEach(function(t){e=t.repeat||1/0,i.isInBreak(t,c)&&(c+=t.to%e-c%e),i.isInBreak(t,l)&&(l-=l%e-t.from%e)}),f.forEach(function(i){for(o=i.from,e=i.repeat||1/0;o-e>c;)o-=e;for(;o<c;)o+=e;for(a=o;a<l;a+=e)k.push({value:a,move:"in"}),k.push({value:a+(i.to-i.from),move:"out",size:i.breakSize})}),k.sort(function(i,t){return i.value===t.value?("in"===i.move?0:1)-("in"===t.move?0:1):i.value-t.value}),n=0,o=c,k.forEach(function(i){1===(n+="in"===i.move?1:-1)&&"in"===i.move&&(o=i.value),0===n&&(u.push({from:o,to:i.value,len:i.value-o-(i.size||0)}),h+=i.value-o-(i.size||0))}),s.breakArray=r.breakArray=u,r.unitLength=l-c-h+p,fireEvent(s,"afterBreaks"),s.staticScale?s.transA=s.staticScale:r.unitLength&&(s.transA*=(l-s.min+p)/r.unitLength),p&&(s.minPixelPadding=s.transA*s.minPointOffset),s.min=c,s.max=l}}),pick(n,!0)&&s.chart.redraw()},i}(),BrokenAxis=function(){function i(){}return i.compose=function(i,t){i.keepProps.push("brokenAxis");var n=Series.prototype;n.drawBreaks=function(i,t){var n,r,s,e,o=this,a=o.points;if(i&&i.brokenAxis&&i.brokenAxis.hasBreaks){var f=i.brokenAxis;t.forEach(function(t){n=f&&f.breakArray||[],r=i.isXAxis?i.min:pick(o.options.threshold,i.min),a.forEach(function(o){e=pick(o["stack"+t.toUpperCase()],o[t]),n.forEach(function(t){isNumber(r)&&isNumber(e)&&(s=!1,r<t.from&&e>t.to||r>t.from&&e<t.from?s="pointBreak":(r<t.from&&e>t.from&&e<t.to||r>t.from&&e>t.to&&e<t.from)&&(s="pointInBreak"),s&&fireEvent(i,s,{point:o,brk:t}))})})})}},n.gappedPath=function(){var i=this.currentDataGrouping,t=i&&i.gapSize,n=this.options.gapSize,r=this.points.slice(),s=r.length-1,e=this.yAxis;if(n&&s>0){"value"!==this.options.gapUnit&&(n*=this.basePointRange),t&&t>n&&t>=this.basePointRange&&(n=t);for(var o=void 0,a=void 0;s--;)if(a&&!1!==a.visible||(a=r[s+1]),o=r[s],!1!==a.visible&&!1!==o.visible){if(a.x-o.x>n){var f=(o.x+a.x)/2;r.splice(s+1,0,{isNull:!0,x:f}),e.stacking&&this.options.stacking&&((e.stacking.stacks[this.stackKey][f]=new StackItem(e,e.options.stackLabels,!1,f,this.stack)).total=0)}a=o}}return this.getGraphPath(r)},addEvent(i,"init",function(){this.brokenAxis||(this.brokenAxis=new BrokenAxisAdditions(this))}),addEvent(i,"afterInit",function(){void 0!==this.brokenAxis&&this.brokenAxis.setBreaks(this.options.breaks,!1)}),addEvent(i,"afterSetTickPositions",function(){var i=this.brokenAxis;if(i&&i.hasBreaks){var t,n=this.tickPositions,r=this.tickPositions.info,s=[];for(t=0;t<n.length;t++)i.isInAnyBreak(n[t])||s.push(n[t]);this.tickPositions=s,this.tickPositions.info=r}}),addEvent(i,"afterSetOptions",function(){this.brokenAxis&&this.brokenAxis.hasBreaks&&(this.options.ordinal=!1)}),addEvent(t,"afterGeneratePoints",function(){var i=this,t=i.isDirty,n=i.options.connectNulls,r=i.points,s=i.xAxis,e=i.yAxis;if(t)for(var o=r.length;o--;){var a=r[o],f=!(null===a.y&&!1===n)&&(s&&s.brokenAxis&&s.brokenAxis.isInAnyBreak(a.x,!0)||e&&e.brokenAxis&&e.brokenAxis.isInAnyBreak(a.y,!0));a.visible=!f&&!1!==a.options.visible}}),addEvent(t,"afterRender",function(){this.drawBreaks(this.xAxis,["x"]),this.drawBreaks(this.yAxis,pick(this.pointArrayMap,["y"]))})},i}();BrokenAxis.compose(Axis,Series);export default BrokenAxis;