"use strict";import Color from"../../Color.js";var color=Color.parse;import H from"../../Globals.js";import Math3D from"../../../Extensions/Math3D.js";var perspective=Math3D.perspective,shapeArea=Math3D.shapeArea;import SVGElement from"./SVGElement.js";import SVGRenderer from"./SVGRenderer.js";import U from"../../Utilities.js";var dFactor,element3dMethods,cuboidMethods,animObject=U.animObject,defined=U.defined,extend=U.extend,merge=U.merge,objectEach=U.objectEach,pick=U.pick,cos=Math.cos,PI=Math.PI,sin=Math.sin,charts=H.charts,deg2rad=H.deg2rad;function curveTo(e,t,r,i,s,n,a,o){var d=[],h=n-s;return n>s&&n-s>Math.PI/2+1e-4?d=(d=d.concat(curveTo(e,t,r,i,s,s+Math.PI/2,a,o))).concat(curveTo(e,t,r,i,s+Math.PI/2,n,a,o)):n<s&&s-n>Math.PI/2+1e-4?d=(d=d.concat(curveTo(e,t,r,i,s,s-Math.PI/2,a,o))).concat(curveTo(e,t,r,i,s-Math.PI/2,n,a,o)):[["C",e+r*Math.cos(s)-r*dFactor*h*Math.sin(s)+a,t+i*Math.sin(s)+i*dFactor*h*Math.cos(s)+o,e+r*Math.cos(n)+r*dFactor*h*Math.sin(n)+a,t+i*Math.sin(n)-i*dFactor*h*Math.cos(n)+o,e+r*Math.cos(n)+a,t+i*Math.sin(n)+o]]}dFactor=4*(Math.sqrt(2)-1)/3/(PI/2),SVGRenderer.prototype.toLinePath=function(e,t){var r=[];return e.forEach(function(e){r.push(["L",e.x,e.y])}),e.length&&(r[0][0]="M",t&&r.push(["Z"])),r},SVGRenderer.prototype.toLineSegments=function(e){var t=[],r=!0;return e.forEach(function(e){t.push(r?["M",e.x,e.y]:["L",e.x,e.y]),r=!r}),t},SVGRenderer.prototype.face3d=function(e){var t=this,r=this.createElement("path");return r.vertexes=[],r.insidePlotArea=!1,r.enabled=!0,r.attr=function(e){if("object"==typeof e&&(defined(e.enabled)||defined(e.vertexes)||defined(e.insidePlotArea))){this.enabled=pick(e.enabled,this.enabled),this.vertexes=pick(e.vertexes,this.vertexes),this.insidePlotArea=pick(e.insidePlotArea,this.insidePlotArea),delete e.enabled,delete e.vertexes,delete e.insidePlotArea;var r=charts[t.chartIndex],i=perspective(this.vertexes,r,this.insidePlotArea),s=t.toLinePath(i,!0),n=shapeArea(i),a=this.enabled&&n>0?"visible":"hidden";e.d=s,e.visibility=a}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(e){if("object"==typeof e&&(defined(e.enabled)||defined(e.vertexes)||defined(e.insidePlotArea))){this.enabled=pick(e.enabled,this.enabled),this.vertexes=pick(e.vertexes,this.vertexes),this.insidePlotArea=pick(e.insidePlotArea,this.insidePlotArea),delete e.enabled,delete e.vertexes,delete e.insidePlotArea;var r=charts[t.chartIndex],i=perspective(this.vertexes,r,this.insidePlotArea),s=t.toLinePath(i,!0),n=shapeArea(i),a=this.enabled&&n>0?"visible":"hidden";e.d=s,this.attr("visibility",a)}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(e)},SVGRenderer.prototype.polyhedron=function(e){var t=this,r=this.g(),i=r.destroy;return this.styledMode||r.attr({"stroke-linejoin":"round"}),r.faces=[],r.destroy=function(){for(var e=0;e<r.faces.length;e++)r.faces[e].destroy();return i.call(this)},r.attr=function(e,i,s,n){if("object"==typeof e&&defined(e.faces)){for(;r.faces.length>e.faces.length;)r.faces.pop().destroy();for(;r.faces.length<e.faces.length;)r.faces.push(t.face3d().add(r));for(var a=0;a<e.faces.length;a++)t.styledMode&&delete e.faces[a].fill,r.faces[a].attr(e.faces[a],null,s,n);delete e.faces}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(e,i,s){if(e&&e.faces){for(;r.faces.length>e.faces.length;)r.faces.pop().destroy();for(;r.faces.length<e.faces.length;)r.faces.push(t.face3d().add(r));for(var n=0;n<e.faces.length;n++)r.faces[n].animate(e.faces[n],i,s);delete e.faces}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(e)},cuboidMethods=merge(element3dMethods={initArgs:function(e){var t=this,r=t.renderer,i=r[t.pathType+"Path"](e),s=i.zIndexes;t.parts.forEach(function(e){t[e]=r.path(i[e]).attr({class:"highcharts-3d-"+e,zIndex:s[e]||0}).add(t)}),t.attr({"stroke-linejoin":"round",zIndex:s.group}),t.originalDestroy=t.destroy,t.destroy=t.destroyParts,t.forcedSides=i.forcedSides},singleSetterForParts:function(e,t,r,i,s,n){var a={},o=[null,null,i||"attr",s,n],d=r&&r.zIndexes;return r?(d&&d.group&&this.attr({zIndex:d.group}),objectEach(r,function(t,i){a[i]={},a[i][e]=t,d&&(a[i].zIndex=r.zIndexes[i]||0)}),o[1]=a):(a[e]=t,o[0]=a),this.processParts.apply(this,o)},processParts:function(e,t,r,i,s){var n=this;return n.parts.forEach(function(a){t&&(e=pick(t[a],!1)),!1!==e&&n[a][r](e,i,s)}),n},destroyParts:function(){return this.processParts(null,null,"destroy"),this.originalDestroy()}},{parts:["front","top","side"],pathType:"cuboid",attr:function(e,t,r,i){if("string"==typeof e&&void 0!==t){var s=e;(e={})[s]=t}return e.shapeArgs||defined(e.x)?this.singleSetterForParts("d",null,this.renderer[this.pathType+"Path"](e.shapeArgs||e)):SVGElement.prototype.attr.call(this,e,void 0,r,i)},animate:function(e,t,r){if(defined(e.x)&&defined(e.y)){var i=this.renderer[this.pathType+"Path"](e),s=i.forcedSides;this.singleSetterForParts("d",null,i,"animate",t,r),this.attr({zIndex:i.zIndexes.group}),s!==this.forcedSides&&(this.forcedSides=s,cuboidMethods.fillSetter.call(this,this.fill))}else SVGElement.prototype.animate.call(this,e,t,r);return this},fillSetter:function(e){return this.forcedSides=this.forcedSides||[],this.singleSetterForParts("fill",null,{front:e,top:color(e).brighten(this.forcedSides.indexOf("top")>=0?0:.1).get(),side:color(e).brighten(this.forcedSides.indexOf("side")>=0?0:-.1).get()}),this.color=this.fill=e,this}}),SVGRenderer.prototype.elements3d={base:element3dMethods,cuboid:cuboidMethods},SVGRenderer.prototype.element3d=function(e,t){var r=this.g();return extend(r,this.elements3d[e]),r.initArgs(t),r},SVGRenderer.prototype.cuboid=function(e){return this.element3d("cuboid",e)},SVGRenderer.prototype.cuboidPath=function(e){var t,r,i,s,n,a,o,d,h=e.x,c=e.y,p=e.z||0,l=e.height,u=e.width,f=e.depth,y=charts[this.chartIndex],v=y.options.chart.options3d.alpha,M=0,x=[{x:h,y:c,z:p},{x:h+u,y:c,z:p},{x:h+u,y:c+l,z:p},{x:h,y:c+l,z:p},{x:h,y:c+l,z:p+f},{x:h+u,y:c+l,z:p+f},{x:h+u,y:c,z:p+f},{x:h,y:c,z:p+f}],m=[];function P(e){return 0===l&&e>1&&e<6?{x:x[e].x,y:x[e].y+10,z:x[e].z}:x[0].x===x[7].x&&e>=4?{x:x[e].x+10,y:x[e].y,z:x[e].z}:0===f&&e<2||e>5?{x:x[e].x,y:x[e].y,z:x[e].z+10}:x[e]}function b(e){return x[e]}return x=perspective(x,y,e.insidePlotArea),r=(t=(d=function(e,t,r){var i=[[],-1],s=e.map(b),n=t.map(b),a=e.map(P),o=t.map(P);return shapeArea(s)<0?i=[s,0]:shapeArea(n)<0?i=[n,1]:r&&(m.push(r),i=shapeArea(a)<0?[s,0]:shapeArea(o)<0?[n,1]:[s,0]),i})([3,2,1,0],[7,6,5,4],"front"))[0],n=t[1],i=(t=d([1,6,7,0],[4,5,2,3],"top"))[0],a=t[1],s=(t=d([1,2,5,6],[0,7,4,3],"side"))[0],1===(o=t[1])?M+=1e6*(y.plotWidth-h):o||(M+=1e6*h),M+=10*(!a||v>=0&&v<=180||v<360&&v>357.5?y.plotHeight-c:10+c),1===n?M+=100*p:n||(M+=100*(1e3-p)),{front:this.toLinePath(r,!0),top:this.toLinePath(i,!0),side:this.toLinePath(s,!0),zIndexes:{group:Math.round(M)},forcedSides:m,isFront:n,isTop:a}},SVGRenderer.prototype.arc3d=function(e){var t=this.g(),r=t.renderer,i=["x","y","r","innerR","start","end","depth"];function s(e){var t,r=!1,s={};for(t in e=merge(e))-1!==i.indexOf(t)&&(s[t]=e[t],delete e[t],r=!0);return!!r&&[s,e]}return(e=merge(e)).alpha=(e.alpha||0)*deg2rad,e.beta=(e.beta||0)*deg2rad,t.top=r.path(),t.side1=r.path(),t.side2=r.path(),t.inn=r.path(),t.out=r.path(),t.onAdd=function(){var e=t.parentGroup,r=t.attr("class");t.top.add(t),["out","inn","side1","side2"].forEach(function(i){t[i].attr({class:r+" highcharts-3d-side"}).add(e)})},["addClass","removeClass"].forEach(function(e){t[e]=function(){var r=arguments;["top","out","inn","side1","side2"].forEach(function(i){t[i][e].apply(t[i],r)})}}),t.setPaths=function(e){var r=t.renderer.arc3dPath(e),i=100*r.zTop;t.attribs=e,t.top.attr({d:r.top,zIndex:r.zTop}),t.inn.attr({d:r.inn,zIndex:r.zInn}),t.out.attr({d:r.out,zIndex:r.zOut}),t.side1.attr({d:r.side1,zIndex:r.zSide1}),t.side2.attr({d:r.side2,zIndex:r.zSide2}),t.zIndex=i,t.attr({zIndex:i}),e.center&&(t.top.setRadialReference(e.center),delete e.center)},t.setPaths(e),t.fillSetter=function(e){var t=color(e).brighten(-.1).get();return this.fill=e,this.side1.attr({fill:t}),this.side2.attr({fill:t}),this.inn.attr({fill:t}),this.out.attr({fill:t}),this.top.attr({fill:e}),this},["opacity","translateX","translateY","visibility"].forEach(function(e){t[e+"Setter"]=function(e,r){t[r]=e,["out","inn","side1","side2","top"].forEach(function(i){t[i].attr(r,e)})}}),t.attr=function(e){var r,i;return"object"==typeof e&&(i=s(e))&&(r=i[0],arguments[0]=i[1],extend(t.attribs,r),t.setPaths(t.attribs)),SVGElement.prototype.attr.apply(t,arguments)},t.animate=function(e,r,i){var n,a,o,d=this.attribs,h="data-"+Math.random().toString(26).substring(2,9);return delete e.center,delete e.z,delete e.alpha,delete e.beta,(o=animObject(pick(r,this.renderer.globalAnimation))).duration&&(n=s(e),t[h]=0,e[h]=1,t[h+"Setter"]=H.noop,n&&(a=n[0],o.step=function(e,t){function r(e){return d[e]+(pick(a[e],d[e])-d[e])*t.pos}t.prop===h&&t.elem.setPaths(merge(d,{x:r("x"),y:r("y"),r:r("r"),innerR:r("innerR"),start:r("start"),end:r("end"),depth:r("depth")}))}),r=o),SVGElement.prototype.animate.call(this,e,r,i)},t.destroy=function(){return this.top.destroy(),this.out.destroy(),this.inn.destroy(),this.side1.destroy(),this.side2.destroy(),SVGElement.prototype.destroy.call(this)},t.hide=function(){this.top.hide(),this.out.hide(),this.inn.hide(),this.side1.hide(),this.side2.hide()},t.show=function(e){this.top.show(e),this.out.show(e),this.inn.show(e),this.side1.show(e),this.side2.show(e)},t},SVGRenderer.prototype.arc3dPath=function(e){var t=e.x,r=e.y,i=e.start,s=e.end-1e-5,n=e.r,a=e.innerR||0,o=e.depth||0,d=e.alpha,h=e.beta,c=Math.cos(i),p=Math.sin(i),l=Math.cos(s),u=Math.sin(s),f=n*Math.cos(h),y=n*Math.cos(d),v=a*Math.cos(h),M=a*Math.cos(d),x=o*Math.sin(h),m=o*Math.sin(d),P=[["M",t+f*c,r+y*p]];(P=P.concat(curveTo(t,r,f,y,i,s,0,0))).push(["L",t+v*l,r+M*u]),(P=P.concat(curveTo(t,r,v,M,s,i,0,0))).push(["Z"]);var b=h>0?Math.PI/2:0,g=d>0?0:Math.PI/2,S=i>-b?i:s>-b?-b:i,z=s<PI-g?s:i<PI-g?PI-g:s,I=2*PI-g,A=[["M",t+f*cos(S),r+y*sin(S)]];A=A.concat(curveTo(t,r,f,y,S,z,0,0)),s>I&&i<I?(A.push(["L",t+f*cos(z)+x,r+y*sin(z)+m]),(A=A.concat(curveTo(t,r,f,y,z,I,x,m))).push(["L",t+f*cos(I),r+y*sin(I)]),(A=A.concat(curveTo(t,r,f,y,I,s,0,0))).push(["L",t+f*cos(s)+x,r+y*sin(s)+m]),(A=A.concat(curveTo(t,r,f,y,s,I,x,m))).push(["L",t+f*cos(I),r+y*sin(I)]),A=A.concat(curveTo(t,r,f,y,I,z,0,0))):s>PI-g&&i<PI-g&&(A.push(["L",t+f*Math.cos(z)+x,r+y*Math.sin(z)+m]),(A=A.concat(curveTo(t,r,f,y,z,s,x,m))).push(["L",t+f*Math.cos(s),r+y*Math.sin(s)]),A=A.concat(curveTo(t,r,f,y,s,z,0,0))),A.push(["L",t+f*Math.cos(z)+x,r+y*Math.sin(z)+m]),(A=A.concat(curveTo(t,r,f,y,z,S,x,m))).push(["Z"]);var E=[["M",t+v*c,r+M*p]];(E=E.concat(curveTo(t,r,v,M,i,s,0,0))).push(["L",t+v*Math.cos(s)+x,r+M*Math.sin(s)+m]),(E=E.concat(curveTo(t,r,v,M,s,i,x,m))).push(["Z"]);var G=[["M",t+f*c,r+y*p],["L",t+f*c+x,r+y*p+m],["L",t+v*c+x,r+M*p+m],["L",t+v*c,r+M*p],["Z"]],T=[["M",t+f*l,r+y*u],["L",t+f*l+x,r+y*u+m],["L",t+v*l+x,r+M*u+m],["L",t+v*l,r+M*u],["Z"]],L=Math.atan2(m,-x),V=Math.abs(s+L),j=Math.abs(i+L),R=Math.abs((i+s)/2+L);function k(e){return(e%=2*Math.PI)>Math.PI&&(e=2*Math.PI-e),e}V=k(V),j=k(j);var F=1e5*(R=k(R)),O=1e5*j,U=1e5*V;return{top:P,zTop:1e5*Math.PI+1,out:A,zOut:Math.max(F,O,U),inn:E,zInn:Math.max(F,O,U),side1:G,zSide1:.99*U,side2:T,zSide2:.99*O}};