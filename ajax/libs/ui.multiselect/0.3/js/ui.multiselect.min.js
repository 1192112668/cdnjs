!function(d){d.widget("ui.multiselect",{_init:function(){this.element.hide(),this.id=this.element.attr("id"),this.container=d('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element),this.count=0,this.selectedContainer=d('<div class="selected"></div>').appendTo(this.container),this.availableContainer=d('<div class="available"></div>').appendTo(this.container),this.selectedActions=d('<div class="actions ui-widget-header ui-helper-clearfix"><span class="count">0 '+d.ui.multiselect.locale.itemsCount+'</span><a href="#" class="remove-all">'+d.ui.multiselect.locale.removeAll+"</a></div>").appendTo(this.selectedContainer),this.availableActions=d('<div class="actions ui-widget-header ui-helper-clearfix"><input type="text" class="search empty ui-widget-content ui-corner-all"/><a href="#" class="add-all">'+d.ui.multiselect.locale.addAll+"</a></div>").appendTo(this.availableContainer),this.selectedList=d('<ul class="selected connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return!1}).appendTo(this.selectedContainer),this.availableList=d('<ul class="available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return!1}).appendTo(this.availableContainer);var i=this;this.container.width(this.element.width()+1),this.selectedContainer.width(Math.floor(this.element.width()*this.options.dividerLocation)),this.availableContainer.width(Math.floor(this.element.width()*(1-this.options.dividerLocation))),this.selectedList.height(Math.max(this.element.height()-this.selectedActions.height(),1)),this.availableList.height(Math.max(this.element.height()-this.availableActions.height(),1)),this.options.animated||(this.options.show="show",this.options.hide="hide"),this._populateLists(this.element.find("option")),this.options.sortable&&d("ul.selected").sortable({placeholder:"ui-state-highlight",axis:"y",update:function(t,e){i.selectedList.find("li").each(function(){d(this).data("optionLink")&&d(this).data("optionLink").remove().appendTo(i.element)})},receive:function(t,e){e.item.data("optionLink").attr("selected",!0),i.count+=1,i._updateCount(),i.selectedList.children(".ui-draggable").each(function(){d(this).removeClass("ui-draggable"),d(this).data("optionLink",e.item.data("optionLink")),d(this).data("idx",e.item.data("idx")),i._applyItemState(d(this),!0)}),setTimeout(function(){e.item.remove()},1)}}),this.options.searchable?this._registerSearchEvents(this.availableContainer.find("input.search")):d(".search").hide(),d(".remove-all").click(function(){return i._populateLists(i.element.find("option").removeAttr("selected")),!1}),d(".add-all").click(function(){return i._populateLists(i.element.find("option").attr("selected","selected")),!1})},destroy:function(){this.element.show(),this.container.remove(),d.widget.prototype.destroy.apply(this,arguments)},_populateLists:function(t){this.selectedList.children(".ui-element").remove(),this.availableList.children(".ui-element").remove(),this.count=0;var i=this;d(t.map(function(t){var e=i._getOptionNode(this).appendTo(this.selected?i.selectedList:i.availableList).show();return this.selected&&(i.count+=1),i._applyItemState(e,this.selected),e.data("idx",t),e[0]}));this._updateCount()},_updateCount:function(){this.selectedContainer.find("span.count").text(this.count+" "+d.ui.multiselect.locale.itemsCount)},_getOptionNode:function(t){t=d(t);var e=d('<li class="ui-state-default ui-element" title="'+t.text()+'"><span class="ui-icon"/>'+t.text()+'<a href="#" class="action"><span class="ui-corner-all ui-icon"/></a></li>').hide();return e.data("optionLink",t),e},_cloneWithData:function(t){var e=t.clone();return e.data("optionLink",t.data("optionLink")),e.data("idx",t.data("idx")),e},_setSelected:function(t,e){if(t.data("optionLink").attr("selected",e),e){var i=this._cloneWithData(t);return t[this.options.hide](this.options.animated,function(){d(this).remove()}),i.appendTo(this.selectedList).hide()[this.options.show](this.options.animated),this._applyItemState(i,!0),i}var s=this.availableList.find("li"),a=this.options.nodeComparator,n=null,o=t.data("idx"),l=a(t,d(s[o]));if(l){for(;0<=o&&o<s.length;)if(0<l?o++:o--,l!=a(t,d(s[o]))){n=s[0<l?o:o+1];break}}else n=s[o];var h=this._cloneWithData(t);return n?h.insertBefore(d(n)):h.appendTo(this.availableList),t[this.options.hide](this.options.animated,function(){d(this).remove()}),h.hide()[this.options.show](this.options.animated),this._applyItemState(h,!1),h},_applyItemState:function(t,e){e?(this.options.sortable?t.children("span").addClass("ui-icon-arrowthick-2-n-s").removeClass("ui-helper-hidden").addClass("ui-icon"):t.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon"),t.find("a.action span").addClass("ui-icon-minus").removeClass("ui-icon-plus"),this._registerRemoveEvents(t.find("a.action"))):(t.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon"),t.find("a.action span").addClass("ui-icon-plus").removeClass("ui-icon-minus"),this._registerAddEvents(t.find("a.action"))),this._registerHoverEvents(t)},_filter:function(t){var e=d(this),i=t.children("li"),s=i.map(function(){return d(this).text().toLowerCase()}),a=d.trim(e.val().toLowerCase()),n=[];a?(i.hide(),s.each(function(t){-1<this.indexOf(a)&&n.push(t)}),d.each(n,function(){d(i[this]).show()})):i.show()},_registerHoverEvents:function(t){t.removeClass("ui-state-hover"),t.mouseover(function(){d(this).addClass("ui-state-hover")}),t.mouseout(function(){d(this).removeClass("ui-state-hover")})},_registerAddEvents:function(t){var e=this;t.click(function(){e._setSelected(d(this).parent(),!0);return e.count+=1,e._updateCount(),!1}).each(function(){d(this).parent().draggable({connectToSortable:"ul.selected",helper:function(){var t=e._cloneWithData(d(this)).width(d(this).width()-50);return t.width(d(this).width()),t},appendTo:".ui-multiselect",containment:".ui-multiselect",revert:"invalid"})})},_registerRemoveEvents:function(t){var e=this;t.click(function(){return e._setSelected(d(this).parent(),!1),--e.count,e._updateCount(),!1})},_registerSearchEvents:function(t){var e=this;t.focus(function(){d(this).addClass("ui-state-active")}).blur(function(){d(this).removeClass("ui-state-active")}).keypress(function(t){if(13==t.keyCode)return!1}).keyup(function(){e._filter.apply(this,[e.availableList])})}}),d.extend(d.ui.multiselect,{defaults:{sortable:!0,searchable:!0,animated:"fast",show:"slideDown",hide:"slideUp",dividerLocation:.6,nodeComparator:function(t,e){var i=t.text(),s=e.text();return i==s?0:i<s?-1:1}},locale:{addAll:"Add all",removeAll:"Remove all",itemsCount:"items selected"}})}(jQuery);