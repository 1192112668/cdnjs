!function(e){"function"==typeof define&&define.amd?define(["jquery","./core"],e):e(jQuery,Formstone)}(function(X,i){"use strict";function o(e){e.preventManipulation&&e.preventManipulation();var t=e.data,a=e.originalEvent;if(a.type.match(/(up|end|cancel)$/i))d(e);else{if(a.pointerId){var n=!1;for(var s in t.touches)t.touches[s].id===a.pointerId&&(n=!0,t.touches[s].pageX=a.pageX,t.touches[s].pageY=a.pageY);n||t.touches.push({id:a.pointerId,pageX:a.pageX,pageY:a.pageY})}else t.touches=a.touches;a.type.match(/(down|start)$/i)?Y(e):a.type.match(/move$/i)&&p(e)}}function Y(e){var t=e.data,a="undefined"!==X.type(t.touches)&&t.touches.length?t.touches[0]:null;a&&t.$el.off(w.mouseDown),t.touching||(t.startE=e.originalEvent,t.startX=a?a.pageX:e.pageX,t.startY=a?a.pageY:e.pageY,t.startT=(new Date).getTime(),t.scaleD=1,t.passedAxis=!1),t.$links&&t.$links.off(w.click);var n,s=x(t.scale?w.scaleStart:w.panStart,e,t.startX,t.startY,t.scaleD,0,0,"","");t.scale&&t.touches&&2<=t.touches.length&&(n=t.touches,t.pinch={startX:f(n[0].pageX,n[1].pageX),startY:f(n[0].pageY,n[1].pageY),startD:m(n[1].pageX-n[0].pageX,n[1].pageY-n[0].pageY)},s.pageX=t.startX=t.pinch.startX,s.pageY=t.startY=t.pinch.startY),t.touching||(t.touching=!0,t.pan&&!a&&D.on(w.mouseMove,t,p).on(w.mouseUp,t,d),i.support.pointer?D.on([w.pointerMove,w.pointerUp,w.pointerCancel].join(" "),t,o):D.on([w.touchMove,w.touchEnd,w.touchCancel].join(" "),t,o),t.$el.trigger(s))}function p(e){var t,a,n,s=e.data,i="undefined"!==X.type(s.touches)&&s.touches.length?s.touches[0]:null,o=i?i.pageX:e.pageX,p=i?i.pageY:e.pageY,c=o-s.startX,r=p-s.startY,u=0<c?"right":"left",h=0<r?"down":"up",l=Math.abs(c)>s.threshold,g=Math.abs(r)>s.threshold;!s.passedAxis&&s.axis&&(s.axisX&&g||s.axisY&&l)?d(e):(!s.passedAxis&&(!s.axis||s.axis&&s.axisX&&l||s.axisY&&g)&&(s.passedAxis=!0),s.passedAxis&&(M.killEvent(e),M.killEvent(s.startE)),t=!0,a=x(s.scale?w.scale:w.pan,e,o,p,s.scaleD,c,r,u,h),s.scale&&(s.touches&&2<=s.touches.length?(n=s.touches,s.pinch.endX=f(n[0].pageX,n[1].pageX),s.pinch.endY=f(n[0].pageY,n[1].pageY),s.pinch.endD=m(n[1].pageX-n[0].pageX,n[1].pageY-n[0].pageY),s.scaleD=s.pinch.endD/s.pinch.startD,a.pageX=s.pinch.endX,a.pageY=s.pinch.endY,a.scale=s.scaleD,a.deltaX=s.pinch.endX-s.pinch.startX,a.deltaY=s.pinch.endY-s.pinch.startY):s.pan||(t=!1)),t&&s.$el.trigger(a))}function d(e){var t=e.data,a="undefined"!==X.type(t.touches)&&t.touches.length?t.touches[0]:null,n=a?a.pageX:e.pageX,s=a?a.pageY:e.pageY,i=n-t.startX,o=s-t.startY,p=(new Date).getTime(),c=t.scale?w.scaleEnd:w.panEnd,r=0<i?"right":"left",u=0<o?"down":"up",h=1<Math.abs(i),l=1<Math.abs(o);if(t.swipe&&p-t.startT<t.time&&Math.abs(i)>t.threshold&&(c=w.swipe),t.axis&&(t.axisX&&l||t.axisY&&h)||h||l){t.$links=t.$el.find("a");for(var g=0,d=t.$links.length;g<d;g++)v(t.$links.eq(g),t)}var f=x(c,e,n,s,t.scaleD,i,o,r,u);D.off([w.touchMove,w.touchEnd,w.touchCancel,w.mouseMove,w.mouseUp,w.pointerMove,w.pointerUp,w.pointerCancel].join(" ")),t.$el.trigger(f),t.touches=[],t.scale,a&&(t.touchTimer=M.startTimer(t.touchTimer,5,function(){t.$el.on(w.mouseDown,t,Y)})),t.touching=!1}function v(e,t){e.on(w.click,t,n);var a=X._data(e[0],"events").click;a.unshift(a.pop())}function n(e){M.killEvent(e,!0),e.data.$links.off(w.click)}function x(e,t,a,n,s,i,o,p,c){return X.Event(e,{originalEvent:t,bubbles:!0,pageX:a,pageY:n,scale:s,deltaX:i,deltaY:o,directionX:p,directionY:c})}function f(e,t){return(e+t)/2}function m(e,t){return Math.sqrt(e*e+t*t)}function a(e,t){e.css({"-ms-touch-action":t,"touch-action":t})}var e=!i.window.PointerEvent,t=i.Plugin("touch",{widget:!0,defaults:{axis:!1,pan:!1,scale:!1,swipe:!1,threshold:10,time:50},methods:{_construct:function(e){var t;e.touches=[],e.touching=!1,this.on(w.dragStart,M.killEvent),e.swipe&&(e.pan=!0),e.scale&&(e.axis=!1),e.axisX="x"===e.axis,e.axisY="y"===e.axis,i.support.pointer?(t="",!e.axis||e.axisX&&e.axisY?t="none":(e.axisX&&(t+=" pan-y"),e.axisY&&(t+=" pan-x")),a(this,t),this.on(w.pointerDown,e,o)):this.on(w.touchStart,e,o).on(w.mouseDown,e,Y)},_destruct:function(e){this.off(w.namespace),a(this,"")}},events:{pointerDown:e?"MSPointerDown":"pointerdown",pointerUp:e?"MSPointerUp":"pointerup",pointerMove:e?"MSPointerMove":"pointermove",pointerCancel:e?"MSPointerCancel":"pointercancel"}}),w=t.events,M=t.functions,D=i.$window;w.pan="pan",w.panStart="panstart",w.panEnd="panend",w.scale="scale",w.scaleStart="scalestart",w.scaleEnd="scaleend",w.swipe="swipe"});