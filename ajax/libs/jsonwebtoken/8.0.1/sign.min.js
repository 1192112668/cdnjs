var timespan=require("./lib/timespan"),xtend=require("xtend"),jws=require("jws"),includes=require("lodash.includes"),isBoolean=require("lodash.isboolean"),isInteger=require("lodash.isinteger"),isNumber=require("lodash.isnumber"),isPlainObject=require("lodash.isplainobject"),isString=require("lodash.isstring"),once=require("lodash.once"),sign_options_schema={expiresIn:{isValid:function(e){return isInteger(e)||isString(e)},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return isInteger(e)||isString(e)},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return isString(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:includes.bind(null,["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"]),message:'"algorithm" must be a valid string enum value'},header:{isValid:isPlainObject,message:'"header" must be an object'},encoding:{isValid:isString,message:'"encoding" must be a string'},issuer:{isValid:isString,message:'"issuer" must be a string'},subject:{isValid:isString,message:'"subject" must be a string'},jwtid:{isValid:isString,message:'"jwtid" must be a string'},noTimestamp:{isValid:isBoolean,message:'"noTimestamp" must be a boolean'},keyid:{isValid:isString,message:'"keyid" must be a string'}},registered_claims_schema={iat:{isValid:isNumber,message:'"iat" should be a number of seconds'},exp:{isValid:isNumber,message:'"exp" should be a number of seconds'},nbf:{isValid:isNumber,message:'"nbf" should be a number of seconds'}};function validate(r,s,n){if(!isPlainObject(n))throw new Error("Expected object");Object.keys(n).forEach(function(e){var i=r[e];if(i){if(!i.isValid(n[e]))throw new Error(i.message)}else if(!s)throw new Error('"'+e+'" is not allowed')})}var options_to_payload={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},options_for_objects=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];module.exports=function(r,e,s,i){s="function"==typeof s?(i=s,{}):s||{};var n="object"==typeof r&&!Buffer.isBuffer(r),o=xtend({alg:s.algorithm||"HS256",typ:n?"JWT":void 0,kid:s.keyid},s.header);function t(e){if(i)return i(e);throw e}if(!e&&"none"!==s.algorithm)return t(new Error("secretOrPrivateKey must have a value"));if(void 0===r)return t(new Error("payload is required"));if(n){try{validate(registered_claims_schema,!0,r)}catch(e){return t(e)}r=xtend(r)}else{var a=options_for_objects.filter(function(e){return void 0!==s[e]});if(0<a.length)return t(new Error("invalid "+a.join(",")+" option for "+typeof r+" payload"))}if(void 0!==r.exp&&void 0!==s.expiresIn)return t(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==r.nbf&&void 0!==s.notBefore)return t(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{validate(sign_options_schema,!1,s)}catch(e){return t(e)}var d=r.iat||Math.floor(Date.now()/1e3);if(s.noTimestamp?delete r.iat:r.iat=d,void 0!==s.notBefore&&(r.nbf=timespan(s.notBefore),void 0===r.nbf))return t(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(void 0!==s.expiresIn&&"object"==typeof r&&(r.exp=timespan(s.expiresIn,d),void 0===r.exp))return t(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));Object.keys(options_to_payload).forEach(function(e){var i=options_to_payload[e];if(void 0!==s[e]){if(void 0!==r[i])return t(new Error('Bad "options.'+e+'" option. The payload already has an "'+i+'" property.'));r[i]=s[e]}});var u=s.encoding||"utf8";if("function"!=typeof i)return jws.sign({header:o,payload:r,secret:e,encoding:u});i=i&&once(i),jws.createSign({header:o,privateKey:e,payload:r,encoding:u}).once("error",i).once("done",function(e){i(null,e)})};