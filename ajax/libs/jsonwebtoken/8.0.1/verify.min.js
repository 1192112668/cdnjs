var JsonWebTokenError=require("./lib/JsonWebTokenError"),NotBeforeError=require("./lib/NotBeforeError"),TokenExpiredError=require("./lib/TokenExpiredError"),decode=require("./decode"),timespan=require("./lib/timespan"),jws=require("jws"),xtend=require("xtend");module.exports=function(e,r,n,i){var o;if("function"!=typeof n||i||(i=n,n={}),o=i||function(e,r){if(e)throw e;return r},(n=xtend(n=n||{})).clockTimestamp&&"number"!=typeof n.clockTimestamp)return o(new JsonWebTokenError("clockTimestamp must be a number"));var t=n.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return o(new JsonWebTokenError("jwt must be provided"));if("string"!=typeof e)return o(new JsonWebTokenError("jwt must be a string"));var s=e.split(".");if(3!==s.length)return o(new JsonWebTokenError("jwt malformed"));var a,u=""!==s[2].trim();if(!u&&r)return o(new JsonWebTokenError("jwt signature is required"));if(u&&!r)return o(new JsonWebTokenError("secret or public key must be provided"));u||n.algorithms||(n.algorithms=["none"]),n.algorithms||(n.algorithms=~r.toString().indexOf("BEGIN CERTIFICATE")||~r.toString().indexOf("BEGIN PUBLIC KEY")?["RS256","RS384","RS512","ES256","ES384","ES512"]:~r.toString().indexOf("BEGIN RSA PUBLIC KEY")?["RS256","RS384","RS512"]:["HS256","HS384","HS512"]);try{a=jws.decode(e)}catch(e){return o(e)}if(!a)return o(new JsonWebTokenError("invalid token"));var d,f,c=a.header;if(!~n.algorithms.indexOf(c.alg))return o(new JsonWebTokenError("invalid algorithm"));try{d=jws.verify(e,c.alg,r)}catch(e){return o(e)}if(!d)return o(new JsonWebTokenError("invalid signature"));try{f=decode(e)}catch(e){return o(e)}if(void 0!==f.nbf&&!n.ignoreNotBefore){if("number"!=typeof f.nbf)return o(new JsonWebTokenError("invalid nbf value"));if(f.nbf>t+(n.clockTolerance||0))return o(new NotBeforeError("jwt not active",new Date(1e3*f.nbf)))}if(void 0!==f.exp&&!n.ignoreExpiration){if("number"!=typeof f.exp)return o(new JsonWebTokenError("invalid exp value"));if(t>=f.exp+(n.clockTolerance||0))return o(new TokenExpiredError("jwt expired",new Date(1e3*f.exp)))}if(n.audience){var b=Array.isArray(n.audience)?n.audience:[n.audience];if(!(Array.isArray(f.aud)?f.aud:[f.aud]).some(function(e){return-1!=b.indexOf(e)}))return o(new JsonWebTokenError("jwt audience invalid. expected: "+b.join(" or ")))}if(n.issuer&&("string"==typeof n.issuer&&f.iss!==n.issuer||Array.isArray(n.issuer)&&-1===n.issuer.indexOf(f.iss)))return o(new JsonWebTokenError("jwt issuer invalid. expected: "+n.issuer));if(n.subject&&f.sub!==n.subject)return o(new JsonWebTokenError("jwt subject invalid. expected: "+n.subject));if(n.jwtid&&f.jti!==n.jwtid)return o(new JsonWebTokenError("jwt jwtid invalid. expected: "+n.jwtid));if(n.maxAge){if("number"!=typeof f.iat)return o(new JsonWebTokenError("iat required when maxAge is specified"));var w=timespan(n.maxAge,f.iat);if(void 0===w)return o(new JsonWebTokenError('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(t>=w+(n.clockTolerance||0))return o(new TokenExpiredError("maxAge exceeded",new Date(1e3*w)))}return o(null,f)};