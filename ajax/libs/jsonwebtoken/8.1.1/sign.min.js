var timespan=require("./lib/timespan"),xtend=require("xtend"),jws=require("jws"),includes=require("lodash.includes"),isBoolean=require("lodash.isboolean"),isInteger=require("lodash.isinteger"),isNumber=require("lodash.isnumber"),isPlainObject=require("lodash.isplainobject"),isString=require("lodash.isstring"),once=require("lodash.once"),sign_options_schema={expiresIn:{isValid:function(e){return isInteger(e)||isString(e)},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return isInteger(e)||isString(e)},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return isString(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:includes.bind(null,["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"]),message:'"algorithm" must be a valid string enum value'},header:{isValid:isPlainObject,message:'"header" must be an object'},encoding:{isValid:isString,message:'"encoding" must be a string'},issuer:{isValid:isString,message:'"issuer" must be a string'},subject:{isValid:isString,message:'"subject" must be a string'},jwtid:{isValid:isString,message:'"jwtid" must be a string'},noTimestamp:{isValid:isBoolean,message:'"noTimestamp" must be a boolean'},keyid:{isValid:isString,message:'"keyid" must be a string'}},registered_claims_schema={iat:{isValid:isNumber,message:'"iat" should be a number of seconds'},exp:{isValid:isNumber,message:'"exp" should be a number of seconds'},nbf:{isValid:isNumber,message:'"nbf" should be a number of seconds'}};function validate(r,n,s,o){if(!isPlainObject(s))throw new Error('Expected "'+o+'" to be a plain object.');Object.keys(s).forEach(function(e){var i=r[e];if(i){if(!i.isValid(s[e]))throw new Error(i.message)}else if(!n)throw new Error('"'+e+'" is not allowed in "'+o+'"')})}function validateOptions(e){return validate(sign_options_schema,!1,e,"options")}function validatePayload(e){return validate(registered_claims_schema,!0,e,"payload")}var options_to_payload={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},options_for_objects=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];module.exports=function(r,e,n,i){n="function"==typeof n?(i=n,{}):n||{};var s="object"==typeof r&&!Buffer.isBuffer(r),o=xtend({alg:n.algorithm||"HS256",typ:s?"JWT":void 0,kid:n.keyid},n.header);function a(e){if(i)return i(e);throw e}if(!e&&"none"!==n.algorithm)return a(new Error("secretOrPrivateKey must have a value"));if(void 0===r)return a(new Error("payload is required"));if(s){try{validatePayload(r)}catch(e){return a(e)}r=xtend(r)}else{var t=options_for_objects.filter(function(e){return void 0!==n[e]});if(0<t.length)return a(new Error("invalid "+t.join(",")+" option for "+typeof r+" payload"))}if(void 0!==r.exp&&void 0!==n.expiresIn)return a(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==r.nbf&&void 0!==n.notBefore)return a(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{validateOptions(n)}catch(e){return a(e)}var d=r.iat||Math.floor(Date.now()/1e3);if(n.noTimestamp?delete r.iat:r.iat=d,void 0!==n.notBefore&&(r.nbf=timespan(n.notBefore,d),void 0===r.nbf))return a(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(void 0!==n.expiresIn&&"object"==typeof r&&(r.exp=timespan(n.expiresIn,d),void 0===r.exp))return a(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));Object.keys(options_to_payload).forEach(function(e){var i=options_to_payload[e];if(void 0!==n[e]){if(void 0!==r[i])return a(new Error('Bad "options.'+e+'" option. The payload already has an "'+i+'" property.'));r[i]=n[e]}});var u=n.encoding||"utf8";if("function"!=typeof i)return jws.sign({header:o,payload:r,secret:e,encoding:u});i=i&&once(i),jws.createSign({header:o,privateKey:e,payload:r,encoding:u}).once("error",i).once("done",function(e){i(null,e)})};