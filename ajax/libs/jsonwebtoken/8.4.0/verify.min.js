var JsonWebTokenError=require("./lib/JsonWebTokenError"),NotBeforeError=require("./lib/NotBeforeError"),TokenExpiredError=require("./lib/TokenExpiredError"),decode=require("./decode"),timespan=require("./lib/timespan"),jws=require("jws");module.exports=function(a,n,u,e){var c;if("function"!=typeof u||e||(e=u,u={}),u=u||{},u=Object.assign({},u),c=e||function(e,r){if(e)throw e;return r},u.clockTimestamp&&"number"!=typeof u.clockTimestamp)return c(new JsonWebTokenError("clockTimestamp must be a number"));if(void 0!==u.nonce&&("string"!=typeof u.nonce||""===u.nonce.trim()))return c(new JsonWebTokenError("nonce must be a non-empty string"));var f=u.clockTimestamp||Math.floor(Date.now()/1e3);if(!a)return c(new JsonWebTokenError("jwt must be provided"));if("string"!=typeof a)return c(new JsonWebTokenError("jwt must be a string"));var d,b=a.split(".");if(3!==b.length)return c(new JsonWebTokenError("jwt malformed"));try{d=decode(a,{complete:!0})}catch(e){return c(e)}if(!d)return c(new JsonWebTokenError("invalid token"));var r,o=d.header;if("function"==typeof n){if(!e)return c(new JsonWebTokenError("verify must be called asynchronous if secret or public key is provided as a callback"));r=n}else r=function(e,r){return r(null,n)};return r(o,function(e,r){if(e)return c(new JsonWebTokenError("error in secret or public key callback: "+e.message));var n,o=""!==b[2].trim();if(!o&&r)return c(new JsonWebTokenError("jwt signature is required"));if(o&&!r)return c(new JsonWebTokenError("secret or public key must be provided"));if(o||u.algorithms||(u.algorithms=["none"]),u.algorithms||(u.algorithms=~r.toString().indexOf("BEGIN CERTIFICATE")||~r.toString().indexOf("BEGIN PUBLIC KEY")?["RS256","RS384","RS512","ES256","ES384","ES512"]:~r.toString().indexOf("BEGIN RSA PUBLIC KEY")?["RS256","RS384","RS512"]:["HS256","HS384","HS512"]),!~u.algorithms.indexOf(d.header.alg))return c(new JsonWebTokenError("invalid algorithm"));try{n=jws.verify(a,d.header.alg,r)}catch(e){return c(e)}if(!n)return c(new JsonWebTokenError("invalid signature"));var i=d.payload;if(void 0!==i.nbf&&!u.ignoreNotBefore){if("number"!=typeof i.nbf)return c(new JsonWebTokenError("invalid nbf value"));if(i.nbf>f+(u.clockTolerance||0))return c(new NotBeforeError("jwt not active",new Date(1e3*i.nbf)))}if(void 0!==i.exp&&!u.ignoreExpiration){if("number"!=typeof i.exp)return c(new JsonWebTokenError("invalid exp value"));if(f>=i.exp+(u.clockTolerance||0))return c(new TokenExpiredError("jwt expired",new Date(1e3*i.exp)))}if(u.audience){var t=Array.isArray(u.audience)?u.audience:[u.audience];if(!(Array.isArray(i.aud)?i.aud:[i.aud]).some(function(r){return t.some(function(e){return e instanceof RegExp?e.test(r):e===r})}))return c(new JsonWebTokenError("jwt audience invalid. expected: "+t.join(" or ")))}if(u.issuer&&("string"==typeof u.issuer&&i.iss!==u.issuer||Array.isArray(u.issuer)&&-1===u.issuer.indexOf(i.iss)))return c(new JsonWebTokenError("jwt issuer invalid. expected: "+u.issuer));if(u.subject&&i.sub!==u.subject)return c(new JsonWebTokenError("jwt subject invalid. expected: "+u.subject));if(u.jwtid&&i.jti!==u.jwtid)return c(new JsonWebTokenError("jwt jwtid invalid. expected: "+u.jwtid));if(u.nonce&&i.nonce!==u.nonce)return c(new JsonWebTokenError("jwt nonce invalid. expected: "+u.nonce));if(u.maxAge){if("number"!=typeof i.iat)return c(new JsonWebTokenError("iat required when maxAge is specified"));var s=timespan(u.maxAge,i.iat);if(void 0===s)return c(new JsonWebTokenError('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(f>=s+(u.clockTolerance||0))return c(new TokenExpiredError("maxAge exceeded",new Date(1e3*s)))}return c(null,i)})};