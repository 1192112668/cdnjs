var JsonWebTokenError=require("./lib/JsonWebTokenError"),NotBeforeError=require("./lib/NotBeforeError"),TokenExpiredError=require("./lib/TokenExpiredError"),decode=require("./decode"),timespan=require("./lib/timespan"),jws=require("jws");module.exports=function(a,n,u,e){var f;if("function"!=typeof u||e||(e=u,u={}),u=u||{},u=Object.assign({},u),f=e||function(e,r){if(e)throw e;return r},u.clockTimestamp&&"number"!=typeof u.clockTimestamp)return f(new JsonWebTokenError("clockTimestamp must be a number"));var d=u.clockTimestamp||Math.floor(Date.now()/1e3);if(!a)return f(new JsonWebTokenError("jwt must be provided"));if("string"!=typeof a)return f(new JsonWebTokenError("jwt must be a string"));var c,l=a.split(".");if(3!==l.length)return f(new JsonWebTokenError("jwt malformed"));try{c=decode(a,{complete:!0})}catch(e){return f(e)}if(!c)return f(new JsonWebTokenError("invalid token"));var r,o=c.header;if("function"==typeof n){if(!e)return f(new JsonWebTokenError("verify must be called asynchronous if secret or public key is provided as a callback"));r=n}else r=function(e,r){return r(null,n)};return r(o,function(e,r){if(e)return f(new JsonWebTokenError("error in secret or public key callback: "+e.message));var n,o=""!==l[2].trim();if(!o&&r)return f(new JsonWebTokenError("jwt signature is required"));if(o&&!r)return f(new JsonWebTokenError("secret or public key must be provided"));if(o||u.algorithms||(u.algorithms=["none"]),u.algorithms||(u.algorithms=~r.toString().indexOf("BEGIN CERTIFICATE")||~r.toString().indexOf("BEGIN PUBLIC KEY")?["RS256","RS384","RS512","ES256","ES384","ES512"]:~r.toString().indexOf("BEGIN RSA PUBLIC KEY")?["RS256","RS384","RS512"]:["HS256","HS384","HS512"]),!~u.algorithms.indexOf(c.header.alg))return f(new JsonWebTokenError("invalid algorithm"));try{n=jws.verify(a,c.header.alg,r)}catch(e){return f(e)}if(!n)return f(new JsonWebTokenError("invalid signature"));var i=c.payload;if(void 0!==i.nbf&&!u.ignoreNotBefore){if("number"!=typeof i.nbf)return f(new JsonWebTokenError("invalid nbf value"));if(i.nbf>d+(u.clockTolerance||0))return f(new NotBeforeError("jwt not active",new Date(1e3*i.nbf)))}if(void 0!==i.exp&&!u.ignoreExpiration){if("number"!=typeof i.exp)return f(new JsonWebTokenError("invalid exp value"));if(d>=i.exp+(u.clockTolerance||0))return f(new TokenExpiredError("jwt expired",new Date(1e3*i.exp)))}if(u.audience){var t=Array.isArray(u.audience)?u.audience:[u.audience];if(!(Array.isArray(i.aud)?i.aud:[i.aud]).some(function(r){return t.some(function(e){return e instanceof RegExp?e.test(r):e===r})}))return f(new JsonWebTokenError("jwt audience invalid. expected: "+t.join(" or ")))}if(u.issuer&&("string"==typeof u.issuer&&i.iss!==u.issuer||Array.isArray(u.issuer)&&-1===u.issuer.indexOf(i.iss)))return f(new JsonWebTokenError("jwt issuer invalid. expected: "+u.issuer));if(u.subject&&i.sub!==u.subject)return f(new JsonWebTokenError("jwt subject invalid. expected: "+u.subject));if(u.jwtid&&i.jti!==u.jwtid)return f(new JsonWebTokenError("jwt jwtid invalid. expected: "+u.jwtid));if(u.maxAge){if("number"!=typeof i.iat)return f(new JsonWebTokenError("iat required when maxAge is specified"));var s=timespan(u.maxAge,i.iat);if(void 0===s)return f(new JsonWebTokenError('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(d>=s+(u.clockTolerance||0))return f(new TokenExpiredError("maxAge exceeded",new Date(1e3*s)))}return f(null,i)})};