"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var esTokenizer=require("./es-tokenizer"),tplTokenizer=require("./tpl-tokenizer"),DATA="$data",IMPORTS="$imports",ESCAPE="$escape",EACH="$each",PRINT="print",INCLUDE="include",EXTEND="extend",BLOCK="block",OUT="$$out",LINE="$$line",BLOCKS="$$blocks",SLICE="$$slice",FROM="$$from",OPTIONS="$$options",has=function(t,e){return t.hasOwnProperty(e)},stringify=JSON.stringify,Compiler=function(){function p(t){var e,n,r=this;_classCallCheck(this,p);var s=t.source,i=t.minimize,o=t.htmlMinifier;if(this.options=t,this.stacks=[],this.context=[],this.scripts=[],this.CONTEXT_MAP={},this.ignore=[DATA,IMPORTS,OPTIONS].concat(t.ignore),this.internal=((e={})[OUT]="''",e[LINE]="[0,0]",e[BLOCKS]="arguments[1]||{}",e[FROM]="null",e[PRINT]="function(){var s=''.concat.apply('',arguments);"+OUT+"+=s;return s}",e[INCLUDE]="function(src,data){var s="+OPTIONS+".include(src,data||"+DATA+",arguments[2]||"+BLOCKS+","+OPTIONS+");"+OUT+"+=s;return s}",e[EXTEND]="function(from){"+FROM+"=from}",e[SLICE]="function(c,p,s){p="+OUT+";"+OUT+"='';c();s="+OUT+";"+OUT+"=p+s;return s}",e[BLOCK]="function(){var a=arguments,s;if(typeof a[0]==='function'){return "+SLICE+"(a[0])}else if("+FROM+"){"+BLOCKS+"[a[0]]="+SLICE+"(a[1])}else{s="+BLOCKS+"[a[0]];if(typeof s==='string'){"+OUT+"+=s}else{s="+SLICE+"(a[1])}return s}}",e),this.dependencies=((n={})[PRINT]=[OUT],n[INCLUDE]=[OUT,OPTIONS,DATA,BLOCKS],n[EXTEND]=[FROM,INCLUDE],n[BLOCK]=[SLICE,FROM,OUT,BLOCKS],n),this.importContext(OUT),t.compileDebug&&this.importContext(LINE),i)try{s=o(s,t)}catch(t){}this.source=s,this.getTplTokens(s,t.rules,this).forEach(function(t){t.type===tplTokenizer.TYPE_STRING?r.parseString(t):r.parseExpression(t)})}return p.prototype.getTplTokens=function(){return tplTokenizer.apply(void 0,arguments)},p.prototype.getEsTokens=function(t){return esTokenizer(t)},p.prototype.getVariables=function(t){var e=!1;return t.filter(function(t){return"whitespace"!==t.type&&"comment"!==t.type}).filter(function(t){return"name"===t.type&&!e||(e="punctuator"===t.type&&"."===t.value,!1)}).map(function(t){return t.value})},p.prototype.importContext=function(t){var e=this,n="",r=this.internal,s=this.dependencies,i=this.ignore,o=this.context,p=this.options.imports,a=this.CONTEXT_MAP;has(a,t)||-1!==i.indexOf(t)||(has(r,t)?(n=r[t],has(s,t)&&s[t].forEach(function(t){return e.importContext(t)})):n=t===ESCAPE||t===EACH||has(p,t)?IMPORTS+"."+t:DATA+"."+t,a[t]=n,o.push({name:t,value:n}))},p.prototype.parseString=function(t){var e,n=t.value;n&&(e=OUT+"+="+stringify(n),this.scripts.push({source:n,tplToken:t,code:e}))},p.prototype.parseExpression=function(t){var e=this,n=t.value,r=t.script,s=r.output,i=r.code;s&&(i=!1===escape||s===tplTokenizer.TYPE_RAW?OUT+"+="+r.code:OUT+"+="+ESCAPE+"("+r.code+")");var o=this.getEsTokens(i);this.getVariables(o).forEach(function(t){return e.importContext(t)}),this.scripts.push({source:n,tplToken:t,code:i})},p.prototype.checkExpression=function(t){for(var e=[[/^\s*}[\w\W]*?{?[\s;]*$/,""],[/(^[\w\W]*?\([\w\W]*?(?:=>|\([\w\W]*?\))\s*{[\s;]*$)/,"$1})"],[/(^[\w\W]*?\([\w\W]*?\)\s*{[\s;]*$)/,"$1}"]],n=0;n<e.length;){if(e[n][0].test(t)){t=t.replace.apply(t,e[n]);break}n++}try{return new Function(t),!0}catch(t){return!1}},p.prototype.build=function(){function e(t,e){var n=e.line,r=e.start,s={generated:{line:i.length+T+1,column:1},original:{line:n+1,column:r+1}};return T+=t.split(/\n/).length-1,s}function n(t){return t.replace(/^[\t ]+|[\t ]$/g,"")}var t=this.options,r=this.context,s=this.scripts,i=this.stacks,o=this.source,p=t.filename,a=t.imports,c=[],u=has(this.CONTEXT_MAP,EXTEND),T=0;i.push("function("+DATA+"){"),i.push("'use strict'"),i.push(DATA+"="+DATA+"||{}"),i.push("var "+r.map(function(t){return t.name+"="+t.value}).join(",")),t.compileDebug?(i.push("try{"),s.forEach(function(t){t.tplToken.type===tplTokenizer.TYPE_EXPRESSION&&i.push(LINE+"=["+[t.tplToken.line,t.tplToken.start].join(",")+"]"),c.push(e(t.code,t.tplToken)),i.push(n(t.code))}),i.push("}catch(error){"),i.push("throw {"+["name:'RuntimeError'","path:"+stringify(p),"message:error.message","line:"+LINE+"[0]+1","column:"+LINE+"[1]+1","source:"+stringify(o),"stack:error.stack"].join(",")+"}"),i.push("}")):s.forEach(function(t){c.push(e(t.code,t.tplToken)),i.push(n(t.code))}),u&&(i.push(OUT+"=''"),i.push(INCLUDE+"("+FROM+","+DATA+","+BLOCKS+")")),i.push("return "+OUT),i.push("}");var h=i.join("\n");try{var l=new Function(IMPORTS,OPTIONS,"return "+h)(a,t);return l.mappings=c,l.sourcesContent=[o],l}catch(t){for(var O=0,E=0,f=0;O<s.length;){var C=s[O];if(!this.checkExpression(C.code)){E=C.tplToken.line,f=C.tplToken.start;break}O++}throw{name:"CompileError",path:p,message:t.message,line:E+1,column:f+1,source:o,generated:h,stack:t.stack}}},p}();Compiler.CONSTS={DATA:DATA,IMPORTS:IMPORTS,PRINT:PRINT,INCLUDE:INCLUDE,EXTEND:EXTEND,BLOCK:BLOCK,OPTIONS:OPTIONS,OUT:OUT,LINE:LINE,BLOCKS:BLOCKS,SLICE:SLICE,FROM:FROM,ESCAPE:ESCAPE,EACH:EACH},module.exports=Compiler;